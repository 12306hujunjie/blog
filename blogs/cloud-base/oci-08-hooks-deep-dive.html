<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-rc.19">
    <script>
      (function() {
        const userMode = localStorage.getItem('vuepress-reco-color-scheme') || 'auto';
        const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (userMode === 'dark' || (userMode === 'auto' && systemDarkMode)) {
          document.documentElement.classList.toggle('dark', true);
        }
      })();
    </script>
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.min.js" as="script"><title>OCI Hook 系统深度解析 - 容器生命周期扩展机制 | database of memory</title><meta name="description" content="study anything and life record">
    <link rel="preload" href="/blog/assets/style-3Js8NCR5.css" as="style"><link rel="stylesheet" href="/blog/assets/style-3Js8NCR5.css">
    <link rel="modulepreload" href="/blog/assets/app-2O6audqE.js"><link rel="modulepreload" href="/blog/assets/oci-08-hooks-deep-dive.html-U722baza.js">
    <link rel="prefetch" href="/blog/assets/timeline.html-Dpj3Uwd1.js" as="script"><link rel="prefetch" href="/blog/assets/posts.html-CwxCj2Hz.js" as="script"><link rel="prefetch" href="/blog/assets/friendship-link.html-BWfmkE8T.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-u-MzmdCM.js" as="script"><link rel="prefetch" href="/blog/assets/2.html-BZ918lqD.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-C0q1hGsM.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CKULWdoq.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CWtVNK-m.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bd6PVF3c.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BbXNqe1N.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DyPCaQFd.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-C18Bjk_W.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BBVLOTuN.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D6KsFqqv.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BFPB5Kke.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B7IkZhlZ.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D_xT1fZZ.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DheB4D6E.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bt_l6w3U.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DeILrr-C.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DSTAwzEO.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BD5fA-NV.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BkRrSqYz.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-cT5R8xwx.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D9YDDbbv.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CbwTJPe7.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BuOxUP39.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BonFf6Hv.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DdMSM_BO.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Cf_rINiA.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DAcku8Eg.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DXT9U0AY.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DNdoOP4f.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-gqCMVOP4.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-HV0Wu9t8.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-LYxcb78a.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B50wkuh6.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DmpqsxHB.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-ChJizRVK.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D91uHYKf.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BLywihRf.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CB6EOmHd.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CxeevLHu.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B6J1fqYY.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D6g5ki7n.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CNoSmcFz.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dg6Odx9T.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dcy99l4T.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BK5mIUzD.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-8yVN6cur.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D33sQ_DA.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BOgMey9f.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D-L5Fugg.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-blGV0Kuf.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Ck4-7Hl7.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-N5xZIiU3.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DHa_luE7.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BDo2AWiQ.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CJj46_t8.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B32LjB8A.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DHAALd4l.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-H_UWlmPh.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DhnB-W5f.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dl8_vnsm.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-AlHvVsZC.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D7E4OavF.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CgCAEUN3.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-4Mr3uCmo.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BWKUAlc0.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CNuv7HDI.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BTkfIlYg.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dqp54iE9.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CtCFev89.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bb4UAQpl.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B6JysInN.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CHu47ESV.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CW5fe8Pz.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CBCt-NmX.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DV90AmxE.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DzWzo9Ij.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bz0VyI0Z.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BjgscHtw.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Cx8p_sw9.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DoYWpPPd.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Ci-xHJlU.js" as="script"><link rel="prefetch" href="/blog/assets/2.html-DwdRHJG4.js" as="script"><link rel="prefetch" href="/blog/assets/3.html-DoXfDGmJ.js" as="script"><link rel="prefetch" href="/blog/assets/4.html-C-kKKJQV.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-fn4kmre_.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CoWvKsGl.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BvQMmH-P.js" as="script"><link rel="prefetch" href="/blog/assets/bitwise_operation.html-EhYVvxM9.js" as="script"><link rel="prefetch" href="/blog/assets/learning_algorithm.html-Tnr40gqi.js" as="script"><link rel="prefetch" href="/blog/assets/cache_pattern.html-BWIGrhub.js" as="script"><link rel="prefetch" href="/blog/assets/docker_tech.html-B7PNaqxh.js" as="script"><link rel="prefetch" href="/blog/assets/k3s.html-DP3vWh7K.js" as="script"><link rel="prefetch" href="/blog/assets/k3s_k8s_ingress.html-0VG_Dn9p.js" as="script"><link rel="prefetch" href="/blog/assets/oci-01-intro-guide.html-CMWMS7fl.js" as="script"><link rel="prefetch" href="/blog/assets/oci-02-runtime-spec.html-C0iBtGsB.js" as="script"><link rel="prefetch" href="/blog/assets/oci-03-image-spec.html-BBhmTevb.js" as="script"><link rel="prefetch" href="/blog/assets/oci-04-distribution-spec.html-BK42sbpW.js" as="script"><link rel="prefetch" href="/blog/assets/oci-05-security-guide.html-B3_bjMcv.js" as="script"><link rel="prefetch" href="/blog/assets/oci-06-monitoring-guide.html-DZeNq5_D.js" as="script"><link rel="prefetch" href="/blog/assets/oci-07-production-guide.html-Dd4znSBp.js" as="script"><link rel="prefetch" href="/blog/assets/oci-linux-configurations-blog.html-B-QLbxh0.js" as="script"><link rel="prefetch" href="/blog/assets/oci-series-index.html-CDKgV4-S.js" as="script"><link rel="prefetch" href="/blog/assets/runc-advanced-lifecycle-analysis.html-DksQevmb.js" as="script"><link rel="prefetch" href="/blog/assets/runc-comprehensive-design-guide.html-B3lFgAwq.js" as="script"><link rel="prefetch" href="/blog/assets/runc-container-lifecycle-diagrams.html-D0cL6kcw.js" as="script"><link rel="prefetch" href="/blog/assets/linux_namespace.html-C_6Up541.js" as="script"><link rel="prefetch" href="/blog/assets/python_checklist.html-C2qsWYBJ.js" as="script"><link rel="prefetch" href="/blog/assets/python_env_manage.html-CUnPJ_1B.js" as="script"><link rel="prefetch" href="/blog/assets/gevent.html-CUgqcz3s.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BJAgUlPO.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BO__mOgk.js" as="script"><link rel="prefetch" href="/blog/assets/sort_1.html-B61YFXe2.js" as="script"><link rel="prefetch" href="/blog/assets/01-runcgaishuyujiagou.html-CdwfP7-9.js" as="script"><link rel="prefetch" href="/blog/assets/02-rongqishengmingzhouqiguanli.html-C-f7fScs.js" as="script"><link rel="prefetch" href="/blog/assets/03-Namespacegelishixian.html-i58zOLTD.js" as="script"><link rel="prefetch" href="/blog/assets/04-Cgroupsziyuanguanli.html-Cv4-SHFL.js" as="script"><link rel="prefetch" href="/blog/assets/05-wenjianxitongyuguazaiguanli.html-BtljxstR.js" as="script"><link rel="prefetch" href="/blog/assets/06-anquantexingshixian.html-BHgpOUyN.js" as="script"><link rel="prefetch" href="/blog/assets/07-CRIUjianchadianyuhuifu.html-2aSuteQG.js" as="script"><link rel="prefetch" href="/blog/assets/08-tongxinyujiankongxitong.html-C1uYqrtr.js" as="script"><link rel="prefetch" href="/blog/assets/09-goujianjianhuarongqiyunxingshi.html-ZL_qjd8j.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DhgGbCoG.js" as="script"><link rel="prefetch" href="/blog/assets/abstract_factory.html-qSB2vqGJ.js" as="script"><link rel="prefetch" href="/blog/assets/factory_method.html-DaXxm691.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CQ2duCZ4.js" as="script"><link rel="prefetch" href="/blog/assets/adapter.html-k-5RMaEx.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-BmtOmY9V.js" as="script"><link rel="prefetch" href="/blog/assets/Valine.min-VCLvSWzF.js" as="script"><link rel="prefetch" href="/blog/assets/giscus-aTimukGI-DWEKOTfS.js" as="script"><link rel="prefetch" href="/blog/assets/KnowledgeMap-Dr6IblrL.js" as="script"><link rel="prefetch" href="/blog/assets/MermaidChart-a1CbfxcL.js" as="script"><link rel="prefetch" href="/blog/assets/mermaid.core-xyQxSs4c.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container series--no show-catalog"><header class="navbar-container not-open"><div class="navbar-inner"><div class="site-brand nav-item"><img class="logo" src="/blog/logo.png" alt="database of memory"><a href="/blog/" class="site-name can-hide">database of memory</a></div><div class="nav-item navbar-links-wrapper" style=""><div><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div><nav class="navbar-links"><!--[--><div class="navbar-links__item"><a href="/blog/" class="link" aria-label="Home"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Home<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/blog/categories/cloud-base/1/" class="link" aria-label="Categories"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Categories<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/blog/tags/runc/1/" class="link" aria-label="Tags"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Tags<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/blog/knowledge-map/" class="link" aria-label="知识地图"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->知识地图<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="Docs"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Docs<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="Docs"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Docs<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/blog/docs/leetcode/" class="link" aria-label="leetcode from scratch"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->leetcode from scratch<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/docs/design_pattern/" class="link" aria-label="design pattern"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->design pattern<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--><!----><span class="xicon-container btn-toggle-dark-mode btn--dark-mode navbar-links__item"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><path d="M15 2h2v3h-2z" fill="currentColor"></path><path d="M27 15h3v2h-3z" fill="currentColor"></path><path d="M15 27h2v3h-2z" fill="currentColor"></path><path d="M2 15h3v2H2z" fill="currentColor"></path><path d="M5.45 6.884l1.414-1.415l2.121 2.122l-1.414 1.414z" fill="currentColor"></path><path d="M23 7.58l2.121-2.12l1.414 1.414l-2.121 2.121z" fill="currentColor"></path><path d="M23.002 24.416l1.415-1.414l2.12 2.122l-1.413 1.414z" fill="currentColor"></path><path d="M5.47 25.13L7.59 23L9 24.42l-2.12 2.12l-1.41-1.41z" fill="currentColor"></path><path d="M16 8a8 8 0 1 0 8 8a8 8 0 0 0-8-8zm0 14a6 6 0 0 1 0-12z" fill="currentColor"></path></svg></span><ul class="social-links navbar-links__item"><!--[--><li class="social-item"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:25px;height:25px;"><path d="M16 2a14 14 0 0 0-4.43 27.28c.7.13 1-.3 1-.67v-2.38c-3.89.84-4.71-1.88-4.71-1.88a3.71 3.71 0 0 0-1.62-2.05c-1.27-.86.1-.85.1-.85a2.94 2.94 0 0 1 2.14 1.45a3 3 0 0 0 4.08 1.16a2.93 2.93 0 0 1 .88-1.87c-3.1-.36-6.37-1.56-6.37-6.92a5.4 5.4 0 0 1 1.44-3.76a5 5 0 0 1 .14-3.7s1.17-.38 3.85 1.43a13.3 13.3 0 0 1 7 0c2.67-1.81 3.84-1.43 3.84-1.43a5 5 0 0 1 .14 3.7a5.4 5.4 0 0 1 1.44 3.76c0 5.38-3.27 6.56-6.39 6.91a3.33 3.33 0 0 1 .95 2.59v3.84c0 .46.25.81 1 .67A14 14 0 0 0 16 2z" fill-rule="evenodd" fill="currentColor"></path></svg></li><!--]--></ul></nav><span class="xicon-container btn-toggle-menus"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><circle cx="16" cy="8" r="2" fill="currentColor"></circle><circle cx="16" cy="16" r="2" fill="currentColor"></circle><circle cx="16" cy="24" r="2" fill="currentColor"></circle></svg></span></div></div></header><!----><!----><!----><div class="theme-main" style=""><!----><!--[--><main class="page-container"><div class="page-content"><h1 class="page-title">OCI Hook 系统深度解析 - 容器生命周期扩展机制</h1><div class="page-info"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M16 4a5 5 0 1 1-5 5a5 5 0 0 1 5-5m0-2a7 7 0 1 0 7 7a7 7 0 0 0-7-7z" fill="currentColor"></path><path d="M26 30h-2v-5a5 5 0 0 0-5-5h-6a5 5 0 0 0-5 5v5H6v-5a7 7 0 0 1 7-7h6a7 7 0 0 1 7 7z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->hujunjie<!--]--></span></span><!----><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M11.17 6l3.42 3.41l.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[--><!--[--><a href="/blog/categories/cloud-base/1.html" class="">cloud-base</a><!--]--><!--]--></span></span><!----><!----></div><div class="theme-reco-md-content"><div><h1 id="oci-hook-系统深度解析-容器生命周期扩展机制" tabindex="-1"><a class="header-anchor" href="#oci-hook-系统深度解析-容器生命周期扩展机制"><span>OCI Hook 系统深度解析 - 容器生命周期扩展机制</span></a></h1><blockquote><p><strong>系列导航：</strong> <a class="route-link" href="/blog/blogs/cloud-base/oci-series-index.html">OCI 容器技术完全指南系列</a> → 第八篇：Hook 系统深度解析<br><strong>规范版本：</strong> OCI Runtime Spec v1.0.2<br><strong>参考仓库：</strong> <a href="https://github.com/opencontainers/runtime-spec" target="_blank" rel="noopener noreferrer">opencontainers/runtime-spec<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><br><strong>最后更新：</strong> 2024-12-19</p></blockquote><h2 id="概述" tabindex="-1"><a class="header-anchor" href="#概述"><span>概述</span></a></h2><p>OCI Hook 系统是容器运行时规范中的核心扩展机制，允许用户在容器生命周期的关键节点执行自定义操作。Hook 提供了强大的容器定制能力，支持网络配置、安全审计、资源监控、清理操作等多种场景。</p><h3 id="hook-系统特点" tabindex="-1"><a class="header-anchor" href="#hook-系统特点"><span>Hook 系统特点</span></a></h3><ul><li><strong>生命周期集成</strong> - 与容器创建、启动、停止等关键阶段深度集成</li><li><strong>命名空间感知</strong> - 在不同的命名空间上下文中执行</li><li><strong>状态传递</strong> - 通过标准输入接收容器状态信息</li><li><strong>错误处理</strong> - 支持超时控制和错误传播</li><li><strong>扩展性强</strong> - 支持多种编程语言和脚本实现</li></ul><h2 id="hook-类型与执行时机" tabindex="-1"><a class="header-anchor" href="#hook-类型与执行时机"><span>Hook 类型与执行时机</span></a></h2><h3 id="_1-createruntime-hook" tabindex="-1"><a class="header-anchor" href="#_1-createruntime-hook"><span>1. createRuntime Hook</span></a></h3><p><strong>执行时机：</strong> 容器运行时环境创建后，pivot_root 操作前<br><strong>执行命名空间：</strong> Runtime Namespace（运行时命名空间）<br><strong>路径解析：</strong> Runtime Namespace</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;hooks&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;createRuntime&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/usr/local/bin/network-setup&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;network-setup&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--container-id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;{{.ID}}&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;env&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;NETWORK_MODE=bridge&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;timeout&quot;</span><span class="token operator">:</span> <span class="token number">30</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>典型用例：</strong></p><ul><li>网络命名空间配置</li><li>存储卷挂载</li><li>安全策略初始化</li><li>监控代理注入</li></ul><p><strong>容器生命周期状态：</strong></p><ul><li>命名空间已创建</li><li>挂载操作已完成</li><li>Cgroups 可能尚未完全配置</li><li>SELinux/AppArmor 标签可能尚未应用</li></ul><h3 id="_2-createcontainer-hook" tabindex="-1"><a class="header-anchor" href="#_2-createcontainer-hook"><span>2. createContainer Hook</span></a></h3><p><strong>执行时机：</strong> 容器运行时环境创建后，pivot_root 操作前<br><strong>执行命名空间：</strong> Container Namespace（容器命名空间）<br><strong>路径解析：</strong> Runtime Namespace</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;hooks&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;createContainer&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/usr/local/bin/container-init&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;container-init&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--setup-filesystem&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;env&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;CONTAINER_ROOT=/rootfs&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;timeout&quot;</span><span class="token operator">:</span> <span class="token number">60</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>典型用例：</strong></p><ul><li>容器内文件系统准备</li><li>应用配置文件生成</li><li>权限设置</li><li>临时文件创建</li></ul><p><strong>容器生命周期状态：</strong></p><ul><li>在容器命名空间中执行</li><li>挂载命名空间已设置</li><li>可以访问容器的文件系统视图</li><li>pivot_root 尚未执行</li></ul><h3 id="_3-startcontainer-hook" tabindex="-1"><a class="header-anchor" href="#_3-startcontainer-hook"><span>3. startContainer Hook</span></a></h3><p><strong>执行时机：</strong> start 操作调用后，用户进程执行前<br><strong>执行命名空间：</strong> Container Namespace（容器命名空间）<br><strong>路径解析：</strong> Container Namespace</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;hooks&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;startContainer&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/usr/bin/ldconfig&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;ldconfig&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;timeout&quot;</span><span class="token operator">:</span> <span class="token number">10</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/usr/local/bin/app-prestart&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;app-prestart&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--validate-config&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;env&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;APP_ENV=production&quot;</span><span class="token punctuation">]</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>典型用例：</strong></p><ul><li>动态链接库缓存更新</li><li>应用配置验证</li><li>运行时环境检查</li><li>依赖服务连接测试</li></ul><p><strong>容器生命周期状态：</strong></p><ul><li>完整的容器环境已准备就绪</li><li>所有挂载操作已完成</li><li>用户进程尚未启动</li><li>可以执行容器内的准备工作</li></ul><h3 id="_4-poststart-hook" tabindex="-1"><a class="header-anchor" href="#_4-poststart-hook"><span>4. poststart Hook</span></a></h3><p><strong>执行时机：</strong> 用户进程启动后，start 操作返回前<br><strong>执行命名空间：</strong> Runtime Namespace（运行时命名空间）<br><strong>路径解析：</strong> Runtime Namespace</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;hooks&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;poststart&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/usr/local/bin/health-monitor&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;health-monitor&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--start-monitoring&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;env&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;MONITOR_INTERVAL=30s&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;timeout&quot;</span><span class="token operator">:</span> <span class="token number">5</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/usr/local/bin/notify-service&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;notify-service&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--event=container-started&quot;</span><span class="token punctuation">]</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>典型用例：</strong></p><ul><li>健康检查启动</li><li>监控系统通知</li><li>负载均衡器注册</li><li>日志收集器启动</li></ul><p><strong>容器生命周期状态：</strong></p><ul><li>用户进程已启动</li><li>容器处于运行状态</li><li>可以进行外部系统集成</li><li>Hook 失败不会影响容器运行</li></ul><h3 id="_5-poststop-hook" tabindex="-1"><a class="header-anchor" href="#_5-poststop-hook"><span>5. poststop Hook</span></a></h3><p><strong>执行时机：</strong> 容器删除后，delete 操作返回前<br><strong>执行命名空间：</strong> Runtime Namespace（运行时命名空间）<br><strong>路径解析：</strong> Runtime Namespace</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;hooks&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;poststop&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/usr/local/bin/cleanup-resources&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;cleanup-resources&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--container-id&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;env&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;CLEANUP_TIMEOUT=300s&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;timeout&quot;</span><span class="token operator">:</span> <span class="token number">60</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/usr/local/bin/audit-log&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;audit-log&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--event=container-stopped&quot;</span><span class="token punctuation">]</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>典型用例：</strong></p><ul><li>资源清理</li><li>审计日志记录</li><li>负载均衡器注销</li><li>临时文件删除</li></ul><p><strong>容器生命周期状态：</strong></p><ul><li>容器进程已退出</li><li>容器资源正在清理</li><li>可以执行清理和审计操作</li><li>Hook 失败不会阻止删除操作</li></ul><h2 id="hook-标准输入格式" tabindex="-1"><a class="header-anchor" href="#hook-标准输入格式"><span>Hook 标准输入格式</span></a></h2><h3 id="容器状态结构" tabindex="-1"><a class="header-anchor" href="#容器状态结构"><span>容器状态结构</span></a></h3><p>Hook 通过标准输入接收 JSON 格式的容器状态信息：</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;ociVersion&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.2&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;container-12345&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;created&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;pid&quot;</span><span class="token operator">:</span> <span class="token number">1234</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;bundle&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/var/lib/containers/container-12345&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;annotations&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;com.example.app&quot;</span><span class="token operator">:</span> <span class="token string">&quot;web-server&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;com.example.version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;v1.2.3&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="状态字段详解" tabindex="-1"><a class="header-anchor" href="#状态字段详解"><span>状态字段详解</span></a></h3><table><thead><tr><th>字段</th><th>类型</th><th>必需</th><th>说明</th></tr></thead><tbody><tr><td><code>ociVersion</code></td><td>string</td><td>是</td><td>OCI 规范版本</td></tr><tr><td><code>id</code></td><td>string</td><td>是</td><td>容器唯一标识符</td></tr><tr><td><code>status</code></td><td>string</td><td>是</td><td>容器状态：creating/created/running/stopped</td></tr><tr><td><code>pid</code></td><td>int</td><td>条件</td><td>容器进程 PID（Linux 上 created/running 状态必需）</td></tr><tr><td><code>bundle</code></td><td>string</td><td>是</td><td>Bundle 目录绝对路径</td></tr><tr><td><code>annotations</code></td><td>object</td><td>否</td><td>容器注解信息</td></tr></tbody></table><h3 id="不同-hook-类型的状态差异" tabindex="-1"><a class="header-anchor" href="#不同-hook-类型的状态差异"><span>不同 Hook 类型的状态差异</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># createRuntime Hook 接收的状态</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&quot;status&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;creating&quot;</span>,</span>
<span class="line">    <span class="token string">&quot;pid&quot;</span><span class="token builtin class-name">:</span> <span class="token number">0</span>  <span class="token comment"># 进程尚未启动</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># createContainer Hook 接收的状态</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&quot;status&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;creating&quot;</span>,</span>
<span class="line">    <span class="token string">&quot;pid&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1234</span>  <span class="token comment"># 容器进程已创建但未启动</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># startContainer Hook 接收的状态</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&quot;status&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;created&quot;</span>,</span>
<span class="line">    <span class="token string">&quot;pid&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1234</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># poststart Hook 接收的状态</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&quot;status&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;running&quot;</span>,</span>
<span class="line">    <span class="token string">&quot;pid&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1234</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># poststop Hook 接收的状态</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&quot;status&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;stopped&quot;</span>,</span>
<span class="line">    <span class="token string">&quot;pid&quot;</span><span class="token builtin class-name">:</span> <span class="token number">0</span>  <span class="token comment"># 进程已退出</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="hook-实现示例" tabindex="-1"><a class="header-anchor" href="#hook-实现示例"><span>Hook 实现示例</span></a></h2><h3 id="_1-网络配置-hook-go-实现" tabindex="-1"><a class="header-anchor" href="#_1-网络配置-hook-go-实现"><span>1. 网络配置 Hook（Go 实现）</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">package</span> main</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;encoding/json&quot;</span></span>
<span class="line">    <span class="token string">&quot;fmt&quot;</span></span>
<span class="line">    <span class="token string">&quot;io&quot;</span></span>
<span class="line">    <span class="token string">&quot;os&quot;</span></span>
<span class="line">    <span class="token string">&quot;os/exec&quot;</span></span>
<span class="line">    <span class="token string">&quot;github.com/opencontainers/runtime-spec/specs-go&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 读取容器状态</span></span>
<span class="line">    stateData<span class="token punctuation">,</span> err <span class="token operator">:=</span> io<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdin<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">&quot;Failed to read state: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">var</span> state specs<span class="token punctuation">.</span>State</span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>stateData<span class="token punctuation">,</span> <span class="token operator">&amp;</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">&quot;Failed to parse state: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 根据容器状态执行网络配置</span></span>
<span class="line">    <span class="token keyword">switch</span> state<span class="token punctuation">.</span>Status <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&quot;creating&quot;</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setupNetwork</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> state<span class="token punctuation">.</span>Pid<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">&quot;Network setup failed: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">            os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&quot;stopped&quot;</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">cleanupNetwork</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>ID<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">&quot;Network cleanup failed: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">            os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Network hook completed for container %s\n&quot;</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>ID<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setupNetwork</span><span class="token punctuation">(</span>containerID <span class="token builtin">string</span><span class="token punctuation">,</span> pid <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 创建 veth 对</span></span>
<span class="line">    vethHost <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;veth-%s-host&quot;</span><span class="token punctuation">,</span> containerID<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    vethContainer <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;veth-%s-cont&quot;</span><span class="token punctuation">,</span> containerID<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    cmd <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span><span class="token string">&quot;ip&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;link&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;add&quot;</span><span class="token punctuation">,</span> vethHost<span class="token punctuation">,</span> <span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;veth&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;peer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> vethContainer<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to create veth pair: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 将容器端移入容器网络命名空间</span></span>
<span class="line">    cmd <span class="token operator">=</span> exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span><span class="token string">&quot;ip&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;link&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;set&quot;</span><span class="token punctuation">,</span> vethContainer<span class="token punctuation">,</span> <span class="token string">&quot;netns&quot;</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%d&quot;</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to move veth to container: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 配置主机端接口</span></span>
<span class="line">    cmd <span class="token operator">=</span> exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span><span class="token string">&quot;ip&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;link&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;set&quot;</span><span class="token punctuation">,</span> vethHost<span class="token punctuation">,</span> <span class="token string">&quot;up&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to bring up host veth: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">cleanupNetwork</span><span class="token punctuation">(</span>containerID <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    vethHost <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;veth-%s-host&quot;</span><span class="token punctuation">,</span> containerID<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    cmd <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span><span class="token string">&quot;ip&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;link&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;delete&quot;</span><span class="token punctuation">,</span> vethHost<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to delete veth: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-安全审计-hook-python-实现" tabindex="-1"><a class="header-anchor" href="#_2-安全审计-hook-python-实现"><span>2. 安全审计 Hook（Python 实现）</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment">#!/usr/bin/env python3</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> json</span>
<span class="line"><span class="token keyword">import</span> sys</span>
<span class="line"><span class="token keyword">import</span> os</span>
<span class="line"><span class="token keyword">import</span> time</span>
<span class="line"><span class="token keyword">import</span> logging</span>
<span class="line"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 配置日志</span></span>
<span class="line">logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span></span>
<span class="line">    filename<span class="token operator">=</span><span class="token string">&#39;/var/log/container-audit.log&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span></span>
<span class="line">    <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">&#39;%(asctime)s - %(levelname)s - %(message)s&#39;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 读取容器状态</span></span>
<span class="line">        state_data <span class="token operator">=</span> sys<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        state <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>state_data<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 执行审计操作</span></span>
<span class="line">        audit_container_event<span class="token punctuation">(</span>state<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></span>
<span class="line">        logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Audit hook failed: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">audit_container_event</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;记录容器事件到审计日志&quot;&quot;&quot;</span></span>
<span class="line">    </span>
<span class="line">    event_data <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&#39;timestamp&#39;</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&#39;container_id&#39;</span><span class="token punctuation">:</span> state<span class="token punctuation">[</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&#39;status&#39;</span><span class="token punctuation">:</span> state<span class="token punctuation">[</span><span class="token string">&#39;status&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&#39;pid&#39;</span><span class="token punctuation">:</span> state<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;pid&#39;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&#39;bundle&#39;</span><span class="token punctuation">:</span> state<span class="token punctuation">[</span><span class="token string">&#39;bundle&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&#39;annotations&#39;</span><span class="token punctuation">:</span> state<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;annotations&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&#39;user&#39;</span><span class="token punctuation">:</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;USER&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;unknown&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&#39;hook_type&#39;</span><span class="token punctuation">:</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;HOOK_TYPE&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;unknown&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 记录安全相关的注解</span></span>
<span class="line">    security_annotations <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        k<span class="token punctuation">:</span> v <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> event_data<span class="token punctuation">[</span><span class="token string">&#39;annotations&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> k<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&#39;security.&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;com.example.security.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> security_annotations<span class="token punctuation">:</span></span>
<span class="line">        event_data<span class="token punctuation">[</span><span class="token string">&#39;security_context&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> security_annotations</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 检查高风险操作</span></span>
<span class="line">    <span class="token keyword">if</span> is_high_risk_container<span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        event_data<span class="token punctuation">[</span><span class="token string">&#39;risk_level&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&#39;HIGH&#39;</span></span>
<span class="line">        logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;High-risk container operation: </span><span class="token interpolation"><span class="token punctuation">{</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>event_data<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">        event_data<span class="token punctuation">[</span><span class="token string">&#39;risk_level&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&#39;NORMAL&#39;</span></span>
<span class="line">        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Container operation: </span><span class="token interpolation"><span class="token punctuation">{</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>event_data<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 发送到 SIEM 系统（示例）</span></span>
<span class="line">    send_to_siem<span class="token punctuation">(</span>event_data<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">is_high_risk_container</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;检查是否为高风险容器&quot;&quot;&quot;</span></span>
<span class="line">    annotations <span class="token operator">=</span> state<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;annotations&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 检查特权容器</span></span>
<span class="line">    <span class="token keyword">if</span> annotations<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;security.privileged&#39;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&#39;true&#39;</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">True</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 检查主机网络</span></span>
<span class="line">    <span class="token keyword">if</span> annotations<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;network.mode&#39;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&#39;host&#39;</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">True</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 检查敏感挂载</span></span>
<span class="line">    sensitive_mounts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;/proc&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/sys&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/dev&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/var/run/docker.sock&#39;</span><span class="token punctuation">]</span></span>
<span class="line">    bundle_path <span class="token operator">=</span> state<span class="token punctuation">[</span><span class="token string">&#39;bundle&#39;</span><span class="token punctuation">]</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>bundle_path<span class="token punctuation">}</span></span><span class="token string">/config.json&quot;</span></span><span class="token punctuation">,</span> <span class="token string">&#39;r&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></span>
<span class="line">            config <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span></span>
<span class="line">            mounts <span class="token operator">=</span> config<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;mounts&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">for</span> mount <span class="token keyword">in</span> mounts<span class="token punctuation">:</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token builtin">any</span><span class="token punctuation">(</span>mount<span class="token punctuation">[</span><span class="token string">&#39;destination&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span>sm<span class="token punctuation">)</span> <span class="token keyword">for</span> sm <span class="token keyword">in</span> sensitive_mounts<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">                    <span class="token keyword">return</span> <span class="token boolean">True</span></span>
<span class="line">    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">pass</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">False</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">send_to_siem</span><span class="token punctuation">(</span>event_data<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;发送事件到 SIEM 系统&quot;&quot;&quot;</span></span>
<span class="line">    <span class="token comment"># 这里可以集成实际的 SIEM 系统</span></span>
<span class="line">    <span class="token comment"># 例如：Splunk, ELK, 等</span></span>
<span class="line">    <span class="token keyword">pass</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span></span>
<span class="line">    main<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-健康检查-hook-shell-实现" tabindex="-1"><a class="header-anchor" href="#_3-健康检查-hook-shell-实现"><span>3. 健康检查 Hook（Shell 实现）</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># health-check-hook.sh</span></span>
<span class="line"><span class="token comment"># 容器健康检查 Hook</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">set</span> <span class="token parameter variable">-euo</span> pipefail</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 读取容器状态</span></span>
<span class="line"><span class="token assign-left variable">STATE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span><span class="token variable">)</span></span></span>
<span class="line"><span class="token assign-left variable">CONTAINER_ID</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$STATE</span>&quot;</span> <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> <span class="token string">&#39;.id&#39;</span><span class="token variable">)</span></span></span>
<span class="line"><span class="token assign-left variable">STATUS</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$STATE</span>&quot;</span> <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> <span class="token string">&#39;.status&#39;</span><span class="token variable">)</span></span></span>
<span class="line"><span class="token assign-left variable">PID</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$STATE</span>&quot;</span> <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> <span class="token string">&#39;.pid // 0&#39;</span><span class="token variable">)</span></span></span>
<span class="line"><span class="token assign-left variable">BUNDLE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$STATE</span>&quot;</span> <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> <span class="token string">&#39;.bundle&#39;</span><span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 日志函数</span></span>
<span class="line"><span class="token function-name function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;[<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> <span class="token string">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="token variable">)</span></span>] <span class="token variable">$1</span>&quot;</span> <span class="token operator">&gt;&gt;</span> /var/log/health-check.log</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 主逻辑</span></span>
<span class="line"><span class="token keyword">case</span> <span class="token string">&quot;<span class="token variable">$STATUS</span>&quot;</span> <span class="token keyword">in</span></span>
<span class="line">    <span class="token string">&quot;running&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        start_health_monitoring</span>
<span class="line">        <span class="token punctuation">;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token string">&quot;stopped&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        stop_health_monitoring</span>
<span class="line">        <span class="token punctuation">;</span><span class="token punctuation">;</span></span>
<span class="line">    *<span class="token punctuation">)</span></span>
<span class="line">        log <span class="token string">&quot;INFO: No action needed for status: <span class="token variable">$STATUS</span>&quot;</span></span>
<span class="line">        <span class="token punctuation">;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">esac</span></span>
<span class="line"></span>
<span class="line"><span class="token function-name function">start_health_monitoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    log <span class="token string">&quot;INFO: Starting health monitoring for container <span class="token variable">$CONTAINER_ID</span> (PID: <span class="token variable">$PID</span>)&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 创建健康检查配置</span></span>
<span class="line">    <span class="token assign-left variable">HEALTH_CONFIG</span><span class="token operator">=</span><span class="token string">&quot;/var/lib/health-checks/<span class="token variable">$CONTAINER_ID</span>.conf&quot;</span></span>
<span class="line">    <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">dirname</span> <span class="token string">&quot;<span class="token variable">$HEALTH_CONFIG</span>&quot;</span><span class="token variable">)</span></span>&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">cat</span> <span class="token operator">&gt;</span> <span class="token string">&quot;<span class="token variable">$HEALTH_CONFIG</span>&quot;</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF</span>
<span class="line">CONTAINER_ID=<span class="token variable">$CONTAINER_ID</span></span>
<span class="line">PID=<span class="token variable">$PID</span></span>
<span class="line">BUNDLE=<span class="token variable">$BUNDLE</span></span>
<span class="line">START_TIME=<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> <span class="token string">&#39;+%s&#39;</span><span class="token variable">)</span></span></span>
<span class="line">HEALTH_CHECK_INTERVAL=30</span>
<span class="line">HEALTH_CHECK_TIMEOUT=10</span>
<span class="line">HEALTH_CHECK_RETRIES=3</span>
<span class="line">EOF</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 启动健康检查守护进程</span></span>
<span class="line">    <span class="token function">nohup</span> /usr/local/bin/health-monitor <span class="token string">&quot;<span class="token variable">$HEALTH_CONFIG</span>&quot;</span> <span class="token operator">&gt;</span> /dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token variable">$!</span> <span class="token operator">&gt;</span> <span class="token string">&quot;/var/run/health-monitor-<span class="token variable">$CONTAINER_ID</span>.pid&quot;</span></span>
<span class="line">    </span>
<span class="line">    log <span class="token string">&quot;INFO: Health monitoring started for container <span class="token variable">$CONTAINER_ID</span>&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token function-name function">stop_health_monitoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    log <span class="token string">&quot;INFO: Stopping health monitoring for container <span class="token variable">$CONTAINER_ID</span>&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 停止健康检查守护进程</span></span>
<span class="line">    <span class="token assign-left variable">PID_FILE</span><span class="token operator">=</span><span class="token string">&quot;/var/run/health-monitor-<span class="token variable">$CONTAINER_ID</span>.pid&quot;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-f</span> <span class="token string">&quot;<span class="token variable">$PID_FILE</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token assign-left variable">MONITOR_PID</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> <span class="token string">&quot;<span class="token variable">$PID_FILE</span>&quot;</span><span class="token variable">)</span></span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token function">kill</span> <span class="token parameter variable">-0</span> <span class="token string">&quot;<span class="token variable">$MONITOR_PID</span>&quot;</span> <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">            <span class="token function">kill</span> <span class="token string">&quot;<span class="token variable">$MONITOR_PID</span>&quot;</span></span>
<span class="line">            log <span class="token string">&quot;INFO: Health monitor process <span class="token variable">$MONITOR_PID</span> terminated&quot;</span></span>
<span class="line">        <span class="token keyword">fi</span></span>
<span class="line">        <span class="token function">rm</span> <span class="token parameter variable">-f</span> <span class="token string">&quot;<span class="token variable">$PID_FILE</span>&quot;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 清理配置文件</span></span>
<span class="line">    <span class="token function">rm</span> <span class="token parameter variable">-f</span> <span class="token string">&quot;/var/lib/health-checks/<span class="token variable">$CONTAINER_ID</span>.conf&quot;</span></span>
<span class="line">    </span>
<span class="line">    log <span class="token string">&quot;INFO: Health monitoring cleanup completed for container <span class="token variable">$CONTAINER_ID</span>&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">log <span class="token string">&quot;INFO: Health check hook completed for container <span class="token variable">$CONTAINER_ID</span>&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="高级-hook-配置" tabindex="-1"><a class="header-anchor" href="#高级-hook-配置"><span>高级 Hook 配置</span></a></h2><h3 id="_1-条件执行-hook" tabindex="-1"><a class="header-anchor" href="#_1-条件执行-hook"><span>1. 条件执行 Hook</span></a></h3><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;hooks&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;createRuntime&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/usr/local/bin/conditional-hook&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;conditional-hook&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--check-annotation&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;network.type&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;env&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">                    <span class="token string">&quot;REQUIRED_ANNOTATION=network.type=custom&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;ACTION=setup-custom-network&quot;</span></span>
<span class="line">                <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;timeout&quot;</span><span class="token operator">:</span> <span class="token number">30</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-多阶段-hook-链" tabindex="-1"><a class="header-anchor" href="#_2-多阶段-hook-链"><span>2. 多阶段 Hook 链</span></a></h3><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;hooks&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;createRuntime&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/usr/local/bin/stage1-network&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;stage1-network&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--prepare&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;timeout&quot;</span><span class="token operator">:</span> <span class="token number">15</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/usr/local/bin/stage2-security&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;stage2-security&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--apply-policies&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;timeout&quot;</span><span class="token operator">:</span> <span class="token number">20</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/usr/local/bin/stage3-monitoring&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;stage3-monitoring&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--enable&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;timeout&quot;</span><span class="token operator">:</span> <span class="token number">10</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-环境特定-hook" tabindex="-1"><a class="header-anchor" href="#_3-环境特定-hook"><span>3. 环境特定 Hook</span></a></h3><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;hooks&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;createRuntime&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/usr/local/bin/env-specific-hook&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;env-specific-hook&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;env&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">                    <span class="token string">&quot;ENVIRONMENT=production&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;DATACENTER=us-west-2&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;CLUSTER_NAME=prod-cluster-01&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;SECURITY_LEVEL=high&quot;</span></span>
<span class="line">                <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;timeout&quot;</span><span class="token operator">:</span> <span class="token number">60</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="hook-错误处理与调试" tabindex="-1"><a class="header-anchor" href="#hook-错误处理与调试"><span>Hook 错误处理与调试</span></a></h2><h3 id="_1-错误处理策略" tabindex="-1"><a class="header-anchor" href="#_1-错误处理策略"><span>1. 错误处理策略</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// Hook 错误处理示例</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">executeHookWithRetry</span><span class="token punctuation">(</span>hook <span class="token operator">*</span>Hook<span class="token punctuation">,</span> state <span class="token operator">*</span>specs<span class="token punctuation">.</span>State<span class="token punctuation">,</span> maxRetries <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> lastErr <span class="token builtin">error</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> maxRetries<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> i <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">            time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span></span>
<span class="line">            log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Retrying hook execution (attempt %d/%d)&quot;</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> maxRetries<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        err <span class="token operator">:=</span> hook<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        lastErr <span class="token operator">=</span> err</span>
<span class="line">        log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Hook execution failed (attempt %d): %v&quot;</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 检查是否为可重试的错误</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">isRetryableError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">break</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;hook failed after %d attempts: %w&quot;</span><span class="token punctuation">,</span> maxRetries<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> lastErr<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">isRetryableError</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 网络错误、临时文件系统错误等可以重试</span></span>
<span class="line">    <span class="token keyword">return</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;network&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span></span>
<span class="line">           strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;temporary&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span></span>
<span class="line">           strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;timeout&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-hook-调试工具" tabindex="-1"><a class="header-anchor" href="#_2-hook-调试工具"><span>2. Hook 调试工具</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># hook-debugger.sh</span></span>
<span class="line"><span class="token comment"># Hook 调试工具</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">DEBUG_DIR</span><span class="token operator">=</span><span class="token string">&quot;/var/log/hook-debug&quot;</span></span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token string">&quot;<span class="token variable">$DEBUG_DIR</span>&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 记录 Hook 执行信息</span></span>
<span class="line"><span class="token function-name function">log_hook_execution</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin class-name">local</span> <span class="token assign-left variable">hook_name</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$1</span>&quot;</span></span>
<span class="line">    <span class="token builtin class-name">local</span> <span class="token assign-left variable">container_id</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$2</span>&quot;</span></span>
<span class="line">    <span class="token builtin class-name">local</span> <span class="token assign-left variable">timestamp</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> <span class="token string">&#39;+%Y%m%d_%H%M%S&#39;</span><span class="token variable">)</span></span></span>
<span class="line">    <span class="token builtin class-name">local</span> <span class="token assign-left variable">debug_file</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$DEBUG_DIR</span>/<span class="token variable">${hook_name}</span>_<span class="token variable">${container_id}</span>_<span class="token variable">${timestamp}</span>.log&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;=== Hook Execution Debug Info ===&quot;</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;Hook Name: <span class="token variable">$hook_name</span>&quot;</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;Container ID: <span class="token variable">$container_id</span>&quot;</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;Timestamp: <span class="token variable"><span class="token variable">$(</span><span class="token function">date</span><span class="token variable">)</span></span>&quot;</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;PID: <span class="token variable">$$</span>&quot;</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;User: <span class="token variable"><span class="token variable">$(</span><span class="token function">whoami</span><span class="token variable">)</span></span>&quot;</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;Working Directory: <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>&quot;</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;Environment:&quot;</span></span>
<span class="line">        <span class="token function">env</span> <span class="token operator">|</span> <span class="token function">sort</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token entity" title="\n">\n</span>=== Container State ===&quot;</span></span>
<span class="line">        <span class="token function">cat</span>  <span class="token comment"># 从标准输入读取状态</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token entity" title="\n">\n</span>=== System Info ===&quot;</span></span>
<span class="line">        <span class="token function">uname</span> <span class="token parameter variable">-a</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token entity" title="\n">\n</span>=== Network Interfaces ===&quot;</span></span>
<span class="line">        <span class="token function">ip</span> addr show</span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token entity" title="\n">\n</span>=== Mount Points ===&quot;</span></span>
<span class="line">        <span class="token function">mount</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token entity" title="\n">\n</span>=== Process Tree ===&quot;</span></span>
<span class="line">        <span class="token function">ps</span> auxf</span>
<span class="line">    <span class="token punctuation">}</span> <span class="token operator">&gt;</span> <span class="token string">&quot;<span class="token variable">$debug_file</span>&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;Debug info saved to: <span class="token variable">$debug_file</span>&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 使用示例</span></span>
<span class="line"><span class="token comment"># echo &quot;$STATE&quot; | log_hook_execution &quot;createRuntime&quot; &quot;$CONTAINER_ID&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-hook-性能监控" tabindex="-1"><a class="header-anchor" href="#_3-hook-性能监控"><span>3. Hook 性能监控</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment">#!/usr/bin/env python3</span></span>
<span class="line"><span class="token comment"># hook-profiler.py</span></span>
<span class="line"><span class="token comment"># Hook 性能监控工具</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> json</span>
<span class="line"><span class="token keyword">import</span> sys</span>
<span class="line"><span class="token keyword">import</span> time</span>
<span class="line"><span class="token keyword">import</span> psutil</span>
<span class="line"><span class="token keyword">import</span> os</span>
<span class="line"><span class="token keyword">from</span> contextlib <span class="token keyword">import</span> contextmanager</span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">HookProfiler</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> hook_name<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>hook_name <span class="token operator">=</span> hook_name</span>
<span class="line">        self<span class="token punctuation">.</span>start_time <span class="token operator">=</span> <span class="token boolean">None</span></span>
<span class="line">        self<span class="token punctuation">.</span>end_time <span class="token operator">=</span> <span class="token boolean">None</span></span>
<span class="line">        self<span class="token punctuation">.</span>peak_memory <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">        self<span class="token punctuation">.</span>peak_cpu <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">        </span>
<span class="line">    <span class="token decorator annotation punctuation">@contextmanager</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">profile</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;性能监控上下文管理器&quot;&quot;&quot;</span></span>
<span class="line">        self<span class="token punctuation">.</span>start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        process <span class="token operator">=</span> psutil<span class="token punctuation">.</span>Process<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">yield</span> self</span>
<span class="line">        <span class="token keyword">finally</span><span class="token punctuation">:</span></span>
<span class="line">            self<span class="token punctuation">.</span>end_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            self<span class="token punctuation">.</span>peak_memory <span class="token operator">=</span> process<span class="token punctuation">.</span>memory_info<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rss</span>
<span class="line">            self<span class="token punctuation">.</span>peak_cpu <span class="token operator">=</span> process<span class="token punctuation">.</span>cpu_percent<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">report</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;生成性能报告&quot;&quot;&quot;</span></span>
<span class="line">        duration <span class="token operator">=</span> self<span class="token punctuation">.</span>end_time <span class="token operator">-</span> self<span class="token punctuation">.</span>start_time</span>
<span class="line">        </span>
<span class="line">        report <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;hook_name&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>hook_name<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;duration_seconds&#39;</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>duration<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;peak_memory_mb&#39;</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>peak_memory <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;peak_cpu_percent&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>peak_cpu<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;timestamp&#39;</span><span class="token punctuation">:</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 写入性能日志</span></span>
<span class="line">        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&#39;/var/log/hook-performance.log&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;a&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></span>
<span class="line">            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>report<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;\n&#39;</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">        <span class="token keyword">return</span> report</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 使用示例</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    hook_name <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token string">&#39;unknown&#39;</span></span>
<span class="line">    profiler <span class="token operator">=</span> HookProfiler<span class="token punctuation">(</span>hook_name<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">with</span> profiler<span class="token punctuation">.</span>profile<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 执行实际的 Hook 逻辑</span></span>
<span class="line">        state_data <span class="token operator">=</span> sys<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        state <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>state_data<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 模拟 Hook 操作</span></span>
<span class="line">        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>  <span class="token comment"># 替换为实际操作</span></span>
<span class="line">        </span>
<span class="line">    <span class="token comment"># 生成性能报告</span></span>
<span class="line">    report <span class="token operator">=</span> profiler<span class="token punctuation">.</span>report<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Hook </span><span class="token interpolation"><span class="token punctuation">{</span>hook_name<span class="token punctuation">}</span></span><span class="token string"> completed in </span><span class="token interpolation"><span class="token punctuation">{</span>report<span class="token punctuation">[</span><span class="token string">&#39;duration_seconds&#39;</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">s&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span></span>
<span class="line">    main<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="生产环境最佳实践" tabindex="-1"><a class="header-anchor" href="#生产环境最佳实践"><span>生产环境最佳实践</span></a></h2><h3 id="_1-hook-安全配置" tabindex="-1"><a class="header-anchor" href="#_1-hook-安全配置"><span>1. Hook 安全配置</span></a></h3><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;hooks&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;createRuntime&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/usr/local/bin/secure-hook&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;secure-hook&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--verify-signature&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;env&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">                    <span class="token string">&quot;HOOK_SIGNATURE_KEY=/etc/hook-keys/public.pem&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;HOOK_LOG_LEVEL=INFO&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;HOOK_AUDIT_ENABLED=true&quot;</span></span>
<span class="line">                <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">&quot;timeout&quot;</span><span class="token operator">:</span> <span class="token number">30</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-hook-资源限制" tabindex="-1"><a class="header-anchor" href="#_2-hook-资源限制"><span>2. Hook 资源限制</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># resource-limited-hook.sh</span></span>
<span class="line"><span class="token comment"># 带资源限制的 Hook</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 设置资源限制</span></span>
<span class="line"><span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-m</span> <span class="token number">102400</span>  <span class="token comment"># 100MB 内存限制</span></span>
<span class="line"><span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-t</span> <span class="token number">30</span>      <span class="token comment"># 30秒 CPU 时间限制</span></span>
<span class="line"><span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-f</span> <span class="token number">10240</span>   <span class="token comment"># 10MB 文件大小限制</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 设置优先级</span></span>
<span class="line"><span class="token function">nice</span> <span class="token parameter variable">-n</span> <span class="token number">10</span> <span class="token string">&quot;<span class="token variable">$@</span>&quot;</span>  <span class="token comment"># 降低优先级</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-hook-监控集成" tabindex="-1"><a class="header-anchor" href="#_3-hook-监控集成"><span>3. Hook 监控集成</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token comment"># prometheus-hook-metrics.yaml</span></span>
<span class="line"><span class="token comment"># Prometheus 监控配置</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> hook<span class="token punctuation">-</span>monitoring</span>
<span class="line"><span class="token key atrule">data</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">hook-exporter.py</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">    #!/usr/bin/env python3</span>
<span class="line">    import json</span>
<span class="line">    import time</span>
<span class="line">    from prometheus_client import Counter, Histogram, start_http_server</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 定义指标</span></span>
<span class="line">    HOOK_EXECUTIONS = Counter(&#39;hook_executions_total&#39;<span class="token punctuation">,</span> <span class="token string">&#39;Total hook executions&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;hook_type&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;status&#39;</span><span class="token punctuation">]</span>)</span>
<span class="line">    HOOK_DURATION = Histogram(&#39;hook_duration_seconds&#39;<span class="token punctuation">,</span> <span class="token string">&#39;Hook execution duration&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;hook_type&#39;</span><span class="token punctuation">]</span>)</span>
<span class="line">    </span>
<span class="line">    def record_hook_execution(hook_type<span class="token punctuation">,</span> duration<span class="token punctuation">,</span> <span class="token key atrule">success)</span><span class="token punctuation">:</span></span>
<span class="line">        status = &#39;success&#39; if success else &#39;failure&#39;</span>
<span class="line">        HOOK_EXECUTIONS.labels(hook_type=hook_type<span class="token punctuation">,</span> status=status).inc()</span>
<span class="line">        HOOK_DURATION.labels(hook_type=hook_type).observe(duration)</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 启动 Prometheus 指标服务器</span></span>
<span class="line">    start_http_server(8000)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="故障排除指南" tabindex="-1"><a class="header-anchor" href="#故障排除指南"><span>故障排除指南</span></a></h2><h3 id="常见问题与解决方案" tabindex="-1"><a class="header-anchor" href="#常见问题与解决方案"><span>常见问题与解决方案</span></a></h3><ol><li><p><strong>Hook 超时问题</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 检查 Hook 执行时间</span></span>
<span class="line"><span class="token function">time</span> /usr/local/bin/your-hook <span class="token operator">&lt;</span> state.json</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 增加超时时间或优化 Hook 逻辑</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&quot;timeout&quot;</span><span class="token builtin class-name">:</span> <span class="token number">120</span>  <span class="token comment"># 增加到 2 分钟</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>权限问题</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 检查 Hook 文件权限</span></span>
<span class="line"><span class="token function">ls</span> <span class="token parameter variable">-la</span> /usr/local/bin/your-hook</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 确保可执行权限</span></span>
<span class="line"><span class="token function">chmod</span> +x /usr/local/bin/your-hook</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>命名空间问题</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 检查 Hook 执行的命名空间</span></span>
<span class="line">nsenter <span class="token parameter variable">-t</span> <span class="token variable">$PID</span> <span class="token parameter variable">-n</span> <span class="token function">ip</span> addr show</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>依赖缺失</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 检查 Hook 依赖</span></span>
<span class="line">ldd /usr/local/bin/your-hook</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 在容器中测试</span></span>
<span class="line"><span class="token function">docker</span> run <span class="token parameter variable">--rm</span> <span class="token parameter variable">-v</span> /usr/local/bin/your-hook:/hook alpine /hook</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><p>OCI Hook 系统为容器生命周期管理提供了强大的扩展能力。通过合理使用不同类型的 Hook，可以实现：</p><ul><li><strong>网络配置自动化</strong> - 动态网络设置和清理</li><li><strong>安全策略执行</strong> - 运行时安全检查和审计</li><li><strong>监控集成</strong> - 容器状态监控和告警</li><li><strong>资源管理</strong> - 动态资源分配和清理</li><li><strong>服务发现</strong> - 自动服务注册和注销</li></ul><p>在生产环境中使用 Hook 时，需要特别注意：</p><ol><li><strong>性能影响</strong> - Hook 会影响容器启动时间</li><li><strong>错误处理</strong> - 合理的超时和重试机制</li><li><strong>安全考虑</strong> - Hook 具有较高权限，需要严格控制</li><li><strong>监控调试</strong> - 完善的日志和监控机制</li><li><strong>版本兼容</strong> - 确保 Hook 与不同 OCI 运行时的兼容性</li></ol><p>通过深入理解 Hook 系统的工作原理和最佳实践，可以构建更加灵活、安全、可观测的容器化应用平台。</p><h2 id="参考资源" tabindex="-1"><a class="header-anchor" href="#参考资源"><span>参考资源</span></a></h2><ul><li><a href="https://github.com/opencontainers/runtime-spec/blob/main/config.md#posix-platform-hooks" target="_blank" rel="noopener noreferrer">OCI Runtime Specification - Hooks<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/opencontainers/runc/blob/main/libcontainer/configs/config.go" target="_blank" rel="noopener noreferrer">runc Hook Implementation<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/opencontainers/runtime-spec/blob/main/runtime.md#lifecycle" target="_blank" rel="noopener noreferrer">Container Lifecycle<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/opencontainers/runtime-spec/tree/main/schema/test" target="_blank" rel="noopener noreferrer">Hook Examples<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul></div></div><footer class="page-meta"><div class="meta-item edit-link"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M2 26h28v2H2z" fill="currentColor"></path><path d="M25.4 9c.8-.8.8-2 0-2.8l-3.6-3.6c-.8-.8-2-.8-2.8 0l-15 15V24h6.4l15-15zm-5-5L24 7.6l-3 3L17.4 7l3-3zM6 22v-3.6l10-10l3.6 3.6l-10 10H6z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Edit this page<!--]--></span></span></div><div class="meta-item last-updated"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->更新于 8/6/2025, 6:07:26 PM<!--]--></span></span></div></footer><!----><div class="reco-valine-wrapper"><div id="valine"></div></div></div><div class="page-catalog-container"><h5 class="tip">目录</h5><ul><!--[--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#概述" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="概述"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->概述<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#hook-系统特点" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="Hook 系统特点"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Hook 系统特点<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#hook-类型与执行时机" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="Hook 类型与执行时机"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Hook 类型与执行时机<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#_1-createruntime-hook" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1. createRuntime Hook"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1. createRuntime Hook<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#_2-createcontainer-hook" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2. createContainer Hook"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2. createContainer Hook<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#_3-startcontainer-hook" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3. startContainer Hook"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3. startContainer Hook<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#_4-poststart-hook" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4. poststart Hook"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4. poststart Hook<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#_5-poststop-hook" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5. poststop Hook"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5. poststop Hook<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#hook-标准输入格式" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="Hook 标准输入格式"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Hook 标准输入格式<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#容器状态结构" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="容器状态结构"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->容器状态结构<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#状态字段详解" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="状态字段详解"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->状态字段详解<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#不同-hook-类型的状态差异" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="不同 Hook 类型的状态差异"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->不同 Hook 类型的状态差异<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#hook-实现示例" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="Hook 实现示例"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Hook 实现示例<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#_1-网络配置-hook-go-实现" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1. 网络配置 Hook（Go 实现）"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1. 网络配置 Hook（Go 实现）<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#_2-安全审计-hook-python-实现" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2. 安全审计 Hook（Python 实现）"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2. 安全审计 Hook（Python 实现）<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#_3-健康检查-hook-shell-实现" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3. 健康检查 Hook（Shell 实现）"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3. 健康检查 Hook（Shell 实现）<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#高级-hook-配置" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="高级 Hook 配置"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->高级 Hook 配置<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#_1-条件执行-hook" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1. 条件执行 Hook"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1. 条件执行 Hook<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#_2-多阶段-hook-链" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2. 多阶段 Hook 链"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2. 多阶段 Hook 链<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#_3-环境特定-hook" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3. 环境特定 Hook"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3. 环境特定 Hook<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#hook-错误处理与调试" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="Hook 错误处理与调试"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Hook 错误处理与调试<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#_1-错误处理策略" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1. 错误处理策略"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1. 错误处理策略<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#_2-hook-调试工具" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2. Hook 调试工具"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2. Hook 调试工具<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#_3-hook-性能监控" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3. Hook 性能监控"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3. Hook 性能监控<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#生产环境最佳实践" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="生产环境最佳实践"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->生产环境最佳实践<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#_1-hook-安全配置" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1. Hook 安全配置"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1. Hook 安全配置<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#_2-hook-资源限制" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2. Hook 资源限制"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2. Hook 资源限制<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#_3-hook-监控集成" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3. Hook 监控集成"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3. Hook 监控集成<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#故障排除指南" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="故障排除指南"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->故障排除指南<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#常见问题与解决方案" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="常见问题与解决方案"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->常见问题与解决方案<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#总结" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="总结"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->总结<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/oci-08-hooks-deep-dive.html#参考资源" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="参考资源"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->参考资源<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--></ul></div></main><!--]--></div></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/blog/assets/app-2O6audqE.js" defer></script>
  </body>
</html>

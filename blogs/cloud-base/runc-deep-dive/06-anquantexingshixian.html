<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-rc.19">
    <script>
      (function() {
        const userMode = localStorage.getItem('vuepress-reco-color-scheme') || 'auto';
        const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (userMode === 'dark' || (userMode === 'auto' && systemDarkMode)) {
          document.documentElement.classList.toggle('dark', true);
        }
      })();
    </script>
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.min.js" as="script"><title>å®‰å…¨ç‰¹æ€§å®ç° | database of memory</title><meta name="description" content="study anything and life record">
    <link rel="preload" href="/blog/assets/style-3Js8NCR5.css" as="style"><link rel="stylesheet" href="/blog/assets/style-3Js8NCR5.css">
    <link rel="modulepreload" href="/blog/assets/app-2O6audqE.js"><link rel="modulepreload" href="/blog/assets/06-anquantexingshixian.html-BHgpOUyN.js">
    <link rel="prefetch" href="/blog/assets/timeline.html-Dpj3Uwd1.js" as="script"><link rel="prefetch" href="/blog/assets/posts.html-CwxCj2Hz.js" as="script"><link rel="prefetch" href="/blog/assets/friendship-link.html-BWfmkE8T.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-u-MzmdCM.js" as="script"><link rel="prefetch" href="/blog/assets/2.html-BZ918lqD.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-C0q1hGsM.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CKULWdoq.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CWtVNK-m.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bd6PVF3c.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BbXNqe1N.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DyPCaQFd.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-C18Bjk_W.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BBVLOTuN.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D6KsFqqv.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BFPB5Kke.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B7IkZhlZ.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D_xT1fZZ.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DheB4D6E.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bt_l6w3U.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DeILrr-C.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DSTAwzEO.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BD5fA-NV.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BkRrSqYz.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-cT5R8xwx.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D9YDDbbv.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CbwTJPe7.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BuOxUP39.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BonFf6Hv.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DdMSM_BO.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Cf_rINiA.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DAcku8Eg.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DXT9U0AY.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DNdoOP4f.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-gqCMVOP4.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-HV0Wu9t8.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-LYxcb78a.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B50wkuh6.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DmpqsxHB.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-ChJizRVK.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D91uHYKf.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BLywihRf.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CB6EOmHd.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CxeevLHu.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B6J1fqYY.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D6g5ki7n.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CNoSmcFz.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dg6Odx9T.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dcy99l4T.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BK5mIUzD.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-8yVN6cur.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D33sQ_DA.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BOgMey9f.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D-L5Fugg.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-blGV0Kuf.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Ck4-7Hl7.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-N5xZIiU3.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DHa_luE7.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BDo2AWiQ.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CJj46_t8.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B32LjB8A.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DHAALd4l.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-H_UWlmPh.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DhnB-W5f.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dl8_vnsm.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-AlHvVsZC.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D7E4OavF.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CgCAEUN3.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-4Mr3uCmo.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BWKUAlc0.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CNuv7HDI.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BTkfIlYg.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dqp54iE9.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CtCFev89.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bb4UAQpl.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B6JysInN.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CHu47ESV.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CW5fe8Pz.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CBCt-NmX.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DV90AmxE.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DzWzo9Ij.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bz0VyI0Z.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BjgscHtw.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Cx8p_sw9.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DoYWpPPd.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Ci-xHJlU.js" as="script"><link rel="prefetch" href="/blog/assets/2.html-DwdRHJG4.js" as="script"><link rel="prefetch" href="/blog/assets/3.html-DoXfDGmJ.js" as="script"><link rel="prefetch" href="/blog/assets/4.html-C-kKKJQV.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-fn4kmre_.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CoWvKsGl.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BvQMmH-P.js" as="script"><link rel="prefetch" href="/blog/assets/bitwise_operation.html-EhYVvxM9.js" as="script"><link rel="prefetch" href="/blog/assets/learning_algorithm.html-Tnr40gqi.js" as="script"><link rel="prefetch" href="/blog/assets/cache_pattern.html-BWIGrhub.js" as="script"><link rel="prefetch" href="/blog/assets/docker_tech.html-B7PNaqxh.js" as="script"><link rel="prefetch" href="/blog/assets/k3s.html-DP3vWh7K.js" as="script"><link rel="prefetch" href="/blog/assets/k3s_k8s_ingress.html-0VG_Dn9p.js" as="script"><link rel="prefetch" href="/blog/assets/oci-01-intro-guide.html-CMWMS7fl.js" as="script"><link rel="prefetch" href="/blog/assets/oci-02-runtime-spec.html-C0iBtGsB.js" as="script"><link rel="prefetch" href="/blog/assets/oci-03-image-spec.html-BBhmTevb.js" as="script"><link rel="prefetch" href="/blog/assets/oci-04-distribution-spec.html-BK42sbpW.js" as="script"><link rel="prefetch" href="/blog/assets/oci-05-security-guide.html-B3_bjMcv.js" as="script"><link rel="prefetch" href="/blog/assets/oci-06-monitoring-guide.html-DZeNq5_D.js" as="script"><link rel="prefetch" href="/blog/assets/oci-07-production-guide.html-Dd4znSBp.js" as="script"><link rel="prefetch" href="/blog/assets/oci-08-hooks-deep-dive.html-U722baza.js" as="script"><link rel="prefetch" href="/blog/assets/oci-linux-configurations-blog.html-B-QLbxh0.js" as="script"><link rel="prefetch" href="/blog/assets/oci-series-index.html-CDKgV4-S.js" as="script"><link rel="prefetch" href="/blog/assets/runc-advanced-lifecycle-analysis.html-DksQevmb.js" as="script"><link rel="prefetch" href="/blog/assets/runc-comprehensive-design-guide.html-B3lFgAwq.js" as="script"><link rel="prefetch" href="/blog/assets/runc-container-lifecycle-diagrams.html-D0cL6kcw.js" as="script"><link rel="prefetch" href="/blog/assets/linux_namespace.html-C_6Up541.js" as="script"><link rel="prefetch" href="/blog/assets/python_checklist.html-C2qsWYBJ.js" as="script"><link rel="prefetch" href="/blog/assets/python_env_manage.html-CUnPJ_1B.js" as="script"><link rel="prefetch" href="/blog/assets/gevent.html-CUgqcz3s.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BJAgUlPO.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BO__mOgk.js" as="script"><link rel="prefetch" href="/blog/assets/sort_1.html-B61YFXe2.js" as="script"><link rel="prefetch" href="/blog/assets/01-runcgaishuyujiagou.html-CdwfP7-9.js" as="script"><link rel="prefetch" href="/blog/assets/02-rongqishengmingzhouqiguanli.html-C-f7fScs.js" as="script"><link rel="prefetch" href="/blog/assets/03-Namespacegelishixian.html-i58zOLTD.js" as="script"><link rel="prefetch" href="/blog/assets/04-Cgroupsziyuanguanli.html-Cv4-SHFL.js" as="script"><link rel="prefetch" href="/blog/assets/05-wenjianxitongyuguazaiguanli.html-BtljxstR.js" as="script"><link rel="prefetch" href="/blog/assets/07-CRIUjianchadianyuhuifu.html-2aSuteQG.js" as="script"><link rel="prefetch" href="/blog/assets/08-tongxinyujiankongxitong.html-C1uYqrtr.js" as="script"><link rel="prefetch" href="/blog/assets/09-goujianjianhuarongqiyunxingshi.html-ZL_qjd8j.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DhgGbCoG.js" as="script"><link rel="prefetch" href="/blog/assets/abstract_factory.html-qSB2vqGJ.js" as="script"><link rel="prefetch" href="/blog/assets/factory_method.html-DaXxm691.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CQ2duCZ4.js" as="script"><link rel="prefetch" href="/blog/assets/adapter.html-k-5RMaEx.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-BmtOmY9V.js" as="script"><link rel="prefetch" href="/blog/assets/Valine.min-VCLvSWzF.js" as="script"><link rel="prefetch" href="/blog/assets/giscus-aTimukGI-DWEKOTfS.js" as="script"><link rel="prefetch" href="/blog/assets/KnowledgeMap-Dr6IblrL.js" as="script"><link rel="prefetch" href="/blog/assets/MermaidChart-a1CbfxcL.js" as="script"><link rel="prefetch" href="/blog/assets/mermaid.core-xyQxSs4c.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container series--no show-catalog"><header class="navbar-container not-open"><div class="navbar-inner"><div class="site-brand nav-item"><img class="logo" src="/blog/logo.png" alt="database of memory"><a href="/blog/" class="site-name can-hide">database of memory</a></div><div class="nav-item navbar-links-wrapper" style=""><div><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div><nav class="navbar-links"><!--[--><div class="navbar-links__item"><a href="/blog/" class="link" aria-label="Home"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Home<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/blog/categories/cloud-base/1/" class="link" aria-label="Categories"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Categories<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/blog/tags/runc/1/" class="link" aria-label="Tags"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Tags<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/blog/knowledge-map/" class="link" aria-label="çŸ¥è¯†åœ°å›¾"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->çŸ¥è¯†åœ°å›¾<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="Docs"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Docs<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="Docs"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Docs<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/blog/docs/leetcode/" class="link" aria-label="leetcode from scratch"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->leetcode from scratch<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/docs/design_pattern/" class="link" aria-label="design pattern"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->design pattern<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--><!----><span class="xicon-container btn-toggle-dark-mode btn--dark-mode navbar-links__item"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><path d="M15 2h2v3h-2z" fill="currentColor"></path><path d="M27 15h3v2h-3z" fill="currentColor"></path><path d="M15 27h2v3h-2z" fill="currentColor"></path><path d="M2 15h3v2H2z" fill="currentColor"></path><path d="M5.45 6.884l1.414-1.415l2.121 2.122l-1.414 1.414z" fill="currentColor"></path><path d="M23 7.58l2.121-2.12l1.414 1.414l-2.121 2.121z" fill="currentColor"></path><path d="M23.002 24.416l1.415-1.414l2.12 2.122l-1.413 1.414z" fill="currentColor"></path><path d="M5.47 25.13L7.59 23L9 24.42l-2.12 2.12l-1.41-1.41z" fill="currentColor"></path><path d="M16 8a8 8 0 1 0 8 8a8 8 0 0 0-8-8zm0 14a6 6 0 0 1 0-12z" fill="currentColor"></path></svg></span><ul class="social-links navbar-links__item"><!--[--><li class="social-item"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:25px;height:25px;"><path d="M16 2a14 14 0 0 0-4.43 27.28c.7.13 1-.3 1-.67v-2.38c-3.89.84-4.71-1.88-4.71-1.88a3.71 3.71 0 0 0-1.62-2.05c-1.27-.86.1-.85.1-.85a2.94 2.94 0 0 1 2.14 1.45a3 3 0 0 0 4.08 1.16a2.93 2.93 0 0 1 .88-1.87c-3.1-.36-6.37-1.56-6.37-6.92a5.4 5.4 0 0 1 1.44-3.76a5 5 0 0 1 .14-3.7s1.17-.38 3.85 1.43a13.3 13.3 0 0 1 7 0c2.67-1.81 3.84-1.43 3.84-1.43a5 5 0 0 1 .14 3.7a5.4 5.4 0 0 1 1.44 3.76c0 5.38-3.27 6.56-6.39 6.91a3.33 3.33 0 0 1 .95 2.59v3.84c0 .46.25.81 1 .67A14 14 0 0 0 16 2z" fill-rule="evenodd" fill="currentColor"></path></svg></li><!--]--></ul></nav><span class="xicon-container btn-toggle-menus"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><circle cx="16" cy="8" r="2" fill="currentColor"></circle><circle cx="16" cy="16" r="2" fill="currentColor"></circle><circle cx="16" cy="24" r="2" fill="currentColor"></circle></svg></span></div></div></header><!----><!----><!----><div class="theme-main" style=""><!----><!--[--><main class="page-container"><div class="page-content"><h1 class="page-title">å®‰å…¨ç‰¹æ€§å®ç°</h1><div class="page-info"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M16 4a5 5 0 1 1-5 5a5 5 0 0 1 5-5m0-2a7 7 0 1 0 7 7a7 7 0 0 0-7-7z" fill="currentColor"></path><path d="M26 30h-2v-5a5 5 0 0 0-5-5h-6a5 5 0 0 0-5 5v5H6v-5a7 7 0 0 1 7-7h6a7 7 0 0 1 7 7z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->hujunjie<!--]--></span></span><!----><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M11.17 6l3.42 3.41l.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[--><!--[--><a href="/blog/categories/cloud-base/runc-deep-dive/1.html" class="">cloud-base/runc-deep-dive</a><!--]--><!--]--></span></span><!----><!----></div><div class="theme-reco-md-content"><div><h1 id="å®‰å…¨ç‰¹æ€§å®ç°" tabindex="-1"><a class="header-anchor" href="#å®‰å…¨ç‰¹æ€§å®ç°"><span>å®‰å…¨ç‰¹æ€§å®ç°</span></a></h1><blockquote><p><strong>ç³»åˆ—å¯¼èˆªï¼š</strong> <a class="route-link" href="/blog/blogs/cloud-base/runc-deep-dive/">runc å®¹å™¨è¿è¡Œæ—¶æ·±åº¦è§£æç³»åˆ—</a> â†’ ç¬¬å…­ç¯‡ï¼šå®‰å…¨ç‰¹æ€§å®ç°<br><strong>ä¸Šä¸€ç¯‡ï¼š</strong> <a class="route-link" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html">æ–‡ä»¶ç³»ç»Ÿä¸æŒ‚è½½ç®¡ç†</a><br><strong>æœ€åæ›´æ–°ï¼š</strong> 2024</p></blockquote><h2 id="æ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#æ¦‚è¿°"><span>æ¦‚è¿°</span></a></h2><p>æœ¬æ–‡æ·±å…¥åˆ†æ runc çš„å®‰å…¨ç‰¹æ€§å®ç°ï¼ŒåŒ…æ‹¬ Capabilitiesã€Seccompã€AppArmor/SELinux ç­‰å¤šå±‚å®‰å…¨é˜²æŠ¤æœºåˆ¶ã€‚è¿™äº›å®‰å…¨ç‰¹æ€§ä¿éšœäº†å®¹å™¨çš„éš”ç¦»æ€§å’Œå®‰å…¨æ€§ã€‚</p><h2 id="ğŸ¯-å­¦ä¹ ç›®æ ‡" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-å­¦ä¹ ç›®æ ‡"><span>ğŸ¯ å­¦ä¹ ç›®æ ‡</span></a></h2><p>å®Œæˆæœ¬æ¨¡å—åï¼Œä½ å°†èƒ½å¤Ÿï¼š</p><ul><li>æ·±å…¥ç†è§£å®¹å™¨å®‰å…¨çš„å¤šå±‚é˜²æŠ¤ä½“ç³»å’Œæ”»å‡»é¢</li><li>æŒæ¡ Linux Capabilities çš„ç»†ç²’åº¦æƒé™æ§åˆ¶æœºåˆ¶</li><li>ç†è§£ seccomp ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤çš„å®ç°åŸç†å’Œé…ç½®æ–¹æ³•</li><li>ç†Ÿæ‚‰ AppArmor/SELinux å¼ºåˆ¶è®¿é—®æ§åˆ¶çš„é›†æˆæ–¹å¼</li><li>æŒæ¡ç”¨æˆ·å‘½åç©ºé—´æƒé™æ˜ å°„çš„å®‰å…¨æ¨¡å‹</li><li>å…·å¤‡è®¾è®¡å’Œå®æ–½å®¹å™¨å®‰å…¨ç­–ç•¥çš„å®è·µèƒ½åŠ›</li></ul><h2 id="_1-å®¹å™¨å®‰å…¨å¨èƒæ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#_1-å®¹å™¨å®‰å…¨å¨èƒæ¨¡å‹"><span>1. å®¹å™¨å®‰å…¨å¨èƒæ¨¡å‹</span></a></h2><h3 id="_1-1-å®¹å™¨å®‰å…¨è¾¹ç•Œ" tabindex="-1"><a class="header-anchor" href="#_1-1-å®¹å™¨å®‰å…¨è¾¹ç•Œ"><span>1.1 å®¹å™¨å®‰å…¨è¾¹ç•Œ</span></a></h3><p>å®¹å™¨å®‰å…¨éœ€è¦åœ¨å¤šä¸ªå±‚é¢å»ºç«‹é˜²æŠ¤è¾¹ç•Œï¼š</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚                åº”ç”¨å±‚                           â”‚ â† åº”ç”¨æ¼æ´ã€æ¶æ„ä»£ç </span>
<span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="line">â”‚              å®¹å™¨è¿è¡Œæ—¶å±‚                       â”‚ â† å®¹å™¨é€ƒé€¸ã€æƒé™æå‡</span>
<span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚</span>
<span class="line">â”‚  â”‚           runc å®‰å…¨æœºåˆ¶             â”‚    â”‚</span>
<span class="line">â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚</span>
<span class="line">â”‚  â”‚ â”‚ Capabilitiesâ”‚    seccomp         â”‚ â”‚    â”‚</span>
<span class="line">â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚</span>
<span class="line">â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚</span>
<span class="line">â”‚  â”‚ â”‚ AppArmor/   â”‚  User Namespaces   â”‚ â”‚    â”‚</span>
<span class="line">â”‚  â”‚ â”‚ SELinux     â”‚                    â”‚ â”‚    â”‚</span>
<span class="line">â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚</span>
<span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚</span>
<span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="line">â”‚                Linux å†…æ ¸å±‚                     â”‚ â† å†…æ ¸æ¼æ´ã€é©±åŠ¨é—®é¢˜</span>
<span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="line">â”‚                ç¡¬ä»¶å±‚                           â”‚ â† ç¡¬ä»¶æ¼æ´ã€ä¾§ä¿¡é“æ”»å‡»</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-ä¸»è¦æ”»å‡»å‘é‡" tabindex="-1"><a class="header-anchor" href="#_1-2-ä¸»è¦æ”»å‡»å‘é‡"><span>1.2 ä¸»è¦æ”»å‡»å‘é‡</span></a></h3><table><thead><tr><th>æ”»å‡»ç±»å‹</th><th>æè¿°</th><th>runc é˜²æŠ¤æœºåˆ¶</th></tr></thead><tbody><tr><td><strong>å®¹å™¨é€ƒé€¸</strong></td><td>çªç ´å®¹å™¨è¾¹ç•Œè®¿é—®å®¿ä¸»æœº</td><td>Namespaces + Capabilities + seccomp</td></tr><tr><td><strong>æƒé™æå‡</strong></td><td>è·å¾—è¶…å‡ºé¢„æœŸçš„æƒé™</td><td>User Namespaces + Capabilities</td></tr><tr><td><strong>èµ„æºè€—å°½</strong></td><td>DOSæ”»å‡»è€—å°½ç³»ç»Ÿèµ„æº</td><td>Cgroups + rlimits</td></tr><tr><td><strong>ä¿¡æ¯æ³„éœ²</strong></td><td>è®¿é—®ä¸åº”è®¿é—®çš„ä¿¡æ¯</td><td>/procæ£€æŸ¥ + æ–‡ä»¶ç³»ç»Ÿéš”ç¦»</td></tr><tr><td><strong>ç³»ç»Ÿè°ƒç”¨æ»¥ç”¨</strong></td><td>åˆ©ç”¨å±é™©ç³»ç»Ÿè°ƒç”¨</td><td>seccomp è¿‡æ»¤</td></tr><tr><td><strong>æ¨ªå‘ç§»åŠ¨</strong></td><td>æ”»å‡»å…¶ä»–å®¹å™¨æˆ–æœåŠ¡</td><td>ç½‘ç»œéš”ç¦» + SELinux/AppArmor</td></tr></tbody></table><h3 id="_1-3-å®‰å…¨æ¶æ„è®¾è®¡åŸåˆ™" tabindex="-1"><a class="header-anchor" href="#_1-3-å®‰å…¨æ¶æ„è®¾è®¡åŸåˆ™"><span>1.3 å®‰å…¨æ¶æ„è®¾è®¡åŸåˆ™</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// å®‰å…¨é…ç½®çš„æ ¸å¿ƒç»“æ„</span></span>
<span class="line"><span class="token keyword">type</span> SecurityConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æƒé™æ§åˆ¶</span></span>
<span class="line">    Capabilities     <span class="token operator">*</span>Capabilities    <span class="token string">`json:&quot;capabilities,omitempty&quot;`</span></span>
<span class="line">    NoNewPrivileges  <span class="token builtin">bool</span>            <span class="token string">`json:&quot;no_new_privileges,omitempty&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤</span></span>
<span class="line">    Seccomp          <span class="token operator">*</span>Seccomp        <span class="token string">`json:&quot;seccomp,omitempty&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å¼ºåˆ¶è®¿é—®æ§åˆ¶</span></span>
<span class="line">    AppArmorProfile  <span class="token builtin">string</span>          <span class="token string">`json:&quot;apparmor_profile,omitempty&quot;`</span></span>
<span class="line">    ProcessLabel     <span class="token builtin">string</span>          <span class="token string">`json:&quot;process_label,omitempty&quot;`</span>    <span class="token comment">// SELinux</span></span>
<span class="line">    MountLabel       <span class="token builtin">string</span>          <span class="token string">`json:&quot;mount_label,omitempty&quot;`</span>      <span class="token comment">// SELinux</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ç”¨æˆ·æƒé™æ˜ å°„</span></span>
<span class="line">    UIDMappings      <span class="token punctuation">[</span><span class="token punctuation">]</span>IDMap         <span class="token string">`json:&quot;uid_mappings,omitempty&quot;`</span></span>
<span class="line">    GIDMappings      <span class="token punctuation">[</span><span class="token punctuation">]</span>IDMap         <span class="token string">`json:&quot;gid_mappings,omitempty&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ–‡ä»¶ç³»ç»Ÿå®‰å…¨</span></span>
<span class="line">    MaskPaths        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>        <span class="token string">`json:&quot;mask_paths,omitempty&quot;`</span></span>
<span class="line">    ReadonlyPaths    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>        <span class="token string">`json:&quot;readonly_paths,omitempty&quot;`</span></span>
<span class="line">    Readonlyfs       <span class="token builtin">bool</span>            <span class="token string">`json:&quot;readonlyfs,omitempty&quot;`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ ¸å¿ƒåŸåˆ™</strong>ï¼š</p><ul><li>ğŸ”’ <strong>æœ€å°æƒé™åŸåˆ™</strong>: åªæˆäºˆå¿…è¦çš„æœ€å°æƒé™</li><li>ğŸ›¡ï¸ <strong>æ·±åº¦é˜²æŠ¤</strong>: å¤šå±‚å®‰å…¨æœºåˆ¶ç›¸äº’è¡¥å……</li><li>ğŸš« <strong>é»˜è®¤æ‹’ç»</strong>: é™¤éæ˜ç¡®å…è®¸ï¼Œå¦åˆ™æ‹’ç»è®¿é—®</li><li>ğŸ“ <strong>å®¡è®¡è·Ÿè¸ª</strong>: è®°å½•å®‰å…¨ç›¸å…³çš„æ“ä½œå’Œå†³ç­–</li></ul><h2 id="_2-linux-capabilities-æƒé™æ§åˆ¶" tabindex="-1"><a class="header-anchor" href="#_2-linux-capabilities-æƒé™æ§åˆ¶"><span>2. Linux Capabilities æƒé™æ§åˆ¶</span></a></h2><h3 id="_2-1-capabilities-åŸºç¡€æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#_2-1-capabilities-åŸºç¡€æ¦‚å¿µ"><span>2.1 Capabilities åŸºç¡€æ¦‚å¿µ</span></a></h3><p>ä¼ ç»Ÿçš„ Unix æƒé™æ¨¡å‹åªæœ‰ <strong>ç‰¹æƒç”¨æˆ· (root)</strong> å’Œ <strong>æ™®é€šç”¨æˆ·</strong> çš„åŒºåˆ†ã€‚Linux Capabilities å°† root çš„è¶…çº§æƒé™åˆ†è§£ä¸ºç»†ç²’åº¦çš„èƒ½åŠ›ä½ï¼š</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">ä¼ ç»Ÿæƒé™æ¨¡å‹:              Capabilities æ¨¡å‹:</span>
<span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚     root     â”‚   åˆ†è§£   â”‚ CAP_NET_ADMIN  (ç½‘ç»œç®¡ç†)   â”‚</span>
<span class="line">â”‚  (æ‰€æœ‰æƒé™)   â”‚  â”€â”€â”€â”€â†’  â”‚ CAP_SYS_ADMIN  (ç³»ç»Ÿç®¡ç†)   â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ CAP_KILL       (å‘é€ä¿¡å·)   â”‚</span>
<span class="line">       â”‚                 â”‚ CAP_CHOWN      (æ–‡ä»¶æ‰€æœ‰æƒ) â”‚</span>
<span class="line">       â”‚                 â”‚ CAP_SETUID     (åˆ‡æ¢ç”¨æˆ·)   â”‚</span>
<span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚ CAP_MKNOD      (åˆ›å»ºè®¾å¤‡)   â”‚</span>
<span class="line">â”‚  æ™®é€šç”¨æˆ·     â”‚         â”‚ ... 38+ ç§èƒ½åŠ›             â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-äº”ç§-capabilities-é›†åˆ" tabindex="-1"><a class="header-anchor" href="#_2-2-äº”ç§-capabilities-é›†åˆ"><span>2.2 äº”ç§ Capabilities é›†åˆ</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/configs/config.go:145</span></span>
<span class="line"><span class="token keyword">type</span> Capabilities <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// è¾¹ç•Œé›†ï¼šå†…æ ¸æ£€æŸ¥çš„èƒ½åŠ›ä¸Šé™</span></span>
<span class="line">    Bounding    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:&quot;bounding,omitempty&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æœ‰æ•ˆé›†ï¼šå½“å‰æ­£åœ¨ä½¿ç”¨çš„èƒ½åŠ›</span></span>
<span class="line">    Effective   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:&quot;effective,omitempty&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å¯ç»§æ‰¿é›†ï¼šå¯ä»¥ä¼ é€’ç»™å­è¿›ç¨‹çš„èƒ½åŠ›</span></span>
<span class="line">    Inheritable <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:&quot;inheritable,omitempty&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®¸å¯é›†ï¼šè¿›ç¨‹è¢«å…è®¸æ‹¥æœ‰çš„èƒ½åŠ›ä¸Šé™</span></span>
<span class="line">    Permitted   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:&quot;permitted,omitempty&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ç¯å¢ƒé›†ï¼šåœ¨ execve åè‡ªåŠ¨æ·»åŠ åˆ°è®¸å¯å’Œæœ‰æ•ˆé›†çš„èƒ½åŠ›</span></span>
<span class="line">    Ambient     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:&quot;ambient,omitempty&quot;`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>é›†åˆå…³ç³»å›¾</strong>ï¼š</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">è¿›ç¨‹æ‰§è¡Œå‰:                    execve() å:</span>
<span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚ Bounding    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ æ–°è¿›ç¨‹ Bounding â”‚ (ä¸å˜)</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚ Permitted   â”‚â”€â”             â”‚ æ–°è¿›ç¨‹ Permittedâ”‚ (æŒ‰è§„åˆ™è®¡ç®—)</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ è®¡ç®—         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚ Inheritable â”‚â”€â”¼â”€è§„åˆ™â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ æ–°è¿›ç¨‹ Effectiveâ”‚ (æŒ‰è§„åˆ™è®¡ç®—)</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚ Ambient     â”‚â”€â”˜             â”‚ æ–°è¿›ç¨‹ Inheritableâ”‚ (ç»§æ‰¿)</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-å¸¸ç”¨-capabilities-è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#_2-3-å¸¸ç”¨-capabilities-è¯¦è§£"><span>2.3 å¸¸ç”¨ Capabilities è¯¦è§£</span></a></h3><table><thead><tr><th>Capability</th><th>åŠŸèƒ½</th><th>å®¹å™¨ä¸­çš„åº”ç”¨</th></tr></thead><tbody><tr><td><strong>CAP_NET_ADMIN</strong></td><td>ç½‘ç»œç®¡ç†æƒé™</td><td>é…ç½®ç½‘ç»œæ¥å£ã€è·¯ç”±ã€iptables</td></tr><tr><td><strong>CAP_NET_BIND_SERVICE</strong></td><td>ç»‘å®šç‰¹æƒç«¯å£(&lt;1024)</td><td>WebæœåŠ¡å™¨ç›‘å¬80/443ç«¯å£</td></tr><tr><td><strong>CAP_SYS_ADMIN</strong></td><td>ç³»ç»Ÿç®¡ç†æƒé™</td><td>æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿã€è®¾ç½®ä¸»æœºå</td></tr><tr><td><strong>CAP_SYS_TIME</strong></td><td>ä¿®æ”¹ç³»ç»Ÿæ—¶é—´</td><td>NTPæœåŠ¡ã€æ—¶é—´åŒæ­¥</td></tr><tr><td><strong>CAP_KILL</strong></td><td>å‘é€ä¿¡å·åˆ°ä»»æ„è¿›ç¨‹</td><td>è¿›ç¨‹ç›‘æ§ã€ä¿¡å·ä¼ é€’</td></tr><tr><td><strong>CAP_CHOWN</strong></td><td>ä¿®æ”¹æ–‡ä»¶æ‰€æœ‰æƒ</td><td>æ–‡ä»¶æƒé™ç®¡ç†</td></tr><tr><td><strong>CAP_SETUID/SETGID</strong></td><td>åˆ‡æ¢ç”¨æˆ·ID</td><td>sudoã€è®¤è¯æœåŠ¡</td></tr><tr><td><strong>CAP_MKNOD</strong></td><td>åˆ›å»ºè®¾å¤‡æ–‡ä»¶</td><td>è®¾å¤‡é©±åŠ¨ã€ç‰¹æ®Šè®¾å¤‡</td></tr></tbody></table><h3 id="_2-4-runc-ä¸­çš„-capabilities-å®ç°" tabindex="-1"><a class="header-anchor" href="#_2-4-runc-ä¸­çš„-capabilities-å®ç°"><span>2.4 runc ä¸­çš„ Capabilities å®ç°</span></a></h3><h4 id="åº”ç”¨æµç¨‹" tabindex="-1"><a class="header-anchor" href="#åº”ç”¨æµç¨‹"><span>åº”ç”¨æµç¨‹</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/capabilities/capabilities.go:61</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">ApplyCapabilities</span><span class="token punctuation">(</span>c <span class="token operator">*</span>configs<span class="token punctuation">.</span>Capabilities<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. æ¸…é™¤æ‰€æœ‰ capabilities é›†åˆ</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">clearCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. æŒ‰ç…§ç‰¹å®šé¡ºåºè®¾ç½® capabilities</span></span>
<span class="line">    <span class="token comment">// é¡ºåºå¾ˆé‡è¦ï¼Œå› ä¸ºä¸åŒé›†åˆä¹‹é—´æœ‰ä¾èµ–å…³ç³»</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setCapabilities</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Effective<span class="token punctuation">,</span> effective<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set effective capabilities: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setCapabilities</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Permitted<span class="token punctuation">,</span> permitted<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set permitted capabilities: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setCapabilities</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Inheritable<span class="token punctuation">,</span> inheritable<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set inheritable capabilities: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setCapabilities</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Bounding<span class="token punctuation">,</span> bounding<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set bounding capabilities: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. Ambient é›†åˆéœ€è¦ç‰¹æ®Šå¤„ç†</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setAmbientCapabilities</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Ambient<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set ambient capabilities: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ambient-capabilities-ç‰¹æ®Šå¤„ç†" tabindex="-1"><a class="header-anchor" href="#ambient-capabilities-ç‰¹æ®Šå¤„ç†"><span>Ambient Capabilities ç‰¹æ®Šå¤„ç†</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">setAmbientCapabilities</span><span class="token punctuation">(</span>caps <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// Ambient capabilities æ˜¯è¾ƒæ–°çš„ç‰¹æ€§ï¼Œéœ€è¦ç‰¹åˆ«å¤„ç†</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token builtin">cap</span> <span class="token operator">:=</span> <span class="token keyword">range</span> caps <span class="token punctuation">{</span></span>
<span class="line">        capInt<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getCapabilityNumber</span><span class="token punctuation">(</span><span class="token builtin">cap</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">continue</span>  <span class="token comment">// å¿½ç•¥ä¸æ”¯æŒçš„ capability</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// é‡ç½® ambient é›†åˆ</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Prctl</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>PR_CAP_AMBIENT<span class="token punctuation">,</span> </span>
<span class="line">                           unix<span class="token punctuation">.</span>PR_CAP_AMBIENT_CLEAR_ALL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// é€ä¸ªæ·»åŠ  capability åˆ° ambient é›†åˆ</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Prctl</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>PR_CAP_AMBIENT<span class="token punctuation">,</span> </span>
<span class="line">                           unix<span class="token punctuation">.</span>PR_CAP_AMBIENT_RAISE<span class="token punctuation">,</span> capInt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// å¦‚æœå¤±è´¥ï¼Œå¯èƒ½æ˜¯å› ä¸ºè¯¥ capability ä¸åœ¨ permitted æˆ– inheritable é›†åˆä¸­</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to add %s to ambient set: %w&quot;</span><span class="token punctuation">,</span> <span class="token builtin">cap</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å…¼å®¹æ€§å¤„ç†" tabindex="-1"><a class="header-anchor" href="#å…¼å®¹æ€§å¤„ç†"><span>å…¼å®¹æ€§å¤„ç†</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">setCapabilities</span><span class="token punctuation">(</span>caps <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> capType capabilityType<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token builtin">cap</span> <span class="token operator">:=</span> <span class="token keyword">range</span> caps <span class="token punctuation">{</span></span>
<span class="line">        capInt<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getCapabilityNumber</span><span class="token punctuation">(</span><span class="token builtin">cap</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// å¯¹äºæœªçŸ¥çš„ capabilityï¼Œè®°å½•è­¦å‘Šä½†ä¸æŠ¥é”™</span></span>
<span class="line">            <span class="token comment">// è¿™ä¿è¯äº†å‘å‰å…¼å®¹æ€§</span></span>
<span class="line">            logrus<span class="token punctuation">.</span><span class="token function">WithError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Warnf</span><span class="token punctuation">(</span><span class="token string">&quot;Ignoring unknown capability %q&quot;</span><span class="token punctuation">,</span> <span class="token builtin">cap</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">continue</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">applySingleCapability</span><span class="token punctuation">(</span>capInt<span class="token punctuation">,</span> capType<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// æŸäº› capability åœ¨ç‰¹å®šå†…æ ¸ç‰ˆæœ¬ä¸­å¯èƒ½ä¸å¯ç”¨</span></span>
<span class="line">            <span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>EINVAL<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                logrus<span class="token punctuation">.</span><span class="token function">WithError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Warnf</span><span class="token punctuation">(</span><span class="token string">&quot;Capability %s not supported&quot;</span><span class="token punctuation">,</span> <span class="token builtin">cap</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">continue</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-5-é»˜è®¤-capabilities-ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#_2-5-é»˜è®¤-capabilities-ç­–ç•¥"><span>2.5 é»˜è®¤ Capabilities ç­–ç•¥</span></a></h3><p>runc ä½¿ç”¨ä¿å®ˆçš„é»˜è®¤ capabilities ç­–ç•¥ï¼š</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// é»˜è®¤æˆäºˆçš„ capabilitiesï¼ˆæœ€å°é›†åˆï¼‰</span></span>
<span class="line"><span class="token keyword">var</span> defaultCapabilities <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&quot;CAP_CHOWN&quot;</span><span class="token punctuation">,</span>           <span class="token comment">// ä¿®æ”¹æ–‡ä»¶æ‰€æœ‰æƒ</span></span>
<span class="line">    <span class="token string">&quot;CAP_DAC_OVERRIDE&quot;</span><span class="token punctuation">,</span>    <span class="token comment">// ç»•è¿‡æ–‡ä»¶æƒé™æ£€æŸ¥</span></span>
<span class="line">    <span class="token string">&quot;CAP_FSETID&quot;</span><span class="token punctuation">,</span>          <span class="token comment">// è®¾ç½®æ–‡ä»¶ set-user-ID ä½</span></span>
<span class="line">    <span class="token string">&quot;CAP_FOWNER&quot;</span><span class="token punctuation">,</span>          <span class="token comment">// ç»•è¿‡æ–‡ä»¶æ‰€æœ‰æƒæ£€æŸ¥</span></span>
<span class="line">    <span class="token string">&quot;CAP_MKNOD&quot;</span><span class="token punctuation">,</span>           <span class="token comment">// åˆ›å»ºè®¾å¤‡æ–‡ä»¶</span></span>
<span class="line">    <span class="token string">&quot;CAP_NET_RAW&quot;</span><span class="token punctuation">,</span>         <span class="token comment">// ä½¿ç”¨ RAW å’Œ PACKET å¥—æ¥å­—</span></span>
<span class="line">    <span class="token string">&quot;CAP_SETGID&quot;</span><span class="token punctuation">,</span>          <span class="token comment">// ä¿®æ”¹è¿›ç¨‹ GID</span></span>
<span class="line">    <span class="token string">&quot;CAP_SETUID&quot;</span><span class="token punctuation">,</span>          <span class="token comment">// ä¿®æ”¹è¿›ç¨‹ UID</span></span>
<span class="line">    <span class="token string">&quot;CAP_SETFCAP&quot;</span><span class="token punctuation">,</span>         <span class="token comment">// è®¾ç½®æ–‡ä»¶ capabilities</span></span>
<span class="line">    <span class="token string">&quot;CAP_SETPCAP&quot;</span><span class="token punctuation">,</span>         <span class="token comment">// ä¿®æ”¹è¿›ç¨‹ capabilities</span></span>
<span class="line">    <span class="token string">&quot;CAP_NET_BIND_SERVICE&quot;</span><span class="token punctuation">,</span> <span class="token comment">// ç»‘å®šç‰¹æƒç«¯å£</span></span>
<span class="line">    <span class="token string">&quot;CAP_SYS_CHROOT&quot;</span><span class="token punctuation">,</span>      <span class="token comment">// ä½¿ç”¨ chroot</span></span>
<span class="line">    <span class="token string">&quot;CAP_KILL&quot;</span><span class="token punctuation">,</span>            <span class="token comment">// å‘é€ä¿¡å·</span></span>
<span class="line">    <span class="token string">&quot;CAP_AUDIT_WRITE&quot;</span><span class="token punctuation">,</span>     <span class="token comment">// å†™å…¥å®¡è®¡æ—¥å¿—</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ˜ç¡®ç¦ç”¨çš„å±é™© capabilities</span></span>
<span class="line"><span class="token keyword">var</span> droppedCapabilities <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&quot;CAP_SYS_ADMIN&quot;</span><span class="token punctuation">,</span>       <span class="token comment">// ç³»ç»Ÿç®¡ç†æƒé™</span></span>
<span class="line">    <span class="token string">&quot;CAP_SYS_TIME&quot;</span><span class="token punctuation">,</span>        <span class="token comment">// ä¿®æ”¹ç³»ç»Ÿæ—¶é—´</span></span>
<span class="line">    <span class="token string">&quot;CAP_NET_ADMIN&quot;</span><span class="token punctuation">,</span>       <span class="token comment">// ç½‘ç»œç®¡ç†æƒé™</span></span>
<span class="line">    <span class="token string">&quot;CAP_SYS_MODULE&quot;</span><span class="token punctuation">,</span>      <span class="token comment">// åŠ è½½å†…æ ¸æ¨¡å—</span></span>
<span class="line">    <span class="token string">&quot;CAP_SYS_RAWIO&quot;</span><span class="token punctuation">,</span>       <span class="token comment">// ç›´æ¥ I/O è®¿é—®</span></span>
<span class="line">    <span class="token string">&quot;CAP_SYS_PTRACE&quot;</span><span class="token punctuation">,</span>      <span class="token comment">// è°ƒè¯•å…¶ä»–è¿›ç¨‹</span></span>
<span class="line">    <span class="token string">&quot;CAP_SYS_NICE&quot;</span><span class="token punctuation">,</span>        <span class="token comment">// ä¿®æ”¹è¿›ç¨‹ä¼˜å…ˆçº§</span></span>
<span class="line">    <span class="token string">&quot;CAP_IPC_LOCK&quot;</span><span class="token punctuation">,</span>        <span class="token comment">// é”å®šå†…å­˜é¡µ</span></span>
<span class="line">    <span class="token string">&quot;CAP_SYS_RESOURCE&quot;</span><span class="token punctuation">,</span>    <span class="token comment">// ä¿®æ”¹èµ„æºé™åˆ¶</span></span>
<span class="line">    <span class="token string">&quot;CAP_SYS_TTY_CONFIG&quot;</span><span class="token punctuation">,</span>  <span class="token comment">// ä¿®æ”¹ TTY é…ç½®</span></span>
<span class="line">    <span class="token string">&quot;CAP_LEASE&quot;</span><span class="token punctuation">,</span>           <span class="token comment">// æ–‡ä»¶ç§Ÿçº¦</span></span>
<span class="line">    <span class="token string">&quot;CAP_WAKE_ALARM&quot;</span><span class="token punctuation">,</span>      <span class="token comment">// è®¾ç½®å®æ—¶æ—¶é’Ÿè­¦æŠ¥</span></span>
<span class="line">    <span class="token string">&quot;CAP_BLOCK_SUSPEND&quot;</span><span class="token punctuation">,</span>   <span class="token comment">// é˜»æ­¢ç³»ç»Ÿä¼‘çœ </span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-seccomp-ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤" tabindex="-1"><a class="header-anchor" href="#_3-seccomp-ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤"><span>3. seccomp ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤</span></a></h2><h3 id="_3-1-seccomp-åŸºç¡€åŸç†" tabindex="-1"><a class="header-anchor" href="#_3-1-seccomp-åŸºç¡€åŸç†"><span>3.1 seccomp åŸºç¡€åŸç†</span></a></h3><p><strong>seccomp (secure computing mode)</strong> æ˜¯ Linux å†…æ ¸çš„å®‰å…¨æœºåˆ¶ï¼Œå¯ä»¥é™åˆ¶è¿›ç¨‹èƒ½å¤Ÿè°ƒç”¨çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">ç”¨æˆ·ç©ºé—´ç¨‹åº                    å†…æ ¸ç©ºé—´</span>
<span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚  åº”ç”¨ç¨‹åº       â”‚            â”‚                     â”‚</span>
<span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   ç³»ç»Ÿè°ƒç”¨  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚</span>
<span class="line">â”‚  â”‚  open()   â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  â”‚   seccomp BPF   â”‚ â”‚</span>
<span class="line">â”‚  â”‚  write()  â”‚  â”‚            â”‚  â”‚     è¿‡æ»¤å™¨       â”‚ â”‚</span>
<span class="line">â”‚  â”‚  exec()   â”‚  â”‚            â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚</span>
<span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚            â”‚        â”‚             â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚        â–¼             â”‚</span>
<span class="line">                               â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚</span>
<span class="line">                               â”‚  â”‚ ALLOW/DENY/TRAP â”‚ â”‚</span>
<span class="line">                               â”‚  â”‚ TRACE/LOG/ERRNO â”‚ â”‚</span>
<span class="line">                               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚</span>
<span class="line">                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-seccomp-é…ç½®ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_3-2-seccomp-é…ç½®ç»“æ„"><span>3.2 seccomp é…ç½®ç»“æ„</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/configs/config.go:207</span></span>
<span class="line"><span class="token keyword">type</span> Seccomp <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// é»˜è®¤åŠ¨ä½œï¼šå¯¹æœªåŒ¹é…è§„åˆ™çš„ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œçš„åŠ¨ä½œ</span></span>
<span class="line">    DefaultAction    Action                   <span class="token string">`json:&quot;default_action&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ¶æ„åˆ—è¡¨ï¼šé™åˆ¶åœ¨ç‰¹å®šCPUæ¶æ„ä¸Š</span></span>
<span class="line">    Architectures    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>                 <span class="token string">`json:&quot;architectures&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ ‡å¿—ï¼šseccompçš„è¡Œä¸ºæ§åˆ¶æ ‡å¿—</span></span>
<span class="line">    Flags            <span class="token punctuation">[</span><span class="token punctuation">]</span>specs<span class="token punctuation">.</span>LinuxSeccompFlag <span class="token string">`json:&quot;flags&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ç³»ç»Ÿè°ƒç”¨è§„åˆ™åˆ—è¡¨</span></span>
<span class="line">    Syscalls         <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Syscall               <span class="token string">`json:&quot;syscalls&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// é»˜è®¤é”™è¯¯è¿”å›å€¼ï¼šå½“åŠ¨ä½œä¸ºERRNOæ—¶è¿”å›çš„é”™è¯¯ç </span></span>
<span class="line">    DefaultErrnoRet  <span class="token operator">*</span><span class="token builtin">uint</span>                    <span class="token string">`json:&quot;default_errno_ret&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ç›‘å¬è·¯å¾„ï¼šç”¨äº seccomp notify æœºåˆ¶</span></span>
<span class="line">    ListenerPath     <span class="token builtin">string</span>                   <span class="token string">`json:&quot;listener_path,omitempty&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ç›‘å¬å…ƒæ•°æ®ï¼šä¼ é€’ç»™ç›‘å¬å™¨çš„é¢å¤–ä¿¡æ¯</span></span>
<span class="line">    ListenerMetadata <span class="token builtin">string</span>                   <span class="token string">`json:&quot;listener_metadata,omitempty&quot;`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç³»ç»Ÿè°ƒç”¨è§„åˆ™</span></span>
<span class="line"><span class="token keyword">type</span> Syscall <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Name     <span class="token builtin">string</span> <span class="token string">`json:&quot;name&quot;`</span>          <span class="token comment">// ç³»ç»Ÿè°ƒç”¨åç§°</span></span>
<span class="line">    Action   Action <span class="token string">`json:&quot;action&quot;`</span>        <span class="token comment">// æ‰§è¡Œçš„åŠ¨ä½œ</span></span>
<span class="line">    ErrnoRet <span class="token operator">*</span><span class="token builtin">uint</span>  <span class="token string">`json:&quot;errnoRet&quot;`</span>      <span class="token comment">// ERRNOåŠ¨ä½œçš„è¿”å›å€¼</span></span>
<span class="line">    Args     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Arg <span class="token string">`json:&quot;args&quot;`</span>          <span class="token comment">// å‚æ•°è¿‡æ»¤æ¡ä»¶</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å‚æ•°è¿‡æ»¤æ¡ä»¶</span></span>
<span class="line"><span class="token keyword">type</span> Arg <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Index    <span class="token builtin">uint</span>     <span class="token string">`json:&quot;index&quot;`</span>    <span class="token comment">// å‚æ•°ç´¢å¼• (0-5)</span></span>
<span class="line">    Value    <span class="token builtin">uint64</span>   <span class="token string">`json:&quot;value&quot;`</span>    <span class="token comment">// æ¯”è¾ƒå€¼</span></span>
<span class="line">    ValueTwo <span class="token operator">*</span><span class="token builtin">uint64</span>  <span class="token string">`json:&quot;valueTwo&quot;`</span> <span class="token comment">// èŒƒå›´æ¯”è¾ƒçš„ç¬¬äºŒä¸ªå€¼</span></span>
<span class="line">    Op       Operator <span class="token string">`json:&quot;op&quot;`</span>       <span class="token comment">// æ¯”è¾ƒæ“ä½œç¬¦</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-seccomp-åŠ¨ä½œç±»å‹" tabindex="-1"><a class="header-anchor" href="#_3-3-seccomp-åŠ¨ä½œç±»å‹"><span>3.3 seccomp åŠ¨ä½œç±»å‹</span></a></h3><table><thead><tr><th>åŠ¨ä½œ</th><th>æè¿°</th><th>åº”ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><strong>KILL/KILL_THREAD</strong></td><td>ç»ˆæ­¢è¿›ç¨‹/çº¿ç¨‹</td><td>ç»å¯¹ç¦æ­¢çš„ç³»ç»Ÿè°ƒç”¨</td></tr><tr><td><strong>ERRNO</strong></td><td>è¿”å›é”™è¯¯ç </td><td>ä¼˜é›…å¤„ç†ä¸å…è®¸çš„è°ƒç”¨</td></tr><tr><td><strong>TRAP</strong></td><td>å‘é€ SIGSYS ä¿¡å·</td><td>è°ƒè¯•å’Œç›‘æ§</td></tr><tr><td><strong>ALLOW</strong></td><td>å…è®¸æ‰§è¡Œ</td><td>ç™½åå•æ¨¡å¼</td></tr><tr><td><strong>TRACE</strong></td><td>è·Ÿè¸ªæ‰§è¡Œ</td><td>å®‰å…¨å®¡è®¡</td></tr><tr><td><strong>LOG</strong></td><td>è®°å½•æ—¥å¿—</td><td>ç›‘æ§å¯ç–‘è°ƒç”¨</td></tr><tr><td><strong>NOTIFY</strong></td><td>é€šçŸ¥ç”¨æˆ·ç©ºé—´</td><td>åŠ¨æ€å®‰å…¨å†³ç­–</td></tr></tbody></table><h3 id="_3-4-runc-ä¸­çš„-seccomp-å®ç°" tabindex="-1"><a class="header-anchor" href="#_3-4-runc-ä¸­çš„-seccomp-å®ç°"><span>3.4 runc ä¸­çš„ seccomp å®ç°</span></a></h3><h4 id="è¿‡æ»¤å™¨åˆå§‹åŒ–" tabindex="-1"><a class="header-anchor" href="#è¿‡æ»¤å™¨åˆå§‹åŒ–"><span>è¿‡æ»¤å™¨åˆå§‹åŒ–</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/seccomp/seccomp_linux.go:89</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">InitSeccomp</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Seccomp<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> config <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;cannot initialize Seccomp - nil config passed&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åˆ›å»º seccomp è¿‡æ»¤å™¨ä¸Šä¸‹æ–‡</span></span>
<span class="line">    filter<span class="token punctuation">,</span> err <span class="token operator">:=</span> libseccomp<span class="token punctuation">.</span><span class="token function">NewFilter</span><span class="token punctuation">(</span><span class="token function">seccompAction</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>DefaultAction<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to create seccomp filter: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> filter<span class="token punctuation">.</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®¾ç½®æ¶æ„é™åˆ¶</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> arch <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Architectures <span class="token punctuation">{</span></span>
<span class="line">        scmpArch<span class="token punctuation">,</span> err <span class="token operator">:=</span> libseccomp<span class="token punctuation">.</span><span class="token function">GetArchFromString</span><span class="token punctuation">(</span>arch<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;invalid architecture %s: %w&quot;</span><span class="token punctuation">,</span> arch<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> filter<span class="token punctuation">.</span><span class="token function">AddArch</span><span class="token punctuation">(</span>scmpArch<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to add architecture %s: %w&quot;</span><span class="token punctuation">,</span> arch<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ·»åŠ ç³»ç»Ÿè°ƒç”¨è§„åˆ™</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> syscall <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Syscalls <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">addSyscallRule</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> syscall<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to add syscall rule for %s: %w&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                             syscall<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åº”ç”¨ BPF è¡¥ä¸ä¼˜åŒ–</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> patchbpf<span class="token punctuation">.</span><span class="token function">PatchAndLoad</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to patch and load seccomp filter: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç³»ç»Ÿè°ƒç”¨è§„åˆ™æ·»åŠ " tabindex="-1"><a class="header-anchor" href="#ç³»ç»Ÿè°ƒç”¨è§„åˆ™æ·»åŠ "><span>ç³»ç»Ÿè°ƒç”¨è§„åˆ™æ·»åŠ </span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">addSyscallRule</span><span class="token punctuation">(</span>filter <span class="token operator">*</span>libseccomp<span class="token punctuation">.</span>ScmpFilter<span class="token punctuation">,</span> syscall <span class="token operator">*</span>Syscall<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// è·å–ç³»ç»Ÿè°ƒç”¨å·</span></span>
<span class="line">    scmpSyscall<span class="token punctuation">,</span> err <span class="token operator">:=</span> libseccomp<span class="token punctuation">.</span><span class="token function">GetSyscallFromName</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>Name<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// å¿½ç•¥æœªçŸ¥çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæé«˜å…¼å®¹æ€§</span></span>
<span class="line">        logrus<span class="token punctuation">.</span><span class="token function">WithError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span><span class="token string">&quot;Ignoring unknown syscall %s&quot;</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>Name<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ„å»ºå‚æ•°æ¡ä»¶</span></span>
<span class="line">    <span class="token keyword">var</span> conditions <span class="token punctuation">[</span><span class="token punctuation">]</span>libseccomp<span class="token punctuation">.</span>ScmpCondition</span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> arg <span class="token operator">:=</span> <span class="token keyword">range</span> syscall<span class="token punctuation">.</span>Args <span class="token punctuation">{</span></span>
<span class="line">        condition <span class="token operator">:=</span> libseccomp<span class="token punctuation">.</span>ScmpCondition<span class="token punctuation">{</span></span>
<span class="line">            Argument<span class="token punctuation">:</span> arg<span class="token punctuation">.</span>Index<span class="token punctuation">,</span></span>
<span class="line">            Op<span class="token punctuation">:</span>       libseccomp<span class="token punctuation">.</span><span class="token function">ScmpCompareOp</span><span class="token punctuation">(</span>arg<span class="token punctuation">.</span>Op<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            Operand1<span class="token punctuation">:</span> arg<span class="token punctuation">.</span>Value<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// å¤„ç†èŒƒå›´æ¯”è¾ƒ</span></span>
<span class="line">        <span class="token keyword">if</span> arg<span class="token punctuation">.</span>ValueTwo <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            condition<span class="token punctuation">.</span>Operand2 <span class="token operator">=</span> <span class="token operator">*</span>arg<span class="token punctuation">.</span>ValueTwo</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        conditions <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>conditions<span class="token punctuation">,</span> condition<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ·»åŠ è§„åˆ™åˆ°è¿‡æ»¤å™¨</span></span>
<span class="line">    action <span class="token operator">:=</span> <span class="token function">seccompAction</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>Action<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> filter<span class="token punctuation">.</span><span class="token function">AddRuleConditional</span><span class="token punctuation">(</span>scmpSyscall<span class="token punctuation">,</span> action<span class="token punctuation">,</span> conditions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to add conditional rule: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-5-bpf-è¡¥ä¸ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_3-5-bpf-è¡¥ä¸ä¼˜åŒ–"><span>3.5 BPF è¡¥ä¸ä¼˜åŒ–</span></a></h3><p>runc å®ç°äº† BPF ç¨‹åºè¡¥ä¸æœºåˆ¶æ¥ä¼˜åŒ– seccomp æ€§èƒ½ï¼š</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/seccomp/patchbpf/enosys_linux.go:45</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">PatchAndLoad</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Seccomp<span class="token punctuation">,</span> filter <span class="token operator">*</span>libseccomp<span class="token punctuation">.</span>ScmpFilter<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ç”Ÿæˆ BPF å­—èŠ‚ç </span></span>
<span class="line">    program<span class="token punctuation">,</span> err <span class="token operator">:=</span> filter<span class="token punctuation">.</span><span class="token function">ExportBPF</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åº”ç”¨ ENOSYS è¡¥ä¸ï¼šå¯¹æœªçŸ¥ç³»ç»Ÿè°ƒç”¨è¿”å› ENOSYS è€Œä¸æ˜¯ kill</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">needsEnosysPatch</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        program<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">patchEnosys</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to patch BPF program: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åŠ è½½è¡¥ä¸åçš„ BPF ç¨‹åº</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Prctl</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>PR_SET_SECCOMP<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>SECCOMP_MODE_FILTER<span class="token punctuation">,</span> </span>
<span class="line">                        <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>program<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to load seccomp filter: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">needsEnosysPatch</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Seccomp<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// å½“é»˜è®¤åŠ¨ä½œä¸æ˜¯ ALLOW ä¸”æ²¡æœ‰ä½¿ç”¨ notify æœºåˆ¶æ—¶éœ€è¦è¡¥ä¸</span></span>
<span class="line">    <span class="token keyword">return</span> config<span class="token punctuation">.</span>DefaultAction <span class="token operator">!=</span> configs<span class="token punctuation">.</span>Kill <span class="token operator">&amp;&amp;</span> </span>
<span class="line">           config<span class="token punctuation">.</span>DefaultAction <span class="token operator">!=</span> configs<span class="token punctuation">.</span>KillThread <span class="token operator">&amp;&amp;</span></span>
<span class="line">           config<span class="token punctuation">.</span>ListenerPath <span class="token operator">==</span> <span class="token string">&quot;&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-6-é«˜çº§ç‰¹æ€§-seccomp-notify" tabindex="-1"><a class="header-anchor" href="#_3-6-é«˜çº§ç‰¹æ€§-seccomp-notify"><span>3.6 é«˜çº§ç‰¹æ€§ï¼šseccomp notify</span></a></h3><p>seccomp notify æ˜¯è¾ƒæ–°çš„ç‰¹æ€§ï¼Œå…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºåŠ¨æ€å¤„ç†ç³»ç»Ÿè°ƒç”¨ï¼š</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// æ£€æŸ¥ notify æœºåˆ¶çš„é™åˆ¶</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">validateNotifyConfig</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Seccomp<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>ListenerPath <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// notify æœºåˆ¶éœ€è¦ Linux 5.7+ å’Œ libseccomp 2.5.0+</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">isNotifySupported</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;seccomp notify requires Linux 5.7+ and libseccomp 2.5.0+&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// write ç³»ç»Ÿè°ƒç”¨ä¸èƒ½ä½¿ç”¨ notify (é¿å…åˆå§‹åŒ–æ­»é”)</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> syscall <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Syscalls <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> syscall<span class="token punctuation">.</span>Name <span class="token operator">==</span> <span class="token string">&quot;write&quot;</span> <span class="token operator">&amp;&amp;</span> syscall<span class="token punctuation">.</span>Action <span class="token operator">==</span> configs<span class="token punctuation">.</span>Notify <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;write syscall cannot use notify action&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-7-é»˜è®¤-seccomp-ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#_3-7-é»˜è®¤-seccomp-ç­–ç•¥"><span>3.7 é»˜è®¤ seccomp ç­–ç•¥</span></a></h3><p>runc æä¾›äº†ä¿å®ˆçš„é»˜è®¤ seccomp é…ç½®ï¼š</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// é»˜è®¤è¢«é˜»æ­¢çš„å±é™©ç³»ç»Ÿè°ƒç”¨</span></span>
<span class="line"><span class="token keyword">var</span> defaultBlockedSyscalls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// å†…æ ¸æ¨¡å—æ“ä½œ</span></span>
<span class="line">    <span class="token string">&quot;init_module&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;finit_module&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;delete_module&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ç›´æ¥å†…å­˜è®¿é—®</span></span>
<span class="line">    <span class="token string">&quot;iopl&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ioperm&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ—¶é—´ä¿®æ”¹</span></span>
<span class="line">    <span class="token string">&quot;clock_settime&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;settimeofday&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;stime&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æŒ‚è½½æ“ä½œ</span></span>
<span class="line">    <span class="token string">&quot;mount&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;umount2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;swapon&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;swapoff&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ç³»ç»Ÿæ§åˆ¶</span></span>
<span class="line">    <span class="token string">&quot;reboot&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sethostname&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;setdomainname&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è¿›ç¨‹è·Ÿè¸ª</span></span>
<span class="line">    <span class="token string">&quot;ptrace&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ€§èƒ½ç›‘æ§</span></span>
<span class="line">    <span class="token string">&quot;perf_event_open&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å®¹å™¨é€ƒé€¸ç›¸å…³</span></span>
<span class="line">    <span class="token string">&quot;unshare&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;clone&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;setns&quot;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç”Ÿæˆé»˜è®¤ seccomp é…ç½®</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">DefaultProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>configs<span class="token punctuation">.</span>Seccomp <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>configs<span class="token punctuation">.</span>Seccomp<span class="token punctuation">{</span></span>
<span class="line">        DefaultAction<span class="token punctuation">:</span> configs<span class="token punctuation">.</span>Allow<span class="token punctuation">,</span>  <span class="token comment">// é»˜è®¤å…è®¸</span></span>
<span class="line">        Architectures<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>runtime<span class="token punctuation">.</span>GOARCH<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        Syscalls<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>configs<span class="token punctuation">.</span>Syscall<span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// é˜»æ­¢å±é™©ç³»ç»Ÿè°ƒç”¨</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                Names<span class="token punctuation">:</span>  defaultBlockedSyscalls<span class="token punctuation">,</span></span>
<span class="line">                Action<span class="token punctuation">:</span> configs<span class="token punctuation">.</span>Errno<span class="token punctuation">,</span></span>
<span class="line">                ErrnoRet<span class="token punctuation">:</span> <span class="token function">uint</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>EPERM<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// clone ç³»ç»Ÿè°ƒç”¨ç‰¹æ®Šå¤„ç†</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                Names<span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;clone&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                Action<span class="token punctuation">:</span> configs<span class="token punctuation">.</span>Allow<span class="token punctuation">,</span></span>
<span class="line">                Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>configs<span class="token punctuation">.</span>Arg<span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">// åªå…è®¸ç‰¹å®šçš„ clone æ ‡å¿—</span></span>
<span class="line">                    <span class="token punctuation">{</span></span>
<span class="line">                        Index<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">                        Value<span class="token punctuation">:</span> unix<span class="token punctuation">.</span>CLONE_NEWNS<span class="token punctuation">,</span></span>
<span class="line">                        Op<span class="token punctuation">:</span>    configs<span class="token punctuation">.</span>OpMaskedEqual<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-apparmor-selinux-å¼ºåˆ¶è®¿é—®æ§åˆ¶" tabindex="-1"><a class="header-anchor" href="#_4-apparmor-selinux-å¼ºåˆ¶è®¿é—®æ§åˆ¶"><span>4. AppArmor/SELinux å¼ºåˆ¶è®¿é—®æ§åˆ¶</span></a></h2><h3 id="_4-1-mac-vs-dac" tabindex="-1"><a class="header-anchor" href="#_4-1-mac-vs-dac"><span>4.1 MAC vs DAC</span></a></h3><p><strong>DAC (Discretionary Access Control)</strong>ï¼šä¼ ç»Ÿçš„ Unix æƒé™æ¨¡å‹</p><ul><li>æ–‡ä»¶æ‰€æœ‰è€…å¯ä»¥å†³å®šè®¿é—®æƒé™</li><li>åŸºäºç”¨æˆ·/ç»„/å…¶ä»–çš„ç®€å•ä¸‰å…ƒæ¨¡å‹</li><li>å®¹æ˜“è¢«æ¶æ„ç¨‹åºç»•è¿‡</li></ul><p><strong>MAC (Mandatory Access Control)</strong>ï¼šå¼ºåˆ¶è®¿é—®æ§åˆ¶</p><ul><li>ç³»ç»Ÿç®¡ç†å‘˜è®¾ç½®çš„ç­–ç•¥ä¸èƒ½è¢«ç»•è¿‡</li><li>åŸºäºå®‰å…¨æ ‡ç­¾å’Œç­–ç•¥è§„åˆ™</li><li>æä¾›æ›´å¼ºçš„å®‰å…¨ä¿æŠ¤</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">DAC æ¨¡å‹:                      MAC æ¨¡å‹:</span>
<span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚  æ–‡ä»¶æ‰€æœ‰è€…     â”‚   å†³å®š     â”‚      ç³»ç»Ÿç®¡ç†å‘˜             â”‚   åˆ¶å®š</span>
<span class="line">â”‚  è®¾ç½®æƒé™       â”‚  â”€â”€â”€â”€â†’    â”‚      åˆ¶å®šå®‰å…¨ç­–ç•¥           â”‚  â”€â”€â”€â”€â†’</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line">       â”‚                                    â”‚</span>
<span class="line">       â–¼                                    â–¼</span>
<span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚ rwx permissions â”‚           â”‚    AppArmor/SELinux ç­–ç•¥    â”‚</span>
<span class="line">â”‚ user:group:otherâ”‚           â”‚      ä¸å¯è¢«è¿›ç¨‹ä¿®æ”¹         â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-apparmor-é›†æˆ" tabindex="-1"><a class="header-anchor" href="#_4-2-apparmor-é›†æˆ"><span>4.2 AppArmor é›†æˆ</span></a></h3><h4 id="åŸºç¡€å®ç°" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€å®ç°"><span>åŸºç¡€å®ç°</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/apparmor/apparmor_linux.go:32</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">ApplyProfile</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> name <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ£€æŸ¥ AppArmor æ˜¯å¦å¯ç”¨</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">IsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;AppArmor is not enabled on this system&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åœ¨ exec æ—¶åˆ‡æ¢åˆ°æŒ‡å®šçš„ profile</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">changeOnExec</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">IsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ£€æŸ¥ AppArmor æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦æŒ‚è½½</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span><span class="token string">&quot;/sys/kernel/security/apparmor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ£€æŸ¥å½“å‰è¿›ç¨‹æ˜¯å¦åœ¨ AppArmor æ§åˆ¶ä¸‹</span></span>
<span class="line">    data<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token string">&quot;/proc/self/attr/current&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å¦‚æœä¸æ˜¯ &quot;unconfined&quot;ï¼Œè¯´æ˜ AppArmor å·²å¯ç”¨</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;unconfined&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">changeOnExec</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// å†™å…¥ exec å±æ€§æ–‡ä»¶ï¼Œåœ¨ä¸‹æ¬¡ exec æ—¶åˆ‡æ¢ profile</span></span>
<span class="line">    attrPath <span class="token operator">:=</span> <span class="token string">&quot;/proc/self/attr/exec&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å°è¯•æ–°ç‰ˆè·¯å¾„</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span><span class="token string">&quot;/proc/self/attr/apparmor/exec&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        attrPath <span class="token operator">=</span> <span class="token string">&quot;/proc/self/attr/apparmor/exec&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span>attrPath<span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_WRONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to open AppArmor exec attr: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å†™å…¥ profile åç§°ï¼Œæ ¼å¼ä¸º &quot;exec profilename&quot;</span></span>
<span class="line">    profileSpec <span class="token operator">:=</span> <span class="token string">&quot;exec &quot;</span> <span class="token operator">+</span> name</span>
<span class="line">    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> file<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>profileSpec<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set AppArmor profile %s: %w&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å®¹å™¨-apparmor-profile-ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#å®¹å™¨-apparmor-profile-ç¤ºä¾‹"><span>å®¹å™¨ AppArmor Profile ç¤ºä¾‹</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># /etc/apparmor.d/docker-default</span></span>
<span class="line"><span class="token comment">#include &lt;tunables/global&gt;</span></span>
<span class="line"></span>
<span class="line">profile docker-default <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token punctuation">(</span>attach_disconnected,mediate_deleted<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment"># ç½‘ç»œè®¿é—®</span></span>
<span class="line">  network inet tcp,</span>
<span class="line">  network inet udp,</span>
<span class="line">  network inet icmp,</span>
<span class="line">  </span>
<span class="line">  <span class="token comment"># æ–‡ä»¶ç³»ç»Ÿè®¿é—®</span></span>
<span class="line">  file,</span>
<span class="line">  / r,</span>
<span class="line">  /etc/ r,</span>
<span class="line">  /etc/** r,</span>
<span class="line">  /lib/ r,</span>
<span class="line">  /lib/** r,</span>
<span class="line">  /usr/ r,</span>
<span class="line">  /usr/** r,</span>
<span class="line">  </span>
<span class="line">  <span class="token comment"># ç¦æ­¢è®¿é—®æ•æ„Ÿè·¯å¾„</span></span>
<span class="line">  deny /sys/firmware/efi/efivars/ wl,</span>
<span class="line">  deny /sys/kernel/security/ wl,</span>
<span class="line">  deny /proc/sys/kernel/core_pattern wl,</span>
<span class="line">  deny /proc/kcore r,</span>
<span class="line">  deny /proc/kallsyms r,</span>
<span class="line">  </span>
<span class="line">  <span class="token comment"># å…è®¸çš„ç³»ç»Ÿè°ƒç”¨</span></span>
<span class="line">  capability chown,</span>
<span class="line">  capability dac_override,</span>
<span class="line">  capability setuid,</span>
<span class="line">  capability setgid,</span>
<span class="line">  capability net_bind_service,</span>
<span class="line">  </span>
<span class="line">  <span class="token comment"># ç¦æ­¢çš„å±é™©æ“ä½œ</span></span>
<span class="line">  deny capability sys_admin,</span>
<span class="line">  deny capability sys_time,</span>
<span class="line">  deny capability sys_module,</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-selinux-é›†æˆ" tabindex="-1"><a class="header-anchor" href="#_4-3-selinux-é›†æˆ"><span>4.3 SELinux é›†æˆ</span></a></h3><h4 id="æ ‡ç­¾è®¾ç½®" tabindex="-1"><a class="header-anchor" href="#æ ‡ç­¾è®¾ç½®"><span>æ ‡ç­¾è®¾ç½®</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// SELinux æ ‡ç­¾åº”ç”¨</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">ApplySELinuxLabels</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span>selinux<span class="token punctuation">.</span><span class="token function">GetEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®¾ç½®è¿›ç¨‹æ‰§è¡Œæ ‡ç­¾</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>ProcessLabel <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> selinux<span class="token punctuation">.</span><span class="token function">SetExecLabel</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>ProcessLabel<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set SELinux exec label: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®¾ç½®å¯†é’¥ç¯æ ‡ç­¾</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>ProcessLabel <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> selinux<span class="token punctuation">.</span><span class="token function">SetKeyLabel</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>ProcessLabel<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set SELinux key label: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æŒ‚è½½æ ‡ç­¾å¤„ç†" tabindex="-1"><a class="header-anchor" href="#æŒ‚è½½æ ‡ç­¾å¤„ç†"><span>æŒ‚è½½æ ‡ç­¾å¤„ç†</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// æ–‡ä»¶ç³»ç»ŸæŒ‚è½½æ—¶åº”ç”¨ SELinux æ ‡ç­¾</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">formatMountLabel</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> mountLabel <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> mountLabel <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ ¼å¼åŒ–æŒ‚è½½æ ‡ç­¾</span></span>
<span class="line">    <span class="token keyword">switch</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>mountLabel<span class="token punctuation">,</span> <span class="token string">&quot;context=&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> mountLabel</span>
<span class="line">    <span class="token keyword">default</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;context=%s&quot;</span><span class="token punctuation">,</span> mountLabel<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="selinux-ç­–ç•¥ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#selinux-ç­–ç•¥ç¤ºä¾‹"><span>SELinux ç­–ç•¥ç¤ºä¾‹</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># container.te - å®¹å™¨ SELinux ç­–ç•¥ç¤ºä¾‹</span></span>
<span class="line">policy_module<span class="token punctuation">(</span>container, <span class="token number">1.0</span>.0<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># å®¹å™¨åŸŸå®šä¹‰</span></span>
<span class="line"><span class="token builtin class-name">type</span> container_t<span class="token punctuation">;</span></span>
<span class="line"><span class="token builtin class-name">type</span> container_exec_t<span class="token punctuation">;</span></span>
<span class="line">domain_type<span class="token punctuation">(</span>container_t<span class="token punctuation">)</span></span>
<span class="line">domain_entry_file<span class="token punctuation">(</span>container_t, container_exec_t<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># å®¹å™¨æ–‡ä»¶ç±»å‹</span></span>
<span class="line"><span class="token builtin class-name">type</span> container_file_t<span class="token punctuation">;</span></span>
<span class="line">files_type<span class="token punctuation">(</span>container_file_t<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># å…è®¸å®¹å™¨åŸŸçš„åŸºæœ¬æ“ä½œ</span></span>
<span class="line">allow container_t self:process <span class="token punctuation">{</span> fork signal_perms <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">allow container_t self:fifo_file rw_fifo_file_perms<span class="token punctuation">;</span></span>
<span class="line">allow container_t self:unix_stream_socket create_stream_socket_perms<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># å…è®¸è®¿é—®å®¹å™¨æ–‡ä»¶</span></span>
<span class="line">allow container_t container_file_t:dir list_dir_perms<span class="token punctuation">;</span></span>
<span class="line">allow container_t container_file_t:file read_file_perms<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç¦æ­¢è®¿é—®æ•æ„Ÿèµ„æº</span></span>
<span class="line">neverallow container_t kernel_t:system module_load<span class="token punctuation">;</span></span>
<span class="line">neverallow container_t sysctl_t:file <span class="token function">write</span><span class="token punctuation">;</span></span>
<span class="line">neverallow container_t device_t:chr_file <span class="token function">write</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-ç”¨æˆ·å‘½åç©ºé—´æƒé™æ˜ å°„" tabindex="-1"><a class="header-anchor" href="#_5-ç”¨æˆ·å‘½åç©ºé—´æƒé™æ˜ å°„"><span>5. ç”¨æˆ·å‘½åç©ºé—´æƒé™æ˜ å°„</span></a></h2><h3 id="_5-1-id-æ˜ å°„æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#_5-1-id-æ˜ å°„æœºåˆ¶"><span>5.1 ID æ˜ å°„æœºåˆ¶</span></a></h3><p>ç”¨æˆ·å‘½åç©ºé—´å…è®¸å®¹å™¨å†…çš„ UID/GID æ˜ å°„åˆ°å®¿ä¸»æœºçš„ä¸åŒ UID/GIDï¼š</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">å®¹å™¨å†…è§†å›¾:        æ˜ å°„å…³ç³»:           å®¿ä¸»æœºè§†å›¾:</span>
<span class="line">UID 0 (root)  â†â”€â†’  UID 1000 (user)    UID 1000 (æ™®é€šç”¨æˆ·)</span>
<span class="line">UID 1         â†â”€â†’  UID 1001           UID 1001</span>
<span class="line">UID 2         â†â”€â†’  UID 1002           UID 1002</span>
<span class="line">...           â†â”€â†’  ...                ...</span>
<span class="line">UID 65535     â†â”€â†’  UID 66535          UID 66535</span>
<span class="line"></span>
<span class="line">æ˜ å°„é…ç½®:</span>
<span class="line">å®¹å™¨ID: 0,  å®¿ä¸»ID: 1000, èŒƒå›´: 65536</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-id-æ˜ å°„é…ç½®" tabindex="-1"><a class="header-anchor" href="#_5-2-id-æ˜ å°„é…ç½®"><span>5.2 ID æ˜ å°„é…ç½®</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/configs/config.go:85</span></span>
<span class="line"><span class="token keyword">type</span> IDMap <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    ContainerID <span class="token builtin">int64</span> <span class="token string">`json:&quot;container_id&quot;`</span>  <span class="token comment">// å®¹å™¨å†…èµ·å§‹ ID</span></span>
<span class="line">    HostID      <span class="token builtin">int64</span> <span class="token string">`json:&quot;host_id&quot;`</span>       <span class="token comment">// å®¿ä¸»æœºèµ·å§‹ ID  </span></span>
<span class="line">    Size        <span class="token builtin">int64</span> <span class="token string">`json:&quot;size&quot;`</span>          <span class="token comment">// æ˜ å°„èŒƒå›´å¤§å°</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç”¨æˆ·æ˜ å°„è·å–</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">GetUserNamespaceMappings</span><span class="token punctuation">(</span>nsPath <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>IDMap<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>IDMap<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// å¿«é€Ÿè·¯å¾„ï¼šç›´æ¥è¯»å–æ˜ å°„æ–‡ä»¶</span></span>
<span class="line">    uidMaps<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">readMappingFile</span><span class="token punctuation">(</span>nsPath<span class="token punctuation">,</span> <span class="token string">&quot;uid_map&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        gidMaps<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">readMappingFile</span><span class="token punctuation">(</span>nsPath<span class="token punctuation">,</span> <span class="token string">&quot;gid_map&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> uidMaps<span class="token punctuation">,</span> gidMaps<span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ…¢é€Ÿè·¯å¾„ï¼šä½¿ç”¨ C ä»£ç åœ¨ç”¨æˆ·å‘½åç©ºé—´å†…è¯»å–</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">readMappingsWithC</span><span class="token punctuation">(</span>nsPath<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-æ˜ å°„æ–‡ä»¶è¯»å–" tabindex="-1"><a class="header-anchor" href="#_5-3-æ˜ å°„æ–‡ä»¶è¯»å–"><span>5.3 æ˜ å°„æ–‡ä»¶è¯»å–</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/internal/userns/userns_maps_linux.go:89</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">readMappingFile</span><span class="token punctuation">(</span>nsPath<span class="token punctuation">,</span> mapType <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>IDMap<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    mapPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">&quot;/proc&quot;</span><span class="token punctuation">,</span> <span class="token function">extractPid</span><span class="token punctuation">(</span>nsPath<span class="token punctuation">)</span><span class="token punctuation">,</span> mapType<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    data<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>mapPath<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">var</span> mappings <span class="token punctuation">[</span><span class="token punctuation">]</span>IDMap</span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> line <span class="token operator">:=</span> <span class="token keyword">range</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        line <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> line <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">continue</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// è§£ææ ¼å¼: &quot;å®¹å™¨ID å®¿ä¸»ID èŒƒå›´å¤§å°&quot;</span></span>
<span class="line">        parts <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Fields</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">3</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">continue</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        containerID<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span></span>
<span class="line">        hostID<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span></span>
<span class="line">        size<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        mappings <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>mappings<span class="token punctuation">,</span> IDMap<span class="token punctuation">{</span></span>
<span class="line">            ContainerID<span class="token punctuation">:</span> containerID<span class="token punctuation">,</span></span>
<span class="line">            HostID<span class="token punctuation">:</span>      hostID<span class="token punctuation">,</span></span>
<span class="line">            Size<span class="token punctuation">:</span>        size<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> mappings<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-c-ä»£ç æ˜ å°„è¯»å–" tabindex="-1"><a class="header-anchor" href="#_5-4-c-ä»£ç æ˜ å°„è¯»å–"><span>5.4 C ä»£ç æ˜ å°„è¯»å–</span></a></h3><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// libcontainer/internal/userns/userns_maps_linux.c:45</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">spawn_userns_cat</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ns_path<span class="token punctuation">,</span> <span class="token keyword">int</span> output_fd<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span> ns_fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> file_fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ‰“å¼€ç”¨æˆ·å‘½åç©ºé—´æ–‡ä»¶æè¿°ç¬¦</span></span>
<span class="line">    ns_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>ns_path<span class="token punctuation">,</span> O_RDONLY <span class="token operator">|</span> O_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ns_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">goto</span> error<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// fork å­è¿›ç¨‹</span></span>
<span class="line">    <span class="token class-name">pid_t</span> child <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// å­è¿›ç¨‹ï¼šè¿›å…¥ç”¨æˆ·å‘½åç©ºé—´</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setns</span><span class="token punctuation">(</span>ns_fd<span class="token punctuation">,</span> CLONE_NEWUSER<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">goto</span> error<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// åœ¨ç”¨æˆ·å‘½åç©ºé—´å†…æ‰“å¼€æ˜ å°„æ–‡ä»¶</span></span>
<span class="line">        file_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> O_RDONLY <span class="token operator">|</span> O_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>file_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">goto</span> error<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// å¤åˆ¶æ–‡ä»¶å†…å®¹åˆ°è¾“å‡ºç®¡é“</span></span>
<span class="line">        <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">ssize_t</span> bytes<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bytes <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>output_fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span> <span class="token operator">!=</span> bytes<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">goto</span> error<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">close</span><span class="token punctuation">(</span>ns_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">    error<span class="token operator">:</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>file_fd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>ns_fd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">close</span><span class="token punctuation">(</span>ns_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// çˆ¶è¿›ç¨‹ï¼šç­‰å¾…å­è¿›ç¨‹å®Œæˆ</span></span>
<span class="line">        <span class="token keyword">int</span> status<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">waitpid</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!=</span> child<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// fork å¤±è´¥</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-5-rootless-å®¹å™¨å®‰å…¨æ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#_5-5-rootless-å®¹å™¨å®‰å…¨æ¨¡å‹"><span>5.5 Rootless å®¹å™¨å®‰å…¨æ¨¡å‹</span></a></h3><p>Rootless å®¹å™¨ä½¿ç”¨ç”¨æˆ·å‘½åç©ºé—´å®ç°æ— ç‰¹æƒè¿è¡Œï¼š</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># rootless å®¹å™¨çš„å…¸å‹æ˜ å°„é…ç½®</span></span>
<span class="line">$ <span class="token function">cat</span> /proc/self/uid_map</span>
<span class="line">         <span class="token number">0</span>       <span class="token number">1000</span>          <span class="token number">1</span>      <span class="token comment"># å®¹å™¨root â†’ å®¿ä¸»æ™®é€šç”¨æˆ·</span></span>
<span class="line">         <span class="token number">1</span>     <span class="token number">100000</span>      <span class="token number">65536</span>      <span class="token comment"># å…¶ä»–ID â†’ å­IDèŒƒå›´</span></span>
<span class="line"></span>
<span class="line">$ <span class="token function">cat</span> /proc/self/gid_map  </span>
<span class="line">         <span class="token number">0</span>       <span class="token number">1000</span>          <span class="token number">1</span>      <span class="token comment"># å®¹å™¨rootç»„ â†’ å®¿ä¸»æ™®é€šç»„</span></span>
<span class="line">         <span class="token number">1</span>     <span class="token number">100000</span>      <span class="token number">65536</span>      <span class="token comment"># å…¶ä»–ç»„ â†’ å­ç»„èŒƒå›´</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥å­IDé…ç½®</span></span>
<span class="line">$ <span class="token function">cat</span> /etc/subuid</span>
<span class="line">user:100000:65536</span>
<span class="line"></span>
<span class="line">$ <span class="token function">cat</span> /etc/subgid  </span>
<span class="line">user:100000:65536</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Rootless å®‰å…¨ä¼˜åŠ¿</strong>ï¼š</p><ul><li>ğŸš« <strong>æ— éœ€ç‰¹æƒ</strong>: ä¸éœ€è¦ root æƒé™å¯åŠ¨å®¹å™¨</li><li>ğŸ”’ <strong>æƒé™éš”ç¦»</strong>: å®¹å™¨å†… root æƒé™è¢«é™åˆ¶åœ¨ç”¨æˆ·å‘½åç©ºé—´å†…</li><li>ğŸ›¡ï¸ <strong>æ”»å‡»é¢ç¼©å°</strong>: å‡å°‘äº†ç‰¹æƒå‡çº§çš„æ”»å‡»é¢</li></ul><h2 id="_6-å®‰å…¨ç­–ç•¥é…ç½®å’Œåº”ç”¨" tabindex="-1"><a class="header-anchor" href="#_6-å®‰å…¨ç­–ç•¥é…ç½®å’Œåº”ç”¨"><span>6. å®‰å…¨ç­–ç•¥é…ç½®å’Œåº”ç”¨</span></a></h2><h3 id="_6-1-å®‰å…¨é…ç½®éªŒè¯" tabindex="-1"><a class="header-anchor" href="#_6-1-å®‰å…¨é…ç½®éªŒè¯"><span>6.1 å®‰å…¨é…ç½®éªŒè¯</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/configs/validate/security.go:15</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">security</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ£€æŸ¥ MaskPaths/ReadonlyPaths éœ€è¦ç§æœ‰ mount namespace</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>MaskPaths<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>ReadonlyPaths<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></span>
<span class="line">        <span class="token operator">!</span>config<span class="token punctuation">.</span>Namespaces<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>configs<span class="token punctuation">.</span>NEWNS<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;cannot restrict paths without private mount namespace&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ£€æŸ¥ SELinux é…ç½®</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>ProcessLabel <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>selinux<span class="token punctuation">.</span><span class="token function">GetEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;SELinux label specified but SELinux disabled&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ£€æŸ¥ AppArmor é…ç½®</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>AppArmorProfile <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>apparmor<span class="token punctuation">.</span><span class="token function">IsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;AppArmor profile specified but AppArmor disabled&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ£€æŸ¥ seccomp é…ç½®</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>Seccomp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">validateSeccompConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Seccomp<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;invalid seccomp config: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-å®‰å…¨ç­–ç•¥åº”ç”¨æµç¨‹" tabindex="-1"><a class="header-anchor" href="#_6-2-å®‰å…¨ç­–ç•¥åº”ç”¨æµç¨‹"><span>6.2 å®‰å…¨ç­–ç•¥åº”ç”¨æµç¨‹</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/standard_init_linux.go:200</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">finalizeNamespace</span><span class="token punctuation">(</span>config <span class="token operator">*</span>initConfig<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. åº”ç”¨ AppArmor profile</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> apparmor<span class="token punctuation">.</span><span class="token function">ApplyProfile</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>AppArmorProfile<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to apply AppArmor profile: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. è®¾ç½® SELinux æ ‡ç­¾</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> selinux<span class="token punctuation">.</span><span class="token function">SetExecLabel</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>ProcessLabel<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set SELinux label: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. åº”ç”¨æ–‡ä»¶ç³»ç»Ÿé™åˆ¶</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">applyPathRestrictions</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to apply path restrictions: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. è®¾ç½® no_new_privs ä½</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>NoNewPrivileges <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Prctl</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>PR_SET_NO_NEW_PRIVS<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set no_new_privs: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 5. åº”ç”¨ Linux capabilities</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> capabilities<span class="token punctuation">.</span><span class="token function">ApplyCapabilities</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Capabilities<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to apply capabilities: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 6. åˆå§‹åŒ– seccomp è¿‡æ»¤å™¨</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>Seccomp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> seccomp<span class="token punctuation">.</span><span class="token function">InitSeccomp</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Seccomp<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to initialize seccomp: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-è·¯å¾„é™åˆ¶å®ç°" tabindex="-1"><a class="header-anchor" href="#_6-3-è·¯å¾„é™åˆ¶å®ç°"><span>6.3 è·¯å¾„é™åˆ¶å®ç°</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// åº”ç”¨æ•æ„Ÿè·¯å¾„çš„è®¿é—®é™åˆ¶</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">applyPathRestrictions</span><span class="token punctuation">(</span>config <span class="token operator">*</span>initConfig<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// å±è”½æ•æ„Ÿè·¯å¾„ (ç”¨ tmpfs è¦†ç›–)</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> path <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>MaskPaths <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">maskPath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Readonlyfs<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®¾ç½®åªè¯»è·¯å¾„</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> path <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>ReadonlyPaths <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">readonlyPath</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">maskPath</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> readonly <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ä½¿ç”¨ tmpfs æŒ‚è½½æ¥å±è”½æ•æ„Ÿè·¯å¾„</span></span>
<span class="line">    flags <span class="token operator">:=</span> unix<span class="token punctuation">.</span>MS_RDONLY</span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span>readonly <span class="token punctuation">{</span></span>
<span class="line">        flags <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&quot;tmpfs&quot;</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> <span class="token string">&quot;tmpfs&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                   <span class="token function">uintptr</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// å¦‚æœæŒ‚è½½å¤±è´¥ï¼Œå°è¯•åˆ›å»ºç©ºæ–‡ä»¶è¦†ç›–</span></span>
<span class="line">        <span class="token keyword">if</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">createEmptyFile</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">readonlyPath</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ç»‘å®šæŒ‚è½½åé‡æ–°æŒ‚è½½ä¸ºåªè¯»</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mount</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> path<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_BIND<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span>  <span class="token comment">// è·¯å¾„ä¸å­˜åœ¨ï¼Œå¿½ç•¥</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">mount</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> path<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                unix<span class="token punctuation">.</span>MS_BIND<span class="token operator">|</span>unix<span class="token punctuation">.</span>MS_REMOUNT<span class="token operator">|</span>unix<span class="token punctuation">.</span>MS_RDONLY<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-å®è·µç»ƒä¹ " tabindex="-1"><a class="header-anchor" href="#_7-å®è·µç»ƒä¹ "><span>7. å®è·µç»ƒä¹ </span></a></h2><h3 id="_7-1-capabilities-å®éªŒ" tabindex="-1"><a class="header-anchor" href="#_7-1-capabilities-å®éªŒ"><span>7.1 Capabilities å®éªŒ</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># å®éªŒ 1: ç†è§£ capabilities çš„ä½œç”¨</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥å½“å‰è¿›ç¨‹çš„ capabilities</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;=== Current Process Capabilities ===&quot;</span></span>
<span class="line"><span class="token function">cat</span> /proc/self/status <span class="token operator">|</span> <span class="token function">grep</span> Cap</span>
<span class="line"></span>
<span class="line"><span class="token comment"># ä½¿ç”¨ capsh åˆ†æ capabilities</span></span>
<span class="line">capsh <span class="token parameter variable">--decode</span><span class="token operator">=</span>0x00000000a80425fb</span>
<span class="line">capsh <span class="token parameter variable">--print</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æµ‹è¯•ç½‘ç»œæƒé™</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;=== Testing Network Capabilities ===&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># åˆ›å»ºä¸€ä¸ªæ²¡æœ‰ CAP_NET_ADMIN çš„è¿›ç¨‹</span></span>
<span class="line">capsh <span class="token parameter variable">--drop</span><span class="token operator">=</span>cap_net_admin <span class="token parameter variable">--print</span> <span class="token operator">&amp;</span></span>
<span class="line"><span class="token assign-left variable">PID</span><span class="token operator">=</span><span class="token variable">$!</span></span>
<span class="line"><span class="token function">sleep</span> <span class="token number">1</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># å°è¯•ä¿®æ”¹ç½‘ç»œé…ç½® (åº”è¯¥å¤±è´¥)</span></span>
<span class="line">nsenter <span class="token parameter variable">-t</span> <span class="token variable">$PID</span> <span class="token parameter variable">-n</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> lo down <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;Permission denied (expected)&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># åˆ›å»ºæœ‰ CAP_NET_BIND_SERVICE çš„è¿›ç¨‹æµ‹è¯•ç‰¹æƒç«¯å£</span></span>
<span class="line">python3 <span class="token parameter variable">-c</span> <span class="token string">&quot;</span>
<span class="line">import socket</span>
<span class="line">try:</span>
<span class="line">    s = socket.socket()</span>
<span class="line">    s.bind<span class="token variable"><span class="token punctuation">((</span>&#39;&#39;<span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">))</span></span>  # ç‰¹æƒç«¯å£</span>
<span class="line">    print(&#39;Successfully bound to port 80&#39;)</span>
<span class="line">    s.close()</span>
<span class="line">except PermissionError:</span>
<span class="line">    print(&#39;Cannot bind to privileged port (expected without CAP_NET_BIND_SERVICE)&#39;)</span>
<span class="line">&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-seccomp-è¿‡æ»¤å®éªŒ" tabindex="-1"><a class="header-anchor" href="#_7-2-seccomp-è¿‡æ»¤å®éªŒ"><span>7.2 seccomp è¿‡æ»¤å®éªŒ</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// å®éªŒ 2: seccomp ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤</span></span>
<span class="line"><span class="token keyword">package</span> main</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;fmt&quot;</span></span>
<span class="line">    <span class="token string">&quot;os&quot;</span></span>
<span class="line">    <span class="token string">&quot;syscall&quot;</span></span>
<span class="line">    <span class="token string">&quot;unsafe&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token string">&quot;golang.org/x/sys/unix&quot;</span></span>
<span class="line">    <span class="token string">&quot;github.com/seccomp/libseccomp-golang&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// åˆ›å»º seccomp è¿‡æ»¤å™¨</span></span>
<span class="line">    filter<span class="token punctuation">,</span> err <span class="token operator">:=</span> seccomp<span class="token punctuation">.</span><span class="token function">NewFilter</span><span class="token punctuation">(</span>seccomp<span class="token punctuation">.</span>ActAllow<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> filter<span class="token punctuation">.</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ç¦æ­¢ mkdir ç³»ç»Ÿè°ƒç”¨</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> filter<span class="token punctuation">.</span><span class="token function">AddRule</span><span class="token punctuation">(</span>seccomp<span class="token punctuation">.</span><span class="token function">ScmpSyscall</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>SYS_MKDIR<span class="token punctuation">)</span><span class="token punctuation">,</span> </span>
<span class="line">                            seccomp<span class="token punctuation">.</span>ActErrno<span class="token punctuation">.</span><span class="token function">SetReturnCode</span><span class="token punctuation">(</span><span class="token function">int16</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>EPERM<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åŠ è½½è¿‡æ»¤å™¨</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> filter<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;seccomp filter loaded&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æµ‹è¯•è¢«ç¦æ­¢çš„ç³»ç»Ÿè°ƒç”¨</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Mkdir</span><span class="token punctuation">(</span><span class="token string">&quot;/tmp/test-mkdir&quot;</span><span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;mkdir failed as expected: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;ERROR: mkdir should have been blocked!&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æµ‹è¯•å…è®¸çš„ç³»ç»Ÿè°ƒç”¨</span></span>
<span class="line">    <span class="token keyword">if</span> file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token string">&quot;/tmp/test-create&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;file creation allowed&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        os<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span><span class="token string">&quot;/tmp/test-create&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-3-apparmor-profile-æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#_7-3-apparmor-profile-æµ‹è¯•"><span>7.3 AppArmor Profile æµ‹è¯•</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># å®éªŒ 3: AppArmor profile çº¦æŸæµ‹è¯•</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥ AppArmor çŠ¶æ€</span></span>
<span class="line"><span class="token function">sudo</span> aa-status</span>
<span class="line"></span>
<span class="line"><span class="token comment"># åˆ›å»ºæµ‹è¯• profile</span></span>
<span class="line"><span class="token function">sudo</span> <span class="token function">tee</span> /etc/apparmor.d/test-container <span class="token operator">&gt;</span> /dev/null <span class="token operator">&lt;&lt;</span> <span class="token string">&#39;EOF&#39;</span>
<span class="line">#include &lt;tunables/global&gt;</span>
<span class="line"></span>
<span class="line">profile test-container flags=(attach_disconnected) {</span>
<span class="line">  #include &lt;abstractions/base&gt;</span>
<span class="line">  </span>
<span class="line">  # å…è®¸åŸºæœ¬æ–‡ä»¶è®¿é—®</span>
<span class="line">  / r,</span>
<span class="line">  /bin/** ix,</span>
<span class="line">  /lib/** ix,</span>
<span class="line">  /usr/bin/** ix,</span>
<span class="line">  /tmp/** rw,</span>
<span class="line">  </span>
<span class="line">  # ç¦æ­¢è®¿é—®æ•æ„Ÿæ–‡ä»¶</span>
<span class="line">  deny /etc/shadow r,</span>
<span class="line">  deny /proc/*/mem r,</span>
<span class="line">  deny /sys/kernel/security/** rw,</span>
<span class="line">  </span>
<span class="line">  # å…è®¸ç½‘ç»œ</span>
<span class="line">  network inet tcp,</span>
<span class="line">  network inet udp,</span>
<span class="line">  </span>
<span class="line">  # ç¦æ­¢æŸäº› capabilities</span>
<span class="line">  deny capability sys_admin,</span>
<span class="line">  deny capability sys_time,</span>
<span class="line">}</span>
<span class="line">EOF</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># åŠ è½½ profile</span></span>
<span class="line"><span class="token function">sudo</span> apparmor_parser <span class="token parameter variable">-r</span> /etc/apparmor.d/test-container</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æµ‹è¯• profile çº¦æŸ</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;=== Testing AppArmor Profile Constraints ===&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># åœ¨ profile çº¦æŸä¸‹è¿è¡Œå‘½ä»¤</span></span>
<span class="line"><span class="token function">sudo</span> aa-exec <span class="token parameter variable">-p</span> test-container /bin/bash <span class="token parameter variable">-c</span> <span class="token string">&#39;</span>
<span class="line">echo &quot;Running under AppArmor profile: $(cat /proc/self/attr/current)&quot;</span>
<span class="line"></span>
<span class="line"># å…è®¸çš„æ“ä½œ</span>
<span class="line">echo &quot;test&quot; &gt; /tmp/allowed.txt</span>
<span class="line">cat /tmp/allowed.txt</span>
<span class="line"></span>
<span class="line"># è¢«ç¦æ­¢çš„æ“ä½œ</span>
<span class="line">echo &quot;Trying to read /etc/shadow:&quot;</span>
<span class="line">cat /etc/shadow 2&gt;&amp;1 || echo &quot;Access denied (expected)&quot;</span>
<span class="line"></span>
<span class="line">echo &quot;Trying to read /proc/1/mem:&quot;</span>
<span class="line">head -c 10 /proc/1/mem 2&gt;&amp;1 || echo &quot;Access denied (expected)&quot;</span>
<span class="line">&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ¸…ç†</span></span>
<span class="line"><span class="token function">sudo</span> <span class="token function">rm</span> /tmp/allowed.txt</span>
<span class="line"><span class="token function">sudo</span> apparmor_parser <span class="token parameter variable">-R</span> /etc/apparmor.d/test-container</span>
<span class="line"><span class="token function">sudo</span> <span class="token function">rm</span> /etc/apparmor.d/test-container</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-4-ç”¨æˆ·å‘½åç©ºé—´æ˜ å°„å®éªŒ" tabindex="-1"><a class="header-anchor" href="#_7-4-ç”¨æˆ·å‘½åç©ºé—´æ˜ å°„å®éªŒ"><span>7.4 ç”¨æˆ·å‘½åç©ºé—´æ˜ å°„å®éªŒ</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># å®éªŒ 4: ç”¨æˆ·å‘½åç©ºé—´æƒé™æ˜ å°„</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;=== User Namespace ID Mapping Test ===&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥å½“å‰ UID/GID</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;Current UID/GID outside namespace: <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span><span class="token variable">)</span></span>&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´å¹¶è®¾ç½®æ˜ å°„</span></span>
<span class="line">unshare <span class="token parameter variable">--user</span> --map-root-user /bin/bash <span class="token parameter variable">-c</span> <span class="token string">&#39;</span>
<span class="line">echo &quot;=== Inside User Namespace ===&quot;</span>
<span class="line">echo &quot;UID/GID inside namespace: $(id)&quot;</span>
<span class="line">echo</span>
<span class="line"></span>
<span class="line"># æ£€æŸ¥æ˜ å°„æ–‡ä»¶</span>
<span class="line">echo &quot;UID mapping:&quot;</span>
<span class="line">cat /proc/self/uid_map</span>
<span class="line"></span>
<span class="line">echo &quot;GID mapping:&quot;  </span>
<span class="line">cat /proc/self/gid_map</span>
<span class="line"></span>
<span class="line"># æµ‹è¯•æ–‡ä»¶æƒé™</span>
<span class="line">echo &quot;=== File Permission Test ===&quot;</span>
<span class="line">echo &quot;Creating file as root inside namespace...&quot;</span>
<span class="line">touch /tmp/userns-test-file</span>
<span class="line">ls -la /tmp/userns-test-file</span>
<span class="line"></span>
<span class="line">echo &quot;File ownership as seen from namespace:&quot;</span>
<span class="line">stat -c &quot;UID: %u, GID: %g&quot; /tmp/userns-test-file</span>
<span class="line">&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;=== Outside Namespace View ===&quot;</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;File ownership as seen from host:&quot;</span></span>
<span class="line"><span class="token function">stat</span> <span class="token parameter variable">-c</span> <span class="token string">&quot;UID: %u, GID: %g&quot;</span> /tmp/userns-test-file <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;File not accessible&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ¸…ç†</span></span>
<span class="line"><span class="token function">rm</span> <span class="token parameter variable">-f</span> /tmp/userns-test-file</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-å®‰å…¨æœ€ä½³å®è·µ" tabindex="-1"><a class="header-anchor" href="#_8-å®‰å…¨æœ€ä½³å®è·µ"><span>8. å®‰å…¨æœ€ä½³å®è·µ</span></a></h2><h3 id="_8-1-å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•" tabindex="-1"><a class="header-anchor" href="#_8-1-å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•"><span>8.1 å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># å®¹å™¨å®‰å…¨é…ç½®æ£€æŸ¥è„šæœ¬</span></span>
<span class="line"></span>
<span class="line"><span class="token function-name function">check_security_config</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin class-name">local</span> <span class="token assign-left variable">config_file</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$1</span>&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;=== Container Security Configuration Audit ===&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># æ£€æŸ¥ capabilities</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;1. Checking Capabilities:&quot;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token string">&#39;&quot;bounding&quot;.*&quot;CAP_SYS_ADMIN&quot;&#39;</span> <span class="token string">&quot;<span class="token variable">$config_file</span>&quot;</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  âš ï¸  WARNING: CAP_SYS_ADMIN granted (high risk)&quot;</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  âœ… CAP_SYS_ADMIN not granted&quot;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token string">&#39;&quot;bounding&quot;.*&quot;CAP_SYS_MODULE&quot;&#39;</span> <span class="token string">&quot;<span class="token variable">$config_file</span>&quot;</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  âŒ CRITICAL: CAP_SYS_MODULE granted (kernel module loading)&quot;</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  âœ… CAP_SYS_MODULE not granted&quot;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># æ£€æŸ¥ seccomp</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;2. Checking seccomp:&quot;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token string">&#39;&quot;defaultAction&quot;:&quot;SCMP_ACT_ALLOW&quot;&#39;</span> <span class="token string">&quot;<span class="token variable">$config_file</span>&quot;</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  âš ï¸  WARNING: Default seccomp action is ALLOW&quot;</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  âœ… Restrictive seccomp policy&quot;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># æ£€æŸ¥åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;3. Checking root filesystem:&quot;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token string">&#39;&quot;readonly&quot;:true&#39;</span> <span class="token string">&quot;<span class="token variable">$config_file</span>&quot;</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  âœ… Root filesystem is read-only&quot;</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  âš ï¸  WARNING: Root filesystem is writable&quot;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># æ£€æŸ¥ç‰¹æƒæ¨¡å¼</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;4. Checking privileged mode:&quot;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token string">&#39;&quot;privileged&quot;:true&#39;</span> <span class="token string">&quot;<span class="token variable">$config_file</span>&quot;</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  âŒ CRITICAL: Container running in privileged mode&quot;</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  âœ… Container not privileged&quot;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># æ£€æŸ¥ç”¨æˆ·å‘½åç©ºé—´</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;5. Checking user namespace:&quot;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token string">&#39;&quot;type&quot;:&quot;user&quot;&#39;</span> <span class="token string">&quot;<span class="token variable">$config_file</span>&quot;</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  âœ… User namespace enabled&quot;</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  âš ï¸  WARNING: User namespace not enabled&quot;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ä½¿ç”¨ç¤ºä¾‹</span></span>
<span class="line"><span class="token comment"># check_security_config config.json</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-å®‰å…¨ç­–ç•¥æ¨¡æ¿" tabindex="-1"><a class="header-anchor" href="#_8-2-å®‰å…¨ç­–ç•¥æ¨¡æ¿"><span>8.2 å®‰å…¨ç­–ç•¥æ¨¡æ¿</span></a></h3><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;ociVersion&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.2&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;process&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;user&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;uid&quot;</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;gid&quot;</span><span class="token operator">:</span> <span class="token number">1000</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/app/server&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;capabilities&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;bounding&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token string">&quot;CAP_CHOWN&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;CAP_SETGID&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">        <span class="token string">&quot;CAP_SETUID&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;CAP_NET_BIND_SERVICE&quot;</span></span>
<span class="line">      <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;effective&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token string">&quot;CAP_CHOWN&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;CAP_SETGID&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;CAP_SETUID&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">        <span class="token string">&quot;CAP_NET_BIND_SERVICE&quot;</span></span>
<span class="line">      <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;permitted&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token string">&quot;CAP_CHOWN&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;CAP_SETGID&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;CAP_SETUID&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;CAP_NET_BIND_SERVICE&quot;</span></span>
<span class="line">      <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;noNewPrivileges&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;root&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rootfs&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;readonly&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;linux&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;namespaces&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pid&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;network&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mount&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;uts&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ipc&quot;</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;uidMappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;containerID&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;hostID&quot;</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">1</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;gidMappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;containerID&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;hostID&quot;</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span> </span>
<span class="line">        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">1</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;seccomp&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;defaultAction&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SCMP_ACT_ERRNO&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;architectures&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;SCMP_ARCH_X86_64&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;syscalls&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">&quot;names&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">            <span class="token string">&quot;read&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;write&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;open&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;stat&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;fstat&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;lstat&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;poll&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;lseek&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mmap&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mprotect&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;munmap&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;brk&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rt_sigaction&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rt_sigprocmask&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;access&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pipe&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;select&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sched_yield&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;mremap&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;msync&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mincore&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;madvise&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;dup&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dup2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pause&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;nanosleep&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;getitimer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;alarm&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;setitimer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;getpid&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;sendfile&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;socket&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;connect&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;accept&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;sendto&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;recvfrom&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sendmsg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;recvmsg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;shutdown&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bind&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;listen&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;getsockname&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;getpeername&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;socketpair&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;setsockopt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;getsockopt&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;clone&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;fork&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;vfork&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;execve&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;exit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;wait4&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;kill&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;uname&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;fcntl&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;flock&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;fsync&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;fdatasync&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;truncate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ftruncate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;getdents&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;getcwd&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;chdir&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;fchdir&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rename&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mkdir&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;rmdir&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;creat&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;link&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;unlink&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;symlink&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;readlink&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;chmod&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;fchmod&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;chown&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;fchown&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;lchown&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;umask&quot;</span></span>
<span class="line">          <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">&quot;action&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SCMP_ACT_ALLOW&quot;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;maskedPaths&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token string">&quot;/proc/acpi&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;/proc/asound&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">      <span class="token string">&quot;/proc/kcore&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;/proc/keys&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;/proc/latency_stats&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;/proc/timer_list&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;/proc/timer_stats&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;/proc/sched_debug&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;/sys/firmware&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;/sys/fs/cgroup&quot;</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;readonlyPaths&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token string">&quot;/proc/bus&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;/proc/fs&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">      <span class="token string">&quot;/proc/irq&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;/proc/sys&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;/proc/sysrq-trigger&quot;</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-3-å®‰å…¨ç›‘æ§å’Œå®¡è®¡" tabindex="-1"><a class="header-anchor" href="#_8-3-å®‰å…¨ç›‘æ§å’Œå®¡è®¡"><span>8.3 å®‰å…¨ç›‘æ§å’Œå®¡è®¡</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// å®‰å…¨äº‹ä»¶ç›‘æ§ç¤ºä¾‹</span></span>
<span class="line"><span class="token keyword">package</span> main</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;log&quot;</span></span>
<span class="line">    <span class="token string">&quot;os&quot;</span></span>
<span class="line">    <span class="token string">&quot;os/signal&quot;</span></span>
<span class="line">    <span class="token string">&quot;syscall&quot;</span></span>
<span class="line">    <span class="token string">&quot;time&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> SecurityMonitor <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    events <span class="token keyword">chan</span> SecurityEvent</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> SecurityEvent <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Type      <span class="token builtin">string</span></span>
<span class="line">    Message   <span class="token builtin">string</span></span>
<span class="line">    Timestamp time<span class="token punctuation">.</span>Time</span>
<span class="line">    Severity  <span class="token builtin">string</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>sm <span class="token operator">*</span>SecurityMonitor<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">go</span> sm<span class="token punctuation">.</span><span class="token function">monitorCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">go</span> sm<span class="token punctuation">.</span><span class="token function">monitorSeccomp</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">go</span> sm<span class="token punctuation">.</span><span class="token function">monitorAppArmor</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">go</span> sm<span class="token punctuation">.</span><span class="token function">logEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>sm <span class="token operator">*</span>SecurityMonitor<span class="token punctuation">)</span> <span class="token function">monitorCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ç›‘æ§ capabilities å˜åŒ–</span></span>
<span class="line">    ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> ticker<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token keyword">range</span> ticker<span class="token punctuation">.</span>C <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// æ£€æŸ¥å½“å‰è¿›ç¨‹çš„ capabilities</span></span>
<span class="line">        caps<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getCurrentCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">continue</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> <span class="token function">containsDangerousCapabilities</span><span class="token punctuation">(</span>caps<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            sm<span class="token punctuation">.</span>events <span class="token operator">&lt;-</span> SecurityEvent<span class="token punctuation">{</span></span>
<span class="line">                Type<span class="token punctuation">:</span>      <span class="token string">&quot;capability&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                Message<span class="token punctuation">:</span>   <span class="token string">&quot;Dangerous capabilities detected&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                Timestamp<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                Severity<span class="token punctuation">:</span>  <span class="token string">&quot;HIGH&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>sm <span class="token operator">*</span>SecurityMonitor<span class="token punctuation">)</span> <span class="token function">monitorSeccomp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ç›‘æ§ seccomp è¿è§„</span></span>
<span class="line">    <span class="token comment">// é€šè¿‡è§£æ /proc/self/status æ£€æŸ¥ seccomp çŠ¶æ€</span></span>
<span class="line">    ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> ticker<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token keyword">range</span> ticker<span class="token punctuation">.</span>C <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">isSeccompActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            sm<span class="token punctuation">.</span>events <span class="token operator">&lt;-</span> SecurityEvent<span class="token punctuation">{</span></span>
<span class="line">                Type<span class="token punctuation">:</span>      <span class="token string">&quot;seccomp&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                Message<span class="token punctuation">:</span>   <span class="token string">&quot;seccomp filter not active&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                Timestamp<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                Severity<span class="token punctuation">:</span>  <span class="token string">&quot;MEDIUM&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>sm <span class="token operator">*</span>SecurityMonitor<span class="token punctuation">)</span> <span class="token function">logEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> event <span class="token operator">:=</span> <span class="token keyword">range</span> sm<span class="token punctuation">.</span>events <span class="token punctuation">{</span></span>
<span class="line">        log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;[%s] %s: %s (%s)&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                  event<span class="token punctuation">.</span>Severity<span class="token punctuation">,</span> event<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> event<span class="token punctuation">.</span>Message<span class="token punctuation">,</span> </span>
<span class="line">                  event<span class="token punctuation">.</span>Timestamp<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>RFC3339<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    monitor <span class="token operator">:=</span> <span class="token operator">&amp;</span>SecurityMonitor<span class="token punctuation">{</span></span>
<span class="line">        events<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> SecurityEvent<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    monitor<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ç­‰å¾…é€€å‡ºä¿¡å·</span></span>
<span class="line">    sigChan <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">    signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>sigChan<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGINT<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGTERM<span class="token punctuation">)</span></span>
<span class="line">    <span class="token operator">&lt;-</span>sigChan</span>
<span class="line">    </span>
<span class="line">    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Security monitor shutting down&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-æ€è€ƒé¢˜" tabindex="-1"><a class="header-anchor" href="#_9-æ€è€ƒé¢˜"><span>9. æ€è€ƒé¢˜</span></a></h2><h3 id="_9-1-å®‰å…¨æ¨¡å‹æ€è€ƒ" tabindex="-1"><a class="header-anchor" href="#_9-1-å®‰å…¨æ¨¡å‹æ€è€ƒ"><span>9.1 å®‰å…¨æ¨¡å‹æ€è€ƒ</span></a></h3><ol><li><p><strong>å¤šå±‚é˜²æŠ¤</strong>: ä¸ºä»€ä¹ˆéœ€è¦ capabilities + seccomp + MAC çš„å¤šå±‚å®‰å…¨æœºåˆ¶ï¼Ÿå•ä¸€æœºåˆ¶çš„å±€é™æ€§æ˜¯ä»€ä¹ˆï¼Ÿ</p></li><li><p><strong>æƒé™æœ€å°åŒ–</strong>: å¦‚ä½•å¹³è¡¡å®‰å…¨æ€§å’ŒåŠŸèƒ½æ€§ï¼Ÿè¿‡åº¦é™åˆ¶æƒé™å¯èƒ½å¯¼è‡´ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p></li><li><p><strong>å®‰å…¨ç­–ç•¥</strong>: å¦‚ä½•ä¸ºä¸åŒç±»å‹çš„åº”ç”¨ï¼ˆWebæœåŠ¡ã€æ•°æ®åº“ã€æ‰¹å¤„ç†ä»»åŠ¡ï¼‰è®¾è®¡åˆé€‚çš„å®‰å…¨ç­–ç•¥ï¼Ÿ</p></li></ol><h3 id="_9-2-å®ç°ç»†èŠ‚æ€è€ƒ" tabindex="-1"><a class="header-anchor" href="#_9-2-å®ç°ç»†èŠ‚æ€è€ƒ"><span>9.2 å®ç°ç»†èŠ‚æ€è€ƒ</span></a></h3><ol start="4"><li><p><strong>Capabilitiesç»§æ‰¿</strong>: ambient capabilities è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿä¸ºä»€ä¹ˆéœ€è¦è¿™ç§å¤æ‚çš„ç»§æ‰¿æ¨¡å‹ï¼Ÿ</p></li><li><p><strong>seccompæ€§èƒ½</strong>: BPFè¿‡æ»¤å™¨å¯¹ç³»ç»Ÿè°ƒç”¨æ€§èƒ½çš„å½±å“å¦‚ä½•ï¼Ÿæœ‰ä»€ä¹ˆä¼˜åŒ–ç­–ç•¥ï¼Ÿ</p></li><li><p><strong>ç”¨æˆ·æ˜ å°„</strong>: åœ¨å¤§è§„æ¨¡å®¹å™¨ç¯å¢ƒä¸­ï¼Œå¦‚ä½•æœ‰æ•ˆç®¡ç†ç”¨æˆ·IDæ˜ å°„ï¼Ÿsubuid/subgid çš„åˆ†é…ç­–ç•¥ï¼Ÿ</p></li></ol><h3 id="_9-3-å®‰å…¨æŒ‘æˆ˜æ€è€ƒ" tabindex="-1"><a class="header-anchor" href="#_9-3-å®‰å…¨æŒ‘æˆ˜æ€è€ƒ"><span>9.3 å®‰å…¨æŒ‘æˆ˜æ€è€ƒ</span></a></h3><ol start="7"><li><p><strong>å®¹å™¨é€ƒé€¸</strong>: å½“å‰çš„å®‰å…¨æœºåˆ¶èƒ½é˜²æŠ¤å“ªäº›ç±»å‹çš„å®¹å™¨é€ƒé€¸ï¼Ÿè¿˜æœ‰ä»€ä¹ˆæ½œåœ¨æ¼æ´ï¼Ÿ</p></li><li><p><strong>å…¼å®¹æ€§é—®é¢˜</strong>: ä¸¥æ ¼çš„å®‰å…¨ç­–ç•¥å¯èƒ½å½±å“åº”ç”¨å…¼å®¹æ€§ï¼Œå¦‚ä½•å¤„ç†è¿™ç§å†²çªï¼Ÿ</p></li><li><p><strong>ç›‘æ§å®¡è®¡</strong>: å¦‚ä½•æœ‰æ•ˆç›‘æ§å’Œå®¡è®¡å®¹å™¨çš„å®‰å…¨è¡Œä¸ºï¼Ÿä»€ä¹ˆæ ·çš„è¡Œä¸ºåº”è¯¥è¢«æ ‡è®°ä¸ºå¯ç–‘ï¼Ÿ</p></li></ol><h2 id="_10-æ‰©å±•é˜…è¯»" tabindex="-1"><a class="header-anchor" href="#_10-æ‰©å±•é˜…è¯»"><span>10. æ‰©å±•é˜…è¯»</span></a></h2><h3 id="_10-1-linux-å®‰å…¨æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#_10-1-linux-å®‰å…¨æœºåˆ¶"><span>10.1 Linux å®‰å…¨æœºåˆ¶</span></a></h3><ul><li><a href="https://man7.org/linux/man-pages/man7/capabilities.7.html" target="_blank" rel="noopener noreferrer">Linux Capabilities<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://man7.org/linux/man-pages/man2/seccomp.2.html" target="_blank" rel="noopener noreferrer">seccomp(2)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://gitlab.com/apparmor/apparmor/-/wikis/Documentation" target="_blank" rel="noopener noreferrer">AppArmor Documentation<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://selinuxproject.org/page/User/UserGuide" target="_blank" rel="noopener noreferrer">SELinux User&#39;s Guide<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h3 id="_10-2-å®¹å™¨å®‰å…¨æœ€ä½³å®è·µ" tabindex="-1"><a class="header-anchor" href="#_10-2-å®¹å™¨å®‰å…¨æœ€ä½³å®è·µ"><span>10.2 å®¹å™¨å®‰å…¨æœ€ä½³å®è·µ</span></a></h3><ul><li><a href="https://www.cisecurity.org/benchmark/docker" target="_blank" rel="noopener noreferrer">CIS Docker Benchmark<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://csrc.nist.gov/publications/detail/sp/800-190/final" target="_blank" rel="noopener noreferrer">NIST Container Security Guide<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://info.aquasec.com/container-security-book" target="_blank" rel="noopener noreferrer">Container Security by Liz Rice<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h3 id="_10-3-å®‰å…¨ç ”ç©¶å’Œå·¥å…·" tabindex="-1"><a class="header-anchor" href="#_10-3-å®‰å…¨ç ”ç©¶å’Œå·¥å…·"><span>10.3 å®‰å…¨ç ”ç©¶å’Œå·¥å…·</span></a></h3><ul><li><a href="https://github.com/freach/container-security-awesome" target="_blank" rel="noopener noreferrer">Container Security Tools<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://falco.org/" target="_blank" rel="noopener noreferrer">Falco Runtime Security<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://open-policy-agent.github.io/gatekeeper/" target="_blank" rel="noopener noreferrer">OPA Gatekeeper<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h2 id="ğŸ¯-æ¨¡å—æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-æ¨¡å—æ€»ç»“"><span>ğŸ¯ æ¨¡å—æ€»ç»“</span></a></h2><p>é€šè¿‡æœ¬æ¨¡å—çš„å­¦ä¹ ï¼Œä½ åº”è¯¥å·²ç»æŒæ¡äº†ï¼š</p><p>âœ… <strong>å¤šå±‚å®‰å…¨æ¶æ„</strong>ï¼šç†è§£å®¹å™¨å®‰å…¨çš„å¨èƒæ¨¡å‹å’Œé˜²æŠ¤ä½“ç³»<br> âœ… <strong>Capabilities æƒé™æ§åˆ¶</strong>ï¼šæŒæ¡ç»†ç²’åº¦æƒé™ç®¡ç†å’Œåº”ç”¨ç­–ç•¥<br> âœ… <strong>seccomp ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤</strong>ï¼šç†è§£BPFè¿‡æ»¤å™¨å’Œç­–ç•¥é…ç½®<br> âœ… <strong>å¼ºåˆ¶è®¿é—®æ§åˆ¶</strong>ï¼šç†Ÿæ‚‰AppArmor/SELinuxçš„é›†æˆå’Œåº”ç”¨<br> âœ… <strong>ç”¨æˆ·æƒé™æ˜ å°„</strong>ï¼šæŒæ¡ç”¨æˆ·å‘½åç©ºé—´çš„å®‰å…¨æ¨¡å‹<br> âœ… <strong>å®‰å…¨ç­–ç•¥è®¾è®¡</strong>ï¼šå…·å¤‡è®¾è®¡å’Œå®æ–½å®¹å™¨å®‰å…¨ç­–ç•¥çš„èƒ½åŠ›</p><p><strong>ä¸‹ä¸€æ­¥</strong>: è¿›å…¥é«˜çº§ç‰¹æ€§æ¨¡å—ï¼Œå­¦ä¹  CRIUã€ç›‘æ§ã€æ„å»ºè‡ªå®šä¹‰å®¹å™¨è¿è¡Œæ—¶ç­‰ä¸»é¢˜ã€‚</p></div></div><footer class="page-meta"><div class="meta-item edit-link"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M2 26h28v2H2z" fill="currentColor"></path><path d="M25.4 9c.8-.8.8-2 0-2.8l-3.6-3.6c-.8-.8-2-.8-2.8 0l-15 15V24h6.4l15-15zm-5-5L24 7.6l-3 3L17.4 7l3-3zM6 22v-3.6l10-10l3.6 3.6l-10 10H6z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Edit this page<!--]--></span></span></div><div class="meta-item last-updated"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->æ›´æ–°äº 8/6/2025, 6:07:26 PM<!--]--></span></span></div></footer><!----><div class="reco-valine-wrapper"><div id="valine"></div></div></div><div class="page-catalog-container"><h5 class="tip">ç›®å½•</h5><ul><!--[--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#æ¦‚è¿°" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="æ¦‚è¿°"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->æ¦‚è¿°<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#ğŸ¯-å­¦ä¹ ç›®æ ‡" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="ğŸ¯ å­¦ä¹ ç›®æ ‡"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->ğŸ¯ å­¦ä¹ ç›®æ ‡<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_1-å®¹å™¨å®‰å…¨å¨èƒæ¨¡å‹" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1. å®¹å™¨å®‰å…¨å¨èƒæ¨¡å‹"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1. å®¹å™¨å®‰å…¨å¨èƒæ¨¡å‹<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_1-1-å®¹å™¨å®‰å…¨è¾¹ç•Œ" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1.1 å®¹å™¨å®‰å…¨è¾¹ç•Œ"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1.1 å®¹å™¨å®‰å…¨è¾¹ç•Œ<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_1-2-ä¸»è¦æ”»å‡»å‘é‡" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1.2 ä¸»è¦æ”»å‡»å‘é‡"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1.2 ä¸»è¦æ”»å‡»å‘é‡<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_1-3-å®‰å…¨æ¶æ„è®¾è®¡åŸåˆ™" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1.3 å®‰å…¨æ¶æ„è®¾è®¡åŸåˆ™"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1.3 å®‰å…¨æ¶æ„è®¾è®¡åŸåˆ™<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_2-linux-capabilities-æƒé™æ§åˆ¶" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2. Linux Capabilities æƒé™æ§åˆ¶"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2. Linux Capabilities æƒé™æ§åˆ¶<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_2-1-capabilities-åŸºç¡€æ¦‚å¿µ" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.1 Capabilities åŸºç¡€æ¦‚å¿µ"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.1 Capabilities åŸºç¡€æ¦‚å¿µ<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_2-2-äº”ç§-capabilities-é›†åˆ" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.2 äº”ç§ Capabilities é›†åˆ"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.2 äº”ç§ Capabilities é›†åˆ<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_2-3-å¸¸ç”¨-capabilities-è¯¦è§£" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.3 å¸¸ç”¨ Capabilities è¯¦è§£"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.3 å¸¸ç”¨ Capabilities è¯¦è§£<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_2-4-runc-ä¸­çš„-capabilities-å®ç°" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.4 runc ä¸­çš„ Capabilities å®ç°"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.4 runc ä¸­çš„ Capabilities å®ç°<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_2-5-é»˜è®¤-capabilities-ç­–ç•¥" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.5 é»˜è®¤ Capabilities ç­–ç•¥"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.5 é»˜è®¤ Capabilities ç­–ç•¥<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_3-seccomp-ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3. seccomp ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3. seccomp ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_3-1-seccomp-åŸºç¡€åŸç†" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.1 seccomp åŸºç¡€åŸç†"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.1 seccomp åŸºç¡€åŸç†<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_3-2-seccomp-é…ç½®ç»“æ„" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.2 seccomp é…ç½®ç»“æ„"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.2 seccomp é…ç½®ç»“æ„<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_3-3-seccomp-åŠ¨ä½œç±»å‹" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.3 seccomp åŠ¨ä½œç±»å‹"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.3 seccomp åŠ¨ä½œç±»å‹<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_3-4-runc-ä¸­çš„-seccomp-å®ç°" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.4 runc ä¸­çš„ seccomp å®ç°"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.4 runc ä¸­çš„ seccomp å®ç°<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_3-5-bpf-è¡¥ä¸ä¼˜åŒ–" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.5 BPF è¡¥ä¸ä¼˜åŒ–"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.5 BPF è¡¥ä¸ä¼˜åŒ–<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_3-6-é«˜çº§ç‰¹æ€§-seccomp-notify" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.6 é«˜çº§ç‰¹æ€§ï¼šseccomp notify"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.6 é«˜çº§ç‰¹æ€§ï¼šseccomp notify<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_3-7-é»˜è®¤-seccomp-ç­–ç•¥" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.7 é»˜è®¤ seccomp ç­–ç•¥"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.7 é»˜è®¤ seccomp ç­–ç•¥<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_4-apparmor-selinux-å¼ºåˆ¶è®¿é—®æ§åˆ¶" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4. AppArmor/SELinux å¼ºåˆ¶è®¿é—®æ§åˆ¶"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4. AppArmor/SELinux å¼ºåˆ¶è®¿é—®æ§åˆ¶<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_4-1-mac-vs-dac" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4.1 MAC vs DAC"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4.1 MAC vs DAC<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_4-2-apparmor-é›†æˆ" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4.2 AppArmor é›†æˆ"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4.2 AppArmor é›†æˆ<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_4-3-selinux-é›†æˆ" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4.3 SELinux é›†æˆ"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4.3 SELinux é›†æˆ<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_5-ç”¨æˆ·å‘½åç©ºé—´æƒé™æ˜ å°„" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5. ç”¨æˆ·å‘½åç©ºé—´æƒé™æ˜ å°„"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5. ç”¨æˆ·å‘½åç©ºé—´æƒé™æ˜ å°„<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_5-1-id-æ˜ å°„æœºåˆ¶" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.1 ID æ˜ å°„æœºåˆ¶"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.1 ID æ˜ å°„æœºåˆ¶<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_5-2-id-æ˜ å°„é…ç½®" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.2 ID æ˜ å°„é…ç½®"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.2 ID æ˜ å°„é…ç½®<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_5-3-æ˜ å°„æ–‡ä»¶è¯»å–" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.3 æ˜ å°„æ–‡ä»¶è¯»å–"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.3 æ˜ å°„æ–‡ä»¶è¯»å–<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_5-4-c-ä»£ç æ˜ å°„è¯»å–" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.4 C ä»£ç æ˜ å°„è¯»å–"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.4 C ä»£ç æ˜ å°„è¯»å–<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_5-5-rootless-å®¹å™¨å®‰å…¨æ¨¡å‹" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.5 Rootless å®¹å™¨å®‰å…¨æ¨¡å‹"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.5 Rootless å®¹å™¨å®‰å…¨æ¨¡å‹<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_6-å®‰å…¨ç­–ç•¥é…ç½®å’Œåº”ç”¨" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6. å®‰å…¨ç­–ç•¥é…ç½®å’Œåº”ç”¨"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6. å®‰å…¨ç­–ç•¥é…ç½®å’Œåº”ç”¨<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_6-1-å®‰å…¨é…ç½®éªŒè¯" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6.1 å®‰å…¨é…ç½®éªŒè¯"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6.1 å®‰å…¨é…ç½®éªŒè¯<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_6-2-å®‰å…¨ç­–ç•¥åº”ç”¨æµç¨‹" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6.2 å®‰å…¨ç­–ç•¥åº”ç”¨æµç¨‹"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6.2 å®‰å…¨ç­–ç•¥åº”ç”¨æµç¨‹<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_6-3-è·¯å¾„é™åˆ¶å®ç°" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6.3 è·¯å¾„é™åˆ¶å®ç°"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6.3 è·¯å¾„é™åˆ¶å®ç°<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_7-å®è·µç»ƒä¹ " class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7. å®è·µç»ƒä¹ "><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7. å®è·µç»ƒä¹ <!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_7-1-capabilities-å®éªŒ" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7.1 Capabilities å®éªŒ"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7.1 Capabilities å®éªŒ<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_7-2-seccomp-è¿‡æ»¤å®éªŒ" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7.2 seccomp è¿‡æ»¤å®éªŒ"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7.2 seccomp è¿‡æ»¤å®éªŒ<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_7-3-apparmor-profile-æµ‹è¯•" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7.3 AppArmor Profile æµ‹è¯•"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7.3 AppArmor Profile æµ‹è¯•<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_7-4-ç”¨æˆ·å‘½åç©ºé—´æ˜ å°„å®éªŒ" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7.4 ç”¨æˆ·å‘½åç©ºé—´æ˜ å°„å®éªŒ"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7.4 ç”¨æˆ·å‘½åç©ºé—´æ˜ å°„å®éªŒ<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_8-å®‰å…¨æœ€ä½³å®è·µ" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8. å®‰å…¨æœ€ä½³å®è·µ"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8. å®‰å…¨æœ€ä½³å®è·µ<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_8-1-å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8.1 å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8.1 å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_8-2-å®‰å…¨ç­–ç•¥æ¨¡æ¿" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8.2 å®‰å…¨ç­–ç•¥æ¨¡æ¿"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8.2 å®‰å…¨ç­–ç•¥æ¨¡æ¿<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_8-3-å®‰å…¨ç›‘æ§å’Œå®¡è®¡" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8.3 å®‰å…¨ç›‘æ§å’Œå®¡è®¡"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8.3 å®‰å…¨ç›‘æ§å’Œå®¡è®¡<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_9-æ€è€ƒé¢˜" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9. æ€è€ƒé¢˜"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9. æ€è€ƒé¢˜<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_9-1-å®‰å…¨æ¨¡å‹æ€è€ƒ" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9.1 å®‰å…¨æ¨¡å‹æ€è€ƒ"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9.1 å®‰å…¨æ¨¡å‹æ€è€ƒ<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_9-2-å®ç°ç»†èŠ‚æ€è€ƒ" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9.2 å®ç°ç»†èŠ‚æ€è€ƒ"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9.2 å®ç°ç»†èŠ‚æ€è€ƒ<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_9-3-å®‰å…¨æŒ‘æˆ˜æ€è€ƒ" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9.3 å®‰å…¨æŒ‘æˆ˜æ€è€ƒ"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9.3 å®‰å…¨æŒ‘æˆ˜æ€è€ƒ<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_10-æ‰©å±•é˜…è¯»" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="10. æ‰©å±•é˜…è¯»"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->10. æ‰©å±•é˜…è¯»<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_10-1-linux-å®‰å…¨æœºåˆ¶" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="10.1 Linux å®‰å…¨æœºåˆ¶"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->10.1 Linux å®‰å…¨æœºåˆ¶<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_10-2-å®¹å™¨å®‰å…¨æœ€ä½³å®è·µ" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="10.2 å®¹å™¨å®‰å…¨æœ€ä½³å®è·µ"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->10.2 å®¹å™¨å®‰å…¨æœ€ä½³å®è·µ<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_10-3-å®‰å…¨ç ”ç©¶å’Œå·¥å…·" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="10.3 å®‰å…¨ç ”ç©¶å’Œå·¥å…·"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->10.3 å®‰å…¨ç ”ç©¶å’Œå·¥å…·<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#ğŸ¯-æ¨¡å—æ€»ç»“" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="ğŸ¯ æ¨¡å—æ€»ç»“"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->ğŸ¯ æ¨¡å—æ€»ç»“<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--></ul></div></main><!--]--></div></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/blog/assets/app-2O6audqE.js" defer></script>
  </body>
</html>

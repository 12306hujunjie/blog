<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-rc.19">
    <script>
      (function() {
        const userMode = localStorage.getItem('vuepress-reco-color-scheme') || 'auto';
        const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (userMode === 'dark' || (userMode === 'auto' && systemDarkMode)) {
          document.documentElement.classList.toggle('dark', true);
        }
      })();
    </script>
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.min.js" as="script"><title>安全特性实现 | database of memory</title><meta name="description" content="study anything and life record">
    <link rel="preload" href="/blog/assets/style-3Js8NCR5.css" as="style"><link rel="stylesheet" href="/blog/assets/style-3Js8NCR5.css">
    <link rel="modulepreload" href="/blog/assets/app-2O6audqE.js"><link rel="modulepreload" href="/blog/assets/06-anquantexingshixian.html-BHgpOUyN.js">
    <link rel="prefetch" href="/blog/assets/timeline.html-Dpj3Uwd1.js" as="script"><link rel="prefetch" href="/blog/assets/posts.html-CwxCj2Hz.js" as="script"><link rel="prefetch" href="/blog/assets/friendship-link.html-BWfmkE8T.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-u-MzmdCM.js" as="script"><link rel="prefetch" href="/blog/assets/2.html-BZ918lqD.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-C0q1hGsM.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CKULWdoq.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CWtVNK-m.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bd6PVF3c.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BbXNqe1N.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DyPCaQFd.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-C18Bjk_W.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BBVLOTuN.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D6KsFqqv.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BFPB5Kke.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B7IkZhlZ.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D_xT1fZZ.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DheB4D6E.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bt_l6w3U.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DeILrr-C.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DSTAwzEO.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BD5fA-NV.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BkRrSqYz.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-cT5R8xwx.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D9YDDbbv.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CbwTJPe7.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BuOxUP39.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BonFf6Hv.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DdMSM_BO.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Cf_rINiA.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DAcku8Eg.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DXT9U0AY.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DNdoOP4f.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-gqCMVOP4.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-HV0Wu9t8.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-LYxcb78a.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B50wkuh6.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DmpqsxHB.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-ChJizRVK.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D91uHYKf.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BLywihRf.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CB6EOmHd.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CxeevLHu.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B6J1fqYY.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D6g5ki7n.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CNoSmcFz.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dg6Odx9T.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dcy99l4T.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BK5mIUzD.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-8yVN6cur.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D33sQ_DA.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BOgMey9f.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D-L5Fugg.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-blGV0Kuf.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Ck4-7Hl7.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-N5xZIiU3.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DHa_luE7.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BDo2AWiQ.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CJj46_t8.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B32LjB8A.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DHAALd4l.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-H_UWlmPh.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DhnB-W5f.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dl8_vnsm.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-AlHvVsZC.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D7E4OavF.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CgCAEUN3.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-4Mr3uCmo.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BWKUAlc0.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CNuv7HDI.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BTkfIlYg.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dqp54iE9.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CtCFev89.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bb4UAQpl.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B6JysInN.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CHu47ESV.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CW5fe8Pz.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CBCt-NmX.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DV90AmxE.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DzWzo9Ij.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bz0VyI0Z.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BjgscHtw.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Cx8p_sw9.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DoYWpPPd.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Ci-xHJlU.js" as="script"><link rel="prefetch" href="/blog/assets/2.html-DwdRHJG4.js" as="script"><link rel="prefetch" href="/blog/assets/3.html-DoXfDGmJ.js" as="script"><link rel="prefetch" href="/blog/assets/4.html-C-kKKJQV.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-fn4kmre_.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CoWvKsGl.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BvQMmH-P.js" as="script"><link rel="prefetch" href="/blog/assets/bitwise_operation.html-EhYVvxM9.js" as="script"><link rel="prefetch" href="/blog/assets/learning_algorithm.html-Tnr40gqi.js" as="script"><link rel="prefetch" href="/blog/assets/cache_pattern.html-BWIGrhub.js" as="script"><link rel="prefetch" href="/blog/assets/docker_tech.html-B7PNaqxh.js" as="script"><link rel="prefetch" href="/blog/assets/k3s.html-DP3vWh7K.js" as="script"><link rel="prefetch" href="/blog/assets/k3s_k8s_ingress.html-0VG_Dn9p.js" as="script"><link rel="prefetch" href="/blog/assets/oci-01-intro-guide.html-CMWMS7fl.js" as="script"><link rel="prefetch" href="/blog/assets/oci-02-runtime-spec.html-C0iBtGsB.js" as="script"><link rel="prefetch" href="/blog/assets/oci-03-image-spec.html-BBhmTevb.js" as="script"><link rel="prefetch" href="/blog/assets/oci-04-distribution-spec.html-BK42sbpW.js" as="script"><link rel="prefetch" href="/blog/assets/oci-05-security-guide.html-B3_bjMcv.js" as="script"><link rel="prefetch" href="/blog/assets/oci-06-monitoring-guide.html-DZeNq5_D.js" as="script"><link rel="prefetch" href="/blog/assets/oci-07-production-guide.html-Dd4znSBp.js" as="script"><link rel="prefetch" href="/blog/assets/oci-08-hooks-deep-dive.html-U722baza.js" as="script"><link rel="prefetch" href="/blog/assets/oci-linux-configurations-blog.html-B-QLbxh0.js" as="script"><link rel="prefetch" href="/blog/assets/oci-series-index.html-CDKgV4-S.js" as="script"><link rel="prefetch" href="/blog/assets/runc-advanced-lifecycle-analysis.html-DksQevmb.js" as="script"><link rel="prefetch" href="/blog/assets/runc-comprehensive-design-guide.html-B3lFgAwq.js" as="script"><link rel="prefetch" href="/blog/assets/runc-container-lifecycle-diagrams.html-D0cL6kcw.js" as="script"><link rel="prefetch" href="/blog/assets/linux_namespace.html-C_6Up541.js" as="script"><link rel="prefetch" href="/blog/assets/python_checklist.html-C2qsWYBJ.js" as="script"><link rel="prefetch" href="/blog/assets/python_env_manage.html-CUnPJ_1B.js" as="script"><link rel="prefetch" href="/blog/assets/gevent.html-CUgqcz3s.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BJAgUlPO.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BO__mOgk.js" as="script"><link rel="prefetch" href="/blog/assets/sort_1.html-B61YFXe2.js" as="script"><link rel="prefetch" href="/blog/assets/01-runcgaishuyujiagou.html-CdwfP7-9.js" as="script"><link rel="prefetch" href="/blog/assets/02-rongqishengmingzhouqiguanli.html-C-f7fScs.js" as="script"><link rel="prefetch" href="/blog/assets/03-Namespacegelishixian.html-i58zOLTD.js" as="script"><link rel="prefetch" href="/blog/assets/04-Cgroupsziyuanguanli.html-Cv4-SHFL.js" as="script"><link rel="prefetch" href="/blog/assets/05-wenjianxitongyuguazaiguanli.html-BtljxstR.js" as="script"><link rel="prefetch" href="/blog/assets/07-CRIUjianchadianyuhuifu.html-2aSuteQG.js" as="script"><link rel="prefetch" href="/blog/assets/08-tongxinyujiankongxitong.html-C1uYqrtr.js" as="script"><link rel="prefetch" href="/blog/assets/09-goujianjianhuarongqiyunxingshi.html-ZL_qjd8j.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DhgGbCoG.js" as="script"><link rel="prefetch" href="/blog/assets/abstract_factory.html-qSB2vqGJ.js" as="script"><link rel="prefetch" href="/blog/assets/factory_method.html-DaXxm691.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CQ2duCZ4.js" as="script"><link rel="prefetch" href="/blog/assets/adapter.html-k-5RMaEx.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-BmtOmY9V.js" as="script"><link rel="prefetch" href="/blog/assets/Valine.min-VCLvSWzF.js" as="script"><link rel="prefetch" href="/blog/assets/giscus-aTimukGI-DWEKOTfS.js" as="script"><link rel="prefetch" href="/blog/assets/KnowledgeMap-Dr6IblrL.js" as="script"><link rel="prefetch" href="/blog/assets/MermaidChart-a1CbfxcL.js" as="script"><link rel="prefetch" href="/blog/assets/mermaid.core-xyQxSs4c.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container series--no show-catalog"><header class="navbar-container not-open"><div class="navbar-inner"><div class="site-brand nav-item"><img class="logo" src="/blog/logo.png" alt="database of memory"><a href="/blog/" class="site-name can-hide">database of memory</a></div><div class="nav-item navbar-links-wrapper" style=""><div><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div><nav class="navbar-links"><!--[--><div class="navbar-links__item"><a href="/blog/" class="link" aria-label="Home"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Home<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/blog/categories/cloud-base/1/" class="link" aria-label="Categories"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Categories<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/blog/tags/runc/1/" class="link" aria-label="Tags"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Tags<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/blog/knowledge-map/" class="link" aria-label="知识地图"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->知识地图<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="Docs"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Docs<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="Docs"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Docs<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/blog/docs/leetcode/" class="link" aria-label="leetcode from scratch"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->leetcode from scratch<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/docs/design_pattern/" class="link" aria-label="design pattern"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->design pattern<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--><!----><span class="xicon-container btn-toggle-dark-mode btn--dark-mode navbar-links__item"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><path d="M15 2h2v3h-2z" fill="currentColor"></path><path d="M27 15h3v2h-3z" fill="currentColor"></path><path d="M15 27h2v3h-2z" fill="currentColor"></path><path d="M2 15h3v2H2z" fill="currentColor"></path><path d="M5.45 6.884l1.414-1.415l2.121 2.122l-1.414 1.414z" fill="currentColor"></path><path d="M23 7.58l2.121-2.12l1.414 1.414l-2.121 2.121z" fill="currentColor"></path><path d="M23.002 24.416l1.415-1.414l2.12 2.122l-1.413 1.414z" fill="currentColor"></path><path d="M5.47 25.13L7.59 23L9 24.42l-2.12 2.12l-1.41-1.41z" fill="currentColor"></path><path d="M16 8a8 8 0 1 0 8 8a8 8 0 0 0-8-8zm0 14a6 6 0 0 1 0-12z" fill="currentColor"></path></svg></span><ul class="social-links navbar-links__item"><!--[--><li class="social-item"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:25px;height:25px;"><path d="M16 2a14 14 0 0 0-4.43 27.28c.7.13 1-.3 1-.67v-2.38c-3.89.84-4.71-1.88-4.71-1.88a3.71 3.71 0 0 0-1.62-2.05c-1.27-.86.1-.85.1-.85a2.94 2.94 0 0 1 2.14 1.45a3 3 0 0 0 4.08 1.16a2.93 2.93 0 0 1 .88-1.87c-3.1-.36-6.37-1.56-6.37-6.92a5.4 5.4 0 0 1 1.44-3.76a5 5 0 0 1 .14-3.7s1.17-.38 3.85 1.43a13.3 13.3 0 0 1 7 0c2.67-1.81 3.84-1.43 3.84-1.43a5 5 0 0 1 .14 3.7a5.4 5.4 0 0 1 1.44 3.76c0 5.38-3.27 6.56-6.39 6.91a3.33 3.33 0 0 1 .95 2.59v3.84c0 .46.25.81 1 .67A14 14 0 0 0 16 2z" fill-rule="evenodd" fill="currentColor"></path></svg></li><!--]--></ul></nav><span class="xicon-container btn-toggle-menus"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><circle cx="16" cy="8" r="2" fill="currentColor"></circle><circle cx="16" cy="16" r="2" fill="currentColor"></circle><circle cx="16" cy="24" r="2" fill="currentColor"></circle></svg></span></div></div></header><!----><!----><!----><div class="theme-main" style=""><!----><!--[--><main class="page-container"><div class="page-content"><h1 class="page-title">安全特性实现</h1><div class="page-info"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M16 4a5 5 0 1 1-5 5a5 5 0 0 1 5-5m0-2a7 7 0 1 0 7 7a7 7 0 0 0-7-7z" fill="currentColor"></path><path d="M26 30h-2v-5a5 5 0 0 0-5-5h-6a5 5 0 0 0-5 5v5H6v-5a7 7 0 0 1 7-7h6a7 7 0 0 1 7 7z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->hujunjie<!--]--></span></span><!----><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M11.17 6l3.42 3.41l.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[--><!--[--><a href="/blog/categories/cloud-base/runc-deep-dive/1.html" class="">cloud-base/runc-deep-dive</a><!--]--><!--]--></span></span><!----><!----></div><div class="theme-reco-md-content"><div><h1 id="安全特性实现" tabindex="-1"><a class="header-anchor" href="#安全特性实现"><span>安全特性实现</span></a></h1><blockquote><p><strong>系列导航：</strong> <a class="route-link" href="/blog/blogs/cloud-base/runc-deep-dive/">runc 容器运行时深度解析系列</a> → 第六篇：安全特性实现<br><strong>上一篇：</strong> <a class="route-link" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html">文件系统与挂载管理</a><br><strong>最后更新：</strong> 2024</p></blockquote><h2 id="概述" tabindex="-1"><a class="header-anchor" href="#概述"><span>概述</span></a></h2><p>本文深入分析 runc 的安全特性实现，包括 Capabilities、Seccomp、AppArmor/SELinux 等多层安全防护机制。这些安全特性保障了容器的隔离性和安全性。</p><h2 id="🎯-学习目标" tabindex="-1"><a class="header-anchor" href="#🎯-学习目标"><span>🎯 学习目标</span></a></h2><p>完成本模块后，你将能够：</p><ul><li>深入理解容器安全的多层防护体系和攻击面</li><li>掌握 Linux Capabilities 的细粒度权限控制机制</li><li>理解 seccomp 系统调用过滤的实现原理和配置方法</li><li>熟悉 AppArmor/SELinux 强制访问控制的集成方式</li><li>掌握用户命名空间权限映射的安全模型</li><li>具备设计和实施容器安全策略的实践能力</li></ul><h2 id="_1-容器安全威胁模型" tabindex="-1"><a class="header-anchor" href="#_1-容器安全威胁模型"><span>1. 容器安全威胁模型</span></a></h2><h3 id="_1-1-容器安全边界" tabindex="-1"><a class="header-anchor" href="#_1-1-容器安全边界"><span>1.1 容器安全边界</span></a></h3><p>容器安全需要在多个层面建立防护边界：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">┌─────────────────────────────────────────────────┐</span>
<span class="line">│                应用层                           │ ← 应用漏洞、恶意代码</span>
<span class="line">├─────────────────────────────────────────────────┤</span>
<span class="line">│              容器运行时层                       │ ← 容器逃逸、权限提升</span>
<span class="line">│  ┌─────────────────────────────────────────┐    │</span>
<span class="line">│  │           runc 安全机制             │    │</span>
<span class="line">│  │ ┌─────────────┬─────────────────────┐ │    │</span>
<span class="line">│  │ │ Capabilities│    seccomp         │ │    │</span>
<span class="line">│  │ └─────────────┴─────────────────────┘ │    │</span>
<span class="line">│  │ ┌─────────────┬─────────────────────┐ │    │</span>
<span class="line">│  │ │ AppArmor/   │  User Namespaces   │ │    │</span>
<span class="line">│  │ │ SELinux     │                    │ │    │</span>
<span class="line">│  │ └─────────────┴─────────────────────┘ │    │</span>
<span class="line">│  └─────────────────────────────────────────┘    │</span>
<span class="line">├─────────────────────────────────────────────────┤</span>
<span class="line">│                Linux 内核层                     │ ← 内核漏洞、驱动问题</span>
<span class="line">├─────────────────────────────────────────────────┤</span>
<span class="line">│                硬件层                           │ ← 硬件漏洞、侧信道攻击</span>
<span class="line">└─────────────────────────────────────────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-主要攻击向量" tabindex="-1"><a class="header-anchor" href="#_1-2-主要攻击向量"><span>1.2 主要攻击向量</span></a></h3><table><thead><tr><th>攻击类型</th><th>描述</th><th>runc 防护机制</th></tr></thead><tbody><tr><td><strong>容器逃逸</strong></td><td>突破容器边界访问宿主机</td><td>Namespaces + Capabilities + seccomp</td></tr><tr><td><strong>权限提升</strong></td><td>获得超出预期的权限</td><td>User Namespaces + Capabilities</td></tr><tr><td><strong>资源耗尽</strong></td><td>DOS攻击耗尽系统资源</td><td>Cgroups + rlimits</td></tr><tr><td><strong>信息泄露</strong></td><td>访问不应访问的信息</td><td>/proc检查 + 文件系统隔离</td></tr><tr><td><strong>系统调用滥用</strong></td><td>利用危险系统调用</td><td>seccomp 过滤</td></tr><tr><td><strong>横向移动</strong></td><td>攻击其他容器或服务</td><td>网络隔离 + SELinux/AppArmor</td></tr></tbody></table><h3 id="_1-3-安全架构设计原则" tabindex="-1"><a class="header-anchor" href="#_1-3-安全架构设计原则"><span>1.3 安全架构设计原则</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 安全配置的核心结构</span></span>
<span class="line"><span class="token keyword">type</span> SecurityConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 权限控制</span></span>
<span class="line">    Capabilities     <span class="token operator">*</span>Capabilities    <span class="token string">`json:&quot;capabilities,omitempty&quot;`</span></span>
<span class="line">    NoNewPrivileges  <span class="token builtin">bool</span>            <span class="token string">`json:&quot;no_new_privileges,omitempty&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 系统调用过滤</span></span>
<span class="line">    Seccomp          <span class="token operator">*</span>Seccomp        <span class="token string">`json:&quot;seccomp,omitempty&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 强制访问控制</span></span>
<span class="line">    AppArmorProfile  <span class="token builtin">string</span>          <span class="token string">`json:&quot;apparmor_profile,omitempty&quot;`</span></span>
<span class="line">    ProcessLabel     <span class="token builtin">string</span>          <span class="token string">`json:&quot;process_label,omitempty&quot;`</span>    <span class="token comment">// SELinux</span></span>
<span class="line">    MountLabel       <span class="token builtin">string</span>          <span class="token string">`json:&quot;mount_label,omitempty&quot;`</span>      <span class="token comment">// SELinux</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 用户权限映射</span></span>
<span class="line">    UIDMappings      <span class="token punctuation">[</span><span class="token punctuation">]</span>IDMap         <span class="token string">`json:&quot;uid_mappings,omitempty&quot;`</span></span>
<span class="line">    GIDMappings      <span class="token punctuation">[</span><span class="token punctuation">]</span>IDMap         <span class="token string">`json:&quot;gid_mappings,omitempty&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 文件系统安全</span></span>
<span class="line">    MaskPaths        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>        <span class="token string">`json:&quot;mask_paths,omitempty&quot;`</span></span>
<span class="line">    ReadonlyPaths    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>        <span class="token string">`json:&quot;readonly_paths,omitempty&quot;`</span></span>
<span class="line">    Readonlyfs       <span class="token builtin">bool</span>            <span class="token string">`json:&quot;readonlyfs,omitempty&quot;`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>核心原则</strong>：</p><ul><li>🔒 <strong>最小权限原则</strong>: 只授予必要的最小权限</li><li>🛡️ <strong>深度防护</strong>: 多层安全机制相互补充</li><li>🚫 <strong>默认拒绝</strong>: 除非明确允许，否则拒绝访问</li><li>📝 <strong>审计跟踪</strong>: 记录安全相关的操作和决策</li></ul><h2 id="_2-linux-capabilities-权限控制" tabindex="-1"><a class="header-anchor" href="#_2-linux-capabilities-权限控制"><span>2. Linux Capabilities 权限控制</span></a></h2><h3 id="_2-1-capabilities-基础概念" tabindex="-1"><a class="header-anchor" href="#_2-1-capabilities-基础概念"><span>2.1 Capabilities 基础概念</span></a></h3><p>传统的 Unix 权限模型只有 <strong>特权用户 (root)</strong> 和 <strong>普通用户</strong> 的区分。Linux Capabilities 将 root 的超级权限分解为细粒度的能力位：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">传统权限模型:              Capabilities 模型:</span>
<span class="line">┌──────────────┐         ┌─────────────────────────────┐</span>
<span class="line">│     root     │   分解   │ CAP_NET_ADMIN  (网络管理)   │</span>
<span class="line">│  (所有权限)   │  ────→  │ CAP_SYS_ADMIN  (系统管理)   │</span>
<span class="line">└──────────────┘         │ CAP_KILL       (发送信号)   │</span>
<span class="line">       │                 │ CAP_CHOWN      (文件所有权) │</span>
<span class="line">       │                 │ CAP_SETUID     (切换用户)   │</span>
<span class="line">┌──────────────┐         │ CAP_MKNOD      (创建设备)   │</span>
<span class="line">│  普通用户     │         │ ... 38+ 种能力             │</span>
<span class="line">└──────────────┘         └─────────────────────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-五种-capabilities-集合" tabindex="-1"><a class="header-anchor" href="#_2-2-五种-capabilities-集合"><span>2.2 五种 Capabilities 集合</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/configs/config.go:145</span></span>
<span class="line"><span class="token keyword">type</span> Capabilities <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 边界集：内核检查的能力上限</span></span>
<span class="line">    Bounding    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:&quot;bounding,omitempty&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 有效集：当前正在使用的能力</span></span>
<span class="line">    Effective   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:&quot;effective,omitempty&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 可继承集：可以传递给子进程的能力</span></span>
<span class="line">    Inheritable <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:&quot;inheritable,omitempty&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 许可集：进程被允许拥有的能力上限</span></span>
<span class="line">    Permitted   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:&quot;permitted,omitempty&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 环境集：在 execve 后自动添加到许可和有效集的能力</span></span>
<span class="line">    Ambient     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:&quot;ambient,omitempty&quot;`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>集合关系图</strong>：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">进程执行前:                    execve() 后:</span>
<span class="line">┌─────────────┐               ┌─────────────────┐</span>
<span class="line">│ Bounding    │───────────────→│ 新进程 Bounding │ (不变)</span>
<span class="line">└─────────────┘               └─────────────────┘</span>
<span class="line">┌─────────────┐               ┌─────────────────┐</span>
<span class="line">│ Permitted   │─┐             │ 新进程 Permitted│ (按规则计算)</span>
<span class="line">└─────────────┘ │             └─────────────────┘</span>
<span class="line">┌─────────────┐ │ 计算         ┌─────────────────┐</span>
<span class="line">│ Inheritable │─┼─规则────────→│ 新进程 Effective│ (按规则计算)</span>
<span class="line">└─────────────┘ │             └─────────────────┘</span>
<span class="line">┌─────────────┐ │             ┌─────────────────┐</span>
<span class="line">│ Ambient     │─┘             │ 新进程 Inheritable│ (继承)</span>
<span class="line">└─────────────┘               └─────────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-常用-capabilities-详解" tabindex="-1"><a class="header-anchor" href="#_2-3-常用-capabilities-详解"><span>2.3 常用 Capabilities 详解</span></a></h3><table><thead><tr><th>Capability</th><th>功能</th><th>容器中的应用</th></tr></thead><tbody><tr><td><strong>CAP_NET_ADMIN</strong></td><td>网络管理权限</td><td>配置网络接口、路由、iptables</td></tr><tr><td><strong>CAP_NET_BIND_SERVICE</strong></td><td>绑定特权端口(&lt;1024)</td><td>Web服务器监听80/443端口</td></tr><tr><td><strong>CAP_SYS_ADMIN</strong></td><td>系统管理权限</td><td>挂载文件系统、设置主机名</td></tr><tr><td><strong>CAP_SYS_TIME</strong></td><td>修改系统时间</td><td>NTP服务、时间同步</td></tr><tr><td><strong>CAP_KILL</strong></td><td>发送信号到任意进程</td><td>进程监控、信号传递</td></tr><tr><td><strong>CAP_CHOWN</strong></td><td>修改文件所有权</td><td>文件权限管理</td></tr><tr><td><strong>CAP_SETUID/SETGID</strong></td><td>切换用户ID</td><td>sudo、认证服务</td></tr><tr><td><strong>CAP_MKNOD</strong></td><td>创建设备文件</td><td>设备驱动、特殊设备</td></tr></tbody></table><h3 id="_2-4-runc-中的-capabilities-实现" tabindex="-1"><a class="header-anchor" href="#_2-4-runc-中的-capabilities-实现"><span>2.4 runc 中的 Capabilities 实现</span></a></h3><h4 id="应用流程" tabindex="-1"><a class="header-anchor" href="#应用流程"><span>应用流程</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/capabilities/capabilities.go:61</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">ApplyCapabilities</span><span class="token punctuation">(</span>c <span class="token operator">*</span>configs<span class="token punctuation">.</span>Capabilities<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 清除所有 capabilities 集合</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">clearCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 按照特定顺序设置 capabilities</span></span>
<span class="line">    <span class="token comment">// 顺序很重要，因为不同集合之间有依赖关系</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setCapabilities</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Effective<span class="token punctuation">,</span> effective<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set effective capabilities: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setCapabilities</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Permitted<span class="token punctuation">,</span> permitted<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set permitted capabilities: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setCapabilities</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Inheritable<span class="token punctuation">,</span> inheritable<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set inheritable capabilities: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setCapabilities</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Bounding<span class="token punctuation">,</span> bounding<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set bounding capabilities: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. Ambient 集合需要特殊处理</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setAmbientCapabilities</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Ambient<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set ambient capabilities: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ambient-capabilities-特殊处理" tabindex="-1"><a class="header-anchor" href="#ambient-capabilities-特殊处理"><span>Ambient Capabilities 特殊处理</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">setAmbientCapabilities</span><span class="token punctuation">(</span>caps <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// Ambient capabilities 是较新的特性，需要特别处理</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token builtin">cap</span> <span class="token operator">:=</span> <span class="token keyword">range</span> caps <span class="token punctuation">{</span></span>
<span class="line">        capInt<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getCapabilityNumber</span><span class="token punctuation">(</span><span class="token builtin">cap</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">continue</span>  <span class="token comment">// 忽略不支持的 capability</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 重置 ambient 集合</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Prctl</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>PR_CAP_AMBIENT<span class="token punctuation">,</span> </span>
<span class="line">                           unix<span class="token punctuation">.</span>PR_CAP_AMBIENT_CLEAR_ALL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 逐个添加 capability 到 ambient 集合</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Prctl</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>PR_CAP_AMBIENT<span class="token punctuation">,</span> </span>
<span class="line">                           unix<span class="token punctuation">.</span>PR_CAP_AMBIENT_RAISE<span class="token punctuation">,</span> capInt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 如果失败，可能是因为该 capability 不在 permitted 或 inheritable 集合中</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to add %s to ambient set: %w&quot;</span><span class="token punctuation">,</span> <span class="token builtin">cap</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="兼容性处理" tabindex="-1"><a class="header-anchor" href="#兼容性处理"><span>兼容性处理</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">setCapabilities</span><span class="token punctuation">(</span>caps <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> capType capabilityType<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token builtin">cap</span> <span class="token operator">:=</span> <span class="token keyword">range</span> caps <span class="token punctuation">{</span></span>
<span class="line">        capInt<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getCapabilityNumber</span><span class="token punctuation">(</span><span class="token builtin">cap</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 对于未知的 capability，记录警告但不报错</span></span>
<span class="line">            <span class="token comment">// 这保证了向前兼容性</span></span>
<span class="line">            logrus<span class="token punctuation">.</span><span class="token function">WithError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Warnf</span><span class="token punctuation">(</span><span class="token string">&quot;Ignoring unknown capability %q&quot;</span><span class="token punctuation">,</span> <span class="token builtin">cap</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">continue</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">applySingleCapability</span><span class="token punctuation">(</span>capInt<span class="token punctuation">,</span> capType<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 某些 capability 在特定内核版本中可能不可用</span></span>
<span class="line">            <span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>EINVAL<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                logrus<span class="token punctuation">.</span><span class="token function">WithError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Warnf</span><span class="token punctuation">(</span><span class="token string">&quot;Capability %s not supported&quot;</span><span class="token punctuation">,</span> <span class="token builtin">cap</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">continue</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-5-默认-capabilities-策略" tabindex="-1"><a class="header-anchor" href="#_2-5-默认-capabilities-策略"><span>2.5 默认 Capabilities 策略</span></a></h3><p>runc 使用保守的默认 capabilities 策略：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 默认授予的 capabilities（最小集合）</span></span>
<span class="line"><span class="token keyword">var</span> defaultCapabilities <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&quot;CAP_CHOWN&quot;</span><span class="token punctuation">,</span>           <span class="token comment">// 修改文件所有权</span></span>
<span class="line">    <span class="token string">&quot;CAP_DAC_OVERRIDE&quot;</span><span class="token punctuation">,</span>    <span class="token comment">// 绕过文件权限检查</span></span>
<span class="line">    <span class="token string">&quot;CAP_FSETID&quot;</span><span class="token punctuation">,</span>          <span class="token comment">// 设置文件 set-user-ID 位</span></span>
<span class="line">    <span class="token string">&quot;CAP_FOWNER&quot;</span><span class="token punctuation">,</span>          <span class="token comment">// 绕过文件所有权检查</span></span>
<span class="line">    <span class="token string">&quot;CAP_MKNOD&quot;</span><span class="token punctuation">,</span>           <span class="token comment">// 创建设备文件</span></span>
<span class="line">    <span class="token string">&quot;CAP_NET_RAW&quot;</span><span class="token punctuation">,</span>         <span class="token comment">// 使用 RAW 和 PACKET 套接字</span></span>
<span class="line">    <span class="token string">&quot;CAP_SETGID&quot;</span><span class="token punctuation">,</span>          <span class="token comment">// 修改进程 GID</span></span>
<span class="line">    <span class="token string">&quot;CAP_SETUID&quot;</span><span class="token punctuation">,</span>          <span class="token comment">// 修改进程 UID</span></span>
<span class="line">    <span class="token string">&quot;CAP_SETFCAP&quot;</span><span class="token punctuation">,</span>         <span class="token comment">// 设置文件 capabilities</span></span>
<span class="line">    <span class="token string">&quot;CAP_SETPCAP&quot;</span><span class="token punctuation">,</span>         <span class="token comment">// 修改进程 capabilities</span></span>
<span class="line">    <span class="token string">&quot;CAP_NET_BIND_SERVICE&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 绑定特权端口</span></span>
<span class="line">    <span class="token string">&quot;CAP_SYS_CHROOT&quot;</span><span class="token punctuation">,</span>      <span class="token comment">// 使用 chroot</span></span>
<span class="line">    <span class="token string">&quot;CAP_KILL&quot;</span><span class="token punctuation">,</span>            <span class="token comment">// 发送信号</span></span>
<span class="line">    <span class="token string">&quot;CAP_AUDIT_WRITE&quot;</span><span class="token punctuation">,</span>     <span class="token comment">// 写入审计日志</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 明确禁用的危险 capabilities</span></span>
<span class="line"><span class="token keyword">var</span> droppedCapabilities <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&quot;CAP_SYS_ADMIN&quot;</span><span class="token punctuation">,</span>       <span class="token comment">// 系统管理权限</span></span>
<span class="line">    <span class="token string">&quot;CAP_SYS_TIME&quot;</span><span class="token punctuation">,</span>        <span class="token comment">// 修改系统时间</span></span>
<span class="line">    <span class="token string">&quot;CAP_NET_ADMIN&quot;</span><span class="token punctuation">,</span>       <span class="token comment">// 网络管理权限</span></span>
<span class="line">    <span class="token string">&quot;CAP_SYS_MODULE&quot;</span><span class="token punctuation">,</span>      <span class="token comment">// 加载内核模块</span></span>
<span class="line">    <span class="token string">&quot;CAP_SYS_RAWIO&quot;</span><span class="token punctuation">,</span>       <span class="token comment">// 直接 I/O 访问</span></span>
<span class="line">    <span class="token string">&quot;CAP_SYS_PTRACE&quot;</span><span class="token punctuation">,</span>      <span class="token comment">// 调试其他进程</span></span>
<span class="line">    <span class="token string">&quot;CAP_SYS_NICE&quot;</span><span class="token punctuation">,</span>        <span class="token comment">// 修改进程优先级</span></span>
<span class="line">    <span class="token string">&quot;CAP_IPC_LOCK&quot;</span><span class="token punctuation">,</span>        <span class="token comment">// 锁定内存页</span></span>
<span class="line">    <span class="token string">&quot;CAP_SYS_RESOURCE&quot;</span><span class="token punctuation">,</span>    <span class="token comment">// 修改资源限制</span></span>
<span class="line">    <span class="token string">&quot;CAP_SYS_TTY_CONFIG&quot;</span><span class="token punctuation">,</span>  <span class="token comment">// 修改 TTY 配置</span></span>
<span class="line">    <span class="token string">&quot;CAP_LEASE&quot;</span><span class="token punctuation">,</span>           <span class="token comment">// 文件租约</span></span>
<span class="line">    <span class="token string">&quot;CAP_WAKE_ALARM&quot;</span><span class="token punctuation">,</span>      <span class="token comment">// 设置实时时钟警报</span></span>
<span class="line">    <span class="token string">&quot;CAP_BLOCK_SUSPEND&quot;</span><span class="token punctuation">,</span>   <span class="token comment">// 阻止系统休眠</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-seccomp-系统调用过滤" tabindex="-1"><a class="header-anchor" href="#_3-seccomp-系统调用过滤"><span>3. seccomp 系统调用过滤</span></a></h2><h3 id="_3-1-seccomp-基础原理" tabindex="-1"><a class="header-anchor" href="#_3-1-seccomp-基础原理"><span>3.1 seccomp 基础原理</span></a></h3><p><strong>seccomp (secure computing mode)</strong> 是 Linux 内核的安全机制，可以限制进程能够调用的系统调用。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">用户空间程序                    内核空间</span>
<span class="line">┌─────────────────┐            ┌─────────────────────┐</span>
<span class="line">│  应用程序       │            │                     │</span>
<span class="line">│  ┌───────────┐  │   系统调用  │  ┌─────────────────┐ │</span>
<span class="line">│  │  open()   │  │ ─────────→ │  │   seccomp BPF   │ │</span>
<span class="line">│  │  write()  │  │            │  │     过滤器       │ │</span>
<span class="line">│  │  exec()   │  │            │  └─────┬───────────┘ │</span>
<span class="line">│  └───────────┘  │            │        │             │</span>
<span class="line">└─────────────────┘            │        ▼             │</span>
<span class="line">                               │  ┌─────────────────┐ │</span>
<span class="line">                               │  │ ALLOW/DENY/TRAP │ │</span>
<span class="line">                               │  │ TRACE/LOG/ERRNO │ │</span>
<span class="line">                               │  └─────────────────┘ │</span>
<span class="line">                               └─────────────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-seccomp-配置结构" tabindex="-1"><a class="header-anchor" href="#_3-2-seccomp-配置结构"><span>3.2 seccomp 配置结构</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/configs/config.go:207</span></span>
<span class="line"><span class="token keyword">type</span> Seccomp <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 默认动作：对未匹配规则的系统调用执行的动作</span></span>
<span class="line">    DefaultAction    Action                   <span class="token string">`json:&quot;default_action&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 架构列表：限制在特定CPU架构上</span></span>
<span class="line">    Architectures    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>                 <span class="token string">`json:&quot;architectures&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 标志：seccomp的行为控制标志</span></span>
<span class="line">    Flags            <span class="token punctuation">[</span><span class="token punctuation">]</span>specs<span class="token punctuation">.</span>LinuxSeccompFlag <span class="token string">`json:&quot;flags&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 系统调用规则列表</span></span>
<span class="line">    Syscalls         <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Syscall               <span class="token string">`json:&quot;syscalls&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 默认错误返回值：当动作为ERRNO时返回的错误码</span></span>
<span class="line">    DefaultErrnoRet  <span class="token operator">*</span><span class="token builtin">uint</span>                    <span class="token string">`json:&quot;default_errno_ret&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 监听路径：用于 seccomp notify 机制</span></span>
<span class="line">    ListenerPath     <span class="token builtin">string</span>                   <span class="token string">`json:&quot;listener_path,omitempty&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 监听元数据：传递给监听器的额外信息</span></span>
<span class="line">    ListenerMetadata <span class="token builtin">string</span>                   <span class="token string">`json:&quot;listener_metadata,omitempty&quot;`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 系统调用规则</span></span>
<span class="line"><span class="token keyword">type</span> Syscall <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Name     <span class="token builtin">string</span> <span class="token string">`json:&quot;name&quot;`</span>          <span class="token comment">// 系统调用名称</span></span>
<span class="line">    Action   Action <span class="token string">`json:&quot;action&quot;`</span>        <span class="token comment">// 执行的动作</span></span>
<span class="line">    ErrnoRet <span class="token operator">*</span><span class="token builtin">uint</span>  <span class="token string">`json:&quot;errnoRet&quot;`</span>      <span class="token comment">// ERRNO动作的返回值</span></span>
<span class="line">    Args     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Arg <span class="token string">`json:&quot;args&quot;`</span>          <span class="token comment">// 参数过滤条件</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 参数过滤条件</span></span>
<span class="line"><span class="token keyword">type</span> Arg <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Index    <span class="token builtin">uint</span>     <span class="token string">`json:&quot;index&quot;`</span>    <span class="token comment">// 参数索引 (0-5)</span></span>
<span class="line">    Value    <span class="token builtin">uint64</span>   <span class="token string">`json:&quot;value&quot;`</span>    <span class="token comment">// 比较值</span></span>
<span class="line">    ValueTwo <span class="token operator">*</span><span class="token builtin">uint64</span>  <span class="token string">`json:&quot;valueTwo&quot;`</span> <span class="token comment">// 范围比较的第二个值</span></span>
<span class="line">    Op       Operator <span class="token string">`json:&quot;op&quot;`</span>       <span class="token comment">// 比较操作符</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-seccomp-动作类型" tabindex="-1"><a class="header-anchor" href="#_3-3-seccomp-动作类型"><span>3.3 seccomp 动作类型</span></a></h3><table><thead><tr><th>动作</th><th>描述</th><th>应用场景</th></tr></thead><tbody><tr><td><strong>KILL/KILL_THREAD</strong></td><td>终止进程/线程</td><td>绝对禁止的系统调用</td></tr><tr><td><strong>ERRNO</strong></td><td>返回错误码</td><td>优雅处理不允许的调用</td></tr><tr><td><strong>TRAP</strong></td><td>发送 SIGSYS 信号</td><td>调试和监控</td></tr><tr><td><strong>ALLOW</strong></td><td>允许执行</td><td>白名单模式</td></tr><tr><td><strong>TRACE</strong></td><td>跟踪执行</td><td>安全审计</td></tr><tr><td><strong>LOG</strong></td><td>记录日志</td><td>监控可疑调用</td></tr><tr><td><strong>NOTIFY</strong></td><td>通知用户空间</td><td>动态安全决策</td></tr></tbody></table><h3 id="_3-4-runc-中的-seccomp-实现" tabindex="-1"><a class="header-anchor" href="#_3-4-runc-中的-seccomp-实现"><span>3.4 runc 中的 seccomp 实现</span></a></h3><h4 id="过滤器初始化" tabindex="-1"><a class="header-anchor" href="#过滤器初始化"><span>过滤器初始化</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/seccomp/seccomp_linux.go:89</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">InitSeccomp</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Seccomp<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> config <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;cannot initialize Seccomp - nil config passed&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 创建 seccomp 过滤器上下文</span></span>
<span class="line">    filter<span class="token punctuation">,</span> err <span class="token operator">:=</span> libseccomp<span class="token punctuation">.</span><span class="token function">NewFilter</span><span class="token punctuation">(</span><span class="token function">seccompAction</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>DefaultAction<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to create seccomp filter: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> filter<span class="token punctuation">.</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置架构限制</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> arch <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Architectures <span class="token punctuation">{</span></span>
<span class="line">        scmpArch<span class="token punctuation">,</span> err <span class="token operator">:=</span> libseccomp<span class="token punctuation">.</span><span class="token function">GetArchFromString</span><span class="token punctuation">(</span>arch<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;invalid architecture %s: %w&quot;</span><span class="token punctuation">,</span> arch<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> filter<span class="token punctuation">.</span><span class="token function">AddArch</span><span class="token punctuation">(</span>scmpArch<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to add architecture %s: %w&quot;</span><span class="token punctuation">,</span> arch<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 添加系统调用规则</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> syscall <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Syscalls <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">addSyscallRule</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> syscall<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to add syscall rule for %s: %w&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                             syscall<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 应用 BPF 补丁优化</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> patchbpf<span class="token punctuation">.</span><span class="token function">PatchAndLoad</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to patch and load seccomp filter: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="系统调用规则添加" tabindex="-1"><a class="header-anchor" href="#系统调用规则添加"><span>系统调用规则添加</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">addSyscallRule</span><span class="token punctuation">(</span>filter <span class="token operator">*</span>libseccomp<span class="token punctuation">.</span>ScmpFilter<span class="token punctuation">,</span> syscall <span class="token operator">*</span>Syscall<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 获取系统调用号</span></span>
<span class="line">    scmpSyscall<span class="token punctuation">,</span> err <span class="token operator">:=</span> libseccomp<span class="token punctuation">.</span><span class="token function">GetSyscallFromName</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>Name<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 忽略未知的系统调用，提高兼容性</span></span>
<span class="line">        logrus<span class="token punctuation">.</span><span class="token function">WithError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span><span class="token string">&quot;Ignoring unknown syscall %s&quot;</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>Name<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 构建参数条件</span></span>
<span class="line">    <span class="token keyword">var</span> conditions <span class="token punctuation">[</span><span class="token punctuation">]</span>libseccomp<span class="token punctuation">.</span>ScmpCondition</span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> arg <span class="token operator">:=</span> <span class="token keyword">range</span> syscall<span class="token punctuation">.</span>Args <span class="token punctuation">{</span></span>
<span class="line">        condition <span class="token operator">:=</span> libseccomp<span class="token punctuation">.</span>ScmpCondition<span class="token punctuation">{</span></span>
<span class="line">            Argument<span class="token punctuation">:</span> arg<span class="token punctuation">.</span>Index<span class="token punctuation">,</span></span>
<span class="line">            Op<span class="token punctuation">:</span>       libseccomp<span class="token punctuation">.</span><span class="token function">ScmpCompareOp</span><span class="token punctuation">(</span>arg<span class="token punctuation">.</span>Op<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            Operand1<span class="token punctuation">:</span> arg<span class="token punctuation">.</span>Value<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 处理范围比较</span></span>
<span class="line">        <span class="token keyword">if</span> arg<span class="token punctuation">.</span>ValueTwo <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            condition<span class="token punctuation">.</span>Operand2 <span class="token operator">=</span> <span class="token operator">*</span>arg<span class="token punctuation">.</span>ValueTwo</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        conditions <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>conditions<span class="token punctuation">,</span> condition<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 添加规则到过滤器</span></span>
<span class="line">    action <span class="token operator">:=</span> <span class="token function">seccompAction</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>Action<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> filter<span class="token punctuation">.</span><span class="token function">AddRuleConditional</span><span class="token punctuation">(</span>scmpSyscall<span class="token punctuation">,</span> action<span class="token punctuation">,</span> conditions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to add conditional rule: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-5-bpf-补丁优化" tabindex="-1"><a class="header-anchor" href="#_3-5-bpf-补丁优化"><span>3.5 BPF 补丁优化</span></a></h3><p>runc 实现了 BPF 程序补丁机制来优化 seccomp 性能：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/seccomp/patchbpf/enosys_linux.go:45</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">PatchAndLoad</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Seccomp<span class="token punctuation">,</span> filter <span class="token operator">*</span>libseccomp<span class="token punctuation">.</span>ScmpFilter<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 生成 BPF 字节码</span></span>
<span class="line">    program<span class="token punctuation">,</span> err <span class="token operator">:=</span> filter<span class="token punctuation">.</span><span class="token function">ExportBPF</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 应用 ENOSYS 补丁：对未知系统调用返回 ENOSYS 而不是 kill</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">needsEnosysPatch</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        program<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">patchEnosys</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to patch BPF program: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 加载补丁后的 BPF 程序</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Prctl</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>PR_SET_SECCOMP<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>SECCOMP_MODE_FILTER<span class="token punctuation">,</span> </span>
<span class="line">                        <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>program<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to load seccomp filter: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">needsEnosysPatch</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Seccomp<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 当默认动作不是 ALLOW 且没有使用 notify 机制时需要补丁</span></span>
<span class="line">    <span class="token keyword">return</span> config<span class="token punctuation">.</span>DefaultAction <span class="token operator">!=</span> configs<span class="token punctuation">.</span>Kill <span class="token operator">&amp;&amp;</span> </span>
<span class="line">           config<span class="token punctuation">.</span>DefaultAction <span class="token operator">!=</span> configs<span class="token punctuation">.</span>KillThread <span class="token operator">&amp;&amp;</span></span>
<span class="line">           config<span class="token punctuation">.</span>ListenerPath <span class="token operator">==</span> <span class="token string">&quot;&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-6-高级特性-seccomp-notify" tabindex="-1"><a class="header-anchor" href="#_3-6-高级特性-seccomp-notify"><span>3.6 高级特性：seccomp notify</span></a></h3><p>seccomp notify 是较新的特性，允许用户空间程序动态处理系统调用：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 检查 notify 机制的限制</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">validateNotifyConfig</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Seccomp<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>ListenerPath <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// notify 机制需要 Linux 5.7+ 和 libseccomp 2.5.0+</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">isNotifySupported</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;seccomp notify requires Linux 5.7+ and libseccomp 2.5.0+&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// write 系统调用不能使用 notify (避免初始化死锁)</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> syscall <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Syscalls <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> syscall<span class="token punctuation">.</span>Name <span class="token operator">==</span> <span class="token string">&quot;write&quot;</span> <span class="token operator">&amp;&amp;</span> syscall<span class="token punctuation">.</span>Action <span class="token operator">==</span> configs<span class="token punctuation">.</span>Notify <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;write syscall cannot use notify action&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-7-默认-seccomp-策略" tabindex="-1"><a class="header-anchor" href="#_3-7-默认-seccomp-策略"><span>3.7 默认 seccomp 策略</span></a></h3><p>runc 提供了保守的默认 seccomp 配置：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 默认被阻止的危险系统调用</span></span>
<span class="line"><span class="token keyword">var</span> defaultBlockedSyscalls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 内核模块操作</span></span>
<span class="line">    <span class="token string">&quot;init_module&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;finit_module&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;delete_module&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 直接内存访问</span></span>
<span class="line">    <span class="token string">&quot;iopl&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ioperm&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 时间修改</span></span>
<span class="line">    <span class="token string">&quot;clock_settime&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;settimeofday&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;stime&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 挂载操作</span></span>
<span class="line">    <span class="token string">&quot;mount&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;umount2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;swapon&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;swapoff&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 系统控制</span></span>
<span class="line">    <span class="token string">&quot;reboot&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sethostname&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;setdomainname&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 进程跟踪</span></span>
<span class="line">    <span class="token string">&quot;ptrace&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 性能监控</span></span>
<span class="line">    <span class="token string">&quot;perf_event_open&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 容器逃逸相关</span></span>
<span class="line">    <span class="token string">&quot;unshare&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;clone&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;setns&quot;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 生成默认 seccomp 配置</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">DefaultProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>configs<span class="token punctuation">.</span>Seccomp <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>configs<span class="token punctuation">.</span>Seccomp<span class="token punctuation">{</span></span>
<span class="line">        DefaultAction<span class="token punctuation">:</span> configs<span class="token punctuation">.</span>Allow<span class="token punctuation">,</span>  <span class="token comment">// 默认允许</span></span>
<span class="line">        Architectures<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>runtime<span class="token punctuation">.</span>GOARCH<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        Syscalls<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>configs<span class="token punctuation">.</span>Syscall<span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 阻止危险系统调用</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                Names<span class="token punctuation">:</span>  defaultBlockedSyscalls<span class="token punctuation">,</span></span>
<span class="line">                Action<span class="token punctuation">:</span> configs<span class="token punctuation">.</span>Errno<span class="token punctuation">,</span></span>
<span class="line">                ErrnoRet<span class="token punctuation">:</span> <span class="token function">uint</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>EPERM<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// clone 系统调用特殊处理</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                Names<span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;clone&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                Action<span class="token punctuation">:</span> configs<span class="token punctuation">.</span>Allow<span class="token punctuation">,</span></span>
<span class="line">                Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>configs<span class="token punctuation">.</span>Arg<span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">// 只允许特定的 clone 标志</span></span>
<span class="line">                    <span class="token punctuation">{</span></span>
<span class="line">                        Index<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">                        Value<span class="token punctuation">:</span> unix<span class="token punctuation">.</span>CLONE_NEWNS<span class="token punctuation">,</span></span>
<span class="line">                        Op<span class="token punctuation">:</span>    configs<span class="token punctuation">.</span>OpMaskedEqual<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-apparmor-selinux-强制访问控制" tabindex="-1"><a class="header-anchor" href="#_4-apparmor-selinux-强制访问控制"><span>4. AppArmor/SELinux 强制访问控制</span></a></h2><h3 id="_4-1-mac-vs-dac" tabindex="-1"><a class="header-anchor" href="#_4-1-mac-vs-dac"><span>4.1 MAC vs DAC</span></a></h3><p><strong>DAC (Discretionary Access Control)</strong>：传统的 Unix 权限模型</p><ul><li>文件所有者可以决定访问权限</li><li>基于用户/组/其他的简单三元模型</li><li>容易被恶意程序绕过</li></ul><p><strong>MAC (Mandatory Access Control)</strong>：强制访问控制</p><ul><li>系统管理员设置的策略不能被绕过</li><li>基于安全标签和策略规则</li><li>提供更强的安全保护</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">DAC 模型:                      MAC 模型:</span>
<span class="line">┌─────────────────┐           ┌─────────────────────────────┐</span>
<span class="line">│  文件所有者     │   决定     │      系统管理员             │   制定</span>
<span class="line">│  设置权限       │  ────→    │      制定安全策略           │  ────→</span>
<span class="line">└─────────────────┘           └─────────────────────────────┘</span>
<span class="line">       │                                    │</span>
<span class="line">       ▼                                    ▼</span>
<span class="line">┌─────────────────┐           ┌─────────────────────────────┐</span>
<span class="line">│ rwx permissions │           │    AppArmor/SELinux 策略    │</span>
<span class="line">│ user:group:other│           │      不可被进程修改         │</span>
<span class="line">└─────────────────┘           └─────────────────────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-apparmor-集成" tabindex="-1"><a class="header-anchor" href="#_4-2-apparmor-集成"><span>4.2 AppArmor 集成</span></a></h3><h4 id="基础实现" tabindex="-1"><a class="header-anchor" href="#基础实现"><span>基础实现</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/apparmor/apparmor_linux.go:32</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">ApplyProfile</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> name <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 检查 AppArmor 是否可用</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">IsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;AppArmor is not enabled on this system&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 在 exec 时切换到指定的 profile</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">changeOnExec</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">IsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 检查 AppArmor 文件系统是否挂载</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span><span class="token string">&quot;/sys/kernel/security/apparmor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 检查当前进程是否在 AppArmor 控制下</span></span>
<span class="line">    data<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token string">&quot;/proc/self/attr/current&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 如果不是 &quot;unconfined&quot;，说明 AppArmor 已启用</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;unconfined&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">changeOnExec</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 写入 exec 属性文件，在下次 exec 时切换 profile</span></span>
<span class="line">    attrPath <span class="token operator">:=</span> <span class="token string">&quot;/proc/self/attr/exec&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 尝试新版路径</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span><span class="token string">&quot;/proc/self/attr/apparmor/exec&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        attrPath <span class="token operator">=</span> <span class="token string">&quot;/proc/self/attr/apparmor/exec&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span>attrPath<span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_WRONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to open AppArmor exec attr: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 写入 profile 名称，格式为 &quot;exec profilename&quot;</span></span>
<span class="line">    profileSpec <span class="token operator">:=</span> <span class="token string">&quot;exec &quot;</span> <span class="token operator">+</span> name</span>
<span class="line">    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> file<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>profileSpec<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set AppArmor profile %s: %w&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="容器-apparmor-profile-示例" tabindex="-1"><a class="header-anchor" href="#容器-apparmor-profile-示例"><span>容器 AppArmor Profile 示例</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># /etc/apparmor.d/docker-default</span></span>
<span class="line"><span class="token comment">#include &lt;tunables/global&gt;</span></span>
<span class="line"></span>
<span class="line">profile docker-default <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token punctuation">(</span>attach_disconnected,mediate_deleted<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment"># 网络访问</span></span>
<span class="line">  network inet tcp,</span>
<span class="line">  network inet udp,</span>
<span class="line">  network inet icmp,</span>
<span class="line">  </span>
<span class="line">  <span class="token comment"># 文件系统访问</span></span>
<span class="line">  file,</span>
<span class="line">  / r,</span>
<span class="line">  /etc/ r,</span>
<span class="line">  /etc/** r,</span>
<span class="line">  /lib/ r,</span>
<span class="line">  /lib/** r,</span>
<span class="line">  /usr/ r,</span>
<span class="line">  /usr/** r,</span>
<span class="line">  </span>
<span class="line">  <span class="token comment"># 禁止访问敏感路径</span></span>
<span class="line">  deny /sys/firmware/efi/efivars/ wl,</span>
<span class="line">  deny /sys/kernel/security/ wl,</span>
<span class="line">  deny /proc/sys/kernel/core_pattern wl,</span>
<span class="line">  deny /proc/kcore r,</span>
<span class="line">  deny /proc/kallsyms r,</span>
<span class="line">  </span>
<span class="line">  <span class="token comment"># 允许的系统调用</span></span>
<span class="line">  capability chown,</span>
<span class="line">  capability dac_override,</span>
<span class="line">  capability setuid,</span>
<span class="line">  capability setgid,</span>
<span class="line">  capability net_bind_service,</span>
<span class="line">  </span>
<span class="line">  <span class="token comment"># 禁止的危险操作</span></span>
<span class="line">  deny capability sys_admin,</span>
<span class="line">  deny capability sys_time,</span>
<span class="line">  deny capability sys_module,</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-selinux-集成" tabindex="-1"><a class="header-anchor" href="#_4-3-selinux-集成"><span>4.3 SELinux 集成</span></a></h3><h4 id="标签设置" tabindex="-1"><a class="header-anchor" href="#标签设置"><span>标签设置</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// SELinux 标签应用</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">ApplySELinuxLabels</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span>selinux<span class="token punctuation">.</span><span class="token function">GetEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置进程执行标签</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>ProcessLabel <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> selinux<span class="token punctuation">.</span><span class="token function">SetExecLabel</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>ProcessLabel<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set SELinux exec label: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置密钥环标签</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>ProcessLabel <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> selinux<span class="token punctuation">.</span><span class="token function">SetKeyLabel</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>ProcessLabel<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set SELinux key label: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="挂载标签处理" tabindex="-1"><a class="header-anchor" href="#挂载标签处理"><span>挂载标签处理</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 文件系统挂载时应用 SELinux 标签</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">formatMountLabel</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> mountLabel <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> mountLabel <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 格式化挂载标签</span></span>
<span class="line">    <span class="token keyword">switch</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>mountLabel<span class="token punctuation">,</span> <span class="token string">&quot;context=&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> mountLabel</span>
<span class="line">    <span class="token keyword">default</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;context=%s&quot;</span><span class="token punctuation">,</span> mountLabel<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="selinux-策略示例" tabindex="-1"><a class="header-anchor" href="#selinux-策略示例"><span>SELinux 策略示例</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># container.te - 容器 SELinux 策略示例</span></span>
<span class="line">policy_module<span class="token punctuation">(</span>container, <span class="token number">1.0</span>.0<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 容器域定义</span></span>
<span class="line"><span class="token builtin class-name">type</span> container_t<span class="token punctuation">;</span></span>
<span class="line"><span class="token builtin class-name">type</span> container_exec_t<span class="token punctuation">;</span></span>
<span class="line">domain_type<span class="token punctuation">(</span>container_t<span class="token punctuation">)</span></span>
<span class="line">domain_entry_file<span class="token punctuation">(</span>container_t, container_exec_t<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 容器文件类型</span></span>
<span class="line"><span class="token builtin class-name">type</span> container_file_t<span class="token punctuation">;</span></span>
<span class="line">files_type<span class="token punctuation">(</span>container_file_t<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 允许容器域的基本操作</span></span>
<span class="line">allow container_t self:process <span class="token punctuation">{</span> fork signal_perms <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">allow container_t self:fifo_file rw_fifo_file_perms<span class="token punctuation">;</span></span>
<span class="line">allow container_t self:unix_stream_socket create_stream_socket_perms<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 允许访问容器文件</span></span>
<span class="line">allow container_t container_file_t:dir list_dir_perms<span class="token punctuation">;</span></span>
<span class="line">allow container_t container_file_t:file read_file_perms<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 禁止访问敏感资源</span></span>
<span class="line">neverallow container_t kernel_t:system module_load<span class="token punctuation">;</span></span>
<span class="line">neverallow container_t sysctl_t:file <span class="token function">write</span><span class="token punctuation">;</span></span>
<span class="line">neverallow container_t device_t:chr_file <span class="token function">write</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-用户命名空间权限映射" tabindex="-1"><a class="header-anchor" href="#_5-用户命名空间权限映射"><span>5. 用户命名空间权限映射</span></a></h2><h3 id="_5-1-id-映射机制" tabindex="-1"><a class="header-anchor" href="#_5-1-id-映射机制"><span>5.1 ID 映射机制</span></a></h3><p>用户命名空间允许容器内的 UID/GID 映射到宿主机的不同 UID/GID：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">容器内视图:        映射关系:           宿主机视图:</span>
<span class="line">UID 0 (root)  ←─→  UID 1000 (user)    UID 1000 (普通用户)</span>
<span class="line">UID 1         ←─→  UID 1001           UID 1001</span>
<span class="line">UID 2         ←─→  UID 1002           UID 1002</span>
<span class="line">...           ←─→  ...                ...</span>
<span class="line">UID 65535     ←─→  UID 66535          UID 66535</span>
<span class="line"></span>
<span class="line">映射配置:</span>
<span class="line">容器ID: 0,  宿主ID: 1000, 范围: 65536</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-id-映射配置" tabindex="-1"><a class="header-anchor" href="#_5-2-id-映射配置"><span>5.2 ID 映射配置</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/configs/config.go:85</span></span>
<span class="line"><span class="token keyword">type</span> IDMap <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    ContainerID <span class="token builtin">int64</span> <span class="token string">`json:&quot;container_id&quot;`</span>  <span class="token comment">// 容器内起始 ID</span></span>
<span class="line">    HostID      <span class="token builtin">int64</span> <span class="token string">`json:&quot;host_id&quot;`</span>       <span class="token comment">// 宿主机起始 ID  </span></span>
<span class="line">    Size        <span class="token builtin">int64</span> <span class="token string">`json:&quot;size&quot;`</span>          <span class="token comment">// 映射范围大小</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 用户映射获取</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">GetUserNamespaceMappings</span><span class="token punctuation">(</span>nsPath <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>IDMap<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>IDMap<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 快速路径：直接读取映射文件</span></span>
<span class="line">    uidMaps<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">readMappingFile</span><span class="token punctuation">(</span>nsPath<span class="token punctuation">,</span> <span class="token string">&quot;uid_map&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        gidMaps<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">readMappingFile</span><span class="token punctuation">(</span>nsPath<span class="token punctuation">,</span> <span class="token string">&quot;gid_map&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> uidMaps<span class="token punctuation">,</span> gidMaps<span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 慢速路径：使用 C 代码在用户命名空间内读取</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">readMappingsWithC</span><span class="token punctuation">(</span>nsPath<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-映射文件读取" tabindex="-1"><a class="header-anchor" href="#_5-3-映射文件读取"><span>5.3 映射文件读取</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/internal/userns/userns_maps_linux.go:89</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">readMappingFile</span><span class="token punctuation">(</span>nsPath<span class="token punctuation">,</span> mapType <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>IDMap<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    mapPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">&quot;/proc&quot;</span><span class="token punctuation">,</span> <span class="token function">extractPid</span><span class="token punctuation">(</span>nsPath<span class="token punctuation">)</span><span class="token punctuation">,</span> mapType<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    data<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>mapPath<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">var</span> mappings <span class="token punctuation">[</span><span class="token punctuation">]</span>IDMap</span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> line <span class="token operator">:=</span> <span class="token keyword">range</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        line <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> line <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">continue</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 解析格式: &quot;容器ID 宿主ID 范围大小&quot;</span></span>
<span class="line">        parts <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Fields</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">3</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">continue</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        containerID<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span></span>
<span class="line">        hostID<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span></span>
<span class="line">        size<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        mappings <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>mappings<span class="token punctuation">,</span> IDMap<span class="token punctuation">{</span></span>
<span class="line">            ContainerID<span class="token punctuation">:</span> containerID<span class="token punctuation">,</span></span>
<span class="line">            HostID<span class="token punctuation">:</span>      hostID<span class="token punctuation">,</span></span>
<span class="line">            Size<span class="token punctuation">:</span>        size<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> mappings<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-c-代码映射读取" tabindex="-1"><a class="header-anchor" href="#_5-4-c-代码映射读取"><span>5.4 C 代码映射读取</span></a></h3><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// libcontainer/internal/userns/userns_maps_linux.c:45</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">spawn_userns_cat</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ns_path<span class="token punctuation">,</span> <span class="token keyword">int</span> output_fd<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span> ns_fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> file_fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 打开用户命名空间文件描述符</span></span>
<span class="line">    ns_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>ns_path<span class="token punctuation">,</span> O_RDONLY <span class="token operator">|</span> O_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ns_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">goto</span> error<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// fork 子进程</span></span>
<span class="line">    <span class="token class-name">pid_t</span> child <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 子进程：进入用户命名空间</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setns</span><span class="token punctuation">(</span>ns_fd<span class="token punctuation">,</span> CLONE_NEWUSER<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">goto</span> error<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 在用户命名空间内打开映射文件</span></span>
<span class="line">        file_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> O_RDONLY <span class="token operator">|</span> O_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>file_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">goto</span> error<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 复制文件内容到输出管道</span></span>
<span class="line">        <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">ssize_t</span> bytes<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bytes <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>output_fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span> <span class="token operator">!=</span> bytes<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">goto</span> error<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">close</span><span class="token punctuation">(</span>ns_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">    error<span class="token operator">:</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>file_fd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>ns_fd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">close</span><span class="token punctuation">(</span>ns_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 父进程：等待子进程完成</span></span>
<span class="line">        <span class="token keyword">int</span> status<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">waitpid</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!=</span> child<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// fork 失败</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-5-rootless-容器安全模型" tabindex="-1"><a class="header-anchor" href="#_5-5-rootless-容器安全模型"><span>5.5 Rootless 容器安全模型</span></a></h3><p>Rootless 容器使用用户命名空间实现无特权运行：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># rootless 容器的典型映射配置</span></span>
<span class="line">$ <span class="token function">cat</span> /proc/self/uid_map</span>
<span class="line">         <span class="token number">0</span>       <span class="token number">1000</span>          <span class="token number">1</span>      <span class="token comment"># 容器root → 宿主普通用户</span></span>
<span class="line">         <span class="token number">1</span>     <span class="token number">100000</span>      <span class="token number">65536</span>      <span class="token comment"># 其他ID → 子ID范围</span></span>
<span class="line"></span>
<span class="line">$ <span class="token function">cat</span> /proc/self/gid_map  </span>
<span class="line">         <span class="token number">0</span>       <span class="token number">1000</span>          <span class="token number">1</span>      <span class="token comment"># 容器root组 → 宿主普通组</span></span>
<span class="line">         <span class="token number">1</span>     <span class="token number">100000</span>      <span class="token number">65536</span>      <span class="token comment"># 其他组 → 子组范围</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检查子ID配置</span></span>
<span class="line">$ <span class="token function">cat</span> /etc/subuid</span>
<span class="line">user:100000:65536</span>
<span class="line"></span>
<span class="line">$ <span class="token function">cat</span> /etc/subgid  </span>
<span class="line">user:100000:65536</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Rootless 安全优势</strong>：</p><ul><li>🚫 <strong>无需特权</strong>: 不需要 root 权限启动容器</li><li>🔒 <strong>权限隔离</strong>: 容器内 root 权限被限制在用户命名空间内</li><li>🛡️ <strong>攻击面缩小</strong>: 减少了特权升级的攻击面</li></ul><h2 id="_6-安全策略配置和应用" tabindex="-1"><a class="header-anchor" href="#_6-安全策略配置和应用"><span>6. 安全策略配置和应用</span></a></h2><h3 id="_6-1-安全配置验证" tabindex="-1"><a class="header-anchor" href="#_6-1-安全配置验证"><span>6.1 安全配置验证</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/configs/validate/security.go:15</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">security</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 检查 MaskPaths/ReadonlyPaths 需要私有 mount namespace</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>MaskPaths<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>ReadonlyPaths<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></span>
<span class="line">        <span class="token operator">!</span>config<span class="token punctuation">.</span>Namespaces<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>configs<span class="token punctuation">.</span>NEWNS<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;cannot restrict paths without private mount namespace&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 检查 SELinux 配置</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>ProcessLabel <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>selinux<span class="token punctuation">.</span><span class="token function">GetEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;SELinux label specified but SELinux disabled&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 检查 AppArmor 配置</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>AppArmorProfile <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>apparmor<span class="token punctuation">.</span><span class="token function">IsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;AppArmor profile specified but AppArmor disabled&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 检查 seccomp 配置</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>Seccomp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">validateSeccompConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Seccomp<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;invalid seccomp config: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-安全策略应用流程" tabindex="-1"><a class="header-anchor" href="#_6-2-安全策略应用流程"><span>6.2 安全策略应用流程</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/standard_init_linux.go:200</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">finalizeNamespace</span><span class="token punctuation">(</span>config <span class="token operator">*</span>initConfig<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 应用 AppArmor profile</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> apparmor<span class="token punctuation">.</span><span class="token function">ApplyProfile</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>AppArmorProfile<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to apply AppArmor profile: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 设置 SELinux 标签</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> selinux<span class="token punctuation">.</span><span class="token function">SetExecLabel</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>ProcessLabel<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set SELinux label: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 应用文件系统限制</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">applyPathRestrictions</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to apply path restrictions: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. 设置 no_new_privs 位</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>NoNewPrivileges <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Prctl</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>PR_SET_NO_NEW_PRIVS<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set no_new_privs: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 5. 应用 Linux capabilities</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> capabilities<span class="token punctuation">.</span><span class="token function">ApplyCapabilities</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Capabilities<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to apply capabilities: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 6. 初始化 seccomp 过滤器</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>Seccomp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> seccomp<span class="token punctuation">.</span><span class="token function">InitSeccomp</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Seccomp<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to initialize seccomp: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-路径限制实现" tabindex="-1"><a class="header-anchor" href="#_6-3-路径限制实现"><span>6.3 路径限制实现</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 应用敏感路径的访问限制</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">applyPathRestrictions</span><span class="token punctuation">(</span>config <span class="token operator">*</span>initConfig<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 屏蔽敏感路径 (用 tmpfs 覆盖)</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> path <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>MaskPaths <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">maskPath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Readonlyfs<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置只读路径</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> path <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>ReadonlyPaths <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">readonlyPath</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">maskPath</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> readonly <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 使用 tmpfs 挂载来屏蔽敏感路径</span></span>
<span class="line">    flags <span class="token operator">:=</span> unix<span class="token punctuation">.</span>MS_RDONLY</span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span>readonly <span class="token punctuation">{</span></span>
<span class="line">        flags <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&quot;tmpfs&quot;</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> <span class="token string">&quot;tmpfs&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                   <span class="token function">uintptr</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 如果挂载失败，尝试创建空文件覆盖</span></span>
<span class="line">        <span class="token keyword">if</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">createEmptyFile</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">readonlyPath</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 绑定挂载后重新挂载为只读</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mount</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> path<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_BIND<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span>  <span class="token comment">// 路径不存在，忽略</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">mount</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> path<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                unix<span class="token punctuation">.</span>MS_BIND<span class="token operator">|</span>unix<span class="token punctuation">.</span>MS_REMOUNT<span class="token operator">|</span>unix<span class="token punctuation">.</span>MS_RDONLY<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-实践练习" tabindex="-1"><a class="header-anchor" href="#_7-实践练习"><span>7. 实践练习</span></a></h2><h3 id="_7-1-capabilities-实验" tabindex="-1"><a class="header-anchor" href="#_7-1-capabilities-实验"><span>7.1 Capabilities 实验</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># 实验 1: 理解 capabilities 的作用</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检查当前进程的 capabilities</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;=== Current Process Capabilities ===&quot;</span></span>
<span class="line"><span class="token function">cat</span> /proc/self/status <span class="token operator">|</span> <span class="token function">grep</span> Cap</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 使用 capsh 分析 capabilities</span></span>
<span class="line">capsh <span class="token parameter variable">--decode</span><span class="token operator">=</span>0x00000000a80425fb</span>
<span class="line">capsh <span class="token parameter variable">--print</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 测试网络权限</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;=== Testing Network Capabilities ===&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 创建一个没有 CAP_NET_ADMIN 的进程</span></span>
<span class="line">capsh <span class="token parameter variable">--drop</span><span class="token operator">=</span>cap_net_admin <span class="token parameter variable">--print</span> <span class="token operator">&amp;</span></span>
<span class="line"><span class="token assign-left variable">PID</span><span class="token operator">=</span><span class="token variable">$!</span></span>
<span class="line"><span class="token function">sleep</span> <span class="token number">1</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 尝试修改网络配置 (应该失败)</span></span>
<span class="line">nsenter <span class="token parameter variable">-t</span> <span class="token variable">$PID</span> <span class="token parameter variable">-n</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> lo down <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;Permission denied (expected)&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 创建有 CAP_NET_BIND_SERVICE 的进程测试特权端口</span></span>
<span class="line">python3 <span class="token parameter variable">-c</span> <span class="token string">&quot;</span>
<span class="line">import socket</span>
<span class="line">try:</span>
<span class="line">    s = socket.socket()</span>
<span class="line">    s.bind<span class="token variable"><span class="token punctuation">((</span>&#39;&#39;<span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">))</span></span>  # 特权端口</span>
<span class="line">    print(&#39;Successfully bound to port 80&#39;)</span>
<span class="line">    s.close()</span>
<span class="line">except PermissionError:</span>
<span class="line">    print(&#39;Cannot bind to privileged port (expected without CAP_NET_BIND_SERVICE)&#39;)</span>
<span class="line">&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-seccomp-过滤实验" tabindex="-1"><a class="header-anchor" href="#_7-2-seccomp-过滤实验"><span>7.2 seccomp 过滤实验</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 实验 2: seccomp 系统调用过滤</span></span>
<span class="line"><span class="token keyword">package</span> main</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;fmt&quot;</span></span>
<span class="line">    <span class="token string">&quot;os&quot;</span></span>
<span class="line">    <span class="token string">&quot;syscall&quot;</span></span>
<span class="line">    <span class="token string">&quot;unsafe&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token string">&quot;golang.org/x/sys/unix&quot;</span></span>
<span class="line">    <span class="token string">&quot;github.com/seccomp/libseccomp-golang&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 创建 seccomp 过滤器</span></span>
<span class="line">    filter<span class="token punctuation">,</span> err <span class="token operator">:=</span> seccomp<span class="token punctuation">.</span><span class="token function">NewFilter</span><span class="token punctuation">(</span>seccomp<span class="token punctuation">.</span>ActAllow<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> filter<span class="token punctuation">.</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 禁止 mkdir 系统调用</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> filter<span class="token punctuation">.</span><span class="token function">AddRule</span><span class="token punctuation">(</span>seccomp<span class="token punctuation">.</span><span class="token function">ScmpSyscall</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>SYS_MKDIR<span class="token punctuation">)</span><span class="token punctuation">,</span> </span>
<span class="line">                            seccomp<span class="token punctuation">.</span>ActErrno<span class="token punctuation">.</span><span class="token function">SetReturnCode</span><span class="token punctuation">(</span><span class="token function">int16</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>EPERM<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 加载过滤器</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> filter<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;seccomp filter loaded&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 测试被禁止的系统调用</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Mkdir</span><span class="token punctuation">(</span><span class="token string">&quot;/tmp/test-mkdir&quot;</span><span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;mkdir failed as expected: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;ERROR: mkdir should have been blocked!&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 测试允许的系统调用</span></span>
<span class="line">    <span class="token keyword">if</span> file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token string">&quot;/tmp/test-create&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;file creation allowed&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        os<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span><span class="token string">&quot;/tmp/test-create&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-3-apparmor-profile-测试" tabindex="-1"><a class="header-anchor" href="#_7-3-apparmor-profile-测试"><span>7.3 AppArmor Profile 测试</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># 实验 3: AppArmor profile 约束测试</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检查 AppArmor 状态</span></span>
<span class="line"><span class="token function">sudo</span> aa-status</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 创建测试 profile</span></span>
<span class="line"><span class="token function">sudo</span> <span class="token function">tee</span> /etc/apparmor.d/test-container <span class="token operator">&gt;</span> /dev/null <span class="token operator">&lt;&lt;</span> <span class="token string">&#39;EOF&#39;</span>
<span class="line">#include &lt;tunables/global&gt;</span>
<span class="line"></span>
<span class="line">profile test-container flags=(attach_disconnected) {</span>
<span class="line">  #include &lt;abstractions/base&gt;</span>
<span class="line">  </span>
<span class="line">  # 允许基本文件访问</span>
<span class="line">  / r,</span>
<span class="line">  /bin/** ix,</span>
<span class="line">  /lib/** ix,</span>
<span class="line">  /usr/bin/** ix,</span>
<span class="line">  /tmp/** rw,</span>
<span class="line">  </span>
<span class="line">  # 禁止访问敏感文件</span>
<span class="line">  deny /etc/shadow r,</span>
<span class="line">  deny /proc/*/mem r,</span>
<span class="line">  deny /sys/kernel/security/** rw,</span>
<span class="line">  </span>
<span class="line">  # 允许网络</span>
<span class="line">  network inet tcp,</span>
<span class="line">  network inet udp,</span>
<span class="line">  </span>
<span class="line">  # 禁止某些 capabilities</span>
<span class="line">  deny capability sys_admin,</span>
<span class="line">  deny capability sys_time,</span>
<span class="line">}</span>
<span class="line">EOF</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 加载 profile</span></span>
<span class="line"><span class="token function">sudo</span> apparmor_parser <span class="token parameter variable">-r</span> /etc/apparmor.d/test-container</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 测试 profile 约束</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;=== Testing AppArmor Profile Constraints ===&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 在 profile 约束下运行命令</span></span>
<span class="line"><span class="token function">sudo</span> aa-exec <span class="token parameter variable">-p</span> test-container /bin/bash <span class="token parameter variable">-c</span> <span class="token string">&#39;</span>
<span class="line">echo &quot;Running under AppArmor profile: $(cat /proc/self/attr/current)&quot;</span>
<span class="line"></span>
<span class="line"># 允许的操作</span>
<span class="line">echo &quot;test&quot; &gt; /tmp/allowed.txt</span>
<span class="line">cat /tmp/allowed.txt</span>
<span class="line"></span>
<span class="line"># 被禁止的操作</span>
<span class="line">echo &quot;Trying to read /etc/shadow:&quot;</span>
<span class="line">cat /etc/shadow 2&gt;&amp;1 || echo &quot;Access denied (expected)&quot;</span>
<span class="line"></span>
<span class="line">echo &quot;Trying to read /proc/1/mem:&quot;</span>
<span class="line">head -c 10 /proc/1/mem 2&gt;&amp;1 || echo &quot;Access denied (expected)&quot;</span>
<span class="line">&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 清理</span></span>
<span class="line"><span class="token function">sudo</span> <span class="token function">rm</span> /tmp/allowed.txt</span>
<span class="line"><span class="token function">sudo</span> apparmor_parser <span class="token parameter variable">-R</span> /etc/apparmor.d/test-container</span>
<span class="line"><span class="token function">sudo</span> <span class="token function">rm</span> /etc/apparmor.d/test-container</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-4-用户命名空间映射实验" tabindex="-1"><a class="header-anchor" href="#_7-4-用户命名空间映射实验"><span>7.4 用户命名空间映射实验</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># 实验 4: 用户命名空间权限映射</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;=== User Namespace ID Mapping Test ===&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检查当前 UID/GID</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;Current UID/GID outside namespace: <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span><span class="token variable">)</span></span>&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 创建用户命名空间并设置映射</span></span>
<span class="line">unshare <span class="token parameter variable">--user</span> --map-root-user /bin/bash <span class="token parameter variable">-c</span> <span class="token string">&#39;</span>
<span class="line">echo &quot;=== Inside User Namespace ===&quot;</span>
<span class="line">echo &quot;UID/GID inside namespace: $(id)&quot;</span>
<span class="line">echo</span>
<span class="line"></span>
<span class="line"># 检查映射文件</span>
<span class="line">echo &quot;UID mapping:&quot;</span>
<span class="line">cat /proc/self/uid_map</span>
<span class="line"></span>
<span class="line">echo &quot;GID mapping:&quot;  </span>
<span class="line">cat /proc/self/gid_map</span>
<span class="line"></span>
<span class="line"># 测试文件权限</span>
<span class="line">echo &quot;=== File Permission Test ===&quot;</span>
<span class="line">echo &quot;Creating file as root inside namespace...&quot;</span>
<span class="line">touch /tmp/userns-test-file</span>
<span class="line">ls -la /tmp/userns-test-file</span>
<span class="line"></span>
<span class="line">echo &quot;File ownership as seen from namespace:&quot;</span>
<span class="line">stat -c &quot;UID: %u, GID: %g&quot; /tmp/userns-test-file</span>
<span class="line">&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;=== Outside Namespace View ===&quot;</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;File ownership as seen from host:&quot;</span></span>
<span class="line"><span class="token function">stat</span> <span class="token parameter variable">-c</span> <span class="token string">&quot;UID: %u, GID: %g&quot;</span> /tmp/userns-test-file <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;File not accessible&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 清理</span></span>
<span class="line"><span class="token function">rm</span> <span class="token parameter variable">-f</span> /tmp/userns-test-file</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-安全最佳实践" tabindex="-1"><a class="header-anchor" href="#_8-安全最佳实践"><span>8. 安全最佳实践</span></a></h2><h3 id="_8-1-安全配置检查清单" tabindex="-1"><a class="header-anchor" href="#_8-1-安全配置检查清单"><span>8.1 安全配置检查清单</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># 容器安全配置检查脚本</span></span>
<span class="line"></span>
<span class="line"><span class="token function-name function">check_security_config</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin class-name">local</span> <span class="token assign-left variable">config_file</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$1</span>&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;=== Container Security Configuration Audit ===&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 检查 capabilities</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;1. Checking Capabilities:&quot;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token string">&#39;&quot;bounding&quot;.*&quot;CAP_SYS_ADMIN&quot;&#39;</span> <span class="token string">&quot;<span class="token variable">$config_file</span>&quot;</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  ⚠️  WARNING: CAP_SYS_ADMIN granted (high risk)&quot;</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  ✅ CAP_SYS_ADMIN not granted&quot;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token string">&#39;&quot;bounding&quot;.*&quot;CAP_SYS_MODULE&quot;&#39;</span> <span class="token string">&quot;<span class="token variable">$config_file</span>&quot;</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  ❌ CRITICAL: CAP_SYS_MODULE granted (kernel module loading)&quot;</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  ✅ CAP_SYS_MODULE not granted&quot;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 检查 seccomp</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;2. Checking seccomp:&quot;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token string">&#39;&quot;defaultAction&quot;:&quot;SCMP_ACT_ALLOW&quot;&#39;</span> <span class="token string">&quot;<span class="token variable">$config_file</span>&quot;</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  ⚠️  WARNING: Default seccomp action is ALLOW&quot;</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  ✅ Restrictive seccomp policy&quot;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 检查只读根文件系统</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;3. Checking root filesystem:&quot;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token string">&#39;&quot;readonly&quot;:true&#39;</span> <span class="token string">&quot;<span class="token variable">$config_file</span>&quot;</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  ✅ Root filesystem is read-only&quot;</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  ⚠️  WARNING: Root filesystem is writable&quot;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 检查特权模式</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;4. Checking privileged mode:&quot;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token string">&#39;&quot;privileged&quot;:true&#39;</span> <span class="token string">&quot;<span class="token variable">$config_file</span>&quot;</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  ❌ CRITICAL: Container running in privileged mode&quot;</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  ✅ Container not privileged&quot;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 检查用户命名空间</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;5. Checking user namespace:&quot;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token string">&#39;&quot;type&quot;:&quot;user&quot;&#39;</span> <span class="token string">&quot;<span class="token variable">$config_file</span>&quot;</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  ✅ User namespace enabled&quot;</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  ⚠️  WARNING: User namespace not enabled&quot;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 使用示例</span></span>
<span class="line"><span class="token comment"># check_security_config config.json</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-安全策略模板" tabindex="-1"><a class="header-anchor" href="#_8-2-安全策略模板"><span>8.2 安全策略模板</span></a></h3><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;ociVersion&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.2&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;process&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;user&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;uid&quot;</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;gid&quot;</span><span class="token operator">:</span> <span class="token number">1000</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/app/server&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;capabilities&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;bounding&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token string">&quot;CAP_CHOWN&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;CAP_SETGID&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">        <span class="token string">&quot;CAP_SETUID&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;CAP_NET_BIND_SERVICE&quot;</span></span>
<span class="line">      <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;effective&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token string">&quot;CAP_CHOWN&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;CAP_SETGID&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;CAP_SETUID&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">        <span class="token string">&quot;CAP_NET_BIND_SERVICE&quot;</span></span>
<span class="line">      <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;permitted&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token string">&quot;CAP_CHOWN&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;CAP_SETGID&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;CAP_SETUID&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;CAP_NET_BIND_SERVICE&quot;</span></span>
<span class="line">      <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;noNewPrivileges&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;root&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rootfs&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;readonly&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;linux&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;namespaces&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pid&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;network&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mount&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;uts&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ipc&quot;</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;uidMappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;containerID&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;hostID&quot;</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">1</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;gidMappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;containerID&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;hostID&quot;</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span> </span>
<span class="line">        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">1</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;seccomp&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;defaultAction&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SCMP_ACT_ERRNO&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;architectures&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;SCMP_ARCH_X86_64&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;syscalls&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">&quot;names&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">            <span class="token string">&quot;read&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;write&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;open&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;stat&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;fstat&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;lstat&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;poll&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;lseek&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mmap&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mprotect&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;munmap&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;brk&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rt_sigaction&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rt_sigprocmask&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;access&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pipe&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;select&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sched_yield&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;mremap&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;msync&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mincore&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;madvise&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;dup&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dup2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pause&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;nanosleep&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;getitimer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;alarm&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;setitimer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;getpid&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;sendfile&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;socket&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;connect&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;accept&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;sendto&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;recvfrom&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sendmsg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;recvmsg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;shutdown&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bind&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;listen&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;getsockname&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;getpeername&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;socketpair&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;setsockopt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;getsockopt&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;clone&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;fork&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;vfork&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;execve&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;exit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;wait4&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;kill&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;uname&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;fcntl&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;flock&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;fsync&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;fdatasync&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;truncate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ftruncate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;getdents&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;getcwd&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;chdir&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;fchdir&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rename&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mkdir&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;rmdir&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;creat&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;link&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;unlink&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;symlink&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;readlink&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;chmod&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;fchmod&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;chown&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;fchown&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;lchown&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;umask&quot;</span></span>
<span class="line">          <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">&quot;action&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SCMP_ACT_ALLOW&quot;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;maskedPaths&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token string">&quot;/proc/acpi&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;/proc/asound&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">      <span class="token string">&quot;/proc/kcore&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;/proc/keys&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;/proc/latency_stats&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;/proc/timer_list&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;/proc/timer_stats&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;/proc/sched_debug&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;/sys/firmware&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;/sys/fs/cgroup&quot;</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;readonlyPaths&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token string">&quot;/proc/bus&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;/proc/fs&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">      <span class="token string">&quot;/proc/irq&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;/proc/sys&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;/proc/sysrq-trigger&quot;</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-3-安全监控和审计" tabindex="-1"><a class="header-anchor" href="#_8-3-安全监控和审计"><span>8.3 安全监控和审计</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 安全事件监控示例</span></span>
<span class="line"><span class="token keyword">package</span> main</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;log&quot;</span></span>
<span class="line">    <span class="token string">&quot;os&quot;</span></span>
<span class="line">    <span class="token string">&quot;os/signal&quot;</span></span>
<span class="line">    <span class="token string">&quot;syscall&quot;</span></span>
<span class="line">    <span class="token string">&quot;time&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> SecurityMonitor <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    events <span class="token keyword">chan</span> SecurityEvent</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> SecurityEvent <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Type      <span class="token builtin">string</span></span>
<span class="line">    Message   <span class="token builtin">string</span></span>
<span class="line">    Timestamp time<span class="token punctuation">.</span>Time</span>
<span class="line">    Severity  <span class="token builtin">string</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>sm <span class="token operator">*</span>SecurityMonitor<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">go</span> sm<span class="token punctuation">.</span><span class="token function">monitorCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">go</span> sm<span class="token punctuation">.</span><span class="token function">monitorSeccomp</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">go</span> sm<span class="token punctuation">.</span><span class="token function">monitorAppArmor</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">go</span> sm<span class="token punctuation">.</span><span class="token function">logEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>sm <span class="token operator">*</span>SecurityMonitor<span class="token punctuation">)</span> <span class="token function">monitorCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 监控 capabilities 变化</span></span>
<span class="line">    ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> ticker<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token keyword">range</span> ticker<span class="token punctuation">.</span>C <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 检查当前进程的 capabilities</span></span>
<span class="line">        caps<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getCurrentCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">continue</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> <span class="token function">containsDangerousCapabilities</span><span class="token punctuation">(</span>caps<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            sm<span class="token punctuation">.</span>events <span class="token operator">&lt;-</span> SecurityEvent<span class="token punctuation">{</span></span>
<span class="line">                Type<span class="token punctuation">:</span>      <span class="token string">&quot;capability&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                Message<span class="token punctuation">:</span>   <span class="token string">&quot;Dangerous capabilities detected&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                Timestamp<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                Severity<span class="token punctuation">:</span>  <span class="token string">&quot;HIGH&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>sm <span class="token operator">*</span>SecurityMonitor<span class="token punctuation">)</span> <span class="token function">monitorSeccomp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 监控 seccomp 违规</span></span>
<span class="line">    <span class="token comment">// 通过解析 /proc/self/status 检查 seccomp 状态</span></span>
<span class="line">    ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> ticker<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token keyword">range</span> ticker<span class="token punctuation">.</span>C <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">isSeccompActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            sm<span class="token punctuation">.</span>events <span class="token operator">&lt;-</span> SecurityEvent<span class="token punctuation">{</span></span>
<span class="line">                Type<span class="token punctuation">:</span>      <span class="token string">&quot;seccomp&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                Message<span class="token punctuation">:</span>   <span class="token string">&quot;seccomp filter not active&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                Timestamp<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                Severity<span class="token punctuation">:</span>  <span class="token string">&quot;MEDIUM&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>sm <span class="token operator">*</span>SecurityMonitor<span class="token punctuation">)</span> <span class="token function">logEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> event <span class="token operator">:=</span> <span class="token keyword">range</span> sm<span class="token punctuation">.</span>events <span class="token punctuation">{</span></span>
<span class="line">        log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;[%s] %s: %s (%s)&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                  event<span class="token punctuation">.</span>Severity<span class="token punctuation">,</span> event<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> event<span class="token punctuation">.</span>Message<span class="token punctuation">,</span> </span>
<span class="line">                  event<span class="token punctuation">.</span>Timestamp<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>RFC3339<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    monitor <span class="token operator">:=</span> <span class="token operator">&amp;</span>SecurityMonitor<span class="token punctuation">{</span></span>
<span class="line">        events<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> SecurityEvent<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    monitor<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 等待退出信号</span></span>
<span class="line">    sigChan <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">    signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>sigChan<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGINT<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGTERM<span class="token punctuation">)</span></span>
<span class="line">    <span class="token operator">&lt;-</span>sigChan</span>
<span class="line">    </span>
<span class="line">    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Security monitor shutting down&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-思考题" tabindex="-1"><a class="header-anchor" href="#_9-思考题"><span>9. 思考题</span></a></h2><h3 id="_9-1-安全模型思考" tabindex="-1"><a class="header-anchor" href="#_9-1-安全模型思考"><span>9.1 安全模型思考</span></a></h3><ol><li><p><strong>多层防护</strong>: 为什么需要 capabilities + seccomp + MAC 的多层安全机制？单一机制的局限性是什么？</p></li><li><p><strong>权限最小化</strong>: 如何平衡安全性和功能性？过度限制权限可能导致什么问题？</p></li><li><p><strong>安全策略</strong>: 如何为不同类型的应用（Web服务、数据库、批处理任务）设计合适的安全策略？</p></li></ol><h3 id="_9-2-实现细节思考" tabindex="-1"><a class="header-anchor" href="#_9-2-实现细节思考"><span>9.2 实现细节思考</span></a></h3><ol start="4"><li><p><strong>Capabilities继承</strong>: ambient capabilities 解决了什么问题？为什么需要这种复杂的继承模型？</p></li><li><p><strong>seccomp性能</strong>: BPF过滤器对系统调用性能的影响如何？有什么优化策略？</p></li><li><p><strong>用户映射</strong>: 在大规模容器环境中，如何有效管理用户ID映射？subuid/subgid 的分配策略？</p></li></ol><h3 id="_9-3-安全挑战思考" tabindex="-1"><a class="header-anchor" href="#_9-3-安全挑战思考"><span>9.3 安全挑战思考</span></a></h3><ol start="7"><li><p><strong>容器逃逸</strong>: 当前的安全机制能防护哪些类型的容器逃逸？还有什么潜在漏洞？</p></li><li><p><strong>兼容性问题</strong>: 严格的安全策略可能影响应用兼容性，如何处理这种冲突？</p></li><li><p><strong>监控审计</strong>: 如何有效监控和审计容器的安全行为？什么样的行为应该被标记为可疑？</p></li></ol><h2 id="_10-扩展阅读" tabindex="-1"><a class="header-anchor" href="#_10-扩展阅读"><span>10. 扩展阅读</span></a></h2><h3 id="_10-1-linux-安全机制" tabindex="-1"><a class="header-anchor" href="#_10-1-linux-安全机制"><span>10.1 Linux 安全机制</span></a></h3><ul><li><a href="https://man7.org/linux/man-pages/man7/capabilities.7.html" target="_blank" rel="noopener noreferrer">Linux Capabilities<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://man7.org/linux/man-pages/man2/seccomp.2.html" target="_blank" rel="noopener noreferrer">seccomp(2)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://gitlab.com/apparmor/apparmor/-/wikis/Documentation" target="_blank" rel="noopener noreferrer">AppArmor Documentation<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://selinuxproject.org/page/User/UserGuide" target="_blank" rel="noopener noreferrer">SELinux User&#39;s Guide<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h3 id="_10-2-容器安全最佳实践" tabindex="-1"><a class="header-anchor" href="#_10-2-容器安全最佳实践"><span>10.2 容器安全最佳实践</span></a></h3><ul><li><a href="https://www.cisecurity.org/benchmark/docker" target="_blank" rel="noopener noreferrer">CIS Docker Benchmark<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://csrc.nist.gov/publications/detail/sp/800-190/final" target="_blank" rel="noopener noreferrer">NIST Container Security Guide<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://info.aquasec.com/container-security-book" target="_blank" rel="noopener noreferrer">Container Security by Liz Rice<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h3 id="_10-3-安全研究和工具" tabindex="-1"><a class="header-anchor" href="#_10-3-安全研究和工具"><span>10.3 安全研究和工具</span></a></h3><ul><li><a href="https://github.com/freach/container-security-awesome" target="_blank" rel="noopener noreferrer">Container Security Tools<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://falco.org/" target="_blank" rel="noopener noreferrer">Falco Runtime Security<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://open-policy-agent.github.io/gatekeeper/" target="_blank" rel="noopener noreferrer">OPA Gatekeeper<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h2 id="🎯-模块总结" tabindex="-1"><a class="header-anchor" href="#🎯-模块总结"><span>🎯 模块总结</span></a></h2><p>通过本模块的学习，你应该已经掌握了：</p><p>✅ <strong>多层安全架构</strong>：理解容器安全的威胁模型和防护体系<br> ✅ <strong>Capabilities 权限控制</strong>：掌握细粒度权限管理和应用策略<br> ✅ <strong>seccomp 系统调用过滤</strong>：理解BPF过滤器和策略配置<br> ✅ <strong>强制访问控制</strong>：熟悉AppArmor/SELinux的集成和应用<br> ✅ <strong>用户权限映射</strong>：掌握用户命名空间的安全模型<br> ✅ <strong>安全策略设计</strong>：具备设计和实施容器安全策略的能力</p><p><strong>下一步</strong>: 进入高级特性模块，学习 CRIU、监控、构建自定义容器运行时等主题。</p></div></div><footer class="page-meta"><div class="meta-item edit-link"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M2 26h28v2H2z" fill="currentColor"></path><path d="M25.4 9c.8-.8.8-2 0-2.8l-3.6-3.6c-.8-.8-2-.8-2.8 0l-15 15V24h6.4l15-15zm-5-5L24 7.6l-3 3L17.4 7l3-3zM6 22v-3.6l10-10l3.6 3.6l-10 10H6z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Edit this page<!--]--></span></span></div><div class="meta-item last-updated"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->更新于 8/6/2025, 6:07:26 PM<!--]--></span></span></div></footer><!----><div class="reco-valine-wrapper"><div id="valine"></div></div></div><div class="page-catalog-container"><h5 class="tip">目录</h5><ul><!--[--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#概述" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="概述"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->概述<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#🎯-学习目标" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="🎯 学习目标"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->🎯 学习目标<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_1-容器安全威胁模型" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1. 容器安全威胁模型"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1. 容器安全威胁模型<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_1-1-容器安全边界" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1.1 容器安全边界"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1.1 容器安全边界<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_1-2-主要攻击向量" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1.2 主要攻击向量"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1.2 主要攻击向量<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_1-3-安全架构设计原则" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1.3 安全架构设计原则"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1.3 安全架构设计原则<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_2-linux-capabilities-权限控制" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2. Linux Capabilities 权限控制"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2. Linux Capabilities 权限控制<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_2-1-capabilities-基础概念" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.1 Capabilities 基础概念"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.1 Capabilities 基础概念<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_2-2-五种-capabilities-集合" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.2 五种 Capabilities 集合"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.2 五种 Capabilities 集合<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_2-3-常用-capabilities-详解" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.3 常用 Capabilities 详解"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.3 常用 Capabilities 详解<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_2-4-runc-中的-capabilities-实现" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.4 runc 中的 Capabilities 实现"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.4 runc 中的 Capabilities 实现<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_2-5-默认-capabilities-策略" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.5 默认 Capabilities 策略"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.5 默认 Capabilities 策略<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_3-seccomp-系统调用过滤" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3. seccomp 系统调用过滤"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3. seccomp 系统调用过滤<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_3-1-seccomp-基础原理" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.1 seccomp 基础原理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.1 seccomp 基础原理<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_3-2-seccomp-配置结构" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.2 seccomp 配置结构"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.2 seccomp 配置结构<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_3-3-seccomp-动作类型" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.3 seccomp 动作类型"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.3 seccomp 动作类型<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_3-4-runc-中的-seccomp-实现" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.4 runc 中的 seccomp 实现"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.4 runc 中的 seccomp 实现<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_3-5-bpf-补丁优化" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.5 BPF 补丁优化"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.5 BPF 补丁优化<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_3-6-高级特性-seccomp-notify" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.6 高级特性：seccomp notify"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.6 高级特性：seccomp notify<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_3-7-默认-seccomp-策略" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.7 默认 seccomp 策略"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.7 默认 seccomp 策略<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_4-apparmor-selinux-强制访问控制" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4. AppArmor/SELinux 强制访问控制"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4. AppArmor/SELinux 强制访问控制<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_4-1-mac-vs-dac" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4.1 MAC vs DAC"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4.1 MAC vs DAC<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_4-2-apparmor-集成" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4.2 AppArmor 集成"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4.2 AppArmor 集成<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_4-3-selinux-集成" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4.3 SELinux 集成"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4.3 SELinux 集成<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_5-用户命名空间权限映射" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5. 用户命名空间权限映射"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5. 用户命名空间权限映射<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_5-1-id-映射机制" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.1 ID 映射机制"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.1 ID 映射机制<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_5-2-id-映射配置" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.2 ID 映射配置"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.2 ID 映射配置<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_5-3-映射文件读取" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.3 映射文件读取"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.3 映射文件读取<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_5-4-c-代码映射读取" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.4 C 代码映射读取"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.4 C 代码映射读取<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_5-5-rootless-容器安全模型" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.5 Rootless 容器安全模型"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.5 Rootless 容器安全模型<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_6-安全策略配置和应用" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6. 安全策略配置和应用"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6. 安全策略配置和应用<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_6-1-安全配置验证" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6.1 安全配置验证"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6.1 安全配置验证<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_6-2-安全策略应用流程" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6.2 安全策略应用流程"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6.2 安全策略应用流程<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_6-3-路径限制实现" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6.3 路径限制实现"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6.3 路径限制实现<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_7-实践练习" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7. 实践练习"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7. 实践练习<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_7-1-capabilities-实验" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7.1 Capabilities 实验"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7.1 Capabilities 实验<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_7-2-seccomp-过滤实验" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7.2 seccomp 过滤实验"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7.2 seccomp 过滤实验<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_7-3-apparmor-profile-测试" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7.3 AppArmor Profile 测试"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7.3 AppArmor Profile 测试<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_7-4-用户命名空间映射实验" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7.4 用户命名空间映射实验"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7.4 用户命名空间映射实验<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_8-安全最佳实践" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8. 安全最佳实践"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8. 安全最佳实践<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_8-1-安全配置检查清单" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8.1 安全配置检查清单"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8.1 安全配置检查清单<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_8-2-安全策略模板" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8.2 安全策略模板"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8.2 安全策略模板<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_8-3-安全监控和审计" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8.3 安全监控和审计"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8.3 安全监控和审计<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_9-思考题" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9. 思考题"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9. 思考题<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_9-1-安全模型思考" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9.1 安全模型思考"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9.1 安全模型思考<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_9-2-实现细节思考" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9.2 实现细节思考"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9.2 实现细节思考<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_9-3-安全挑战思考" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9.3 安全挑战思考"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9.3 安全挑战思考<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_10-扩展阅读" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="10. 扩展阅读"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->10. 扩展阅读<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_10-1-linux-安全机制" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="10.1 Linux 安全机制"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->10.1 Linux 安全机制<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_10-2-容器安全最佳实践" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="10.2 容器安全最佳实践"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->10.2 容器安全最佳实践<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#_10-3-安全研究和工具" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="10.3 安全研究和工具"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->10.3 安全研究和工具<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html#🎯-模块总结" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="🎯 模块总结"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->🎯 模块总结<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--></ul></div></main><!--]--></div></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/blog/assets/app-2O6audqE.js" defer></script>
  </body>
</html>

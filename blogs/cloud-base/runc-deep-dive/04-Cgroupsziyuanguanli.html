<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-rc.19">
    <script>
      (function() {
        const userMode = localStorage.getItem('vuepress-reco-color-scheme') || 'auto';
        const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (userMode === 'dark' || (userMode === 'auto' && systemDarkMode)) {
          document.documentElement.classList.toggle('dark', true);
        }
      })();
    </script>
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.min.js" as="script"><title>Cgroups 资源管理 | database of memory</title><meta name="description" content="study anything and life record">
    <link rel="preload" href="/blog/assets/style-3Js8NCR5.css" as="style"><link rel="stylesheet" href="/blog/assets/style-3Js8NCR5.css">
    <link rel="modulepreload" href="/blog/assets/app-2O6audqE.js"><link rel="modulepreload" href="/blog/assets/04-Cgroupsziyuanguanli.html-Cv4-SHFL.js">
    <link rel="prefetch" href="/blog/assets/timeline.html-Dpj3Uwd1.js" as="script"><link rel="prefetch" href="/blog/assets/posts.html-CwxCj2Hz.js" as="script"><link rel="prefetch" href="/blog/assets/friendship-link.html-BWfmkE8T.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-u-MzmdCM.js" as="script"><link rel="prefetch" href="/blog/assets/2.html-BZ918lqD.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-C0q1hGsM.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CKULWdoq.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CWtVNK-m.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bd6PVF3c.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BbXNqe1N.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DyPCaQFd.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-C18Bjk_W.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BBVLOTuN.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D6KsFqqv.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BFPB5Kke.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B7IkZhlZ.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D_xT1fZZ.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DheB4D6E.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bt_l6w3U.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DeILrr-C.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DSTAwzEO.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BD5fA-NV.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BkRrSqYz.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-cT5R8xwx.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D9YDDbbv.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CbwTJPe7.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BuOxUP39.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BonFf6Hv.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DdMSM_BO.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Cf_rINiA.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DAcku8Eg.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DXT9U0AY.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DNdoOP4f.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-gqCMVOP4.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-HV0Wu9t8.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-LYxcb78a.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B50wkuh6.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DmpqsxHB.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-ChJizRVK.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D91uHYKf.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BLywihRf.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CB6EOmHd.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CxeevLHu.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B6J1fqYY.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D6g5ki7n.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CNoSmcFz.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dg6Odx9T.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dcy99l4T.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BK5mIUzD.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-8yVN6cur.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D33sQ_DA.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BOgMey9f.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D-L5Fugg.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-blGV0Kuf.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Ck4-7Hl7.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-N5xZIiU3.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DHa_luE7.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BDo2AWiQ.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CJj46_t8.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B32LjB8A.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DHAALd4l.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-H_UWlmPh.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DhnB-W5f.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dl8_vnsm.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-AlHvVsZC.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D7E4OavF.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CgCAEUN3.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-4Mr3uCmo.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BWKUAlc0.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CNuv7HDI.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BTkfIlYg.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dqp54iE9.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CtCFev89.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bb4UAQpl.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B6JysInN.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CHu47ESV.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CW5fe8Pz.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CBCt-NmX.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DV90AmxE.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DzWzo9Ij.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bz0VyI0Z.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BjgscHtw.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Cx8p_sw9.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DoYWpPPd.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Ci-xHJlU.js" as="script"><link rel="prefetch" href="/blog/assets/2.html-DwdRHJG4.js" as="script"><link rel="prefetch" href="/blog/assets/3.html-DoXfDGmJ.js" as="script"><link rel="prefetch" href="/blog/assets/4.html-C-kKKJQV.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-fn4kmre_.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CoWvKsGl.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BvQMmH-P.js" as="script"><link rel="prefetch" href="/blog/assets/bitwise_operation.html-EhYVvxM9.js" as="script"><link rel="prefetch" href="/blog/assets/learning_algorithm.html-Tnr40gqi.js" as="script"><link rel="prefetch" href="/blog/assets/cache_pattern.html-BWIGrhub.js" as="script"><link rel="prefetch" href="/blog/assets/docker_tech.html-B7PNaqxh.js" as="script"><link rel="prefetch" href="/blog/assets/k3s.html-DP3vWh7K.js" as="script"><link rel="prefetch" href="/blog/assets/k3s_k8s_ingress.html-0VG_Dn9p.js" as="script"><link rel="prefetch" href="/blog/assets/oci-01-intro-guide.html-CMWMS7fl.js" as="script"><link rel="prefetch" href="/blog/assets/oci-02-runtime-spec.html-C0iBtGsB.js" as="script"><link rel="prefetch" href="/blog/assets/oci-03-image-spec.html-BBhmTevb.js" as="script"><link rel="prefetch" href="/blog/assets/oci-04-distribution-spec.html-BK42sbpW.js" as="script"><link rel="prefetch" href="/blog/assets/oci-05-security-guide.html-B3_bjMcv.js" as="script"><link rel="prefetch" href="/blog/assets/oci-06-monitoring-guide.html-DZeNq5_D.js" as="script"><link rel="prefetch" href="/blog/assets/oci-07-production-guide.html-Dd4znSBp.js" as="script"><link rel="prefetch" href="/blog/assets/oci-08-hooks-deep-dive.html-U722baza.js" as="script"><link rel="prefetch" href="/blog/assets/oci-linux-configurations-blog.html-B-QLbxh0.js" as="script"><link rel="prefetch" href="/blog/assets/oci-series-index.html-CDKgV4-S.js" as="script"><link rel="prefetch" href="/blog/assets/runc-advanced-lifecycle-analysis.html-DksQevmb.js" as="script"><link rel="prefetch" href="/blog/assets/runc-comprehensive-design-guide.html-B3lFgAwq.js" as="script"><link rel="prefetch" href="/blog/assets/runc-container-lifecycle-diagrams.html-D0cL6kcw.js" as="script"><link rel="prefetch" href="/blog/assets/linux_namespace.html-C_6Up541.js" as="script"><link rel="prefetch" href="/blog/assets/python_checklist.html-C2qsWYBJ.js" as="script"><link rel="prefetch" href="/blog/assets/python_env_manage.html-CUnPJ_1B.js" as="script"><link rel="prefetch" href="/blog/assets/gevent.html-CUgqcz3s.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BJAgUlPO.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BO__mOgk.js" as="script"><link rel="prefetch" href="/blog/assets/sort_1.html-B61YFXe2.js" as="script"><link rel="prefetch" href="/blog/assets/01-runcgaishuyujiagou.html-CdwfP7-9.js" as="script"><link rel="prefetch" href="/blog/assets/02-rongqishengmingzhouqiguanli.html-C-f7fScs.js" as="script"><link rel="prefetch" href="/blog/assets/03-Namespacegelishixian.html-i58zOLTD.js" as="script"><link rel="prefetch" href="/blog/assets/05-wenjianxitongyuguazaiguanli.html-BtljxstR.js" as="script"><link rel="prefetch" href="/blog/assets/06-anquantexingshixian.html-BHgpOUyN.js" as="script"><link rel="prefetch" href="/blog/assets/07-CRIUjianchadianyuhuifu.html-2aSuteQG.js" as="script"><link rel="prefetch" href="/blog/assets/08-tongxinyujiankongxitong.html-C1uYqrtr.js" as="script"><link rel="prefetch" href="/blog/assets/09-goujianjianhuarongqiyunxingshi.html-ZL_qjd8j.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DhgGbCoG.js" as="script"><link rel="prefetch" href="/blog/assets/abstract_factory.html-qSB2vqGJ.js" as="script"><link rel="prefetch" href="/blog/assets/factory_method.html-DaXxm691.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CQ2duCZ4.js" as="script"><link rel="prefetch" href="/blog/assets/adapter.html-k-5RMaEx.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-BmtOmY9V.js" as="script"><link rel="prefetch" href="/blog/assets/Valine.min-VCLvSWzF.js" as="script"><link rel="prefetch" href="/blog/assets/giscus-aTimukGI-DWEKOTfS.js" as="script"><link rel="prefetch" href="/blog/assets/KnowledgeMap-Dr6IblrL.js" as="script"><link rel="prefetch" href="/blog/assets/MermaidChart-a1CbfxcL.js" as="script"><link rel="prefetch" href="/blog/assets/mermaid.core-xyQxSs4c.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container series--no show-catalog"><header class="navbar-container not-open"><div class="navbar-inner"><div class="site-brand nav-item"><img class="logo" src="/blog/logo.png" alt="database of memory"><a href="/blog/" class="site-name can-hide">database of memory</a></div><div class="nav-item navbar-links-wrapper" style=""><div><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div><nav class="navbar-links"><!--[--><div class="navbar-links__item"><a href="/blog/" class="link" aria-label="Home"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Home<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/blog/categories/cloud-base/1/" class="link" aria-label="Categories"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Categories<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/blog/tags/runc/1/" class="link" aria-label="Tags"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Tags<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/blog/knowledge-map/" class="link" aria-label="知识地图"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->知识地图<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="Docs"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Docs<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="Docs"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Docs<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/blog/docs/leetcode/" class="link" aria-label="leetcode from scratch"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->leetcode from scratch<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/docs/design_pattern/" class="link" aria-label="design pattern"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->design pattern<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--><!----><span class="xicon-container btn-toggle-dark-mode btn--dark-mode navbar-links__item"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><path d="M15 2h2v3h-2z" fill="currentColor"></path><path d="M27 15h3v2h-3z" fill="currentColor"></path><path d="M15 27h2v3h-2z" fill="currentColor"></path><path d="M2 15h3v2H2z" fill="currentColor"></path><path d="M5.45 6.884l1.414-1.415l2.121 2.122l-1.414 1.414z" fill="currentColor"></path><path d="M23 7.58l2.121-2.12l1.414 1.414l-2.121 2.121z" fill="currentColor"></path><path d="M23.002 24.416l1.415-1.414l2.12 2.122l-1.413 1.414z" fill="currentColor"></path><path d="M5.47 25.13L7.59 23L9 24.42l-2.12 2.12l-1.41-1.41z" fill="currentColor"></path><path d="M16 8a8 8 0 1 0 8 8a8 8 0 0 0-8-8zm0 14a6 6 0 0 1 0-12z" fill="currentColor"></path></svg></span><ul class="social-links navbar-links__item"><!--[--><li class="social-item"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:25px;height:25px;"><path d="M16 2a14 14 0 0 0-4.43 27.28c.7.13 1-.3 1-.67v-2.38c-3.89.84-4.71-1.88-4.71-1.88a3.71 3.71 0 0 0-1.62-2.05c-1.27-.86.1-.85.1-.85a2.94 2.94 0 0 1 2.14 1.45a3 3 0 0 0 4.08 1.16a2.93 2.93 0 0 1 .88-1.87c-3.1-.36-6.37-1.56-6.37-6.92a5.4 5.4 0 0 1 1.44-3.76a5 5 0 0 1 .14-3.7s1.17-.38 3.85 1.43a13.3 13.3 0 0 1 7 0c2.67-1.81 3.84-1.43 3.84-1.43a5 5 0 0 1 .14 3.7a5.4 5.4 0 0 1 1.44 3.76c0 5.38-3.27 6.56-6.39 6.91a3.33 3.33 0 0 1 .95 2.59v3.84c0 .46.25.81 1 .67A14 14 0 0 0 16 2z" fill-rule="evenodd" fill="currentColor"></path></svg></li><!--]--></ul></nav><span class="xicon-container btn-toggle-menus"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><circle cx="16" cy="8" r="2" fill="currentColor"></circle><circle cx="16" cy="16" r="2" fill="currentColor"></circle><circle cx="16" cy="24" r="2" fill="currentColor"></circle></svg></span></div></div></header><!----><!----><!----><div class="theme-main" style=""><!----><!--[--><main class="page-container"><div class="page-content"><h1 class="page-title">Cgroups 资源管理</h1><div class="page-info"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M16 4a5 5 0 1 1-5 5a5 5 0 0 1 5-5m0-2a7 7 0 1 0 7 7a7 7 0 0 0-7-7z" fill="currentColor"></path><path d="M26 30h-2v-5a5 5 0 0 0-5-5h-6a5 5 0 0 0-5 5v5H6v-5a7 7 0 0 1 7-7h6a7 7 0 0 1 7 7z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->hujunjie<!--]--></span></span><!----><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M11.17 6l3.42 3.41l.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[--><!--[--><a href="/blog/categories/cloud-base/runc-deep-dive/1.html" class="">cloud-base/runc-deep-dive</a><!--]--><!--]--></span></span><!----><!----></div><div class="theme-reco-md-content"><div><h1 id="cgroups-资源管理" tabindex="-1"><a class="header-anchor" href="#cgroups-资源管理"><span>Cgroups 资源管理</span></a></h1><blockquote><p><strong>系列导航：</strong> <a class="route-link" href="/blog/blogs/cloud-base/runc-deep-dive/">runc 容器运行时深度解析系列</a> → 第四篇：Cgroups 资源管理<br><strong>上一篇：</strong> <a class="route-link" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html">Namespace隔离实现</a><br><strong>最后更新：</strong> 2024</p></blockquote><h2 id="概述" tabindex="-1"><a class="header-anchor" href="#概述"><span>概述</span></a></h2><p>本文深入分析 runc 如何利用 Linux Cgroups 实现容器资源管理和限制。Cgroups 是容器资源隔离的核心机制，能够精确控制容器对 CPU、内存、I/O 等资源的使用。</p><h2 id="🎯-学习目标" tabindex="-1"><a class="header-anchor" href="#🎯-学习目标"><span>🎯 学习目标</span></a></h2><p>完成本模块后，你将能够：</p><ul><li>深入理解 Linux Cgroups 的核心概念和层次结构</li><li>掌握 cgroups v1 和 v2 的架构差异和实现原理</li><li>理解 CPU、内存、IO、设备等资源控制机制</li><li>掌握 runc 中资源限制的配置和应用流程</li><li>具备资源监控、统计和性能调优的实践能力</li></ul><h2 id="_1-cgroups-基础概念" tabindex="-1"><a class="header-anchor" href="#_1-cgroups-基础概念"><span>1. Cgroups 基础概念</span></a></h2><h3 id="_1-1-什么是-cgroups" tabindex="-1"><a class="header-anchor" href="#_1-1-什么是-cgroups"><span>1.1 什么是 Cgroups？</span></a></h3><p><strong>Cgroups (Control Groups)</strong> 是 Linux 内核提供的资源管理和隔离机制，允许对进程组进行资源限制、优先级分配和资源使用统计。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">┌─────────────────────────────────────────────────┐</span>
<span class="line">│                    物理机器                     │</span>
<span class="line">│  CPU: 8核   Memory: 16GB   Disk: 1TB          │</span>
<span class="line">└┬────────────────────┬───────────────────────────┘</span>
<span class="line"> │                    │</span>
<span class="line"> ▼                    ▼</span>
<span class="line">┌─────────────────┐  ┌─────────────────────────────┐</span>
<span class="line">│   容器 A        │  │        容器 B               │</span>
<span class="line">│ CPU: 2核 (25%)  │  │    CPU: 4核 (50%)          │</span>
<span class="line">│ Memory: 4GB     │  │    Memory: 8GB             │</span>
<span class="line">│ IO: 100MB/s     │  │    IO: 200MB/s             │</span>
<span class="line">└─────────────────┘  └─────────────────────────────┘</span>
<span class="line">       ▲                        ▲</span>
<span class="line">   cgroup-a                 cgroup-b</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>核心功能</strong>：</p><ul><li>🎯 <strong>资源限制</strong>: 限制进程组使用的资源上限</li><li>⚖️ <strong>优先级分配</strong>: 分配不同的资源权重</li><li>📊 <strong>资源统计</strong>: 监控和统计资源使用情况</li><li>🔧 <strong>资源控制</strong>: 动态调整资源配置</li></ul><h3 id="_1-2-cgroups-层次结构" tabindex="-1"><a class="header-anchor" href="#_1-2-cgroups-层次结构"><span>1.2 Cgroups 层次结构</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">/sys/fs/cgroup/         ← cgroup 文件系统根目录</span>
<span class="line">├── system.slice/       ← systemd 创建的系统服务</span>
<span class="line">│   ├── cgroup.procs    ← 进程列表</span>
<span class="line">│   ├── cpu.shares      ← CPU 权重</span>
<span class="line">│   └── memory.limit_in_bytes ← 内存限制</span>
<span class="line">├── user.slice/         ← 用户会话</span>
<span class="line">└── machine.slice/      ← 虚拟机和容器</span>
<span class="line">    └── docker-abc123.scope/</span>
<span class="line">        ├── cgroup.procs</span>
<span class="line">        ├── cpu.cfs_quota_us</span>
<span class="line">        ├── cpu.cfs_period_us</span>
<span class="line">        ├── memory.limit_in_bytes</span>
<span class="line">        ├── memory.usage_in_bytes</span>
<span class="line">        └── blkio.throttle.read_bps_device</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>层次结构特点</strong>：</p><ul><li>🌳 <strong>树形结构</strong>: 子 cgroup 继承父 cgroup 的属性</li><li>👥 <strong>进程归属</strong>: 每个进程属于且仅属于一个 cgroup</li><li>📋 <strong>控制器</strong>: 每个控制器独立管理特定类型资源</li></ul><h2 id="_2-cgroups-v1-vs-v2-架构差异" tabindex="-1"><a class="header-anchor" href="#_2-cgroups-v1-vs-v2-架构差异"><span>2. Cgroups v1 vs v2 架构差异</span></a></h2><h3 id="_2-1-架构对比图" tabindex="-1"><a class="header-anchor" href="#_2-1-架构对比图"><span>2.1 架构对比图</span></a></h3><h4 id="cgroups-v1-多层次架构" tabindex="-1"><a class="header-anchor" href="#cgroups-v1-多层次架构"><span>Cgroups v1 (多层次架构)</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">/sys/fs/cgroup/</span>
<span class="line">├── cpu/              ← CPU 控制器独立层次</span>
<span class="line">│   ├── system/</span>
<span class="line">│   └── docker/</span>
<span class="line">│       └── container1/</span>
<span class="line">├── memory/           ← 内存控制器独立层次  </span>
<span class="line">│   ├── system/</span>
<span class="line">│   └── docker/</span>
<span class="line">│       └── container1/</span>
<span class="line">├── blkio/            ← IO 控制器独立层次</span>
<span class="line">│   ├── system/</span>
<span class="line">│   └── docker/</span>
<span class="line">│       └── container1/</span>
<span class="line">└── devices/          ← 设备控制器独立层次</span>
<span class="line">    ├── system/</span>
<span class="line">    └── docker/</span>
<span class="line">        └── container1/</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="cgroups-v2-统一层次架构" tabindex="-1"><a class="header-anchor" href="#cgroups-v2-统一层次架构"><span>Cgroups v2 (统一层次架构)</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">/sys/fs/cgroup/              ← 统一文件系统</span>
<span class="line">├── cgroup.controllers       ← 可用控制器列表</span>
<span class="line">├── cgroup.subtree_control   ← 启用的子控制器</span>
<span class="line">├── system.slice/</span>
<span class="line">│   ├── cpu.weight          ← 所有控制器文件</span>
<span class="line">│   ├── memory.max          ← 都在同一目录</span>
<span class="line">│   ├── io.max</span>
<span class="line">│   └── cgroup.procs</span>
<span class="line">└── machine.slice/</span>
<span class="line">    └── docker-abc123.scope/</span>
<span class="line">        ├── cpu.weight</span>
<span class="line">        ├── memory.max</span>
<span class="line">        ├── io.max</span>
<span class="line">        └── cgroup.procs</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-核心差异对比" tabindex="-1"><a class="header-anchor" href="#_2-2-核心差异对比"><span>2.2 核心差异对比</span></a></h3><table><thead><tr><th>特性</th><th>Cgroups v1</th><th>Cgroups v2</th></tr></thead><tbody><tr><td><strong>层次结构</strong></td><td>多个独立层次</td><td>统一层次结构</td></tr><tr><td><strong>控制器管理</strong></td><td>每个控制器独立挂载</td><td>所有控制器统一管理</td></tr><tr><td><strong>CPU权重</strong></td><td><code>cpu.shares</code> (2-262144)</td><td><code>cpu.weight</code> (1-10000)</td></tr><tr><td><strong>内存交换</strong></td><td><code>memory.memsw.limit_in_bytes</code></td><td><code>memory.swap.max</code></td></tr><tr><td><strong>IO控制</strong></td><td><code>blkio.*</code> 接口</td><td><code>io.*</code> 接口</td></tr><tr><td><strong>设备控制</strong></td><td>白名单机制</td><td>eBPF 程序</td></tr><tr><td><strong>内存回收</strong></td><td>复杂的页面回收</td><td>统一的内存回收策略</td></tr><tr><td><strong>PSI支持</strong></td><td>不支持</td><td>内置压力失速信息</td></tr></tbody></table><h3 id="_2-3-runc-的实现适配" tabindex="-1"><a class="header-anchor" href="#_2-3-runc-的实现适配"><span>2.3 runc 的实现适配</span></a></h3><p>runc 通过抽象接口同时支持两个版本：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 统一的 Manager 接口</span></span>
<span class="line"><span class="token keyword">type</span> Manager <span class="token keyword">interface</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">Apply</span><span class="token punctuation">(</span>pid <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span>           <span class="token comment">// 将进程加入 cgroup</span></span>
<span class="line">    <span class="token function">GetPids</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>       <span class="token comment">// 获取 cgroup 中的进程列表</span></span>
<span class="line">    <span class="token function">GetAllPids</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>    <span class="token comment">// 获取包括子 cgroup 的所有进程</span></span>
<span class="line">    <span class="token function">GetStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Stats<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>     <span class="token comment">// 获取资源使用统计</span></span>
<span class="line">    <span class="token function">Freeze</span><span class="token punctuation">(</span>state FreezerState<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token comment">// 冻结/解冻进程</span></span>
<span class="line">    <span class="token function">Destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>               <span class="token comment">// 销毁 cgroup</span></span>
<span class="line">    <span class="token function">Set</span><span class="token punctuation">(</span>r <span class="token operator">*</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span>       <span class="token comment">// 设置资源限制</span></span>
<span class="line">    <span class="token function">GetPaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>  <span class="token comment">// 获取 cgroup 路径</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 版本检测和管理器创建</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewManager</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token punctuation">(</span>Manager<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> cgroups<span class="token punctuation">.</span><span class="token function">IsCgroup2UnifiedMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 使用 v2 管理器</span></span>
<span class="line">        <span class="token keyword">return</span> fs2<span class="token punctuation">.</span><span class="token function">NewManager</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> path<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 使用 v1 管理器  </span></span>
<span class="line">        <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">NewManager</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> paths<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-核心资源控制机制" tabindex="-1"><a class="header-anchor" href="#_3-核心资源控制机制"><span>3. 核心资源控制机制</span></a></h2><h3 id="_3-1-cpu-资源控制" tabindex="-1"><a class="header-anchor" href="#_3-1-cpu-资源控制"><span>3.1 CPU 资源控制</span></a></h3><h4 id="a-cpu-权重控制-相对权重" tabindex="-1"><a class="header-anchor" href="#a-cpu-权重控制-相对权重"><span>A. CPU 权重控制 (相对权重)</span></a></h4><p><strong>Cgroups v1 实现</strong>：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// CPU 权重设置 (cpu.shares)</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>CpuGroup<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> r<span class="token punctuation">.</span>CpuShares <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 范围: 2-262144，默认: 1024</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;cpu.shares&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">            strconv<span class="token punctuation">.</span><span class="token function">FormatUint</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>CpuShares<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set cpu.shares: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Cgroups v2 实现</strong>：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// CPU 权重设置 (cpu.weight)  </span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setCPU</span><span class="token punctuation">(</span>dirPath <span class="token builtin">string</span><span class="token punctuation">,</span> r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> r<span class="token punctuation">.</span>CpuWeight <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 范围: 1-10000，默认: 100</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> <span class="token string">&quot;cpu.weight&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">            strconv<span class="token punctuation">.</span><span class="token function">FormatUint</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>CpuWeight<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set cpu.weight: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// v1 shares 到 v2 weight 的转换</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">convertSharesToWeight</span><span class="token punctuation">(</span>shares <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token builtin">uint64</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> shares <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// weight = ((shares - 2) * 9999) / 262142 + 1</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>shares <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">9999</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">262142</span> <span class="token operator">+</span> <span class="token number">1</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>权重计算示例</strong>：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">场景: 3个容器竞争 CPU</span>
<span class="line">容器A: cpu.shares = 1024 (默认)</span>
<span class="line">容器B: cpu.shares = 512  (一半权重)  </span>
<span class="line">容器C: cpu.shares = 2048 (两倍权重)</span>
<span class="line"></span>
<span class="line">总权重 = 1024 + 512 + 2048 = 3584</span>
<span class="line"></span>
<span class="line">CPU 分配比例:</span>
<span class="line">容器A: 1024/3584 = 28.6%</span>
<span class="line">容器B: 512/3584  = 14.3%  </span>
<span class="line">容器C: 2048/3584 = 57.1%</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="b-cpu-配额控制-硬限制" tabindex="-1"><a class="header-anchor" href="#b-cpu-配额控制-硬限制"><span>B. CPU 配额控制 (硬限制)</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// CFS 调度器配额设置</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setCPUQuota</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> quota <span class="token builtin">int64</span><span class="token punctuation">,</span> period <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 设置调度周期 (默认 100ms = 100,000μs)</span></span>
<span class="line">    <span class="token keyword">if</span> period <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;cpu.cfs_period_us&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">            strconv<span class="token punctuation">.</span><span class="token function">FormatUint</span><span class="token punctuation">(</span>period<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置配额 (每个周期内可使用的 CPU 时间)</span></span>
<span class="line">    <span class="token keyword">if</span> quota <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;cpu.cfs_quota_us&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">            strconv<span class="token punctuation">.</span><span class="token function">FormatInt</span><span class="token punctuation">(</span>quota<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>配额计算示例</strong>：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 限制容器使用 1.5 个 CPU 核心</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token number">100000</span> <span class="token operator">&gt;</span> cpu.cfs_period_us    <span class="token comment"># 周期 100ms</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token number">150000</span> <span class="token operator">&gt;</span> cpu.cfs_quota_us     <span class="token comment"># 配额 150ms</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 限制使用 50% 的单核 CPU</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token number">100000</span> <span class="token operator">&gt;</span> cpu.cfs_period_us    <span class="token comment"># 周期 100ms  </span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token number">50000</span>  <span class="token operator">&gt;</span> cpu.cfs_quota_us     <span class="token comment"># 配额 50ms</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 配额计算公式:</span></span>
<span class="line"><span class="token comment"># CPU核心数 = quota / period</span></span>
<span class="line"><span class="token comment"># 1.5 核 = 150000 / 100000 = 1.5</span></span>
<span class="line"><span class="token comment"># 0.5 核 = 50000 / 100000 = 0.5</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="c-cpu-突发控制-burst" tabindex="-1"><a class="header-anchor" href="#c-cpu-突发控制-burst"><span>C. CPU 突发控制 (Burst)</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// CPU 突发限制 (较新的内核特性)</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setCPUBurst</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> burst <span class="token operator">*</span><span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> burst <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 允许短期内超过配额使用的 CPU 时间</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;cpu.cfs_burst_us&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">            strconv<span class="token punctuation">.</span><span class="token function">FormatUint</span><span class="token punctuation">(</span><span class="token operator">*</span>burst<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 忽略不支持的内核</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token operator">!</span>os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> err</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-内存资源控制" tabindex="-1"><a class="header-anchor" href="#_3-2-内存资源控制"><span>3.2 内存资源控制</span></a></h3><h4 id="a-内存限制设置" tabindex="-1"><a class="header-anchor" href="#a-内存限制设置"><span>A. 内存限制设置</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 内存限制的复杂设置逻辑</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setMemoryAndSwap</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 关键: 交换空间限制必须 &gt;= 内存限制</span></span>
<span class="line">    <span class="token keyword">if</span> r<span class="token punctuation">.</span>Memory <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>MemorySwap <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        curLimit<span class="token punctuation">,</span> err <span class="token operator">:=</span> fscommon<span class="token punctuation">.</span><span class="token function">GetCgroupParamUint</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> cgroupMemoryLimit<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 根据当前值决定设置顺序</span></span>
<span class="line">        <span class="token keyword">if</span> r<span class="token punctuation">.</span>MemorySwap <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> curLimit <span class="token operator">&lt;</span> <span class="token function">uint64</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>MemorySwap<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 情况1: 先设置交换，再设置内存</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setSwap</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> r<span class="token punctuation">.</span>MemorySwap<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> err</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">setMemory</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Memory<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 情况2: 正常顺序 - 先内存，后交换</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setMemory</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Memory<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">setSwap</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> r<span class="token punctuation">.</span>MemorySwap<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setMemory</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> limit <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> limit <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> cgroupMemoryLimit<span class="token punctuation">,</span> </span>
<span class="line">        strconv<span class="token punctuation">.</span><span class="token function">FormatInt</span><span class="token punctuation">(</span>limit<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// EBUSY 表示新限制低于当前使用量</span></span>
<span class="line">    <span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>EBUSY<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        usage<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> fscommon<span class="token punctuation">.</span><span class="token function">GetCgroupParamUint</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> cgroupMemoryUsage<span class="token punctuation">)</span></span>
<span class="line">        max<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> fscommon<span class="token punctuation">.</span><span class="token function">GetCgroupParamUint</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> cgroupMemoryMaxUsage<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;cannot set memory limit to %d: current usage %d, peak usage %d&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">            limit<span class="token punctuation">,</span> usage<span class="token punctuation">,</span> max<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> err</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="b-cgroups-v2-内存管理" tabindex="-1"><a class="header-anchor" href="#b-cgroups-v2-内存管理"><span>B. Cgroups v2 内存管理</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// v2 的内存管理更加统一和简化</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setMemory</span><span class="token punctuation">(</span>dirPath <span class="token builtin">string</span><span class="token punctuation">,</span> r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 检查当前内存使用，避免设置过低的限制</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">CheckMemoryUsage</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// v2 中交换空间限制不包含内存</span></span>
<span class="line">    swap<span class="token punctuation">,</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">ConvertMemorySwapToCgroupV2Value</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>MemorySwap<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Memory<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置交换限制</span></span>
<span class="line">    <span class="token keyword">if</span> swapStr <span class="token operator">:=</span> <span class="token function">numToStr</span><span class="token punctuation">(</span>swap<span class="token punctuation">)</span><span class="token punctuation">;</span> swapStr <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> <span class="token string">&quot;memory.swap.max&quot;</span><span class="token punctuation">,</span> swapStr<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 如果 swap 未启用，静默忽略错误</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token operator">!</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> os<span class="token punctuation">.</span>ErrNotExist<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>swapStr <span class="token operator">==</span> <span class="token string">&quot;max&quot;</span> <span class="token operator">||</span> swapStr <span class="token operator">==</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> err</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置内存限制</span></span>
<span class="line">    <span class="token keyword">if</span> val <span class="token operator">:=</span> <span class="token function">numToStr</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Memory<span class="token punctuation">)</span><span class="token punctuation">;</span> val <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> <span class="token string">&quot;memory.max&quot;</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 内存交换值转换 (v1 -&gt; v2)</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">ConvertMemorySwapToCgroupV2Value</span><span class="token punctuation">(</span>memorySwap<span class="token punctuation">,</span> memory <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// v1: memory.memsw.limit_in_bytes 包含内存+交换总量</span></span>
<span class="line">    <span class="token comment">// v2: memory.swap.max 只包含交换空间</span></span>
<span class="line">    <span class="token keyword">if</span> memorySwap <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>  <span class="token comment">// 无限制</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> memorySwap <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> memory <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> memorySwap <span class="token operator">-</span> memory<span class="token punctuation">,</span> <span class="token boolean">nil</span>  <span class="token comment">// 减去内存部分</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> memorySwap<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="c-内存回收策略" tabindex="-1"><a class="header-anchor" href="#c-内存回收策略"><span>C. 内存回收策略</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 内存交换倾向性设置</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setSwappiness</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> swappiness <span class="token operator">*</span><span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> swappiness <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 范围 0-100，值越小越不愿意使用交换空间</span></span>
<span class="line">        <span class="token comment">// 0: 禁用交换 (除非内存不足)</span></span>
<span class="line">        <span class="token comment">// 100: 积极使用交换空间</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;memory.swappiness&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">            strconv<span class="token punctuation">.</span><span class="token function">FormatUint</span><span class="token punctuation">(</span><span class="token operator">*</span>swappiness<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-io-资源控制" tabindex="-1"><a class="header-anchor" href="#_3-3-io-资源控制"><span>3.3 IO 资源控制</span></a></h3><h4 id="a-io-权重控制" tabindex="-1"><a class="header-anchor" href="#a-io-权重控制"><span>A. IO 权重控制</span></a></h4><p><strong>Cgroups v1 实现</strong>：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>BlkioGroup<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 检测并选择调度器 (CFQ 或 BFQ)</span></span>
<span class="line">    s<span class="token punctuation">.</span><span class="token function">detectWeightFilenames</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置全局 IO 权重</span></span>
<span class="line">    <span class="token keyword">if</span> r<span class="token punctuation">.</span>BlkioWeight <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 范围: 10-1000，默认: 500</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> s<span class="token punctuation">.</span>weightFilename<span class="token punctuation">,</span> </span>
<span class="line">            strconv<span class="token punctuation">.</span><span class="token function">FormatUint</span><span class="token punctuation">(</span><span class="token function">uint64</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>BlkioWeight<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置设备级 IO 权重</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> wd <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>BlkioWeightDevice <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> wd<span class="token punctuation">.</span>Weight <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 格式: &quot;major:minor weight&quot;</span></span>
<span class="line">            weightStr <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%d:%d %d&quot;</span><span class="token punctuation">,</span> wd<span class="token punctuation">.</span>Major<span class="token punctuation">,</span> wd<span class="token punctuation">.</span>Minor<span class="token punctuation">,</span> wd<span class="token punctuation">.</span>Weight<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> s<span class="token punctuation">.</span>weightDeviceFilename<span class="token punctuation">,</span> </span>
<span class="line">                weightStr<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> err</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">setThrottle</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> r<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Cgroups v2 实现</strong>：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">setIo</span><span class="token punctuation">(</span>dirPath <span class="token builtin">string</span><span class="token punctuation">,</span> r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 优先尝试使用 BFQ 调度器 (更好的性能)</span></span>
<span class="line">    <span class="token keyword">var</span> bfq <span class="token operator">*</span>os<span class="token punctuation">.</span>File</span>
<span class="line">    <span class="token keyword">if</span> r<span class="token punctuation">.</span>BlkioWeight <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>BlkioWeightDevice<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> bfq<span class="token punctuation">,</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> <span class="token string">&quot;io.bfq.weight&quot;</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">defer</span> bfq<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置 IO 权重</span></span>
<span class="line">    <span class="token keyword">if</span> r<span class="token punctuation">.</span>BlkioWeight <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> bfq <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 使用 BFQ 调度器</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> bfq<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>strconv<span class="token punctuation">.</span><span class="token function">FormatUint</span><span class="token punctuation">(</span><span class="token function">uint64</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>BlkioWeight<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> err</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 转换为 io.weight 值 (不同的范围)</span></span>
<span class="line">            v <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">ConvertBlkIOToIOWeightValue</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>BlkioWeight<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> <span class="token string">&quot;io.weight&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                strconv<span class="token punctuation">.</span><span class="token function">FormatUint</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> err</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// BlkIO 权重到 IO 权重的转换</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">ConvertBlkIOToIOWeightValue</span><span class="token punctuation">(</span>blkioWeight <span class="token builtin">uint16</span><span class="token punctuation">)</span> <span class="token builtin">uint64</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> blkioWeight <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// weight = (blkioWeight - 10) * 9999 / 990 + 1</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">uint64</span><span class="token punctuation">(</span>blkioWeight<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">9999</span><span class="token operator">/</span><span class="token number">990</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="b-io-限流-throttling" tabindex="-1"><a class="header-anchor" href="#b-io-限流-throttling"><span>B. IO 限流 (Throttling)</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// IO 带宽限制</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setIOThrottle</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 读取带宽限制</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> td <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>BlkioThrottleReadBpsDevice <span class="token punctuation">{</span></span>
<span class="line">        throttleStr <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%d:%d %d&quot;</span><span class="token punctuation">,</span> td<span class="token punctuation">.</span>Major<span class="token punctuation">,</span> td<span class="token punctuation">.</span>Minor<span class="token punctuation">,</span> td<span class="token punctuation">.</span>Rate<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;blkio.throttle.read_bps_device&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">            throttleStr<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 写入带宽限制</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> td <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>BlkioThrottleWriteBpsDevice <span class="token punctuation">{</span></span>
<span class="line">        throttleStr <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%d:%d %d&quot;</span><span class="token punctuation">,</span> td<span class="token punctuation">.</span>Major<span class="token punctuation">,</span> td<span class="token punctuation">.</span>Minor<span class="token punctuation">,</span> td<span class="token punctuation">.</span>Rate<span class="token punctuation">)</span>  </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;blkio.throttle.write_bps_device&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">            throttleStr<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// IOPS 限制</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> td <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>BlkioThrottleReadIOPSDevice <span class="token punctuation">{</span></span>
<span class="line">        throttleStr <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%d:%d %d&quot;</span><span class="token punctuation">,</span> td<span class="token punctuation">.</span>Major<span class="token punctuation">,</span> td<span class="token punctuation">.</span>Minor<span class="token punctuation">,</span> td<span class="token punctuation">.</span>Rate<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;blkio.throttle.read_iops_device&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">            throttleStr<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-4-设备访问控制" tabindex="-1"><a class="header-anchor" href="#_3-4-设备访问控制"><span>3.4 设备访问控制</span></a></h3><h4 id="a-cgroups-v1-设备控制-白名单机制" tabindex="-1"><a class="header-anchor" href="#a-cgroups-v1-设备控制-白名单机制"><span>A. Cgroups v1 设备控制 (白名单机制)</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 设备访问控制的状态机实现</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setV1</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 加载当前设备访问状态</span></span>
<span class="line">    current<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">loadEmulator</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 构建目标状态</span></span>
<span class="line">    target<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">buildEmulator</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Devices<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 计算状态转换规则</span></span>
<span class="line">    transitionRules<span class="token punctuation">,</span> err <span class="token operator">:=</span> current<span class="token punctuation">.</span><span class="token function">Transition</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. 应用转换规则</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> rule <span class="token operator">:=</span> <span class="token keyword">range</span> transitionRules <span class="token punctuation">{</span></span>
<span class="line">        file <span class="token operator">:=</span> <span class="token string">&quot;devices.deny&quot;</span></span>
<span class="line">        <span class="token keyword">if</span> rule<span class="token punctuation">.</span>Allow <span class="token punctuation">{</span></span>
<span class="line">            file <span class="token operator">=</span> <span class="token string">&quot;devices.allow&quot;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        ruleStr <span class="token operator">:=</span> rule<span class="token punctuation">.</span><span class="token function">CgroupString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 格式: &quot;c 1:3 rwm&quot;</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> file<span class="token punctuation">,</span> ruleStr<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to write %s to %s: %w&quot;</span><span class="token punctuation">,</span> ruleStr<span class="token punctuation">,</span> file<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 5. 验证最终状态</span></span>
<span class="line">    currentAfter<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">loadEmulator</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span>target<span class="token punctuation">.</span><span class="token function">IsBlacklist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>reflect<span class="token punctuation">.</span><span class="token function">DeepEqual</span><span class="token punctuation">(</span>currentAfter<span class="token punctuation">,</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;resulting devices cgroup doesn&#39;t precisely match target&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>设备规则格式</strong>：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 设备规则格式: [a|b|c] [major:minor|*] [r][w][m]</span></span>
<span class="line"><span class="token comment"># a: all devices, b: block devices, c: character devices  </span></span>
<span class="line"><span class="token comment"># major:minor: 设备号，* 表示所有</span></span>
<span class="line"><span class="token comment"># r: read, w: write, m: mknod</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 允许访问所有设备 (危险!)</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;a *:* rwm&quot;</span> <span class="token operator">&gt;</span> devices.allow</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 允许读写 /dev/null (1:3)</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;c 1:3 rw&quot;</span> <span class="token operator">&gt;</span> devices.allow  </span>
<span class="line"></span>
<span class="line"><span class="token comment"># 禁止访问所有块设备</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;b *:* rwm&quot;</span> <span class="token operator">&gt;</span> devices.deny</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 允许创建字符设备节点 </span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;c 5:0 m&quot;</span> <span class="token operator">&gt;</span> devices.allow  <span class="token comment"># /dev/tty</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="b-cgroups-v2-设备控制-ebpf-程序" tabindex="-1"><a class="header-anchor" href="#b-cgroups-v2-设备控制-ebpf-程序"><span>B. Cgroups v2 设备控制 (eBPF 程序)</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// v2 使用 eBPF 程序进行设备访问控制</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setV2</span><span class="token punctuation">(</span>dirPath <span class="token builtin">string</span><span class="token punctuation">,</span> r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 生成 eBPF 指令和许可证</span></span>
<span class="line">    insts<span class="token punctuation">,</span> license<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">deviceFilter</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Devices<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 打开 cgroup 目录文件描述符</span></span>
<span class="line">    dirFD<span class="token punctuation">,</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>O_DIRECTORY<span class="token operator">|</span>unix<span class="token punctuation">.</span>O_RDONLY<span class="token punctuation">,</span> <span class="token number">0o600</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;cannot get dir FD for %s&quot;</span><span class="token punctuation">,</span> dirPath<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> unix<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span>dirFD<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 加载和附加 eBPF 程序到 cgroup</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">loadAttachCgroupDeviceFilter</span><span class="token punctuation">(</span>insts<span class="token punctuation">,</span> license<span class="token punctuation">,</span> dirFD<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">canSkipEBPFError</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">// rootless 模式或纯允许规则可以忽略 eBPF 错误</span></span>
<span class="line">        logrus<span class="token punctuation">.</span><span class="token function">WithError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to load eBPF device filter&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 检查是否可以忽略 eBPF 错误</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">canSkipEBPFError</span><span class="token punctuation">(</span>r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// rootless 模式允许忽略 eBPF 错误</span></span>
<span class="line">    <span class="token keyword">if</span> userns<span class="token punctuation">.</span><span class="token function">RunningInUserNS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 如果所有规则都是允许规则且包含 rwm 权限</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> dev <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>Devices <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token operator">!</span>dev<span class="token punctuation">.</span>Allow <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isRWM</span><span class="token punctuation">(</span>dev<span class="token punctuation">.</span>Permissions<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-5-进程数限制-pids" tabindex="-1"><a class="header-anchor" href="#_3-5-进程数限制-pids"><span>3.5 进程数限制 (PIDs)</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 限制 cgroup 中的进程数量</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setPids</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> r<span class="token punctuation">.</span>PidsLimit <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">var</span> limit <span class="token builtin">string</span></span>
<span class="line">        <span class="token keyword">if</span> r<span class="token punctuation">.</span>PidsLimit <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">            limit <span class="token operator">=</span> strconv<span class="token punctuation">.</span><span class="token function">FormatInt</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>PidsLimit<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            limit <span class="token operator">=</span> <span class="token string">&quot;max&quot;</span>  <span class="token comment">// 无限制</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;pids.max&quot;</span><span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-资源统计和监控" tabindex="-1"><a class="header-anchor" href="#_4-资源统计和监控"><span>4. 资源统计和监控</span></a></h2><h3 id="_4-1-统计数据结构" tabindex="-1"><a class="header-anchor" href="#_4-1-统计数据结构"><span>4.1 统计数据结构</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 综合的资源使用统计</span></span>
<span class="line"><span class="token keyword">type</span> Stats <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    CpuStats     CpuStats                <span class="token string">`json:&quot;cpu_stats&quot;`</span></span>
<span class="line">    CPUSetStats  CPUSetStats             <span class="token string">`json:&quot;cpuset_stats&quot;`</span></span>
<span class="line">    MemoryStats  MemoryStats             <span class="token string">`json:&quot;memory_stats&quot;`</span></span>
<span class="line">    PidsStats    PidsStats               <span class="token string">`json:&quot;pids_stats&quot;`</span></span>
<span class="line">    BlkioStats   BlkioStats              <span class="token string">`json:&quot;blkio_stats&quot;`</span></span>
<span class="line">    HugetlbStats <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>HugetlbStats <span class="token string">`json:&quot;hugetlb_stats&quot;`</span></span>
<span class="line">    RdmaStats    RdmaStats               <span class="token string">`json:&quot;rdma_stats&quot;`</span></span>
<span class="line">    MiscStats    <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>MiscStats    <span class="token string">`json:&quot;misc_stats&quot;`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// CPU 使用统计</span></span>
<span class="line"><span class="token keyword">type</span> CpuStats <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    CpuUsage       CpuUsage       <span class="token string">`json:&quot;cpu_usage&quot;`</span></span>
<span class="line">    ThrottlingData ThrottlingData <span class="token string">`json:&quot;throttling_data&quot;`</span></span>
<span class="line">    PSI            <span class="token operator">*</span>PSIStats      <span class="token string">`json:&quot;psi,omitempty&quot;`</span>  <span class="token comment">// 压力失速信息</span></span>
<span class="line">    BurstData      BurstData      <span class="token string">`json:&quot;cpu_burst&quot;`</span>      <span class="token comment">// 突发使用数据</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 内存使用统计</span></span>
<span class="line"><span class="token keyword">type</span> MemoryStats <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Cache              <span class="token builtin">uint64</span>                <span class="token string">`json:&quot;cache&quot;`</span></span>
<span class="line">    Usage              MemoryData            <span class="token string">`json:&quot;usage&quot;`</span></span>
<span class="line">    SwapUsage          MemoryData            <span class="token string">`json:&quot;swap_usage&quot;`</span></span>
<span class="line">    SwapOnlyUsage      MemoryData            <span class="token string">`json:&quot;swap_only_usage&quot;`</span></span>
<span class="line">    KernelUsage        MemoryData            <span class="token string">`json:&quot;kernel_usage&quot;`</span></span>
<span class="line">    KernelTCPUsage     MemoryData            <span class="token string">`json:&quot;kernel_tcp_usage&quot;`</span></span>
<span class="line">    PageUsageByNUMA    PageUsageByNUMA       <span class="token string">`json:&quot;page_usage_by_numa&quot;`</span></span>
<span class="line">    UseHierarchy       <span class="token builtin">bool</span>                  <span class="token string">`json:&quot;use_hierarchy&quot;`</span></span>
<span class="line">    Stats              <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">uint64</span>     <span class="token string">`json:&quot;stats&quot;`</span>  <span class="token comment">// 详细统计</span></span>
<span class="line">    PSI                <span class="token operator">*</span>PSIStats             <span class="token string">`json:&quot;psi,omitempty&quot;`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 压力失速信息 (PSI - Pressure Stall Information)</span></span>
<span class="line"><span class="token keyword">type</span> PSIStats <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Some PSIData <span class="token string">`json:&quot;some&quot;`</span> <span class="token comment">// 某些任务受阻</span></span>
<span class="line">    Full PSIData <span class="token string">`json:&quot;full&quot;`</span> <span class="token comment">// 所有任务受阻  </span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> PSIData <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Avg10  <span class="token builtin">float64</span> <span class="token string">`json:&quot;avg10&quot;`</span>  <span class="token comment">// 10秒平均</span></span>
<span class="line">    Avg60  <span class="token builtin">float64</span> <span class="token string">`json:&quot;avg60&quot;`</span>  <span class="token comment">// 60秒平均</span></span>
<span class="line">    Avg300 <span class="token builtin">float64</span> <span class="token string">`json:&quot;avg300&quot;`</span> <span class="token comment">// 300秒平均</span></span>
<span class="line">    Total  <span class="token builtin">uint64</span>  <span class="token string">`json:&quot;total&quot;`</span>  <span class="token comment">// 总计微秒</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-统计数据收集实现" tabindex="-1"><a class="header-anchor" href="#_4-2-统计数据收集实现"><span>4.2 统计数据收集实现</span></a></h3><h4 id="cgroups-v1-统计收集" tabindex="-1"><a class="header-anchor" href="#cgroups-v1-统计收集"><span>Cgroups v1 统计收集</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// v1 需要从多个子系统收集统计</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">GetStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Stats<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    stats <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">NewStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 遍历所有子系统收集统计</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> sys <span class="token operator">:=</span> <span class="token keyword">range</span> subsystems <span class="token punctuation">{</span></span>
<span class="line">        path <span class="token operator">:=</span> m<span class="token punctuation">.</span>paths<span class="token punctuation">[</span>sys<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">if</span> path <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">continue</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> sys<span class="token punctuation">.</span><span class="token function">GetStats</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> stats<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">Cause</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">continue</span>  <span class="token comment">// 子系统不存在，跳过</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> stats<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// CPU 统计收集示例</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>CpuGroup<span class="token punctuation">)</span> <span class="token function">GetStats</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> stats <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Stats<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// CPU 使用时间统计</span></span>
<span class="line">    <span class="token keyword">if</span> cpuacctUsage<span class="token punctuation">,</span> err <span class="token operator">:=</span> fscommon<span class="token punctuation">.</span><span class="token function">GetCgroupParamUint</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;cpuacct.usage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        stats<span class="token punctuation">.</span>CpuStats<span class="token punctuation">.</span>CpuUsage<span class="token punctuation">.</span>TotalUsage <span class="token operator">=</span> cpuacctUsage</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 分核心 CPU 使用统计</span></span>
<span class="line">    <span class="token keyword">if</span> percpuUsage<span class="token punctuation">,</span> err <span class="token operator">:=</span> fscommon<span class="token punctuation">.</span><span class="token function">ParseCgroupFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;cpuacct.usage_percpu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">for</span> i<span class="token punctuation">,</span> usage <span class="token operator">:=</span> <span class="token keyword">range</span> percpuUsage <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span>CpuStats<span class="token punctuation">.</span>CpuUsage<span class="token punctuation">.</span>PercpuUsage<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> i <span class="token punctuation">{</span></span>
<span class="line">                stats<span class="token punctuation">.</span>CpuStats<span class="token punctuation">.</span>CpuUsage<span class="token punctuation">.</span>PercpuUsage <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span>CpuStats<span class="token punctuation">.</span>CpuUsage<span class="token punctuation">.</span>PercpuUsage<span class="token punctuation">,</span> usage<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                stats<span class="token punctuation">.</span>CpuStats<span class="token punctuation">.</span>CpuUsage<span class="token punctuation">.</span>PercpuUsage<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> usage</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 限流统计</span></span>
<span class="line">    <span class="token keyword">if</span> throttledData<span class="token punctuation">,</span> err <span class="token operator">:=</span> fscommon<span class="token punctuation">.</span><span class="token function">ParseCgroupFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;cpu.stat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        stats<span class="token punctuation">.</span>CpuStats<span class="token punctuation">.</span>ThrottlingData<span class="token punctuation">.</span>Periods <span class="token operator">=</span> throttledData<span class="token punctuation">[</span><span class="token string">&quot;nr_periods&quot;</span><span class="token punctuation">]</span></span>
<span class="line">        stats<span class="token punctuation">.</span>CpuStats<span class="token punctuation">.</span>ThrottlingData<span class="token punctuation">.</span>ThrottledPeriods <span class="token operator">=</span> throttledData<span class="token punctuation">[</span><span class="token string">&quot;nr_throttled&quot;</span><span class="token punctuation">]</span>  </span>
<span class="line">        stats<span class="token punctuation">.</span>CpuStats<span class="token punctuation">.</span>ThrottlingData<span class="token punctuation">.</span>ThrottledTime <span class="token operator">=</span> throttledData<span class="token punctuation">[</span><span class="token string">&quot;throttled_time&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="cgroups-v2-统计收集" tabindex="-1"><a class="header-anchor" href="#cgroups-v2-统计收集"><span>Cgroups v2 统计收集</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// v2 从统一路径收集所有统计</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">GetStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Stats<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> errs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span></span>
<span class="line">    st <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">NewStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 收集各种资源统计</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">statPids</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>dirPath<span class="token punctuation">,</span> st<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">statMemory</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>dirPath<span class="token punctuation">,</span> st<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">statIo</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>dirPath<span class="token punctuation">,</span> st<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">statCpu</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>dirPath<span class="token punctuation">,</span> st<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 收集 PSI (压力失速信息)</span></span>
<span class="line">    <span class="token keyword">if</span> st<span class="token punctuation">.</span>CpuStats<span class="token punctuation">.</span>PSI<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">statPSI</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>dirPath<span class="token punctuation">,</span> <span class="token string">&quot;cpu.pressure&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> st<span class="token punctuation">.</span>MemoryStats<span class="token punctuation">.</span>PSI<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">statPSI</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>dirPath<span class="token punctuation">,</span> <span class="token string">&quot;memory.pressure&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> st<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// PSI 统计收集</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">statPSI</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> file <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>cgroups<span class="token punctuation">.</span>PSIStats<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    data<span class="token punctuation">,</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> file<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    psi <span class="token operator">:=</span> <span class="token operator">&amp;</span>cgroups<span class="token punctuation">.</span>PSIStats<span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 解析格式: &quot;some avg10=0.00 avg60=0.00 avg300=0.00 total=0&quot;</span></span>
<span class="line">    lines <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> line <span class="token operator">:=</span> <span class="token keyword">range</span> lines <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">&quot;some &quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            psi<span class="token punctuation">.</span>Some <span class="token operator">=</span> <span class="token function">parsePSIData</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">&quot;full &quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            psi<span class="token punctuation">.</span>Full <span class="token operator">=</span> <span class="token function">parsePSIData</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> psi<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-性能监控指标解读" tabindex="-1"><a class="header-anchor" href="#_4-3-性能监控指标解读"><span>4.3 性能监控指标解读</span></a></h3><h4 id="a-cpu-监控指标" tabindex="-1"><a class="header-anchor" href="#a-cpu-监控指标"><span>A. CPU 监控指标</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// CPU 使用率计算</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">calculateCPUPercent</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> curr <span class="token operator">*</span>CpuStats<span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> <span class="token punctuation">(</span></span>
<span class="line">        cpuDelta    <span class="token operator">=</span> curr<span class="token punctuation">.</span>CpuUsage<span class="token punctuation">.</span>TotalUsage <span class="token operator">-</span> prev<span class="token punctuation">.</span>CpuUsage<span class="token punctuation">.</span>TotalUsage</span>
<span class="line">        systemDelta <span class="token operator">=</span> curr<span class="token punctuation">.</span>SystemUsage <span class="token operator">-</span> prev<span class="token punctuation">.</span>SystemUsage</span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> systemDelta <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> cpuDelta <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>cpuDelta<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">float64</span><span class="token punctuation">(</span>systemDelta<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">float64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span>CpuUsage<span class="token punctuation">.</span>PercpuUsage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100.0</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0.0</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 限流分析</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">analyzeCPUThrottling</span><span class="token punctuation">(</span>stats <span class="token operator">*</span>CpuStats<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> stats<span class="token punctuation">.</span>ThrottlingData<span class="token punctuation">.</span>Periods <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        throttlePercent <span class="token operator">:=</span> <span class="token function">float64</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span>ThrottlingData<span class="token punctuation">.</span>ThrottledPeriods<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">float64</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span>ThrottlingData<span class="token punctuation">.</span>Periods<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;CPU Throttling: %.2f%% of periods throttled\n&quot;</span><span class="token punctuation">,</span> throttlePercent<span class="token punctuation">)</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Total throttled time: %d ns\n&quot;</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>ThrottlingData<span class="token punctuation">.</span>ThrottledTime<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="b-内存监控指标" tabindex="-1"><a class="header-anchor" href="#b-内存监控指标"><span>B. 内存监控指标</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 内存使用分析</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">analyzeMemoryUsage</span><span class="token punctuation">(</span>stats <span class="token operator">*</span>MemoryStats<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Memory Usage: %d / %d bytes (%.2f%%)\n&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">        stats<span class="token punctuation">.</span>Usage<span class="token punctuation">.</span>Usage<span class="token punctuation">,</span> stats<span class="token punctuation">.</span>Usage<span class="token punctuation">.</span>Limit<span class="token punctuation">,</span></span>
<span class="line">        <span class="token function">float64</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span>Usage<span class="token punctuation">.</span>Usage<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">float64</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span>Usage<span class="token punctuation">.</span>Limit<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Memory Cache: %d bytes\n&quot;</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>Cache<span class="token punctuation">)</span></span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Memory RSS: %d bytes\n&quot;</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>Stats<span class="token punctuation">[</span><span class="token string">&quot;rss&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Memory Swap: %d / %d bytes\n&quot;</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>SwapUsage<span class="token punctuation">.</span>Usage<span class="token punctuation">,</span> stats<span class="token punctuation">.</span>SwapUsage<span class="token punctuation">.</span>Limit<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 内存压力分析</span></span>
<span class="line">    <span class="token keyword">if</span> stats<span class="token punctuation">.</span>PSI <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Memory Pressure: some=%.2f%%, full=%.2f%%\n&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            stats<span class="token punctuation">.</span>PSI<span class="token punctuation">.</span>Some<span class="token punctuation">.</span>Avg60<span class="token punctuation">,</span> stats<span class="token punctuation">.</span>PSI<span class="token punctuation">.</span>Full<span class="token punctuation">.</span>Avg60<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-高级特性和优化" tabindex="-1"><a class="header-anchor" href="#_5-高级特性和优化"><span>5. 高级特性和优化</span></a></h2><h3 id="_5-1-层次结构管理" tabindex="-1"><a class="header-anchor" href="#_5-1-层次结构管理"><span>5.1 层次结构管理</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// cgroup 层次结构的创建和管理</span></span>
<span class="line"><span class="token keyword">type</span> Manager <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    mu      sync<span class="token punctuation">.</span>Mutex</span>
<span class="line">    cgroups <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Cgroup</span>
<span class="line">    paths   <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>  <span class="token comment">// v1: 多路径映射</span></span>
<span class="line">    dirPath <span class="token builtin">string</span>            <span class="token comment">// v2: 单一路径</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 创建 cgroup 层次结构</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">Apply</span><span class="token punctuation">(</span>pid <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 创建 cgroup 目录结构</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">createCgroupPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 设置资源限制</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 将进程加入 cgroup</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">addProcess</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err  </span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">createCgroupPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// v1 需要为每个子系统创建路径</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span>cgroups<span class="token punctuation">.</span><span class="token function">IsCgroup2UnifiedMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">for</span> subsys<span class="token punctuation">,</span> path <span class="token operator">:=</span> <span class="token keyword">range</span> m<span class="token punctuation">.</span>paths <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to create cgroup path %s: %w&quot;</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// v2 只需创建单一路径</span></span>
<span class="line">    <span class="token keyword">return</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>dirPath<span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-动态资源调整" tabindex="-1"><a class="header-anchor" href="#_5-2-动态资源调整"><span>5.2 动态资源调整</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 运行时动态调整资源限制</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">UpdateResources</span><span class="token punctuation">(</span>r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 验证新的资源配置</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">validateResources</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 应用新的资源限制</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 更新内部配置</span></span>
<span class="line">    m<span class="token punctuation">.</span>cgroups<span class="token punctuation">.</span>Resources <span class="token operator">=</span> r</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">validateResources</span><span class="token punctuation">(</span>r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 内存限制不能低于当前使用量</span></span>
<span class="line">    <span class="token keyword">if</span> r<span class="token punctuation">.</span>Memory <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 检查当前内存使用</span></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// CPU 配额合理性检查  </span></span>
<span class="line">    <span class="token keyword">if</span> r<span class="token punctuation">.</span>CpuQuota <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>CpuPeriod <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        cpuRatio <span class="token operator">:=</span> <span class="token function">float64</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>CpuQuota<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">float64</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>CpuPeriod<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> cpuRatio <span class="token operator">&gt;</span> <span class="token function">float64</span><span class="token punctuation">(</span>runtime<span class="token punctuation">.</span><span class="token function">NumCPU</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;CPU quota %.2f exceeds available CPUs %d&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                cpuRatio<span class="token punctuation">,</span> runtime<span class="token punctuation">.</span><span class="token function">NumCPU</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-rootless-容器支持" tabindex="-1"><a class="header-anchor" href="#_5-3-rootless-容器支持"><span>5.3 Rootless 容器支持</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// Rootless 模式的特殊处理</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewRootlessManager</span><span class="token punctuation">(</span>config <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Cgroup<span class="token punctuation">)</span> <span class="token punctuation">(</span>cgroups<span class="token punctuation">.</span>Manager<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 检查 cgroups 委托</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">isValidDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;insufficient cgroups delegation for rootless&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// Rootless 模式下的路径调整</span></span>
<span class="line">    userSlice<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getUserSlice</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    config<span class="token punctuation">.</span>Path <span class="token operator">=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>userSlice<span class="token punctuation">,</span> config<span class="token punctuation">.</span>Path<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> cgroups<span class="token punctuation">.</span><span class="token function">IsCgroup2UnifiedMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fs2<span class="token punctuation">.</span><span class="token function">NewManager</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> config<span class="token punctuation">.</span>Path<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// v1 rootless 支持有限</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;cgroups v1 rootless support is limited&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">isValidDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 检查用户是否有足够的 cgroups 委托权限</span></span>
<span class="line">    delegateFile <span class="token operator">:=</span> <span class="token string">&quot;/sys/fs/cgroup/cgroup.subtree_control&quot;</span></span>
<span class="line">    <span class="token keyword">if</span> data<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>delegateFile<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;memory&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> </span>
<span class="line">               strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;cpu&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-性能优化策略" tabindex="-1"><a class="header-anchor" href="#_5-4-性能优化策略"><span>5.4 性能优化策略</span></a></h3><h4 id="a-批量操作" tabindex="-1"><a class="header-anchor" href="#a-批量操作"><span>A. 批量操作</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 批量设置多个资源参数，减少系统调用</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">SetBatch</span><span class="token punctuation">(</span>r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    operations <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">setCpu</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>path<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">setMemory</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>path<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">setIO</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>path<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">setPids</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>path<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 并发执行，但要处理依赖关系</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> op <span class="token operator">:=</span> <span class="token keyword">range</span> operations <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="b-缓存机制" tabindex="-1"><a class="header-anchor" href="#b-缓存机制"><span>B. 缓存机制</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 统计数据缓存，避免频繁读取文件</span></span>
<span class="line"><span class="token keyword">type</span> cachedStats <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    stats     <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Stats</span>
<span class="line">    timestamp time<span class="token punctuation">.</span>Time</span>
<span class="line">    ttl       time<span class="token punctuation">.</span>Duration</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">GetStatsCached</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Stats<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> m<span class="token punctuation">.</span>cache <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span> <span class="token operator">&lt;</span> m<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>ttl <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> m<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>stats<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    stats<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">GetStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    m<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token operator">&amp;</span>cachedStats<span class="token punctuation">{</span></span>
<span class="line">        stats<span class="token punctuation">:</span>     stats<span class="token punctuation">,</span></span>
<span class="line">        timestamp<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        ttl<span class="token punctuation">:</span>       time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">,</span>  <span class="token comment">// 5秒缓存</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> stats<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-实践练习" tabindex="-1"><a class="header-anchor" href="#_6-实践练习"><span>6. 实践练习</span></a></h2><h3 id="_6-1-基础资源限制实验" tabindex="-1"><a class="header-anchor" href="#_6-1-基础资源限制实验"><span>6.1 基础资源限制实验</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># 实验 1: CPU 限制测试</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 创建测试 cgroup</span></span>
<span class="line"><span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /sys/fs/cgroup/cpu/test-cpu</span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token variable">$$</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /sys/fs/cgroup/cpu/test-cpu/cgroup.procs</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 限制为 0.5 个 CPU 核心</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token number">100000</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /sys/fs/cgroup/cpu/test-cpu/cpu.cfs_period_us</span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token number">50000</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /sys/fs/cgroup/cpu/test-cpu/cpu.cfs_quota_us</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 运行 CPU 密集任务并观察限制效果</span></span>
<span class="line">stress <span class="token parameter variable">--cpu</span> <span class="token number">4</span> <span class="token parameter variable">--timeout</span> 30s <span class="token operator">&amp;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 监控 CPU 使用</span></span>
<span class="line"><span class="token function">watch</span> <span class="token parameter variable">-n</span> <span class="token number">1</span> <span class="token string">&quot;cat /sys/fs/cgroup/cpu/test-cpu/cpuacct.usage &amp;&amp; top -p \<span class="token variable">$!</span>&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash  </span></span>
<span class="line"><span class="token comment"># 实验 2: 内存限制测试</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 创建内存限制 cgroup</span></span>
<span class="line"><span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /sys/fs/cgroup/memory/test-memory</span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token variable">$$</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /sys/fs/cgroup/memory/test-memory/cgroup.procs</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 限制内存为 100MB</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token number">104857600</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /sys/fs/cgroup/memory/test-memory/memory.limit_in_bytes</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 尝试分配 200MB 内存 (应该被 OOM killer 终止)</span></span>
<span class="line">stress <span class="token parameter variable">--vm</span> <span class="token number">1</span> --vm-bytes 200M <span class="token parameter variable">--timeout</span> 10s</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检查 OOM 统计</span></span>
<span class="line"><span class="token function">cat</span> /sys/fs/cgroup/memory/test-memory/memory.oom_control</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-监控脚本开发" tabindex="-1"><a class="header-anchor" href="#_6-2-监控脚本开发"><span>6.2 监控脚本开发</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># cgroup 资源监控脚本</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">CGROUP_PATH</span><span class="token operator">=</span><span class="token string">&quot;/sys/fs/cgroup&quot;</span></span>
<span class="line"><span class="token assign-left variable">CONTAINER_PATH</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$CGROUP_PATH</span>/system.slice/docker-*.scope&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token function-name function">monitor_container</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin class-name">local</span> <span class="token assign-left variable">container_path</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$1</span>&quot;</span></span>
<span class="line">    <span class="token builtin class-name">local</span> <span class="token assign-left variable">container_name</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">basename</span> <span class="token string">&quot;<span class="token variable">$container_path</span>&quot;</span> <span class="token operator">|</span> <span class="token function">cut</span> -d<span class="token string">&#39;-&#39;</span> <span class="token parameter variable">-f2</span> <span class="token operator">|</span> <span class="token function">cut</span> -d<span class="token string">&#39;.&#39;</span> <span class="token parameter variable">-f1</span><span class="token variable">)</span></span></span>
<span class="line">    </span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;=== Container: <span class="token variable">$container_name</span> ===&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># CPU 统计</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-f</span> <span class="token string">&quot;<span class="token variable">$container_path</span>/cpu.stat&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;CPU Stats:&quot;</span></span>
<span class="line">        <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">&quot;(usage_usec|throttled)&quot;</span> <span class="token string">&quot;<span class="token variable">$container_path</span>/cpu.stat&quot;</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">&#39;s/^/  /&#39;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 内存统计  </span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-f</span> <span class="token string">&quot;<span class="token variable">$container_path</span>/memory.current&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;Memory Usage: <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> $container_path/memory.current<span class="token variable">)</span></span> bytes&quot;</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;Memory Limit: <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> $container_path/memory.max<span class="token variable">)</span></span>&quot;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># IO 统计</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-f</span> <span class="token string">&quot;<span class="token variable">$container_path</span>/io.stat&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;IO Stats:&quot;</span></span>
<span class="line">        <span class="token function">head</span> <span class="token parameter variable">-3</span> <span class="token string">&quot;<span class="token variable">$container_path</span>/io.stat&quot;</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">&#39;s/^/  /&#39;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line">    </span>
<span class="line">    <span class="token builtin class-name">echo</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 监控所有容器</span></span>
<span class="line"><span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token for-or-select variable">container_path</span> <span class="token keyword">in</span> <span class="token variable">$CONTAINER_PATH</span><span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">        <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-d</span> <span class="token string">&quot;<span class="token variable">$container_path</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> monitor_container <span class="token string">&quot;<span class="token variable">$container_path</span>&quot;</span></span>
<span class="line">    <span class="token keyword">done</span></span>
<span class="line">    <span class="token function">sleep</span> <span class="token number">5</span></span>
<span class="line"><span class="token keyword">done</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-自定义资源控制" tabindex="-1"><a class="header-anchor" href="#_6-3-自定义资源控制"><span>6.3 自定义资源控制</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 自定义资源管理器示例</span></span>
<span class="line"><span class="token keyword">package</span> main</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;fmt&quot;</span></span>
<span class="line">    <span class="token string">&quot;github.com/opencontainers/cgroups&quot;</span></span>
<span class="line">    <span class="token string">&quot;github.com/opencontainers/cgroups/fs2&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 创建自定义 cgroup 配置</span></span>
<span class="line">    cgroupConfig <span class="token operator">:=</span> <span class="token operator">&amp;</span>cgroups<span class="token punctuation">.</span>Cgroup<span class="token punctuation">{</span></span>
<span class="line">        Path<span class="token punctuation">:</span> <span class="token string">&quot;custom-test&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        Resources<span class="token punctuation">:</span> <span class="token operator">&amp;</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">{</span></span>
<span class="line">            Memory<span class="token punctuation">:</span> <span class="token number">128</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>  <span class="token comment">// 128MB</span></span>
<span class="line">            CpuWeight<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>             <span class="token comment">// CPU 权重</span></span>
<span class="line">            CpuQuota<span class="token punctuation">:</span> <span class="token number">50000</span><span class="token punctuation">,</span>           <span class="token comment">// 0.5 CPU 核心</span></span>
<span class="line">            CpuPeriod<span class="token punctuation">:</span> <span class="token number">100000</span><span class="token punctuation">,</span>         <span class="token comment">// 100ms 周期</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 创建管理器 (自动检测 v1/v2)</span></span>
<span class="line">    manager<span class="token punctuation">,</span> err <span class="token operator">:=</span> fs2<span class="token punctuation">.</span><span class="token function">NewManager</span><span class="token punctuation">(</span>cgroupConfig<span class="token punctuation">,</span> cgroupConfig<span class="token punctuation">.</span>Path<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 应用配置到当前进程</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> manager<span class="token punctuation">.</span><span class="token function">Apply</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">Getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Cgroup applied successfully!&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 运行一些工作负载</span></span>
<span class="line">    <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 获取统计信息</span></span>
<span class="line">    stats<span class="token punctuation">,</span> err <span class="token operator">:=</span> manager<span class="token punctuation">.</span><span class="token function">GetStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;CPU Usage: %d ns\n&quot;</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>CpuStats<span class="token punctuation">.</span>CpuUsage<span class="token punctuation">.</span>TotalUsage<span class="token punctuation">)</span></span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Memory Usage: %d bytes\n&quot;</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>MemoryStats<span class="token punctuation">.</span>Usage<span class="token punctuation">.</span>Usage<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 清理</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> manager<span class="token punctuation">.</span><span class="token function">Destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to cleanup: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 模拟一些 CPU 和内存使用</span></span>
<span class="line">    data <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token comment">// 50MB</span></span>
<span class="line">    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">        data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">byte</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// CPU 密集计算</span></span>
<span class="line">    sum <span class="token operator">:=</span> <span class="token number">0</span></span>
<span class="line">    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">        sum <span class="token operator">+=</span> i</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Work completed, sum: %d\n&quot;</span><span class="token punctuation">,</span> sum<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-故障排除和调试" tabindex="-1"><a class="header-anchor" href="#_7-故障排除和调试"><span>7. 故障排除和调试</span></a></h2><h3 id="_7-1-常见问题诊断" tabindex="-1"><a class="header-anchor" href="#_7-1-常见问题诊断"><span>7.1 常见问题诊断</span></a></h3><h4 id="权限问题" tabindex="-1"><a class="header-anchor" href="#权限问题"><span>权限问题</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 检查 cgroup 挂载情况</span></span>
<span class="line"><span class="token function">mount</span> <span class="token operator">|</span> <span class="token function">grep</span> cgroup</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检查 cgroup 版本</span></span>
<span class="line"><span class="token function">stat</span> <span class="token parameter variable">-fc</span> %T /sys/fs/cgroup/</span>
<span class="line"><span class="token comment"># cgroup2fs = v2, tmpfs = v1</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检查用户权限</span></span>
<span class="line"><span class="token function">ls</span> <span class="token parameter variable">-la</span> /sys/fs/cgroup/user.slice/user-<span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span>.slice/</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检查 systemd 委托</span></span>
<span class="line">systemctl <span class="token parameter variable">--user</span> show-environment</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="资源限制不生效" tabindex="-1"><a class="header-anchor" href="#资源限制不生效"><span>资源限制不生效</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 检查是否正确设置</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;设置的限制:&quot;</span></span>
<span class="line"><span class="token function">cat</span> /sys/fs/cgroup/memory/test/memory.limit_in_bytes</span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;当前使用:&quot;</span>  </span>
<span class="line"><span class="token function">cat</span> /sys/fs/cgroup/memory/test/memory.usage_in_bytes</span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;进程列表:&quot;</span></span>
<span class="line"><span class="token function">cat</span> /sys/fs/cgroup/memory/test/cgroup.procs</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检查内核支持</span></span>
<span class="line"><span class="token function">grep</span> CONFIG_MEMCG /boot/config-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token parameter variable">-r</span><span class="token variable">)</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-性能分析工具" tabindex="-1"><a class="header-anchor" href="#_7-2-性能分析工具"><span>7.2 性能分析工具</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 使用 systemd-cgtop 监控</span></span>
<span class="line">systemd-cgtop</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 使用 htop 查看 cgroup 信息</span></span>
<span class="line"><span class="token function">htop</span> <span class="token parameter variable">-t</span>  <span class="token comment"># 显示进程树</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 使用 perf 分析 cgroup 性能</span></span>
<span class="line">perf record <span class="token parameter variable">-g</span> <span class="token parameter variable">-e</span> cpu-cycles <span class="token parameter variable">--cgroup</span><span class="token operator">=</span>/sys/fs/cgroup/test ./workload</span>
<span class="line">perf report</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-思考题" tabindex="-1"><a class="header-anchor" href="#_8-思考题"><span>8. 思考题</span></a></h2><h3 id="_8-1-架构设计思考" tabindex="-1"><a class="header-anchor" href="#_8-1-架构设计思考"><span>8.1 架构设计思考</span></a></h3><ol><li><p><strong>双版本架构</strong>: 为什么 runc 需要同时支持 cgroups v1 和 v2？两个版本能否统一？</p></li><li><p><strong>资源冲突处理</strong>: 当 CPU 配额和权重同时设置时，内核如何处理优先级？</p></li><li><p><strong>内存交换策略</strong>: 为什么内存限制的设置顺序很重要？如何避免设置冲突？</p></li></ol><h3 id="_8-2-性能优化思考" tabindex="-1"><a class="header-anchor" href="#_8-2-性能优化思考"><span>8.2 性能优化思考</span></a></h3><ol start="4"><li><p><strong>统计收集开销</strong>: 频繁读取 cgroup 统计文件对性能有什么影响？如何优化？</p></li><li><p><strong>批量操作</strong>: 哪些 cgroup 操作可以批量执行？如何设计批量接口？</p></li><li><p><strong>缓存策略</strong>: cgroup 路径和文件描述符应该如何缓存？什么时候失效？</p></li></ol><h3 id="_8-3-实际应用思考" tabindex="-1"><a class="header-anchor" href="#_8-3-实际应用思考"><span>8.3 实际应用思考</span></a></h3><ol start="7"><li><p><strong>动态调整</strong>: 如何在不重启容器的情况下安全地调整资源限制？</p></li><li><p><strong>资源超售</strong>: 在资源超售的情况下，如何设计合理的资源分配策略？</p></li><li><p><strong>多租户隔离</strong>: 如何使用 cgroups 实现多租户之间的资源隔离？</p></li></ol><h2 id="_9-扩展阅读" tabindex="-1"><a class="header-anchor" href="#_9-扩展阅读"><span>9. 扩展阅读</span></a></h2><h3 id="_9-1-内核文档" tabindex="-1"><a class="header-anchor" href="#_9-1-内核文档"><span>9.1 内核文档</span></a></h3><ul><li><a href="https://www.kernel.org/doc/Documentation/admin-guide/cgroup-v2.rst" target="_blank" rel="noopener noreferrer">Control Group v2<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://www.kernel.org/doc/Documentation/cgroup-v1/" target="_blank" rel="noopener noreferrer">Control Group v1<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://www.kernel.org/doc/Documentation/scheduler/sched-bwc.txt" target="_blank" rel="noopener noreferrer">CPU Bandwidth Control<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://www.kernel.org/doc/Documentation/cgroup-v1/memory.txt" target="_blank" rel="noopener noreferrer">Memory Resource Controller<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h3 id="_9-2-实践指南" tabindex="-1"><a class="header-anchor" href="#_9-2-实践指南"><span>9.2 实践指南</span></a></h3><ul><li><a href="https://www.slideshare.net/jpetazzo/cgroups-namespaces-and-beyond-what-are-containers-made-from-dockercon-europe-2015" target="_blank" rel="noopener noreferrer">Cgroups, namespaces and beyond<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/managing_monitoring_and_updating_the_kernel/using-control-groups_managing-monitoring-and-updating-the-kernel" target="_blank" rel="noopener noreferrer">Understanding cgroups<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://systemd.io/CGROUP_DELEGATION/" target="_blank" rel="noopener noreferrer">Systemd and cgroups<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h3 id="_9-3-工具和监控" tabindex="-1"><a class="header-anchor" href="#_9-3-工具和监控"><span>9.3 工具和监控</span></a></h3><ul><li><a href="https://github.com/google/cadvisor" target="_blank" rel="noopener noreferrer">cAdvisor - Container monitoring<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://www.freedesktop.org/software/systemd/man/systemd-cgtop.html" target="_blank" rel="noopener noreferrer">systemd-cgtop<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/cloudera/cgroupspy" target="_blank" rel="noopener noreferrer">cgroupspy - Python cgroups interface<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h2 id="🎯-模块总结" tabindex="-1"><a class="header-anchor" href="#🎯-模块总结"><span>🎯 模块总结</span></a></h2><p>通过本模块的学习，你应该已经掌握了：</p><p>✅ <strong>Cgroups 基础架构</strong>：理解 v1/v2 差异和层次结构管理<br> ✅ <strong>资源控制机制</strong>：掌握 CPU、内存、IO、设备控制的实现原理<br> ✅ <strong>统计监控系统</strong>：理解资源使用统计和性能指标分析<br> ✅ <strong>高级特性应用</strong>：掌握动态调整、Rootless 支持等高级功能<br> ✅ <strong>故障排除能力</strong>：具备 cgroups 问题诊断和性能调优技能</p><p><strong>下一步</strong>: 进入 <a class="route-link" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html">模块 5: 文件系统与挂载管理</a>，学习容器文件系统隔离和挂载机制。</p></div></div><footer class="page-meta"><div class="meta-item edit-link"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M2 26h28v2H2z" fill="currentColor"></path><path d="M25.4 9c.8-.8.8-2 0-2.8l-3.6-3.6c-.8-.8-2-.8-2.8 0l-15 15V24h6.4l15-15zm-5-5L24 7.6l-3 3L17.4 7l3-3zM6 22v-3.6l10-10l3.6 3.6l-10 10H6z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Edit this page<!--]--></span></span></div><div class="meta-item last-updated"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->更新于 8/6/2025, 6:07:26 PM<!--]--></span></span></div></footer><!----><div class="reco-valine-wrapper"><div id="valine"></div></div></div><div class="page-catalog-container"><h5 class="tip">目录</h5><ul><!--[--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#概述" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="概述"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->概述<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#🎯-学习目标" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="🎯 学习目标"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->🎯 学习目标<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_1-cgroups-基础概念" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1. Cgroups 基础概念"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1. Cgroups 基础概念<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_1-1-什么是-cgroups" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1.1 什么是 Cgroups？"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1.1 什么是 Cgroups？<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_1-2-cgroups-层次结构" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1.2 Cgroups 层次结构"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1.2 Cgroups 层次结构<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_2-cgroups-v1-vs-v2-架构差异" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2. Cgroups v1 vs v2 架构差异"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2. Cgroups v1 vs v2 架构差异<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_2-1-架构对比图" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.1 架构对比图"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.1 架构对比图<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_2-2-核心差异对比" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.2 核心差异对比"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.2 核心差异对比<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_2-3-runc-的实现适配" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.3 runc 的实现适配"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.3 runc 的实现适配<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_3-核心资源控制机制" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3. 核心资源控制机制"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3. 核心资源控制机制<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_3-1-cpu-资源控制" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.1 CPU 资源控制"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.1 CPU 资源控制<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_3-2-内存资源控制" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.2 内存资源控制"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.2 内存资源控制<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_3-3-io-资源控制" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.3 IO 资源控制"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.3 IO 资源控制<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_3-4-设备访问控制" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.4 设备访问控制"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.4 设备访问控制<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_3-5-进程数限制-pids" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.5 进程数限制 (PIDs)"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.5 进程数限制 (PIDs)<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_4-资源统计和监控" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4. 资源统计和监控"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4. 资源统计和监控<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_4-1-统计数据结构" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4.1 统计数据结构"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4.1 统计数据结构<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_4-2-统计数据收集实现" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4.2 统计数据收集实现"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4.2 统计数据收集实现<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_4-3-性能监控指标解读" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4.3 性能监控指标解读"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4.3 性能监控指标解读<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_5-高级特性和优化" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5. 高级特性和优化"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5. 高级特性和优化<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_5-1-层次结构管理" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.1 层次结构管理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.1 层次结构管理<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_5-2-动态资源调整" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.2 动态资源调整"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.2 动态资源调整<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_5-3-rootless-容器支持" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.3 Rootless 容器支持"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.3 Rootless 容器支持<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_5-4-性能优化策略" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.4 性能优化策略"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.4 性能优化策略<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_6-实践练习" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6. 实践练习"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6. 实践练习<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_6-1-基础资源限制实验" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6.1 基础资源限制实验"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6.1 基础资源限制实验<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_6-2-监控脚本开发" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6.2 监控脚本开发"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6.2 监控脚本开发<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_6-3-自定义资源控制" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6.3 自定义资源控制"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6.3 自定义资源控制<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_7-故障排除和调试" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7. 故障排除和调试"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7. 故障排除和调试<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_7-1-常见问题诊断" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7.1 常见问题诊断"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7.1 常见问题诊断<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_7-2-性能分析工具" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7.2 性能分析工具"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7.2 性能分析工具<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_8-思考题" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8. 思考题"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8. 思考题<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_8-1-架构设计思考" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8.1 架构设计思考"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8.1 架构设计思考<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_8-2-性能优化思考" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8.2 性能优化思考"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8.2 性能优化思考<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_8-3-实际应用思考" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8.3 实际应用思考"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8.3 实际应用思考<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_9-扩展阅读" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9. 扩展阅读"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9. 扩展阅读<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_9-1-内核文档" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9.1 内核文档"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9.1 内核文档<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_9-2-实践指南" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9.2 实践指南"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9.2 实践指南<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#_9-3-工具和监控" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9.3 工具和监控"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9.3 工具和监控<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html#🎯-模块总结" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="🎯 模块总结"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->🎯 模块总结<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--></ul></div></main><!--]--></div></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/blog/assets/app-2O6audqE.js" defer></script>
  </body>
</html>

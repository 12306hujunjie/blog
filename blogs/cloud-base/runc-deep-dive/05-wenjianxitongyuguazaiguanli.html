<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-rc.19">
    <script>
      (function() {
        const userMode = localStorage.getItem('vuepress-reco-color-scheme') || 'auto';
        const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (userMode === 'dark' || (userMode === 'auto' && systemDarkMode)) {
          document.documentElement.classList.toggle('dark', true);
        }
      })();
    </script>
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.min.js" as="script"><title>文件系统与挂载管理 | database of memory</title><meta name="description" content="study anything and life record">
    <link rel="preload" href="/blog/assets/style-3Js8NCR5.css" as="style"><link rel="stylesheet" href="/blog/assets/style-3Js8NCR5.css">
    <link rel="modulepreload" href="/blog/assets/app-6X7aTgdN.js"><link rel="modulepreload" href="/blog/assets/05-wenjianxitongyuguazaiguanli.html-CqMH5NWU.js">
    <link rel="prefetch" href="/blog/assets/timeline.html-DqGpz6zD.js" as="script"><link rel="prefetch" href="/blog/assets/posts.html-D7Bvy0d7.js" as="script"><link rel="prefetch" href="/blog/assets/friendship-link.html-BeuJvd9N.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Chuj08UQ.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CAiUFWts.js" as="script"><link rel="prefetch" href="/blog/assets/2.html-D37ih9Uu.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B7r5o5tl.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bk-Ur-c2.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BoqA-Ln0.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CePHWKeW.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DrJSOmlA.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-U1rZfE85.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CTD9OTnI.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-ClxupEHP.js" as="script"><link rel="prefetch" href="/blog/assets/2.html-qlkAfAwM.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bcv-xUWV.js" as="script"><link rel="prefetch" href="/blog/assets/2.html-k8qqQK3e.js" as="script"><link rel="prefetch" href="/blog/assets/3.html-CDYIBSbu.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-C9Nfp7Ay.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CjHzGOJ-.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CYNCZ_rK.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BcBA7pf2.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bs4xEXI5.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-M__IdVLb.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BH3X1mh_.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BHb1grF4.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Brifmhtt.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-qwpDWejy.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-C1gJL2lV.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-U6_-H0Sh.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-LhfHHy5S.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-C-LkskE-.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DmhkJd-t.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BCtbHwdB.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DiSqFikV.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Ggy9-9RW.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DHzX2MiW.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Y_MjXMva.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dfh-jUGd.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dj3i--SL.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-jFYTncAL.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CEVzFokr.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CQO4krTi.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-kJCQem_o.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CptdwrQ-.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BZ8F9Q78.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CO2Lqb20.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B3vfuGqd.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D0Hq0dy6.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BaR09h1V.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B0dHEN0C.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DxeVe2QE.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B-kJe58I.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-bmqWX6zb.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BebdTN1L.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BwMJ76N1.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CTduS54Q.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dcc4oMtL.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Cuqf1HeB.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D7mC1WDN.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-v6nZ1ZWL.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BPZMg7Ne.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DxoNufPU.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BZBwiKs9.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-C_-Xixh1.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BnQNYAZB.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BE0yJYJV.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CEWENM8H.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-XtMtCj0R.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CrwupWzR.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CWANwt8I.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-0cS3PG1a.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-SjppBNSL.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CHykDJHD.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dtk_YvDI.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-fpyujYmI.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BFxeIDyb.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CKHvNVKM.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DIUFuATR.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BtIyxRUq.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D4v3h6Vg.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-FIb6d2j_.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BaLNiMq6.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bdo9dHNd.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-1AGwP5Te.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CKMLoDjE.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BJHQObic.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BCpqeqgO.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-jC2ZrfN-.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-vWaMPMS8.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BEVoBKhp.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Do1Zlsl6.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CPVc_dd4.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DWViIrax.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-RQjr3Fnf.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-dD1j4CIg.js" as="script"><link rel="prefetch" href="/blog/assets/2.html-CS7SB9DU.js" as="script"><link rel="prefetch" href="/blog/assets/3.html-ft_1EMsZ.js" as="script"><link rel="prefetch" href="/blog/assets/4.html-QiRa9oJ7.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BAQynWuW.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-KC4P4b0V.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BE8vwrI8.js" as="script"><link rel="prefetch" href="/blog/assets/bitwise_operation.html-CGQUwYxj.js" as="script"><link rel="prefetch" href="/blog/assets/learning_algorithm.html-DI9nJoC0.js" as="script"><link rel="prefetch" href="/blog/assets/cache_pattern.html-Dl3pGg-V.js" as="script"><link rel="prefetch" href="/blog/assets/docker_tech.html-C6Pxm_Pq.js" as="script"><link rel="prefetch" href="/blog/assets/k3s.html-SJowENbd.js" as="script"><link rel="prefetch" href="/blog/assets/k3s_k8s_ingress.html-BLEzHFNF.js" as="script"><link rel="prefetch" href="/blog/assets/oci-01-intro-guide.html-DPFVTs4y.js" as="script"><link rel="prefetch" href="/blog/assets/oci-02-runtime-spec.html-qS0CXXyx.js" as="script"><link rel="prefetch" href="/blog/assets/oci-03-image-spec.html-TDvk0Tea.js" as="script"><link rel="prefetch" href="/blog/assets/oci-04-distribution-spec.html-6IAzcDD0.js" as="script"><link rel="prefetch" href="/blog/assets/oci-05-security-guide.html-Cc6Cssbq.js" as="script"><link rel="prefetch" href="/blog/assets/oci-06-monitoring-guide.html-CvtfFvF0.js" as="script"><link rel="prefetch" href="/blog/assets/oci-07-production-guide.html-n2TaAX2U.js" as="script"><link rel="prefetch" href="/blog/assets/oci-08-hooks-deep-dive.html-C7B2kQ6J.js" as="script"><link rel="prefetch" href="/blog/assets/oci-linux-configurations-blog.html-DwrOQxhi.js" as="script"><link rel="prefetch" href="/blog/assets/oci-series-index.html-DRCITB_S.js" as="script"><link rel="prefetch" href="/blog/assets/runc-container-lifecycle-diagrams.html-BAc1MNwt.js" as="script"><link rel="prefetch" href="/blog/assets/linux_namespace.html-jiIEKnFi.js" as="script"><link rel="prefetch" href="/blog/assets/python_checklist.html-s6uOrY8u.js" as="script"><link rel="prefetch" href="/blog/assets/python_env_manage.html-BSV_lFtV.js" as="script"><link rel="prefetch" href="/blog/assets/gevent.html-CA1arPDM.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DkNYT3Zm.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-D9psQpTb.js" as="script"><link rel="prefetch" href="/blog/assets/fullstack.html-Dv-FNS3q.js" as="script"><link rel="prefetch" href="/blog/assets/sort_1.html-W70lVzfg.js" as="script"><link rel="prefetch" href="/blog/assets/01-runcgaishuyujiagou.html-QDM-MnSj.js" as="script"><link rel="prefetch" href="/blog/assets/02-rongqishengmingzhouqiguanli.html-0v7Ls9cX.js" as="script"><link rel="prefetch" href="/blog/assets/03-Namespacegelishixian.html-Dg1Vp7rK.js" as="script"><link rel="prefetch" href="/blog/assets/04-Cgroupsziyuanguanli.html-BgjFfgpp.js" as="script"><link rel="prefetch" href="/blog/assets/06-anquantexingshixian.html-CVCalXw5.js" as="script"><link rel="prefetch" href="/blog/assets/07-CRIUjianchadianyuhuifu.html-DliOwtSW.js" as="script"><link rel="prefetch" href="/blog/assets/08-tongxinyujiankongxitong.html-CGPnknuZ.js" as="script"><link rel="prefetch" href="/blog/assets/09-goujianjianhuarongqiyunxingshi.html-CpW0Ergx.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CEju9IkR.js" as="script"><link rel="prefetch" href="/blog/assets/python-async-mastery.html-CSosiE7a.js" as="script"><link rel="prefetch" href="/blog/assets/abstract_factory.html-CUp2rgGA.js" as="script"><link rel="prefetch" href="/blog/assets/factory_method.html-COdBv8o2.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Cpj7w3BK.js" as="script"><link rel="prefetch" href="/blog/assets/adapter.html-BkNp5Tfd.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-hxa3gNLp.js" as="script"><link rel="prefetch" href="/blog/assets/Valine.min-VCLvSWzF.js" as="script"><link rel="prefetch" href="/blog/assets/giscus-aTimukGI-DWEKOTfS.js" as="script"><link rel="prefetch" href="/blog/assets/KnowledgeMap-CVNiRhtZ.js" as="script"><link rel="prefetch" href="/blog/assets/MermaidChart-z8ABlZRz.js" as="script"><link rel="prefetch" href="/blog/assets/mermaid.core-9NKgZvfC.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container series--no show-catalog"><header class="navbar-container not-open"><div class="navbar-inner"><div class="site-brand nav-item"><img class="logo" src="/blog/logo.png" alt="database of memory"><a href="/blog/" class="site-name can-hide">database of memory</a></div><div class="nav-item navbar-links-wrapper" style=""><div><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div><nav class="navbar-links"><!--[--><div class="navbar-links__item"><a href="/blog/" class="link" aria-label="Home"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Home<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/blog/categories/cloud-base/1/" class="link" aria-label="Categories"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Categories<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/blog/tags/runc/1/" class="link" aria-label="Tags"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Tags<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/blog/knowledge-map/" class="link" aria-label="知识地图"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->知识地图<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="Docs"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Docs<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="Docs"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Docs<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/blog/docs/leetcode/" class="link" aria-label="leetcode from scratch"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->leetcode from scratch<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/docs/design_pattern/" class="link" aria-label="design pattern"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->design pattern<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--><!----><span class="xicon-container btn-toggle-dark-mode btn--dark-mode navbar-links__item"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><path d="M15 2h2v3h-2z" fill="currentColor"></path><path d="M27 15h3v2h-3z" fill="currentColor"></path><path d="M15 27h2v3h-2z" fill="currentColor"></path><path d="M2 15h3v2H2z" fill="currentColor"></path><path d="M5.45 6.884l1.414-1.415l2.121 2.122l-1.414 1.414z" fill="currentColor"></path><path d="M23 7.58l2.121-2.12l1.414 1.414l-2.121 2.121z" fill="currentColor"></path><path d="M23.002 24.416l1.415-1.414l2.12 2.122l-1.413 1.414z" fill="currentColor"></path><path d="M5.47 25.13L7.59 23L9 24.42l-2.12 2.12l-1.41-1.41z" fill="currentColor"></path><path d="M16 8a8 8 0 1 0 8 8a8 8 0 0 0-8-8zm0 14a6 6 0 0 1 0-12z" fill="currentColor"></path></svg></span><ul class="social-links navbar-links__item"><!--[--><li class="social-item"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:25px;height:25px;"><path d="M16 2a14 14 0 0 0-4.43 27.28c.7.13 1-.3 1-.67v-2.38c-3.89.84-4.71-1.88-4.71-1.88a3.71 3.71 0 0 0-1.62-2.05c-1.27-.86.1-.85.1-.85a2.94 2.94 0 0 1 2.14 1.45a3 3 0 0 0 4.08 1.16a2.93 2.93 0 0 1 .88-1.87c-3.1-.36-6.37-1.56-6.37-6.92a5.4 5.4 0 0 1 1.44-3.76a5 5 0 0 1 .14-3.7s1.17-.38 3.85 1.43a13.3 13.3 0 0 1 7 0c2.67-1.81 3.84-1.43 3.84-1.43a5 5 0 0 1 .14 3.7a5.4 5.4 0 0 1 1.44 3.76c0 5.38-3.27 6.56-6.39 6.91a3.33 3.33 0 0 1 .95 2.59v3.84c0 .46.25.81 1 .67A14 14 0 0 0 16 2z" fill-rule="evenodd" fill="currentColor"></path></svg></li><!--]--></ul></nav><span class="xicon-container btn-toggle-menus"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><circle cx="16" cy="8" r="2" fill="currentColor"></circle><circle cx="16" cy="16" r="2" fill="currentColor"></circle><circle cx="16" cy="24" r="2" fill="currentColor"></circle></svg></span></div></div></header><!----><!----><!----><div class="theme-main" style=""><!----><!--[--><main class="page-container"><div class="page-content"><h1 class="page-title">文件系统与挂载管理</h1><div class="page-info"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M16 4a5 5 0 1 1-5 5a5 5 0 0 1 5-5m0-2a7 7 0 1 0 7 7a7 7 0 0 0-7-7z" fill="currentColor"></path><path d="M26 30h-2v-5a5 5 0 0 0-5-5h-6a5 5 0 0 0-5 5v5H6v-5a7 7 0 0 1 7-7h6a7 7 0 0 1 7 7z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->hujunjie<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2025-08-05<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M11.17 6l3.42 3.41l.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[--><!--[--><a href="/blog/categories/cloud-base/runc-deep-dive/1.html" class="">cloud-base/runc-deep-dive</a><!--]--><!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M10 14a4 4 0 1 1 4-4a4.005 4.005 0 0 1-4 4zm0-6a2 2 0 1 0 1.998 2.004A2.002 2.002 0 0 0 10 8z" fill="currentColor"></path><path d="M16.644 29.415L2.586 15.354A2 2 0 0 1 2 13.941V4a2 2 0 0 1 2-2h9.941a2 2 0 0 1 1.414.586l14.06 14.058a2 2 0 0 1 0 2.828l-9.943 9.943a2 2 0 0 1-2.829 0zM4 4v9.942L18.058 28L28 18.058L13.942 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[--><!--[--><a href="/blog/tags/runc/1.html" class="">runc</a><a href="/blog/tags/yunyuansheng/1.html" class="">云原生</a><a href="/blog/tags/wenjianxitong/1.html" class="">文件系统</a><!--]--><!--]--></span></span><!----></div><div class="theme-reco-md-content"><div><h1 id="文件系统与挂载管理" tabindex="-1"><a class="header-anchor" href="#文件系统与挂载管理"><span>文件系统与挂载管理</span></a></h1><blockquote><p><strong>系列导航：</strong> <a class="route-link" href="/blog/blogs/cloud-base/runc-deep-dive/">runc 容器运行时深度解析系列</a> → 第五篇：文件系统与挂载管理<br><strong>上一篇：</strong> <a class="route-link" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html">Cgroups资源管理</a><br><strong>最后更新：</strong> 2024</p></blockquote><h2 id="概述" tabindex="-1"><a class="header-anchor" href="#概述"><span>概述</span></a></h2><p>本文深入分析 runc 如何管理容器的文件系统和挂载点。包括 rootfs 的准备和切换、挂载点的创建和管理，以及挂载传播等高级特性。</p><h2 id="🎯-学习目标" tabindex="-1"><a class="header-anchor" href="#🎯-学习目标"><span>🎯 学习目标</span></a></h2><p>完成本模块后，你将能够：</p><ul><li>深入理解容器 rootfs 准备和切换的完整机制</li><li>掌握 runc 中各种挂载类型的处理逻辑和安全策略</li><li>理解 Mount Namespace 与文件系统隔离的实现原理</li><li>熟悉 bind mount、overlay、特殊文件系统的应用场景</li><li>具备排查容器文件系统问题和优化挂载配置的能力</li></ul><h2 id="_1-容器文件系统基础" tabindex="-1"><a class="header-anchor" href="#_1-容器文件系统基础"><span>1. 容器文件系统基础</span></a></h2><h3 id="_1-1-什么是容器文件系统" tabindex="-1"><a class="header-anchor" href="#_1-1-什么是容器文件系统"><span>1.1 什么是容器文件系统？</span></a></h3><p>容器文件系统是为容器进程提供隔离文件视图的核心机制。它通过 <strong>rootfs 切换</strong> + <strong>挂载管理</strong> + <strong>文件系统隔离</strong> 实现完整的文件系统虚拟化。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">宿主机文件系统                   容器文件系统视图</span>
<span class="line">┌─────────────────────┐         ┌─────────────────────┐</span>
<span class="line">│ /                   │   变换   │ /                   │</span>
<span class="line">│ ├── bin/            │  ────→  │ ├── bin/            │ (来自镜像)</span>
<span class="line">│ ├── etc/            │         │ ├── etc/            │ (来自镜像)</span>
<span class="line">│ ├── home/           │         │ ├── home/           │ (来自挂载)</span>
<span class="line">│ ├── proc/           │         │ ├── proc/           │ (容器proc)</span>
<span class="line">│ └── var/containers/ │         │ ├── tmp/            │ (tmpfs)</span>
<span class="line">│     └── rootfs/     │         │ └── dev/            │ (设备节点)</span>
<span class="line">└─────────────────────┘         └─────────────────────┘</span>
<span class="line">      宿主机视图                      容器内视图</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>核心组件</strong>：</p><ul><li>🏠 <strong>Rootfs</strong>: 容器的根文件系统，通常来自镜像</li><li>🔗 <strong>Bind Mounts</strong>: 将宿主机目录映射到容器内</li><li>💾 <strong>Tmpfs</strong>: 临时内存文件系统</li><li>⚙️ <strong>Special FS</strong>: proc、sys、dev 等特殊文件系统</li></ul><h3 id="_1-2-文件系统隔离层次" tabindex="-1"><a class="header-anchor" href="#_1-2-文件系统隔离层次"><span>1.2 文件系统隔离层次</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">┌─────────────────────────────────────────────────┐</span>
<span class="line">│              应用进程视图                       │</span>
<span class="line">├─────────────────────────────────────────────────┤</span>
<span class="line">│           容器挂载命名空间                      │</span>
<span class="line">│  ┌─────────────────────────────────────────┐    │</span>
<span class="line">│  │          /                              │    │</span>
<span class="line">│  │  ├── bin/ (来自镜像层)                  │    │ </span>
<span class="line">│  │  ├── etc/ (来自镜像层)                  │    │</span>
<span class="line">│  │  ├── proc/ (容器专属procfs)             │    │</span>
<span class="line">│  │  ├── tmp/ (tmpfs内存文件系统)           │    │</span>
<span class="line">│  │  └── app/ (bind mount宿主机目录)        │    │</span>
<span class="line">│  └─────────────────────────────────────────┘    │</span>
<span class="line">├─────────────────────────────────────────────────┤</span>
<span class="line">│                宿主机内核                       │</span>
<span class="line">│  ┌─────────────────┬─────────────────────────┐   │</span>
<span class="line">│  │  真实文件系统   │   虚拟文件系统 (VFS)   │   │</span>
<span class="line">│  │   (ext4/xfs)    │   (proc/sys/tmpfs)     │   │</span>
<span class="line">│  └─────────────────┴─────────────────────────┘   │</span>
<span class="line">└─────────────────────────────────────────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-rootfs-准备和切换机制" tabindex="-1"><a class="header-anchor" href="#_2-rootfs-准备和切换机制"><span>2. Rootfs 准备和切换机制</span></a></h2><h3 id="_2-1-整体流程架构" tabindex="-1"><a class="header-anchor" href="#_2-1-整体流程架构"><span>2.1 整体流程架构</span></a></h3><p>runc 的文件系统初始化遵循 <strong>准备</strong> → <strong>挂载</strong> → <strong>切换</strong> → <strong>加固</strong> 的四阶段流程：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">用户执行: runc create mycontainer</span>
<span class="line">           │</span>
<span class="line">           ▼</span>
<span class="line">┌─────────────────────────────────────────────────┐</span>
<span class="line">│  阶段1: prepareRoot - 根挂载点预处理            │</span>
<span class="line">│  - 设置挂载传播属性                             │</span>
<span class="line">│  - 确保父挂载点私有化                           │</span>
<span class="line">│  - 自绑定rootfs准备pivot_root                   │</span>
<span class="line">└─────────────┬───────────────────────────────────┘</span>
<span class="line">              │</span>
<span class="line">              ▼</span>
<span class="line">┌─────────────────────────────────────────────────┐</span>
<span class="line">│  阶段2: prepareRootfs - 挂载处理                │</span>
<span class="line">│  - 处理所有OCI配置的挂载点                      │</span>
<span class="line">│  - 创建设备节点和符号链接                       │</span>
<span class="line">│  - 处理特殊文件系统(proc/sys/cgroup)            │</span>
<span class="line">└─────────────┬───────────────────────────────────┘</span>
<span class="line">              │</span>
<span class="line">              ▼</span>
<span class="line">┌─────────────────────────────────────────────────┐</span>
<span class="line">│  阶段3: pivotRoot/msMoveRoot - 根文件系统切换   │</span>
<span class="line">│  - pivot_root(): 标准切换方式                   │</span>
<span class="line">│  - MS_MOVE: --no-pivot-root 选项               │</span>
<span class="line">│  - chroot(): 传统方式(无mount namespace)        │</span>
<span class="line">└─────────────┬───────────────────────────────────┘</span>
<span class="line">              │</span>
<span class="line">              ▼</span>
<span class="line">┌─────────────────────────────────────────────────┐</span>
<span class="line">│  阶段4: finalizeRootfs - 安全加固               │</span>
<span class="line">│  - 重新挂载tmpfs/dev为只读                      │</span>
<span class="line">│  - 设置根文件系统只读                           │</span>
<span class="line">│  - 应用umask权限设置                            │</span>
<span class="line">└─────────────────────────────────────────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-prepareroot-根挂载点预处理" tabindex="-1"><a class="header-anchor" href="#_2-2-prepareroot-根挂载点预处理"><span>2.2 prepareRoot - 根挂载点预处理</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/rootfs_linux.go:97</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">prepareRoot</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 设置根挂载传播属性</span></span>
<span class="line">    flag <span class="token operator">:=</span> unix<span class="token punctuation">.</span>MS_SLAVE <span class="token operator">|</span> unix<span class="token punctuation">.</span>MS_REC  <span class="token comment">// 默认为slave递归</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>RootPropagation <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        flag <span class="token operator">=</span> config<span class="token punctuation">.</span>RootPropagation    <span class="token comment">// 用户自定义传播属性</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 在根目录上应用传播属性</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set root mount propagation: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 确保rootfs父挂载点是私有的</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">rootfsParentMountPrivate</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Rootfs<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 递归绑定挂载rootfs到自身，为pivot_root做准备</span></span>
<span class="line">    <span class="token comment">// 这一步是关键：使rootfs成为独立的挂载点</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">mount</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Rootfs<span class="token punctuation">,</span> config<span class="token punctuation">.</span>Rootfs<span class="token punctuation">,</span> <span class="token string">&quot;bind&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                unix<span class="token punctuation">.</span>MS_BIND<span class="token operator">|</span>unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>挂载传播属性解释</strong>：</p><table><thead><tr><th>传播类型</th><th>含义</th><th>应用场景</th></tr></thead><tbody><tr><td><strong>MS_PRIVATE</strong></td><td>私有，挂载不传播</td><td>完全隔离容器挂载</td></tr><tr><td><strong>MS_SLAVE</strong></td><td>从属，只接收不发送</td><td>接收宿主机挂载，但不影响宿主机</td></tr><tr><td><strong>MS_SHARED</strong></td><td>共享，双向传播</td><td>容器与宿主机共享挂载变更</td></tr><tr><td><strong>MS_UNBINDABLE</strong></td><td>不可绑定</td><td>防止挂载点被bind</td></tr></tbody></table><h3 id="_2-3-三种根文件系统切换方式" tabindex="-1"><a class="header-anchor" href="#_2-3-三种根文件系统切换方式"><span>2.3 三种根文件系统切换方式</span></a></h3><h4 id="a-pivot-root-方式-标准方式" tabindex="-1"><a class="header-anchor" href="#a-pivot-root-方式-标准方式"><span>A. pivot_root 方式 (标准方式)</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/rootfs_linux.go:128</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">pivotRoot</span><span class="token punctuation">(</span>rootfs <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 打开旧根和新根的文件描述符</span></span>
<span class="line">    oldroot<span class="token punctuation">,</span> err <span class="token operator">:=</span> linux<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>O_DIRECTORY<span class="token operator">|</span>unix<span class="token punctuation">.</span>O_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> oldroot<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    newroot<span class="token punctuation">,</span> err <span class="token operator">:=</span> linux<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>rootfs<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>O_DIRECTORY<span class="token operator">|</span>unix<span class="token punctuation">.</span>O_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> newroot<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 切换到新根目录</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Fchdir</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>newroot<span class="token punctuation">.</span><span class="token function">Fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 执行pivot_root系统调用</span></span>
<span class="line">    <span class="token comment">// 技巧：pivot_root(&quot;.&quot;, &quot;.&quot;) - 来自LXC开发者的智慧</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">PivotRoot</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;pivot_root failed: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置旧根为slave，防止挂载传播到宿主机</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_SLAVE<span class="token operator">|</span>unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 分离卸载旧根</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MNT_DETACH<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 切换工作目录到新根</span></span>
<span class="line">    <span class="token keyword">return</span> unix<span class="token punctuation">.</span><span class="token function">Chdir</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>pivot_root 工作原理</strong>：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">执行前:                        执行后:</span>
<span class="line">宿主机根 (/)                   容器根 (/)</span>
<span class="line">├── bin/                      ├── bin/         (来自镜像)</span>
<span class="line">├── etc/                      ├── etc/         (来自镜像)</span>
<span class="line">└── containers/               ├── tmp/         (tmpfs)</span>
<span class="line">    └── rootfs/               └── proc/        (容器procfs)</span>
<span class="line">        ├── bin/</span>
<span class="line">        ├── etc/</span>
<span class="line">        └── tmp/</span>
<span class="line">        </span>
<span class="line">pivot_root(rootfs, oldroot) 将:</span>
<span class="line">- rootfs 变成新的根目录 /</span>
<span class="line">- 原来的根目录被移到 oldroot 位置</span>
<span class="line">- 然后卸载 oldroot，完成切换</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="b-ms-move-方式-no-pivot-root" tabindex="-1"><a class="header-anchor" href="#b-ms-move-方式-no-pivot-root"><span>B. MS_MOVE 方式 (--no-pivot-root)</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/rootfs_linux.go:185</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">msMoveRoot</span><span class="token punctuation">(</span>rootfs <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 先处理潜在的安全风险：屏蔽危险的procfs和sysfs挂载</span></span>
<span class="line">    mountinfos<span class="token punctuation">,</span> err <span class="token operator">:=</span> mountinfo<span class="token punctuation">.</span><span class="token function">GetMounts</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>info <span class="token operator">*</span>mountinfo<span class="token punctuation">.</span>Info<span class="token punctuation">)</span> <span class="token punctuation">(</span>skip<span class="token punctuation">,</span> stop <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 过滤条件：根目录、proc/sys文件系统、不在rootfs内部的挂载</span></span>
<span class="line">        <span class="token keyword">if</span> info<span class="token punctuation">.</span>Root <span class="token operator">!=</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">||</span> </span>
<span class="line">           <span class="token punctuation">(</span>info<span class="token punctuation">.</span>FSType <span class="token operator">!=</span> <span class="token string">&quot;proc&quot;</span> <span class="token operator">&amp;&amp;</span> info<span class="token punctuation">.</span>FSType <span class="token operator">!=</span> <span class="token string">&quot;sysfs&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span></span>
<span class="line">           strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>Mountpoint<span class="token punctuation">,</span> rootfs<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            skip <span class="token operator">=</span> <span class="token boolean">true</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 卸载或覆盖危险挂载点</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> info <span class="token operator">:=</span> <span class="token keyword">range</span> mountinfos <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 设置为slave防止传播</span></span>
<span class="line">        <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>Mountpoint<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_SLAVE<span class="token operator">|</span>unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">unmount</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>Mountpoint<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MNT_DETACH<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 如果无法卸载，用tmpfs覆盖</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&quot;tmpfs&quot;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>Mountpoint<span class="token punctuation">,</span> <span class="token string">&quot;tmpfs&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to mask %s: %w&quot;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>Mountpoint<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 将rootfs移动到根位置</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mount</span><span class="token punctuation">(</span>rootfs<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_MOVE<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to move %s to /: %w&quot;</span><span class="token punctuation">,</span> rootfs<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 执行chroot完成切换</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">chroot</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="c-chroot-方式-传统方式" tabindex="-1"><a class="header-anchor" href="#c-chroot-方式-传统方式"><span>C. chroot 方式 (传统方式)</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">chroot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 简单的chroot系统调用</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Chroot</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> unix<span class="token punctuation">.</span><span class="token function">Chdir</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>三种方式对比</strong>：</p><table><thead><tr><th>方式</th><th>使用场景</th><th>优势</th><th>劣势</th></tr></thead><tbody><tr><td><strong>pivot_root</strong></td><td>有mount namespace</td><td>安全性最高，完全隔离</td><td>需要mount namespace</td></tr><tr><td><strong>MS_MOVE</strong></td><td>--no-pivot-root标志</td><td>兼容性好</td><td>需要额外安全处理</td></tr><tr><td><strong>chroot</strong></td><td>无mount namespace</td><td>简单兼容</td><td>安全性较低，可能逃逸</td></tr></tbody></table><h2 id="_3-挂载类型和处理机制" tabindex="-1"><a class="header-anchor" href="#_3-挂载类型和处理机制"><span>3. 挂载类型和处理机制</span></a></h2><h3 id="_3-1-挂载分发器-mounttorootfs" tabindex="-1"><a class="header-anchor" href="#_3-1-挂载分发器-mounttorootfs"><span>3.1 挂载分发器 - mountToRootfs</span></a></h3><p>runc 根据不同的设备类型采用专门的处理逻辑：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/rootfs_linux.go:566</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">mountToRootfs</span><span class="token punctuation">(</span>c <span class="token operator">*</span>mountConfig<span class="token punctuation">,</span> m mountEntry<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">switch</span> m<span class="token punctuation">.</span>Device <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&quot;proc&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sysfs&quot;</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// 特殊文件系统需要安全检查</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">checkProcMount</span><span class="token punctuation">(</span>rootfs<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">mountPropagate</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> rootfs<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&quot;mqueue&quot;</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// 消息队列文件系统</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mountPropagate</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> rootfs<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> label<span class="token punctuation">.</span><span class="token function">SetFileLabel</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> mountLabel<span class="token punctuation">)</span>  <span class="token comment">// SELinux标签</span></span>
<span class="line">        </span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&quot;tmpfs&quot;</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// tmpfs支持copyup扩展</span></span>
<span class="line">        <span class="token keyword">if</span> m<span class="token punctuation">.</span>Extensions<span class="token operator">&amp;</span>configs<span class="token punctuation">.</span>EXT_COPYUP <span class="token operator">==</span> configs<span class="token punctuation">.</span>EXT_COPYUP <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">doTmpfsCopyUp</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> rootfs<span class="token punctuation">,</span> mountLabel<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">mountPropagate</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> rootfs<span class="token punctuation">,</span> mountLabel<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&quot;bind&quot;</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// bind挂载需要特殊的标志处理</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">handleBindMount</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> rootfs<span class="token punctuation">,</span> mountLabel<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&quot;cgroup&quot;</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// cgroup文件系统分版本处理</span></span>
<span class="line">        <span class="token keyword">if</span> cgroups<span class="token punctuation">.</span><span class="token function">IsCgroup2UnifiedMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">mountCgroupV2</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Mount<span class="token punctuation">,</span> c<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">mountCgroupV1</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Mount<span class="token punctuation">,</span> c<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">    <span class="token keyword">default</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// 其他标准文件系统</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">mountPropagate</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> rootfs<span class="token punctuation">,</span> mountLabel<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-bind-挂载的复杂处理" tabindex="-1"><a class="header-anchor" href="#_3-2-bind-挂载的复杂处理"><span>3.2 bind 挂载的复杂处理</span></a></h3><p>bind 挂载是最复杂的挂载类型，因为需要处理 <strong>locked flags</strong> 问题：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">handleBindMount</span><span class="token punctuation">(</span>m mountEntry<span class="token punctuation">,</span> rootfs<span class="token punctuation">,</span> mountLabel <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 执行基础bind挂载</span></span>
<span class="line">    flags <span class="token operator">:=</span> m<span class="token punctuation">.</span>Flags <span class="token operator">|</span> unix<span class="token punctuation">.</span>MS_BIND</span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mountViaFds</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Source<span class="token punctuation">,</span> m<span class="token punctuation">.</span>srcFile<span class="token punctuation">,</span> m<span class="token punctuation">.</span>Destination<span class="token punctuation">,</span> dstFd<span class="token punctuation">,</span> </span>
<span class="line">                         <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>flags<span class="token operator">&amp;^</span>unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">)</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Data<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 处理递归绑定</span></span>
<span class="line">    <span class="token keyword">if</span> m<span class="token punctuation">.</span>Flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_REC <span class="token operator">==</span> unix<span class="token punctuation">.</span>MS_REC <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mountViaFds</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Source<span class="token punctuation">,</span> m<span class="token punctuation">.</span>srcFile<span class="token punctuation">,</span> m<span class="token punctuation">.</span>Destination<span class="token punctuation">,</span> dstFd<span class="token punctuation">,</span> </span>
<span class="line">                             <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Data<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 重新应用挂载标志 (这是关键步骤!)</span></span>
<span class="line">    <span class="token comment">// bind挂载后需要单独的remount来应用ro/nosuid等标志</span></span>
<span class="line">    <span class="token keyword">if</span> m<span class="token punctuation">.</span>Flags<span class="token operator">&amp;^</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>MS_BIND<span class="token operator">|</span>unix<span class="token punctuation">.</span>MS_REC<span class="token operator">|</span>unix<span class="token punctuation">.</span>MS_REMOUNT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> m<span class="token punctuation">.</span>ClearedFlags <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        flags <span class="token operator">:=</span> m<span class="token punctuation">.</span>Flags <span class="token operator">|</span> unix<span class="token punctuation">.</span>MS_BIND <span class="token operator">|</span> unix<span class="token punctuation">.</span>MS_REMOUNT</span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 尝试直接设置标志</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mountViaFds</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Destination<span class="token punctuation">,</span> dstFd<span class="token punctuation">,</span> </span>
<span class="line">                             <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 如果失败，可能存在locked flags</span></span>
<span class="line">        <span class="token comment">// 需要获取源文件系统的当前标志</span></span>
<span class="line">        st<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">srcStatfs</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        srcFlags <span class="token operator">:=</span> <span class="token function">statfsToMountFlags</span><span class="token punctuation">(</span><span class="token operator">*</span>st<span class="token punctuation">)</span>  <span class="token comment">// 从statfs转换为mount标志</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 检查是否有无法清除的locked flags</span></span>
<span class="line">        lockedFlags <span class="token operator">:=</span> srcFlags <span class="token operator">&amp;</span> m<span class="token punctuation">.</span>ClearedFlags <span class="token operator">&amp;</span> mntLockFlags</span>
<span class="line">        <span class="token keyword">if</span> lockedFlags <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;cannot clear locked mount flags: %s&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                             <span class="token function">stringifyMountFlags</span><span class="token punctuation">(</span>lockedFlags<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 重新应用，包含locked flags</span></span>
<span class="line">        flags <span class="token operator">|=</span> srcFlags <span class="token operator">&amp;</span> mntLockFlags</span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">mountViaFds</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Destination<span class="token punctuation">,</span> dstFd<span class="token punctuation">,</span> </span>
<span class="line">                          <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>locked flags 问题解释</strong>：</p><p>某些挂载标志在源文件系统上可能是&quot;锁定&quot;的，无法通过remount清除：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 例如：源文件系统是只读的 (MS_RDONLY)</span></span>
<span class="line">$ <span class="token function">mount</span> <span class="token operator">|</span> <span class="token function">grep</span> /source</span>
<span class="line">/dev/sda1 on /source <span class="token builtin class-name">type</span> ext4 <span class="token punctuation">(</span>ro,noatime<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># bind挂载后，无法将其改为可写</span></span>
<span class="line">$ <span class="token function">mount</span> <span class="token parameter variable">--bind</span> /source /target</span>
<span class="line">$ <span class="token function">mount</span> <span class="token parameter variable">-o</span> remount,rw /target  <span class="token comment"># 这会失败！</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># runc的解决方案：检测locked flags并保持它们</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-新版挂载api支持" tabindex="-1"><a class="header-anchor" href="#_3-3-新版挂载api支持"><span>3.3 新版挂载API支持</span></a></h3><p>runc 支持 Linux 5.2+ 的新版挂载API，主要用于 <strong>idmapped mounts</strong>：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/mount_linux.go:242</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">mountFd</span><span class="token punctuation">(</span>nsHandles <span class="token operator">*</span>userns<span class="token punctuation">.</span>Handles<span class="token punctuation">,</span> m <span class="token operator">*</span>configs<span class="token punctuation">.</span>Mount<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>mountSource<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> m<span class="token punctuation">.</span><span class="token function">IsIDMapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 使用open_tree()创建挂载文件描述符</span></span>
<span class="line">        flags <span class="token operator">:=</span> <span class="token function">uint</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>OPEN_TREE_CLONE <span class="token operator">|</span> unix<span class="token punctuation">.</span>OPEN_TREE_CLOEXEC<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> m<span class="token punctuation">.</span>Flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_REC <span class="token operator">==</span> unix<span class="token punctuation">.</span>MS_REC <span class="token punctuation">{</span></span>
<span class="line">            flags <span class="token operator">|=</span> unix<span class="token punctuation">.</span>AT_RECURSIVE</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        fd<span class="token punctuation">,</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">OpenTree</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>AT_FDCWD<span class="token punctuation">,</span> m<span class="token punctuation">.</span>Source<span class="token punctuation">,</span> flags<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;open_tree(%s): %w&quot;</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Source<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        mountFile <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">NewFile</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Source<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 获取用户命名空间文件描述符</span></span>
<span class="line">        usernsFile<span class="token punctuation">,</span> err <span class="token operator">:=</span> nsHandles<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>userns<span class="token punctuation">.</span>Mapping<span class="token punctuation">{</span></span>
<span class="line">            UIDMappings<span class="token punctuation">:</span> m<span class="token punctuation">.</span>IDMapping<span class="token punctuation">.</span>UIDMappings<span class="token punctuation">,</span></span>
<span class="line">            GIDMappings<span class="token punctuation">:</span> m<span class="token punctuation">.</span>IDMapping<span class="token punctuation">.</span>GIDMappings<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 应用idmap属性</span></span>
<span class="line">        attr <span class="token operator">:=</span> <span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MountAttr<span class="token punctuation">{</span></span>
<span class="line">            Attr_set<span class="token punctuation">:</span>  unix<span class="token punctuation">.</span>MOUNT_ATTR_IDMAP<span class="token punctuation">,</span></span>
<span class="line">            Userns_fd<span class="token punctuation">:</span> <span class="token function">uint64</span><span class="token punctuation">(</span>usernsFile<span class="token punctuation">.</span><span class="token function">Fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">MountSetattr</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>mountFile<span class="token punctuation">.</span><span class="token function">Fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                                   unix<span class="token punctuation">.</span>AT_EMPTY_PATH<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;mount_setattr(idmap): %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">&amp;</span>mountSource<span class="token punctuation">{</span>Type<span class="token punctuation">:</span> mountSourceOpenTree<span class="token punctuation">,</span> file<span class="token punctuation">:</span> mountFile<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 普通bind挂载使用O_PATH</span></span>
<span class="line">    mountFile<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Source<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>O_PATH<span class="token operator">|</span>unix<span class="token punctuation">.</span>O_CLOEXEC<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>mountSource<span class="token punctuation">{</span>Type<span class="token punctuation">:</span> mountSourcePlain<span class="token punctuation">,</span> file<span class="token punctuation">:</span> mountFile<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>idmapped mounts 的优势</strong>：</p><ul><li>🔐 <strong>权限映射</strong>: 文件系统内的 UID/GID 可以映射到不同的用户命名空间</li><li>🔒 <strong>安全性</strong>: 无需 chown 就能改变文件所有权视图</li><li>⚡ <strong>性能</strong>: 避免复制文件，直接映射权限</li></ul><h2 id="_4-特殊文件系统处理" tabindex="-1"><a class="header-anchor" href="#_4-特殊文件系统处理"><span>4. 特殊文件系统处理</span></a></h2><h3 id="_4-1-proc-文件系统安全检查" tabindex="-1"><a class="header-anchor" href="#_4-1-proc-文件系统安全检查"><span>4.1 /proc 文件系统安全检查</span></a></h3><p>proc 文件系统包含敏感的系统信息，runc 实现了严格的安全检查：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/rootfs_linux.go:790</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">checkProcMount</span><span class="token punctuation">(</span>rootfs<span class="token punctuation">,</span> dest <span class="token builtin">string</span><span class="token punctuation">,</span> m mountEntry<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 计算相对于/proc的路径</span></span>
<span class="line">    path<span class="token punctuation">,</span> err <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Rel</span><span class="token punctuation">(</span>filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>rootfs<span class="token punctuation">,</span> <span class="token string">&quot;/proc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dest<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> path <span class="token operator">==</span> <span class="token string">&quot;.&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 在/proc根目录上的挂载</span></span>
<span class="line">        <span class="token keyword">if</span> m<span class="token punctuation">.</span><span class="token function">IsBind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// bind挂载必须是真正的procfs</span></span>
<span class="line">            fsStat<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">srcStatfs</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> err</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">if</span> fsStat<span class="token punctuation">.</span>Type <span class="token operator">!=</span> unix<span class="token punctuation">.</span>PROC_SUPER_MAGIC <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;bind mount %s is not procfs&quot;</span><span class="token punctuation">,</span> dest<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// 检查是否为procfs根节点 (inode == 1)</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> uStat<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">srcStat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">const</span> procRootIno <span class="token operator">=</span> <span class="token number">1</span></span>
<span class="line">                <span class="token keyword">if</span> uStat<span class="token punctuation">.</span>Ino <span class="token operator">!=</span> procRootIno <span class="token punctuation">{</span></span>
<span class="line">                    logrus<span class="token punctuation">.</span><span class="token function">Warnf</span><span class="token punctuation">(</span><span class="token string">&quot;bind-mount %s is not procfs root (inode %d)&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                               dest<span class="token punctuation">,</span> uStat<span class="token punctuation">.</span>Ino<span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> m<span class="token punctuation">.</span>Device <span class="token operator">==</span> <span class="token string">&quot;proc&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span>  <span class="token comment">// 新的procfs挂载总是安全的</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%s cannot be mounted: not procfs&quot;</span><span class="token punctuation">,</span> dest<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// /proc子路径：只允许特定的白名单路径</span></span>
<span class="line">    validProcMounts <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&quot;/proc/cpuinfo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/proc/diskstats&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/proc/meminfo&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;/proc/stat&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/proc/swaps&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/proc/uptime&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/proc/loadavg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;/proc/sys/kernel/ns_last_pid&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;/proc/sys/crypto/fips_enabled&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token comment">// 更多安全的proc路径...</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 检查是否为允许的路径</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> validPath <span class="token operator">:=</span> <span class="token keyword">range</span> validProcMounts <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> filepath<span class="token punctuation">.</span><span class="token function">Clean</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span> <span class="token operator">==</span> validPath <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%s cannot be mounted inside /proc: not in whitelist&quot;</span><span class="token punctuation">,</span> dest<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-cgroup-文件系统处理" tabindex="-1"><a class="header-anchor" href="#_4-2-cgroup-文件系统处理"><span>4.2 cgroup 文件系统处理</span></a></h3><h4 id="cgroups-v1-处理" tabindex="-1"><a class="header-anchor" href="#cgroups-v1-处理"><span>Cgroups v1 处理</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">mountCgroupV1</span><span class="token punctuation">(</span>m <span class="token operator">*</span>configs<span class="token punctuation">.</span>Mount<span class="token punctuation">,</span> c <span class="token operator">*</span>mountConfig<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 获取系统中的cgroup挂载点</span></span>
<span class="line">    binds<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getCgroupMounts</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 创建tmpfs作为cgroup根挂载点</span></span>
<span class="line">    tmpfs <span class="token operator">:=</span> <span class="token operator">&amp;</span>configs<span class="token punctuation">.</span>Mount<span class="token punctuation">{</span></span>
<span class="line">        Source<span class="token punctuation">:</span>      <span class="token string">&quot;tmpfs&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        Device<span class="token punctuation">:</span>      <span class="token string">&quot;tmpfs&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        Destination<span class="token punctuation">:</span> m<span class="token punctuation">.</span>Destination<span class="token punctuation">,</span></span>
<span class="line">        Flags<span class="token punctuation">:</span>       defaultMountFlags<span class="token punctuation">,</span></span>
<span class="line">        Data<span class="token punctuation">:</span>        <span class="token string">&quot;mode=755,size=65536k&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mountToRootfs</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> mountEntry<span class="token punctuation">{</span>Mount<span class="token punctuation">:</span> tmpfs<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 为每个cgroup子系统创建挂载点</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token keyword">range</span> binds <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> c<span class="token punctuation">.</span>cgroupns <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// cgroup命名空间模式：直接挂载cgroup文件系统</span></span>
<span class="line">            subsystemName <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>Subsystems<span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mountViaFds</span><span class="token punctuation">(</span><span class="token string">&quot;cgroup&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>Destination<span class="token punctuation">,</span> dstFd<span class="token punctuation">,</span> </span>
<span class="line">                                 <span class="token string">&quot;cgroup&quot;</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>Flags<span class="token punctuation">)</span><span class="token punctuation">,</span> subsystemName<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to mount cgroup %s: %w&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                                 subsystemName<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 非命名空间模式：bind挂载宿主机cgroup路径</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mountToRootfs</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> mountEntry<span class="token punctuation">{</span>Mount<span class="token punctuation">:</span> b<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> err</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="cgroups-v2-处理" tabindex="-1"><a class="header-anchor" href="#cgroups-v2-处理"><span>Cgroups v2 处理</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">mountCgroupV2</span><span class="token punctuation">(</span>m <span class="token operator">*</span>configs<span class="token punctuation">.</span>Mount<span class="token punctuation">,</span> c <span class="token operator">*</span>mountConfig<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 尝试直接挂载cgroup2文件系统</span></span>
<span class="line">    err <span class="token operator">:=</span> <span class="token function">mountViaFds</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Source<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Destination<span class="token punctuation">,</span> dstFd<span class="token punctuation">,</span> </span>
<span class="line">                      <span class="token string">&quot;cgroup2&quot;</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Flags<span class="token punctuation">)</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Data<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>EPERM<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>EBUSY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 权限不足时降级为bind挂载</span></span>
<span class="line">    bindMount <span class="token operator">:=</span> <span class="token operator">&amp;</span>configs<span class="token punctuation">.</span>Mount<span class="token punctuation">{</span></span>
<span class="line">        Device<span class="token punctuation">:</span>      <span class="token string">&quot;bind&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        Source<span class="token punctuation">:</span>      fs2<span class="token punctuation">.</span>UnifiedMountpoint<span class="token punctuation">,</span>  <span class="token comment">// /sys/fs/cgroup</span></span>
<span class="line">        Destination<span class="token punctuation">:</span> m<span class="token punctuation">.</span>Destination<span class="token punctuation">,</span></span>
<span class="line">        Flags<span class="token punctuation">:</span>       unix<span class="token punctuation">.</span>MS_BIND <span class="token operator">|</span> m<span class="token punctuation">.</span>Flags<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> c<span class="token punctuation">.</span>cgroupns <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>cgroup2Path <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// cgroup命名空间模式：挂载容器特定路径</span></span>
<span class="line">        bindMount<span class="token punctuation">.</span>Source <span class="token operator">=</span> c<span class="token punctuation">.</span>cgroup2Path</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">mountToRootfs</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> mountEntry<span class="token punctuation">{</span>Mount<span class="token punctuation">:</span> bindMount<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-dev-文件系统和设备节点" tabindex="-1"><a class="header-anchor" href="#_4-3-dev-文件系统和设备节点"><span>4.3 /dev 文件系统和设备节点</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/rootfs_linux.go:473</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">createDevices</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    useBindMount <span class="token operator">:=</span> userns<span class="token punctuation">.</span><span class="token function">RunningInUserNS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> </span>
<span class="line">                   config<span class="token punctuation">.</span>Namespaces<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>configs<span class="token punctuation">.</span>NEWUSER<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 创建配置中指定的设备节点</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> node <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Devices <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ptmx由setupPtmx()单独处理</span></span>
<span class="line">        <span class="token keyword">if</span> utils<span class="token punctuation">.</span><span class="token function">CleanPath</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Path<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;/dev/ptmx&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">continue</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">createDeviceNode</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Rootfs<span class="token punctuation">,</span> node<span class="token punctuation">,</span> useBindMount<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to create device %s: %w&quot;</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">createDeviceNode</span><span class="token punctuation">(</span>rootfs <span class="token builtin">string</span><span class="token punctuation">,</span> node <span class="token operator">*</span>devices<span class="token punctuation">.</span>Device<span class="token punctuation">,</span> bind <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    dest<span class="token punctuation">,</span> err <span class="token operator">:=</span> securejoin<span class="token punctuation">.</span><span class="token function">SecureJoin</span><span class="token punctuation">(</span>rootfs<span class="token punctuation">,</span> node<span class="token punctuation">.</span>Path<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> bind <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 用户命名空间中使用bind挂载</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">bindMountDeviceNode</span><span class="token punctuation">(</span>rootfs<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> node<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 直接使用mknod创建设备节点</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">mknodDevice</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> node<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 设备节点bind挂载</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">bindMountDeviceNode</span><span class="token punctuation">(</span>rootfs<span class="token punctuation">,</span> dest <span class="token builtin">string</span><span class="token punctuation">,</span> node <span class="token operator">*</span>devices<span class="token punctuation">.</span>Device<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 创建目标文件</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">createBlankFile</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// bind挂载设备节点</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">mount</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> <span class="token string">&quot;bind&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_BIND<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 创建标准设备符号链接</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setupDevSymlinks</span><span class="token punctuation">(</span>rootfs <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    links <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;/proc/self/fd&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/dev/fd&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;/proc/self/fd/0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/dev/stdin&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;/proc/self/fd/1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/dev/stdout&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;/proc/self/fd/2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/dev/stderr&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 条件性符号链接</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span><span class="token string">&quot;/proc/kcore&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        links <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>links<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;/proc/kcore&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/dev/core&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> link <span class="token operator">:=</span> <span class="token keyword">range</span> links <span class="token punctuation">{</span></span>
<span class="line">        newPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>rootfs<span class="token punctuation">,</span> link<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Symlink</span><span class="token punctuation">(</span>link<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> newPath<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>os<span class="token punctuation">.</span><span class="token function">IsExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-挂载配置和选项解析" tabindex="-1"><a class="header-anchor" href="#_5-挂载配置和选项解析"><span>5. 挂载配置和选项解析</span></a></h2><h3 id="_5-1-mount-结构定义" tabindex="-1"><a class="header-anchor" href="#_5-1-mount-结构定义"><span>5.1 Mount 结构定义</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/configs/mount_linux.go:23</span></span>
<span class="line"><span class="token keyword">type</span> Mount <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Source           <span class="token builtin">string</span>              <span class="token comment">// 源路径或设备</span></span>
<span class="line">    Destination      <span class="token builtin">string</span>              <span class="token comment">// 容器内目标路径</span></span>
<span class="line">    Device           <span class="token builtin">string</span>              <span class="token comment">// 文件系统类型或设备类型</span></span>
<span class="line">    Flags            <span class="token builtin">int</span>                 <span class="token comment">// 挂载标志位</span></span>
<span class="line">    ClearedFlags     <span class="token builtin">int</span>                 <span class="token comment">// 明确清除的标志</span></span>
<span class="line">    PropagationFlags <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>               <span class="token comment">// 挂载传播标志数组</span></span>
<span class="line">    Data             <span class="token builtin">string</span>              <span class="token comment">// 文件系统特定选项</span></span>
<span class="line">    Relabel          <span class="token builtin">string</span>              <span class="token comment">// SELinux重标记选项</span></span>
<span class="line">    RecAttr          <span class="token operator">*</span>unix<span class="token punctuation">.</span>MountAttr     <span class="token comment">// mount_setattr递归属性</span></span>
<span class="line">    Extensions       <span class="token builtin">int</span>                 <span class="token comment">// runc扩展标志</span></span>
<span class="line">    IDMapping        <span class="token operator">*</span>MountIDMapping     <span class="token comment">// idmapped挂载配置</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 常用方法</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Mount<span class="token punctuation">)</span> <span class="token function">IsBind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> m<span class="token punctuation">.</span>Flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_BIND <span class="token operator">!=</span> <span class="token number">0</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Mount<span class="token punctuation">)</span> <span class="token function">IsIDMapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> m<span class="token punctuation">.</span>IDMapping <span class="token operator">!=</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-挂载选项解析机制" tabindex="-1"><a class="header-anchor" href="#_5-2-挂载选项解析机制"><span>5.2 挂载选项解析机制</span></a></h3><p>runc 使用多层映射表解析 OCI 规范中的挂载选项：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/specconv/spec_linux.go:1079</span></span>
<span class="line"><span class="token keyword">var</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token comment">// 基础挂载标志映射  </span></span>
<span class="line">    mountFlags <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span>clear <span class="token builtin">bool</span><span class="token punctuation">;</span> flag <span class="token builtin">int</span><span class="token punctuation">}</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&quot;defaults&quot;</span><span class="token punctuation">:</span>   <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                    <span class="token comment">// 默认选项</span></span>
<span class="line">        <span class="token string">&quot;ro&quot;</span><span class="token punctuation">:</span>         <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_RDONLY<span class="token punctuation">}</span><span class="token punctuation">,</span>       <span class="token comment">// 只读</span></span>
<span class="line">        <span class="token string">&quot;rw&quot;</span><span class="token punctuation">:</span>         <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_RDONLY<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token comment">// 可写(清除只读)</span></span>
<span class="line">        <span class="token string">&quot;nosuid&quot;</span><span class="token punctuation">:</span>     <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NOSUID<span class="token punctuation">}</span><span class="token punctuation">,</span>       <span class="token comment">// 禁用suid</span></span>
<span class="line">        <span class="token string">&quot;suid&quot;</span><span class="token punctuation">:</span>       <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NOSUID<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token comment">// 允许suid(清除nosuid)</span></span>
<span class="line">        <span class="token string">&quot;nodev&quot;</span><span class="token punctuation">:</span>      <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NODEV<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token comment">// 禁用设备节点</span></span>
<span class="line">        <span class="token string">&quot;dev&quot;</span><span class="token punctuation">:</span>        <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NODEV<span class="token punctuation">}</span><span class="token punctuation">,</span>         <span class="token comment">// 允许设备节点</span></span>
<span class="line">        <span class="token string">&quot;noexec&quot;</span><span class="token punctuation">:</span>     <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NOEXEC<span class="token punctuation">}</span><span class="token punctuation">,</span>       <span class="token comment">// 禁用可执行文件</span></span>
<span class="line">        <span class="token string">&quot;exec&quot;</span><span class="token punctuation">:</span>       <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NOEXEC<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token comment">// 允许可执行文件</span></span>
<span class="line">        <span class="token string">&quot;sync&quot;</span><span class="token punctuation">:</span>       <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_SYNCHRONOUS<span class="token punctuation">}</span><span class="token punctuation">,</span>   <span class="token comment">// 同步IO</span></span>
<span class="line">        <span class="token string">&quot;async&quot;</span><span class="token punctuation">:</span>      <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_SYNCHRONOUS<span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">// 异步IO</span></span>
<span class="line">        <span class="token string">&quot;dirsync&quot;</span><span class="token punctuation">:</span>    <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_DIRSYNC<span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token comment">// 目录同步</span></span>
<span class="line">        <span class="token string">&quot;remount&quot;</span><span class="token punctuation">:</span>    <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_REMOUNT<span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token comment">// 重新挂载</span></span>
<span class="line">        <span class="token string">&quot;mand&quot;</span><span class="token punctuation">:</span>       <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_MANDLOCK<span class="token punctuation">}</span><span class="token punctuation">,</span>     <span class="token comment">// 强制锁</span></span>
<span class="line">        <span class="token string">&quot;nomand&quot;</span><span class="token punctuation">:</span>     <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_MANDLOCK<span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token comment">// 禁用强制锁</span></span>
<span class="line">        <span class="token string">&quot;atime&quot;</span><span class="token punctuation">:</span>      <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NOATIME<span class="token punctuation">}</span><span class="token punctuation">,</span>       <span class="token comment">// 更新访问时间</span></span>
<span class="line">        <span class="token string">&quot;noatime&quot;</span><span class="token punctuation">:</span>    <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NOATIME<span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token comment">// 不更新访问时间</span></span>
<span class="line">        <span class="token string">&quot;diratime&quot;</span><span class="token punctuation">:</span>   <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NODIRATIME<span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">// 目录访问时间</span></span>
<span class="line">        <span class="token string">&quot;nodiratime&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NODIRATIME<span class="token punctuation">}</span><span class="token punctuation">,</span>   <span class="token comment">// 禁用目录访问时间</span></span>
<span class="line">        <span class="token string">&quot;bind&quot;</span><span class="token punctuation">:</span>       <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_BIND<span class="token punctuation">}</span><span class="token punctuation">,</span>         <span class="token comment">// bind挂载</span></span>
<span class="line">        <span class="token string">&quot;rbind&quot;</span><span class="token punctuation">:</span>      <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_BIND <span class="token operator">|</span> unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 递归bind挂载</span></span>
<span class="line">        <span class="token string">&quot;relatime&quot;</span><span class="token punctuation">:</span>   <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_RELATIME<span class="token punctuation">}</span><span class="token punctuation">,</span>     <span class="token comment">// 相对访问时间</span></span>
<span class="line">        <span class="token string">&quot;norelatime&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_RELATIME<span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token comment">// 禁用相对访问时间</span></span>
<span class="line">        <span class="token string">&quot;strictatime&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_STRICTATIME<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 严格访问时间</span></span>
<span class="line">        <span class="token string">&quot;nostrictatime&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_STRICTATIME<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 非严格访问时间</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 挂载传播属性映射</span></span>
<span class="line">    mountPropagationMapping <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&quot;private&quot;</span><span class="token punctuation">:</span>     unix<span class="token punctuation">.</span>MS_PRIVATE<span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rprivate&quot;</span><span class="token punctuation">:</span>    unix<span class="token punctuation">.</span>MS_PRIVATE <span class="token operator">|</span> unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;shared&quot;</span><span class="token punctuation">:</span>      unix<span class="token punctuation">.</span>MS_SHARED<span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rshared&quot;</span><span class="token punctuation">:</span>     unix<span class="token punctuation">.</span>MS_SHARED <span class="token operator">|</span> unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;slave&quot;</span><span class="token punctuation">:</span>       unix<span class="token punctuation">.</span>MS_SLAVE<span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rslave&quot;</span><span class="token punctuation">:</span>      unix<span class="token punctuation">.</span>MS_SLAVE <span class="token operator">|</span> unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;unbindable&quot;</span><span class="token punctuation">:</span>  unix<span class="token punctuation">.</span>MS_UNBINDABLE<span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;runbindable&quot;</span><span class="token punctuation">:</span> unix<span class="token punctuation">.</span>MS_UNBINDABLE <span class="token operator">|</span> unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// mount_setattr递归属性映射 (Linux 5.12+)</span></span>
<span class="line">    recAttrFlags <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span>clear <span class="token builtin">bool</span><span class="token punctuation">;</span> flag <span class="token builtin">uint64</span><span class="token punctuation">}</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&quot;rro&quot;</span><span class="token punctuation">:</span>        <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_RDONLY<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rrw&quot;</span><span class="token punctuation">:</span>        <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_RDONLY<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rnosuid&quot;</span><span class="token punctuation">:</span>    <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_NOSUID<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rsuid&quot;</span><span class="token punctuation">:</span>      <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_NOSUID<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rnodev&quot;</span><span class="token punctuation">:</span>     <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_NODEV<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rdev&quot;</span><span class="token punctuation">:</span>       <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_NODEV<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rnoexec&quot;</span><span class="token punctuation">:</span>    <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_NOEXEC<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rexec&quot;</span><span class="token punctuation">:</span>      <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_NOEXEC<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rnodiratime&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_NODIRATIME<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rdiratime&quot;</span><span class="token punctuation">:</span>   <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_NODIRATIME<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rnoatime&quot;</span><span class="token punctuation">:</span>    <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_NOATIME<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;ratime&quot;</span><span class="token punctuation">:</span>      <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_NOATIME<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rrelatime&quot;</span><span class="token punctuation">:</span>   <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_RELATIME<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rnorelatime&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_RELATIME<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rstrictatime&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_STRICTATIME<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rnostrictatime&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_STRICTATIME<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-选项解析算法" tabindex="-1"><a class="header-anchor" href="#_5-3-选项解析算法"><span>5.3 选项解析算法</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">parseMountOptions</span><span class="token punctuation">(</span>options <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>configs<span class="token punctuation">.</span>Mount<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> <span class="token punctuation">(</span></span>
<span class="line">        data     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span></span>
<span class="line">        mount    configs<span class="token punctuation">.</span>Mount</span>
<span class="line">        recAttrSet<span class="token punctuation">,</span> recAttrClr <span class="token builtin">uint64</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> option <span class="token operator">:=</span> <span class="token keyword">range</span> options <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> f<span class="token punctuation">,</span> exists <span class="token operator">:=</span> mountFlags<span class="token punctuation">[</span>option<span class="token punctuation">]</span><span class="token punctuation">;</span> exists <span class="token operator">&amp;&amp;</span> f<span class="token punctuation">.</span>flag <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> f<span class="token punctuation">.</span>clear <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// 清除标志</span></span>
<span class="line">                mount<span class="token punctuation">.</span>Flags <span class="token operator">&amp;=</span> <span class="token operator">^</span>f<span class="token punctuation">.</span>flag</span>
<span class="line">                mount<span class="token punctuation">.</span>ClearedFlags <span class="token operator">|=</span> f<span class="token punctuation">.</span>flag</span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// 设置标志</span></span>
<span class="line">                mount<span class="token punctuation">.</span>Flags <span class="token operator">|=</span> f<span class="token punctuation">.</span>flag</span>
<span class="line">                mount<span class="token punctuation">.</span>ClearedFlags <span class="token operator">&amp;=</span> <span class="token operator">^</span>f<span class="token punctuation">.</span>flag</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> f<span class="token punctuation">,</span> exists <span class="token operator">:=</span> mountPropagationMapping<span class="token punctuation">[</span>option<span class="token punctuation">]</span><span class="token punctuation">;</span> exists <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 传播属性</span></span>
<span class="line">            mount<span class="token punctuation">.</span>PropagationFlags <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>mount<span class="token punctuation">.</span>PropagationFlags<span class="token punctuation">,</span> f<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> f<span class="token punctuation">,</span> exists <span class="token operator">:=</span> recAttrFlags<span class="token punctuation">[</span>option<span class="token punctuation">]</span><span class="token punctuation">;</span> exists <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 递归属性 (mount_setattr)</span></span>
<span class="line">            <span class="token keyword">if</span> f<span class="token punctuation">.</span>clear <span class="token punctuation">{</span></span>
<span class="line">                recAttrClr <span class="token operator">|=</span> f<span class="token punctuation">.</span>flag</span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                recAttrSet <span class="token operator">|=</span> f<span class="token punctuation">.</span>flag</span>
<span class="line">                <span class="token comment">// atime标志需要特殊处理</span></span>
<span class="line">                <span class="token keyword">if</span> f<span class="token punctuation">.</span>flag<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MOUNT_ATTR__ATIME <span class="token operator">==</span> f<span class="token punctuation">.</span>flag <span class="token punctuation">{</span></span>
<span class="line">                    recAttrClr <span class="token operator">|=</span> unix<span class="token punctuation">.</span>MOUNT_ATTR__ATIME</span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 文件系统特定选项</span></span>
<span class="line">            data <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> option<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    mount<span class="token punctuation">.</span>Data <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置mount_setattr属性</span></span>
<span class="line">    <span class="token keyword">if</span> recAttrSet <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> recAttrClr <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        mount<span class="token punctuation">.</span>RecAttr <span class="token operator">=</span> <span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MountAttr<span class="token punctuation">{</span></span>
<span class="line">            Attr_set<span class="token punctuation">:</span> recAttrSet<span class="token punctuation">,</span></span>
<span class="line">            Attr_clr<span class="token punctuation">:</span> recAttrClr<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>mount<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-安全机制和错误处理" tabindex="-1"><a class="header-anchor" href="#_6-安全机制和错误处理"><span>6. 安全机制和错误处理</span></a></h2><h3 id="_6-1-路径安全处理" tabindex="-1"><a class="header-anchor" href="#_6-1-路径安全处理"><span>6.1 路径安全处理</span></a></h3><p>runc 使用多种机制防止路径遍历攻击：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 使用procfd确保路径安全</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">WithProcfd</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">,</span> fn <span class="token keyword">func</span><span class="token punctuation">(</span>procfd <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 使用 /proc/self/fd/&lt;fd&gt; 确保操作在正确的路径上</span></span>
<span class="line">    file<span class="token punctuation">,</span> err <span class="token operator">:=</span> securejoin<span class="token punctuation">.</span><span class="token function">OpenInRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> path<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>O_PATH<span class="token operator">|</span>unix<span class="token punctuation">.</span>O_CLOEXEC<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    procfd <span class="token operator">:=</span> <span class="token string">&quot;/proc/self/fd/&quot;</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">Fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>procfd<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// securejoin 确保安全路径连接</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">secureJoin</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 防止 ../ 路径遍历</span></span>
<span class="line">    <span class="token comment">// 防止符号链接逃逸  </span></span>
<span class="line">    <span class="token comment">// 确保结果路径在root内部</span></span>
<span class="line">    <span class="token keyword">return</span> securejoin<span class="token punctuation">.</span><span class="token function">SecureJoin</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> path<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-错误处理和诊断" tabindex="-1"><a class="header-anchor" href="#_6-2-错误处理和诊断"><span>6.2 错误处理和诊断</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 结构化的挂载错误信息</span></span>
<span class="line"><span class="token keyword">type</span> mountError <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    op      <span class="token builtin">string</span>        <span class="token comment">// 操作类型 (mount/unmount)</span></span>
<span class="line">    source  <span class="token builtin">string</span>        <span class="token comment">// 源路径</span></span>
<span class="line">    srcFile <span class="token operator">*</span>mountSource  <span class="token comment">// 源文件描述符信息</span></span>
<span class="line">    target  <span class="token builtin">string</span>        <span class="token comment">// 目标路径</span></span>
<span class="line">    dstFd   <span class="token builtin">string</span>        <span class="token comment">// 目标procfd路径</span></span>
<span class="line">    flags   <span class="token builtin">uintptr</span>       <span class="token comment">// 挂载标志</span></span>
<span class="line">    data    <span class="token builtin">string</span>        <span class="token comment">// 挂载选项</span></span>
<span class="line">    err     <span class="token builtin">error</span>         <span class="token comment">// 底层错误</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>mountError<span class="token punctuation">)</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> srcType <span class="token builtin">string</span></span>
<span class="line">    <span class="token keyword">if</span> e<span class="token punctuation">.</span>srcFile <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        srcType <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>srcFile<span class="token punctuation">.</span>Type<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s failed: src=%s, srcType=%s, dst=%s, flags=%s, data=%s: %v&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                       e<span class="token punctuation">.</span>op<span class="token punctuation">,</span> e<span class="token punctuation">.</span>source<span class="token punctuation">,</span> srcType<span class="token punctuation">,</span> e<span class="token punctuation">.</span>target<span class="token punctuation">,</span></span>
<span class="line">                       <span class="token function">stringifyMountFlags</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>flags<span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>data<span class="token punctuation">,</span> e<span class="token punctuation">.</span>err<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 挂载标志的可读化</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">stringifyMountFlags</span><span class="token punctuation">(</span>flags <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> opts <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span></span>
<span class="line">    <span class="token keyword">if</span> flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_RDONLY <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        opts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token string">&quot;ro&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_NOSUID <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        opts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token string">&quot;nosuid&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_NODEV <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        opts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token string">&quot;nodev&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_NOEXEC <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        opts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token string">&quot;noexec&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_BIND <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        opts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token string">&quot;bind&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// ... 更多标志</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;0&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-只读文件系统加固" tabindex="-1"><a class="header-anchor" href="#_6-3-只读文件系统加固"><span>6.3 只读文件系统加固</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/rootfs_linux.go:388</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">finalizeRootfs</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 重新挂载延迟只读的文件系统</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> mount <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Mounts <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> mount<span class="token punctuation">.</span>Flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_RDONLY <span class="token operator">!=</span> unix<span class="token punctuation">.</span>MS_RDONLY <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">continue</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// tmpfs 和 /dev 延迟只读处理</span></span>
<span class="line">        <span class="token keyword">if</span> mount<span class="token punctuation">.</span>Device <span class="token operator">==</span> <span class="token string">&quot;tmpfs&quot;</span> <span class="token operator">||</span> utils<span class="token punctuation">.</span><span class="token function">CleanPath</span><span class="token punctuation">(</span>mount<span class="token punctuation">.</span>Destination<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;/dev&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">remountReadonly</span><span class="token punctuation">(</span>mount<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to remount %s as readonly: %w&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                                 mount<span class="token punctuation">.</span>Destination<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 设置根文件系统只读</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>Readonlyfs <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setReadonly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set rootfs readonly: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 应用 umask</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>Umask <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        unix<span class="token punctuation">.</span><span class="token function">Umask</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token operator">*</span>config<span class="token punctuation">.</span>Umask<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        unix<span class="token punctuation">.</span><span class="token function">Umask</span><span class="token punctuation">(</span><span class="token number">0o022</span><span class="token punctuation">)</span>  <span class="token comment">// 默认 umask</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setReadonly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 重新挂载根文件系统为只读</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_BIND<span class="token operator">|</span>unix<span class="token punctuation">.</span>MS_REMOUNT<span class="token operator">|</span>unix<span class="token punctuation">.</span>MS_RDONLY<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-实践练习" tabindex="-1"><a class="header-anchor" href="#_7-实践练习"><span>7. 实践练习</span></a></h2><h3 id="_7-1-基础挂载实验" tabindex="-1"><a class="header-anchor" href="#_7-1-基础挂载实验"><span>7.1 基础挂载实验</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># 实验 1: 理解不同挂载类型</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 创建实验环境</span></span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /tmp/rootfs/<span class="token punctuation">{</span>bin,etc,proc,sys,dev,tmp<span class="token punctuation">}</span></span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /tmp/host-data</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 1. bind 挂载实验</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;host content&quot;</span> <span class="token operator">&gt;</span> /tmp/host-data/file.txt</span>
<span class="line"><span class="token function">mount</span> <span class="token parameter variable">--bind</span> /tmp/host-data /tmp/rootfs/tmp</span>
<span class="line"><span class="token function">ls</span> /tmp/rootfs/tmp/  <span class="token comment"># 应该看到 file.txt</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 2. tmpfs 挂载实验</span></span>
<span class="line"><span class="token function">mount</span> <span class="token parameter variable">-t</span> tmpfs tmpfs /tmp/rootfs/dev <span class="token parameter variable">-o</span> <span class="token assign-left variable">size</span><span class="token operator">=</span>10M,mode<span class="token operator">=</span><span class="token number">755</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;tmpfs content&quot;</span> <span class="token operator">&gt;</span> /tmp/rootfs/dev/tmpfile</span>
<span class="line"><span class="token function">ls</span> /tmp/rootfs/dev/</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 3. proc 挂载实验</span></span>
<span class="line"><span class="token function">mount</span> <span class="token parameter variable">-t</span> proc proc /tmp/rootfs/proc</span>
<span class="line"><span class="token function">ls</span> /tmp/rootfs/proc/  <span class="token comment"># 看到proc内容</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 4. 测试挂载传播</span></span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /tmp/test-propagation/<span class="token punctuation">{</span>source,target<span class="token punctuation">}</span></span>
<span class="line"><span class="token function">mount</span> <span class="token parameter variable">--bind</span> /tmp/test-propagation/source /tmp/test-propagation/target</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 共享传播</span></span>
<span class="line"><span class="token function">mount</span> --make-shared /tmp/test-propagation/target</span>
<span class="line"><span class="token function">mount</span> <span class="token parameter variable">--bind</span> /tmp/host-data /tmp/test-propagation/target/shared</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检查传播效果</span></span>
<span class="line"><span class="token function">ls</span> /tmp/test-propagation/source/  <span class="token comment"># 应该看到shared目录</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 清理</span></span>
<span class="line"><span class="token function">umount</span> <span class="token parameter variable">-R</span> /tmp/rootfs</span>
<span class="line"><span class="token function">umount</span> <span class="token parameter variable">-R</span> /tmp/test-propagation</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-容器文件系统构建" tabindex="-1"><a class="header-anchor" href="#_7-2-容器文件系统构建"><span>7.2 容器文件系统构建</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># 实验 2: 手动构建容器文件系统</span></span>
<span class="line"></span>
<span class="line"><span class="token function-name function">create_container_rootfs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin class-name">local</span> <span class="token assign-left variable">rootfs</span><span class="token operator">=</span><span class="token string">&quot;/tmp/container-rootfs&quot;</span></span>
<span class="line">    <span class="token builtin class-name">local</span> <span class="token assign-left variable">old_root</span><span class="token operator">=</span><span class="token string">&quot;/tmp/old-root&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 1. 准备基础rootfs</span></span>
<span class="line">    <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token string">&quot;<span class="token variable">$rootfs</span>&quot;</span>/<span class="token punctuation">{</span>bin,etc,lib,proc,sys,dev,tmp<span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 复制必要的可执行文件</span></span>
<span class="line">    <span class="token function">cp</span> /bin/sh <span class="token string">&quot;<span class="token variable">$rootfs</span>/bin/&quot;</span></span>
<span class="line">    <span class="token function">cp</span> /bin/ls <span class="token string">&quot;<span class="token variable">$rootfs</span>/bin/&quot;</span></span>
<span class="line">    <span class="token function">cp</span> /bin/cat <span class="token string">&quot;<span class="token variable">$rootfs</span>/bin/&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 复制库文件</span></span>
<span class="line">    ldd /bin/sh <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-o</span> <span class="token string">&#39;/lib[^ ]*&#39;</span> <span class="token operator">|</span> <span class="token keyword">while</span> <span class="token builtin class-name">read</span> lib<span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">        <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token string">&quot;<span class="token variable">$rootfs</span><span class="token variable"><span class="token variable">$(</span><span class="token function">dirname</span> <span class="token string">&quot;<span class="token variable">$lib</span>&quot;</span><span class="token variable">)</span></span>&quot;</span></span>
<span class="line">        <span class="token function">cp</span> <span class="token string">&quot;<span class="token variable">$lib</span>&quot;</span> <span class="token string">&quot;<span class="token variable">$rootfs</span><span class="token variable">$lib</span>&quot;</span></span>
<span class="line">    <span class="token keyword">done</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 2. 设置挂载传播</span></span>
<span class="line">    <span class="token function">mount</span> --make-private /</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 3. bind挂载rootfs到自身</span></span>
<span class="line">    <span class="token function">mount</span> <span class="token parameter variable">--bind</span> <span class="token string">&quot;<span class="token variable">$rootfs</span>&quot;</span> <span class="token string">&quot;<span class="token variable">$rootfs</span>&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 4. 切换到新namespace中执行</span></span>
<span class="line">    unshare <span class="token parameter variable">--mount</span> <span class="token parameter variable">--pid</span> <span class="token parameter variable">--fork</span> /bin/bash <span class="token parameter variable">-c</span> <span class="token string">&quot;</span>
<span class="line">        # 在新的mount namespace中</span>
<span class="line">        cd &#39;<span class="token variable">$rootfs</span>&#39;</span>
<span class="line">        </span>
<span class="line">        # 挂载特殊文件系统</span>
<span class="line">        mount -t proc proc proc/</span>
<span class="line">        mount -t sysfs sysfs sys/</span>
<span class="line">        mount -t tmpfs tmpfs tmp/ -o size=100M</span>
<span class="line">        </span>
<span class="line">        # 创建设备节点</span>
<span class="line">        mkdir -p dev</span>
<span class="line">        mknod dev/null c 1 3</span>
<span class="line">        mknod dev/zero c 1 5</span>
<span class="line">        mknod dev/random c 1 8</span>
<span class="line">        </span>
<span class="line">        # 创建符号链接</span>
<span class="line">        ln -sf /proc/self/fd dev/fd</span>
<span class="line">        ln -sf /proc/self/fd/0 dev/stdin</span>
<span class="line">        ln -sf /proc/self/fd/1 dev/stdout</span>
<span class="line">        ln -sf /proc/self/fd/2 dev/stderr</span>
<span class="line">        </span>
<span class="line">        # 执行pivot_root</span>
<span class="line">        mkdir -p &#39;<span class="token variable">$old_root</span>&#39;</span>
<span class="line">        pivot_root . &#39;<span class="token variable">$old_root</span>&#39;</span>
<span class="line">        </span>
<span class="line">        # 卸载旧根</span>
<span class="line">        umount /<span class="token variable">$old_root</span> 2&gt;/dev/null || true</span>
<span class="line">        rmdir /<span class="token variable">$old_root</span> 2&gt;/dev/null || true</span>
<span class="line">        </span>
<span class="line">        # 进入容器环境</span>
<span class="line">        cd /</span>
<span class="line">        exec /bin/sh</span>
<span class="line">    &quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 执行实验</span></span>
<span class="line">create_container_rootfs</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-3-挂载选项解析测试" tabindex="-1"><a class="header-anchor" href="#_7-3-挂载选项解析测试"><span>7.3 挂载选项解析测试</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 实验 3: 理解挂载选项解析</span></span>
<span class="line"><span class="token keyword">package</span> main</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;fmt&quot;</span></span>
<span class="line">    <span class="token string">&quot;strings&quot;</span></span>
<span class="line">    <span class="token string">&quot;golang.org/x/sys/unix&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">parseMountOptions</span><span class="token punctuation">(</span>options <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> flags <span class="token builtin">int</span></span>
<span class="line">    <span class="token keyword">var</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span></span>
<span class="line">    </span>
<span class="line">    mountFlags <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span>clear <span class="token builtin">bool</span><span class="token punctuation">;</span> flag <span class="token builtin">int</span><span class="token punctuation">}</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&quot;ro&quot;</span><span class="token punctuation">:</span>     <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_RDONLY<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rw&quot;</span><span class="token punctuation">:</span>     <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_RDONLY<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;nosuid&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NOSUID<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;suid&quot;</span><span class="token punctuation">:</span>   <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NOSUID<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;bind&quot;</span><span class="token punctuation">:</span>   <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_BIND<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rbind&quot;</span><span class="token punctuation">:</span>  <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_BIND <span class="token operator">|</span> unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> opt <span class="token operator">:=</span> <span class="token keyword">range</span> options <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> f<span class="token punctuation">,</span> exists <span class="token operator">:=</span> mountFlags<span class="token punctuation">[</span>opt<span class="token punctuation">]</span><span class="token punctuation">;</span> exists <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> f<span class="token punctuation">.</span>clear <span class="token punctuation">{</span></span>
<span class="line">                flags <span class="token operator">&amp;=</span> <span class="token operator">^</span>f<span class="token punctuation">.</span>flag</span>
<span class="line">                fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Cleared flag: %s\n&quot;</span><span class="token punctuation">,</span> opt<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                flags <span class="token operator">|=</span> f<span class="token punctuation">.</span>flag</span>
<span class="line">                fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Set flag: %s\n&quot;</span><span class="token punctuation">,</span> opt<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            data <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> opt<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Final flags: %d\n&quot;</span><span class="token punctuation">,</span> flags<span class="token punctuation">)</span></span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Data: %s\n&quot;</span><span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 测试不同选项组合</span></span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;=== Test 1: ro,nosuid,bind ===&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">parseMountOptions</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;ro&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;nosuid&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bind&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;\n=== Test 2: rw,suid,rbind,size=100M ===&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">parseMountOptions</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;rw&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;suid&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rbind&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;size=100M&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;\n=== Test 3: ro then rw ===&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">parseMountOptions</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;ro&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rw&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-4-文件系统安全测试" tabindex="-1"><a class="header-anchor" href="#_7-4-文件系统安全测试"><span>7.4 文件系统安全测试</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># 实验 4: 测试文件系统安全机制</span></span>
<span class="line"></span>
<span class="line"><span class="token function-name function">test_path_traversal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;=== Path Traversal Test ===&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 创建容器rootfs</span></span>
<span class="line">    <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /tmp/container/<span class="token punctuation">{</span>rootfs,host-secret<span class="token punctuation">}</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;secret content&quot;</span> <span class="token operator">&gt;</span> /tmp/container/host-secret/secret.txt</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 测试路径遍历防护</span></span>
<span class="line">    <span class="token function">ln</span> <span class="token parameter variable">-sf</span> <span class="token punctuation">..</span>/host-secret /tmp/container/rootfs/escape</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># runc会防止这种符号链接逃逸</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;Attempting to access: /tmp/container/rootfs/escape/secret.txt&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 模拟securejoin检查</span></span>
<span class="line">    <span class="token keyword">if</span> readlink /tmp/container/rootfs/escape <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token string">&quot;\.\.&quot;</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;Path traversal detected and blocked!&quot;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token function-name function">test_proc_mount_security</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;=== /proc Mount Security Test ===&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /tmp/test-proc/rootfs/proc</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 允许的/proc挂载</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;Testing allowed /proc paths:&quot;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token for-or-select variable">path</span> <span class="token keyword">in</span> <span class="token string">&quot;/proc/cpuinfo&quot;</span> <span class="token string">&quot;/proc/meminfo&quot;</span> <span class="token string">&quot;/proc/uptime&quot;</span><span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  <span class="token variable">$path</span> - ALLOWED&quot;</span></span>
<span class="line">    <span class="token keyword">done</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 禁止的/proc挂载</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;Testing forbidden /proc paths:&quot;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token for-or-select variable">path</span> <span class="token keyword">in</span> <span class="token string">&quot;/proc/1/maps&quot;</span> <span class="token string">&quot;/proc/sys/kernel/core_pattern&quot;</span> <span class="token string">&quot;/proc/kcore&quot;</span><span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  <span class="token variable">$path</span> - BLOCKED&quot;</span></span>
<span class="line">    <span class="token keyword">done</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token function-name function">test_bind_mount_flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;=== Bind Mount Flags Test ===&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 创建源目录和文件</span></span>
<span class="line">    <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /tmp/bind-test/source</span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;test&quot;</span> <span class="token operator">&gt;</span> /tmp/bind-test/source/file.txt</span>
<span class="line">    <span class="token function">chmod</span> <span class="token number">777</span> /tmp/bind-test/source/file.txt</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 测试只读bind挂载</span></span>
<span class="line">    <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /tmp/bind-test/target</span>
<span class="line">    <span class="token function">mount</span> <span class="token parameter variable">--bind</span> /tmp/bind-test/source /tmp/bind-test/target</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 尝试重新挂载为只读</span></span>
<span class="line">    <span class="token function">mount</span> <span class="token parameter variable">-o</span> remount,ro /tmp/bind-test/target</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 测试写入（应该失败）</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;write test&quot;</span> <span class="token operator">&gt;</span> /tmp/bind-test/target/file.txt <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;ERROR: Read-only bind mount failed!&quot;</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;SUCCESS: Read-only bind mount working&quot;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">umount</span> /tmp/bind-test/target</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 运行测试</span></span>
<span class="line">test_path_traversal</span>
<span class="line">test_proc_mount_security  </span>
<span class="line">test_bind_mount_flags</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 清理</span></span>
<span class="line"><span class="token function">rm</span> <span class="token parameter variable">-rf</span> /tmp/container /tmp/test-proc /tmp/bind-test</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-故障排除和调试" tabindex="-1"><a class="header-anchor" href="#_8-故障排除和调试"><span>8. 故障排除和调试</span></a></h2><h3 id="_8-1-常见挂载问题诊断" tabindex="-1"><a class="header-anchor" href="#_8-1-常见挂载问题诊断"><span>8.1 常见挂载问题诊断</span></a></h3><h4 id="权限问题" tabindex="-1"><a class="header-anchor" href="#权限问题"><span>权限问题</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 检查当前挂载情况</span></span>
<span class="line"><span class="token function">mount</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">&quot;container\|runc&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检查文件系统权限</span></span>
<span class="line"><span class="token function">ls</span> <span class="token parameter variable">-la</span> /proc/self/ns/mnt  <span class="token comment"># mount namespace</span></span>
<span class="line"><span class="token function">ls</span> <span class="token parameter variable">-la</span> /sys/fs/cgroup     <span class="token comment"># cgroup文件系统</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检查用户权限</span></span>
<span class="line"><span class="token function">id</span></span>
<span class="line"><span class="token function">groups</span></span>
<span class="line"><span class="token function">cat</span> /proc/self/uid_map</span>
<span class="line"><span class="token function">cat</span> /proc/self/gid_map</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="挂载传播问题" tabindex="-1"><a class="header-anchor" href="#挂载传播问题"><span>挂载传播问题</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 检查挂载传播属性</span></span>
<span class="line"><span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">&quot;shared|slave|private&quot;</span> /proc/self/mountinfo</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看特定挂载点的传播属性</span></span>
<span class="line">findmnt <span class="token parameter variable">-o</span> TARGET,PROPAGATION /</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 修复传播属性</span></span>
<span class="line"><span class="token function">mount</span> --make-private /</span>
<span class="line"><span class="token function">mount</span> --make-slave /</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-调试工具和方法" tabindex="-1"><a class="header-anchor" href="#_8-2-调试工具和方法"><span>8.2 调试工具和方法</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># strace 跟踪挂载系统调用</span></span>
<span class="line"><span class="token function">strace</span> <span class="token parameter variable">-f</span> <span class="token parameter variable">-e</span> <span class="token assign-left variable">trace</span><span class="token operator">=</span>mount,umount,pivot_root runc create container</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 使用 nsenter 进入容器的 mount namespace</span></span>
<span class="line">nsenter <span class="token parameter variable">-m</span> <span class="token parameter variable">-p</span> <span class="token parameter variable">-t</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> inspect <span class="token parameter variable">-f</span> <span class="token string">&#39;{{.State.Pid}}&#39;</span> container<span class="token variable">)</span></span> /bin/sh</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检查容器内的挂载情况</span></span>
<span class="line">nsenter <span class="token parameter variable">-m</span> <span class="token parameter variable">-t</span> PID <span class="token function">cat</span> /proc/mounts</span>
<span class="line">nsenter <span class="token parameter variable">-m</span> <span class="token parameter variable">-t</span> PID findmnt</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 调试 runc 挂载过程</span></span>
<span class="line"><span class="token assign-left variable">RUNC_DEBUG</span><span class="token operator">=</span><span class="token number">1</span> runc create container <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-i</span> <span class="token function">mount</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-3-性能分析" tabindex="-1"><a class="header-anchor" href="#_8-3-性能分析"><span>8.3 性能分析</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 测量挂载操作时间</span></span>
<span class="line"><span class="token function">time</span> runc create container</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 分析I/O性能</span></span>
<span class="line">iostat <span class="token parameter variable">-x</span> <span class="token number">1</span> <span class="token number">10</span> <span class="token operator">&amp;</span></span>
<span class="line">runc run container</span>
<span class="line"><span class="token function">kill</span> %1</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 内存使用分析</span></span>
<span class="line">/usr/bin/time <span class="token parameter variable">-v</span> runc run container</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-思考题" tabindex="-1"><a class="header-anchor" href="#_9-思考题"><span>9. 思考题</span></a></h2><h3 id="_9-1-架构设计思考" tabindex="-1"><a class="header-anchor" href="#_9-1-架构设计思考"><span>9.1 架构设计思考</span></a></h3><ol><li><p><strong>rootfs切换方式</strong>: pivot_root vs MS_MOVE vs chroot 的优缺点对比，什么场景下选择哪种方式？</p></li><li><p><strong>挂载传播</strong>: 为什么容器需要 MS_SLAVE 传播属性？如果使用 MS_SHARED 会有什么风险？</p></li><li><p><strong>bind挂载复杂性</strong>: 为什么 bind 挂载需要 remount 来应用标志？locked flags 问题如何更优雅地解决？</p></li></ol><h3 id="_9-2-安全性思考" tabindex="-1"><a class="header-anchor" href="#_9-2-安全性思考"><span>9.2 安全性思考</span></a></h3><ol start="4"><li><p><strong>/proc安全</strong>: 除了白名单机制，还有什么方法可以增强 /proc 挂载的安全性？</p></li><li><p><strong>路径遍历</strong>: securejoin 机制能否防御所有的路径遍历攻击？还有什么潜在漏洞？</p></li><li><p><strong>idmapped mounts</strong>: idmapped mounts 在什么场景下最有价值？有什么安全风险？</p></li></ol><h3 id="_9-3-性能优化思考" tabindex="-1"><a class="header-anchor" href="#_9-3-性能优化思考"><span>9.3 性能优化思考</span></a></h3><ol start="7"><li><p><strong>挂载开销</strong>: 大量挂载点对容器启动性能的影响？如何优化？</p></li><li><p><strong>文件系统选择</strong>: 不同 rootfs 文件系统 (ext4/xfs/overlay) 对性能的影响？</p></li><li><p><strong>内存使用</strong>: tmpfs 的内存使用如何控制？何时选择 tmpfs vs bind mount？</p></li></ol><h2 id="_10-扩展阅读" tabindex="-1"><a class="header-anchor" href="#_10-扩展阅读"><span>10. 扩展阅读</span></a></h2><h3 id="_10-1-linux-内核文档" tabindex="-1"><a class="header-anchor" href="#_10-1-linux-内核文档"><span>10.1 Linux 内核文档</span></a></h3><ul><li><a href="https://man7.org/linux/man-pages/man7/mount_namespaces.7.html" target="_blank" rel="noopener noreferrer">Mount namespaces<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://man7.org/linux/man-pages/man2/pivot_root.2.html" target="_blank" rel="noopener noreferrer">pivot_root(2)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://man7.org/linux/man-pages/man2/mount.2.html" target="_blank" rel="noopener noreferrer">mount(2)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://man7.org/linux/man-pages/man2/mount_setattr.2.html" target="_blank" rel="noopener noreferrer">mount_setattr(2)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h3 id="_10-2-文件系统技术" tabindex="-1"><a class="header-anchor" href="#_10-2-文件系统技术"><span>10.2 文件系统技术</span></a></h3><ul><li><a href="https://www.kernel.org/doc/Documentation/filesystems/vfs.txt" target="_blank" rel="noopener noreferrer">VFS (Virtual File System)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://lwn.net/Articles/281157/" target="_blank" rel="noopener noreferrer">Bind Mounts<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://lwn.net/Articles/159077/" target="_blank" rel="noopener noreferrer">Mount propagation<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://lwn.net/Articles/837566/" target="_blank" rel="noopener noreferrer">Idmapped mounts<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h3 id="_10-3-容器技术深入" tabindex="-1"><a class="header-anchor" href="#_10-3-容器技术深入"><span>10.3 容器技术深入</span></a></h3><ul><li><a href="https://medium.com/containers-world/filesystem-technology-container-6cfbeac6c0dc" target="_blank" rel="noopener noreferrer">Container filesystems<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://arkfox.com/archive/overlayfs/" target="_blank" rel="noopener noreferrer">OverlayFS and containers<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://blog.quarkslab.com/mount-namespace-linux-kernel.html" target="_blank" rel="noopener noreferrer">Container security with mount namespaces<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h2 id="🎯-模块总结" tabindex="-1"><a class="header-anchor" href="#🎯-模块总结"><span>🎯 模块总结</span></a></h2><p>通过本模块的学习，你应该已经掌握了：</p><p>✅ <strong>Rootfs 切换机制</strong>：理解三种切换方式和适用场景<br> ✅ <strong>挂载类型处理</strong>：掌握各种文件系统的专门处理逻辑<br> ✅ <strong>安全防护机制</strong>：理解路径安全、proc检查等防护措施<br> ✅ <strong>配置解析系统</strong>：熟悉挂载选项的多层映射和解析流程<br> ✅ <strong>故障排除能力</strong>：具备挂载问题诊断和性能优化技能</p><p><strong>下一步</strong>: 进入 <a class="route-link" href="/blog/blogs/cloud-base/runc-deep-dive/06-anquantexingshixian.html">模块 6: 安全特性实现</a>，学习容器安全机制的具体实现。</p></div></div><footer class="page-meta"><div class="meta-item edit-link"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M2 26h28v2H2z" fill="currentColor"></path><path d="M25.4 9c.8-.8.8-2 0-2.8l-3.6-3.6c-.8-.8-2-.8-2.8 0l-15 15V24h6.4l15-15zm-5-5L24 7.6l-3 3L17.4 7l3-3zM6 22v-3.6l10-10l3.6 3.6l-10 10H6z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Edit this page<!--]--></span></span></div><div class="meta-item last-updated"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->更新于 8/12/2025, 4:02:36 PM<!--]--></span></span></div></footer><!----><div class="reco-valine-wrapper"><div id="valine"></div></div></div><div class="page-catalog-container"><h5 class="tip">目录</h5><ul><!--[--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#概述" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="概述"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->概述<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#🎯-学习目标" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="🎯 学习目标"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->🎯 学习目标<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_1-容器文件系统基础" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1. 容器文件系统基础"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1. 容器文件系统基础<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_1-1-什么是容器文件系统" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1.1 什么是容器文件系统？"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1.1 什么是容器文件系统？<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_1-2-文件系统隔离层次" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1.2 文件系统隔离层次"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1.2 文件系统隔离层次<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_2-rootfs-准备和切换机制" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2. Rootfs 准备和切换机制"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2. Rootfs 准备和切换机制<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_2-1-整体流程架构" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.1 整体流程架构"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.1 整体流程架构<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_2-2-prepareroot-根挂载点预处理" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.2 prepareRoot - 根挂载点预处理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.2 prepareRoot - 根挂载点预处理<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_2-3-三种根文件系统切换方式" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.3 三种根文件系统切换方式"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.3 三种根文件系统切换方式<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_3-挂载类型和处理机制" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3. 挂载类型和处理机制"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3. 挂载类型和处理机制<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_3-1-挂载分发器-mounttorootfs" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.1 挂载分发器 - mountToRootfs"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.1 挂载分发器 - mountToRootfs<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_3-2-bind-挂载的复杂处理" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.2 bind 挂载的复杂处理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.2 bind 挂载的复杂处理<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_3-3-新版挂载api支持" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.3 新版挂载API支持"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.3 新版挂载API支持<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_4-特殊文件系统处理" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4. 特殊文件系统处理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4. 特殊文件系统处理<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_4-1-proc-文件系统安全检查" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4.1 /proc 文件系统安全检查"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4.1 /proc 文件系统安全检查<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_4-2-cgroup-文件系统处理" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4.2 cgroup 文件系统处理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4.2 cgroup 文件系统处理<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_4-3-dev-文件系统和设备节点" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4.3 /dev 文件系统和设备节点"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4.3 /dev 文件系统和设备节点<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_5-挂载配置和选项解析" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5. 挂载配置和选项解析"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5. 挂载配置和选项解析<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_5-1-mount-结构定义" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.1 Mount 结构定义"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.1 Mount 结构定义<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_5-2-挂载选项解析机制" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.2 挂载选项解析机制"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.2 挂载选项解析机制<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_5-3-选项解析算法" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.3 选项解析算法"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.3 选项解析算法<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_6-安全机制和错误处理" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6. 安全机制和错误处理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6. 安全机制和错误处理<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_6-1-路径安全处理" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6.1 路径安全处理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6.1 路径安全处理<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_6-2-错误处理和诊断" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6.2 错误处理和诊断"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6.2 错误处理和诊断<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_6-3-只读文件系统加固" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6.3 只读文件系统加固"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6.3 只读文件系统加固<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_7-实践练习" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7. 实践练习"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7. 实践练习<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_7-1-基础挂载实验" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7.1 基础挂载实验"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7.1 基础挂载实验<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_7-2-容器文件系统构建" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7.2 容器文件系统构建"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7.2 容器文件系统构建<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_7-3-挂载选项解析测试" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7.3 挂载选项解析测试"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7.3 挂载选项解析测试<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_7-4-文件系统安全测试" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7.4 文件系统安全测试"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7.4 文件系统安全测试<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_8-故障排除和调试" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8. 故障排除和调试"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8. 故障排除和调试<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_8-1-常见挂载问题诊断" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8.1 常见挂载问题诊断"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8.1 常见挂载问题诊断<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_8-2-调试工具和方法" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8.2 调试工具和方法"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8.2 调试工具和方法<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_8-3-性能分析" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8.3 性能分析"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8.3 性能分析<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_9-思考题" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9. 思考题"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9. 思考题<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_9-1-架构设计思考" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9.1 架构设计思考"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9.1 架构设计思考<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_9-2-安全性思考" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9.2 安全性思考"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9.2 安全性思考<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_9-3-性能优化思考" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9.3 性能优化思考"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9.3 性能优化思考<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_10-扩展阅读" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="10. 扩展阅读"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->10. 扩展阅读<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_10-1-linux-内核文档" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="10.1 Linux 内核文档"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->10.1 Linux 内核文档<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_10-2-文件系统技术" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="10.2 文件系统技术"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->10.2 文件系统技术<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#_10-3-容器技术深入" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="10.3 容器技术深入"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->10.3 容器技术深入<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html#🎯-模块总结" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="🎯 模块总结"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->🎯 模块总结<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--></ul></div></main><!--]--></div></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/blog/assets/app-6X7aTgdN.js" defer></script>
  </body>
</html>

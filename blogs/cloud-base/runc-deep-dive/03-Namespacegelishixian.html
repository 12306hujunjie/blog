<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-rc.19">
    <script>
      (function() {
        const userMode = localStorage.getItem('vuepress-reco-color-scheme') || 'auto';
        const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (userMode === 'dark' || (userMode === 'auto' && systemDarkMode)) {
          document.documentElement.classList.toggle('dark', true);
        }
      })();
    </script>
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.min.js" as="script"><title>Namespace 隔离实现 | database of memory</title><meta name="description" content="study anything and life record">
    <link rel="preload" href="/blog/assets/style-3Js8NCR5.css" as="style"><link rel="stylesheet" href="/blog/assets/style-3Js8NCR5.css">
    <link rel="modulepreload" href="/blog/assets/app-2O6audqE.js"><link rel="modulepreload" href="/blog/assets/03-Namespacegelishixian.html-i58zOLTD.js">
    <link rel="prefetch" href="/blog/assets/timeline.html-Dpj3Uwd1.js" as="script"><link rel="prefetch" href="/blog/assets/posts.html-CwxCj2Hz.js" as="script"><link rel="prefetch" href="/blog/assets/friendship-link.html-BWfmkE8T.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-u-MzmdCM.js" as="script"><link rel="prefetch" href="/blog/assets/2.html-BZ918lqD.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-C0q1hGsM.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CKULWdoq.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CWtVNK-m.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bd6PVF3c.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BbXNqe1N.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DyPCaQFd.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-C18Bjk_W.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BBVLOTuN.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D6KsFqqv.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BFPB5Kke.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B7IkZhlZ.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D_xT1fZZ.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DheB4D6E.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bt_l6w3U.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DeILrr-C.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DSTAwzEO.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BD5fA-NV.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BkRrSqYz.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-cT5R8xwx.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D9YDDbbv.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CbwTJPe7.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BuOxUP39.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BonFf6Hv.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DdMSM_BO.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Cf_rINiA.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DAcku8Eg.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DXT9U0AY.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DNdoOP4f.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-gqCMVOP4.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-HV0Wu9t8.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-LYxcb78a.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B50wkuh6.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DmpqsxHB.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-ChJizRVK.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D91uHYKf.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BLywihRf.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CB6EOmHd.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CxeevLHu.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B6J1fqYY.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D6g5ki7n.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CNoSmcFz.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dg6Odx9T.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dcy99l4T.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BK5mIUzD.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-8yVN6cur.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D33sQ_DA.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BOgMey9f.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D-L5Fugg.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-blGV0Kuf.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Ck4-7Hl7.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-N5xZIiU3.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DHa_luE7.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BDo2AWiQ.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CJj46_t8.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B32LjB8A.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DHAALd4l.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-H_UWlmPh.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DhnB-W5f.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dl8_vnsm.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-AlHvVsZC.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D7E4OavF.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CgCAEUN3.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-4Mr3uCmo.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BWKUAlc0.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CNuv7HDI.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BTkfIlYg.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dqp54iE9.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CtCFev89.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bb4UAQpl.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B6JysInN.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CHu47ESV.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CW5fe8Pz.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CBCt-NmX.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DV90AmxE.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DzWzo9Ij.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bz0VyI0Z.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BjgscHtw.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Cx8p_sw9.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DoYWpPPd.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Ci-xHJlU.js" as="script"><link rel="prefetch" href="/blog/assets/2.html-DwdRHJG4.js" as="script"><link rel="prefetch" href="/blog/assets/3.html-DoXfDGmJ.js" as="script"><link rel="prefetch" href="/blog/assets/4.html-C-kKKJQV.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-fn4kmre_.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CoWvKsGl.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BvQMmH-P.js" as="script"><link rel="prefetch" href="/blog/assets/bitwise_operation.html-EhYVvxM9.js" as="script"><link rel="prefetch" href="/blog/assets/learning_algorithm.html-Tnr40gqi.js" as="script"><link rel="prefetch" href="/blog/assets/cache_pattern.html-BWIGrhub.js" as="script"><link rel="prefetch" href="/blog/assets/docker_tech.html-B7PNaqxh.js" as="script"><link rel="prefetch" href="/blog/assets/k3s.html-DP3vWh7K.js" as="script"><link rel="prefetch" href="/blog/assets/k3s_k8s_ingress.html-0VG_Dn9p.js" as="script"><link rel="prefetch" href="/blog/assets/oci-01-intro-guide.html-CMWMS7fl.js" as="script"><link rel="prefetch" href="/blog/assets/oci-02-runtime-spec.html-C0iBtGsB.js" as="script"><link rel="prefetch" href="/blog/assets/oci-03-image-spec.html-BBhmTevb.js" as="script"><link rel="prefetch" href="/blog/assets/oci-04-distribution-spec.html-BK42sbpW.js" as="script"><link rel="prefetch" href="/blog/assets/oci-05-security-guide.html-B3_bjMcv.js" as="script"><link rel="prefetch" href="/blog/assets/oci-06-monitoring-guide.html-DZeNq5_D.js" as="script"><link rel="prefetch" href="/blog/assets/oci-07-production-guide.html-Dd4znSBp.js" as="script"><link rel="prefetch" href="/blog/assets/oci-08-hooks-deep-dive.html-U722baza.js" as="script"><link rel="prefetch" href="/blog/assets/oci-linux-configurations-blog.html-B-QLbxh0.js" as="script"><link rel="prefetch" href="/blog/assets/oci-series-index.html-CDKgV4-S.js" as="script"><link rel="prefetch" href="/blog/assets/runc-advanced-lifecycle-analysis.html-DksQevmb.js" as="script"><link rel="prefetch" href="/blog/assets/runc-comprehensive-design-guide.html-B3lFgAwq.js" as="script"><link rel="prefetch" href="/blog/assets/runc-container-lifecycle-diagrams.html-D0cL6kcw.js" as="script"><link rel="prefetch" href="/blog/assets/linux_namespace.html-C_6Up541.js" as="script"><link rel="prefetch" href="/blog/assets/python_checklist.html-C2qsWYBJ.js" as="script"><link rel="prefetch" href="/blog/assets/python_env_manage.html-CUnPJ_1B.js" as="script"><link rel="prefetch" href="/blog/assets/gevent.html-CUgqcz3s.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BJAgUlPO.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BO__mOgk.js" as="script"><link rel="prefetch" href="/blog/assets/sort_1.html-B61YFXe2.js" as="script"><link rel="prefetch" href="/blog/assets/01-runcgaishuyujiagou.html-CdwfP7-9.js" as="script"><link rel="prefetch" href="/blog/assets/02-rongqishengmingzhouqiguanli.html-C-f7fScs.js" as="script"><link rel="prefetch" href="/blog/assets/04-Cgroupsziyuanguanli.html-Cv4-SHFL.js" as="script"><link rel="prefetch" href="/blog/assets/05-wenjianxitongyuguazaiguanli.html-BtljxstR.js" as="script"><link rel="prefetch" href="/blog/assets/06-anquantexingshixian.html-BHgpOUyN.js" as="script"><link rel="prefetch" href="/blog/assets/07-CRIUjianchadianyuhuifu.html-2aSuteQG.js" as="script"><link rel="prefetch" href="/blog/assets/08-tongxinyujiankongxitong.html-C1uYqrtr.js" as="script"><link rel="prefetch" href="/blog/assets/09-goujianjianhuarongqiyunxingshi.html-ZL_qjd8j.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DhgGbCoG.js" as="script"><link rel="prefetch" href="/blog/assets/abstract_factory.html-qSB2vqGJ.js" as="script"><link rel="prefetch" href="/blog/assets/factory_method.html-DaXxm691.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CQ2duCZ4.js" as="script"><link rel="prefetch" href="/blog/assets/adapter.html-k-5RMaEx.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-BmtOmY9V.js" as="script"><link rel="prefetch" href="/blog/assets/Valine.min-VCLvSWzF.js" as="script"><link rel="prefetch" href="/blog/assets/giscus-aTimukGI-DWEKOTfS.js" as="script"><link rel="prefetch" href="/blog/assets/KnowledgeMap-Dr6IblrL.js" as="script"><link rel="prefetch" href="/blog/assets/MermaidChart-a1CbfxcL.js" as="script"><link rel="prefetch" href="/blog/assets/mermaid.core-xyQxSs4c.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container series--no show-catalog"><header class="navbar-container not-open"><div class="navbar-inner"><div class="site-brand nav-item"><img class="logo" src="/blog/logo.png" alt="database of memory"><a href="/blog/" class="site-name can-hide">database of memory</a></div><div class="nav-item navbar-links-wrapper" style=""><div><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div><nav class="navbar-links"><!--[--><div class="navbar-links__item"><a href="/blog/" class="link" aria-label="Home"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Home<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/blog/categories/cloud-base/1/" class="link" aria-label="Categories"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Categories<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/blog/tags/runc/1/" class="link" aria-label="Tags"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Tags<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/blog/knowledge-map/" class="link" aria-label="知识地图"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->知识地图<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="Docs"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Docs<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="Docs"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Docs<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/blog/docs/leetcode/" class="link" aria-label="leetcode from scratch"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->leetcode from scratch<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/docs/design_pattern/" class="link" aria-label="design pattern"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->design pattern<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--><!----><span class="xicon-container btn-toggle-dark-mode btn--dark-mode navbar-links__item"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><path d="M15 2h2v3h-2z" fill="currentColor"></path><path d="M27 15h3v2h-3z" fill="currentColor"></path><path d="M15 27h2v3h-2z" fill="currentColor"></path><path d="M2 15h3v2H2z" fill="currentColor"></path><path d="M5.45 6.884l1.414-1.415l2.121 2.122l-1.414 1.414z" fill="currentColor"></path><path d="M23 7.58l2.121-2.12l1.414 1.414l-2.121 2.121z" fill="currentColor"></path><path d="M23.002 24.416l1.415-1.414l2.12 2.122l-1.413 1.414z" fill="currentColor"></path><path d="M5.47 25.13L7.59 23L9 24.42l-2.12 2.12l-1.41-1.41z" fill="currentColor"></path><path d="M16 8a8 8 0 1 0 8 8a8 8 0 0 0-8-8zm0 14a6 6 0 0 1 0-12z" fill="currentColor"></path></svg></span><ul class="social-links navbar-links__item"><!--[--><li class="social-item"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:25px;height:25px;"><path d="M16 2a14 14 0 0 0-4.43 27.28c.7.13 1-.3 1-.67v-2.38c-3.89.84-4.71-1.88-4.71-1.88a3.71 3.71 0 0 0-1.62-2.05c-1.27-.86.1-.85.1-.85a2.94 2.94 0 0 1 2.14 1.45a3 3 0 0 0 4.08 1.16a2.93 2.93 0 0 1 .88-1.87c-3.1-.36-6.37-1.56-6.37-6.92a5.4 5.4 0 0 1 1.44-3.76a5 5 0 0 1 .14-3.7s1.17-.38 3.85 1.43a13.3 13.3 0 0 1 7 0c2.67-1.81 3.84-1.43 3.84-1.43a5 5 0 0 1 .14 3.7a5.4 5.4 0 0 1 1.44 3.76c0 5.38-3.27 6.56-6.39 6.91a3.33 3.33 0 0 1 .95 2.59v3.84c0 .46.25.81 1 .67A14 14 0 0 0 16 2z" fill-rule="evenodd" fill="currentColor"></path></svg></li><!--]--></ul></nav><span class="xicon-container btn-toggle-menus"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><circle cx="16" cy="8" r="2" fill="currentColor"></circle><circle cx="16" cy="16" r="2" fill="currentColor"></circle><circle cx="16" cy="24" r="2" fill="currentColor"></circle></svg></span></div></div></header><!----><!----><!----><div class="theme-main" style=""><!----><!--[--><main class="page-container"><div class="page-content"><h1 class="page-title">Namespace 隔离实现</h1><div class="page-info"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M16 4a5 5 0 1 1-5 5a5 5 0 0 1 5-5m0-2a7 7 0 1 0 7 7a7 7 0 0 0-7-7z" fill="currentColor"></path><path d="M26 30h-2v-5a5 5 0 0 0-5-5h-6a5 5 0 0 0-5 5v5H6v-5a7 7 0 0 1 7-7h6a7 7 0 0 1 7 7z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->hujunjie<!--]--></span></span><!----><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M11.17 6l3.42 3.41l.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[--><!--[--><a href="/blog/categories/cloud-base/runc-deep-dive/1.html" class="">cloud-base/runc-deep-dive</a><!--]--><!--]--></span></span><!----><!----></div><div class="theme-reco-md-content"><div><h1 id="namespace-隔离实现" tabindex="-1"><a class="header-anchor" href="#namespace-隔离实现"><span>Namespace 隔离实现</span></a></h1><blockquote><p><strong>系列导航：</strong> <a class="route-link" href="/blog/blogs/cloud-base/runc-deep-dive/">runc 容器运行时深度解析系列</a> → 第三篇：Namespace 隔离实现<br><strong>上一篇：</strong> <a class="route-link" href="/blog/blogs/cloud-base/runc-deep-dive/02-rongqishengmingzhouqiguanli.html">容器生命周期管理</a><br><strong>最后更新：</strong> 2024</p></blockquote><h2 id="概述" tabindex="-1"><a class="header-anchor" href="#概述"><span>概述</span></a></h2><p>本文深入分析 runc 如何实现 Linux Namespace 隔离机制，这是容器技术的核心基础之一。通过 Namespace，容器可以拥有独立的进程空间、网络栈、文件系统视图等，实现与宿主机和其他容器的有效隔离。</p><h2 id="🎯-学习目标" tabindex="-1"><a class="header-anchor" href="#🎯-学习目标"><span>🎯 学习目标</span></a></h2><p>完成本模块后，你将能够：</p><ul><li>深入理解 Linux Namespace 的 8 种类型和作用机制</li><li>掌握 runc 中三阶段进程创建模型的设计原理</li><li>理解 nsenter 的 C 代码实现和系统调用封装</li><li>掌握 namespace 创建、加入和管理的完整流程</li><li>具备调试和定制 namespace 隔离功能的能力</li></ul><h2 id="_1-linux-namespace-基础概念" tabindex="-1"><a class="header-anchor" href="#_1-linux-namespace-基础概念"><span>1. Linux Namespace 基础概念</span></a></h2><h3 id="_1-1-什么是-namespace" tabindex="-1"><a class="header-anchor" href="#_1-1-什么是-namespace"><span>1.1 什么是 Namespace？</span></a></h3><p><strong>Namespace</strong> 是 Linux 内核提供的一种资源隔离机制，它可以让不同的进程组看到不同的系统视图，实现进程级别的虚拟化。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">┌─────────────────────────────────────────────────┐</span>
<span class="line">│                物理机器                         │</span>
<span class="line">├─────────────────┬───────────────────────────────┤</span>
<span class="line">│   容器 A        │        容器 B                 │</span>
<span class="line">│                 │                               │</span>
<span class="line">│ PID: 1,2,3      │     PID: 1,2,3               │</span>
<span class="line">│ NET: eth0       │     NET: eth0                │</span>
<span class="line">│ MNT: /app       │     MNT: /data               │</span>
<span class="line">│ UTS: web-01     │     UTS: db-01               │</span>
<span class="line">└─────────────────┴───────────────────────────────┘</span>
<span class="line">       ▲                        ▲</span>
<span class="line">       │        共享内核         │</span>
<span class="line">   namespace A             namespace B</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>核心特性</strong>：</p><ul><li>🔒 <strong>隔离性</strong>: 每个 namespace 内的进程只能看到自己的资源</li><li>🧬 <strong>继承性</strong>: 子进程继承父进程的 namespace</li><li>🔄 <strong>可加入</strong>: 进程可以加入已存在的 namespace</li><li>🏗️ <strong>可嵌套</strong>: 某些 namespace 支持嵌套结构</li></ul><h3 id="_1-2-八种-namespace-类型详解" tabindex="-1"><a class="header-anchor" href="#_1-2-八种-namespace-类型详解"><span>1.2 八种 Namespace 类型详解</span></a></h3><h4 id="a-pid-namespace-进程id隔离" tabindex="-1"><a class="header-anchor" href="#a-pid-namespace-进程id隔离"><span>A. PID Namespace (进程ID隔离)</span></a></h4><p><strong>作用</strong>: 隔离进程 ID 空间，每个 PID namespace 都有自己的 PID 1 (init进程)</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/configs/namespaces_linux.go:15</span></span>
<span class="line"><span class="token keyword">const</span> NEWPID NamespaceType <span class="token operator">=</span> <span class="token string">&quot;NEWPID&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>关键特性</strong>：</p><ul><li>容器内的 PID 1 进程负责回收僵尸进程</li><li>内外 PID 映射：容器内 PID 1 对应宿主机上某个 PID</li><li>嵌套支持：可以创建多层 PID namespace</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">宿主机视图:        容器内视图:</span>
<span class="line">PID 1: systemd    PID 1: /bin/bash  ← 容器的 init 进程</span>
<span class="line">PID 1234: runc    PID 2: /app       ← 应用进程</span>
<span class="line">PID 1235: bash    (不可见其他进程)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="b-network-namespace-网络隔离" tabindex="-1"><a class="header-anchor" href="#b-network-namespace-网络隔离"><span>B. Network Namespace (网络隔离)</span></a></h4><p><strong>作用</strong>: 隔离网络设备、IP地址、端口、路由表等网络资源</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">const</span> NEWNET NamespaceType <span class="token operator">=</span> <span class="token string">&quot;NEWNET&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>隔离资源</strong>：</p><ul><li>网络接口(eth0, lo等)</li><li>IP地址和路由表</li><li>iptables规则</li><li>网络端口范围</li><li>/proc/net 目录内容</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">┌─────────────────┐    ┌─────────────────┐</span>
<span class="line">│   宿主机网络     │    │   容器网络       │</span>
<span class="line">│                 │    │                 │</span>
<span class="line">│ eth0: 10.0.0.1  │    │ eth0: 172.17.0.2│</span>
<span class="line">│ lo: 127.0.0.1   │    │ lo: 127.0.0.1   │</span>
<span class="line">│ 路由表: 默认     │    │ 路由表: 隔离     │</span>
<span class="line">└─────────────────┘    └─────────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="c-mount-namespace-文件系统隔离" tabindex="-1"><a class="header-anchor" href="#c-mount-namespace-文件系统隔离"><span>C. Mount Namespace (文件系统隔离)</span></a></h4><p><strong>作用</strong>: 隔离文件系统挂载点，每个 mount namespace 有独立的挂载点列表</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">const</span> NEWNS NamespaceType <span class="token operator">=</span> <span class="token string">&quot;NEWNS&quot;</span>  <span class="token comment">// 历史原因，NS是最早的namespace</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>隔离内容</strong>：</p><ul><li>挂载点列表(/proc/mounts)</li><li>根文件系统(/)</li><li>挂载传播属性(private, shared, slave等)</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">宿主机挂载:              容器内挂载:</span>
<span class="line">/dev/sda1 -&gt; /          /dev/sda2 -&gt; /</span>
<span class="line">/dev/sda2 -&gt; /home      tmpfs -&gt; /tmp</span>
<span class="line">tmpfs -&gt; /tmp           /dev/sda3 -&gt; /data</span>
<span class="line">                        overlay -&gt; /app</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="d-user-namespace-用户权限隔离" tabindex="-1"><a class="header-anchor" href="#d-user-namespace-用户权限隔离"><span>D. User Namespace (用户权限隔离)</span></a></h4><p><strong>作用</strong>: 隔离用户ID和组ID，实现用户权限映射</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">const</span> NEWUSER NamespaceType <span class="token operator">=</span> <span class="token string">&quot;NEWUSER&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>核心概念</strong>：</p><ul><li>ID 映射：容器内 UID/GID 映射到宿主机的不同 UID/GID</li><li>权限隔离：容器内的 root 用户不等同于宿主机 root</li><li>无特权容器：普通用户也可以创建容器</li></ul><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// ID映射配置示例</span></span>
<span class="line"><span class="token keyword">type</span> IDMap <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    ContainerID <span class="token builtin">int64</span>  <span class="token comment">// 容器内ID: 0 (root)</span></span>
<span class="line">    HostID      <span class="token builtin">int64</span>  <span class="token comment">// 宿主机ID: 1000 (普通用户)</span></span>
<span class="line">    Size        <span class="token builtin">int64</span>  <span class="token comment">// 映射范围: 65536</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>映射示例</strong>：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">容器内视图:        宿主机视图:</span>
<span class="line">UID 0 (root)   →  UID 1000 (user)</span>
<span class="line">UID 1 (user)   →  UID 1001 </span>
<span class="line">UID 100        →  UID 1100</span>
<span class="line">...            →  ...</span>
<span class="line">UID 65535      →  UID 66535</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="e-ipc-namespace-进程间通信隔离" tabindex="-1"><a class="header-anchor" href="#e-ipc-namespace-进程间通信隔离"><span>E. IPC Namespace (进程间通信隔离)</span></a></h4><p><strong>作用</strong>: 隔离 System V IPC 和 POSIX 消息队列</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">const</span> NEWIPC NamespaceType <span class="token operator">=</span> <span class="token string">&quot;NEWIPC&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>隔离资源</strong>：</p><ul><li>System V 消息队列、信号量、共享内存</li><li>POSIX 消息队列</li><li>/proc/sysvipc/ 内容</li></ul><h4 id="f-uts-namespace-主机名隔离" tabindex="-1"><a class="header-anchor" href="#f-uts-namespace-主机名隔离"><span>F. UTS Namespace (主机名隔离)</span></a></h4><p><strong>作用</strong>: 隔离主机名(hostname)和域名(domainname)</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">const</span> NEWUTS NamespaceType <span class="token operator">=</span> <span class="token string">&quot;NEWUTS&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>应用场景</strong>：</p><ul><li>容器有独立的主机名</li><li>微服务架构中的服务标识</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 宿主机</span></span>
<span class="line">$ <span class="token function">hostname</span></span>
<span class="line">host-machine</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 容器内</span></span>
<span class="line">$ <span class="token function">hostname</span>  </span>
<span class="line">web-server-01</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="g-cgroup-namespace-控制组隔离" tabindex="-1"><a class="header-anchor" href="#g-cgroup-namespace-控制组隔离"><span>G. Cgroup Namespace (控制组隔离)</span></a></h4><p><strong>作用</strong>: 隔离 cgroups 视图，容器内看不到宿主机的完整 cgroups 树</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">const</span> NEWCGROUP NamespaceType <span class="token operator">=</span> <span class="token string">&quot;NEWCGROUP&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>特性</strong>：</p><ul><li>虚拟化 /proc/cgroups 和 /proc/self/cgroup 内容</li><li>隐藏宿主机的 cgroups 层次结构</li></ul><h4 id="h-time-namespace-时间隔离" tabindex="-1"><a class="header-anchor" href="#h-time-namespace-时间隔离"><span>H. Time Namespace (时间隔离)</span></a></h4><p><strong>作用</strong>: 隔离系统时间，容器可以有不同的时间视图</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">const</span> NEWTIME NamespaceType <span class="token operator">=</span> <span class="token string">&quot;NEWTIME&quot;</span>  <span class="token comment">// Linux 5.6+ 支持</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>应用场景</strong>：</p><ul><li>时间旅行测试</li><li>不同时区的应用</li></ul><h2 id="_2-runc-的-namespace-实现架构" tabindex="-1"><a class="header-anchor" href="#_2-runc-的-namespace-实现架构"><span>2. runc 的 Namespace 实现架构</span></a></h2><h3 id="_2-1-核心数据结构" tabindex="-1"><a class="header-anchor" href="#_2-1-核心数据结构"><span>2.1 核心数据结构</span></a></h3><h4 id="namespace-配置结构" tabindex="-1"><a class="header-anchor" href="#namespace-配置结构"><span>Namespace 配置结构</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/configs/namespaces_linux.go:55</span></span>
<span class="line"><span class="token keyword">type</span> Namespace <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Type NamespaceType <span class="token string">`json:&quot;type&quot;`</span>         <span class="token comment">// namespace 类型</span></span>
<span class="line">    Path <span class="token builtin">string</span>        <span class="token string">`json:&quot;path,omitempty&quot;`</span> <span class="token comment">// 加入现有 namespace 的路径</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> Namespaces <span class="token punctuation">[</span><span class="token punctuation">]</span>Namespace</span>
<span class="line"></span>
<span class="line"><span class="token comment">// 检查是否包含特定类型的 namespace</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>n Namespaces<span class="token punctuation">)</span> <span class="token function">Contains</span><span class="token punctuation">(</span>t NamespaceType<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ns <span class="token operator">:=</span> <span class="token keyword">range</span> n <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> ns<span class="token punctuation">.</span>Type <span class="token operator">==</span> t <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="系统调用映射" tabindex="-1"><a class="header-anchor" href="#系统调用映射"><span>系统调用映射</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/configs/namespaces_syscall.go:12</span></span>
<span class="line"><span class="token keyword">var</span> namespaceInfo <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span>NamespaceType<span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span></span>
<span class="line">    NEWNET<span class="token punctuation">:</span>    unix<span class="token punctuation">.</span>CLONE_NEWNET<span class="token punctuation">,</span>    <span class="token comment">// 0x40000000</span></span>
<span class="line">    NEWNS<span class="token punctuation">:</span>     unix<span class="token punctuation">.</span>CLONE_NEWNS<span class="token punctuation">,</span>     <span class="token comment">// 0x00020000  </span></span>
<span class="line">    NEWUSER<span class="token punctuation">:</span>   unix<span class="token punctuation">.</span>CLONE_NEWUSER<span class="token punctuation">,</span>   <span class="token comment">// 0x10000000</span></span>
<span class="line">    NEWIPC<span class="token punctuation">:</span>    unix<span class="token punctuation">.</span>CLONE_NEWIPC<span class="token punctuation">,</span>    <span class="token comment">// 0x08000000</span></span>
<span class="line">    NEWUTS<span class="token punctuation">:</span>    unix<span class="token punctuation">.</span>CLONE_NEWUTS<span class="token punctuation">,</span>    <span class="token comment">// 0x04000000</span></span>
<span class="line">    NEWPID<span class="token punctuation">:</span>    unix<span class="token punctuation">.</span>CLONE_NEWPID<span class="token punctuation">,</span>    <span class="token comment">// 0x20000000</span></span>
<span class="line">    NEWCGROUP<span class="token punctuation">:</span> unix<span class="token punctuation">.</span>CLONE_NEWCGROUP<span class="token punctuation">,</span> <span class="token comment">// 0x02000000</span></span>
<span class="line">    NEWTIME<span class="token punctuation">:</span>   unix<span class="token punctuation">.</span>CLONE_NEWTIME<span class="token punctuation">,</span>   <span class="token comment">// 0x00000080</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 生成 clone 系统调用标志</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>n Namespaces<span class="token punctuation">)</span> <span class="token function">CloneFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">uintptr</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> flag <span class="token builtin">int</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ns <span class="token operator">:=</span> <span class="token keyword">range</span> n <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> ns<span class="token punctuation">.</span>Path <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">continue</span>  <span class="token comment">// 加入现有 namespace，不需要创建新的</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        flag <span class="token operator">|=</span> namespaceInfo<span class="token punctuation">[</span>ns<span class="token punctuation">.</span>Type<span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-三阶段进程创建模型" tabindex="-1"><a class="header-anchor" href="#_2-2-三阶段进程创建模型"><span>2.2 三阶段进程创建模型</span></a></h3><p>runc 采用独特的三阶段进程创建模型来处理 namespace 的复杂性：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">用户调用: runc create mycontainer</span>
<span class="line">│</span>
<span class="line">▼</span>
<span class="line">┌─────────────────────────────────────────────────┐</span>
<span class="line">│  阶段0: 父进程 (STAGE_PARENT)                   │</span>
<span class="line">│  职责: 用户映射设置、进程协调                    │</span>
<span class="line">│  进程: runc 主进程                              │</span>
<span class="line">└─────────────┬───────────────────────────────────┘</span>
<span class="line">              │ fork() + nsenter</span>
<span class="line">              ▼</span>
<span class="line">┌─────────────────────────────────────────────────┐</span>
<span class="line">│  阶段1: 中间子进程 (STAGE_CHILD)                │</span>
<span class="line">│  职责: 加入/创建 namespace、权限处理             │</span>
<span class="line">│  进程: bootstrap 进程                           │</span>
<span class="line">└─────────────┬───────────────────────────────────┘</span>
<span class="line">              │ fork() </span>
<span class="line">              ▼</span>
<span class="line">┌─────────────────────────────────────────────────┐</span>
<span class="line">│  阶段2: 最终进程 (STAGE_INIT)                   │</span>
<span class="line">│  职责: 容器初始化、执行用户程序                  │</span>
<span class="line">│  进程: 容器的 init 进程                         │</span>
<span class="line">└─────────────────────────────────────────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="为什么需要三阶段" tabindex="-1"><a class="header-anchor" href="#为什么需要三阶段"><span>为什么需要三阶段？</span></a></h4><ol><li><strong>权限处理复杂性</strong>: 用户 namespace 需要先设置映射才能操作其他 namespace</li><li><strong>时序依赖</strong>: 某些 namespace 的创建顺序很重要</li><li><strong>同步需求</strong>: 父进程需要设置子进程的用户映射</li><li><strong>安全考虑</strong>: 最终进程不应该有不必要的权限</li></ol><h3 id="_2-3-nsenter-核心实现" tabindex="-1"><a class="header-anchor" href="#_2-3-nsenter-核心实现"><span>2.3 nsenter 核心实现</span></a></h3><h4 id="c-代码结构" tabindex="-1"><a class="header-anchor" href="#c-代码结构"><span>C 代码结构</span></a></h4><p>runc 使用 C 代码实现底层 namespace 操作，主要文件：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">libcontainer/nsenter/</span>
<span class="line">├── nsexec.c          # 主要实现文件</span>
<span class="line">├── namespace.h       # 命名空间常量定义  </span>
<span class="line">├── log.c/log.h       # 日志记录</span>
<span class="line">└── nsenter.go        # Go 与 C 的接口</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="主入口函数" tabindex="-1"><a class="header-anchor" href="#主入口函数"><span>主入口函数</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// libcontainer/nsenter/nsexec.c:638</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">nsexec</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span> pipenum<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">nlconfig_t</span> config <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 1. 解析配置和同步管道</span></span>
<span class="line">    pipenum <span class="token operator">=</span> <span class="token function">initpipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>pipenum <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 从管道读取配置信息</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">nlconfig_parse</span><span class="token punctuation">(</span>pipenum<span class="token punctuation">,</span> <span class="token operator">&amp;</span>config<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to parse netlink config&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 根据阶段执行不同逻辑</span></span>
<span class="line">    <span class="token keyword">switch</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>stage<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> STAGE_PARENT<span class="token operator">:</span>  </span>
<span class="line">        <span class="token function">parent_stage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">case</span> STAGE_CHILD<span class="token operator">:</span>   </span>
<span class="line">        <span class="token function">child_stage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">case</span> STAGE_INIT<span class="token operator">:</span>    </span>
<span class="line">        <span class="token function">init_stage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="配置结构体" tabindex="-1"><a class="header-anchor" href="#配置结构体"><span>配置结构体</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// libcontainer/nsenter/nsexec.c:89</span></span>
<span class="line"><span class="token keyword">struct</span> <span class="token class-name">nlconfig_t</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>                    <span class="token comment">// 序列化数据</span></span>
<span class="line">    <span class="token keyword">int</span> stage<span class="token punctuation">;</span>                     <span class="token comment">// 当前阶段</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// namespace 相关</span></span>
<span class="line">    <span class="token keyword">char</span> <span class="token operator">*</span>namespaces<span class="token punctuation">;</span>              <span class="token comment">// 要加入的 namespace 路径</span></span>
<span class="line">    <span class="token class-name">size_t</span> namespaces_len<span class="token punctuation">;</span>         <span class="token comment">// 长度</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// clone 标志</span></span>
<span class="line">    <span class="token class-name">uint32_t</span> cloneflags<span class="token punctuation">;</span>           <span class="token comment">// clone() 系统调用标志</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 用户映射</span></span>
<span class="line">    <span class="token keyword">char</span> <span class="token operator">*</span>uidmap<span class="token punctuation">,</span> <span class="token operator">*</span>gidmap<span class="token punctuation">;</span>         <span class="token comment">// ID 映射数据</span></span>
<span class="line">    <span class="token keyword">char</span> <span class="token operator">*</span>uidmappath<span class="token punctuation">,</span> <span class="token operator">*</span>gidmappath<span class="token punctuation">;</span> <span class="token comment">// 映射文件路径</span></span>
<span class="line">    <span class="token keyword">int</span> uidmap_len<span class="token punctuation">,</span> gidmap_len<span class="token punctuation">;</span>    <span class="token comment">// 映射数据长度</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 其他配置</span></span>
<span class="line">    <span class="token keyword">char</span> <span class="token operator">*</span>oom_score_adj<span class="token punctuation">;</span>           <span class="token comment">// OOM 分数调整</span></span>
<span class="line">    <span class="token keyword">char</span> <span class="token operator">*</span>rootfs<span class="token punctuation">;</span>                  <span class="token comment">// 根文件系统路径</span></span>
<span class="line">    bool is_rootless_euid<span class="token punctuation">;</span>         <span class="token comment">// 是否为 rootless 模式</span></span>
<span class="line">    bool is_setgroup<span class="token punctuation">;</span>              <span class="token comment">// 是否可以调用 setgroups</span></span>
<span class="line">    bool no_new_keyring<span class="token punctuation">;</span>           <span class="token comment">// 是否禁用新 keyring</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 时间 namespace 偏移</span></span>
<span class="line">    <span class="token keyword">char</span> <span class="token operator">*</span>time_offsets<span class="token punctuation">;</span>            <span class="token comment">// 时间偏移配置</span></span>
<span class="line">    <span class="token keyword">int</span> time_offsets_len<span class="token punctuation">;</span>          <span class="token comment">// 偏移配置长度</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-namespace-创建流程详解" tabindex="-1"><a class="header-anchor" href="#_3-namespace-创建流程详解"><span>3. Namespace 创建流程详解</span></a></h2><h3 id="_3-1-阶段0-父进程-stage-parent" tabindex="-1"><a class="header-anchor" href="#_3-1-阶段0-父进程-stage-parent"><span>3.1 阶段0: 父进程 (STAGE_PARENT)</span></a></h3><p><strong>主要职责</strong>: 设置用户映射，协调子进程</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// libcontainer/nsenter/nsexec.c:900</span></span>
<span class="line"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">parent_stage</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">nlconfig_t</span> <span class="token operator">*</span>config<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">pid_t</span> stage1_pid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> stage2_pid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 1. 等待第一阶段进程就绪</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sync_wait_for_child</span><span class="token punctuation">(</span>syncpipe<span class="token punctuation">,</span> SYNC_RECVPID_PLS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to sync with child&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">    <span class="token comment">// 接收子进程 PID</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>syncpipe<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stage1_pid<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stage1_pid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stage1_pid<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to read child pid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 设置用户 ID 映射</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>uidmappath<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">update_uidmap</span><span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>uidmappath<span class="token punctuation">,</span> stage1_pid<span class="token punctuation">,</span> </span>
<span class="line">                     config<span class="token operator">-&gt;</span>uidmap<span class="token punctuation">,</span> config<span class="token operator">-&gt;</span>uidmap_len<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>gidmappath<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">update_gidmap</span><span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>gidmappath<span class="token punctuation">,</span> stage1_pid<span class="token punctuation">,</span> </span>
<span class="line">                     config<span class="token operator">-&gt;</span>gidmap<span class="token punctuation">,</span> config<span class="token operator">-&gt;</span>gidmap_len<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 设置时间偏移 (TIME namespace)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>time_offsets<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">update_time_offsets</span><span class="token punctuation">(</span>stage1_pid<span class="token punctuation">,</span> config<span class="token operator">-&gt;</span>time_offsets<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. 通知子进程继续</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sync_wake_child</span><span class="token punctuation">(</span>syncpipe<span class="token punctuation">,</span> SYNC_USERMAP_ACK<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to sync with child&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="用户映射设置" tabindex="-1"><a class="header-anchor" href="#用户映射设置"><span>用户映射设置</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// libcontainer/nsenter/nsexec.c:393  </span></span>
<span class="line"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">update_uidmap</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span> <span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>map<span class="token punctuation">,</span> <span class="token class-name">size_t</span> map_len<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 首先尝试直接写入 /proc/pid/uid_map</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write_file</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> map_len<span class="token punctuation">,</span> <span class="token string">&quot;/proc/%d/uid_map&quot;</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 如果权限不足，尝试使用 newuidmap 工具</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EPERM<span class="token punctuation">)</span> </span>
<span class="line">            <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to update /proc/%d/uid_map&quot;</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">        <span class="token comment">// 使用外部工具进行映射</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">try_mapping_tool</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> map<span class="token punctuation">,</span> map_len<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to use newuid map on %d&quot;</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-阶段1-中间子进程-stage-child" tabindex="-1"><a class="header-anchor" href="#_3-2-阶段1-中间子进程-stage-child"><span>3.2 阶段1: 中间子进程 (STAGE_CHILD)</span></a></h3><p><strong>主要职责</strong>: 加入现有 namespace，创建新 namespace</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// libcontainer/nsenter/nsexec.c:1063</span></span>
<span class="line"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">child_stage</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">nlconfig_t</span> <span class="token operator">*</span>config<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 发送 PID 给父进程</span></span>
<span class="line">    <span class="token class-name">pid_t</span> stage1_pid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>syncpipe<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stage1_pid<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stage1_pid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stage1_pid<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to write pid to parent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">    <span class="token comment">// 2. 等待父进程设置用户映射</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sync_wait_for_child</span><span class="token punctuation">(</span>syncpipe<span class="token punctuation">,</span> SYNC_USERMAP_ACK<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to wait for parent to map user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 加入现有的 namespace (如果指定了路径)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>namespaces<span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">join_namespaces</span><span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>namespaces<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. 创建用户 namespace (如果需要)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>cloneflags <span class="token operator">&amp;</span> CLONE_NEWUSER<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unshare</span><span class="token punctuation">(</span>CLONE_NEWUSER<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to unshare user namespace&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 5. 创建其他 namespace</span></span>
<span class="line">    <span class="token function">try_unshare</span><span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>cloneflags <span class="token operator">&amp;</span> <span class="token operator">~</span>CLONE_NEWUSER<span class="token punctuation">,</span> <span class="token string">&quot;remaining namespaces&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 6. Fork 出最终的 init 进程</span></span>
<span class="line">    stage2_pid <span class="token operator">=</span> <span class="token function">clone_parent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">,</span> STAGE_INIT<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>stage2_pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;unable to fork stage-2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">    <span class="token comment">// 7. 等待 init 进程完成初始化</span></span>
<span class="line">    <span class="token function">wait_for_stage2_child</span><span class="token punctuation">(</span>stage2_pid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="namespace-加入机制" tabindex="-1"><a class="header-anchor" href="#namespace-加入机制"><span>Namespace 加入机制</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// libcontainer/nsenter/nsexec.c:533</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">join_namespaces</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>nsspec<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">namespace_t</span> <span class="token operator">*</span>ns_list<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">size_t</span> ns_len<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 1. 解析 namespace 规格字符串</span></span>
<span class="line">    <span class="token comment">// 格式: &quot;net:/proc/1234/ns/net,pid:/proc/1234/ns/pid&quot;</span></span>
<span class="line">    to_join <span class="token operator">=</span> <span class="token function">__open_namespaces</span><span class="token punctuation">(</span>nsspec<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ns_list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ns_len<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 分三个步骤加入，处理权限依赖</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 步骤1: 加入非用户命名空间</span></span>
<span class="line">    joined <span class="token operator">|=</span> <span class="token function">__join_namespaces</span><span class="token punctuation">(</span>to_join <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>joined <span class="token operator">|</span> CLONE_NEWUSER<span class="token punctuation">)</span><span class="token punctuation">,</span> </span>
<span class="line">                                ns_list<span class="token punctuation">,</span> ns_len<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 步骤2: 加入用户命名空间</span></span>
<span class="line">    joined <span class="token operator">|=</span> <span class="token function">__join_namespaces</span><span class="token punctuation">(</span>CLONE_NEWUSER<span class="token punctuation">,</span> ns_list<span class="token punctuation">,</span> ns_len<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 步骤3: 加入剩余的命名空间  </span></span>
<span class="line">    joined <span class="token operator">|=</span> <span class="token function">__join_namespaces</span><span class="token punctuation">(</span>to_join <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>joined <span class="token operator">|</span> CLONE_NEWUSER<span class="token punctuation">)</span><span class="token punctuation">,</span> </span>
<span class="line">                                ns_list<span class="token punctuation">,</span> ns_len<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">free_namespaces</span><span class="token punctuation">(</span>ns_list<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="加入单个-namespace" tabindex="-1"><a class="header-anchor" href="#加入单个-namespace"><span>加入单个 Namespace</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// libcontainer/nsenter/nsexec.c:458</span></span>
<span class="line"><span class="token keyword">static</span> <span class="token class-name">nsset_t</span> <span class="token function">__join_namespaces</span><span class="token punctuation">(</span><span class="token class-name">nsset_t</span> allow<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">namespace_t</span> <span class="token operator">*</span>ns_list<span class="token punctuation">,</span> <span class="token class-name">size_t</span> ns_len<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">nsset_t</span> joined <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ns_len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">struct</span> <span class="token class-name">namespace_t</span> <span class="token operator">*</span>ns <span class="token operator">=</span> <span class="token operator">&amp;</span>ns_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">int</span> nstype <span class="token operator">=</span> <span class="token function">nstype</span><span class="token punctuation">(</span>ns<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>nstype <span class="token operator">&amp;</span> allow<span class="token punctuation">)</span><span class="token punctuation">)</span> </span>
<span class="line">            <span class="token keyword">continue</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">        <span class="token comment">// 使用 setns() 系统调用加入 namespace</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setns</span><span class="token punctuation">(</span>ns<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> nstype<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EPERM<span class="token punctuation">)</span> </span>
<span class="line">                <span class="token keyword">continue</span><span class="token punctuation">;</span>  <span class="token comment">// 跳过权限错误</span></span>
<span class="line">            <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to setns into %s namespace&quot;</span><span class="token punctuation">,</span> ns<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        joined <span class="token operator">|=</span> nstype<span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 用户命名空间特殊处理</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>nstype <span class="token operator">==</span> CLONE_NEWUSER<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setresuid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to become root in user namespace&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setresgid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  </span>
<span class="line">                <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to become root in user namespace&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> joined<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-阶段2-最终-init-进程-stage-init" tabindex="-1"><a class="header-anchor" href="#_3-3-阶段2-最终-init-进程-stage-init"><span>3.3 阶段2: 最终 init 进程 (STAGE_INIT)</span></a></h3><p><strong>主要职责</strong>: 进程属性设置，返回 Go 运行时</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// libcontainer/nsenter/nsexec.c:1184</span></span>
<span class="line"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">init_stage</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">nlconfig_t</span> <span class="token operator">*</span>config<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 创建新的进程会话</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;setsid failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 设置用户和组 ID (如果不在用户命名空间中)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>cloneflags <span class="token operator">&amp;</span> CLONE_NEWUSER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setresuid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to setresuid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setresgid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to setresgid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 设置 OOM 分数调整</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>oom_score_adj <span class="token operator">&amp;&amp;</span> <span class="token function">strlen</span><span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>oom_score_adj<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">write_file</span><span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>oom_score_adj<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>oom_score_adj<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                  <span class="token string">&quot;/proc/self/oom_score_adj&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. 清理不需要的文件描述符</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>syncpipe <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">close</span><span class="token punctuation">(</span>syncpipe<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        syncpipe <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 5. 设置进程为不可转储 (安全措施)  </span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>namespaces<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">prctl</span><span class="token punctuation">(</span>PR_SET_DUMPABLE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set process as non-dumpable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 6. 返回到 Go 运行时继续初始化</span></span>
<span class="line">    <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 控制权返回 Go</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-go-运行时集成" tabindex="-1"><a class="header-anchor" href="#_4-go-运行时集成"><span>4. Go 运行时集成</span></a></h2><h3 id="_4-1-标准初始化流程" tabindex="-1"><a class="header-anchor" href="#_4-1-标准初始化流程"><span>4.1 标准初始化流程</span></a></h3><p>当 C 代码完成 namespace 设置后，控制权返回到 Go 运行时：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/standard_init_linux.go:52</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>linuxStandardInit<span class="token punctuation">)</span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. Keyring 设置</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span>l<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>NoNewKeyring <span class="token punctuation">{</span></span>
<span class="line">        ringname<span class="token punctuation">,</span> keepperms<span class="token punctuation">,</span> newperms <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">getSessionRingParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// 加入会话 keyring，设置 SELinux 标签</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> keys<span class="token punctuation">.</span><span class="token function">JoinSessionKeyring</span><span class="token punctuation">(</span>ringname<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 网络配置 (NEWNET namespace)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setupNetwork</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setupRoute</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 根文件系统准备 (NEWNS namespace)  </span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">prepareRootfs</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>pipe<span class="token punctuation">,</span> l<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. 挂载命名空间处理</span></span>
<span class="line">    <span class="token keyword">if</span> l<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Namespaces<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>configs<span class="token punctuation">.</span>NEWNS<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">finalizeRootfs</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 5. UTS namespace - 设置主机名</span></span>
<span class="line">    <span class="token keyword">if</span> hostname <span class="token operator">:=</span> l<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Hostname<span class="token punctuation">;</span> hostname <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Sethostname</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>hostname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 6. 最终命名空间配置</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">finalizeNamespace</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 7. 执行用户程序</span></span>
<span class="line">    name<span class="token punctuation">,</span> err <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">LookPath</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> system<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> l<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Args<span class="token punctuation">,</span> os<span class="token punctuation">.</span><span class="token function">Environ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-网络配置示例" tabindex="-1"><a class="header-anchor" href="#_4-2-网络配置示例"><span>4.2 网络配置示例</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/standard_init_linux.go:96</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setupNetwork</span><span class="token punctuation">(</span>config <span class="token operator">*</span>initConfig<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> config <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Networks <span class="token punctuation">{</span></span>
<span class="line">        strategy<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getStrategy</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Type<span class="token punctuation">)</span>  </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> strategy<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>Network<span class="token punctuation">)</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>Pid<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-主机名设置示例" tabindex="-1"><a class="header-anchor" href="#_4-3-主机名设置示例"><span>4.3 主机名设置示例</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// UTS namespace 中的主机名设置</span></span>
<span class="line"><span class="token keyword">if</span> hostname <span class="token operator">:=</span> l<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Hostname<span class="token punctuation">;</span> hostname <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Sethostname</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>hostname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set hostname %q: %w&quot;</span><span class="token punctuation">,</span> hostname<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 域名设置</span></span>
<span class="line"><span class="token keyword">if</span> domainname <span class="token operator">:=</span> l<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Domainname<span class="token punctuation">;</span> domainname <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Setdomainname</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>domainname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set domainname %q: %w&quot;</span><span class="token punctuation">,</span> domainname<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-namespace-创建顺序和依赖关系" tabindex="-1"><a class="header-anchor" href="#_5-namespace-创建顺序和依赖关系"><span>5. Namespace 创建顺序和依赖关系</span></a></h2><h3 id="_5-1-创建顺序原则" tabindex="-1"><a class="header-anchor" href="#_5-1-创建顺序原则"><span>5.1 创建顺序原则</span></a></h3><p>runc 严格按照以下顺序处理 namespace：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/configs/namespaces_linux.go:123</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NamespaceTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>NamespaceType <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>NamespaceType<span class="token punctuation">{</span></span>
<span class="line">        NEWUSER<span class="token punctuation">,</span>   <span class="token comment">// 1. 用户命名空间 - 必须最先</span></span>
<span class="line">        NEWIPC<span class="token punctuation">,</span>    <span class="token comment">// 2. IPC 命名空间</span></span>
<span class="line">        NEWUTS<span class="token punctuation">,</span>    <span class="token comment">// 3. UTS 命名空间  </span></span>
<span class="line">        NEWNET<span class="token punctuation">,</span>    <span class="token comment">// 4. 网络命名空间</span></span>
<span class="line">        NEWPID<span class="token punctuation">,</span>    <span class="token comment">// 5. PID 命名空间</span></span>
<span class="line">        NEWNS<span class="token punctuation">,</span>     <span class="token comment">// 6. 挂载命名空间</span></span>
<span class="line">        NEWCGROUP<span class="token punctuation">,</span> <span class="token comment">// 7. Cgroup 命名空间</span></span>
<span class="line">        NEWTIME<span class="token punctuation">,</span>   <span class="token comment">// 8. 时间命名空间</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-依赖关系详解" tabindex="-1"><a class="header-anchor" href="#_5-2-依赖关系详解"><span>5.2 依赖关系详解</span></a></h3><h4 id="用户命名空间的特殊地位" tabindex="-1"><a class="header-anchor" href="#用户命名空间的特殊地位"><span>用户命名空间的特殊地位</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">NEWUSER (用户命名空间)</span>
<span class="line">    │</span>
<span class="line">    │ 必须首先创建，因为：</span>
<span class="line">    │ 1. 影响其他 namespace 的权限检查</span>
<span class="line">    │ 2. 创建后才能进行 ID 映射</span>
<span class="line">    │ 3. 其他 namespace 的创建可能需要相应权限</span>
<span class="line">    │</span>
<span class="line">    ├── NEWIPC (需要 IPC 权限)</span>
<span class="line">    ├── NEWUTS (需要 SYS_ADMIN 权限)</span>
<span class="line">    ├── NEWNET (需要 NET_ADMIN 权限)  </span>
<span class="line">    ├── NEWPID (需要 SYS_ADMIN 权限)</span>
<span class="line">    ├── NEWNS  (需要 SYS_ADMIN 权限)</span>
<span class="line">    └── NEWCGROUP (需要 SYS_ADMIN 权限)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="权限检查逻辑" tabindex="-1"><a class="header-anchor" href="#权限检查逻辑"><span>权限检查逻辑</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 检查创建 namespace 所需的权限</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">checkNamespacePermissions</span><span class="token punctuation">(</span>ns NamespaceType<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">switch</span> ns <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> NEWUSER<span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// 用户命名空间不需要特殊权限</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token keyword">case</span> NEWNET<span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// 需要 CAP_NET_ADMIN 或在用户命名空间中</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">checkCapability</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>CAP_NET_ADMIN<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">case</span> NEWNS<span class="token punctuation">,</span> NEWUTS<span class="token punctuation">,</span> NEWPID<span class="token punctuation">,</span> NEWIPC<span class="token punctuation">,</span> NEWCGROUP<span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// 需要 CAP_SYS_ADMIN 或在用户命名空间中</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">checkCapability</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>CAP_SYS_ADMIN<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-同步机制详解" tabindex="-1"><a class="header-anchor" href="#_5-3-同步机制详解"><span>5.3 同步机制详解</span></a></h3><h4 id="同步消息类型" tabindex="-1"><a class="header-anchor" href="#同步消息类型"><span>同步消息类型</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// libcontainer/nsenter/nsexec.c:60</span></span>
<span class="line"><span class="token keyword">enum</span> <span class="token class-name">sync_t</span> <span class="token punctuation">{</span></span>
<span class="line">    SYNC_USERMAP_PLS <span class="token operator">=</span> <span class="token number">0x40</span><span class="token punctuation">,</span>      <span class="token comment">// 请求父进程进行用户映射</span></span>
<span class="line">    SYNC_USERMAP_ACK <span class="token operator">=</span> <span class="token number">0x41</span><span class="token punctuation">,</span>      <span class="token comment">// 用户映射完成确认</span></span>
<span class="line">    SYNC_RECVPID_PLS <span class="token operator">=</span> <span class="token number">0x42</span><span class="token punctuation">,</span>      <span class="token comment">// 发送 PID 请求</span></span>
<span class="line">    SYNC_RECVPID_ACK <span class="token operator">=</span> <span class="token number">0x43</span><span class="token punctuation">,</span>      <span class="token comment">// PID 接收确认  </span></span>
<span class="line">    SYNC_GRANDCHILD <span class="token operator">=</span> <span class="token number">0x44</span><span class="token punctuation">,</span>       <span class="token comment">// 孙进程就绪信号</span></span>
<span class="line">    SYNC_CHILD_FINISH <span class="token operator">=</span> <span class="token number">0x45</span><span class="token punctuation">,</span>     <span class="token comment">// 子进程完成信号</span></span>
<span class="line">    SYNC_TIMEOFFSETS_PLS <span class="token operator">=</span> <span class="token number">0x46</span><span class="token punctuation">,</span>  <span class="token comment">// 请求设置时间偏移</span></span>
<span class="line">    SYNC_TIMEOFFSETS_ACK <span class="token operator">=</span> <span class="token number">0x47</span><span class="token punctuation">,</span>  <span class="token comment">// 时间偏移设置完成</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="同步流程图" tabindex="-1"><a class="header-anchor" href="#同步流程图"><span>同步流程图</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">父进程 (STAGE_PARENT)          中间进程 (STAGE_CHILD)           最终进程 (STAGE_INIT)</span>
<span class="line">      │                              │                               │</span>
<span class="line">      │◄────── SYNC_RECVPID_PLS ─────┤                               │</span>
<span class="line">      │                              │                               │</span>
<span class="line">      │─── update_uidmap/gidmap ──── │                               │</span>
<span class="line">      │                              │                               │  </span>
<span class="line">      │────── SYNC_USERMAP_ACK ─────►│                               │</span>
<span class="line">      │                              │                               │</span>
<span class="line">      │                              │─── unshare/join namespaces ──│</span>
<span class="line">      │                              │                               │</span>
<span class="line">      │                              │────────── fork() ───────────►│</span>
<span class="line">      │                              │                               │</span>
<span class="line">      │◄──── SYNC_GRANDCHILD ────────┼───────────────────────────────│</span>
<span class="line">      │                              │                               │</span>
<span class="line">      │────── SYNC_CHILD_FINISH ────►│                               │</span>
<span class="line">      │                              │                               │</span>
<span class="line">      │                              │ exit                          │ init...</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-高级特性和优化" tabindex="-1"><a class="header-anchor" href="#_6-高级特性和优化"><span>6. 高级特性和优化</span></a></h2><h3 id="_6-1-时间命名空间处理" tabindex="-1"><a class="header-anchor" href="#_6-1-时间命名空间处理"><span>6.1 时间命名空间处理</span></a></h3><p>时间命名空间是较新的功能 (Linux 5.6+)，允许容器有不同的系统时间：</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// 设置时间偏移</span></span>
<span class="line"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">update_time_offsets</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>offsets<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">char</span> <span class="token operator">*</span>saveptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">char</span> <span class="token operator">*</span>offset_str <span class="token operator">=</span> <span class="token function">strtok_r</span><span class="token punctuation">(</span>offsets<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>saveptr<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>offset_str <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 解析偏移格式: &quot;monotonic 1000000000 0&quot;  </span></span>
<span class="line">        <span class="token keyword">char</span> <span class="token operator">*</span>clock_id <span class="token operator">=</span> <span class="token function">strtok_r</span><span class="token punctuation">(</span>offset_str<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>saveptr<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">char</span> <span class="token operator">*</span>sec_str <span class="token operator">=</span> <span class="token function">strtok_r</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>saveptr<span class="token punctuation">)</span><span class="token punctuation">;</span>  </span>
<span class="line">        <span class="token keyword">char</span> <span class="token operator">*</span>nsec_str <span class="token operator">=</span> <span class="token function">strtok_r</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>saveptr<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 写入 /proc/pid/timens_offsets</span></span>
<span class="line">        <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open_proc_file</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token string">&quot;timens_offsets&quot;</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">dprintf</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">&quot;%s %s %s\n&quot;</span><span class="token punctuation">,</span> clock_id<span class="token punctuation">,</span> sec_str<span class="token punctuation">,</span> nsec_str<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        offset_str <span class="token operator">=</span> <span class="token function">strtok_r</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>saveptr<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-rootless-容器支持" tabindex="-1"><a class="header-anchor" href="#_6-2-rootless-容器支持"><span>6.2 Rootless 容器支持</span></a></h3><p>Rootless 模式允许普通用户创建容器：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 检查是否运行在 rootless 模式</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">isRootless</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> os<span class="token punctuation">.</span><span class="token function">Geteuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// rootless 模式的特殊处理</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">handleRootlessNamespaces</span><span class="token punctuation">(</span>namespaces Namespaces<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">isRootless</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// rootless 模式必须包含用户命名空间</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span>namespaces<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>NEWUSER<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;rootless containers require user namespaces&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 某些功能在 rootless 模式下受限</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ns <span class="token operator">:=</span> <span class="token keyword">range</span> namespaces <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">switch</span> ns<span class="token punctuation">.</span>Type <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">case</span> NEWNET<span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment">// 网络命名空间在 rootless 模式下功能受限</span></span>
<span class="line">            logrus<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">&quot;network namespace has limited functionality in rootless mode&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-性能优化" tabindex="-1"><a class="header-anchor" href="#_6-3-性能优化"><span>6.3 性能优化</span></a></h3><h4 id="批量-namespace-操作" tabindex="-1"><a class="header-anchor" href="#批量-namespace-操作"><span>批量 Namespace 操作</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// 批量创建多个 namespace，减少系统调用次数</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">create_namespaces_batch</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> clone_flags<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 一次 unshare 调用创建多个 namespace</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unshare</span><span class="token punctuation">(</span>clone_flags<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 如果批量创建失败，逐个尝试</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">uint32_t</span> flag <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> i<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>clone_flags <span class="token operator">&amp;</span> flag<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unshare</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">!=</span> EINVAL<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="文件描述符缓存" tabindex="-1"><a class="header-anchor" href="#文件描述符缓存"><span>文件描述符缓存</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// 缓存 namespace 文件描述符，避免重复打开</span></span>
<span class="line"><span class="token keyword">static</span> <span class="token keyword">int</span> ns_fd_cache<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">get_namespace_fd</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ns_path<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 检查缓存</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>ns_fd_cache<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">char</span> fd_path<span class="token punctuation">[</span>PATH_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">snprintf</span><span class="token punctuation">(</span>fd_path<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>fd_path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;/proc/self/fd/%d&quot;</span><span class="token punctuation">,</span> ns_fd_cache<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token function">readlink</span><span class="token punctuation">(</span>fd_path<span class="token punctuation">)</span><span class="token punctuation">,</span> ns_path<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> ns_fd_cache<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 打开并缓存</span></span>
<span class="line">    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>ns_path<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 找空位缓存</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>ns_fd_cache<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                ns_fd_cache<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> fd<span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> fd<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-调试和故障排除" tabindex="-1"><a class="header-anchor" href="#_7-调试和故障排除"><span>7. 调试和故障排除</span></a></h2><h3 id="_7-1-常见问题诊断" tabindex="-1"><a class="header-anchor" href="#_7-1-常见问题诊断"><span>7.1 常见问题诊断</span></a></h3><h4 id="权限问题诊断" tabindex="-1"><a class="header-anchor" href="#权限问题诊断"><span>权限问题诊断</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 检查用户命名空间支持</span></span>
<span class="line">$ <span class="token function">cat</span> /proc/sys/user/max_user_namespaces</span>
<span class="line"><span class="token number">65536</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检查当前进程的 namespace</span></span>
<span class="line">$ <span class="token function">ls</span> <span class="token parameter variable">-la</span> /proc/self/ns/</span>
<span class="line">lrwxrwxrwx <span class="token number">1</span> user user <span class="token number">0</span> Jan  <span class="token number">1</span> <span class="token number">10</span>:00 cgroup -<span class="token operator">&gt;</span> <span class="token string">&#39;cgroup:[4026531835]&#39;</span></span>
<span class="line">lrwxrwxrwx <span class="token number">1</span> user user <span class="token number">0</span> Jan  <span class="token number">1</span> <span class="token number">10</span>:00 ipc -<span class="token operator">&gt;</span> <span class="token string">&#39;ipc:[4026531839]&#39;</span></span>
<span class="line">lrwxrwxrwx <span class="token number">1</span> user user <span class="token number">0</span> Jan  <span class="token number">1</span> <span class="token number">10</span>:00 mnt -<span class="token operator">&gt;</span> <span class="token string">&#39;mnt:[4026531840]&#39;</span></span>
<span class="line">lrwxrwxrwx <span class="token number">1</span> user user <span class="token number">0</span> Jan  <span class="token number">1</span> <span class="token number">10</span>:00 net -<span class="token operator">&gt;</span> <span class="token string">&#39;net:[4026531992]&#39;</span></span>
<span class="line">lrwxrwxrwx <span class="token number">1</span> user user <span class="token number">0</span> Jan  <span class="token number">1</span> <span class="token number">10</span>:00 pid -<span class="token operator">&gt;</span> <span class="token string">&#39;pid:[4026531836]&#39;</span></span>
<span class="line">lrwxrwxrwx <span class="token number">1</span> user user <span class="token number">0</span> Jan  <span class="token number">1</span> <span class="token number">10</span>:00 user -<span class="token operator">&gt;</span> <span class="token string">&#39;user:[4026531837]&#39;</span></span>
<span class="line">lrwxrwxrwx <span class="token number">1</span> user user <span class="token number">0</span> Jan  <span class="token number">1</span> <span class="token number">10</span>:00 uts -<span class="token operator">&gt;</span> <span class="token string">&#39;uts:[4026531838]&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检查用户映射</span></span>
<span class="line">$ <span class="token function">cat</span> /proc/1234/uid_map</span>
<span class="line">         <span class="token number">0</span>       <span class="token number">1000</span>          <span class="token number">1</span></span>
<span class="line">         <span class="token number">1</span>       <span class="token number">1001</span>      <span class="token number">65534</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="调试信息收集" tabindex="-1"><a class="header-anchor" href="#调试信息收集"><span>调试信息收集</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 添加 namespace 调试信息</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">debugNamespaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    nsTypes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;cgroup&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ipc&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mnt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;net&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pid&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;uts&quot;</span><span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Current namespace information:&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> nsType <span class="token operator">:=</span> <span class="token keyword">range</span> nsTypes <span class="token punctuation">{</span></span>
<span class="line">        nsPath <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;/proc/self/ns/%s&quot;</span><span class="token punctuation">,</span> nsType<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> target<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Readlink</span><span class="token punctuation">(</span>nsPath<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;  %s: %s\n&quot;</span><span class="token punctuation">,</span> nsType<span class="token punctuation">,</span> target<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;  %s: error reading (%v)\n&quot;</span><span class="token punctuation">,</span> nsType<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 检查用户映射</span></span>
<span class="line">    <span class="token keyword">if</span> data<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token string">&quot;/proc/self/uid_map&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;UID mapping:\n%s&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> data<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token string">&quot;/proc/self/gid_map&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;GID mapping:\n%s&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-性能分析" tabindex="-1"><a class="header-anchor" href="#_7-2-性能分析"><span>7.2 性能分析</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 使用 strace 跟踪系统调用</span></span>
<span class="line">$ <span class="token function">strace</span> <span class="token parameter variable">-f</span> <span class="token parameter variable">-e</span> <span class="token assign-left variable">trace</span><span class="token operator">=</span>clone,unshare,setns runc create mycontainer</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 使用 perf 分析性能</span></span>
<span class="line">$ perf record runc run mycontainer</span>
<span class="line">$ perf report</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检查 namespace 创建时间</span></span>
<span class="line">$ <span class="token function">time</span> runc create mycontainer</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-实践练习" tabindex="-1"><a class="header-anchor" href="#_8-实践练习"><span>8. 实践练习</span></a></h2><h3 id="_8-1-手动创建-namespace" tabindex="-1"><a class="header-anchor" href="#_8-1-手动创建-namespace"><span>8.1 手动创建 Namespace</span></a></h3><p>体验不同类型的 namespace 隔离效果：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># 练习1：创建 PID namespace</span></span>
<span class="line"><span class="token function">sudo</span> unshare <span class="token parameter variable">--pid</span> <span class="token parameter variable">--fork</span> --mount-proc /bin/bash</span>
<span class="line"><span class="token comment"># 在新 shell 中执行:</span></span>
<span class="line"><span class="token function">ps</span> aux  <span class="token comment"># 只能看到当前 namespace 的进程</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 练习2：创建网络 namespace  </span></span>
<span class="line"><span class="token function">sudo</span> unshare <span class="token parameter variable">--net</span> /bin/bash</span>
<span class="line"><span class="token function">ip</span> <span class="token function">link</span> show  <span class="token comment"># 只能看到 loopback 接口</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 练习3：创建挂载 namespace</span></span>
<span class="line"><span class="token function">sudo</span> unshare <span class="token parameter variable">--mount</span> /bin/bash</span>
<span class="line"><span class="token function">mount</span> <span class="token parameter variable">-t</span> tmpfs tmpfs /tmp</span>
<span class="line"><span class="token function">ls</span> /tmp  <span class="token comment"># 只在当前 namespace 中可见</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 练习4：创建 UTS namespace</span></span>
<span class="line"><span class="token function">sudo</span> unshare <span class="token parameter variable">--uts</span> /bin/bash  </span>
<span class="line"><span class="token function">hostname</span> container-test</span>
<span class="line"><span class="token function">hostname</span>  <span class="token comment"># 只在当前 namespace 中生效</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-自定义-namespace-配置" tabindex="-1"><a class="header-anchor" href="#_8-2-自定义-namespace-配置"><span>8.2 自定义 Namespace 配置</span></a></h3><p>修改容器配置体验不同的 namespace 组合：</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;ociVersion&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.2&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;process&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;root&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rootfs&quot;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;linux&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;namespaces&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pid&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;network&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> </span>
<span class="line">      <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mount&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;uts&quot;</span><span class="token punctuation">}</span></span>
<span class="line">      <span class="token comment">// 故意省略 user namespace，观察权限变化</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-3-namespace-性能测试" tabindex="-1"><a class="header-anchor" href="#_8-3-namespace-性能测试"><span>8.3 Namespace 性能测试</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># 测试不同 namespace 组合的创建时间</span></span>
<span class="line"></span>
<span class="line"><span class="token function-name function">test_namespace_performance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin class-name">local</span> <span class="token assign-left variable">namespaces</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$1</span>&quot;</span></span>
<span class="line">    <span class="token builtin class-name">local</span> <span class="token assign-left variable">desc</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$2</span>&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;Testing <span class="token variable">$desc</span>...&quot;</span></span>
<span class="line">    <span class="token function">time</span> <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">..</span><span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">        <span class="token function">sudo</span> unshare <span class="token variable">$namespaces</span> /bin/true</span>
<span class="line">    <span class="token keyword">done</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 测试各种组合</span></span>
<span class="line">test_namespace_performance <span class="token string">&quot;--pid&quot;</span> <span class="token string">&quot;PID namespace only&quot;</span></span>
<span class="line">test_namespace_performance <span class="token string">&quot;--pid --net&quot;</span> <span class="token string">&quot;PID + Network&quot;</span></span>
<span class="line">test_namespace_performance <span class="token string">&quot;--pid --net --mount --uts --ipc&quot;</span> <span class="token string">&quot;All common namespaces&quot;</span></span>
<span class="line">test_namespace_performance <span class="token string">&quot;--user --pid --net --mount --uts --ipc&quot;</span> <span class="token string">&quot;Including user namespace&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-4-调试-runc-namespace-创建" tabindex="-1"><a class="header-anchor" href="#_8-4-调试-runc-namespace-创建"><span>8.4 调试 runc Namespace 创建</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 启用 runc 调试日志</span></span>
<span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">RUNC_DEBUG</span><span class="token operator">=</span><span class="token number">1</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 跟踪 namespace 创建过程</span></span>
<span class="line"><span class="token function">strace</span> <span class="token parameter variable">-f</span> <span class="token parameter variable">-e</span> <span class="token assign-left variable">trace</span><span class="token operator">=</span>clone,unshare,setns,openat <span class="token parameter variable">-o</span> /tmp/runc.strace <span class="token punctuation">\</span></span>
<span class="line">    runc create mycontainer</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 分析结果</span></span>
<span class="line"><span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">&quot;(clone|unshare|setns)&quot;</span> /tmp/runc.strace <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-20</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-思考题" tabindex="-1"><a class="header-anchor" href="#_9-思考题"><span>9. 思考题</span></a></h2><h3 id="_9-1-架构设计思考" tabindex="-1"><a class="header-anchor" href="#_9-1-架构设计思考"><span>9.1 架构设计思考</span></a></h3><ol><li><p><strong>三阶段设计的必要性</strong>：为什么 runc 需要三阶段进程创建？能否简化为两阶段？</p></li><li><p><strong>用户命名空间优先级</strong>：为什么用户命名空间必须最先创建？如果顺序错误会发生什么？</p></li><li><p><strong>同步机制复杂性</strong>：父子进程之间的同步为什么这么复杂？有没有更简单的方案？</p></li></ol><h3 id="_9-2-技术实现思考" tabindex="-1"><a class="header-anchor" href="#_9-2-技术实现思考"><span>9.2 技术实现思考</span></a></h3><ol start="4"><li><p><strong>C/Go 混合编程</strong>：为什么底层 namespace 操作用 C 实现，而不是纯 Go？</p></li><li><p><strong>错误处理策略</strong>：如果某个 namespace 创建失败，runc 如何进行清理？</p></li><li><p><strong>性能优化空间</strong>：当前的实现有哪些性能瓶颈？如何优化？</p></li></ol><h3 id="_9-3-安全性思考" tabindex="-1"><a class="header-anchor" href="#_9-3-安全性思考"><span>9.3 安全性思考</span></a></h3><ol start="7"><li><p><strong>权限逃逸风险</strong>：user namespace 的 ID 映射有什么安全风险？</p></li><li><p><strong>隔离完整性</strong>：如何确保容器无法看到或影响宿主机的其他 namespace？</p></li><li><p><strong>Rootless 安全性</strong>：rootless 容器是否真的更安全？有什么局限性？</p></li></ol><h3 id="_9-4-扩展性思考" tabindex="-1"><a class="header-anchor" href="#_9-4-扩展性思考"><span>9.4 扩展性思考</span></a></h3><ol start="10"><li><strong>新 Namespace 支持</strong>：如果 Linux 内核增加新的 namespace 类型，runc 需要如何修改？</li></ol><h2 id="_10-扩展阅读" tabindex="-1"><a class="header-anchor" href="#_10-扩展阅读"><span>10. 扩展阅读</span></a></h2><h3 id="_10-1-linux-内核文档" tabindex="-1"><a class="header-anchor" href="#_10-1-linux-内核文档"><span>10.1 Linux 内核文档</span></a></h3><ul><li><a href="https://lwn.net/Articles/531114/" target="_blank" rel="noopener noreferrer">Namespaces in operation<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://man7.org/linux/man-pages/man7/user_namespaces.7.html" target="_blank" rel="noopener noreferrer">User namespaces<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://man7.org/linux/man-pages/man7/pid_namespaces.7.html" target="_blank" rel="noopener noreferrer">PID namespaces<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://man7.org/linux/man-pages/man7/network_namespaces.7.html" target="_blank" rel="noopener noreferrer">Network namespaces<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h3 id="_10-2-系统调用参考" tabindex="-1"><a class="header-anchor" href="#_10-2-系统调用参考"><span>10.2 系统调用参考</span></a></h3><ul><li><a href="https://man7.org/linux/man-pages/man2/clone.2.html" target="_blank" rel="noopener noreferrer">clone(2)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://man7.org/linux/man-pages/man2/unshare.2.html" target="_blank" rel="noopener noreferrer">unshare(2)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://man7.org/linux/man-pages/man2/setns.2.html" target="_blank" rel="noopener noreferrer">setns(2)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://man7.org/linux/man-pages/man1/nsenter.1.html" target="_blank" rel="noopener noreferrer">nsenter(1)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h3 id="_10-3-深入学习资源" tabindex="-1"><a class="header-anchor" href="#_10-3-深入学习资源"><span>10.3 深入学习资源</span></a></h3><ul><li><a href="https://medium.com/@saschagrunert/demystifying-containers-101-a-deep-dive-into-container-technology-for-beginners-d7b60d8511c1" target="_blank" rel="noopener noreferrer">Linux Container Primitives<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://www.ianlewis.org/en/container-runtimes-part-1-introduction-container-r" target="_blank" rel="noopener noreferrer">Container Runtimes<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://rootlesscontaine.rs/" target="_blank" rel="noopener noreferrer">Rootless Containers<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h2 id="🎯-模块总结" tabindex="-1"><a class="header-anchor" href="#🎯-模块总结"><span>🎯 模块总结</span></a></h2><p>通过本模块的学习，你应该已经掌握了：</p><p>✅ <strong>8种 Namespace 类型</strong>：理解每种 namespace 的作用和隔离范围<br> ✅ <strong>三阶段进程模型</strong>：理解复杂的进程创建和同步机制<br> ✅ <strong>底层实现原理</strong>：掌握 C 代码实现和系统调用使用<br> ✅ <strong>权限和依赖关系</strong>：理解 namespace 创建顺序和权限要求<br> ✅ <strong>调试和优化方法</strong>：具备故障排除和性能分析能力</p><p><strong>下一步</strong>: 进入 <a class="route-link" href="/blog/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html">模块 4: Cgroups 资源管理</a>，学习容器资源限制和监控机制。</p></div></div><footer class="page-meta"><div class="meta-item edit-link"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M2 26h28v2H2z" fill="currentColor"></path><path d="M25.4 9c.8-.8.8-2 0-2.8l-3.6-3.6c-.8-.8-2-.8-2.8 0l-15 15V24h6.4l15-15zm-5-5L24 7.6l-3 3L17.4 7l3-3zM6 22v-3.6l10-10l3.6 3.6l-10 10H6z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Edit this page<!--]--></span></span></div><div class="meta-item last-updated"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->更新于 8/6/2025, 6:07:26 PM<!--]--></span></span></div></footer><!----><div class="reco-valine-wrapper"><div id="valine"></div></div></div><div class="page-catalog-container"><h5 class="tip">目录</h5><ul><!--[--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#概述" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="概述"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->概述<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#🎯-学习目标" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="🎯 学习目标"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->🎯 学习目标<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_1-linux-namespace-基础概念" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1. Linux Namespace 基础概念"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1. Linux Namespace 基础概念<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_1-1-什么是-namespace" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1.1 什么是 Namespace？"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1.1 什么是 Namespace？<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_1-2-八种-namespace-类型详解" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1.2 八种 Namespace 类型详解"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1.2 八种 Namespace 类型详解<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_2-runc-的-namespace-实现架构" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2. runc 的 Namespace 实现架构"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2. runc 的 Namespace 实现架构<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_2-1-核心数据结构" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.1 核心数据结构"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.1 核心数据结构<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_2-2-三阶段进程创建模型" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.2 三阶段进程创建模型"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.2 三阶段进程创建模型<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_2-3-nsenter-核心实现" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.3 nsenter 核心实现"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.3 nsenter 核心实现<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_3-namespace-创建流程详解" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3. Namespace 创建流程详解"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3. Namespace 创建流程详解<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_3-1-阶段0-父进程-stage-parent" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.1 阶段0: 父进程 (STAGE_PARENT)"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.1 阶段0: 父进程 (STAGE_PARENT)<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_3-2-阶段1-中间子进程-stage-child" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.2 阶段1: 中间子进程 (STAGE_CHILD)"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.2 阶段1: 中间子进程 (STAGE_CHILD)<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_3-3-阶段2-最终-init-进程-stage-init" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.3 阶段2: 最终 init 进程 (STAGE_INIT)"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.3 阶段2: 最终 init 进程 (STAGE_INIT)<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_4-go-运行时集成" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4. Go 运行时集成"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4. Go 运行时集成<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_4-1-标准初始化流程" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4.1 标准初始化流程"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4.1 标准初始化流程<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_4-2-网络配置示例" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4.2 网络配置示例"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4.2 网络配置示例<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_4-3-主机名设置示例" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4.3 主机名设置示例"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4.3 主机名设置示例<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_5-namespace-创建顺序和依赖关系" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5. Namespace 创建顺序和依赖关系"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5. Namespace 创建顺序和依赖关系<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_5-1-创建顺序原则" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.1 创建顺序原则"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.1 创建顺序原则<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_5-2-依赖关系详解" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.2 依赖关系详解"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.2 依赖关系详解<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_5-3-同步机制详解" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.3 同步机制详解"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.3 同步机制详解<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_6-高级特性和优化" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6. 高级特性和优化"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6. 高级特性和优化<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_6-1-时间命名空间处理" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6.1 时间命名空间处理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6.1 时间命名空间处理<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_6-2-rootless-容器支持" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6.2 Rootless 容器支持"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6.2 Rootless 容器支持<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_6-3-性能优化" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6.3 性能优化"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6.3 性能优化<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_7-调试和故障排除" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7. 调试和故障排除"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7. 调试和故障排除<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_7-1-常见问题诊断" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7.1 常见问题诊断"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7.1 常见问题诊断<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_7-2-性能分析" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7.2 性能分析"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7.2 性能分析<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_8-实践练习" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8. 实践练习"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8. 实践练习<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_8-1-手动创建-namespace" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8.1 手动创建 Namespace"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8.1 手动创建 Namespace<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_8-2-自定义-namespace-配置" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8.2 自定义 Namespace 配置"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8.2 自定义 Namespace 配置<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_8-3-namespace-性能测试" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8.3 Namespace 性能测试"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8.3 Namespace 性能测试<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_8-4-调试-runc-namespace-创建" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8.4 调试 runc Namespace 创建"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8.4 调试 runc Namespace 创建<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_9-思考题" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9. 思考题"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9. 思考题<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_9-1-架构设计思考" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9.1 架构设计思考"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9.1 架构设计思考<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_9-2-技术实现思考" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9.2 技术实现思考"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9.2 技术实现思考<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_9-3-安全性思考" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9.3 安全性思考"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9.3 安全性思考<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_9-4-扩展性思考" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9.4 扩展性思考"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9.4 扩展性思考<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_10-扩展阅读" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="10. 扩展阅读"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->10. 扩展阅读<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_10-1-linux-内核文档" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="10.1 Linux 内核文档"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->10.1 Linux 内核文档<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_10-2-系统调用参考" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="10.2 系统调用参考"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->10.2 系统调用参考<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#_10-3-深入学习资源" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="10.3 深入学习资源"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->10.3 深入学习资源<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html#🎯-模块总结" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="🎯 模块总结"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->🎯 模块总结<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--></ul></div></main><!--]--></div></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/blog/assets/app-2O6audqE.js" defer></script>
  </body>
</html>

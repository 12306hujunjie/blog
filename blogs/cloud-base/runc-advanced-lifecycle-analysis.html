<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-rc.19">
    <script>
      (function() {
        const userMode = localStorage.getItem('vuepress-reco-color-scheme') || 'auto';
        const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (userMode === 'dark' || (userMode === 'auto' && systemDarkMode)) {
          document.documentElement.classList.toggle('dark', true);
        }
      })();
    </script>
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.min.js" as="script"><title>runc 容器生命周期高级流程深度分析 | database of memory</title><meta name="description" content="深入分析runc容器生命周期管理的高级流程和实现细节，包括暂停/恢复、CRIU检查点、动态更新等核心机制">
    <link rel="preload" href="/blog/assets/style-3Js8NCR5.css" as="style"><link rel="stylesheet" href="/blog/assets/style-3Js8NCR5.css">
    <link rel="modulepreload" href="/blog/assets/app-2O6audqE.js"><link rel="modulepreload" href="/blog/assets/runc-advanced-lifecycle-analysis.html-DksQevmb.js">
    <link rel="prefetch" href="/blog/assets/timeline.html-Dpj3Uwd1.js" as="script"><link rel="prefetch" href="/blog/assets/posts.html-CwxCj2Hz.js" as="script"><link rel="prefetch" href="/blog/assets/friendship-link.html-BWfmkE8T.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-u-MzmdCM.js" as="script"><link rel="prefetch" href="/blog/assets/2.html-BZ918lqD.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-C0q1hGsM.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CKULWdoq.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CWtVNK-m.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bd6PVF3c.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BbXNqe1N.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DyPCaQFd.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-C18Bjk_W.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BBVLOTuN.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D6KsFqqv.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BFPB5Kke.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B7IkZhlZ.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D_xT1fZZ.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DheB4D6E.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bt_l6w3U.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DeILrr-C.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DSTAwzEO.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BD5fA-NV.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BkRrSqYz.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-cT5R8xwx.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D9YDDbbv.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CbwTJPe7.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BuOxUP39.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BonFf6Hv.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DdMSM_BO.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Cf_rINiA.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DAcku8Eg.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DXT9U0AY.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DNdoOP4f.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-gqCMVOP4.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-HV0Wu9t8.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-LYxcb78a.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B50wkuh6.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DmpqsxHB.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-ChJizRVK.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D91uHYKf.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BLywihRf.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CB6EOmHd.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CxeevLHu.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B6J1fqYY.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D6g5ki7n.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CNoSmcFz.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dg6Odx9T.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dcy99l4T.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BK5mIUzD.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-8yVN6cur.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D33sQ_DA.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BOgMey9f.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D-L5Fugg.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-blGV0Kuf.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Ck4-7Hl7.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-N5xZIiU3.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DHa_luE7.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BDo2AWiQ.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CJj46_t8.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B32LjB8A.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DHAALd4l.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-H_UWlmPh.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DhnB-W5f.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dl8_vnsm.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-AlHvVsZC.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D7E4OavF.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CgCAEUN3.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-4Mr3uCmo.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BWKUAlc0.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CNuv7HDI.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BTkfIlYg.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dqp54iE9.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CtCFev89.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bb4UAQpl.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B6JysInN.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CHu47ESV.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CW5fe8Pz.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CBCt-NmX.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DV90AmxE.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DzWzo9Ij.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Bz0VyI0Z.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BjgscHtw.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Cx8p_sw9.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DoYWpPPd.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Ci-xHJlU.js" as="script"><link rel="prefetch" href="/blog/assets/2.html-DwdRHJG4.js" as="script"><link rel="prefetch" href="/blog/assets/3.html-DoXfDGmJ.js" as="script"><link rel="prefetch" href="/blog/assets/4.html-C-kKKJQV.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-fn4kmre_.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CoWvKsGl.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BvQMmH-P.js" as="script"><link rel="prefetch" href="/blog/assets/bitwise_operation.html-EhYVvxM9.js" as="script"><link rel="prefetch" href="/blog/assets/learning_algorithm.html-Tnr40gqi.js" as="script"><link rel="prefetch" href="/blog/assets/cache_pattern.html-BWIGrhub.js" as="script"><link rel="prefetch" href="/blog/assets/docker_tech.html-B7PNaqxh.js" as="script"><link rel="prefetch" href="/blog/assets/k3s.html-DP3vWh7K.js" as="script"><link rel="prefetch" href="/blog/assets/k3s_k8s_ingress.html-0VG_Dn9p.js" as="script"><link rel="prefetch" href="/blog/assets/oci-01-intro-guide.html-CMWMS7fl.js" as="script"><link rel="prefetch" href="/blog/assets/oci-02-runtime-spec.html-C0iBtGsB.js" as="script"><link rel="prefetch" href="/blog/assets/oci-03-image-spec.html-BBhmTevb.js" as="script"><link rel="prefetch" href="/blog/assets/oci-04-distribution-spec.html-BK42sbpW.js" as="script"><link rel="prefetch" href="/blog/assets/oci-05-security-guide.html-B3_bjMcv.js" as="script"><link rel="prefetch" href="/blog/assets/oci-06-monitoring-guide.html-DZeNq5_D.js" as="script"><link rel="prefetch" href="/blog/assets/oci-07-production-guide.html-Dd4znSBp.js" as="script"><link rel="prefetch" href="/blog/assets/oci-08-hooks-deep-dive.html-U722baza.js" as="script"><link rel="prefetch" href="/blog/assets/oci-linux-configurations-blog.html-B-QLbxh0.js" as="script"><link rel="prefetch" href="/blog/assets/oci-series-index.html-CDKgV4-S.js" as="script"><link rel="prefetch" href="/blog/assets/runc-comprehensive-design-guide.html-B3lFgAwq.js" as="script"><link rel="prefetch" href="/blog/assets/runc-container-lifecycle-diagrams.html-D0cL6kcw.js" as="script"><link rel="prefetch" href="/blog/assets/linux_namespace.html-C_6Up541.js" as="script"><link rel="prefetch" href="/blog/assets/python_checklist.html-C2qsWYBJ.js" as="script"><link rel="prefetch" href="/blog/assets/python_env_manage.html-CUnPJ_1B.js" as="script"><link rel="prefetch" href="/blog/assets/gevent.html-CUgqcz3s.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BJAgUlPO.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BO__mOgk.js" as="script"><link rel="prefetch" href="/blog/assets/sort_1.html-B61YFXe2.js" as="script"><link rel="prefetch" href="/blog/assets/01-runcgaishuyujiagou.html-CdwfP7-9.js" as="script"><link rel="prefetch" href="/blog/assets/02-rongqishengmingzhouqiguanli.html-C-f7fScs.js" as="script"><link rel="prefetch" href="/blog/assets/03-Namespacegelishixian.html-i58zOLTD.js" as="script"><link rel="prefetch" href="/blog/assets/04-Cgroupsziyuanguanli.html-Cv4-SHFL.js" as="script"><link rel="prefetch" href="/blog/assets/05-wenjianxitongyuguazaiguanli.html-BtljxstR.js" as="script"><link rel="prefetch" href="/blog/assets/06-anquantexingshixian.html-BHgpOUyN.js" as="script"><link rel="prefetch" href="/blog/assets/07-CRIUjianchadianyuhuifu.html-2aSuteQG.js" as="script"><link rel="prefetch" href="/blog/assets/08-tongxinyujiankongxitong.html-C1uYqrtr.js" as="script"><link rel="prefetch" href="/blog/assets/09-goujianjianhuarongqiyunxingshi.html-ZL_qjd8j.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DhgGbCoG.js" as="script"><link rel="prefetch" href="/blog/assets/abstract_factory.html-qSB2vqGJ.js" as="script"><link rel="prefetch" href="/blog/assets/factory_method.html-DaXxm691.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CQ2duCZ4.js" as="script"><link rel="prefetch" href="/blog/assets/adapter.html-k-5RMaEx.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-BmtOmY9V.js" as="script"><link rel="prefetch" href="/blog/assets/Valine.min-VCLvSWzF.js" as="script"><link rel="prefetch" href="/blog/assets/giscus-aTimukGI-DWEKOTfS.js" as="script"><link rel="prefetch" href="/blog/assets/KnowledgeMap-Dr6IblrL.js" as="script"><link rel="prefetch" href="/blog/assets/MermaidChart-a1CbfxcL.js" as="script"><link rel="prefetch" href="/blog/assets/mermaid.core-xyQxSs4c.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container series--no show-catalog"><header class="navbar-container not-open"><div class="navbar-inner"><div class="site-brand nav-item"><img class="logo" src="/blog/logo.png" alt="database of memory"><a href="/blog/" class="site-name can-hide">database of memory</a></div><div class="nav-item navbar-links-wrapper" style=""><div><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div><nav class="navbar-links"><!--[--><div class="navbar-links__item"><a href="/blog/" class="link" aria-label="Home"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Home<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/blog/categories/cloud-base/1/" class="link" aria-label="Categories"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Categories<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/blog/tags/runc/1/" class="link" aria-label="Tags"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Tags<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/blog/knowledge-map/" class="link" aria-label="知识地图"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->知识地图<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="Docs"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Docs<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="Docs"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Docs<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/blog/docs/leetcode/" class="link" aria-label="leetcode from scratch"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->leetcode from scratch<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/docs/design_pattern/" class="link" aria-label="design pattern"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->design pattern<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--><!----><span class="xicon-container btn-toggle-dark-mode btn--dark-mode navbar-links__item"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><path d="M15 2h2v3h-2z" fill="currentColor"></path><path d="M27 15h3v2h-3z" fill="currentColor"></path><path d="M15 27h2v3h-2z" fill="currentColor"></path><path d="M2 15h3v2H2z" fill="currentColor"></path><path d="M5.45 6.884l1.414-1.415l2.121 2.122l-1.414 1.414z" fill="currentColor"></path><path d="M23 7.58l2.121-2.12l1.414 1.414l-2.121 2.121z" fill="currentColor"></path><path d="M23.002 24.416l1.415-1.414l2.12 2.122l-1.413 1.414z" fill="currentColor"></path><path d="M5.47 25.13L7.59 23L9 24.42l-2.12 2.12l-1.41-1.41z" fill="currentColor"></path><path d="M16 8a8 8 0 1 0 8 8a8 8 0 0 0-8-8zm0 14a6 6 0 0 1 0-12z" fill="currentColor"></path></svg></span><ul class="social-links navbar-links__item"><!--[--><li class="social-item"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:25px;height:25px;"><path d="M16 2a14 14 0 0 0-4.43 27.28c.7.13 1-.3 1-.67v-2.38c-3.89.84-4.71-1.88-4.71-1.88a3.71 3.71 0 0 0-1.62-2.05c-1.27-.86.1-.85.1-.85a2.94 2.94 0 0 1 2.14 1.45a3 3 0 0 0 4.08 1.16a2.93 2.93 0 0 1 .88-1.87c-3.1-.36-6.37-1.56-6.37-6.92a5.4 5.4 0 0 1 1.44-3.76a5 5 0 0 1 .14-3.7s1.17-.38 3.85 1.43a13.3 13.3 0 0 1 7 0c2.67-1.81 3.84-1.43 3.84-1.43a5 5 0 0 1 .14 3.7a5.4 5.4 0 0 1 1.44 3.76c0 5.38-3.27 6.56-6.39 6.91a3.33 3.33 0 0 1 .95 2.59v3.84c0 .46.25.81 1 .67A14 14 0 0 0 16 2z" fill-rule="evenodd" fill="currentColor"></path></svg></li><!--]--></ul></nav><span class="xicon-container btn-toggle-menus"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><circle cx="16" cy="8" r="2" fill="currentColor"></circle><circle cx="16" cy="16" r="2" fill="currentColor"></circle><circle cx="16" cy="24" r="2" fill="currentColor"></circle></svg></span></div></div></header><!----><!----><!----><div class="theme-main" style=""><!----><!--[--><main class="page-container"><div class="page-content"><h1 class="page-title">runc 容器生命周期高级流程深度分析</h1><div class="page-info"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M16 4a5 5 0 1 1-5 5a5 5 0 0 1 5-5m0-2a7 7 0 1 0 7 7a7 7 0 0 0-7-7z" fill="currentColor"></path><path d="M26 30h-2v-5a5 5 0 0 0-5-5h-6a5 5 0 0 0-5 5v5H6v-5a7 7 0 0 1 7-7h6a7 7 0 0 1 7 7z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->hujunjie<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2024-01-15<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M11.17 6l3.42 3.41l.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[--><!--[--><a href="/blog/categories/cloud-base/1.html" class="">cloud-base</a><!--]--><!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M10 14a4 4 0 1 1 4-4a4.005 4.005 0 0 1-4 4zm0-6a2 2 0 1 0 1.998 2.004A2.002 2.002 0 0 0 10 8z" fill="currentColor"></path><path d="M16.644 29.415L2.586 15.354A2 2 0 0 1 2 13.941V4a2 2 0 0 1 2-2h9.941a2 2 0 0 1 1.414.586l14.06 14.058a2 2 0 0 1 0 2.828l-9.943 9.943a2 2 0 0 1-2.829 0zM4 4v9.942L18.058 28L28 18.058L13.942 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[--><!--[--><a href="/blog/tags/runc/1.html" class="">runc</a><a href="/blog/tags/rongqijishu/1.html" class="">容器技术</a><a href="/blog/tags/shengmingzhouqiguanli/1.html" class="">生命周期管理</a><a href="/blog/tags/shendufenxi/1.html" class="">深度分析</a><a href="/blog/tags/yunyuansheng/1.html" class="">云原生</a><a href="/blog/tags/CRIU/1.html" class="">CRIU</a><a href="/blog/tags/Cgroup/1.html" class="">Cgroup</a><!--]--><!--]--></span></span><!----></div><div class="theme-reco-md-content"><div><h1 id="runc-容器生命周期高级流程深度分析" tabindex="-1"><a class="header-anchor" href="#runc-容器生命周期高级流程深度分析"><span>runc 容器生命周期高级流程深度分析</span></a></h1><h2 id="目录" tabindex="-1"><a class="header-anchor" href="#目录"><span>目录</span></a></h2><ol><li><a href="#1-%E5%AE%B9%E5%99%A8%E6%9A%82%E5%81%9C%E6%81%A2%E5%A4%8D%E6%9C%BA%E5%88%B6%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90">容器暂停/恢复机制深度解析</a></li><li><a href="#2-criu%E6%A3%80%E6%9F%A5%E7%82%B9%E6%81%A2%E5%A4%8D%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B">CRIU检查点/恢复完整流程</a></li><li><a href="#3-%E5%AE%B9%E5%99%A8%E5%8A%A8%E6%80%81%E6%9B%B4%E6%96%B0%E6%9C%BA%E5%88%B6">容器动态更新机制</a></li><li><a href="#4-%E5%AE%B9%E5%99%A8%E6%89%A7%E8%A1%8Cexec%E6%B7%B1%E5%BA%A6%E5%AE%9E%E7%8E%B0">容器执行(exec)深度实现</a></li><li><a href="#5-%E5%AE%B9%E5%99%A8%E5%88%A0%E9%99%A4%E5%92%8C%E8%B5%84%E6%BA%90%E6%B8%85%E7%90%86">容器删除和资源清理</a></li><li><a href="#6-%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86%E5%92%8C%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86">信号处理和进程管理</a></li><li><a href="#7-%E4%BA%8B%E4%BB%B6%E7%9B%91%E6%8E%A7%E5%92%8C%E7%BB%9F%E8%AE%A1%E6%94%B6%E9%9B%86">事件监控和统计收集</a></li><li><a href="#8-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%93%8D%E4%BD%9C%E5%AE%9E%E7%8E%B0">高级网络操作实现</a></li><li><a href="#9-%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86%E8%AF%A6%E7%BB%86%E6%9C%BA%E5%88%B6">设备管理详细机制</a></li><li><a href="#10-%E6%8C%82%E8%BD%BD%E5%92%8C%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%93%8D%E4%BD%9C">挂载和文件系统操作</a></li><li><a href="#11-%E5%AE%89%E5%85%A8%E6%94%BB%E5%87%BB%E5%90%91%E9%87%8F%E4%B8%8E%E9%98%B2%E6%8A%A4">安全攻击向量与防护</a></li></ol><hr><h2 id="_1-容器暂停-恢复机制深度解析" tabindex="-1"><a class="header-anchor" href="#_1-容器暂停-恢复机制深度解析"><span>1. 容器暂停/恢复机制深度解析</span></a></h2><h3 id="_1-1-核心实现原理" tabindex="-1"><a class="header-anchor" href="#_1-1-核心实现原理"><span>1.1 核心实现原理</span></a></h3><h4 id="cgroup-freezer-子系统" tabindex="-1"><a class="header-anchor" href="#cgroup-freezer-子系统"><span>Cgroup Freezer 子系统</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">cgroup freezer 工作原理:</span>
<span class="line">┌─────────────────────────────────────────────────────────┐</span>
<span class="line">│ 用户空间 (runc pause/resume)                            │</span>
<span class="line">├─────────────────────────────────────────────────────────┤</span>
<span class="line">│ 写入 freezer.state (v1) / cgroup.freeze (v2)           │</span>
<span class="line">├─────────────────────────────────────────────────────────┤</span>
<span class="line">│ 内核 freezer 子系统                                    │</span>
<span class="line">│ ┌─────────────────────────────────────────────────────┐ │</span>
<span class="line">│ │ 1. 遍历 cgroup 中的所有进程                        │ │</span>
<span class="line">│ │ 2. 设置每个进程的 PF_FROZEN 标志                   │ │</span>
<span class="line">│ │ 3. 发送 fake signal 唤醒睡眠进程                   │ │</span>
<span class="line">│ │ 4. 进程检查 PF_FROZEN 后进入 freezer()             │ │</span>
<span class="line">│ │ 5. 进程在 freezer() 中无限等待                     │ │</span>
<span class="line">│ └─────────────────────────────────────────────────────┘ │</span>
<span class="line">├─────────────────────────────────────────────────────────┤</span>
<span class="line">│ 进程状态: TASK_UNINTERRUPTIBLE (D state)               │</span>
<span class="line">└─────────────────────────────────────────────────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-详细实现流程" tabindex="-1"><a class="header-anchor" href="#_1-2-详细实现流程"><span>1.2 详细实现流程</span></a></h3><h4 id="暂停操作-pause-go-→-container-linux-go" tabindex="-1"><a class="header-anchor" href="#暂停操作-pause-go-→-container-linux-go"><span>暂停操作 (pause.go → container_linux.go)</span></a></h4><p><strong>位置：</strong> <code>libcontainer/container_linux.go:772-789</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Container<span class="token punctuation">)</span> <span class="token function">Pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    c<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> c<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 1. 状态验证</span></span>
<span class="line">    status<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">currentStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">switch</span> status <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> Running<span class="token punctuation">,</span> Created<span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// 2. 执行 cgroup freezer 操作</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>cgroupManager<span class="token punctuation">.</span><span class="token function">Freeze</span><span class="token punctuation">(</span>cgroups<span class="token punctuation">.</span>Frozen<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 3. 状态转换到暂停状态</span></span>
<span class="line">        <span class="token keyword">return</span> c<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">transition</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pausedState<span class="token punctuation">{</span>c<span class="token punctuation">:</span> c<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> ErrNotRunning</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="cgroup-manager-实现细节" tabindex="-1"><a class="header-anchor" href="#cgroup-manager-实现细节"><span>Cgroup Manager 实现细节</span></a></h4><p><strong>位置：</strong> 通过 <code>opencontainers/cgroups</code> 库实现</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// Cgroup v1 实现</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">Freeze</span><span class="token punctuation">(</span>state cgroups<span class="token punctuation">.</span>FreezerState<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    freezerFile <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token string">&quot;freezer.state&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">switch</span> state <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> cgroups<span class="token punctuation">.</span>Frozen<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>freezerFile<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;FROZEN&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">case</span> cgroups<span class="token punctuation">.</span>Thawed<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>freezerFile<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;THAWED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Cgroup v2 实现</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">Freeze</span><span class="token punctuation">(</span>state cgroups<span class="token punctuation">.</span>FreezerState<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    freezerFile <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token string">&quot;cgroup.freeze&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">switch</span> state <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> cgroups<span class="token punctuation">.</span>Frozen<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>freezerFile<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">case</span> cgroups<span class="token punctuation">.</span>Thawed<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>freezerFile<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-3-特殊情况处理" tabindex="-1"><a class="header-anchor" href="#_1-3-特殊情况处理"><span>1.3 特殊情况处理</span></a></h3><h4 id="暂停状态下的-sigkill-处理" tabindex="-1"><a class="header-anchor" href="#暂停状态下的-sigkill-处理"><span>暂停状态下的 SIGKILL 处理</span></a></h4><p><strong>位置：</strong> <code>libcontainer/container_linux.go:424-430</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">if</span> s <span class="token operator">==</span> unix<span class="token punctuation">.</span>SIGKILL <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 特殊处理：暂停状态下的 SIGKILL</span></span>
<span class="line">    <span class="token keyword">if</span> paused<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> paused <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 必须先解冻才能杀死进程</span></span>
<span class="line">        <span class="token boolean">_</span> <span class="token operator">=</span> c<span class="token punctuation">.</span>cgroupManager<span class="token punctuation">.</span><span class="token function">Freeze</span><span class="token punctuation">(</span>cgroups<span class="token punctuation">.</span>Thawed<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>原因分析：</strong></p><ul><li>暂停状态下进程无法处理信号</li><li>SIGKILL 需要进程能够接收和处理</li><li>必须先解冻进程组，再发送 SIGKILL</li></ul><h4 id="恢复操作实现" tabindex="-1"><a class="header-anchor" href="#恢复操作实现"><span>恢复操作实现</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Container<span class="token punctuation">)</span> <span class="token function">Resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    c<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> c<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 1. 解冻 cgroup</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>cgroupManager<span class="token punctuation">.</span><span class="token function">Freeze</span><span class="token punctuation">(</span>cgroups<span class="token punctuation">.</span>Thawed<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 状态转换回运行状态</span></span>
<span class="line">    <span class="token keyword">return</span> c<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">transition</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>runningState<span class="token punctuation">{</span>c<span class="token punctuation">:</span> c<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-4-暂停-恢复调试追踪流程图" tabindex="-1"><a class="header-anchor" href="#_1-4-暂停-恢复调试追踪流程图"><span>1.4 暂停/恢复调试追踪流程图</span></a></h3><div class="mermaid-wrapper"><div class="mermaid-container" data-mermaid-code="sequenceDiagram%0A%20%20%20%20participant%20CLI%20as%20runc%20CLI%0A%20%20%20%20participant%20Container%20as%20Container%0A%20%20%20%20participant%20CgroupMgr%20as%20CgroupManager%0A%20%20%20%20participant%20CgroupFS%20as%20CgroupFS%0A%20%20%20%20participant%20Kernel%20as%20Linux%20Kernel%0A%20%20%20%20participant%20Process%20as%20Container%20Process%0A%0A%20%20%20%20Note%20over%20CLI%3A%20runc%20pause%20mycontainer%0A%20%20%20%20CLI-%3E%3EContainer%3A%20Pause()%0A%20%20%20%20Note%20right%20of%20Container%3A%20%E8%B0%83%E8%AF%95%E7%82%B9%201%3A%20%E6%9A%82%E5%81%9C%E8%AF%B7%E6%B1%82%E6%8E%A5%E6%94%B6%0A%20%20%20%20%0A%20%20%20%20Container-%3E%3EContainer%3A%20currentStatus()%0A%20%20%20%20alt%20%E7%8A%B6%E6%80%81%E6%A3%80%E6%9F%A5%0A%20%20%20%20%20%20%20%20Container-%3E%3EContainer%3A%20status%20%3D%3D%20Running%2FCreated%0A%20%20%20%20%20%20%20%20Note%20right%20of%20Container%3A%20%E8%B0%83%E8%AF%95%E7%82%B9%202%3A%20%E7%8A%B6%E6%80%81%E9%AA%8C%E8%AF%81%E9%80%9A%E8%BF%87%0A%20%20%20%20else%20%E7%8A%B6%E6%80%81%E5%BC%82%E5%B8%B8%0A%20%20%20%20%20%20%20%20Container--%3E%3ECLI%3A%20ErrNotRunning%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20Container-%3E%3ECgroupMgr%3A%20Freeze(cgroups.Frozen)%0A%20%20%20%20Note%20over%20CgroupMgr%3A%20%E8%B0%83%E8%AF%95%E7%82%B9%203%3A%20Cgroup%E5%86%BB%E7%BB%93%E6%93%8D%E4%BD%9C%0A%20%20%20%20%0A%20%20%20%20alt%20Cgroup%20v1%0A%20%20%20%20%20%20%20%20CgroupMgr-%3E%3ECgroupFS%3A%20write%20FROZEN%20to%20freezer.state%0A%20%20%20%20%20%20%20%20Note%20right%20of%20CgroupFS%3A%20%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84%3A%20%2Fsys%2Ffs%2Fcgroup%2Ffreezer%2Fdocker%2Fcontainer_id%2Ffreezer.state%0A%20%20%20%20else%20Cgroup%20v2%20%20%0A%20%20%20%20%20%20%20%20CgroupMgr-%3E%3ECgroupFS%3A%20write%201%20to%20cgroup.freeze%0A%20%20%20%20%20%20%20%20Note%20right%20of%20CgroupFS%3A%20%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84%3A%20%2Fsys%2Ffs%2Fcgroup%2Fdocker%2Fcontainer_id%2Fcgroup.freeze%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20CgroupFS-%3E%3EKernel%3A%20%E9%80%9A%E7%9F%A5%E5%86%85%E6%A0%B8%E5%86%BB%E7%BB%93%E8%BF%9B%E7%A8%8B%E7%BB%84%0A%20%20%20%20Note%20right%20of%20Kernel%3A%20%E8%B0%83%E8%AF%95%E7%82%B9%204%3A%20%E5%86%85%E6%A0%B8freezer%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%BF%80%E6%B4%BB%0A%20%20%20%20%0A%20%20%20%20Kernel-%3E%3EProcess%3A%20%E8%AE%BE%E7%BD%AEPF_FROZEN%E6%A0%87%E5%BF%97%0A%20%20%20%20Kernel-%3E%3EProcess%3A%20%E5%8F%91%E9%80%81fake%20signal%E5%94%A4%E9%86%92%E7%9D%A1%E7%9C%A0%E8%BF%9B%E7%A8%8B%0A%20%20%20%20Process-%3E%3EProcess%3A%20%E6%A3%80%E6%9F%A5PF_FROZEN%E6%A0%87%E5%BF%97%0A%20%20%20%20Process-%3E%3EProcess%3A%20%E8%BF%9B%E5%85%A5freezer()%E7%AD%89%E5%BE%85%E7%8A%B6%E6%80%81%0A%20%20%20%20Note%20right%20of%20Process%3A%20%E8%B0%83%E8%AF%95%E7%82%B9%205%3A%20%E8%BF%9B%E7%A8%8B%E8%BF%9B%E5%85%A5TASK_UNINTERRUPTIBLE%E7%8A%B6%E6%80%81%0A%20%20%20%20%0A%20%20%20%20Container-%3E%3EContainer%3A%20state.transition(%26pausedState%7B%7D)%0A%20%20%20%20Container-%3E%3EContainer%3A%20saveState()%0A%20%20%20%20Note%20over%20Container%3A%20%E8%B0%83%E8%AF%95%E7%82%B9%206%3A%20%E7%8A%B6%E6%80%81%E6%8C%81%E4%B9%85%E5%8C%96%E4%B8%BAPaused%0A%20%20%20%20%0A%20%20%20%20Container--%3E%3ECLI%3A%20%E6%9A%82%E5%81%9C%E6%88%90%E5%8A%9F%0A%20%20%20%20%0A%20%20%20%20Note%20over%20CLI%3A%20%3D%3D%3D%20%E6%81%A2%E5%A4%8D%E6%B5%81%E7%A8%8B%20%3D%3D%3D%0A%20%20%20%20Note%20over%20CLI%3A%20runc%20resume%20mycontainer%0A%20%20%20%20CLI-%3E%3EContainer%3A%20Resume()%0A%20%20%20%20Note%20right%20of%20Container%3A%20%E8%B0%83%E8%AF%95%E7%82%B9%207%3A%20%E6%81%A2%E5%A4%8D%E8%AF%B7%E6%B1%82%E6%8E%A5%E6%94%B6%0A%20%20%20%20%0A%20%20%20%20Container-%3E%3ECgroupMgr%3A%20Freeze(cgroups.Thawed)%0A%20%20%20%20Note%20over%20CgroupMgr%3A%20%E8%B0%83%E8%AF%95%E7%82%B9%208%3A%20Cgroup%E8%A7%A3%E5%86%BB%E6%93%8D%E4%BD%9C%0A%20%20%20%20%0A%20%20%20%20alt%20Cgroup%20v1%0A%20%20%20%20%20%20%20%20CgroupMgr-%3E%3ECgroupFS%3A%20write%20THAWED%20to%20freezer.state%0A%20%20%20%20else%20Cgroup%20v2%0A%20%20%20%20%20%20%20%20CgroupMgr-%3E%3ECgroupFS%3A%20write%200%20to%20cgroup.freeze%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20CgroupFS-%3E%3EKernel%3A%20%E9%80%9A%E7%9F%A5%E5%86%85%E6%A0%B8%E8%A7%A3%E5%86%BB%E8%BF%9B%E7%A8%8B%E7%BB%84%0A%20%20%20%20Note%20right%20of%20Kernel%3A%20%E8%B0%83%E8%AF%95%E7%82%B9%209%3A%20%E5%86%85%E6%A0%B8%E6%B8%85%E9%99%A4freezer%E7%8A%B6%E6%80%81%0A%20%20%20%20%0A%20%20%20%20Kernel-%3E%3EProcess%3A%20%E6%B8%85%E9%99%A4PF_FROZEN%E6%A0%87%E5%BF%97%0A%20%20%20%20Process-%3E%3EProcess%3A%20%E4%BB%8Efreezer()%E8%BF%94%E5%9B%9E%0A%20%20%20%20Process-%3E%3EProcess%3A%20%E6%81%A2%E5%A4%8D%E6%AD%A3%E5%B8%B8%E6%89%A7%E8%A1%8C%0A%20%20%20%20Note%20right%20of%20Process%3A%20%E8%B0%83%E8%AF%95%E7%82%B9%2010%3A%20%E8%BF%9B%E7%A8%8B%E6%81%A2%E5%A4%8DTASK_RUNNING%E7%8A%B6%E6%80%81%0A%20%20%20%20%0A%20%20%20%20Container-%3E%3EContainer%3A%20state.transition(%26runningState%7B%7D)%0A%20%20%20%20Container-%3E%3EContainer%3A%20saveState()%0A%20%20%20%20Note%20over%20Container%3A%20%E8%B0%83%E8%AF%95%E7%82%B9%2011%3A%20%E7%8A%B6%E6%80%81%E6%81%A2%E5%A4%8D%E4%B8%BARunning%0A%20%20%20%20%0A%20%20%20%20Container--%3E%3ECLI%3A%20%E6%81%A2%E5%A4%8D%E6%88%90%E5%8A%9F" id="mermaid-vz1eev3g8"><div class="mermaid-loading">Loading diagram...</div></div></div><h3 id="_1-5-暂停-恢复过程中的特殊情况调试" tabindex="-1"><a class="header-anchor" href="#_1-5-暂停-恢复过程中的特殊情况调试"><span>1.5 暂停/恢复过程中的特殊情况调试</span></a></h3><div class="mermaid-wrapper"><div class="mermaid-container" data-mermaid-code="graph%20TD%0A%20%20%20%20A%5B%E6%9A%82%E5%81%9C%E7%8A%B6%E6%80%81%E5%AE%B9%E5%99%A8%5D%20--%3E%20B%7B%E6%8E%A5%E6%94%B6%E4%BF%A1%E5%8F%B7%7D%0A%20%20%20%20%0A%20%20%20%20B%20--%3E%7CSIGKILL%7C%20C%5B%E6%A3%80%E6%B5%8B%E5%AE%B9%E5%99%A8%E6%9A%82%E5%81%9C%E7%8A%B6%E6%80%81%5D%0A%20%20%20%20B%20--%3E%7C%E5%85%B6%E4%BB%96%E4%BF%A1%E5%8F%B7%7C%20D%5B%E4%BF%A1%E5%8F%B7%E8%A2%AB%E9%98%BB%E5%A1%9E%5D%0A%20%20%20%20%0A%20%20%20%20C%20--%3E%20E%5B%E4%B8%B4%E6%97%B6%E8%A7%A3%E5%86%BB%E5%AE%B9%E5%99%A8%5D%0A%20%20%20%20E%20--%3E%20F%5B%E5%8F%91%E9%80%81SIGKILL%5D%0A%20%20%20%20F%20--%3E%20G%5B%E8%BF%9B%E7%A8%8B%E7%BB%88%E6%AD%A2%5D%0A%20%20%20%20%0A%20%20%20%20D%20--%3E%20H%5B%E7%AD%89%E5%BE%85%E6%81%A2%E5%A4%8D%E5%90%8E%E5%A4%84%E7%90%86%5D%0A%20%20%20%20%0A%20%20%20%20subgraph%20DEBUG%5B%22%E8%B0%83%E8%AF%95%E8%BF%BD%E8%B8%AA%E7%82%B9%22%5D%0A%20%20%20%20%20%20%20%20T1%5B%E7%9B%91%E6%8E%A7freezer.state%E5%8F%98%E5%8C%96%5D%0A%20%20%20%20%20%20%20%20T2%5B%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81%E6%A3%80%E6%9F%A5%3A%20%2Fproc%2Fpid%2Fstat%5D%0A%20%20%20%20%20%20%20%20T3%5B%E4%BF%A1%E5%8F%B7%E9%98%9F%E5%88%97%E7%8A%B6%E6%80%81%3A%20%2Fproc%2Fpid%2Fstatus%5D%0A%20%20%20%20%20%20%20%20T4%5Bcgroup%E8%BF%9B%E7%A8%8B%E5%88%97%E8%A1%A8%E5%8F%98%E5%8C%96%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20I%5B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4%E7%A4%BA%E4%BE%8B%5D%20--%3E%20J%5Bwatch%20cat%20%2Fsys%2Ffs%2Fcgroup%2Ffreezer%2F...%2Ffreezer.state%5D%0A%20%20%20%20I%20--%3E%20K%5Bps%20axo%20pid%2Cppid%2Cstate%2Ccomm%20%7C%20grep%20container%5D%0A%20%20%20%20I%20--%3E%20L%5Bkill%20-0%20pid%20%23%20%E6%B5%8B%E8%AF%95%E8%BF%9B%E7%A8%8B%E6%98%AF%E5%90%A6%E5%AD%98%E6%B4%BB%5D%0A%20%20%20%20%0A%20%20%20%20style%20A%20fill%3A%23f9f%2Cstroke%3A%23333%2Cstroke-width%3A2px%0A%20%20%20%20style%20T1%20fill%3A%23ff9%2Cstroke%3A%23333%2Cstroke-width%3A1px%0A%20%20%20%20style%20T2%20fill%3A%23ff9%2Cstroke%3A%23333%2Cstroke-width%3A1px%0A%20%20%20%20style%20T3%20fill%3A%23ff9%2Cstroke%3A%23333%2Cstroke-width%3A1px%0A%20%20%20%20style%20T4%20fill%3A%23ff9%2Cstroke%3A%23333%2Cstroke-width%3A1px" id="mermaid-tax41ouzo"><div class="mermaid-loading">Loading diagram...</div></div></div><h3 id="_1-6-暂停-恢复调试验证脚本" tabindex="-1"><a class="header-anchor" href="#_1-6-暂停-恢复调试验证脚本"><span>1.6 暂停/恢复调试验证脚本</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># runc pause/resume 调试验证脚本</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">CONTAINER_ID</span><span class="token operator">=</span><span class="token string">&quot;debug-container&quot;</span></span>
<span class="line"><span class="token assign-left variable">CGROUP_PATH</span><span class="token operator">=</span><span class="token string">&quot;/sys/fs/cgroup&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;=== 暂停/恢复调试验证 ===&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 1. 创建并启动容器</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;1. 创建容器...&quot;</span></span>
<span class="line">runc create <span class="token variable">$CONTAINER_ID</span></span>
<span class="line">runc start <span class="token variable">$CONTAINER_ID</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 2. 获取容器进程信息</span></span>
<span class="line"><span class="token assign-left variable">CONTAINER_PID</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>runc state $CONTAINER_ID <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> <span class="token string">&#39;.pid&#39;</span><span class="token variable">)</span></span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;容器主进程PID: <span class="token variable">$CONTAINER_PID</span>&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 3. 监控容器状态变化</span></span>
<span class="line"><span class="token function-name function">monitor_container_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">        <span class="token assign-left variable">STATE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">ps</span> <span class="token parameter variable">-o</span> state --no-headers <span class="token parameter variable">-p</span> $CONTAINER_PID <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;N/A&quot;</span><span class="token variable">)</span></span></span>
<span class="line">        <span class="token assign-left variable">FREEZER_STATE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> $CGROUP_PATH/freezer/docker/$CONTAINER_ID/freezer.state <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;N/A&quot;</span><span class="token variable">)</span></span></span>
<span class="line">        <span class="token assign-left variable">RUNC_STATE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>runc state $CONTAINER_ID <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> <span class="token string">&#39;.status&#39;</span><span class="token variable">)</span></span></span>
<span class="line">        </span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> <span class="token string">&#39;+%H:%M:%S&#39;</span><span class="token variable">)</span></span> - PID:<span class="token variable">$CONTAINER_PID</span> State:<span class="token variable">$STATE</span> Freezer:<span class="token variable">$FREEZER_STATE</span> runc:<span class="token variable">$RUNC_STATE</span>&quot;</span></span>
<span class="line">        <span class="token function">sleep</span> <span class="token number">1</span></span>
<span class="line">    <span class="token keyword">done</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 4. 后台启动状态监控</span></span>
<span class="line">monitor_container_state <span class="token operator">&amp;</span></span>
<span class="line"><span class="token assign-left variable">MONITOR_PID</span><span class="token operator">=</span><span class="token variable">$!</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 5. 执行暂停操作</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;2. 暂停容器...&quot;</span></span>
<span class="line"><span class="token function">sleep</span> <span class="token number">2</span></span>
<span class="line">runc pause <span class="token variable">$CONTAINER_ID</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 6. 验证暂停状态</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;3. 验证暂停状态...&quot;</span></span>
<span class="line"><span class="token function">sleep</span> <span class="token number">3</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 7. 尝试发送信号（应该被阻塞）</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;4. 测试信号处理（SIGUSR1）...&quot;</span></span>
<span class="line"><span class="token function">kill</span> <span class="token parameter variable">-USR1</span> <span class="token variable">$CONTAINER_PID</span> <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;信号发送成功&quot;</span> <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;信号被阻塞&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 8. 恢复容器</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;5. 恢复容器...&quot;</span></span>
<span class="line"><span class="token function">sleep</span> <span class="token number">2</span></span>
<span class="line">runc resume <span class="token variable">$CONTAINER_ID</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 9. 验证恢复状态</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;6. 验证恢复状态...&quot;</span></span>
<span class="line"><span class="token function">sleep</span> <span class="token number">3</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 10. 清理</span></span>
<span class="line"><span class="token function">kill</span> <span class="token variable">$MONITOR_PID</span></span>
<span class="line">runc <span class="token function">kill</span> <span class="token variable">$CONTAINER_ID</span> KILL</span>
<span class="line">runc delete <span class="token variable">$CONTAINER_ID</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;=== 调试验证完成 ===&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="_2-criu检查点-恢复完整流程" tabindex="-1"><a class="header-anchor" href="#_2-criu检查点-恢复完整流程"><span>2. CRIU检查点/恢复完整流程</span></a></h2><h3 id="_2-1-criu-集成架构" tabindex="-1"><a class="header-anchor" href="#_2-1-criu-集成架构"><span>2.1 CRIU 集成架构</span></a></h3><div class="mermaid-wrapper"><div class="mermaid-container" data-mermaid-code="graph%20TB%0A%20%20%20%20A%5Brunc%20checkpoint%2Frestore%20%E5%91%BD%E4%BB%A4%5D%20--%3E%20B%5BgRPC%2FRPC%20%E9%80%9A%E4%BF%A1%5D%0A%20%20%20%20B%20--%3E%20C%5BCRIU%20daemon%20%E8%BF%9B%E7%A8%8B%5D%0A%20%20%20%20%0A%20%20%20%20C%20--%3E%20D%5B%E8%BF%9B%E7%A8%8B%E6%A0%91%E9%81%8D%E5%8E%86%E5%92%8C%E5%86%BB%E7%BB%93%5D%0A%20%20%20%20C%20--%3E%20E%5B%E5%86%85%E5%AD%98%E9%A1%B5%E9%9D%A2%E8%BD%AC%E5%82%A8%5D%0A%20%20%20%20C%20--%3E%20F%5B%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E7%8A%B6%E6%80%81%E4%BF%9D%E5%AD%98%5D%0A%20%20%20%20C%20--%3E%20G%5B%E7%BD%91%E7%BB%9C%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E7%8A%B6%E6%80%81%5D%0A%20%20%20%20C%20--%3E%20H%5B%E6%8C%82%E8%BD%BD%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E5%BF%AB%E7%85%A7%5D%0A%20%20%20%20C%20--%3E%20I%5BIPC%20%E5%AF%B9%E8%B1%A1%E7%8A%B6%E6%80%81%5D%0A%20%20%20%20%0A%20%20%20%20D%20--%3E%20J%5B%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%5D%0A%20%20%20%20E%20--%3E%20J%0A%20%20%20%20F%20--%3E%20J%0A%20%20%20%20G%20--%3E%20J%0A%20%20%20%20H%20--%3E%20J%0A%20%20%20%20I%20--%3E%20J%0A%20%20%20%20%0A%20%20%20%20J%20--%3E%20K%5Bcore-%26lt%3Bpid%26gt%3B.img%3Cbr%2F%3E%E8%BF%9B%E7%A8%8B%E6%A0%B8%E5%BF%83%E4%BF%A1%E6%81%AF%5D%0A%20%20%20%20J%20--%3E%20L%5Bmm-%26lt%3Bpid%26gt%3B.img%3Cbr%2F%3E%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%5D%0A%20%20%20%20J%20--%3E%20M%5Bpagemap-%26lt%3Bpid%26gt%3B.img%3Cbr%2F%3E%E9%A1%B5%E9%9D%A2%E6%98%A0%E5%B0%84%5D%0A%20%20%20%20J%20--%3E%20N%5Bpages-%26lt%3Bn%26gt%3B.img%3Cbr%2F%3E%E5%86%85%E5%AD%98%E9%A1%B5%E9%9D%A2%E6%95%B0%E6%8D%AE%5D%0A%20%20%20%20J%20--%3E%20O%5Bfiles.img%3Cbr%2F%3E%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%5D%0A%20%20%20%20J%20--%3E%20P%5Bfs-%26lt%3Bpid%26gt%3B.img%3Cbr%2F%3E%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%BF%A1%E6%81%AF%5D%0A%20%20%20%20%0A%20%20%20%20style%20A%20fill%3A%23e1f5fe%0A%20%20%20%20style%20C%20fill%3A%23f3e5f5%0A%20%20%20%20style%20J%20fill%3A%23e8f5e8" id="mermaid-go5ybzv0n"><div class="mermaid-loading">Loading diagram...</div></div></div><h3 id="_2-2-检查点创建流程" tabindex="-1"><a class="header-anchor" href="#_2-2-检查点创建流程"><span>2.2 检查点创建流程</span></a></h3><h4 id="版本兼容性检查" tabindex="-1"><a class="header-anchor" href="#版本兼容性检查"><span>版本兼容性检查</span></a></h4><p><strong>位置：</strong> <code>libcontainer/criu_linux.go:280-292</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Container<span class="token punctuation">)</span> <span class="token function">Checkpoint</span><span class="token punctuation">(</span>criuOpts <span class="token operator">*</span>CriuOpts<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// CRIU 版本检查 (需要 3.0.0+)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">checkCriuVersion</span><span class="token punctuation">(</span><span class="token number">30000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 特性检查</span></span>
<span class="line">    criuFeatures<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">criuFeatures</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">checkCriuFeatures</span><span class="token punctuation">(</span>criuOpts<span class="token punctuation">,</span> criuFeatures<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="rpc-选项配置" tabindex="-1"><a class="header-anchor" href="#rpc-选项配置"><span>RPC 选项配置</span></a></h4><p><strong>位置：</strong> <code>libcontainer/criu_linux.go:340-408</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line">rpcOpts <span class="token operator">:=</span> criurpc<span class="token punctuation">.</span>CriuOpts<span class="token punctuation">{</span></span>
<span class="line">    ImagesDirFd<span class="token punctuation">:</span>     proto<span class="token punctuation">.</span><span class="token function">Int32</span><span class="token punctuation">(</span><span class="token function">int32</span><span class="token punctuation">(</span>imageDir<span class="token punctuation">.</span><span class="token function">Fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    WorkDirFd<span class="token punctuation">:</span>       proto<span class="token punctuation">.</span><span class="token function">Int32</span><span class="token punctuation">(</span><span class="token function">int32</span><span class="token punctuation">(</span>workDir<span class="token punctuation">.</span><span class="token function">Fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    LogLevel<span class="token punctuation">:</span>        proto<span class="token punctuation">.</span><span class="token function">Int32</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    LogFile<span class="token punctuation">:</span>         proto<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">&quot;dump.log&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    Root<span class="token punctuation">:</span>            proto<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Rootfs<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    ManageCgroups<span class="token punctuation">:</span>   proto<span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    TcpEstablished<span class="token punctuation">:</span>  proto<span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span>criuOpts<span class="token punctuation">.</span>TcpEstablished<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    ExtUnixSk<span class="token punctuation">:</span>       proto<span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span>criuOpts<span class="token punctuation">.</span>ExternalUnixConnections<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    ShellJob<span class="token punctuation">:</span>        proto<span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span>criuOpts<span class="token punctuation">.</span>ShellJob<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    FileLocks<span class="token punctuation">:</span>       proto<span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span>criuOpts<span class="token punctuation">.</span>FileLocks<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    Pid<span class="token punctuation">:</span>             proto<span class="token punctuation">.</span><span class="token function">Int32</span><span class="token punctuation">(</span><span class="token function">int32</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>initProcess<span class="token punctuation">.</span><span class="token function">pid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="外部命名空间处理" tabindex="-1"><a class="header-anchor" href="#外部命名空间处理"><span>外部命名空间处理</span></a></h4><p><strong>位置：</strong> <code>libcontainer/criu_linux.go:189-209</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Container<span class="token punctuation">)</span> <span class="token function">handleCheckpointingExternalNamespaces</span><span class="token punctuation">(</span>rpcOpts <span class="token operator">*</span>criurpc<span class="token punctuation">.</span>CriuOpts<span class="token punctuation">,</span> t configs<span class="token punctuation">.</span>NamespaceType<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    nsPath <span class="token operator">:=</span> c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Namespaces<span class="token punctuation">.</span><span class="token function">PathOf</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> nsPath <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">var</span> ns unix<span class="token punctuation">.</span>Stat_t</span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>nsPath<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ns<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;stat of %s failed: %w&quot;</span><span class="token punctuation">,</span> nsPath<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 生成外部命名空间标识符</span></span>
<span class="line">    criuExternal <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s[%d]:%s&quot;</span><span class="token punctuation">,</span> configs<span class="token punctuation">.</span><span class="token function">NsName</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span> ns<span class="token punctuation">.</span>Ino<span class="token punctuation">,</span> <span class="token function">criuNsToKey</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    rpcOpts<span class="token punctuation">.</span>External <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>rpcOpts<span class="token punctuation">.</span>External<span class="token punctuation">,</span> criuExternal<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-内存页面管理" tabindex="-1"><a class="header-anchor" href="#_2-3-内存页面管理"><span>2.3 内存页面管理</span></a></h3><h4 id="lazy-pages-支持" tabindex="-1"><a class="header-anchor" href="#lazy-pages-支持"><span>Lazy Pages 支持</span></a></h4><p><strong>位置：</strong> <code>libcontainer/criu_linux.go:409-435</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">if</span> criuOpts<span class="token punctuation">.</span>LazyPages <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// Lazy pages 需要 userfaultfd 支持</span></span>
<span class="line">    rpcOpts<span class="token punctuation">.</span>LazyPages <span class="token operator">=</span> proto<span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> criuOpts<span class="token punctuation">.</span>StatusFd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span></span>
<span class="line">        rpcOpts<span class="token punctuation">.</span>StatusFd <span class="token operator">=</span> proto<span class="token punctuation">.</span><span class="token function">Int32</span><span class="token punctuation">(</span><span class="token function">int32</span><span class="token punctuation">(</span>criuOpts<span class="token punctuation">.</span>StatusFd<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 页面服务器配置</span></span>
<span class="line">    <span class="token keyword">if</span> criuOpts<span class="token punctuation">.</span>PageServer<span class="token punctuation">.</span>Address <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        rpcOpts<span class="token punctuation">.</span>PsSocket <span class="token operator">=</span> proto<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>criuOpts<span class="token punctuation">.</span>PageServer<span class="token punctuation">.</span>Address<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> criuOpts<span class="token punctuation">.</span>PageServer<span class="token punctuation">.</span>Port <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">            rpcOpts<span class="token punctuation">.</span>PsPort <span class="token operator">=</span> proto<span class="token punctuation">.</span><span class="token function">Int32</span><span class="token punctuation">(</span>criuOpts<span class="token punctuation">.</span>PageServer<span class="token punctuation">.</span>Port<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="内存去重" tabindex="-1"><a class="header-anchor" href="#内存去重"><span>内存去重</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">if</span> criuOpts<span class="token punctuation">.</span>AutoDedup <span class="token punctuation">{</span></span>
<span class="line">    rpcOpts<span class="token punctuation">.</span>AutoDedup <span class="token operator">=</span> proto<span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-恢复流程实现" tabindex="-1"><a class="header-anchor" href="#_2-4-恢复流程实现"><span>2.4 恢复流程实现</span></a></h3><h4 id="挂载准备" tabindex="-1"><a class="header-anchor" href="#挂载准备"><span>挂载准备</span></a></h4><p><strong>位置：</strong> <code>libcontainer/criu_linux.go:622-674</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 为 CRIU 恢复准备绑定挂载</span></span>
<span class="line">root <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>stateDir<span class="token punctuation">,</span> <span class="token string">&quot;criu-root&quot;</span><span class="token punctuation">)</span> </span>
<span class="line"><span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token number">0o755</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 绑定挂载容器根文件系统</span></span>
<span class="line">err <span class="token operator">=</span> <span class="token function">mount</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Rootfs<span class="token punctuation">,</span> root<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_BIND<span class="token operator">|</span>unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token boolean">_</span> <span class="token operator">=</span> unix<span class="token punctuation">.</span><span class="token function">Unmount</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MNT_DETACH<span class="token punctuation">)</span></span>
<span class="line">    <span class="token boolean">_</span> <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">RemoveAll</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="进程恢复和监控" tabindex="-1"><a class="header-anchor" href="#进程恢复和监控"><span>进程恢复和监控</span></a></h4><p><strong>位置：</strong> <code>libcontainer/criu_linux.go:723-801</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">for</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">select</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> notify <span class="token operator">:=</span> <span class="token operator">&lt;-</span>notifyReceive<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">switch</span> notify<span class="token punctuation">.</span><span class="token function">GetScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token string">&quot;post-restore&quot;</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment">// 恢复后处理</span></span>
<span class="line">            pid <span class="token operator">:=</span> notify<span class="token punctuation">.</span><span class="token function">GetPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            logrus<span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span><span class="token string">&quot;restore: got post-restore event, pid: %d&quot;</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            p<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">FindProcess</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            cmd<span class="token punctuation">.</span>Process <span class="token operator">=</span> p</span>
<span class="line">            <span class="token comment">// 创建恢复后的进程对象</span></span>
<span class="line">            r<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">newRestoredProcess</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> fds<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            process<span class="token punctuation">.</span>ops <span class="token operator">=</span> r</span>
<span class="line">            </span>
<span class="line">        <span class="token keyword">case</span> <span class="token string">&quot;network-unlock&quot;</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment">// 网络解锁</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">criuNotifications</span><span class="token punctuation">(</span>notify<span class="token punctuation">,</span> notifySend<span class="token punctuation">,</span> criuOpts<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">case</span> err <span class="token operator">:=</span> <span class="token operator">&lt;-</span>criuProcessDone<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> process<span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="_3-容器动态更新机制" tabindex="-1"><a class="header-anchor" href="#_3-容器动态更新机制"><span>3. 容器动态更新机制</span></a></h2><h3 id="_3-1-支持的动态更新类型" tabindex="-1"><a class="header-anchor" href="#_3-1-支持的动态更新类型"><span>3.1 支持的动态更新类型</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">动态更新支持矩阵:</span>
<span class="line">┌─────────────────────┬──────────────────┬──────────────────┐</span>
<span class="line">│ 资源类型            │ 支持动态更新     │ 限制条件         │</span>
<span class="line">├─────────────────────┼──────────────────┼──────────────────┤</span>
<span class="line">│ CPU Shares          │ ✓                │ 无               │</span>
<span class="line">│ CPU Quota/Period    │ ✓                │ 必须同时设置     │</span>
<span class="line">│ CPU Set (亲和性)    │ ✓                │ 有效CPU范围      │</span>
<span class="line">│ Memory Limit        │ ✓                │ 不能小于当前使用 │</span>
<span class="line">│ Memory Swap         │ ✓                │ 依赖内核支持     │</span>
<span class="line">│ Memory Swappiness   │ ✓                │ 0-100范围        │</span>
<span class="line">│ Block I/O Weight    │ ✓                │ 10-1000范围      │</span>
<span class="line">│ Block I/O Throttle  │ ✓                │ 设备存在         │</span>
<span class="line">│ PID Limit           │ ✓                │ 不能小于当前PID数│</span>
<span class="line">│ Intel RDT           │ ✓                │ 硬件支持         │</span>
<span class="line">└─────────────────────┴──────────────────┴──────────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-更新实现机制" tabindex="-1"><a class="header-anchor" href="#_3-2-更新实现机制"><span>3.2 更新实现机制</span></a></h3><h4 id="核心更新函数" tabindex="-1"><a class="header-anchor" href="#核心更新函数"><span>核心更新函数</span></a></h4><p><strong>位置：</strong> <code>libcontainer/container_linux.go:164-197</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Container<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    c<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> c<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 1. 状态检查</span></span>
<span class="line">    status<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">currentStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> status <span class="token operator">==</span> Stopped <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> ErrNotRunning</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 应用 cgroup 资源更新</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>cgroupManager<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 3. 失败回滚机制</span></span>
<span class="line">        <span class="token keyword">if</span> err2 <span class="token operator">:=</span> c<span class="token punctuation">.</span>cgroupManager<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span><span class="token punctuation">;</span> err2 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            logrus<span class="token punctuation">.</span><span class="token function">Warnf</span><span class="token punctuation">(</span><span class="token string">&quot;Setting back cgroup configs failed&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. 更新容器配置</span></span>
<span class="line">    c<span class="token punctuation">.</span>config <span class="token operator">=</span> config</span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="cpu-配额和周期的协调更新" tabindex="-1"><a class="header-anchor" href="#cpu-配额和周期的协调更新"><span>CPU 配额和周期的协调更新</span></a></h4><p><strong>位置：</strong> <code>update.go:298-331</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// CPU quota/period 必须协调更新</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">validateCpuQuotaPeriod</span><span class="token punctuation">(</span>p <span class="token builtin">uint64</span><span class="token punctuation">,</span> q <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 验证 period 和 quota 的组合合理性</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> q <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> q <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 两者都设置或都不设置</span></span>
<span class="line">        config<span class="token punctuation">.</span>Cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">.</span>CpuPeriod <span class="token operator">=</span> p</span>
<span class="line">        config<span class="token punctuation">.</span>Cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">.</span>CpuQuota <span class="token operator">=</span> q</span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 部分更新时保持现有值</span></span>
<span class="line">        <span class="token keyword">if</span> p <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">            config<span class="token punctuation">.</span>Cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">.</span>CpuPeriod <span class="token operator">=</span> p</span>
<span class="line">            <span class="token comment">// 保持现有 quota</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> q <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">            config<span class="token punctuation">.</span>Cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">.</span>CpuQuota <span class="token operator">=</span> q</span>
<span class="line">            <span class="token comment">// 保持现有 period</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-intel-rdt-动态配置" tabindex="-1"><a class="header-anchor" href="#_3-3-intel-rdt-动态配置"><span>3.3 Intel RDT 动态配置</span></a></h3><p><strong>位置：</strong> <code>update.go:364-392</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// Intel RDT 资源配置更新</span></span>
<span class="line"><span class="token keyword">if</span> l3CacheSchema <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token operator">||</span> memBwSchema <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>IntelRdt <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        config<span class="token punctuation">.</span>IntelRdt <span class="token operator">=</span> <span class="token operator">&amp;</span>configs<span class="token punctuation">.</span>IntelRdt<span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// L3 缓存分配模式</span></span>
<span class="line">    <span class="token keyword">if</span> l3CacheSchema <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        config<span class="token punctuation">.</span>IntelRdt<span class="token punctuation">.</span>L3CacheSchema <span class="token operator">=</span> l3CacheSchema</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 内存带宽分配模式</span></span>
<span class="line">    <span class="token keyword">if</span> memBwSchema <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        config<span class="token punctuation">.</span>IntelRdt<span class="token punctuation">.</span>MemBwSchema <span class="token operator">=</span> memBwSchema</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 创建或更新 Intel RDT 管理器</span></span>
<span class="line">    intelRdtManager <span class="token operator">:=</span> intelrdt<span class="token punctuation">.</span><span class="token function">NewManager</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">,</span> container<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>IntelRdtPath<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> intelRdtManager<span class="token punctuation">.</span><span class="token function">Apply</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>InitProcessPid<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="_4-容器执行-exec-深度实现" tabindex="-1"><a class="header-anchor" href="#_4-容器执行-exec-深度实现"><span>4. 容器执行(exec)深度实现</span></a></h2><h3 id="_4-1-命名空间加入机制" tabindex="-1"><a class="header-anchor" href="#_4-1-命名空间加入机制"><span>4.1 命名空间加入机制</span></a></h3><h4 id="setns-进程创建" tabindex="-1"><a class="header-anchor" href="#setns-进程创建"><span>setns 进程创建</span></a></h4><p><strong>位置：</strong> <code>libcontainer/container_linux.go:635-689</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Container<span class="token punctuation">)</span> <span class="token function">newSetnsProcess</span><span class="token punctuation">(</span>p <span class="token operator">*</span>Process<span class="token punctuation">,</span> cmd <span class="token operator">*</span>exec<span class="token punctuation">.</span>Cmd<span class="token punctuation">,</span> comm <span class="token operator">*</span>processComm<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>setnsProcess<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 设置初始化类型</span></span>
<span class="line">    cmd<span class="token punctuation">.</span>Env <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>Env<span class="token punctuation">,</span> <span class="token string">&quot;_LIBCONTAINER_INITTYPE=&quot;</span><span class="token operator">+</span><span class="token function">string</span><span class="token punctuation">(</span>initSetns<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 获取容器状态</span></span>
<span class="line">    state <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">currentState</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 生成引导数据</span></span>
<span class="line">    data<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">bootstrapData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>NamespacePaths<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. 创建 setns 进程对象</span></span>
<span class="line">    proc <span class="token operator">:=</span> <span class="token operator">&amp;</span>setnsProcess<span class="token punctuation">{</span></span>
<span class="line">        cmd<span class="token punctuation">:</span>                 cmd<span class="token punctuation">,</span></span>
<span class="line">        comm<span class="token punctuation">:</span>                comm<span class="token punctuation">,</span></span>
<span class="line">        cgroupPaths<span class="token punctuation">:</span>         state<span class="token punctuation">.</span>CgroupPaths<span class="token punctuation">,</span></span>
<span class="line">        rootlessCgroups<span class="token punctuation">:</span>     c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>RootlessCgroups<span class="token punctuation">,</span></span>
<span class="line">        intelRdtPath<span class="token punctuation">:</span>        state<span class="token punctuation">.</span>IntelRdtPath<span class="token punctuation">,</span></span>
<span class="line">        initProcessPid<span class="token punctuation">:</span>      state<span class="token punctuation">.</span>InitProcessPid<span class="token punctuation">,</span></span>
<span class="line">        config<span class="token punctuation">:</span>              c<span class="token punctuation">.</span><span class="token function">newProcessConfig</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        process<span class="token punctuation">:</span>             p<span class="token punctuation">,</span></span>
<span class="line">        bootstrapData<span class="token punctuation">:</span>       io<span class="token punctuation">.</span><span class="token function">MultiReader</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> proc<span class="token punctuation">.</span>comm<span class="token punctuation">.</span>initSockParent<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        initProcessStarted<span class="token punctuation">:</span>  c<span class="token punctuation">.</span>initProcessStarted<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> proc<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-子-cgroup-管理" tabindex="-1"><a class="header-anchor" href="#_4-2-子-cgroup-管理"><span>4.2 子 Cgroup 管理</span></a></h3><h4 id="子-cgroup-路径解析" tabindex="-1"><a class="header-anchor" href="#子-cgroup-路径解析"><span>子 Cgroup 路径解析</span></a></h4><p><strong>位置：</strong> <code>exec.go:125-153</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">getSubCgroupPaths</span><span class="token punctuation">(</span>args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    paths <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> args <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> ctr<span class="token punctuation">,</span> path<span class="token punctuation">,</span> ok <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Cut</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// cgroup v1 格式: controller:path</span></span>
<span class="line">            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ctrl <span class="token operator">:=</span> <span class="token keyword">range</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>ctr<span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                paths<span class="token punctuation">[</span>ctrl<span class="token punctuation">]</span> <span class="token operator">=</span> path</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// cgroup v2 格式: path (统一层次结构)</span></span>
<span class="line">            paths<span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> c</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> paths<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="子-cgroup-创建和配置" tabindex="-1"><a class="header-anchor" href="#子-cgroup-创建和配置"><span>子 Cgroup 创建和配置</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Container<span class="token punctuation">)</span> <span class="token function">createExecSubCgroup</span><span class="token punctuation">(</span>subCgroupPaths <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>subCgroupPaths<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 创建子 cgroup</span></span>
<span class="line">    <span class="token keyword">for</span> controller<span class="token punctuation">,</span> path <span class="token operator">:=</span> <span class="token keyword">range</span> subCgroupPaths <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> controller <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// cgroup v2</span></span>
<span class="line">            fullPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>cgroupManager<span class="token punctuation">.</span><span class="token function">Path</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// cgroup v1</span></span>
<span class="line">            fullPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>cgroupManager<span class="token punctuation">.</span><span class="token function">Path</span><span class="token punctuation">(</span>controller<span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">,</span> <span class="token number">0o755</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to create exec sub-cgroup %s: %w&quot;</span><span class="token punctuation">,</span> fullPath<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-安全上下文继承" tabindex="-1"><a class="header-anchor" href="#_4-3-安全上下文继承"><span>4.3 安全上下文继承</span></a></h3><h4 id="进程凭据设置" tabindex="-1"><a class="header-anchor" href="#进程凭据设置"><span>进程凭据设置</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>setnsProcess<span class="token punctuation">)</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 命名空间加入 (setns 系统调用)</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ns <span class="token operator">:=</span> <span class="token keyword">range</span> p<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Namespaces <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> ns<span class="token punctuation">.</span>Path <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 加入现有命名空间</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Setns</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span><span class="token function">Fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">int</span><span class="token punctuation">(</span>ns<span class="token punctuation">.</span>Type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to setns %s: %w&quot;</span><span class="token punctuation">,</span> ns<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 用户凭据设置</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setupUser</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to setup user: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 安全标签应用</span></span>
<span class="line">    <span class="token keyword">if</span> p<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ProcessLabel <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> label<span class="token punctuation">.</span><span class="token function">SetProcessLabel</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ProcessLabel<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set process label: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. Capabilities 设置</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> capabilities<span class="token punctuation">.</span><span class="token function">Apply</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Capabilities<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to apply capabilities: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="_5-容器删除和资源清理" tabindex="-1"><a class="header-anchor" href="#_5-容器删除和资源清理"><span>5. 容器删除和资源清理</span></a></h2><h3 id="_5-1-删除操作流程" tabindex="-1"><a class="header-anchor" href="#_5-1-删除操作流程"><span>5.1 删除操作流程</span></a></h3><h4 id="强制终止策略" tabindex="-1"><a class="header-anchor" href="#强制终止策略"><span>强制终止策略</span></a></h4><p><strong>位置：</strong> <code>delete.go:16-25</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">killContainer</span><span class="token punctuation">(</span>container <span class="token operator">*</span>libcontainer<span class="token punctuation">.</span>Container<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 发送 SIGKILL 信号</span></span>
<span class="line">    <span class="token boolean">_</span> <span class="token operator">=</span> container<span class="token punctuation">.</span><span class="token function">Signal</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>SIGKILL<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 等待进程终止 (最多10秒)</span></span>
<span class="line">    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 3. 检查进程是否仍然存在</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> container<span class="token punctuation">.</span><span class="token function">Signal</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span><span class="token function">Signal</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 进程已终止，执行清理</span></span>
<span class="line">            <span class="token keyword">return</span> container<span class="token punctuation">.</span><span class="token function">Destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;container init still running&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-资源清理详细流程" tabindex="-1"><a class="header-anchor" href="#_5-2-资源清理详细流程"><span>5.2 资源清理详细流程</span></a></h3><h4 id="容器销毁实现" tabindex="-1"><a class="header-anchor" href="#容器销毁实现"><span>容器销毁实现</span></a></h4><p><strong>位置：</strong> <code>libcontainer/container_linux.go:754-768</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Container<span class="token punctuation">)</span> <span class="token function">Destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    c<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> c<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 1. 状态驱动的清理</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to destroy container: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="状态相关的清理操作" tabindex="-1"><a class="header-anchor" href="#状态相关的清理操作"><span>状态相关的清理操作</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// runningState 的清理</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>runningState<span class="token punctuation">)</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 终止所有进程</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>SIGKILL<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 等待进程终止</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>c<span class="token punctuation">.</span>initProcess<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 清理 cgroup</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>c<span class="token punctuation">.</span>cgroupManager<span class="token punctuation">.</span><span class="token function">Destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. 清理 Intel RDT</span></span>
<span class="line">    <span class="token keyword">if</span> r<span class="token punctuation">.</span>c<span class="token punctuation">.</span>intelRdtManager <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>c<span class="token punctuation">.</span>intelRdtManager<span class="token punctuation">.</span><span class="token function">Destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 5. 清理状态目录</span></span>
<span class="line">    <span class="token keyword">return</span> os<span class="token punctuation">.</span><span class="token function">RemoveAll</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>c<span class="token punctuation">.</span>root<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-cgroup-清理验证" tabindex="-1"><a class="header-anchor" href="#_5-3-cgroup-清理验证"><span>5.3 Cgroup 清理验证</span></a></h3><h4 id="进程疏散确认" tabindex="-1"><a class="header-anchor" href="#进程疏散确认"><span>进程疏散确认</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">Destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 检查 cgroup 是否为空</span></span>
<span class="line">    pids<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">GetAllPids</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>pids<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;cgroup still contains %d processes&quot;</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>pids<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 移除 cgroup 目录</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> subsystem <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;memory&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;cpu&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pids&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;blkio&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">{</span></span>
<span class="line">        cgroupPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">&quot;/sys/fs/cgroup&quot;</span><span class="token punctuation">,</span> subsystem<span class="token punctuation">,</span> m<span class="token punctuation">.</span>path<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>cgroupPath<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to remove cgroup %s: %w&quot;</span><span class="token punctuation">,</span> cgroupPath<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="_6-信号处理和进程管理" tabindex="-1"><a class="header-anchor" href="#_6-信号处理和进程管理"><span>6. 信号处理和进程管理</span></a></h2><h3 id="_6-1-信号处理架构" tabindex="-1"><a class="header-anchor" href="#_6-1-信号处理架构"><span>6.1 信号处理架构</span></a></h3><h4 id="信号处理流程图" tabindex="-1"><a class="header-anchor" href="#信号处理流程图"><span>信号处理流程图</span></a></h4><div class="mermaid-wrapper"><div class="mermaid-container" data-mermaid-code="graph%20TD%0A%20%20%20%20A%5B%E5%A4%96%E9%83%A8%E4%BF%A1%E5%8F%B7%5D%20--%3E%20B%5B%E4%BF%A1%E5%8F%B7%E7%BC%93%E5%86%B2%E9%80%9A%E9%81%93%3Cbr%2F%3E%E5%AE%B9%E9%87%8F%3A%202048%5D%0A%20%20%20%20B%20--%3E%20C%7B%E4%BF%A1%E5%8F%B7%E7%B1%BB%E5%9E%8B%E5%88%A4%E6%96%AD%7D%0A%20%20%20%20%0A%20%20%20%20C%20--%3E%7CSIGWINCH%7C%20D%5B%E7%BB%88%E7%AB%AF%E7%AA%97%E5%8F%A3%E5%A4%A7%E5%B0%8F%E5%8F%98%E5%8C%96%5D%0A%20%20%20%20C%20--%3E%7CSIGCHLD%7C%20E%5B%E5%AD%90%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81%E5%8F%98%E5%8C%96%5D%0A%20%20%20%20C%20--%3E%7CSIGURG%7C%20F%5BGo%E8%BF%90%E8%A1%8C%E6%97%B6%E4%BF%A1%E5%8F%B7%3Cbr%2F%3E%E4%B8%8D%E8%BD%AC%E5%8F%91%5D%0A%20%20%20%20C%20--%3E%7C%E5%85%B6%E4%BB%96%E4%BF%A1%E5%8F%B7%7C%20G%5B%E8%BD%AC%E5%8F%91%E5%88%B0%E5%AE%B9%E5%99%A8PID%201%5D%0A%20%20%20%20%0A%20%20%20%20D%20--%3E%20H%5B%E8%B0%83%E6%95%B4TTY%E5%A4%A7%E5%B0%8F%5D%0A%20%20%20%20E%20--%3E%20I%5B%E6%94%B6%E5%89%B2%E5%83%B5%E5%B0%B8%E8%BF%9B%E7%A8%8B%5D%0A%20%20%20%20G%20--%3E%20J%5B%E5%AE%B9%E5%99%A8%E8%BF%9B%E7%A8%8B%E5%A4%84%E7%90%86%5D%0A%20%20%20%20%0A%20%20%20%20I%20--%3E%20K%5B%E8%AE%B0%E5%BD%95%E9%80%80%E5%87%BA%E4%BF%A1%E6%81%AF%5D%0A%20%20%20%20K%20--%3E%20L%5B%E9%80%9A%E7%9F%A5%E9%80%80%E5%87%BA%E4%BA%8B%E4%BB%B6%5D%0A%20%20%20%20%0A%20%20%20%20subgraph%20%22%E5%AD%90%E8%BF%9B%E7%A8%8B%E6%94%B6%E5%89%B2%E5%99%A8%22%0A%20%20%20%20%20%20%20%20M%5B%E5%90%AF%E7%94%A8Subreaper%5D%0A%20%20%20%20%20%20%20%20N%5BWait4%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%5D%0A%20%20%20%20%20%20%20%20O%5B%E6%94%B6%E9%9B%86%E9%80%80%E5%87%BA%E7%8A%B6%E6%80%81%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20E%20--%3E%20M%0A%20%20%20%20M%20--%3E%20N%0A%20%20%20%20N%20--%3E%20O%0A%20%20%20%20O%20--%3E%20K%0A%20%20%20%20%0A%20%20%20%20style%20A%20fill%3A%23ffeb3b%0A%20%20%20%20style%20C%20fill%3A%232196f3%0A%20%20%20%20style%20I%20fill%3A%234caf50" id="mermaid-qfq76uivt"><div class="mermaid-loading">Loading diagram...</div></div></div><h4 id="信号缓冲和转发机制" tabindex="-1"><a class="header-anchor" href="#信号缓冲和转发机制"><span>信号缓冲和转发机制</span></a></h4><p><strong>位置：</strong> <code>signals.go:21-45</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">newSignalHandler</span><span class="token punctuation">(</span>enableSubreaper <span class="token builtin">bool</span><span class="token punctuation">,</span> notifySocket <span class="token operator">*</span>notifySocket<span class="token punctuation">)</span> <span class="token operator">*</span>signalHandler <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 启用子进程收割器</span></span>
<span class="line">    <span class="token keyword">if</span> enableSubreaper <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> system<span class="token punctuation">.</span><span class="token function">SetSubreaper</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            logrus<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 创建信号缓冲通道 (容量 2048)</span></span>
<span class="line">    s <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">,</span> signalBufferSize<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 捕获所有信号</span></span>
<span class="line">    signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>signalHandler<span class="token punctuation">{</span></span>
<span class="line">        signals<span class="token punctuation">:</span> s<span class="token punctuation">,</span></span>
<span class="line">        notify<span class="token punctuation">:</span>  notifySocket<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-进程树信号管理" tabindex="-1"><a class="header-anchor" href="#_6-2-进程树信号管理"><span>6.2 进程树信号管理</span></a></h3><h4 id="特殊信号处理" tabindex="-1"><a class="header-anchor" href="#特殊信号处理"><span>特殊信号处理</span></a></h4><p><strong>位置：</strong> <code>libcontainer/container_linux.go:383-413</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Container<span class="token punctuation">)</span> <span class="token function">Signal</span><span class="token punctuation">(</span>s os<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. SIGKILL 在非 PID 命名空间的特殊处理</span></span>
<span class="line">    <span class="token keyword">if</span> s <span class="token operator">==</span> unix<span class="token punctuation">.</span>SIGKILL <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Namespaces<span class="token punctuation">.</span><span class="token function">IsPrivate</span><span class="token punctuation">(</span>configs<span class="token punctuation">.</span>NEWPID<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 必须杀死 cgroup 中的所有进程</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">signalAllProcesses</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>cgroupManager<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>SIGKILL<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to kill all processes: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 常规信号转发</span></span>
<span class="line">    <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="批量进程信号发送" tabindex="-1"><a class="header-anchor" href="#批量进程信号发送"><span>批量进程信号发送</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">signalAllProcesses</span><span class="token punctuation">(</span>manager cgroups<span class="token punctuation">.</span>Manager<span class="token punctuation">,</span> s unix<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 获取 cgroup 中的所有进程</span></span>
<span class="line">    pids<span class="token punctuation">,</span> err <span class="token operator">:=</span> manager<span class="token punctuation">.</span><span class="token function">GetAllPids</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 向每个进程发送信号</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> pid <span class="token operator">:=</span> <span class="token keyword">range</span> pids <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Kill</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 忽略进程已不存在的错误</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">==</span> unix<span class="token punctuation">.</span>ESRCH <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">continue</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to signal process %d: %w&quot;</span><span class="token punctuation">,</span> pid<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-僵尸进程收割" tabindex="-1"><a class="header-anchor" href="#_6-3-僵尸进程收割"><span>6.3 僵尸进程收割</span></a></h3><h4 id="子进程状态收集" tabindex="-1"><a class="header-anchor" href="#子进程状态收集"><span>子进程状态收集</span></a></h4><p><strong>位置：</strong> <code>signals.go:127-148</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>signalHandler<span class="token punctuation">)</span> <span class="token function">reap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>exits <span class="token punctuation">[</span><span class="token punctuation">]</span>exit<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">var</span> ws unix<span class="token punctuation">.</span>WaitStatus</span>
<span class="line">        <span class="token keyword">var</span> rus unix<span class="token punctuation">.</span>Rusage</span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 1. 非阻塞等待子进程</span></span>
<span class="line">        pid<span class="token punctuation">,</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Wait4</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ws<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>WNOHANG<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rus<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">==</span> unix<span class="token punctuation">.</span>ECHILD <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// 没有更多子进程</span></span>
<span class="line">                <span class="token keyword">return</span> exits<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> pid <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 没有退出的子进程</span></span>
<span class="line">            <span class="token keyword">return</span> exits<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 2. 记录退出信息</span></span>
<span class="line">        exits <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>exits<span class="token punctuation">,</span> exit<span class="token punctuation">{</span></span>
<span class="line">            pid<span class="token punctuation">:</span>    pid<span class="token punctuation">,</span></span>
<span class="line">            status<span class="token punctuation">:</span> utils<span class="token punctuation">.</span><span class="token function">ExitStatus</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            rusage<span class="token punctuation">:</span> <span class="token operator">&amp;</span>rus<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-4-信号转发逻辑" tabindex="-1"><a class="header-anchor" href="#_6-4-信号转发逻辑"><span>6.4 信号转发逻辑</span></a></h3><p><strong>位置：</strong> <code>signals.go:85-122</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">for</span> s <span class="token operator">:=</span> <span class="token keyword">range</span> h<span class="token punctuation">.</span>signals <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">switch</span> s <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> unix<span class="token punctuation">.</span>SIGWINCH<span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// 终端窗口大小变化</span></span>
<span class="line">        <span class="token boolean">_</span> <span class="token operator">=</span> tty<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">    <span class="token keyword">case</span> unix<span class="token punctuation">.</span>SIGCHLD<span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// 子进程状态变化</span></span>
<span class="line">        exits<span class="token punctuation">,</span> err <span class="token operator">:=</span> h<span class="token punctuation">.</span><span class="token function">reap</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            logrus<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> e <span class="token operator">:=</span> <span class="token keyword">range</span> exits <span class="token punctuation">{</span></span>
<span class="line">            logrus<span class="token punctuation">.</span><span class="token function">WithFields</span><span class="token punctuation">(</span>logrus<span class="token punctuation">.</span>Fields<span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&quot;pid&quot;</span><span class="token punctuation">:</span>    e<span class="token punctuation">.</span>pid<span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;status&quot;</span><span class="token punctuation">:</span> e<span class="token punctuation">.</span>status<span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">&quot;process exited&quot;</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">if</span> h<span class="token punctuation">.</span>notify <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                h<span class="token punctuation">.</span>notify<span class="token punctuation">.</span><span class="token function">notifyExit</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">    <span class="token keyword">case</span> unix<span class="token punctuation">.</span>SIGURG<span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// Go 运行时信号，不转发</span></span>
<span class="line">        <span class="token keyword">continue</span></span>
<span class="line">        </span>
<span class="line">    <span class="token keyword">default</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// 转发其他信号到容器 PID 1</span></span>
<span class="line">        logrus<span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span><span class="token string">&quot;forwarding signal %d (%s) to %d&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                     <span class="token function">int</span><span class="token punctuation">(</span>us<span class="token punctuation">)</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span><span class="token function">SignalName</span><span class="token punctuation">(</span>us<span class="token punctuation">)</span><span class="token punctuation">,</span> pid1<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> process<span class="token punctuation">.</span><span class="token function">Signal</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            logrus<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="_7-事件监控和统计收集" tabindex="-1"><a class="header-anchor" href="#_7-事件监控和统计收集"><span>7. 事件监控和统计收集</span></a></h2><h3 id="_7-1-实时统计收集架构" tabindex="-1"><a class="header-anchor" href="#_7-1-实时统计收集架构"><span>7.1 实时统计收集架构</span></a></h3><div class="mermaid-wrapper"><div class="mermaid-container" data-mermaid-code="graph%20TB%0A%20%20%20%20A%5BContainer.Stats()%5D%20--%3E%20B%5B%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF%E8%81%9A%E5%90%88%5D%0A%20%20%20%20%0A%20%20%20%20B%20--%3E%20C%5BCgroup%E7%BB%9F%E8%AE%A1%5D%0A%20%20%20%20B%20--%3E%20D%5BIntel%20RDT%E7%BB%9F%E8%AE%A1%5D%0A%20%20%20%20B%20--%3E%20E%5B%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3%E7%BB%9F%E8%AE%A1%5D%0A%20%20%20%20%0A%20%20%20%20C%20--%3E%20C1%5B%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E9%87%8F%5D%0A%20%20%20%20C%20--%3E%20C2%5BCPU%E4%BD%BF%E7%94%A8%E7%8E%87%5D%0A%20%20%20%20C%20--%3E%20C3%5B%E5%9D%97%E8%AE%BE%E5%A4%87I%2FO%5D%0A%20%20%20%20C%20--%3E%20C4%5B%E8%BF%9B%E7%A8%8B%E6%95%B0%E9%87%8F%5D%0A%20%20%20%20%0A%20%20%20%20D%20--%3E%20D1%5BL3%E7%BC%93%E5%AD%98%E5%8D%A0%E7%94%A8%5D%0A%20%20%20%20D%20--%3E%20D2%5B%E5%86%85%E5%AD%98%E5%B8%A6%E5%AE%BD%E4%BD%BF%E7%94%A8%5D%0A%20%20%20%20%0A%20%20%20%20E%20--%3E%20E1%5B%E6%8E%A5%E6%94%B6%E5%AD%97%E8%8A%82%E6%95%B0%5D%0A%20%20%20%20E%20--%3E%20E2%5B%E5%8F%91%E9%80%81%E5%AD%97%E8%8A%82%E6%95%B0%5D%0A%20%20%20%20E%20--%3E%20E3%5B%E4%B8%A2%E5%8C%85%E7%BB%9F%E8%AE%A1%5D%0A%20%20%20%20E%20--%3E%20E4%5B%E9%94%99%E8%AF%AF%E7%BB%9F%E8%AE%A1%5D%0A%20%20%20%20%0A%20%20%20%20subgraph%20%22%E6%95%B0%E6%8D%AE%E6%BA%90%22%0A%20%20%20%20%20%20%20%20F1%5B%2Fsys%2Ffs%2Fcgroup%2F%5D%0A%20%20%20%20%20%20%20%20F2%5B%2Fsys%2Ffs%2Fresctrl%2F%5D%0A%20%20%20%20%20%20%20%20F3%5B%2Fsys%2Fclass%2Fnet%2F%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20C%20--%3E%20F1%0A%20%20%20%20D%20--%3E%20F2%0A%20%20%20%20E%20--%3E%20F3%0A%20%20%20%20%0A%20%20%20%20style%20A%20fill%3A%23e3f2fd%0A%20%20%20%20style%20B%20fill%3A%23f3e5f5%0A%20%20%20%20style%20C%20fill%3A%23e8f5e8%0A%20%20%20%20style%20D%20fill%3A%23fff3e0%0A%20%20%20%20style%20E%20fill%3A%23fce4ec" id="mermaid-wf8w8dbrh"><div class="mermaid-loading">Loading diagram...</div></div></div><h4 id="容器统计信息结构" tabindex="-1"><a class="header-anchor" href="#容器统计信息结构"><span>容器统计信息结构</span></a></h4><p><strong>位置：</strong> <code>libcontainer/container_linux.go:136-160</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Container<span class="token punctuation">)</span> <span class="token function">Stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Stats<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    stats <span class="token operator">:=</span> <span class="token operator">&amp;</span>Stats<span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 1. Cgroup 统计信息</span></span>
<span class="line">    <span class="token keyword">if</span> stats<span class="token punctuation">.</span>CgroupStats<span class="token punctuation">,</span> err <span class="token operator">=</span> c<span class="token punctuation">.</span>cgroupManager<span class="token punctuation">.</span><span class="token function">GetStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> stats<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to get container cgroup stats: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. Intel RDT 统计信息</span></span>
<span class="line">    <span class="token keyword">if</span> c<span class="token punctuation">.</span>intelRdtManager <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> stats<span class="token punctuation">.</span>IntelRdtStats<span class="token punctuation">,</span> err <span class="token operator">=</span> c<span class="token punctuation">.</span>intelRdtManager<span class="token punctuation">.</span><span class="token function">GetStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> stats<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to get container Intel RDT stats: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 网络接口统计</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> iface <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Networks <span class="token punctuation">{</span></span>
<span class="line">        istats<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getNetworkInterfaceStats</span><span class="token punctuation">(</span>iface<span class="token punctuation">.</span>HostInterfaceName<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            logrus<span class="token punctuation">.</span><span class="token function">Warnf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to get network stats for %s: %v&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                        iface<span class="token punctuation">.</span>HostInterfaceName<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">continue</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        stats<span class="token punctuation">.</span>Interfaces <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span>Interfaces<span class="token punctuation">,</span> istats<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> stats<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-oom-通知机制" tabindex="-1"><a class="header-anchor" href="#_7-2-oom-通知机制"><span>7.2 OOM 通知机制</span></a></h3><h4 id="oom-事件监控流程" tabindex="-1"><a class="header-anchor" href="#oom-事件监控流程"><span>OOM 事件监控流程</span></a></h4><div class="mermaid-wrapper"><div class="mermaid-container" data-mermaid-code="sequenceDiagram%0A%20%20%20%20participant%20App%20as%20%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%0A%20%20%20%20participant%20Runc%20as%20runc%0A%20%20%20%20participant%20Cgroup%20as%20Cgroup%E5%AD%90%E7%B3%BB%E7%BB%9F%0A%20%20%20%20participant%20Kernel%20as%20%E5%86%85%E6%A0%B8%0A%20%20%20%20participant%20EventFd%20as%20EventFD%0A%20%20%20%20%0A%20%20%20%20App-%3E%3ERunc%3A%20%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8%0A%20%20%20%20Runc-%3E%3ECgroup%3A%20%E5%88%9B%E5%BB%BAmemory%20cgroup%0A%20%20%20%20Runc-%3E%3EEventFd%3A%20%E5%88%9B%E5%BB%BAeventfd%0A%20%20%20%20Runc-%3E%3ECgroup%3A%20%E6%B3%A8%E5%86%8COOM%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%3Cbr%2F%3E%E5%86%99%E5%85%A5cgroup.event_control%0A%20%20%20%20%0A%20%20%20%20Note%20over%20Cgroup%2CKernel%3A%20%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E4%B8%AD...%0A%20%20%20%20%0A%20%20%20%20Kernel-%3E%3ECgroup%3A%20%E5%86%85%E5%AD%98%E4%B8%8D%E8%B6%B3%E8%A7%A6%E5%8F%91OOM%0A%20%20%20%20Cgroup-%3E%3EEventFd%3A%20%E5%8F%91%E9%80%81OOM%E4%BA%8B%E4%BB%B6%E9%80%9A%E7%9F%A5%0A%20%20%20%20EventFd-%3E%3ERunc%3A%20%E9%80%9A%E8%BF%87channel%E9%80%9A%E7%9F%A5%0A%20%20%20%20Runc-%3E%3EApp%3A%20OOM%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%0A%20%20%20%20%0A%20%20%20%20Note%20over%20App%3A%20%E5%8F%AF%E4%BB%A5%E9%80%89%E6%8B%A9%3A%3Cbr%2F%3E1.%20%E9%87%8D%E5%90%AF%E5%AE%B9%E5%99%A8%3Cbr%2F%3E2.%20%E5%A2%9E%E5%8A%A0%E5%86%85%E5%AD%98%E9%99%90%E5%88%B6%3Cbr%2F%3E3.%20%E8%AE%B0%E5%BD%95%E6%97%A5%E5%BF%97" id="mermaid-hzvongqow"><div class="mermaid-loading">Loading diagram...</div></div></div><h4 id="eventfd-集成实现" tabindex="-1"><a class="header-anchor" href="#eventfd-集成实现"><span>Eventfd 集成实现</span></a></h4><p><strong>位置：</strong> <code>libcontainer/notify_linux.go:63-71</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">notifyOnOOM</span><span class="token punctuation">(</span>dir <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">registerMemoryEvent</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token string">&quot;memory.oom_control&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">registerMemoryEvent</span><span class="token punctuation">(</span>cgDir <span class="token builtin">string</span><span class="token punctuation">,</span> evName <span class="token builtin">string</span><span class="token punctuation">,</span> arg <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 打开事件文件</span></span>
<span class="line">    evFile<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>cgDir<span class="token punctuation">,</span> evName<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> evFile<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 创建 eventfd</span></span>
<span class="line">    fd<span class="token punctuation">,</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Eventfd</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>EFD_CLOEXEC<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    eventfd <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">NewFile</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;eventfd&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 注册事件监听</span></span>
<span class="line">    eventControlPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>cgDir<span class="token punctuation">,</span> <span class="token string">&quot;cgroup.event_control&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    data <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%d %d %s&quot;</span><span class="token punctuation">,</span> eventfd<span class="token punctuation">.</span><span class="token function">Fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> evFile<span class="token punctuation">.</span><span class="token function">Fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>eventControlPath<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0o700</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        eventfd<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. 创建通知通道</span></span>
<span class="line">    ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">defer</span> eventfd<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        buf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> eventfd<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            ch <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> ch<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-3-网络统计收集" tabindex="-1"><a class="header-anchor" href="#_7-3-网络统计收集"><span>7.3 网络统计收集</span></a></h3><h4 id="接口统计解析" tabindex="-1"><a class="header-anchor" href="#接口统计解析"><span>接口统计解析</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">getNetworkInterfaceStats</span><span class="token punctuation">(</span>interfaceName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>NetworkInterface<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 从 /sys/class/net/&lt;interface&gt;/statistics 读取统计信息</span></span>
<span class="line">    statsPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">&quot;/sys/class/net&quot;</span><span class="token punctuation">,</span> interfaceName<span class="token punctuation">,</span> <span class="token string">&quot;statistics&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    stats <span class="token operator">:=</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>NetworkInterface<span class="token punctuation">{</span></span>
<span class="line">        Name<span class="token punctuation">:</span> interfaceName<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 读取入站统计</span></span>
<span class="line">    rxBytes<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">readUint64File</span><span class="token punctuation">(</span>filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>statsPath<span class="token punctuation">,</span> <span class="token string">&quot;rx_bytes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    rxPackets<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">readUint64File</span><span class="token punctuation">(</span>filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>statsPath<span class="token punctuation">,</span> <span class="token string">&quot;rx_packets&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    rxErrors<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">readUint64File</span><span class="token punctuation">(</span>filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>statsPath<span class="token punctuation">,</span> <span class="token string">&quot;rx_errors&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    rxDropped<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">readUint64File</span><span class="token punctuation">(</span>filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>statsPath<span class="token punctuation">,</span> <span class="token string">&quot;rx_dropped&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    stats<span class="token punctuation">.</span>RxBytes <span class="token operator">=</span> rxBytes</span>
<span class="line">    stats<span class="token punctuation">.</span>RxPackets <span class="token operator">=</span> rxPackets</span>
<span class="line">    stats<span class="token punctuation">.</span>RxErrors <span class="token operator">=</span> rxErrors</span>
<span class="line">    stats<span class="token punctuation">.</span>RxDropped <span class="token operator">=</span> rxDropped</span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 读取出站统计</span></span>
<span class="line">    txBytes<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">readUint64File</span><span class="token punctuation">(</span>filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>statsPath<span class="token punctuation">,</span> <span class="token string">&quot;tx_bytes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    txPackets<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">readUint64File</span><span class="token punctuation">(</span>filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>statsPath<span class="token punctuation">,</span> <span class="token string">&quot;tx_packets&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    txErrors<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">readUint64File</span><span class="token punctuation">(</span>filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>statsPath<span class="token punctuation">,</span> <span class="token string">&quot;tx_errors&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    txDropped<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">readUint64File</span><span class="token punctuation">(</span>filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>statsPath<span class="token punctuation">,</span> <span class="token string">&quot;tx_dropped&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    stats<span class="token punctuation">.</span>TxBytes <span class="token operator">=</span> txBytes</span>
<span class="line">    stats<span class="token punctuation">.</span>TxPackets <span class="token operator">=</span> txPackets</span>
<span class="line">    stats<span class="token punctuation">.</span>TxErrors <span class="token operator">=</span> txErrors</span>
<span class="line">    stats<span class="token punctuation">.</span>TxDropped <span class="token operator">=</span> txDropped</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> stats<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="_8-高级网络操作实现" tabindex="-1"><a class="header-anchor" href="#_8-高级网络操作实现"><span>8. 高级网络操作实现</span></a></h2><h3 id="_8-1-网络设备命名空间迁移" tabindex="-1"><a class="header-anchor" href="#_8-1-网络设备命名空间迁移"><span>8.1 网络设备命名空间迁移</span></a></h3><h4 id="原子化设备迁移" tabindex="-1"><a class="header-anchor" href="#原子化设备迁移"><span>原子化设备迁移</span></a></h4><p><strong>位置：</strong> <code>libcontainer/network_linux.go:113-232</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">devChangeNetNamespace</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> nsPath <span class="token builtin">string</span><span class="token punctuation">,</span> device configs<span class="token punctuation">.</span>LinuxNetDevice<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 获取网络接口</span></span>
<span class="line">    link<span class="token punctuation">,</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">LinkByName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to find link %s: %w&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 关闭接口（迁移前必须）</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">LinkSetDown</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set %s down: %w&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 保存现有 IP 地址</span></span>
<span class="line">    addresses<span class="token punctuation">,</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">AddrList</span><span class="token punctuation">(</span>link<span class="token punctuation">,</span> netlink<span class="token punctuation">.</span>FAMILY_ALL<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to get addresses for %s: %w&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. 原子化重命名和命名空间迁移</span></span>
<span class="line">    newName <span class="token operator">:=</span> device<span class="token punctuation">.</span>Name</span>
<span class="line">    <span class="token keyword">if</span> newName <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        newName <span class="token operator">=</span> name</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 打开目标命名空间</span></span>
<span class="line">    ns<span class="token punctuation">,</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>nsPath<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>O_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to open namespace %s: %w&quot;</span><span class="token punctuation">,</span> nsPath<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> unix<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span>ns<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 构造 netlink 请求</span></span>
<span class="line">    flags <span class="token operator">:=</span> unix<span class="token punctuation">.</span>NLM_F_REQUEST <span class="token operator">|</span> unix<span class="token punctuation">.</span>NLM_F_ACK</span>
<span class="line">    req <span class="token operator">:=</span> nl<span class="token punctuation">.</span><span class="token function">NewNetlinkRequest</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>RTM_NEWLINK<span class="token punctuation">,</span> flags<span class="token punctuation">)</span></span>
<span class="line">    req<span class="token punctuation">.</span><span class="token function">AddData</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nl<span class="token punctuation">.</span>IfInfomsg<span class="token punctuation">{</span></span>
<span class="line">        Index<span class="token punctuation">:</span> <span class="token function">int32</span><span class="token punctuation">(</span>link<span class="token punctuation">.</span><span class="token function">Attrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Index<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    req<span class="token punctuation">.</span><span class="token function">AddData</span><span class="token punctuation">(</span>nl<span class="token punctuation">.</span><span class="token function">NewRtAttr</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>IFLA_IFNAME<span class="token punctuation">,</span> nl<span class="token punctuation">.</span><span class="token function">ZeroTerminated</span><span class="token punctuation">(</span>newName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    req<span class="token punctuation">.</span><span class="token function">AddData</span><span class="token punctuation">(</span>nl<span class="token punctuation">.</span><span class="token function">NewRtAttr</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>IFLA_NET_NS_FD<span class="token punctuation">,</span> nl<span class="token punctuation">.</span><span class="token function">Uint32Attr</span><span class="token punctuation">(</span><span class="token function">uint32</span><span class="token punctuation">(</span>ns<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 发送 netlink 消息</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> req<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>NETLINK_ROUTE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to move %s to namespace: %w&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 5. 在新命名空间中恢复配置</span></span>
<span class="line">    <span class="token keyword">return</span> netns<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>hostNS netns<span class="token punctuation">.</span>NsHandle<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">defer</span> hostNS<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 在容器命名空间中重新获取接口</span></span>
<span class="line">        nsLink<span class="token punctuation">,</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">LinkByName</span><span class="token punctuation">(</span>newName<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to find %s in container: %w&quot;</span><span class="token punctuation">,</span> newName<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 恢复 IP 地址</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> address <span class="token operator">:=</span> <span class="token keyword">range</span> addresses <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 只恢复永久和全局地址</span></span>
<span class="line">            <span class="token keyword">if</span> address<span class="token punctuation">.</span>Flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>IFA_F_PERMANENT <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">continue</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">if</span> address<span class="token punctuation">.</span>Scope <span class="token operator">!=</span> unix<span class="token punctuation">.</span>RT_SCOPE_UNIVERSE <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">continue</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">AddrAdd</span><span class="token punctuation">(</span>nsLink<span class="token punctuation">,</span> <span class="token operator">&amp;</span>netlink<span class="token punctuation">.</span>Addr<span class="token punctuation">{</span></span>
<span class="line">                IPNet<span class="token punctuation">:</span> address<span class="token punctuation">.</span>IPNet<span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                logrus<span class="token punctuation">.</span><span class="token function">Warnf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to add address %s to %s: %v&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                           address<span class="token punctuation">.</span>IPNet<span class="token punctuation">,</span> newName<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 启动接口</span></span>
<span class="line">        <span class="token keyword">return</span> netlink<span class="token punctuation">.</span><span class="token function">LinkSetUp</span><span class="token punctuation">(</span>nsLink<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-veth-pair-管理" tabindex="-1"><a class="header-anchor" href="#_8-2-veth-pair-管理"><span>8.2 Veth Pair 管理</span></a></h3><h4 id="veth-对创建和配置" tabindex="-1"><a class="header-anchor" href="#veth-对创建和配置"><span>Veth 对创建和配置</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">createVethPair</span><span class="token punctuation">(</span>hostIfName<span class="token punctuation">,</span> containerIfName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 创建 veth 对</span></span>
<span class="line">    veth <span class="token operator">:=</span> <span class="token operator">&amp;</span>netlink<span class="token punctuation">.</span>Veth<span class="token punctuation">{</span></span>
<span class="line">        LinkAttrs<span class="token punctuation">:</span> netlink<span class="token punctuation">.</span>LinkAttrs<span class="token punctuation">{</span></span>
<span class="line">            Name<span class="token punctuation">:</span> hostIfName<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        PeerName<span class="token punctuation">:</span> containerIfName<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">LinkAdd</span><span class="token punctuation">(</span>veth<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to create veth pair: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 获取容器端接口</span></span>
<span class="line">    containerVeth<span class="token punctuation">,</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">LinkByName</span><span class="token punctuation">(</span>containerIfName<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to find container veth: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 移动容器端到容器命名空间</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">LinkSetNsFd</span><span class="token punctuation">(</span>containerVeth<span class="token punctuation">,</span> <span class="token function">int</span><span class="token punctuation">(</span>containerNS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to move container veth to namespace: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. 配置主机端</span></span>
<span class="line">    hostVeth<span class="token punctuation">,</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">LinkByName</span><span class="token punctuation">(</span>hostIfName<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to find host veth: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 连接到主机网桥</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">LinkSetMaster</span><span class="token punctuation">(</span>hostVeth<span class="token punctuation">,</span> bridge<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to attach to bridge: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 启动主机端接口</span></span>
<span class="line">    <span class="token keyword">return</span> netlink<span class="token punctuation">.</span><span class="token function">LinkSetUp</span><span class="token punctuation">(</span>hostVeth<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="_9-设备管理详细机制" tabindex="-1"><a class="header-anchor" href="#_9-设备管理详细机制"><span>9. 设备管理详细机制</span></a></h2><h3 id="_9-1-设备管理架构" tabindex="-1"><a class="header-anchor" href="#_9-1-设备管理架构"><span>9.1 设备管理架构</span></a></h3><div class="mermaid-wrapper"><div class="mermaid-container" data-mermaid-code="graph%20TB%0A%20%20%20%20A%5B%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%5D%20--%3E%20B%7B%E9%9C%80%E8%A6%81%E8%AE%BE%E5%A4%87%E8%AE%BE%E7%BD%AE%3F%7D%0A%20%20%20%20B%20--%3E%7C%E6%98%AF%7C%20C%5B%E5%88%9B%E5%BB%BA%E8%AE%BE%E5%A4%87%E8%8A%82%E7%82%B9%5D%0A%20%20%20%20B%20--%3E%7C%E5%90%A6%7C%20D%5B%E8%B7%B3%E8%BF%87%E8%AE%BE%E5%A4%87%E8%AE%BE%E7%BD%AE%5D%0A%20%20%20%20%0A%20%20%20%20C%20--%3E%20E%5B%E9%BB%98%E8%AE%A4%E8%AE%BE%E5%A4%87%E5%88%9B%E5%BB%BA%5D%0A%20%20%20%20C%20--%3E%20F%5B%E7%94%A8%E6%88%B7%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%BE%E5%A4%87%5D%0A%20%20%20%20%0A%20%20%20%20E%20--%3E%20G%5B%2Fdev%2Fnull%5D%0A%20%20%20%20E%20--%3E%20H%5B%2Fdev%2Fzero%5D%0A%20%20%20%20E%20--%3E%20I%5B%2Fdev%2Frandom%5D%0A%20%20%20%20E%20--%3E%20J%5B%2Fdev%2Furandom%5D%0A%20%20%20%20E%20--%3E%20K%5B%2Fdev%2Ftty%5D%0A%20%20%20%20E%20--%3E%20L%5B%2Fdev%2Fconsole%5D%0A%20%20%20%20E%20--%3E%20M%5B%2Fdev%2Fptmx%5D%0A%20%20%20%20%0A%20%20%20%20F%20--%3E%20N%5B%E8%AE%BE%E5%A4%87%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81%5D%0A%20%20%20%20N%20--%3E%20O%5BCgroup%E8%AE%BE%E5%A4%87%E6%8E%A7%E5%88%B6%5D%0A%20%20%20%20%0A%20%20%20%20O%20--%3E%20P%5B%E8%AE%BE%E5%A4%87%E8%AE%BF%E9%97%AE%E8%A7%84%E5%88%99%5D%0A%20%20%20%20P%20--%3E%20Q%5B%E8%AF%BB%E6%9D%83%E9%99%90%20r%5D%0A%20%20%20%20P%20--%3E%20R%5B%E5%86%99%E6%9D%83%E9%99%90%20w%5D%0A%20%20%20%20P%20--%3E%20S%5B%E5%88%9B%E5%BB%BA%E6%9D%83%E9%99%90%20m%5D%0A%20%20%20%20%0A%20%20%20%20subgraph%20%22%E8%AE%BE%E5%A4%87%E7%B1%BB%E5%9E%8B%22%0A%20%20%20%20%20%20%20%20T1%5B%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%20c%5D%0A%20%20%20%20%20%20%20%20T2%5B%E5%9D%97%E8%AE%BE%E5%A4%87%20b%5D%0A%20%20%20%20%20%20%20%20T3%5B%E6%89%80%E6%9C%89%E8%AE%BE%E5%A4%87%20a%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20P%20--%3E%20T1%0A%20%20%20%20P%20--%3E%20T2%0A%20%20%20%20P%20--%3E%20T3%0A%20%20%20%20%0A%20%20%20%20subgraph%20%22%E7%83%AD%E6%8F%92%E6%8B%94%E5%A4%84%E7%90%86%22%0A%20%20%20%20%20%20%20%20U1%5BUdev%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%5D%0A%20%20%20%20%20%20%20%20U2%5B%E8%AE%BE%E5%A4%87%E6%B7%BB%E5%8A%A0%5D%0A%20%20%20%20%20%20%20%20U3%5B%E8%AE%BE%E5%A4%87%E7%A7%BB%E9%99%A4%5D%0A%20%20%20%20%20%20%20%20U4%5B%E6%9D%83%E9%99%90%E6%9B%B4%E6%96%B0%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20O%20--%3E%20U1%0A%20%20%20%20U1%20--%3E%20U2%0A%20%20%20%20U1%20--%3E%20U3%0A%20%20%20%20U2%20--%3E%20U4%0A%20%20%20%20U3%20--%3E%20U4%0A%20%20%20%20%0A%20%20%20%20style%20A%20fill%3A%23e3f2fd%0A%20%20%20%20style%20C%20fill%3A%23f3e5f5%0A%20%20%20%20style%20O%20fill%3A%23e8f5e8%0A%20%20%20%20style%20P%20fill%3A%23fff3e0" id="mermaid-i4oi9fgnm"><div class="mermaid-loading">Loading diagram...</div></div></div><h4 id="标准设备创建流程" tabindex="-1"><a class="header-anchor" href="#标准设备创建流程"><span>标准设备创建流程</span></a></h4><p><strong>位置：</strong> <code>libcontainer/rootfs_linux.go:165-169</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">if</span> setupDev <span class="token operator">:=</span> <span class="token function">needsSetupDev</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> setupDev <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">createDevices</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;error creating device nodes: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="设备节点创建实现" tabindex="-1"><a class="header-anchor" href="#设备节点创建实现"><span>设备节点创建实现</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">createDevices</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 必需的默认设备</span></span>
<span class="line">    defaultDevices <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>configs<span class="token punctuation">.</span>DeviceRule<span class="token punctuation">{</span></span>
<span class="line">        <span class="token punctuation">{</span>Type<span class="token punctuation">:</span> configs<span class="token punctuation">.</span>CharDevice<span class="token punctuation">,</span> Major<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> Minor<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> Path<span class="token punctuation">:</span> <span class="token string">&quot;/dev/null&quot;</span><span class="token punctuation">,</span> FileMode<span class="token punctuation">:</span> <span class="token number">0o666</span><span class="token punctuation">,</span> Uid<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> Gid<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span>Type<span class="token punctuation">:</span> configs<span class="token punctuation">.</span>CharDevice<span class="token punctuation">,</span> Major<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> Minor<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> Path<span class="token punctuation">:</span> <span class="token string">&quot;/dev/zero&quot;</span><span class="token punctuation">,</span> FileMode<span class="token punctuation">:</span> <span class="token number">0o666</span><span class="token punctuation">,</span> Uid<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> Gid<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span>Type<span class="token punctuation">:</span> configs<span class="token punctuation">.</span>CharDevice<span class="token punctuation">,</span> Major<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> Minor<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> Path<span class="token punctuation">:</span> <span class="token string">&quot;/dev/full&quot;</span><span class="token punctuation">,</span> FileMode<span class="token punctuation">:</span> <span class="token number">0o666</span><span class="token punctuation">,</span> Uid<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> Gid<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span>Type<span class="token punctuation">:</span> configs<span class="token punctuation">.</span>CharDevice<span class="token punctuation">,</span> Major<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> Minor<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> Path<span class="token punctuation">:</span> <span class="token string">&quot;/dev/random&quot;</span><span class="token punctuation">,</span> FileMode<span class="token punctuation">:</span> <span class="token number">0o666</span><span class="token punctuation">,</span> Uid<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> Gid<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span>Type<span class="token punctuation">:</span> configs<span class="token punctuation">.</span>CharDevice<span class="token punctuation">,</span> Major<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> Minor<span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span> Path<span class="token punctuation">:</span> <span class="token string">&quot;/dev/urandom&quot;</span><span class="token punctuation">,</span> FileMode<span class="token punctuation">:</span> <span class="token number">0o666</span><span class="token punctuation">,</span> Uid<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> Gid<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span>Type<span class="token punctuation">:</span> configs<span class="token punctuation">.</span>CharDevice<span class="token punctuation">,</span> Major<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> Minor<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> Path<span class="token punctuation">:</span> <span class="token string">&quot;/dev/tty&quot;</span><span class="token punctuation">,</span> FileMode<span class="token punctuation">:</span> <span class="token number">0o666</span><span class="token punctuation">,</span> Uid<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> Gid<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span>Type<span class="token punctuation">:</span> configs<span class="token punctuation">.</span>CharDevice<span class="token punctuation">,</span> Major<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> Minor<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> Path<span class="token punctuation">:</span> <span class="token string">&quot;/dev/console&quot;</span><span class="token punctuation">,</span> FileMode<span class="token punctuation">:</span> <span class="token number">0o600</span><span class="token punctuation">,</span> Uid<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> Gid<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span>Type<span class="token punctuation">:</span> configs<span class="token punctuation">.</span>CharDevice<span class="token punctuation">,</span> Major<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> Minor<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> Path<span class="token punctuation">:</span> <span class="token string">&quot;/dev/ptmx&quot;</span><span class="token punctuation">,</span> FileMode<span class="token punctuation">:</span> <span class="token number">0o666</span><span class="token punctuation">,</span> Uid<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> Gid<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 创建设备节点</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> device <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token function">append</span><span class="token punctuation">(</span>defaultDevices<span class="token punctuation">,</span> config<span class="token punctuation">.</span>Devices<span class="token operator">...</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">createDeviceNode</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to create device %s: %w&quot;</span><span class="token punctuation">,</span> device<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">createDeviceNode</span><span class="token punctuation">(</span>device configs<span class="token punctuation">.</span>DeviceRule<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 创建设备文件</span></span>
<span class="line">    mode <span class="token operator">:=</span> device<span class="token punctuation">.</span>FileMode <span class="token operator">|</span> <span class="token function">uint32</span><span class="token punctuation">(</span>device<span class="token punctuation">.</span>Type<span class="token punctuation">)</span></span>
<span class="line">    dev <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Mkdev</span><span class="token punctuation">(</span><span class="token function">uint32</span><span class="token punctuation">(</span>device<span class="token punctuation">.</span>Major<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uint32</span><span class="token punctuation">(</span>device<span class="token punctuation">.</span>Minor<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Mknod</span><span class="token punctuation">(</span>device<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> <span class="token function">int</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token operator">!</span>os<span class="token punctuation">.</span><span class="token function">IsExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 设置所有者和权限</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Chown</span><span class="token punctuation">(</span>device<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> <span class="token function">int</span><span class="token punctuation">(</span>device<span class="token punctuation">.</span>Uid<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">int</span><span class="token punctuation">(</span>device<span class="token punctuation">.</span>Gid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> unix<span class="token punctuation">.</span><span class="token function">Chmod</span><span class="token punctuation">(</span>device<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> os<span class="token punctuation">.</span><span class="token function">FileMode</span><span class="token punctuation">(</span>device<span class="token punctuation">.</span>FileMode<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-2-设备-cgroup-控制" tabindex="-1"><a class="header-anchor" href="#_9-2-设备-cgroup-控制"><span>9.2 设备 Cgroup 控制</span></a></h3><h4 id="设备访问控制" tabindex="-1"><a class="header-anchor" href="#设备访问控制"><span>设备访问控制</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">type</span> LinuxDeviceCgroup <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Allow  <span class="token builtin">bool</span>     <span class="token string">`json:&quot;allow&quot;`</span></span>
<span class="line">    Type   <span class="token builtin">string</span>   <span class="token string">`json:&quot;type,omitempty&quot;`</span>   <span class="token comment">// a(all), c(char), b(block)</span></span>
<span class="line">    Major  <span class="token operator">*</span><span class="token builtin">int64</span>   <span class="token string">`json:&quot;major,omitempty&quot;`</span></span>
<span class="line">    Minor  <span class="token operator">*</span><span class="token builtin">int64</span>   <span class="token string">`json:&quot;minor,omitempty&quot;`</span></span>
<span class="line">    Access <span class="token builtin">string</span>   <span class="token string">`json:&quot;access,omitempty&quot;`</span> <span class="token comment">// r(read), w(write), m(mknod)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">applyDeviceCgroupRules</span><span class="token punctuation">(</span>manager cgroups<span class="token punctuation">.</span>Manager<span class="token punctuation">,</span> rules <span class="token punctuation">[</span><span class="token punctuation">]</span>configs<span class="token punctuation">.</span>DeviceRule<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> rule <span class="token operator">:=</span> <span class="token keyword">range</span> rules <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> manager<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>resources<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to apply device rule: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-3-热插拔设备处理" tabindex="-1"><a class="header-anchor" href="#_9-3-热插拔设备处理"><span>9.3 热插拔设备处理</span></a></h3><h4 id="udev-事件处理" tabindex="-1"><a class="header-anchor" href="#udev-事件处理"><span>Udev 事件处理</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">handleUdevEvent</span><span class="token punctuation">(</span>event UdevEvent<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">switch</span> event<span class="token punctuation">.</span>Action <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&quot;add&quot;</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// 设备插入</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">createDeviceNode</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>Device<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">updateDeviceCgroup</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>Device<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&quot;remove&quot;</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// 设备移除</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">removeDeviceNode</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>Device<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">updateDeviceCgroup</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>Device<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">    <span class="token keyword">default</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="_10-挂载和文件系统操作" tabindex="-1"><a class="header-anchor" href="#_10-挂载和文件系统操作"><span>10. 挂载和文件系统操作</span></a></h2><h3 id="_10-1-现代挂载-api-集成" tabindex="-1"><a class="header-anchor" href="#_10-1-现代挂载-api-集成"><span>10.1 现代挂载 API 集成</span></a></h3><h4 id="open-tree-和-move-mount-支持" tabindex="-1"><a class="header-anchor" href="#open-tree-和-move-mount-支持"><span>open_tree 和 move_mount 支持</span></a></h4><p><strong>位置：</strong> <code>libcontainer/mount_linux.go:253-339</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">mountFd</span><span class="token punctuation">(</span>nsHandles <span class="token operator">*</span>userns<span class="token punctuation">.</span>Handles<span class="token punctuation">,</span> m <span class="token operator">*</span>configs<span class="token punctuation">.</span>Mount<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>mountSource<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> m<span class="token punctuation">.</span><span class="token function">IsIDMapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 1. 使用 open_tree 创建挂载文件描述符</span></span>
<span class="line">        flags <span class="token operator">:=</span> <span class="token function">uint</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>OPEN_TREE_CLONE <span class="token operator">|</span> unix<span class="token punctuation">.</span>OPEN_TREE_CLOEXEC<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> m<span class="token punctuation">.</span>Flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_REC <span class="token operator">==</span> unix<span class="token punctuation">.</span>MS_REC <span class="token punctuation">{</span></span>
<span class="line">            flags <span class="token operator">|=</span> unix<span class="token punctuation">.</span>AT_RECURSIVE</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        fd<span class="token punctuation">,</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">OpenTree</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>AT_FDCWD<span class="token punctuation">,</span> m<span class="token punctuation">.</span>Source<span class="token punctuation">,</span> flags<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;open_tree failed: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        mountFile <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">NewFile</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Source<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 2. 配置 ID 映射</span></span>
<span class="line">        usernsFile<span class="token punctuation">,</span> err <span class="token operator">:=</span> nsHandles<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>IDMapping<span class="token punctuation">,</span> config<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">defer</span> usernsFile<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        setAttrFlags <span class="token operator">:=</span> unix<span class="token punctuation">.</span>AT_RECURSIVE</span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">MountSetattr</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>mountFile<span class="token punctuation">.</span><span class="token function">Fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> setAttrFlags<span class="token punctuation">,</span> <span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MountAttr<span class="token punctuation">{</span></span>
<span class="line">            Attr_set<span class="token punctuation">:</span>  unix<span class="token punctuation">.</span>MOUNT_ATTR_IDMAP<span class="token punctuation">,</span></span>
<span class="line">            Userns_fd<span class="token punctuation">:</span> <span class="token function">uint64</span><span class="token punctuation">(</span>usernsFile<span class="token punctuation">.</span><span class="token function">Fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set MOUNT_ATTR_IDMAP: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">&amp;</span>mountSource<span class="token punctuation">{</span></span>
<span class="line">            Type<span class="token punctuation">:</span> mountSourceOpenTree<span class="token punctuation">,</span></span>
<span class="line">            file<span class="token punctuation">:</span> mountFile<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 传统挂载方式</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>mountSource<span class="token punctuation">{</span></span>
<span class="line">        Type<span class="token punctuation">:</span> mountSourcePlain<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="文件描述符挂载" tabindex="-1"><a class="header-anchor" href="#文件描述符挂载"><span>文件描述符挂载</span></a></h4><p><strong>位置：</strong> <code>libcontainer/mount_linux.go:158-209</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">mountViaFds</span><span class="token punctuation">(</span>source <span class="token builtin">string</span><span class="token punctuation">,</span> srcFile <span class="token operator">*</span>mountSource<span class="token punctuation">,</span> target<span class="token punctuation">,</span> dstFd<span class="token punctuation">,</span> fstype <span class="token builtin">string</span><span class="token punctuation">,</span> flags <span class="token builtin">uintptr</span><span class="token punctuation">,</span> data <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    isMoveMount <span class="token operator">:=</span> srcFile <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> srcFile<span class="token punctuation">.</span>Type <span class="token operator">==</span> mountSourceOpenTree</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> isMoveMount <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 使用 move_mount 系统调用</span></span>
<span class="line">        err <span class="token operator">=</span> unix<span class="token punctuation">.</span><span class="token function">MoveMount</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>srcFile<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">Fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                           unix<span class="token punctuation">.</span>AT_FDCWD<span class="token punctuation">,</span> dstFd<span class="token punctuation">,</span></span>
<span class="line">                           unix<span class="token punctuation">.</span>MOVE_MOUNT_F_EMPTY_PATH<span class="token operator">|</span>unix<span class="token punctuation">.</span>MOVE_MOUNT_T_SYMLINKS<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;move_mount failed: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 传统 mount 系统调用</span></span>
<span class="line">        <span class="token keyword">var</span> src<span class="token punctuation">,</span> dst <span class="token builtin">string</span></span>
<span class="line">        <span class="token keyword">if</span> srcFile <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            src <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;/proc/self/fd/%d&quot;</span><span class="token punctuation">,</span> srcFile<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">Fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            src <span class="token operator">=</span> source</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> dstFd <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">            dst <span class="token operator">=</span> dstFd</span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            dst <span class="token operator">=</span> target</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        err <span class="token operator">=</span> unix<span class="token punctuation">.</span><span class="token function">Mount</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token punctuation">,</span> fstype<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> data<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;mount failed: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_10-2-挂载标志处理" tabindex="-1"><a class="header-anchor" href="#_10-2-挂载标志处理"><span>10.2 挂载标志处理</span></a></h3><h4 id="标志字符串化" tabindex="-1"><a class="header-anchor" href="#标志字符串化"><span>标志字符串化</span></a></h4><p><strong>位置：</strong> <code>libcontainer/mount_linux.go</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> stringifyMountFlags<span class="token punctuation">[</span>Int int32plus<span class="token punctuation">]</span><span class="token punctuation">(</span>flags Int<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">    flagNames <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">        name <span class="token builtin">string</span></span>
<span class="line">        bits Int</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_RDONLY&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_RDONLY<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_NOSUID&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NOSUID<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_NODEV&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NODEV<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_NOEXEC&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NOEXEC<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_SYNCHRONOUS&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_SYNCHRONOUS<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_REMOUNT&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_REMOUNT<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_MANDLOCK&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_MANDLOCK<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_DIRSYNC&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_DIRSYNC<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_NOSYMFOLLOW&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NOSYMFOLLOW<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_NOATIME&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NOATIME<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_NODIRATIME&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NODIRATIME<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_BIND&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_BIND<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_MOVE&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_MOVE<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_REC&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_SILENT&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_SILENT<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_POSIXACL&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_POSIXACL<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_UNBINDABLE&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_UNBINDABLE<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_PRIVATE&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_PRIVATE<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_SLAVE&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_SLAVE<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_SHARED&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_SHARED<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_RELATIME&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_RELATIME<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_KERNMOUNT&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_KERNMOUNT<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_I_VERSION&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_I_VERSION<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_STRICTATIME&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_STRICTATIME<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_LAZYTIME&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_LAZYTIME<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_ACTIVE&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_ACTIVE<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;MS_NOUSER&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NOUSER<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">var</span> parts <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> flag <span class="token operator">:=</span> <span class="token keyword">range</span> flagNames <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> flags<span class="token operator">&amp;</span>flag<span class="token punctuation">.</span>bits <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">            parts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>parts<span class="token punctuation">,</span> flag<span class="token punctuation">.</span>name<span class="token punctuation">)</span></span>
<span class="line">            flags <span class="token operator">&amp;^=</span> flag<span class="token punctuation">.</span>bits</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> flags <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        parts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>parts<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;0x%x&quot;</span><span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>parts<span class="token punctuation">,</span> <span class="token string">&quot;|&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_10-3-overlay-文件系统处理" tabindex="-1"><a class="header-anchor" href="#_10-3-overlay-文件系统处理"><span>10.3 Overlay 文件系统处理</span></a></h3><h4 id="overlay-挂载配置" tabindex="-1"><a class="header-anchor" href="#overlay-挂载配置"><span>Overlay 挂载配置</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">setupOverlayMount</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Mount<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 解析 overlay 选项</span></span>
<span class="line">    <span class="token keyword">var</span> lowerDirs<span class="token punctuation">,</span> upperDir<span class="token punctuation">,</span> workDir <span class="token builtin">string</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> opt <span class="token operator">:=</span> <span class="token keyword">range</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Data<span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> kv <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">SplitN</span><span class="token punctuation">(</span>opt<span class="token punctuation">,</span> <span class="token string">&quot;=&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">len</span><span class="token punctuation">(</span>kv<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">switch</span> kv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">case</span> <span class="token string">&quot;lowerdir&quot;</span><span class="token punctuation">:</span></span>
<span class="line">                lowerDirs <span class="token operator">=</span> kv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></span>
<span class="line">            <span class="token keyword">case</span> <span class="token string">&quot;upperdir&quot;</span><span class="token punctuation">:</span></span>
<span class="line">                upperDir <span class="token operator">=</span> kv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></span>
<span class="line">            <span class="token keyword">case</span> <span class="token string">&quot;workdir&quot;</span><span class="token punctuation">:</span></span>
<span class="line">                workDir <span class="token operator">=</span> kv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 创建必要的目录</span></span>
<span class="line">    <span class="token keyword">if</span> upperDir <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>upperDir<span class="token punctuation">,</span> <span class="token number">0o755</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to create upperdir %s: %w&quot;</span><span class="token punctuation">,</span> upperDir<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> workDir <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>workDir<span class="token punctuation">,</span> <span class="token number">0o755</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to create workdir %s: %w&quot;</span><span class="token punctuation">,</span> workDir<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 执行 overlay 挂载</span></span>
<span class="line">    <span class="token keyword">return</span> unix<span class="token punctuation">.</span><span class="token function">Mount</span><span class="token punctuation">(</span><span class="token string">&quot;overlay&quot;</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>Destination<span class="token punctuation">,</span> <span class="token string">&quot;overlay&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                     config<span class="token punctuation">.</span>Flags<span class="token punctuation">,</span> config<span class="token punctuation">.</span>Data<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="_11-安全攻击向量与防护" tabindex="-1"><a class="header-anchor" href="#_11-安全攻击向量与防护"><span>11. 安全攻击向量与防护</span></a></h2><h3 id="_11-1-主要攻击向量分析" tabindex="-1"><a class="header-anchor" href="#_11-1-主要攻击向量分析"><span>11.1 主要攻击向量分析</span></a></h3><h4 id="命名空间逃逸攻击" tabindex="-1"><a class="header-anchor" href="#命名空间逃逸攻击"><span>命名空间逃逸攻击</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">命名空间逃逸攻击向量:</span>
<span class="line">┌─────────────────────────────────────────────────────────┐</span>
<span class="line">│ 1. 挂载命名空间逃逸                                     │</span>
<span class="line">│    ├── 共享挂载传播利用                                 │</span>
<span class="line">│    ├── /proc 文件系统访问                               │</span>
<span class="line">│    └── bind 挂载路径遍历                                │</span>
<span class="line">│                                                        │</span>
<span class="line">│ 2. PID 命名空间逃逸                                     │</span>
<span class="line">│    ├── /proc/*/ns/* 符号链接利用                        │</span>
<span class="line">│    ├── ptrace 系统调用攻击                              │</span>
<span class="line">│    └── 进程层次结构操控                                 │</span>
<span class="line">│                                                        │</span>
<span class="line">│ 3. 网络命名空间绕过                                     │</span>
<span class="line">│    ├── netlink 套接字滥用                               │</span>
<span class="line">│    ├── 网络接口注入                                     │</span>
<span class="line">│    └── 路由表污染                                       │</span>
<span class="line">│                                                        │</span>
<span class="line">│ 4. 用户命名空间提权                                     │</span>
<span class="line">│    ├── UID/GID 映射操控                                 │</span>
<span class="line">│    ├── capability 继承利用                              │</span>
<span class="line">│    └── setuid 程序执行                                  │</span>
<span class="line">└─────────────────────────────────────────────────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="资源耗尽攻击" tabindex="-1"><a class="header-anchor" href="#资源耗尽攻击"><span>资源耗尽攻击</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 防护：内存使用限制</span></span>
<span class="line"><span class="token keyword">type</span> MemoryAttackMitigation <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 检查点大小限制</span></span>
<span class="line">    MaxCheckpointSize <span class="token builtin">int64</span> <span class="token string">`json:&quot;max_checkpoint_size&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 进程数量限制</span></span>
<span class="line">    MaxProcesses <span class="token builtin">int</span> <span class="token string">`json:&quot;max_processes&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 文件描述符限制</span></span>
<span class="line">    MaxOpenFiles <span class="token builtin">int</span> <span class="token string">`json:&quot;max_open_files&quot;`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. CPU 使用限制</span></span>
<span class="line">    CPUQuota <span class="token builtin">int64</span> <span class="token string">`json:&quot;cpu_quota&quot;`</span></span>
<span class="line">    CPUPeriod <span class="token builtin">int64</span> <span class="token string">`json:&quot;cpu_period&quot;`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">validateResourceLimits</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 内存限制验证</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>Cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">.</span>Memory <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token operator">*</span>config<span class="token punctuation">.</span>Cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">.</span>Memory <span class="token operator">&gt;</span> MaxAllowedMemory <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;memory limit exceeds maximum allowed&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// PID 限制验证</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>Cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">.</span>PidsLimit <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token operator">*</span>config<span class="token punctuation">.</span>Cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">.</span>PidsLimit <span class="token operator">&gt;</span> MaxAllowedPids <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;PID limit exceeds maximum allowed&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_11-2-权限提升防护" tabindex="-1"><a class="header-anchor" href="#_11-2-权限提升防护"><span>11.2 权限提升防护</span></a></h3><h4 id="nonewprivileges-强制执行" tabindex="-1"><a class="header-anchor" href="#nonewprivileges-强制执行"><span>NoNewPrivileges 强制执行</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">enforceNoNewPrivileges</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 强制启用 NoNewPrivileges</span></span>
<span class="line">    config<span class="token punctuation">.</span>NoNewPrivileges <span class="token operator">=</span> <span class="token boolean">true</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 验证 setuid/setgid 程序限制</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> mount <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Mounts <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> mount<span class="token punctuation">.</span>Flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_NOSUID <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">            logrus<span class="token punctuation">.</span><span class="token function">Warnf</span><span class="token punctuation">(</span><span class="token string">&quot;mount %s allows setuid programs&quot;</span><span class="token punctuation">,</span> mount<span class="token punctuation">.</span>Destination<span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment">// 自动添加 nosuid 标志</span></span>
<span class="line">            mount<span class="token punctuation">.</span>Flags <span class="token operator">|=</span> unix<span class="token punctuation">.</span>MS_NOSUID</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. Capability 最小化</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>Capabilities <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        config<span class="token punctuation">.</span>Capabilities <span class="token operator">=</span> <span class="token operator">&amp;</span>configs<span class="token punctuation">.</span>Capabilities<span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 清空所有 capability 集合</span></span>
<span class="line">    config<span class="token punctuation">.</span>Capabilities<span class="token punctuation">.</span>Bounding <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    config<span class="token punctuation">.</span>Capabilities<span class="token punctuation">.</span>Effective <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    config<span class="token punctuation">.</span>Capabilities<span class="token punctuation">.</span>Inheritable <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    config<span class="token punctuation">.</span>Capabilities<span class="token punctuation">.</span>Permitted <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    config<span class="token punctuation">.</span>Capabilities<span class="token punctuation">.</span>Ambient <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_11-3-状态一致性保护" tabindex="-1"><a class="header-anchor" href="#_11-3-状态一致性保护"><span>11.3 状态一致性保护</span></a></h3><h4 id="竞态条件防护" tabindex="-1"><a class="header-anchor" href="#竞态条件防护"><span>竞态条件防护</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Container<span class="token punctuation">)</span> <span class="token function">atomicStateTransition</span><span class="token punctuation">(</span>newState containerState<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    c<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> c<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 1. 验证状态转换合法性</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span>c<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">canTransitionTo</span><span class="token punctuation">(</span>newState<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;invalid state transition from %s to %s&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                         c<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newState<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 原子性状态更新</span></span>
<span class="line">    oldState <span class="token operator">:=</span> c<span class="token punctuation">.</span>state</span>
<span class="line">    c<span class="token punctuation">.</span>state <span class="token operator">=</span> newState</span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 持久化状态变更</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">saveState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 回滚状态</span></span>
<span class="line">        c<span class="token punctuation">.</span>state <span class="token operator">=</span> oldState</span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to save state: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="信号处理安全" tabindex="-1"><a class="header-anchor" href="#信号处理安全"><span>信号处理安全</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>signalHandler<span class="token punctuation">)</span> <span class="token function">securSignalForwarding</span><span class="token punctuation">(</span>pid <span class="token builtin">int</span><span class="token punctuation">,</span> signal os<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 验证目标进程</span></span>
<span class="line">    <span class="token keyword">if</span> pid <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;invalid PID: %d&quot;</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 检查进程存在性</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Kill</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">==</span> unix<span class="token punctuation">.</span>ESRCH <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;process %d not found&quot;</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to check process %d: %w&quot;</span><span class="token punctuation">,</span> pid<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 验证信号合法性</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">isAllowedSignal</span><span class="token punctuation">(</span>signal<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;signal %v not allowed&quot;</span><span class="token punctuation">,</span> signal<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. 安全地发送信号</span></span>
<span class="line">    <span class="token keyword">return</span> unix<span class="token punctuation">.</span><span class="token function">Kill</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> signal<span class="token punctuation">.</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">isAllowedSignal</span><span class="token punctuation">(</span>signal os<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    allowedSignals <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>os<span class="token punctuation">.</span>Signal<span class="token punctuation">{</span></span>
<span class="line">        unix<span class="token punctuation">.</span>SIGTERM<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>SIGKILL<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>SIGSTOP<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>SIGCONT<span class="token punctuation">,</span></span>
<span class="line">        unix<span class="token punctuation">.</span>SIGUSR1<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>SIGUSR2<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>SIGHUP<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>SIGINT<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> allowed <span class="token operator">:=</span> <span class="token keyword">range</span> allowedSignals <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> signal <span class="token operator">==</span> allowed <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_11-4-文件描述符安全" tabindex="-1"><a class="header-anchor" href="#_11-4-文件描述符安全"><span>11.4 文件描述符安全</span></a></h3><h4 id="安全文件描述符传递" tabindex="-1"><a class="header-anchor" href="#安全文件描述符传递"><span>安全文件描述符传递</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">safeFileDescriptorPassing</span><span class="token punctuation">(</span>fds <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> fd <span class="token operator">:=</span> <span class="token keyword">range</span> fds <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 1. 验证文件描述符路径</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">isValidFdPath</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;invalid file descriptor path: %s&quot;</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 2. 检查文件权限</span></span>
<span class="line">        fileInfo<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;cannot stat fd %s: %w&quot;</span><span class="token punctuation">,</span> fd<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 3. 验证文件类型</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">isAllowedFileType</span><span class="token punctuation">(</span>fileInfo<span class="token punctuation">.</span><span class="token function">Mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;file type not allowed for fd %s&quot;</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 4. 设置 CLOEXEC 标志</span></span>
<span class="line">        file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;cannot open fd %s: %w&quot;</span><span class="token punctuation">,</span> fd<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">CloseOnExec</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">Fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set CLOEXEC on %s: %w&quot;</span><span class="token punctuation">,</span> fd<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">isValidFdPath</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 只允许 /proc/self/fd/ 路径</span></span>
<span class="line">    <span class="token keyword">return</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;/proc/self/fd/&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> </span>
<span class="line">           strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;/dev/fd/&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">isAllowedFileType</span><span class="token punctuation">(</span>mode os<span class="token punctuation">.</span>FileMode<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 允许的文件类型</span></span>
<span class="line">    <span class="token keyword">return</span> mode<span class="token punctuation">.</span><span class="token function">IsRegular</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> </span>
<span class="line">           mode<span class="token operator">&amp;</span>os<span class="token punctuation">.</span>ModeCharDevice <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> </span>
<span class="line">           mode<span class="token operator">&amp;</span>os<span class="token punctuation">.</span>ModeNamedPipe <span class="token operator">!=</span> <span class="token number">0</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_11-5-挂载安全防护" tabindex="-1"><a class="header-anchor" href="#_11-5-挂载安全防护"><span>11.5 挂载安全防护</span></a></h3><h4 id="挂载源验证" tabindex="-1"><a class="header-anchor" href="#挂载源验证"><span>挂载源验证</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">validateMountSecurity</span><span class="token punctuation">(</span>mount <span class="token operator">*</span>configs<span class="token punctuation">.</span>Mount<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 路径遍历防护</span></span>
<span class="line">    <span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>mount<span class="token punctuation">.</span>Source<span class="token punctuation">,</span> <span class="token string">&quot;..&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;mount source contains path traversal: %s&quot;</span><span class="token punctuation">,</span> mount<span class="token punctuation">.</span>Source<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 敏感路径保护</span></span>
<span class="line">    sensitivePaths <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&quot;/proc&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/sys&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/dev&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/etc&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/boot&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/lib&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/lib64&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> sensitive <span class="token operator">:=</span> <span class="token keyword">range</span> sensitivePaths <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>mount<span class="token punctuation">.</span>Destination<span class="token punctuation">,</span> sensitive<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> mount<span class="token punctuation">.</span>Flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_NOSUID <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">                mount<span class="token punctuation">.</span>Flags <span class="token operator">|=</span> unix<span class="token punctuation">.</span>MS_NOSUID</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">if</span> mount<span class="token punctuation">.</span>Flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_NODEV <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">                mount<span class="token punctuation">.</span>Flags <span class="token operator">|=</span> unix<span class="token punctuation">.</span>MS_NODEV</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">if</span> mount<span class="token punctuation">.</span>Flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_NOEXEC <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">                mount<span class="token punctuation">.</span>Flags <span class="token operator">|=</span> unix<span class="token punctuation">.</span>MS_NOEXEC</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 挂载类型验证</span></span>
<span class="line">    allowedTypes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&quot;tmpfs&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;proc&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sysfs&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;devpts&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mqueue&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">        <span class="token string">&quot;cgroup&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;cgroup2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bind&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    typeAllowed <span class="token operator">:=</span> <span class="token boolean">false</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> allowed <span class="token operator">:=</span> <span class="token keyword">range</span> allowedTypes <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> mount<span class="token punctuation">.</span>Type <span class="token operator">==</span> allowed <span class="token punctuation">{</span></span>
<span class="line">            typeAllowed <span class="token operator">=</span> <span class="token boolean">true</span></span>
<span class="line">            <span class="token keyword">break</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span>typeAllowed <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;mount type %s not allowed&quot;</span><span class="token punctuation">,</span> mount<span class="token punctuation">.</span>Type<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><p>通过这个超深度分析，我们可以看到 runc 容器生命周期管理的复杂性和精密性：</p><h3 id="关键技术洞察" tabindex="-1"><a class="header-anchor" href="#关键技术洞察"><span>关键技术洞察</span></a></h3><ol><li><strong>多层协调机制</strong> - runc 通过精密的状态机和进程协调实现了复杂的容器生命周期管理</li><li><strong>现代 Linux API 集成</strong> - 大量使用了 Linux 5.0+ 的新系统调用和特性</li><li><strong>防御性编程</strong> - 每个操作都有详细的错误处理和安全验证</li><li><strong>性能优化</strong> - 通过文件描述符传递、异步操作等技术优化性能</li><li><strong>安全优先</strong> - 多层安全机制确保容器隔离的完整性</li></ol><h3 id="架构设计精髓" tabindex="-1"><a class="header-anchor" href="#架构设计精髓"><span>架构设计精髓</span></a></h3><ol><li><strong>状态驱动设计</strong> - 所有操作都基于明确的状态转换</li><li><strong>资源生命周期管理</strong> - 严格的资源创建、使用、清理流程</li><li><strong>错误恢复机制</strong> - 完善的失败处理和资源回收</li><li><strong>可扩展架构</strong> - 插件化的网络、存储、安全模块</li><li><strong>向后兼容</strong> - 支持多版本 Linux 内核和特性</li></ol><p>这个分析展现了现代容器技术的核心实现，为理解和开发高性能、高安全性的容器系统提供了宝贵的参考。</p></div></div><footer class="page-meta"><div class="meta-item edit-link"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M2 26h28v2H2z" fill="currentColor"></path><path d="M25.4 9c.8-.8.8-2 0-2.8l-3.6-3.6c-.8-.8-2-.8-2.8 0l-15 15V24h6.4l15-15zm-5-5L24 7.6l-3 3L17.4 7l3-3zM6 22v-3.6l10-10l3.6 3.6l-10 10H6z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Edit this page<!--]--></span></span></div><div class="meta-item last-updated"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->更新于 8/6/2025, 6:07:26 PM<!--]--></span></span></div></footer><!----><div class="reco-valine-wrapper"><div id="valine"></div></div></div><div class="page-catalog-container"><h5 class="tip">目录</h5><ul><!--[--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#目录" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="目录"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->目录<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_1-容器暂停-恢复机制深度解析" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1. 容器暂停/恢复机制深度解析"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1. 容器暂停/恢复机制深度解析<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_1-1-核心实现原理" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1.1 核心实现原理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1.1 核心实现原理<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_1-2-详细实现流程" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1.2 详细实现流程"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1.2 详细实现流程<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_1-3-特殊情况处理" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1.3 特殊情况处理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1.3 特殊情况处理<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_1-4-暂停-恢复调试追踪流程图" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1.4 暂停/恢复调试追踪流程图"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1.4 暂停/恢复调试追踪流程图<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_1-5-暂停-恢复过程中的特殊情况调试" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1.5 暂停/恢复过程中的特殊情况调试"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1.5 暂停/恢复过程中的特殊情况调试<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_1-6-暂停-恢复调试验证脚本" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1.6 暂停/恢复调试验证脚本"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1.6 暂停/恢复调试验证脚本<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_2-criu检查点-恢复完整流程" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2. CRIU检查点/恢复完整流程"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2. CRIU检查点/恢复完整流程<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_2-1-criu-集成架构" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.1 CRIU 集成架构"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.1 CRIU 集成架构<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_2-2-检查点创建流程" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.2 检查点创建流程"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.2 检查点创建流程<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_2-3-内存页面管理" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.3 内存页面管理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.3 内存页面管理<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_2-4-恢复流程实现" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.4 恢复流程实现"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.4 恢复流程实现<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_3-容器动态更新机制" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3. 容器动态更新机制"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3. 容器动态更新机制<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_3-1-支持的动态更新类型" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.1 支持的动态更新类型"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.1 支持的动态更新类型<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_3-2-更新实现机制" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.2 更新实现机制"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.2 更新实现机制<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_3-3-intel-rdt-动态配置" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3.3 Intel RDT 动态配置"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3.3 Intel RDT 动态配置<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_4-容器执行-exec-深度实现" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4. 容器执行(exec)深度实现"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4. 容器执行(exec)深度实现<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_4-1-命名空间加入机制" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4.1 命名空间加入机制"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4.1 命名空间加入机制<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_4-2-子-cgroup-管理" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4.2 子 Cgroup 管理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4.2 子 Cgroup 管理<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_4-3-安全上下文继承" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="4.3 安全上下文继承"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->4.3 安全上下文继承<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_5-容器删除和资源清理" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5. 容器删除和资源清理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5. 容器删除和资源清理<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_5-1-删除操作流程" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.1 删除操作流程"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.1 删除操作流程<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_5-2-资源清理详细流程" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.2 资源清理详细流程"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.2 资源清理详细流程<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_5-3-cgroup-清理验证" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="5.3 Cgroup 清理验证"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->5.3 Cgroup 清理验证<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_6-信号处理和进程管理" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6. 信号处理和进程管理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6. 信号处理和进程管理<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_6-1-信号处理架构" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6.1 信号处理架构"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6.1 信号处理架构<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_6-2-进程树信号管理" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6.2 进程树信号管理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6.2 进程树信号管理<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_6-3-僵尸进程收割" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6.3 僵尸进程收割"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6.3 僵尸进程收割<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_6-4-信号转发逻辑" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="6.4 信号转发逻辑"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->6.4 信号转发逻辑<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_7-事件监控和统计收集" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7. 事件监控和统计收集"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7. 事件监控和统计收集<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_7-1-实时统计收集架构" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7.1 实时统计收集架构"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7.1 实时统计收集架构<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_7-2-oom-通知机制" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7.2 OOM 通知机制"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7.2 OOM 通知机制<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_7-3-网络统计收集" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="7.3 网络统计收集"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->7.3 网络统计收集<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_8-高级网络操作实现" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8. 高级网络操作实现"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8. 高级网络操作实现<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_8-1-网络设备命名空间迁移" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8.1 网络设备命名空间迁移"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8.1 网络设备命名空间迁移<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_8-2-veth-pair-管理" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="8.2 Veth Pair 管理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->8.2 Veth Pair 管理<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_9-设备管理详细机制" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9. 设备管理详细机制"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9. 设备管理详细机制<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_9-1-设备管理架构" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9.1 设备管理架构"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9.1 设备管理架构<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_9-2-设备-cgroup-控制" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9.2 设备 Cgroup 控制"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9.2 设备 Cgroup 控制<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_9-3-热插拔设备处理" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="9.3 热插拔设备处理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->9.3 热插拔设备处理<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_10-挂载和文件系统操作" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="10. 挂载和文件系统操作"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->10. 挂载和文件系统操作<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_10-1-现代挂载-api-集成" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="10.1 现代挂载 API 集成"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->10.1 现代挂载 API 集成<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_10-2-挂载标志处理" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="10.2 挂载标志处理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->10.2 挂载标志处理<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_10-3-overlay-文件系统处理" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="10.3 Overlay 文件系统处理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->10.3 Overlay 文件系统处理<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_11-安全攻击向量与防护" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="11. 安全攻击向量与防护"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->11. 安全攻击向量与防护<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_11-1-主要攻击向量分析" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="11.1 主要攻击向量分析"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->11.1 主要攻击向量分析<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_11-2-权限提升防护" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="11.2 权限提升防护"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->11.2 权限提升防护<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_11-3-状态一致性保护" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="11.3 状态一致性保护"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->11.3 状态一致性保护<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_11-4-文件描述符安全" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="11.4 文件描述符安全"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->11.4 文件描述符安全<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#_11-5-挂载安全防护" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="11.5 挂载安全防护"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->11.5 挂载安全防护<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#总结" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="总结"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->总结<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#关键技术洞察" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="关键技术洞察"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->关键技术洞察<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/cloud-base/runc-advanced-lifecycle-analysis.html#架构设计精髓" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="架构设计精髓"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->架构设计精髓<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--]--></ul></div></main><!--]--></div></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/blog/assets/app-2O6audqE.js" defer></script>
  </body>
</html>

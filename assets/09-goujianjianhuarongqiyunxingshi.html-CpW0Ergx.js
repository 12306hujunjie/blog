import{_ as l,c,b as s,a as i,e as a,d as t,w as e,r as o,o as u}from"./app-6X7aTgdN.js";const r={};function k(d,n){const p=o("RouteLink");return u(),c("div",null,[n[11]||(n[11]=s("h1",{id:"构建简化容器运行时",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#构建简化容器运行时"},[s("span",null,"构建简化容器运行时")])],-1)),s("blockquote",null,[s("p",null,[n[2]||(n[2]=s("strong",null,"系列导航：",-1)),n[3]||(n[3]=a()),t(p,{to:"/blogs/cloud-base/runc-deep-dive/"},{default:e(()=>n[0]||(n[0]=[a("runc 容器运行时深度解析系列")])),_:1,__:[0]}),n[4]||(n[4]=a(" → 第九篇：构建简化容器运行时")),n[5]||(n[5]=s("br",null,null,-1)),n[6]||(n[6]=s("strong",null,"上一篇：",-1)),n[7]||(n[7]=a()),t(p,{to:"/blogs/cloud-base/runc-deep-dive/08-%E9%80%9A%E4%BF%A1%E4%B8%8E%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F.html"},{default:e(()=>n[1]||(n[1]=[a("通信与监控系统")])),_:1,__:[1]}),n[8]||(n[8]=s("br",null,null,-1)),n[9]||(n[9]=s("strong",null,"最后更新：",-1)),n[10]||(n[10]=a(" 2024"))])]),n[12]||(n[12]=i(`<h2 id="概述" tabindex="-1"><a class="header-anchor" href="#概述"><span>概述</span></a></h2><p>本文将指导你从零开始构建一个简化的容器运行时 minirunc，通过实际编程加深对容器技术原理的理解。这个项目将包含容器的核心功能：进程隔离、资源限制和文件系统管理。</p><h2 id="概述-1" tabindex="-1"><a class="header-anchor" href="#概述-1"><span>概述</span></a></h2><p>通过前面8个模块的学习，我们已经深入理解了runc的核心实现原理。现在，让我们将这些知识付诸实践，从零开始构建一个简化但功能完整的容器运行时&quot;minirunc&quot;。这个实践项目将帮助你真正掌握容器技术的精髓。</p><h2 id="_1-项目架构设计" tabindex="-1"><a class="header-anchor" href="#_1-项目架构设计"><span>1. 项目架构设计</span></a></h2><h3 id="_1-1-整体架构" tabindex="-1"><a class="header-anchor" href="#_1-1-整体架构"><span>1.1 整体架构</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">┌─────────────────────────────────────────────────────────────┐</span>
<span class="line">│                    MiniRunc 架构设计                          │</span>
<span class="line">├─────────────────────────────────────────────────────────────┤</span>
<span class="line">│                                                              │</span>
<span class="line">│   CLI层                      核心层                          │</span>
<span class="line">│  ┌──────────┐            ┌────────────┐                    │</span>
<span class="line">│  │   main   │───────────&gt;│  Runtime   │                    │</span>
<span class="line">│  │          │            │  Manager   │                    │</span>
<span class="line">│  └──────────┘            └────────────┘                    │</span>
<span class="line">│       │                        │                            │</span>
<span class="line">│  ┌──────────┐            ┌────────────┐                    │</span>
<span class="line">│  │ Commands │            │ Container  │                    │</span>
<span class="line">│  │  - run   │            │   Engine   │                    │</span>
<span class="line">│  │  - exec  │            └────────────┘                    │</span>
<span class="line">│  │  - ps    │                  │                            │</span>
<span class="line">│  │  - kill  │            ┌────────────────────────┐        │</span>
<span class="line">│  └──────────┘            │    Subsystems         │        │</span>
<span class="line">│                          ├────────────────────────┤        │</span>
<span class="line">│                          │ • Namespace Manager    │        │</span>
<span class="line">│                          │ • Cgroups Controller   │        │</span>
<span class="line">│                          │ • Filesystem Handler   │        │</span>
<span class="line">│                          │ • Security Module      │        │</span>
<span class="line">│                          │ • Network Manager      │        │</span>
<span class="line">│                          │ • Process Monitor      │        │</span>
<span class="line">│                          └────────────────────────┘        │</span>
<span class="line">│                                                            │</span>
<span class="line">└─────────────────────────────────────────────────────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-项目结构" tabindex="-1"><a class="header-anchor" href="#_1-2-项目结构"><span>1.2 项目结构</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">minirunc/</span>
<span class="line">├── cmd/                    <span class="token comment"># CLI命令实现</span></span>
<span class="line">│   ├── run.go             <span class="token comment"># run命令</span></span>
<span class="line">│   ├── exec.go            <span class="token comment"># exec命令</span></span>
<span class="line">│   ├── ps.go              <span class="token comment"># ps命令</span></span>
<span class="line">│   └── kill.go            <span class="token comment"># kill命令</span></span>
<span class="line">├── container/             <span class="token comment"># 容器核心实现</span></span>
<span class="line">│   ├── container.go       <span class="token comment"># 容器主逻辑</span></span>
<span class="line">│   ├── init.go           <span class="token comment"># init进程</span></span>
<span class="line">│   └── process.go        <span class="token comment"># 进程管理</span></span>
<span class="line">├── namespace/            <span class="token comment"># 命名空间管理</span></span>
<span class="line">│   ├── namespace.go      <span class="token comment"># 命名空间接口</span></span>
<span class="line">│   ├── mount.go          <span class="token comment"># Mount命名空间</span></span>
<span class="line">│   ├── pid.go           <span class="token comment"># PID命名空间</span></span>
<span class="line">│   ├── network.go       <span class="token comment"># 网络命名空间</span></span>
<span class="line">│   └── user.go          <span class="token comment"># 用户命名空间</span></span>
<span class="line">├── cgroups/             <span class="token comment"># Cgroups资源管理</span></span>
<span class="line">│   ├── manager.go       <span class="token comment"># Cgroups管理器</span></span>
<span class="line">│   ├── cpu.go          <span class="token comment"># CPU限制</span></span>
<span class="line">│   ├── memory.go       <span class="token comment"># 内存限制</span></span>
<span class="line">│   └── blkio.go        <span class="token comment"># I/O限制</span></span>
<span class="line">├── rootfs/              <span class="token comment"># 文件系统管理</span></span>
<span class="line">│   ├── rootfs.go       <span class="token comment"># rootfs管理</span></span>
<span class="line">│   └── mount.go        <span class="token comment"># 挂载处理</span></span>
<span class="line">├── network/            <span class="token comment"># 网络管理</span></span>
<span class="line">│   ├── bridge.go       <span class="token comment"># 网桥管理</span></span>
<span class="line">│   └── veth.go         <span class="token comment"># veth设备</span></span>
<span class="line">├── security/           <span class="token comment"># 安全模块</span></span>
<span class="line">│   ├── capabilities.go <span class="token comment"># 能力管理</span></span>
<span class="line">│   └── seccomp.go     <span class="token comment"># Seccomp过滤</span></span>
<span class="line">└── main.go            <span class="token comment"># 程序入口</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-核心数据结构" tabindex="-1"><a class="header-anchor" href="#_2-核心数据结构"><span>2. 核心数据结构</span></a></h2><h3 id="_2-1-容器配置" tabindex="-1"><a class="header-anchor" href="#_2-1-容器配置"><span>2.1 容器配置</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// container/types.go</span></span>
<span class="line"><span class="token keyword">package</span> container</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;time&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Container 容器结构</span></span>
<span class="line"><span class="token keyword">type</span> Container <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    ID         <span class="token builtin">string</span>            <span class="token string">\`json:&quot;id&quot;\`</span></span>
<span class="line">    Name       <span class="token builtin">string</span>            <span class="token string">\`json:&quot;name&quot;\`</span></span>
<span class="line">    State      ContainerState    <span class="token string">\`json:&quot;state&quot;\`</span></span>
<span class="line">    Config     <span class="token operator">*</span>ContainerConfig  <span class="token string">\`json:&quot;config&quot;\`</span></span>
<span class="line">    Created    time<span class="token punctuation">.</span>Time         <span class="token string">\`json:&quot;created&quot;\`</span></span>
<span class="line">    Pid        <span class="token builtin">int</span>               <span class="token string">\`json:&quot;pid&quot;\`</span></span>
<span class="line">    RootPath   <span class="token builtin">string</span>            <span class="token string">\`json:&quot;root_path&quot;\`</span></span>
<span class="line">    ConfigPath <span class="token builtin">string</span>            <span class="token string">\`json:&quot;config_path&quot;\`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ContainerState 容器状态</span></span>
<span class="line"><span class="token keyword">type</span> ContainerState <span class="token builtin">string</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">(</span></span>
<span class="line">    StateCreated  ContainerState <span class="token operator">=</span> <span class="token string">&quot;created&quot;</span></span>
<span class="line">    StateRunning  ContainerState <span class="token operator">=</span> <span class="token string">&quot;running&quot;</span></span>
<span class="line">    StateStopped  ContainerState <span class="token operator">=</span> <span class="token string">&quot;stopped&quot;</span></span>
<span class="line">    StatePaused   ContainerState <span class="token operator">=</span> <span class="token string">&quot;paused&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ContainerConfig 容器配置</span></span>
<span class="line"><span class="token keyword">type</span> ContainerConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 基础配置</span></span>
<span class="line">    Hostname     <span class="token builtin">string</span>            <span class="token string">\`json:&quot;hostname&quot;\`</span></span>
<span class="line">    Rootfs       <span class="token builtin">string</span>            <span class="token string">\`json:&quot;rootfs&quot;\`</span></span>
<span class="line">    Cmd          <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>          <span class="token string">\`json:&quot;cmd&quot;\`</span></span>
<span class="line">    Env          <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>          <span class="token string">\`json:&quot;env&quot;\`</span></span>
<span class="line">    WorkingDir   <span class="token builtin">string</span>            <span class="token string">\`json:&quot;working_dir&quot;\`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 资源限制</span></span>
<span class="line">    Resources    <span class="token operator">*</span>Resources        <span class="token string">\`json:&quot;resources&quot;\`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 命名空间</span></span>
<span class="line">    Namespaces   <span class="token punctuation">[</span><span class="token punctuation">]</span>NamespaceConfig <span class="token string">\`json:&quot;namespaces&quot;\`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 挂载配置</span></span>
<span class="line">    Mounts       <span class="token punctuation">[</span><span class="token punctuation">]</span>Mount           <span class="token string">\`json:&quot;mounts&quot;\`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 网络配置</span></span>
<span class="line">    Network      <span class="token operator">*</span>NetworkConfig    <span class="token string">\`json:&quot;network&quot;\`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 安全配置</span></span>
<span class="line">    Capabilities <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>          <span class="token string">\`json:&quot;capabilities&quot;\`</span></span>
<span class="line">    SeccompProfile <span class="token builtin">string</span>          <span class="token string">\`json:&quot;seccomp_profile&quot;\`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Resources 资源限制配置</span></span>
<span class="line"><span class="token keyword">type</span> Resources <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Memory       <span class="token operator">*</span>MemoryResource   <span class="token string">\`json:&quot;memory,omitempty&quot;\`</span></span>
<span class="line">    CPU          <span class="token operator">*</span>CPUResource      <span class="token string">\`json:&quot;cpu,omitempty&quot;\`</span></span>
<span class="line">    BlockIO      <span class="token operator">*</span>BlockIOResource  <span class="token string">\`json:&quot;blkio,omitempty&quot;\`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> MemoryResource <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Limit       <span class="token builtin">int64</span>  <span class="token string">\`json:&quot;limit,omitempty&quot;\`</span>        <span class="token comment">// 内存限制(bytes)</span></span>
<span class="line">    Reservation <span class="token builtin">int64</span>  <span class="token string">\`json:&quot;reservation,omitempty&quot;\`</span>  <span class="token comment">// 内存预留</span></span>
<span class="line">    Swap        <span class="token builtin">int64</span>  <span class="token string">\`json:&quot;swap,omitempty&quot;\`</span>         <span class="token comment">// Swap限制</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> CPUResource <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Shares  <span class="token builtin">uint64</span>  <span class="token string">\`json:&quot;shares,omitempty&quot;\`</span>  <span class="token comment">// CPU份额</span></span>
<span class="line">    Quota   <span class="token builtin">int64</span>   <span class="token string">\`json:&quot;quota,omitempty&quot;\`</span>   <span class="token comment">// CPU配额</span></span>
<span class="line">    Period  <span class="token builtin">uint64</span>  <span class="token string">\`json:&quot;period,omitempty&quot;\`</span>  <span class="token comment">// CPU周期</span></span>
<span class="line">    Cpus    <span class="token builtin">string</span>  <span class="token string">\`json:&quot;cpus,omitempty&quot;\`</span>    <span class="token comment">// CPU核心</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// NamespaceConfig 命名空间配置</span></span>
<span class="line"><span class="token keyword">type</span> NamespaceConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Type <span class="token builtin">string</span> <span class="token string">\`json:&quot;type&quot;\`</span></span>
<span class="line">    Path <span class="token builtin">string</span> <span class="token string">\`json:&quot;path,omitempty&quot;\`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Mount 挂载配置</span></span>
<span class="line"><span class="token keyword">type</span> Mount <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Source      <span class="token builtin">string</span>   <span class="token string">\`json:&quot;source&quot;\`</span></span>
<span class="line">    Destination <span class="token builtin">string</span>   <span class="token string">\`json:&quot;destination&quot;\`</span></span>
<span class="line">    Type        <span class="token builtin">string</span>   <span class="token string">\`json:&quot;type&quot;\`</span></span>
<span class="line">    Options     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">\`json:&quot;options&quot;\`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-容器运行时实现" tabindex="-1"><a class="header-anchor" href="#_3-容器运行时实现"><span>3. 容器运行时实现</span></a></h2><h3 id="_3-1-主程序入口" tabindex="-1"><a class="header-anchor" href="#_3-1-主程序入口"><span>3.1 主程序入口</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// main.go</span></span>
<span class="line"><span class="token keyword">package</span> main</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;fmt&quot;</span></span>
<span class="line">    <span class="token string">&quot;os&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token string">&quot;github.com/urfave/cli/v2&quot;</span></span>
<span class="line">    <span class="token string">&quot;minirunc/cmd&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    app <span class="token operator">:=</span> <span class="token operator">&amp;</span>cli<span class="token punctuation">.</span>App<span class="token punctuation">{</span></span>
<span class="line">        Name<span class="token punctuation">:</span>    <span class="token string">&quot;minirunc&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        Usage<span class="token punctuation">:</span>   <span class="token string">&quot;A minimal container runtime&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        Version<span class="token punctuation">:</span> <span class="token string">&quot;0.1.0&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        Commands<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>cli<span class="token punctuation">.</span>Command<span class="token punctuation">{</span></span>
<span class="line">            cmd<span class="token punctuation">.</span>RunCommand<span class="token punctuation">,</span></span>
<span class="line">            cmd<span class="token punctuation">.</span>ExecCommand<span class="token punctuation">,</span></span>
<span class="line">            cmd<span class="token punctuation">.</span>PsCommand<span class="token punctuation">,</span></span>
<span class="line">            cmd<span class="token punctuation">.</span>KillCommand<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">&quot;Error: %v\\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-run命令实现" tabindex="-1"><a class="header-anchor" href="#_3-2-run命令实现"><span>3.2 Run命令实现</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// cmd/run.go</span></span>
<span class="line"><span class="token keyword">package</span> cmd</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;encoding/json&quot;</span></span>
<span class="line">    <span class="token string">&quot;fmt&quot;</span></span>
<span class="line">    <span class="token string">&quot;os&quot;</span></span>
<span class="line">    <span class="token string">&quot;os/exec&quot;</span></span>
<span class="line">    <span class="token string">&quot;path/filepath&quot;</span></span>
<span class="line">    <span class="token string">&quot;syscall&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token string">&quot;github.com/urfave/cli/v2&quot;</span></span>
<span class="line">    <span class="token string">&quot;minirunc/container&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span> RunCommand <span class="token operator">=</span> <span class="token operator">&amp;</span>cli<span class="token punctuation">.</span>Command<span class="token punctuation">{</span></span>
<span class="line">    Name<span class="token punctuation">:</span>  <span class="token string">&quot;run&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    Usage<span class="token punctuation">:</span> <span class="token string">&quot;Create and run a container&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    Flags<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>cli<span class="token punctuation">.</span>Flag<span class="token punctuation">{</span></span>
<span class="line">        <span class="token operator">&amp;</span>cli<span class="token punctuation">.</span>StringFlag<span class="token punctuation">{</span></span>
<span class="line">            Name<span class="token punctuation">:</span>  <span class="token string">&quot;bundle&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            Value<span class="token punctuation">:</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            Usage<span class="token punctuation">:</span> <span class="token string">&quot;path to the bundle directory&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token operator">&amp;</span>cli<span class="token punctuation">.</span>BoolFlag<span class="token punctuation">{</span></span>
<span class="line">            Name<span class="token punctuation">:</span>  <span class="token string">&quot;detach&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            Usage<span class="token punctuation">:</span> <span class="token string">&quot;run container in background&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    Action<span class="token punctuation">:</span> runAction<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">runAction</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>cli<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> ctx<span class="token punctuation">.</span><span class="token function">NArg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;container id is required&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    containerID <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">    bundle <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">&quot;bundle&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 1. 加载配置</span></span>
<span class="line">    configPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>bundle<span class="token punctuation">,</span> <span class="token string">&quot;config.json&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    config<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">loadConfig</span><span class="token punctuation">(</span>configPath<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to load config: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 创建容器</span></span>
<span class="line">    c <span class="token operator">:=</span> <span class="token operator">&amp;</span>container<span class="token punctuation">.</span>Container<span class="token punctuation">{</span></span>
<span class="line">        ID<span class="token punctuation">:</span>         containerID<span class="token punctuation">,</span></span>
<span class="line">        Config<span class="token punctuation">:</span>     config<span class="token punctuation">,</span></span>
<span class="line">        RootPath<span class="token punctuation">:</span>   bundle<span class="token punctuation">,</span></span>
<span class="line">        ConfigPath<span class="token punctuation">:</span> configPath<span class="token punctuation">,</span></span>
<span class="line">        State<span class="token punctuation">:</span>      container<span class="token punctuation">.</span>StateCreated<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 判断是否是init进程</span></span>
<span class="line">    <span class="token keyword">if</span> os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&quot;/proc/self/exe&quot;</span> <span class="token operator">&amp;&amp;</span> os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&quot;init&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 这是容器内的init进程</span></span>
<span class="line">        <span class="token keyword">return</span> container<span class="token punctuation">.</span><span class="token function">RunInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. 创建新进程运行容器</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">runContainer</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span><span class="token string">&quot;detach&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">runContainer</span><span class="token punctuation">(</span>c <span class="token operator">*</span>container<span class="token punctuation">.</span>Container<span class="token punctuation">,</span> detach <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 准备命令</span></span>
<span class="line">    cmd <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span><span class="token string">&quot;/proc/self/exe&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;init&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置进程属性</span></span>
<span class="line">    cmd<span class="token punctuation">.</span>SysProcAttr <span class="token operator">=</span> <span class="token operator">&amp;</span>syscall<span class="token punctuation">.</span>SysProcAttr<span class="token punctuation">{</span></span>
<span class="line">        Cloneflags<span class="token punctuation">:</span> syscall<span class="token punctuation">.</span>CLONE_NEWUTS <span class="token operator">|</span></span>
<span class="line">                   syscall<span class="token punctuation">.</span>CLONE_NEWPID <span class="token operator">|</span></span>
<span class="line">                   syscall<span class="token punctuation">.</span>CLONE_NEWNS <span class="token operator">|</span></span>
<span class="line">                   syscall<span class="token punctuation">.</span>CLONE_NEWNET <span class="token operator">|</span></span>
<span class="line">                   syscall<span class="token punctuation">.</span>CLONE_NEWIPC<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置用户映射(如果需要)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">needsUserNamespace</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        cmd<span class="token punctuation">.</span>SysProcAttr<span class="token punctuation">.</span>Cloneflags <span class="token operator">|=</span> syscall<span class="token punctuation">.</span>CLONE_NEWUSER</span>
<span class="line">        cmd<span class="token punctuation">.</span>SysProcAttr<span class="token punctuation">.</span>UidMappings <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>syscall<span class="token punctuation">.</span>SysProcIDMap<span class="token punctuation">{</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                ContainerID<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">                HostID<span class="token punctuation">:</span>      os<span class="token punctuation">.</span><span class="token function">Getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                Size<span class="token punctuation">:</span>        <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        cmd<span class="token punctuation">.</span>SysProcAttr<span class="token punctuation">.</span>GidMappings <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>syscall<span class="token punctuation">.</span>SysProcIDMap<span class="token punctuation">{</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                ContainerID<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">                HostID<span class="token punctuation">:</span>      os<span class="token punctuation">.</span><span class="token function">Getgid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                Size<span class="token punctuation">:</span>        <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 创建管道传递配置</span></span>
<span class="line">    r<span class="token punctuation">,</span> w<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Pipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    cmd<span class="token punctuation">.</span>ExtraFiles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>os<span class="token punctuation">.</span>File<span class="token punctuation">{</span>r<span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置标准输入输出</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span>detach <span class="token punctuation">{</span></span>
<span class="line">        cmd<span class="token punctuation">.</span>Stdin <span class="token operator">=</span> os<span class="token punctuation">.</span>Stdin</span>
<span class="line">        cmd<span class="token punctuation">.</span>Stdout <span class="token operator">=</span> os<span class="token punctuation">.</span>Stdout</span>
<span class="line">        cmd<span class="token punctuation">.</span>Stderr <span class="token operator">=</span> os<span class="token punctuation">.</span>Stderr</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 启动进程</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to start container: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 发送配置给init进程</span></span>
<span class="line">    encoder <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> encoder<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Config<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    w<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 记录容器PID</span></span>
<span class="line">    c<span class="token punctuation">.</span>Pid <span class="token operator">=</span> cmd<span class="token punctuation">.</span>Process<span class="token punctuation">.</span>Pid</span>
<span class="line">    c<span class="token punctuation">.</span>State <span class="token operator">=</span> container<span class="token punctuation">.</span>StateRunning</span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置cgroups</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setupCgroups</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to setup cgroups: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 等待进程退出(如果不是后台运行)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span>detach <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;container exited with error: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-init进程实现" tabindex="-1"><a class="header-anchor" href="#_3-3-init进程实现"><span>3.3 Init进程实现</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// container/init.go</span></span>
<span class="line"><span class="token keyword">package</span> container</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;encoding/json&quot;</span></span>
<span class="line">    <span class="token string">&quot;fmt&quot;</span></span>
<span class="line">    <span class="token string">&quot;os&quot;</span></span>
<span class="line">    <span class="token string">&quot;path/filepath&quot;</span></span>
<span class="line">    <span class="token string">&quot;syscall&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// RunInit 容器init进程入口</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">RunInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 从管道读取配置</span></span>
<span class="line">    configFile <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">NewFile</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;config&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    decoder <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>configFile<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">var</span> config ContainerConfig</span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> decoder<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to decode config: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    configFile<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置主机名</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Sethostname</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Hostname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set hostname: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 准备根文件系统</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setupRootfs</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to setup rootfs: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置环境变量</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> env <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Env <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Setenv</span><span class="token punctuation">(</span>env<span class="token punctuation">[</span><span class="token punctuation">:</span>strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">&quot;=&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> </span>
<span class="line">            env<span class="token punctuation">[</span>strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">&quot;=&quot;</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 切换工作目录</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>WorkingDir <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Chdir</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>WorkingDir<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置能力</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setupCapabilities</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Capabilities<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to setup capabilities: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 执行用户命令</span></span>
<span class="line">    path<span class="token punctuation">,</span> err <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">LookPath</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Cmd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;command not found: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> syscall<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> config<span class="token punctuation">.</span>Cmd<span class="token punctuation">,</span> os<span class="token punctuation">.</span><span class="token function">Environ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// setupRootfs 设置根文件系统</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setupRootfs</span><span class="token punctuation">(</span>config <span class="token operator">*</span>ContainerConfig<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 挂载/proc</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mountProc</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Rootfs<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 挂载/dev</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mountDev</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Rootfs<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 挂载/sys</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mountSys</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Rootfs<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 处理用户定义的挂载</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> mount <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Mounts <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">doMount</span><span class="token punctuation">(</span>mount<span class="token punctuation">,</span> config<span class="token punctuation">.</span>Rootfs<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to mount %s: %v&quot;</span><span class="token punctuation">,</span> mount<span class="token punctuation">.</span>Destination<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 切换根文件系统</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">pivotRoot</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Rootfs<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to pivot root: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// pivotRoot 切换根文件系统</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">pivotRoot</span><span class="token punctuation">(</span>newroot <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 为put_old创建临时目录</span></span>
<span class="line">    putold <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>newroot<span class="token punctuation">,</span> <span class="token string">&quot;.pivot_root&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>putold<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 调用pivot_root</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">PivotRoot</span><span class="token punctuation">(</span>newroot<span class="token punctuation">,</span> putold<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 切换当前工作目录到新根</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Chdir</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 卸载put_old</span></span>
<span class="line">    putold <span class="token operator">=</span> <span class="token string">&quot;/.pivot_root&quot;</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Unmount</span><span class="token punctuation">(</span>putold<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>MNT_DETACH<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 删除临时目录</span></span>
<span class="line">    <span class="token keyword">return</span> os<span class="token punctuation">.</span><span class="token function">RemoveAll</span><span class="token punctuation">(</span>putold<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-命名空间管理" tabindex="-1"><a class="header-anchor" href="#_4-命名空间管理"><span>4. 命名空间管理</span></a></h2><h3 id="_4-1-命名空间管理器" tabindex="-1"><a class="header-anchor" href="#_4-1-命名空间管理器"><span>4.1 命名空间管理器</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// namespace/namespace.go</span></span>
<span class="line"><span class="token keyword">package</span> namespace</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;fmt&quot;</span></span>
<span class="line">    <span class="token string">&quot;os&quot;</span></span>
<span class="line">    <span class="token string">&quot;path/filepath&quot;</span></span>
<span class="line">    <span class="token string">&quot;syscall&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// NamespaceType 命名空间类型</span></span>
<span class="line"><span class="token keyword">type</span> NamespaceType <span class="token builtin">string</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">(</span></span>
<span class="line">    NEWNET  NamespaceType <span class="token operator">=</span> <span class="token string">&quot;net&quot;</span></span>
<span class="line">    NEWUTS  NamespaceType <span class="token operator">=</span> <span class="token string">&quot;uts&quot;</span></span>
<span class="line">    NEWIPC  NamespaceType <span class="token operator">=</span> <span class="token string">&quot;ipc&quot;</span></span>
<span class="line">    NEWPID  NamespaceType <span class="token operator">=</span> <span class="token string">&quot;pid&quot;</span></span>
<span class="line">    NEWNS   NamespaceType <span class="token operator">=</span> <span class="token string">&quot;mnt&quot;</span></span>
<span class="line">    NEWUSER NamespaceType <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span></span>
<span class="line">    NEWCGROUP NamespaceType <span class="token operator">=</span> <span class="token string">&quot;cgroup&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// NamespaceManager 命名空间管理器</span></span>
<span class="line"><span class="token keyword">type</span> NamespaceManager <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    pid <span class="token builtin">int</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// NewNamespaceManager 创建命名空间管理器</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewNamespaceManager</span><span class="token punctuation">(</span>pid <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>NamespaceManager <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>NamespaceManager<span class="token punctuation">{</span>pid<span class="token punctuation">:</span> pid<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Enter 进入指定命名空间</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>nm <span class="token operator">*</span>NamespaceManager<span class="token punctuation">)</span> <span class="token function">Enter</span><span class="token punctuation">(</span>nsType NamespaceType<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    nsPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">&quot;/proc&quot;</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%d&quot;</span><span class="token punctuation">,</span> nm<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;ns&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>nsType<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 打开命名空间文件</span></span>
<span class="line">    fd<span class="token punctuation">,</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>nsPath<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>O_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to open namespace %s: %v&quot;</span><span class="token punctuation">,</span> nsType<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> syscall<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 进入命名空间</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Setns</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to enter namespace %s: %v&quot;</span><span class="token punctuation">,</span> nsType<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Create 创建新的命名空间</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>nm <span class="token operator">*</span>NamespaceManager<span class="token punctuation">)</span> <span class="token function">Create</span><span class="token punctuation">(</span>nsTypes <span class="token punctuation">[</span><span class="token punctuation">]</span>NamespaceType<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> cloneFlags <span class="token builtin">uintptr</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> nsType <span class="token operator">:=</span> <span class="token keyword">range</span> nsTypes <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">switch</span> nsType <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">case</span> NEWNET<span class="token punctuation">:</span></span>
<span class="line">            cloneFlags <span class="token operator">|=</span> syscall<span class="token punctuation">.</span>CLONE_NEWNET</span>
<span class="line">        <span class="token keyword">case</span> NEWUTS<span class="token punctuation">:</span></span>
<span class="line">            cloneFlags <span class="token operator">|=</span> syscall<span class="token punctuation">.</span>CLONE_NEWUTS</span>
<span class="line">        <span class="token keyword">case</span> NEWIPC<span class="token punctuation">:</span></span>
<span class="line">            cloneFlags <span class="token operator">|=</span> syscall<span class="token punctuation">.</span>CLONE_NEWIPC</span>
<span class="line">        <span class="token keyword">case</span> NEWPID<span class="token punctuation">:</span></span>
<span class="line">            cloneFlags <span class="token operator">|=</span> syscall<span class="token punctuation">.</span>CLONE_NEWPID</span>
<span class="line">        <span class="token keyword">case</span> NEWNS<span class="token punctuation">:</span></span>
<span class="line">            cloneFlags <span class="token operator">|=</span> syscall<span class="token punctuation">.</span>CLONE_NEWNS</span>
<span class="line">        <span class="token keyword">case</span> NEWUSER<span class="token punctuation">:</span></span>
<span class="line">            cloneFlags <span class="token operator">|=</span> syscall<span class="token punctuation">.</span>CLONE_NEWUSER</span>
<span class="line">        <span class="token keyword">case</span> NEWCGROUP<span class="token punctuation">:</span></span>
<span class="line">            cloneFlags <span class="token operator">|=</span> <span class="token number">0x02000000</span> <span class="token comment">// CLONE_NEWCGROUP</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 使用unshare创建新命名空间</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Unshare</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>cloneFlags<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to unshare namespaces: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-网络命名空间" tabindex="-1"><a class="header-anchor" href="#_4-2-网络命名空间"><span>4.2 网络命名空间</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// namespace/network.go</span></span>
<span class="line"><span class="token keyword">package</span> namespace</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;fmt&quot;</span></span>
<span class="line">    <span class="token string">&quot;net&quot;</span></span>
<span class="line">    <span class="token string">&quot;github.com/vishvananda/netlink&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// NetworkNamespace 网络命名空间管理</span></span>
<span class="line"><span class="token keyword">type</span> NetworkNamespace <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    name <span class="token builtin">string</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// CreateVethPair 创建veth设备对</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>nn <span class="token operator">*</span>NetworkNamespace<span class="token punctuation">)</span> <span class="token function">CreateVethPair</span><span class="token punctuation">(</span>hostName<span class="token punctuation">,</span> containerName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 创建veth对</span></span>
<span class="line">    veth <span class="token operator">:=</span> <span class="token operator">&amp;</span>netlink<span class="token punctuation">.</span>Veth<span class="token punctuation">{</span></span>
<span class="line">        LinkAttrs<span class="token punctuation">:</span> netlink<span class="token punctuation">.</span>LinkAttrs<span class="token punctuation">{</span></span>
<span class="line">            Name<span class="token punctuation">:</span> hostName<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        PeerName<span class="token punctuation">:</span> containerName<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">LinkAdd</span><span class="token punctuation">(</span>veth<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to create veth pair: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 启动主机端接口</span></span>
<span class="line">    hostVeth<span class="token punctuation">,</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">LinkByName</span><span class="token punctuation">(</span>hostName<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">LinkSetUp</span><span class="token punctuation">(</span>hostVeth<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set up host veth: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// MoveVethToNamespace 将veth设备移动到容器命名空间</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>nn <span class="token operator">*</span>NetworkNamespace<span class="token punctuation">)</span> <span class="token function">MoveVethToNamespace</span><span class="token punctuation">(</span>vethName <span class="token builtin">string</span><span class="token punctuation">,</span> pid <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    veth<span class="token punctuation">,</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">LinkByName</span><span class="token punctuation">(</span>vethName<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 移动到目标命名空间</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">LinkSetNsPid</span><span class="token punctuation">(</span>veth<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to move veth to namespace: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ConfigureContainerNetwork 配置容器网络</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>nn <span class="token operator">*</span>NetworkNamespace<span class="token punctuation">)</span> <span class="token function">ConfigureContainerNetwork</span><span class="token punctuation">(</span>vethName<span class="token punctuation">,</span> ipAddr <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 获取veth设备</span></span>
<span class="line">    veth<span class="token punctuation">,</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">LinkByName</span><span class="token punctuation">(</span>vethName<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 配置IP地址</span></span>
<span class="line">    addr<span class="token punctuation">,</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">ParseAddr</span><span class="token punctuation">(</span>ipAddr<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">AddrAdd</span><span class="token punctuation">(</span>veth<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to add IP address: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 启动接口</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">LinkSetUp</span><span class="token punctuation">(</span>veth<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set up container veth: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 配置lo接口</span></span>
<span class="line">    lo<span class="token punctuation">,</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">LinkByName</span><span class="token punctuation">(</span><span class="token string">&quot;lo&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        netlink<span class="token punctuation">.</span><span class="token function">LinkSetUp</span><span class="token punctuation">(</span>lo<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-cgroups资源管理" tabindex="-1"><a class="header-anchor" href="#_5-cgroups资源管理"><span>5. Cgroups资源管理</span></a></h2><h3 id="_5-1-cgroups管理器" tabindex="-1"><a class="header-anchor" href="#_5-1-cgroups管理器"><span>5.1 Cgroups管理器</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// cgroups/manager.go</span></span>
<span class="line"><span class="token keyword">package</span> cgroups</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;fmt&quot;</span></span>
<span class="line">    <span class="token string">&quot;io/ioutil&quot;</span></span>
<span class="line">    <span class="token string">&quot;os&quot;</span></span>
<span class="line">    <span class="token string">&quot;path/filepath&quot;</span></span>
<span class="line">    <span class="token string">&quot;strconv&quot;</span></span>
<span class="line">    <span class="token string">&quot;strings&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// CgroupManager cgroups管理器</span></span>
<span class="line"><span class="token keyword">type</span> CgroupManager <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    containerID <span class="token builtin">string</span></span>
<span class="line">    cgroupPath  <span class="token builtin">string</span></span>
<span class="line">    subsystems  <span class="token punctuation">[</span><span class="token punctuation">]</span>Subsystem</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Subsystem cgroup子系统接口</span></span>
<span class="line"><span class="token keyword">type</span> Subsystem <span class="token keyword">interface</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span></span>
<span class="line">    <span class="token function">Set</span><span class="token punctuation">(</span>cgroupPath <span class="token builtin">string</span><span class="token punctuation">,</span> res <span class="token operator">*</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span></span>
<span class="line">    <span class="token function">Apply</span><span class="token punctuation">(</span>cgroupPath <span class="token builtin">string</span><span class="token punctuation">,</span> pid <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span></span>
<span class="line">    <span class="token function">Remove</span><span class="token punctuation">(</span>cgroupPath <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// NewCgroupManager 创建cgroup管理器</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewCgroupManager</span><span class="token punctuation">(</span>containerID <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>CgroupManager <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>CgroupManager<span class="token punctuation">{</span></span>
<span class="line">        containerID<span class="token punctuation">:</span> containerID<span class="token punctuation">,</span></span>
<span class="line">        cgroupPath<span class="token punctuation">:</span>  filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">&quot;/sys/fs/cgroup&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;minirunc&quot;</span><span class="token punctuation">,</span> containerID<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        subsystems<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Subsystem<span class="token punctuation">{</span></span>
<span class="line">            <span class="token operator">&amp;</span>MemorySubsystem<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token operator">&amp;</span>CPUSubsystem<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token operator">&amp;</span>CpusetSubsystem<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Set 设置资源限制</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>CgroupManager<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>res <span class="token operator">*</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> subsystem <span class="token operator">:=</span> <span class="token keyword">range</span> m<span class="token punctuation">.</span>subsystems <span class="token punctuation">{</span></span>
<span class="line">        subsysPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>cgroupPath<span class="token punctuation">,</span> subsystem<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 创建cgroup目录</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>subsysPath<span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 设置资源限制</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> subsystem<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>subsysPath<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set %s: %v&quot;</span><span class="token punctuation">,</span> subsystem<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Apply 将进程加入cgroup</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>CgroupManager<span class="token punctuation">)</span> <span class="token function">Apply</span><span class="token punctuation">(</span>pid <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> subsystem <span class="token operator">:=</span> <span class="token keyword">range</span> m<span class="token punctuation">.</span>subsystems <span class="token punctuation">{</span></span>
<span class="line">        subsysPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>cgroupPath<span class="token punctuation">,</span> subsystem<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> subsystem<span class="token punctuation">.</span><span class="token function">Apply</span><span class="token punctuation">(</span>subsysPath<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to apply %s: %v&quot;</span><span class="token punctuation">,</span> subsystem<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Destroy 销毁cgroup</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>CgroupManager<span class="token punctuation">)</span> <span class="token function">Destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> subsystem <span class="token operator">:=</span> <span class="token keyword">range</span> m<span class="token punctuation">.</span>subsystems <span class="token punctuation">{</span></span>
<span class="line">        subsysPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>cgroupPath<span class="token punctuation">,</span> subsystem<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> subsystem<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>subsysPath<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> os<span class="token punctuation">.</span><span class="token function">RemoveAll</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>cgroupPath<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-内存子系统" tabindex="-1"><a class="header-anchor" href="#_5-2-内存子系统"><span>5.2 内存子系统</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// cgroups/memory.go</span></span>
<span class="line"><span class="token keyword">package</span> cgroups</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;fmt&quot;</span></span>
<span class="line">    <span class="token string">&quot;io/ioutil&quot;</span></span>
<span class="line">    <span class="token string">&quot;path/filepath&quot;</span></span>
<span class="line">    <span class="token string">&quot;strconv&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// MemorySubsystem 内存子系统</span></span>
<span class="line"><span class="token keyword">type</span> MemorySubsystem <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>MemorySubsystem<span class="token punctuation">)</span> <span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token string">&quot;memory&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>MemorySubsystem<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>cgroupPath <span class="token builtin">string</span><span class="token punctuation">,</span> res <span class="token operator">*</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> res<span class="token punctuation">.</span>Memory <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置内存限制</span></span>
<span class="line">    <span class="token keyword">if</span> res<span class="token punctuation">.</span>Memory<span class="token punctuation">.</span>Limit <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        limitFile <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>cgroupPath<span class="token punctuation">,</span> <span class="token string">&quot;memory.limit_in_bytes&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>limitFile<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>strconv<span class="token punctuation">.</span><span class="token function">FormatInt</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>Memory<span class="token punctuation">.</span>Limit<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set memory limit: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置swap限制</span></span>
<span class="line">    <span class="token keyword">if</span> res<span class="token punctuation">.</span>Memory<span class="token punctuation">.</span>Swap <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        swapFile <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>cgroupPath<span class="token punctuation">,</span> <span class="token string">&quot;memory.memsw.limit_in_bytes&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>swapFile<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>strconv<span class="token punctuation">.</span><span class="token function">FormatInt</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>Memory<span class="token punctuation">.</span>Swap<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set swap limit: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置OOM控制</span></span>
<span class="line">    oomControlFile <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>cgroupPath<span class="token punctuation">,</span> <span class="token string">&quot;memory.oom_control&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>oomControlFile<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set oom control: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>MemorySubsystem<span class="token punctuation">)</span> <span class="token function">Apply</span><span class="token punctuation">(</span>cgroupPath <span class="token builtin">string</span><span class="token punctuation">,</span> pid <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    procsFile <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>cgroupPath<span class="token punctuation">,</span> <span class="token string">&quot;cgroup.procs&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>procsFile<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>MemorySubsystem<span class="token punctuation">)</span> <span class="token function">Remove</span><span class="token punctuation">(</span>cgroupPath <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> os<span class="token punctuation">.</span><span class="token function">RemoveAll</span><span class="token punctuation">(</span>cgroupPath<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// GetMemoryStats 获取内存统计</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>MemorySubsystem<span class="token punctuation">)</span> <span class="token function">GetMemoryStats</span><span class="token punctuation">(</span>cgroupPath <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>MemoryStats<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    stats <span class="token operator">:=</span> <span class="token operator">&amp;</span>MemoryStats<span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 读取当前使用量</span></span>
<span class="line">    usageFile <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>cgroupPath<span class="token punctuation">,</span> <span class="token string">&quot;memory.usage_in_bytes&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    usage<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>usageFile<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    stats<span class="token punctuation">.</span>Usage<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseUint</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>usage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 读取最大使用量</span></span>
<span class="line">    maxUsageFile <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>cgroupPath<span class="token punctuation">,</span> <span class="token string">&quot;memory.max_usage_in_bytes&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    maxUsage<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>maxUsageFile<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    stats<span class="token punctuation">.</span>MaxUsage<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseUint</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>maxUsage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 读取限制</span></span>
<span class="line">    limitFile <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>cgroupPath<span class="token punctuation">,</span> <span class="token string">&quot;memory.limit_in_bytes&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    limit<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>limitFile<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    stats<span class="token punctuation">.</span>Limit<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseUint</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> stats<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-cpu子系统" tabindex="-1"><a class="header-anchor" href="#_5-3-cpu子系统"><span>5.3 CPU子系统</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// cgroups/cpu.go</span></span>
<span class="line"><span class="token keyword">package</span> cgroups</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;fmt&quot;</span></span>
<span class="line">    <span class="token string">&quot;io/ioutil&quot;</span></span>
<span class="line">    <span class="token string">&quot;path/filepath&quot;</span></span>
<span class="line">    <span class="token string">&quot;strconv&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// CPUSubsystem CPU子系统</span></span>
<span class="line"><span class="token keyword">type</span> CPUSubsystem <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>CPUSubsystem<span class="token punctuation">)</span> <span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token string">&quot;cpu&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>CPUSubsystem<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>cgroupPath <span class="token builtin">string</span><span class="token punctuation">,</span> res <span class="token operator">*</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> res<span class="token punctuation">.</span>CPU <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置CPU份额</span></span>
<span class="line">    <span class="token keyword">if</span> res<span class="token punctuation">.</span>CPU<span class="token punctuation">.</span>Shares <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        sharesFile <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>cgroupPath<span class="token punctuation">,</span> <span class="token string">&quot;cpu.shares&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>sharesFile<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>strconv<span class="token punctuation">.</span><span class="token function">FormatUint</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>CPU<span class="token punctuation">.</span>Shares<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set cpu shares: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置CPU配额</span></span>
<span class="line">    <span class="token keyword">if</span> res<span class="token punctuation">.</span>CPU<span class="token punctuation">.</span>Quota <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        quotaFile <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>cgroupPath<span class="token punctuation">,</span> <span class="token string">&quot;cpu.cfs_quota_us&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>quotaFile<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>strconv<span class="token punctuation">.</span><span class="token function">FormatInt</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>CPU<span class="token punctuation">.</span>Quota<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set cpu quota: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置CPU周期</span></span>
<span class="line">    <span class="token keyword">if</span> res<span class="token punctuation">.</span>CPU<span class="token punctuation">.</span>Period <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        periodFile <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>cgroupPath<span class="token punctuation">,</span> <span class="token string">&quot;cpu.cfs_period_us&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>periodFile<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>strconv<span class="token punctuation">.</span><span class="token function">FormatUint</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>CPU<span class="token punctuation">.</span>Period<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set cpu period: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>CPUSubsystem<span class="token punctuation">)</span> <span class="token function">Apply</span><span class="token punctuation">(</span>cgroupPath <span class="token builtin">string</span><span class="token punctuation">,</span> pid <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    procsFile <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>cgroupPath<span class="token punctuation">,</span> <span class="token string">&quot;cgroup.procs&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>procsFile<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>CPUSubsystem<span class="token punctuation">)</span> <span class="token function">Remove</span><span class="token punctuation">(</span>cgroupPath <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> os<span class="token punctuation">.</span><span class="token function">RemoveAll</span><span class="token punctuation">(</span>cgroupPath<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-文件系统管理" tabindex="-1"><a class="header-anchor" href="#_6-文件系统管理"><span>6. 文件系统管理</span></a></h2><h3 id="_6-1-rootfs管理" tabindex="-1"><a class="header-anchor" href="#_6-1-rootfs管理"><span>6.1 Rootfs管理</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// rootfs/rootfs.go</span></span>
<span class="line"><span class="token keyword">package</span> rootfs</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;fmt&quot;</span></span>
<span class="line">    <span class="token string">&quot;os&quot;</span></span>
<span class="line">    <span class="token string">&quot;path/filepath&quot;</span></span>
<span class="line">    <span class="token string">&quot;syscall&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// RootfsManager rootfs管理器</span></span>
<span class="line"><span class="token keyword">type</span> RootfsManager <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    rootPath <span class="token builtin">string</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// NewRootfsManager 创建rootfs管理器</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewRootfsManager</span><span class="token punctuation">(</span>rootPath <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>RootfsManager <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>RootfsManager<span class="token punctuation">{</span></span>
<span class="line">        rootPath<span class="token punctuation">:</span> rootPath<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// PrepareRootfs 准备根文件系统</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>rm <span class="token operator">*</span>RootfsManager<span class="token punctuation">)</span> <span class="token function">PrepareRootfs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 绑定挂载rootfs</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Mount</span><span class="token punctuation">(</span>rm<span class="token punctuation">.</span>rootPath<span class="token punctuation">,</span> rm<span class="token punctuation">.</span>rootPath<span class="token punctuation">,</span> <span class="token string">&quot;bind&quot;</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>MS_BIND<span class="token operator">|</span>syscall<span class="token punctuation">.</span>MS_REC<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to bind mount rootfs: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置为私有挂载</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Mount</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> rm<span class="token punctuation">.</span>rootPath<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>MS_PRIVATE<span class="token operator">|</span>syscall<span class="token punctuation">.</span>MS_REC<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to make rootfs private: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// MountSpecialFilesystems 挂载特殊文件系统</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>rm <span class="token operator">*</span>RootfsManager<span class="token punctuation">)</span> <span class="token function">MountSpecialFilesystems</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 挂载/proc</span></span>
<span class="line">    procPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>rm<span class="token punctuation">.</span>rootPath<span class="token punctuation">,</span> <span class="token string">&quot;proc&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>procPath<span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Mount</span><span class="token punctuation">(</span><span class="token string">&quot;proc&quot;</span><span class="token punctuation">,</span> procPath<span class="token punctuation">,</span> <span class="token string">&quot;proc&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to mount proc: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 挂载/dev</span></span>
<span class="line">    devPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>rm<span class="token punctuation">.</span>rootPath<span class="token punctuation">,</span> <span class="token string">&quot;dev&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>devPath<span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Mount</span><span class="token punctuation">(</span><span class="token string">&quot;tmpfs&quot;</span><span class="token punctuation">,</span> devPath<span class="token punctuation">,</span> <span class="token string">&quot;tmpfs&quot;</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>MS_NOSUID<span class="token operator">|</span>syscall<span class="token punctuation">.</span>MS_STRICTATIME<span class="token punctuation">,</span> <span class="token string">&quot;mode=755&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to mount dev: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 创建必要的设备节点</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> rm<span class="token punctuation">.</span><span class="token function">createDeviceNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 挂载/dev/pts</span></span>
<span class="line">    ptsPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>rm<span class="token punctuation">.</span>rootPath<span class="token punctuation">,</span> <span class="token string">&quot;dev&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pts&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>ptsPath<span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Mount</span><span class="token punctuation">(</span><span class="token string">&quot;devpts&quot;</span><span class="token punctuation">,</span> ptsPath<span class="token punctuation">,</span> <span class="token string">&quot;devpts&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;newinstance,ptmxmode=0666,mode=620&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to mount devpts: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 挂载/dev/shm</span></span>
<span class="line">    shmPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>rm<span class="token punctuation">.</span>rootPath<span class="token punctuation">,</span> <span class="token string">&quot;dev&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;shm&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>shmPath<span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Mount</span><span class="token punctuation">(</span><span class="token string">&quot;tmpfs&quot;</span><span class="token punctuation">,</span> shmPath<span class="token punctuation">,</span> <span class="token string">&quot;tmpfs&quot;</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>MS_NOSUID<span class="token operator">|</span>syscall<span class="token punctuation">.</span>MS_NODEV<span class="token operator">|</span>syscall<span class="token punctuation">.</span>MS_NOEXEC<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to mount shm: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 挂载/sys</span></span>
<span class="line">    sysPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>rm<span class="token punctuation">.</span>rootPath<span class="token punctuation">,</span> <span class="token string">&quot;sys&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>sysPath<span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Mount</span><span class="token punctuation">(</span><span class="token string">&quot;sysfs&quot;</span><span class="token punctuation">,</span> sysPath<span class="token punctuation">,</span> <span class="token string">&quot;sysfs&quot;</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>MS_NOSUID<span class="token operator">|</span>syscall<span class="token punctuation">.</span>MS_NODEV<span class="token operator">|</span>syscall<span class="token punctuation">.</span>MS_NOEXEC<span class="token operator">|</span>syscall<span class="token punctuation">.</span>MS_RDONLY<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to mount sys: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// createDeviceNodes 创建设备节点</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>rm <span class="token operator">*</span>RootfsManager<span class="token punctuation">)</span> <span class="token function">createDeviceNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    devices <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">        path  <span class="token builtin">string</span></span>
<span class="line">        mode  <span class="token builtin">uint32</span></span>
<span class="line">        dev   <span class="token builtin">int</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;/dev/null&quot;</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>S_IFCHR <span class="token operator">|</span> <span class="token number">0666</span><span class="token punctuation">,</span> <span class="token function">makedev</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;/dev/zero&quot;</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>S_IFCHR <span class="token operator">|</span> <span class="token number">0666</span><span class="token punctuation">,</span> <span class="token function">makedev</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;/dev/random&quot;</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>S_IFCHR <span class="token operator">|</span> <span class="token number">0666</span><span class="token punctuation">,</span> <span class="token function">makedev</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;/dev/urandom&quot;</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>S_IFCHR <span class="token operator">|</span> <span class="token number">0666</span><span class="token punctuation">,</span> <span class="token function">makedev</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;/dev/console&quot;</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>S_IFCHR <span class="token operator">|</span> <span class="token number">0600</span><span class="token punctuation">,</span> <span class="token function">makedev</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;/dev/tty&quot;</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>S_IFCHR <span class="token operator">|</span> <span class="token number">0666</span><span class="token punctuation">,</span> <span class="token function">makedev</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;/dev/ptmx&quot;</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>S_IFCHR <span class="token operator">|</span> <span class="token number">0666</span><span class="token punctuation">,</span> <span class="token function">makedev</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> dev <span class="token operator">:=</span> <span class="token keyword">range</span> devices <span class="token punctuation">{</span></span>
<span class="line">        devPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>rm<span class="token punctuation">.</span>rootPath<span class="token punctuation">,</span> dev<span class="token punctuation">.</span>path<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 删除已存在的设备</span></span>
<span class="line">        os<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>devPath<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 创建设备节点</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Mknod</span><span class="token punctuation">(</span>devPath<span class="token punctuation">,</span> dev<span class="token punctuation">.</span>mode<span class="token punctuation">,</span> dev<span class="token punctuation">.</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to create device %s: %v&quot;</span><span class="token punctuation">,</span> dev<span class="token punctuation">.</span>path<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 创建符号链接</span></span>
<span class="line">    links <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&quot;/dev/fd&quot;</span><span class="token punctuation">:</span>     <span class="token string">&quot;/proc/self/fd&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;/dev/stdin&quot;</span><span class="token punctuation">:</span>  <span class="token string">&quot;/proc/self/fd/0&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;/dev/stdout&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;/proc/self/fd/1&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;/dev/stderr&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;/proc/self/fd/2&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> link<span class="token punctuation">,</span> target <span class="token operator">:=</span> <span class="token keyword">range</span> links <span class="token punctuation">{</span></span>
<span class="line">        linkPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>rm<span class="token punctuation">.</span>rootPath<span class="token punctuation">,</span> link<span class="token punctuation">)</span></span>
<span class="line">        os<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>linkPath<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Symlink</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> linkPath<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to create symlink %s: %v&quot;</span><span class="token punctuation">,</span> link<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">makedev</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> minor <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">(</span>major <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> minor</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-安全模块" tabindex="-1"><a class="header-anchor" href="#_7-安全模块"><span>7. 安全模块</span></a></h2><h3 id="_7-1-capabilities管理" tabindex="-1"><a class="header-anchor" href="#_7-1-capabilities管理"><span>7.1 Capabilities管理</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// security/capabilities.go</span></span>
<span class="line"><span class="token keyword">package</span> security</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;fmt&quot;</span></span>
<span class="line">    <span class="token string">&quot;syscall&quot;</span></span>
<span class="line">    <span class="token string">&quot;unsafe&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Capability Linux能力</span></span>
<span class="line"><span class="token keyword">type</span> Capability <span class="token builtin">int</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">(</span></span>
<span class="line">    CAP_CHOWN Capability <span class="token operator">=</span> <span class="token boolean">iota</span></span>
<span class="line">    CAP_DAC_OVERRIDE</span>
<span class="line">    CAP_DAC_READ_SEARCH</span>
<span class="line">    CAP_FOWNER</span>
<span class="line">    CAP_FSETID</span>
<span class="line">    CAP_KILL</span>
<span class="line">    CAP_SETGID</span>
<span class="line">    CAP_SETUID</span>
<span class="line">    CAP_SETPCAP</span>
<span class="line">    CAP_NET_BIND_SERVICE</span>
<span class="line">    CAP_NET_RAW</span>
<span class="line">    CAP_SYS_CHROOT</span>
<span class="line">    CAP_MKNOD</span>
<span class="line">    CAP_AUDIT_WRITE</span>
<span class="line">    CAP_SETFCAP</span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// capHeader 能力头结构</span></span>
<span class="line"><span class="token keyword">type</span> capHeader <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    version <span class="token builtin">uint32</span></span>
<span class="line">    pid     <span class="token builtin">int32</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// capData 能力数据结构</span></span>
<span class="line"><span class="token keyword">type</span> capData <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    effective   <span class="token builtin">uint32</span></span>
<span class="line">    permitted   <span class="token builtin">uint32</span></span>
<span class="line">    inheritable <span class="token builtin">uint32</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// CapabilityManager 能力管理器</span></span>
<span class="line"><span class="token keyword">type</span> CapabilityManager <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    caps <span class="token punctuation">[</span><span class="token punctuation">]</span>Capability</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// NewCapabilityManager 创建能力管理器</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewCapabilityManager</span><span class="token punctuation">(</span>caps <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>CapabilityManager <span class="token punctuation">{</span></span>
<span class="line">    cm <span class="token operator">:=</span> <span class="token operator">&amp;</span>CapabilityManager<span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 解析能力列表</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token builtin">cap</span> <span class="token operator">:=</span> <span class="token keyword">range</span> caps <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> c<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">parseCapability</span><span class="token punctuation">(</span><span class="token builtin">cap</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span></span>
<span class="line">            cm<span class="token punctuation">.</span>caps <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>cm<span class="token punctuation">.</span>caps<span class="token punctuation">,</span> c<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> cm</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Apply 应用能力设置</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>cm <span class="token operator">*</span>CapabilityManager<span class="token punctuation">)</span> <span class="token function">Apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 获取当前能力</span></span>
<span class="line">    header <span class="token operator">:=</span> <span class="token operator">&amp;</span>capHeader<span class="token punctuation">{</span></span>
<span class="line">        version<span class="token punctuation">:</span> <span class="token number">0x20080522</span><span class="token punctuation">,</span> <span class="token comment">// _LINUX_CAPABILITY_VERSION_3</span></span>
<span class="line">        pid<span class="token punctuation">:</span>     <span class="token number">0</span><span class="token punctuation">,</span>          <span class="token comment">// 当前进程</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">var</span> data <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>capData</span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 获取当前能力</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Syscall</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>SYS_CAPGET<span class="token punctuation">,</span> </span>
<span class="line">        <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;capget failed: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 清空所有能力</span></span>
<span class="line">    data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>effective <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">    data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>permitted <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">    data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>inheritable <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">    data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>effective <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">    data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>permitted <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">    data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>inheritable <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 设置需要的能力</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token builtin">cap</span> <span class="token operator">:=</span> <span class="token keyword">range</span> cm<span class="token punctuation">.</span>caps <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token builtin">cap</span> <span class="token operator">&lt;</span> <span class="token number">32</span> <span class="token punctuation">{</span></span>
<span class="line">            data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>effective <span class="token operator">|=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token function">uint</span><span class="token punctuation">(</span><span class="token builtin">cap</span><span class="token punctuation">)</span></span>
<span class="line">            data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>permitted <span class="token operator">|=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token function">uint</span><span class="token punctuation">(</span><span class="token builtin">cap</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>effective <span class="token operator">|=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token function">uint</span><span class="token punctuation">(</span><span class="token builtin">cap</span><span class="token operator">-</span><span class="token number">32</span><span class="token punctuation">)</span></span>
<span class="line">            data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>permitted <span class="token operator">|=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token function">uint</span><span class="token punctuation">(</span><span class="token builtin">cap</span><span class="token operator">-</span><span class="token number">32</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 应用能力设置</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Syscall</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>SYS_CAPSET<span class="token punctuation">,</span></span>
<span class="line">        <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;capset failed: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// DropAllCapabilities 丢弃所有能力</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">DropAllCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    header <span class="token operator">:=</span> <span class="token operator">&amp;</span>capHeader<span class="token punctuation">{</span></span>
<span class="line">        version<span class="token punctuation">:</span> <span class="token number">0x20080522</span><span class="token punctuation">,</span></span>
<span class="line">        pid<span class="token punctuation">:</span>     <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">var</span> data <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>capData</span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 清空所有能力</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Syscall</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>SYS_CAPSET<span class="token punctuation">,</span></span>
<span class="line">        <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to drop capabilities: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-测试和调试" tabindex="-1"><a class="header-anchor" href="#_8-测试和调试"><span>8. 测试和调试</span></a></h2><h3 id="_8-1-单元测试" tabindex="-1"><a class="header-anchor" href="#_8-1-单元测试"><span>8.1 单元测试</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// container/container_test.go</span></span>
<span class="line"><span class="token keyword">package</span> container</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;testing&quot;</span></span>
<span class="line">    <span class="token string">&quot;os&quot;</span></span>
<span class="line">    <span class="token string">&quot;path/filepath&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">TestCreateContainer</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 准备测试环境</span></span>
<span class="line">    testDir <span class="token operator">:=</span> <span class="token string">&quot;/tmp/minirunc-test&quot;</span></span>
<span class="line">    os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>testDir<span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> os<span class="token punctuation">.</span><span class="token function">RemoveAll</span><span class="token punctuation">(</span>testDir<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 创建测试配置</span></span>
<span class="line">    config <span class="token operator">:=</span> <span class="token operator">&amp;</span>ContainerConfig<span class="token punctuation">{</span></span>
<span class="line">        Hostname<span class="token punctuation">:</span> <span class="token string">&quot;test-container&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        Rootfs<span class="token punctuation">:</span>   filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>testDir<span class="token punctuation">,</span> <span class="token string">&quot;rootfs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        Cmd<span class="token punctuation">:</span>      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        Env<span class="token punctuation">:</span>      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;PATH=/bin:/usr/bin&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 创建容器</span></span>
<span class="line">    c <span class="token operator">:=</span> <span class="token operator">&amp;</span>Container<span class="token punctuation">{</span></span>
<span class="line">        ID<span class="token punctuation">:</span>     <span class="token string">&quot;test-001&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        Config<span class="token punctuation">:</span> config<span class="token punctuation">,</span></span>
<span class="line">        State<span class="token punctuation">:</span>  StateCreated<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 验证容器创建</span></span>
<span class="line">    <span class="token keyword">if</span> c<span class="token punctuation">.</span>ID <span class="token operator">!=</span> <span class="token string">&quot;test-001&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Expected container ID test-001, got %s&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>ID<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> c<span class="token punctuation">.</span>State <span class="token operator">!=</span> StateCreated <span class="token punctuation">{</span></span>
<span class="line">        t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Expected container state Created, got %s&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>State<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">TestNamespaceCreation</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 测试命名空间创建</span></span>
<span class="line">    nm <span class="token operator">:=</span> <span class="token function">NewNamespaceManager</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">Getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 测试创建UTS命名空间</span></span>
<span class="line">    err <span class="token operator">:=</span> nm<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>NamespaceType<span class="token punctuation">{</span>NEWUTS<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> os<span class="token punctuation">.</span><span class="token function">Getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        t<span class="token punctuation">.</span><span class="token function">Skip</span><span class="token punctuation">(</span><span class="token string">&quot;Skipping namespace test: requires root privileges&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create UTS namespace: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-集成测试" tabindex="-1"><a class="header-anchor" href="#_8-2-集成测试"><span>8.2 集成测试</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># test/integration_test.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 构建minirunc</span></span>
<span class="line">go build <span class="token parameter variable">-o</span> minirunc main.go</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 准备测试rootfs</span></span>
<span class="line"><span class="token assign-left variable">TEST_DIR</span><span class="token operator">=</span><span class="token string">&quot;/tmp/minirunc-integration&quot;</span></span>
<span class="line"><span class="token assign-left variable">ROOTFS</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$TEST_DIR</span>/rootfs&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">$ROOTFS</span></span>
<span class="line"><span class="token function">tar</span> <span class="token parameter variable">-xf</span> alpine-rootfs.tar.gz <span class="token parameter variable">-C</span> <span class="token variable">$ROOTFS</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 创建配置文件</span></span>
<span class="line"><span class="token function">cat</span> <span class="token operator">&gt;</span> <span class="token variable">$TEST_DIR</span>/config.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF</span>
<span class="line">{</span>
<span class="line">    &quot;hostname&quot;: &quot;minirunc-test&quot;,</span>
<span class="line">    &quot;rootfs&quot;: &quot;<span class="token variable">$ROOTFS</span>&quot;,</span>
<span class="line">    &quot;cmd&quot;: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;echo &#39;Hello from container&#39; &amp;&amp; exit 0&quot;],</span>
<span class="line">    &quot;env&quot;: [&quot;PATH=/bin:/usr/bin&quot;],</span>
<span class="line">    &quot;namespaces&quot;: [</span>
<span class="line">        {&quot;type&quot;: &quot;pid&quot;},</span>
<span class="line">        {&quot;type&quot;: &quot;net&quot;},</span>
<span class="line">        {&quot;type&quot;: &quot;ipc&quot;},</span>
<span class="line">        {&quot;type&quot;: &quot;uts&quot;},</span>
<span class="line">        {&quot;type&quot;: &quot;mnt&quot;}</span>
<span class="line">    ],</span>
<span class="line">    &quot;resources&quot;: {</span>
<span class="line">        &quot;memory&quot;: {</span>
<span class="line">            &quot;limit&quot;: 134217728</span>
<span class="line">        },</span>
<span class="line">        &quot;cpu&quot;: {</span>
<span class="line">            &quot;shares&quot;: 512</span>
<span class="line">        }</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line">EOF</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 运行容器</span></span>
<span class="line">./minirunc run <span class="token parameter variable">--bundle</span> <span class="token variable">$TEST_DIR</span> test-container</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 清理</span></span>
<span class="line"><span class="token function">rm</span> <span class="token parameter variable">-rf</span> <span class="token variable">$TEST_DIR</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-3-调试技巧" tabindex="-1"><a class="header-anchor" href="#_8-3-调试技巧"><span>8.3 调试技巧</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 调试辅助函数</span></span>
<span class="line"><span class="token keyword">package</span> debug</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;fmt&quot;</span></span>
<span class="line">    <span class="token string">&quot;runtime&quot;</span></span>
<span class="line">    <span class="token string">&quot;strings&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Debug 输出调试信息</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">Debug</span><span class="token punctuation">(</span>format <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">&quot;DEBUG&quot;</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">&quot;1&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 获取调用位置</span></span>
<span class="line">    <span class="token boolean">_</span><span class="token punctuation">,</span> file<span class="token punctuation">,</span> line<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">Caller</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">    file <span class="token operator">=</span> filepath<span class="token punctuation">.</span><span class="token function">Base</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 输出调试信息</span></span>
<span class="line">    prefix <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;[DEBUG %s:%d]&quot;</span><span class="token punctuation">,</span> file<span class="token punctuation">,</span> line<span class="token punctuation">)</span></span>
<span class="line">    msg <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span>format<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span></span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">&quot;%s %s\\n&quot;</span><span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> msg<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// TraceCall 跟踪函数调用</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">TraceCall</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">&quot;Entering %s&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">&quot;Leaving %s&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 使用示例</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">someFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">defer</span> <span class="token function">TraceCall</span><span class="token punctuation">(</span><span class="token string">&quot;someFunction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">&quot;Processing data...&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// 函数逻辑</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-部署和使用" tabindex="-1"><a class="header-anchor" href="#_9-部署和使用"><span>9. 部署和使用</span></a></h2><h3 id="_9-1-编译和安装" tabindex="-1"><a class="header-anchor" href="#_9-1-编译和安装"><span>9.1 编译和安装</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 编译</span></span>
<span class="line">go build <span class="token parameter variable">-o</span> minirunc main.go</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 安装到系统路径</span></span>
<span class="line"><span class="token function">sudo</span> <span class="token function">cp</span> minirunc /usr/local/bin/</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 设置权限</span></span>
<span class="line"><span class="token function">sudo</span> <span class="token function">chmod</span> +x /usr/local/bin/minirunc</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-2-使用示例" tabindex="-1"><a class="header-anchor" href="#_9-2-使用示例"><span>9.2 使用示例</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 1. 准备bundle目录</span></span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /tmp/container/rootfs</span>
<span class="line"><span class="token builtin class-name">cd</span> /tmp/container</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 2. 解压rootfs</span></span>
<span class="line"><span class="token function">tar</span> <span class="token parameter variable">-xf</span> /path/to/alpine-rootfs.tar.gz <span class="token parameter variable">-C</span> rootfs/</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 3. 创建配置文件</span></span>
<span class="line"><span class="token function">cat</span> <span class="token operator">&gt;</span> config.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF</span>
<span class="line">{</span>
<span class="line">    &quot;hostname&quot;: &quot;my-container&quot;,</span>
<span class="line">    &quot;rootfs&quot;: &quot;./rootfs&quot;,</span>
<span class="line">    &quot;cmd&quot;: [&quot;/bin/sh&quot;],</span>
<span class="line">    &quot;env&quot;: [&quot;PATH=/bin:/usr/bin:/sbin:/usr/sbin&quot;],</span>
<span class="line">    &quot;namespaces&quot;: [</span>
<span class="line">        {&quot;type&quot;: &quot;pid&quot;},</span>
<span class="line">        {&quot;type&quot;: &quot;net&quot;},</span>
<span class="line">        {&quot;type&quot;: &quot;ipc&quot;},</span>
<span class="line">        {&quot;type&quot;: &quot;uts&quot;},</span>
<span class="line">        {&quot;type&quot;: &quot;mnt&quot;}</span>
<span class="line">    ],</span>
<span class="line">    &quot;mounts&quot;: [</span>
<span class="line">        {</span>
<span class="line">            &quot;source&quot;: &quot;/etc/resolv.conf&quot;,</span>
<span class="line">            &quot;destination&quot;: &quot;/etc/resolv.conf&quot;,</span>
<span class="line">            &quot;type&quot;: &quot;bind&quot;,</span>
<span class="line">            &quot;options&quot;: [&quot;ro&quot;, &quot;bind&quot;]</span>
<span class="line">        }</span>
<span class="line">    ],</span>
<span class="line">    &quot;resources&quot;: {</span>
<span class="line">        &quot;memory&quot;: {</span>
<span class="line">            &quot;limit&quot;: 268435456</span>
<span class="line">        },</span>
<span class="line">        &quot;cpu&quot;: {</span>
<span class="line">            &quot;shares&quot;: 1024,</span>
<span class="line">            &quot;quota&quot;: 100000,</span>
<span class="line">            &quot;period&quot;: 100000</span>
<span class="line">        }</span>
<span class="line">    },</span>
<span class="line">    &quot;capabilities&quot;: [</span>
<span class="line">        &quot;CAP_CHOWN&quot;,</span>
<span class="line">        &quot;CAP_DAC_OVERRIDE&quot;,</span>
<span class="line">        &quot;CAP_FSETID&quot;,</span>
<span class="line">        &quot;CAP_FOWNER&quot;,</span>
<span class="line">        &quot;CAP_SETGID&quot;,</span>
<span class="line">        &quot;CAP_SETUID&quot;,</span>
<span class="line">        &quot;CAP_SETPCAP&quot;,</span>
<span class="line">        &quot;CAP_NET_BIND_SERVICE&quot;,</span>
<span class="line">        &quot;CAP_SYS_CHROOT&quot;,</span>
<span class="line">        &quot;CAP_KILL&quot;,</span>
<span class="line">        &quot;CAP_AUDIT_WRITE&quot;</span>
<span class="line">    ]</span>
<span class="line">}</span>
<span class="line">EOF</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 4. 运行容器</span></span>
<span class="line"><span class="token function">sudo</span> minirunc run my-container</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 5. 在另一个终端查看容器</span></span>
<span class="line"><span class="token function">sudo</span> minirunc <span class="token function">ps</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 6. 进入容器</span></span>
<span class="line"><span class="token function">sudo</span> minirunc <span class="token builtin class-name">exec</span> my-container /bin/sh</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 7. 停止容器</span></span>
<span class="line"><span class="token function">sudo</span> minirunc <span class="token function">kill</span> my-container</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_10-性能优化" tabindex="-1"><a class="header-anchor" href="#_10-性能优化"><span>10. 性能优化</span></a></h2><h3 id="_10-1-启动时间优化" tabindex="-1"><a class="header-anchor" href="#_10-1-启动时间优化"><span>10.1 启动时间优化</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 并行初始化</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">parallelInit</span><span class="token punctuation">(</span>config <span class="token operator">*</span>ContainerConfig<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    errCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 并行执行初始化任务</span></span>
<span class="line">    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        errCh <span class="token operator">&lt;-</span> <span class="token function">setupRootfs</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        errCh <span class="token operator">&lt;-</span> <span class="token function">setupNetwork</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        errCh <span class="token operator">&lt;-</span> <span class="token function">setupCgroups</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 等待所有任务完成</span></span>
<span class="line">    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token operator">&lt;-</span>errCh<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_10-2-内存优化" tabindex="-1"><a class="header-anchor" href="#_10-2-内存优化"><span>10.2 内存优化</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 使用对象池减少内存分配</span></span>
<span class="line"><span class="token keyword">var</span> bufferPool <span class="token operator">=</span> sync<span class="token punctuation">.</span>Pool<span class="token punctuation">{</span></span>
<span class="line">    New<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">readWithPool</span><span class="token punctuation">(</span>r io<span class="token punctuation">.</span>Reader<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    buf <span class="token operator">:=</span> bufferPool<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> bufferPool<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    n<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    result <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">copy</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> result<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><p>通过构建这个简化的容器运行时，我们实践了runc的核心技术:</p><ol><li><strong>进程隔离</strong>: 使用Linux命名空间实现进程、网络、文件系统等隔离</li><li><strong>资源管理</strong>: 通过Cgroups限制和监控容器资源使用</li><li><strong>文件系统</strong>: 实现rootfs切换和特殊文件系统挂载</li><li><strong>安全机制</strong>: 应用Linux Capabilities和其他安全特性</li><li><strong>通信监控</strong>: 建立容器与主机的通信通道</li></ol><p>这个minirunc项目虽然简化，但涵盖了容器运行时的核心功能，是深入理解容器技术的绝佳实践。通过亲手实现这些功能，你将真正掌握容器技术的本质，为进一步的容器技术研究和开发打下坚实基础。</p><h2 id="下一步建议" tabindex="-1"><a class="header-anchor" href="#下一步建议"><span>下一步建议</span></a></h2><ol><li><strong>增强功能</strong>: 添加镜像管理、层文件系统支持</li><li><strong>提升性能</strong>: 优化启动时间、减少资源开销</li><li><strong>完善安全</strong>: 实现Seccomp、AppArmor/SELinux集成</li><li><strong>扩展网络</strong>: 支持更多网络模式和CNI插件</li><li><strong>添加存储</strong>: 实现volume管理和持久化存储</li><li><strong>集成编排</strong>: 与Kubernetes CRI接口对接</li></ol>`,60))])}const m=l(r,[["render",k]]),b=JSON.parse('{"path":"/blogs/cloud-base/runc-deep-dive/09-goujianjianhuarongqiyunxingshi.html","title":"构建简化容器运行时","lang":"en-US","frontmatter":{"title":"构建简化容器运行时","date":"2025-08-09T00:00:00.000Z","tags":["runc","云原生","实践"],"categories":["cloud-base/runc-deep-dive"],"sidebar":"auto"},"headers":[{"level":2,"title":"概述","slug":"概述","link":"#概述","children":[]},{"level":2,"title":"概述","slug":"概述-1","link":"#概述-1","children":[]},{"level":2,"title":"1. 项目架构设计","slug":"_1-项目架构设计","link":"#_1-项目架构设计","children":[{"level":3,"title":"1.1 整体架构","slug":"_1-1-整体架构","link":"#_1-1-整体架构","children":[]},{"level":3,"title":"1.2 项目结构","slug":"_1-2-项目结构","link":"#_1-2-项目结构","children":[]}]},{"level":2,"title":"2. 核心数据结构","slug":"_2-核心数据结构","link":"#_2-核心数据结构","children":[{"level":3,"title":"2.1 容器配置","slug":"_2-1-容器配置","link":"#_2-1-容器配置","children":[]}]},{"level":2,"title":"3. 容器运行时实现","slug":"_3-容器运行时实现","link":"#_3-容器运行时实现","children":[{"level":3,"title":"3.1 主程序入口","slug":"_3-1-主程序入口","link":"#_3-1-主程序入口","children":[]},{"level":3,"title":"3.2 Run命令实现","slug":"_3-2-run命令实现","link":"#_3-2-run命令实现","children":[]},{"level":3,"title":"3.3 Init进程实现","slug":"_3-3-init进程实现","link":"#_3-3-init进程实现","children":[]}]},{"level":2,"title":"4. 命名空间管理","slug":"_4-命名空间管理","link":"#_4-命名空间管理","children":[{"level":3,"title":"4.1 命名空间管理器","slug":"_4-1-命名空间管理器","link":"#_4-1-命名空间管理器","children":[]},{"level":3,"title":"4.2 网络命名空间","slug":"_4-2-网络命名空间","link":"#_4-2-网络命名空间","children":[]}]},{"level":2,"title":"5. Cgroups资源管理","slug":"_5-cgroups资源管理","link":"#_5-cgroups资源管理","children":[{"level":3,"title":"5.1 Cgroups管理器","slug":"_5-1-cgroups管理器","link":"#_5-1-cgroups管理器","children":[]},{"level":3,"title":"5.2 内存子系统","slug":"_5-2-内存子系统","link":"#_5-2-内存子系统","children":[]},{"level":3,"title":"5.3 CPU子系统","slug":"_5-3-cpu子系统","link":"#_5-3-cpu子系统","children":[]}]},{"level":2,"title":"6. 文件系统管理","slug":"_6-文件系统管理","link":"#_6-文件系统管理","children":[{"level":3,"title":"6.1 Rootfs管理","slug":"_6-1-rootfs管理","link":"#_6-1-rootfs管理","children":[]}]},{"level":2,"title":"7. 安全模块","slug":"_7-安全模块","link":"#_7-安全模块","children":[{"level":3,"title":"7.1 Capabilities管理","slug":"_7-1-capabilities管理","link":"#_7-1-capabilities管理","children":[]}]},{"level":2,"title":"8. 测试和调试","slug":"_8-测试和调试","link":"#_8-测试和调试","children":[{"level":3,"title":"8.1 单元测试","slug":"_8-1-单元测试","link":"#_8-1-单元测试","children":[]},{"level":3,"title":"8.2 集成测试","slug":"_8-2-集成测试","link":"#_8-2-集成测试","children":[]},{"level":3,"title":"8.3 调试技巧","slug":"_8-3-调试技巧","link":"#_8-3-调试技巧","children":[]}]},{"level":2,"title":"9. 部署和使用","slug":"_9-部署和使用","link":"#_9-部署和使用","children":[{"level":3,"title":"9.1 编译和安装","slug":"_9-1-编译和安装","link":"#_9-1-编译和安装","children":[]},{"level":3,"title":"9.2 使用示例","slug":"_9-2-使用示例","link":"#_9-2-使用示例","children":[]}]},{"level":2,"title":"10. 性能优化","slug":"_10-性能优化","link":"#_10-性能优化","children":[{"level":3,"title":"10.1 启动时间优化","slug":"_10-1-启动时间优化","link":"#_10-1-启动时间优化","children":[]},{"level":3,"title":"10.2 内存优化","slug":"_10-2-内存优化","link":"#_10-2-内存优化","children":[]}]},{"level":2,"title":"总结","slug":"总结","link":"#总结","children":[]},{"level":2,"title":"下一步建议","slug":"下一步建议","link":"#下一步建议","children":[]}],"git":{"createdTime":1755014556000,"updatedTime":1755014556000,"contributors":[{"name":"hushengnian","email":"hushengnian@example.com","commits":1}]},"filePathRelative":"blogs/cloud-base/runc-deep-dive/09-构建简化容器运行时.md"}');export{m as comp,b as data};

import{_ as o,c as u,b as s,a as c,e as a,d as e,w as l,r as i,o as r}from"./app-2O6audqE.js";const d={},k={href:"https://lwn.net/Articles/531114/",target:"_blank",rel:"noopener noreferrer"},m={href:"https://man7.org/linux/man-pages/man7/user_namespaces.7.html",target:"_blank",rel:"noopener noreferrer"},v={href:"https://man7.org/linux/man-pages/man7/pid_namespaces.7.html",target:"_blank",rel:"noopener noreferrer"},b={href:"https://man7.org/linux/man-pages/man7/network_namespaces.7.html",target:"_blank",rel:"noopener noreferrer"},g={href:"https://man7.org/linux/man-pages/man2/clone.2.html",target:"_blank",rel:"noopener noreferrer"},h={href:"https://man7.org/linux/man-pages/man2/unshare.2.html",target:"_blank",rel:"noopener noreferrer"},f={href:"https://man7.org/linux/man-pages/man2/setns.2.html",target:"_blank",rel:"noopener noreferrer"},_={href:"https://man7.org/linux/man-pages/man1/nsenter.1.html",target:"_blank",rel:"noopener noreferrer"},y={href:"https://medium.com/@saschagrunert/demystifying-containers-101-a-deep-dive-into-container-technology-for-beginners-d7b60d8511c1",target:"_blank",rel:"noopener noreferrer"},w={href:"https://www.ianlewis.org/en/container-runtimes-part-1-introduction-container-r",target:"_blank",rel:"noopener noreferrer"},x={href:"https://rootlesscontaine.rs/",target:"_blank",rel:"noopener noreferrer"};function N(q,n){const t=i("RouteLink"),p=i("ExternalLinkIcon");return r(),u("div",null,[n[26]||(n[26]=s("h1",{id:"namespace-éš”ç¦»å®ç°",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#namespace-éš”ç¦»å®ç°"},[s("span",null,"Namespace éš”ç¦»å®ç°")])],-1)),s("blockquote",null,[s("p",null,[n[2]||(n[2]=s("strong",null,"ç³»åˆ—å¯¼èˆªï¼š",-1)),n[3]||(n[3]=a()),e(t,{to:"/blogs/cloud-base/runc-deep-dive/"},{default:l(()=>n[0]||(n[0]=[a("runc å®¹å™¨è¿è¡Œæ—¶æ·±åº¦è§£æç³»åˆ—")])),_:1,__:[0]}),n[4]||(n[4]=a(" â†’ ç¬¬ä¸‰ç¯‡ï¼šNamespace éš”ç¦»å®ç°")),n[5]||(n[5]=s("br",null,null,-1)),n[6]||(n[6]=s("strong",null,"ä¸Šä¸€ç¯‡ï¼š",-1)),n[7]||(n[7]=a()),e(t,{to:"/blogs/cloud-base/runc-deep-dive/02-%E5%AE%B9%E5%99%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86.html"},{default:l(()=>n[1]||(n[1]=[a("å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†")])),_:1,__:[1]}),n[8]||(n[8]=s("br",null,null,-1)),n[9]||(n[9]=s("strong",null,"æœ€åæ›´æ–°ï¼š",-1)),n[10]||(n[10]=a(" 2024"))])]),n[27]||(n[27]=c(`<h2 id="æ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#æ¦‚è¿°"><span>æ¦‚è¿°</span></a></h2><p>æœ¬æ–‡æ·±å…¥åˆ†æ runc å¦‚ä½•å®ç° Linux Namespace éš”ç¦»æœºåˆ¶ï¼Œè¿™æ˜¯å®¹å™¨æŠ€æœ¯çš„æ ¸å¿ƒåŸºç¡€ä¹‹ä¸€ã€‚é€šè¿‡ Namespaceï¼Œå®¹å™¨å¯ä»¥æ‹¥æœ‰ç‹¬ç«‹çš„è¿›ç¨‹ç©ºé—´ã€ç½‘ç»œæ ˆã€æ–‡ä»¶ç³»ç»Ÿè§†å›¾ç­‰ï¼Œå®ç°ä¸å®¿ä¸»æœºå’Œå…¶ä»–å®¹å™¨çš„æœ‰æ•ˆéš”ç¦»ã€‚</p><h2 id="ğŸ¯-å­¦ä¹ ç›®æ ‡" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-å­¦ä¹ ç›®æ ‡"><span>ğŸ¯ å­¦ä¹ ç›®æ ‡</span></a></h2><p>å®Œæˆæœ¬æ¨¡å—åï¼Œä½ å°†èƒ½å¤Ÿï¼š</p><ul><li>æ·±å…¥ç†è§£ Linux Namespace çš„ 8 ç§ç±»å‹å’Œä½œç”¨æœºåˆ¶</li><li>æŒæ¡ runc ä¸­ä¸‰é˜¶æ®µè¿›ç¨‹åˆ›å»ºæ¨¡å‹çš„è®¾è®¡åŸç†</li><li>ç†è§£ nsenter çš„ C ä»£ç å®ç°å’Œç³»ç»Ÿè°ƒç”¨å°è£…</li><li>æŒæ¡ namespace åˆ›å»ºã€åŠ å…¥å’Œç®¡ç†çš„å®Œæ•´æµç¨‹</li><li>å…·å¤‡è°ƒè¯•å’Œå®šåˆ¶ namespace éš”ç¦»åŠŸèƒ½çš„èƒ½åŠ›</li></ul><h2 id="_1-linux-namespace-åŸºç¡€æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#_1-linux-namespace-åŸºç¡€æ¦‚å¿µ"><span>1. Linux Namespace åŸºç¡€æ¦‚å¿µ</span></a></h2><h3 id="_1-1-ä»€ä¹ˆæ˜¯-namespace" tabindex="-1"><a class="header-anchor" href="#_1-1-ä»€ä¹ˆæ˜¯-namespace"><span>1.1 ä»€ä¹ˆæ˜¯ Namespaceï¼Ÿ</span></a></h3><p><strong>Namespace</strong> æ˜¯ Linux å†…æ ¸æä¾›çš„ä¸€ç§èµ„æºéš”ç¦»æœºåˆ¶ï¼Œå®ƒå¯ä»¥è®©ä¸åŒçš„è¿›ç¨‹ç»„çœ‹åˆ°ä¸åŒçš„ç³»ç»Ÿè§†å›¾ï¼Œå®ç°è¿›ç¨‹çº§åˆ«çš„è™šæ‹ŸåŒ–ã€‚</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚                ç‰©ç†æœºå™¨                         â”‚</span>
<span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="line">â”‚   å®¹å™¨ A        â”‚        å®¹å™¨ B                 â”‚</span>
<span class="line">â”‚                 â”‚                               â”‚</span>
<span class="line">â”‚ PID: 1,2,3      â”‚     PID: 1,2,3               â”‚</span>
<span class="line">â”‚ NET: eth0       â”‚     NET: eth0                â”‚</span>
<span class="line">â”‚ MNT: /app       â”‚     MNT: /data               â”‚</span>
<span class="line">â”‚ UTS: web-01     â”‚     UTS: db-01               â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line">       â–²                        â–²</span>
<span class="line">       â”‚        å…±äº«å†…æ ¸         â”‚</span>
<span class="line">   namespace A             namespace B</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ ¸å¿ƒç‰¹æ€§</strong>ï¼š</p><ul><li>ğŸ”’ <strong>éš”ç¦»æ€§</strong>: æ¯ä¸ª namespace å†…çš„è¿›ç¨‹åªèƒ½çœ‹åˆ°è‡ªå·±çš„èµ„æº</li><li>ğŸ§¬ <strong>ç»§æ‰¿æ€§</strong>: å­è¿›ç¨‹ç»§æ‰¿çˆ¶è¿›ç¨‹çš„ namespace</li><li>ğŸ”„ <strong>å¯åŠ å…¥</strong>: è¿›ç¨‹å¯ä»¥åŠ å…¥å·²å­˜åœ¨çš„ namespace</li><li>ğŸ—ï¸ <strong>å¯åµŒå¥—</strong>: æŸäº› namespace æ”¯æŒåµŒå¥—ç»“æ„</li></ul><h3 id="_1-2-å…«ç§-namespace-ç±»å‹è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#_1-2-å…«ç§-namespace-ç±»å‹è¯¦è§£"><span>1.2 å…«ç§ Namespace ç±»å‹è¯¦è§£</span></a></h3><h4 id="a-pid-namespace-è¿›ç¨‹idéš”ç¦»" tabindex="-1"><a class="header-anchor" href="#a-pid-namespace-è¿›ç¨‹idéš”ç¦»"><span>A. PID Namespace (è¿›ç¨‹IDéš”ç¦»)</span></a></h4><p><strong>ä½œç”¨</strong>: éš”ç¦»è¿›ç¨‹ ID ç©ºé—´ï¼Œæ¯ä¸ª PID namespace éƒ½æœ‰è‡ªå·±çš„ PID 1 (initè¿›ç¨‹)</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/configs/namespaces_linux.go:15</span></span>
<span class="line"><span class="token keyword">const</span> NEWPID NamespaceType <span class="token operator">=</span> <span class="token string">&quot;NEWPID&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å…³é”®ç‰¹æ€§</strong>ï¼š</p><ul><li>å®¹å™¨å†…çš„ PID 1 è¿›ç¨‹è´Ÿè´£å›æ”¶åƒµå°¸è¿›ç¨‹</li><li>å†…å¤– PID æ˜ å°„ï¼šå®¹å™¨å†… PID 1 å¯¹åº”å®¿ä¸»æœºä¸ŠæŸä¸ª PID</li><li>åµŒå¥—æ”¯æŒï¼šå¯ä»¥åˆ›å»ºå¤šå±‚ PID namespace</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">å®¿ä¸»æœºè§†å›¾:        å®¹å™¨å†…è§†å›¾:</span>
<span class="line">PID 1: systemd    PID 1: /bin/bash  â† å®¹å™¨çš„ init è¿›ç¨‹</span>
<span class="line">PID 1234: runc    PID 2: /app       â† åº”ç”¨è¿›ç¨‹</span>
<span class="line">PID 1235: bash    (ä¸å¯è§å…¶ä»–è¿›ç¨‹)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="b-network-namespace-ç½‘ç»œéš”ç¦»" tabindex="-1"><a class="header-anchor" href="#b-network-namespace-ç½‘ç»œéš”ç¦»"><span>B. Network Namespace (ç½‘ç»œéš”ç¦»)</span></a></h4><p><strong>ä½œç”¨</strong>: éš”ç¦»ç½‘ç»œè®¾å¤‡ã€IPåœ°å€ã€ç«¯å£ã€è·¯ç”±è¡¨ç­‰ç½‘ç»œèµ„æº</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">const</span> NEWNET NamespaceType <span class="token operator">=</span> <span class="token string">&quot;NEWNET&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>éš”ç¦»èµ„æº</strong>ï¼š</p><ul><li>ç½‘ç»œæ¥å£(eth0, loç­‰)</li><li>IPåœ°å€å’Œè·¯ç”±è¡¨</li><li>iptablesè§„åˆ™</li><li>ç½‘ç»œç«¯å£èŒƒå›´</li><li>/proc/net ç›®å½•å†…å®¹</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚   å®¿ä¸»æœºç½‘ç»œ     â”‚    â”‚   å®¹å™¨ç½‘ç»œ       â”‚</span>
<span class="line">â”‚                 â”‚    â”‚                 â”‚</span>
<span class="line">â”‚ eth0: 10.0.0.1  â”‚    â”‚ eth0: 172.17.0.2â”‚</span>
<span class="line">â”‚ lo: 127.0.0.1   â”‚    â”‚ lo: 127.0.0.1   â”‚</span>
<span class="line">â”‚ è·¯ç”±è¡¨: é»˜è®¤     â”‚    â”‚ è·¯ç”±è¡¨: éš”ç¦»     â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="c-mount-namespace-æ–‡ä»¶ç³»ç»Ÿéš”ç¦»" tabindex="-1"><a class="header-anchor" href="#c-mount-namespace-æ–‡ä»¶ç³»ç»Ÿéš”ç¦»"><span>C. Mount Namespace (æ–‡ä»¶ç³»ç»Ÿéš”ç¦»)</span></a></h4><p><strong>ä½œç”¨</strong>: éš”ç¦»æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹ï¼Œæ¯ä¸ª mount namespace æœ‰ç‹¬ç«‹çš„æŒ‚è½½ç‚¹åˆ—è¡¨</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">const</span> NEWNS NamespaceType <span class="token operator">=</span> <span class="token string">&quot;NEWNS&quot;</span>  <span class="token comment">// å†å²åŸå› ï¼ŒNSæ˜¯æœ€æ—©çš„namespace</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>éš”ç¦»å†…å®¹</strong>ï¼š</p><ul><li>æŒ‚è½½ç‚¹åˆ—è¡¨(/proc/mounts)</li><li>æ ¹æ–‡ä»¶ç³»ç»Ÿ(/)</li><li>æŒ‚è½½ä¼ æ’­å±æ€§(private, shared, slaveç­‰)</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">å®¿ä¸»æœºæŒ‚è½½:              å®¹å™¨å†…æŒ‚è½½:</span>
<span class="line">/dev/sda1 -&gt; /          /dev/sda2 -&gt; /</span>
<span class="line">/dev/sda2 -&gt; /home      tmpfs -&gt; /tmp</span>
<span class="line">tmpfs -&gt; /tmp           /dev/sda3 -&gt; /data</span>
<span class="line">                        overlay -&gt; /app</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="d-user-namespace-ç”¨æˆ·æƒé™éš”ç¦»" tabindex="-1"><a class="header-anchor" href="#d-user-namespace-ç”¨æˆ·æƒé™éš”ç¦»"><span>D. User Namespace (ç”¨æˆ·æƒé™éš”ç¦»)</span></a></h4><p><strong>ä½œç”¨</strong>: éš”ç¦»ç”¨æˆ·IDå’Œç»„IDï¼Œå®ç°ç”¨æˆ·æƒé™æ˜ å°„</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">const</span> NEWUSER NamespaceType <span class="token operator">=</span> <span class="token string">&quot;NEWUSER&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>ï¼š</p><ul><li>ID æ˜ å°„ï¼šå®¹å™¨å†… UID/GID æ˜ å°„åˆ°å®¿ä¸»æœºçš„ä¸åŒ UID/GID</li><li>æƒé™éš”ç¦»ï¼šå®¹å™¨å†…çš„ root ç”¨æˆ·ä¸ç­‰åŒäºå®¿ä¸»æœº root</li><li>æ— ç‰¹æƒå®¹å™¨ï¼šæ™®é€šç”¨æˆ·ä¹Ÿå¯ä»¥åˆ›å»ºå®¹å™¨</li></ul><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// IDæ˜ å°„é…ç½®ç¤ºä¾‹</span></span>
<span class="line"><span class="token keyword">type</span> IDMap <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    ContainerID <span class="token builtin">int64</span>  <span class="token comment">// å®¹å™¨å†…ID: 0 (root)</span></span>
<span class="line">    HostID      <span class="token builtin">int64</span>  <span class="token comment">// å®¿ä¸»æœºID: 1000 (æ™®é€šç”¨æˆ·)</span></span>
<span class="line">    Size        <span class="token builtin">int64</span>  <span class="token comment">// æ˜ å°„èŒƒå›´: 65536</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ˜ å°„ç¤ºä¾‹</strong>ï¼š</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">å®¹å™¨å†…è§†å›¾:        å®¿ä¸»æœºè§†å›¾:</span>
<span class="line">UID 0 (root)   â†’  UID 1000 (user)</span>
<span class="line">UID 1 (user)   â†’  UID 1001 </span>
<span class="line">UID 100        â†’  UID 1100</span>
<span class="line">...            â†’  ...</span>
<span class="line">UID 65535      â†’  UID 66535</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="e-ipc-namespace-è¿›ç¨‹é—´é€šä¿¡éš”ç¦»" tabindex="-1"><a class="header-anchor" href="#e-ipc-namespace-è¿›ç¨‹é—´é€šä¿¡éš”ç¦»"><span>E. IPC Namespace (è¿›ç¨‹é—´é€šä¿¡éš”ç¦»)</span></a></h4><p><strong>ä½œç”¨</strong>: éš”ç¦» System V IPC å’Œ POSIX æ¶ˆæ¯é˜Ÿåˆ—</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">const</span> NEWIPC NamespaceType <span class="token operator">=</span> <span class="token string">&quot;NEWIPC&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>éš”ç¦»èµ„æº</strong>ï¼š</p><ul><li>System V æ¶ˆæ¯é˜Ÿåˆ—ã€ä¿¡å·é‡ã€å…±äº«å†…å­˜</li><li>POSIX æ¶ˆæ¯é˜Ÿåˆ—</li><li>/proc/sysvipc/ å†…å®¹</li></ul><h4 id="f-uts-namespace-ä¸»æœºåéš”ç¦»" tabindex="-1"><a class="header-anchor" href="#f-uts-namespace-ä¸»æœºåéš”ç¦»"><span>F. UTS Namespace (ä¸»æœºåéš”ç¦»)</span></a></h4><p><strong>ä½œç”¨</strong>: éš”ç¦»ä¸»æœºå(hostname)å’ŒåŸŸå(domainname)</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">const</span> NEWUTS NamespaceType <span class="token operator">=</span> <span class="token string">&quot;NEWUTS&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>åº”ç”¨åœºæ™¯</strong>ï¼š</p><ul><li>å®¹å™¨æœ‰ç‹¬ç«‹çš„ä¸»æœºå</li><li>å¾®æœåŠ¡æ¶æ„ä¸­çš„æœåŠ¡æ ‡è¯†</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># å®¿ä¸»æœº</span></span>
<span class="line">$ <span class="token function">hostname</span></span>
<span class="line">host-machine</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å®¹å™¨å†…</span></span>
<span class="line">$ <span class="token function">hostname</span>  </span>
<span class="line">web-server-01</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="g-cgroup-namespace-æ§åˆ¶ç»„éš”ç¦»" tabindex="-1"><a class="header-anchor" href="#g-cgroup-namespace-æ§åˆ¶ç»„éš”ç¦»"><span>G. Cgroup Namespace (æ§åˆ¶ç»„éš”ç¦»)</span></a></h4><p><strong>ä½œç”¨</strong>: éš”ç¦» cgroups è§†å›¾ï¼Œå®¹å™¨å†…çœ‹ä¸åˆ°å®¿ä¸»æœºçš„å®Œæ•´ cgroups æ ‘</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">const</span> NEWCGROUP NamespaceType <span class="token operator">=</span> <span class="token string">&quot;NEWCGROUP&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>ç‰¹æ€§</strong>ï¼š</p><ul><li>è™šæ‹ŸåŒ– /proc/cgroups å’Œ /proc/self/cgroup å†…å®¹</li><li>éšè—å®¿ä¸»æœºçš„ cgroups å±‚æ¬¡ç»“æ„</li></ul><h4 id="h-time-namespace-æ—¶é—´éš”ç¦»" tabindex="-1"><a class="header-anchor" href="#h-time-namespace-æ—¶é—´éš”ç¦»"><span>H. Time Namespace (æ—¶é—´éš”ç¦»)</span></a></h4><p><strong>ä½œç”¨</strong>: éš”ç¦»ç³»ç»Ÿæ—¶é—´ï¼Œå®¹å™¨å¯ä»¥æœ‰ä¸åŒçš„æ—¶é—´è§†å›¾</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">const</span> NEWTIME NamespaceType <span class="token operator">=</span> <span class="token string">&quot;NEWTIME&quot;</span>  <span class="token comment">// Linux 5.6+ æ”¯æŒ</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>åº”ç”¨åœºæ™¯</strong>ï¼š</p><ul><li>æ—¶é—´æ—…è¡Œæµ‹è¯•</li><li>ä¸åŒæ—¶åŒºçš„åº”ç”¨</li></ul><h2 id="_2-runc-çš„-namespace-å®ç°æ¶æ„" tabindex="-1"><a class="header-anchor" href="#_2-runc-çš„-namespace-å®ç°æ¶æ„"><span>2. runc çš„ Namespace å®ç°æ¶æ„</span></a></h2><h3 id="_2-1-æ ¸å¿ƒæ•°æ®ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_2-1-æ ¸å¿ƒæ•°æ®ç»“æ„"><span>2.1 æ ¸å¿ƒæ•°æ®ç»“æ„</span></a></h3><h4 id="namespace-é…ç½®ç»“æ„" tabindex="-1"><a class="header-anchor" href="#namespace-é…ç½®ç»“æ„"><span>Namespace é…ç½®ç»“æ„</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/configs/namespaces_linux.go:55</span></span>
<span class="line"><span class="token keyword">type</span> Namespace <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Type NamespaceType <span class="token string">\`json:&quot;type&quot;\`</span>         <span class="token comment">// namespace ç±»å‹</span></span>
<span class="line">    Path <span class="token builtin">string</span>        <span class="token string">\`json:&quot;path,omitempty&quot;\`</span> <span class="token comment">// åŠ å…¥ç°æœ‰ namespace çš„è·¯å¾„</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> Namespaces <span class="token punctuation">[</span><span class="token punctuation">]</span>Namespace</span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ£€æŸ¥æ˜¯å¦åŒ…å«ç‰¹å®šç±»å‹çš„ namespace</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>n Namespaces<span class="token punctuation">)</span> <span class="token function">Contains</span><span class="token punctuation">(</span>t NamespaceType<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ns <span class="token operator">:=</span> <span class="token keyword">range</span> n <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> ns<span class="token punctuation">.</span>Type <span class="token operator">==</span> t <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç³»ç»Ÿè°ƒç”¨æ˜ å°„" tabindex="-1"><a class="header-anchor" href="#ç³»ç»Ÿè°ƒç”¨æ˜ å°„"><span>ç³»ç»Ÿè°ƒç”¨æ˜ å°„</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/configs/namespaces_syscall.go:12</span></span>
<span class="line"><span class="token keyword">var</span> namespaceInfo <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span>NamespaceType<span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span></span>
<span class="line">    NEWNET<span class="token punctuation">:</span>    unix<span class="token punctuation">.</span>CLONE_NEWNET<span class="token punctuation">,</span>    <span class="token comment">// 0x40000000</span></span>
<span class="line">    NEWNS<span class="token punctuation">:</span>     unix<span class="token punctuation">.</span>CLONE_NEWNS<span class="token punctuation">,</span>     <span class="token comment">// 0x00020000  </span></span>
<span class="line">    NEWUSER<span class="token punctuation">:</span>   unix<span class="token punctuation">.</span>CLONE_NEWUSER<span class="token punctuation">,</span>   <span class="token comment">// 0x10000000</span></span>
<span class="line">    NEWIPC<span class="token punctuation">:</span>    unix<span class="token punctuation">.</span>CLONE_NEWIPC<span class="token punctuation">,</span>    <span class="token comment">// 0x08000000</span></span>
<span class="line">    NEWUTS<span class="token punctuation">:</span>    unix<span class="token punctuation">.</span>CLONE_NEWUTS<span class="token punctuation">,</span>    <span class="token comment">// 0x04000000</span></span>
<span class="line">    NEWPID<span class="token punctuation">:</span>    unix<span class="token punctuation">.</span>CLONE_NEWPID<span class="token punctuation">,</span>    <span class="token comment">// 0x20000000</span></span>
<span class="line">    NEWCGROUP<span class="token punctuation">:</span> unix<span class="token punctuation">.</span>CLONE_NEWCGROUP<span class="token punctuation">,</span> <span class="token comment">// 0x02000000</span></span>
<span class="line">    NEWTIME<span class="token punctuation">:</span>   unix<span class="token punctuation">.</span>CLONE_NEWTIME<span class="token punctuation">,</span>   <span class="token comment">// 0x00000080</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç”Ÿæˆ clone ç³»ç»Ÿè°ƒç”¨æ ‡å¿—</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>n Namespaces<span class="token punctuation">)</span> <span class="token function">CloneFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">uintptr</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> flag <span class="token builtin">int</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ns <span class="token operator">:=</span> <span class="token keyword">range</span> n <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> ns<span class="token punctuation">.</span>Path <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">continue</span>  <span class="token comment">// åŠ å…¥ç°æœ‰ namespaceï¼Œä¸éœ€è¦åˆ›å»ºæ–°çš„</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        flag <span class="token operator">|=</span> namespaceInfo<span class="token punctuation">[</span>ns<span class="token punctuation">.</span>Type<span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-ä¸‰é˜¶æ®µè¿›ç¨‹åˆ›å»ºæ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#_2-2-ä¸‰é˜¶æ®µè¿›ç¨‹åˆ›å»ºæ¨¡å‹"><span>2.2 ä¸‰é˜¶æ®µè¿›ç¨‹åˆ›å»ºæ¨¡å‹</span></a></h3><p>runc é‡‡ç”¨ç‹¬ç‰¹çš„ä¸‰é˜¶æ®µè¿›ç¨‹åˆ›å»ºæ¨¡å‹æ¥å¤„ç† namespace çš„å¤æ‚æ€§ï¼š</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">ç”¨æˆ·è°ƒç”¨: runc create mycontainer</span>
<span class="line">â”‚</span>
<span class="line">â–¼</span>
<span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚  é˜¶æ®µ0: çˆ¶è¿›ç¨‹ (STAGE_PARENT)                   â”‚</span>
<span class="line">â”‚  èŒè´£: ç”¨æˆ·æ˜ å°„è®¾ç½®ã€è¿›ç¨‹åè°ƒ                    â”‚</span>
<span class="line">â”‚  è¿›ç¨‹: runc ä¸»è¿›ç¨‹                              â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line">              â”‚ fork() + nsenter</span>
<span class="line">              â–¼</span>
<span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚  é˜¶æ®µ1: ä¸­é—´å­è¿›ç¨‹ (STAGE_CHILD)                â”‚</span>
<span class="line">â”‚  èŒè´£: åŠ å…¥/åˆ›å»º namespaceã€æƒé™å¤„ç†             â”‚</span>
<span class="line">â”‚  è¿›ç¨‹: bootstrap è¿›ç¨‹                           â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line">              â”‚ fork() </span>
<span class="line">              â–¼</span>
<span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚  é˜¶æ®µ2: æœ€ç»ˆè¿›ç¨‹ (STAGE_INIT)                   â”‚</span>
<span class="line">â”‚  èŒè´£: å®¹å™¨åˆå§‹åŒ–ã€æ‰§è¡Œç”¨æˆ·ç¨‹åº                  â”‚</span>
<span class="line">â”‚  è¿›ç¨‹: å®¹å™¨çš„ init è¿›ç¨‹                         â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä¸ºä»€ä¹ˆéœ€è¦ä¸‰é˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆéœ€è¦ä¸‰é˜¶æ®µ"><span>ä¸ºä»€ä¹ˆéœ€è¦ä¸‰é˜¶æ®µï¼Ÿ</span></a></h4><ol><li><strong>æƒé™å¤„ç†å¤æ‚æ€§</strong>: ç”¨æˆ· namespace éœ€è¦å…ˆè®¾ç½®æ˜ å°„æ‰èƒ½æ“ä½œå…¶ä»– namespace</li><li><strong>æ—¶åºä¾èµ–</strong>: æŸäº› namespace çš„åˆ›å»ºé¡ºåºå¾ˆé‡è¦</li><li><strong>åŒæ­¥éœ€æ±‚</strong>: çˆ¶è¿›ç¨‹éœ€è¦è®¾ç½®å­è¿›ç¨‹çš„ç”¨æˆ·æ˜ å°„</li><li><strong>å®‰å…¨è€ƒè™‘</strong>: æœ€ç»ˆè¿›ç¨‹ä¸åº”è¯¥æœ‰ä¸å¿…è¦çš„æƒé™</li></ol><h3 id="_2-3-nsenter-æ ¸å¿ƒå®ç°" tabindex="-1"><a class="header-anchor" href="#_2-3-nsenter-æ ¸å¿ƒå®ç°"><span>2.3 nsenter æ ¸å¿ƒå®ç°</span></a></h3><h4 id="c-ä»£ç ç»“æ„" tabindex="-1"><a class="header-anchor" href="#c-ä»£ç ç»“æ„"><span>C ä»£ç ç»“æ„</span></a></h4><p>runc ä½¿ç”¨ C ä»£ç å®ç°åº•å±‚ namespace æ“ä½œï¼Œä¸»è¦æ–‡ä»¶ï¼š</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">libcontainer/nsenter/</span>
<span class="line">â”œâ”€â”€ nsexec.c          # ä¸»è¦å®ç°æ–‡ä»¶</span>
<span class="line">â”œâ”€â”€ namespace.h       # å‘½åç©ºé—´å¸¸é‡å®šä¹‰  </span>
<span class="line">â”œâ”€â”€ log.c/log.h       # æ—¥å¿—è®°å½•</span>
<span class="line">â””â”€â”€ nsenter.go        # Go ä¸ C çš„æ¥å£</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä¸»å…¥å£å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#ä¸»å…¥å£å‡½æ•°"><span>ä¸»å…¥å£å‡½æ•°</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// libcontainer/nsenter/nsexec.c:638</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">nsexec</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span> pipenum<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">nlconfig_t</span> config <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 1. è§£æé…ç½®å’ŒåŒæ­¥ç®¡é“</span></span>
<span class="line">    pipenum <span class="token operator">=</span> <span class="token function">initpipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>pipenum <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. ä»ç®¡é“è¯»å–é…ç½®ä¿¡æ¯</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">nlconfig_parse</span><span class="token punctuation">(</span>pipenum<span class="token punctuation">,</span> <span class="token operator">&amp;</span>config<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to parse netlink config&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. æ ¹æ®é˜¶æ®µæ‰§è¡Œä¸åŒé€»è¾‘</span></span>
<span class="line">    <span class="token keyword">switch</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>stage<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> STAGE_PARENT<span class="token operator">:</span>  </span>
<span class="line">        <span class="token function">parent_stage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">case</span> STAGE_CHILD<span class="token operator">:</span>   </span>
<span class="line">        <span class="token function">child_stage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">case</span> STAGE_INIT<span class="token operator">:</span>    </span>
<span class="line">        <span class="token function">init_stage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="é…ç½®ç»“æ„ä½“" tabindex="-1"><a class="header-anchor" href="#é…ç½®ç»“æ„ä½“"><span>é…ç½®ç»“æ„ä½“</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// libcontainer/nsenter/nsexec.c:89</span></span>
<span class="line"><span class="token keyword">struct</span> <span class="token class-name">nlconfig_t</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>                    <span class="token comment">// åºåˆ—åŒ–æ•°æ®</span></span>
<span class="line">    <span class="token keyword">int</span> stage<span class="token punctuation">;</span>                     <span class="token comment">// å½“å‰é˜¶æ®µ</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// namespace ç›¸å…³</span></span>
<span class="line">    <span class="token keyword">char</span> <span class="token operator">*</span>namespaces<span class="token punctuation">;</span>              <span class="token comment">// è¦åŠ å…¥çš„ namespace è·¯å¾„</span></span>
<span class="line">    <span class="token class-name">size_t</span> namespaces_len<span class="token punctuation">;</span>         <span class="token comment">// é•¿åº¦</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// clone æ ‡å¿—</span></span>
<span class="line">    <span class="token class-name">uint32_t</span> cloneflags<span class="token punctuation">;</span>           <span class="token comment">// clone() ç³»ç»Ÿè°ƒç”¨æ ‡å¿—</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ç”¨æˆ·æ˜ å°„</span></span>
<span class="line">    <span class="token keyword">char</span> <span class="token operator">*</span>uidmap<span class="token punctuation">,</span> <span class="token operator">*</span>gidmap<span class="token punctuation">;</span>         <span class="token comment">// ID æ˜ å°„æ•°æ®</span></span>
<span class="line">    <span class="token keyword">char</span> <span class="token operator">*</span>uidmappath<span class="token punctuation">,</span> <span class="token operator">*</span>gidmappath<span class="token punctuation">;</span> <span class="token comment">// æ˜ å°„æ–‡ä»¶è·¯å¾„</span></span>
<span class="line">    <span class="token keyword">int</span> uidmap_len<span class="token punctuation">,</span> gidmap_len<span class="token punctuation">;</span>    <span class="token comment">// æ˜ å°„æ•°æ®é•¿åº¦</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å…¶ä»–é…ç½®</span></span>
<span class="line">    <span class="token keyword">char</span> <span class="token operator">*</span>oom_score_adj<span class="token punctuation">;</span>           <span class="token comment">// OOM åˆ†æ•°è°ƒæ•´</span></span>
<span class="line">    <span class="token keyword">char</span> <span class="token operator">*</span>rootfs<span class="token punctuation">;</span>                  <span class="token comment">// æ ¹æ–‡ä»¶ç³»ç»Ÿè·¯å¾„</span></span>
<span class="line">    bool is_rootless_euid<span class="token punctuation">;</span>         <span class="token comment">// æ˜¯å¦ä¸º rootless æ¨¡å¼</span></span>
<span class="line">    bool is_setgroup<span class="token punctuation">;</span>              <span class="token comment">// æ˜¯å¦å¯ä»¥è°ƒç”¨ setgroups</span></span>
<span class="line">    bool no_new_keyring<span class="token punctuation">;</span>           <span class="token comment">// æ˜¯å¦ç¦ç”¨æ–° keyring</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ—¶é—´ namespace åç§»</span></span>
<span class="line">    <span class="token keyword">char</span> <span class="token operator">*</span>time_offsets<span class="token punctuation">;</span>            <span class="token comment">// æ—¶é—´åç§»é…ç½®</span></span>
<span class="line">    <span class="token keyword">int</span> time_offsets_len<span class="token punctuation">;</span>          <span class="token comment">// åç§»é…ç½®é•¿åº¦</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-namespace-åˆ›å»ºæµç¨‹è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#_3-namespace-åˆ›å»ºæµç¨‹è¯¦è§£"><span>3. Namespace åˆ›å»ºæµç¨‹è¯¦è§£</span></a></h2><h3 id="_3-1-é˜¶æ®µ0-çˆ¶è¿›ç¨‹-stage-parent" tabindex="-1"><a class="header-anchor" href="#_3-1-é˜¶æ®µ0-çˆ¶è¿›ç¨‹-stage-parent"><span>3.1 é˜¶æ®µ0: çˆ¶è¿›ç¨‹ (STAGE_PARENT)</span></a></h3><p><strong>ä¸»è¦èŒè´£</strong>: è®¾ç½®ç”¨æˆ·æ˜ å°„ï¼Œåè°ƒå­è¿›ç¨‹</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// libcontainer/nsenter/nsexec.c:900</span></span>
<span class="line"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">parent_stage</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">nlconfig_t</span> <span class="token operator">*</span>config<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">pid_t</span> stage1_pid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> stage2_pid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 1. ç­‰å¾…ç¬¬ä¸€é˜¶æ®µè¿›ç¨‹å°±ç»ª</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sync_wait_for_child</span><span class="token punctuation">(</span>syncpipe<span class="token punctuation">,</span> SYNC_RECVPID_PLS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to sync with child&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">    <span class="token comment">// æ¥æ”¶å­è¿›ç¨‹ PID</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>syncpipe<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stage1_pid<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stage1_pid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stage1_pid<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to read child pid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. è®¾ç½®ç”¨æˆ· ID æ˜ å°„</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>uidmappath<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">update_uidmap</span><span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>uidmappath<span class="token punctuation">,</span> stage1_pid<span class="token punctuation">,</span> </span>
<span class="line">                     config<span class="token operator">-&gt;</span>uidmap<span class="token punctuation">,</span> config<span class="token operator">-&gt;</span>uidmap_len<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>gidmappath<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">update_gidmap</span><span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>gidmappath<span class="token punctuation">,</span> stage1_pid<span class="token punctuation">,</span> </span>
<span class="line">                     config<span class="token operator">-&gt;</span>gidmap<span class="token punctuation">,</span> config<span class="token operator">-&gt;</span>gidmap_len<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. è®¾ç½®æ—¶é—´åç§» (TIME namespace)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>time_offsets<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">update_time_offsets</span><span class="token punctuation">(</span>stage1_pid<span class="token punctuation">,</span> config<span class="token operator">-&gt;</span>time_offsets<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. é€šçŸ¥å­è¿›ç¨‹ç»§ç»­</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sync_wake_child</span><span class="token punctuation">(</span>syncpipe<span class="token punctuation">,</span> SYNC_USERMAP_ACK<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to sync with child&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç”¨æˆ·æ˜ å°„è®¾ç½®" tabindex="-1"><a class="header-anchor" href="#ç”¨æˆ·æ˜ å°„è®¾ç½®"><span>ç”¨æˆ·æ˜ å°„è®¾ç½®</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// libcontainer/nsenter/nsexec.c:393  </span></span>
<span class="line"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">update_uidmap</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span> <span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>map<span class="token punctuation">,</span> <span class="token class-name">size_t</span> map_len<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// é¦–å…ˆå°è¯•ç›´æ¥å†™å…¥ /proc/pid/uid_map</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write_file</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> map_len<span class="token punctuation">,</span> <span class="token string">&quot;/proc/%d/uid_map&quot;</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// å¦‚æœæƒé™ä¸è¶³ï¼Œå°è¯•ä½¿ç”¨ newuidmap å·¥å…·</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EPERM<span class="token punctuation">)</span> </span>
<span class="line">            <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to update /proc/%d/uid_map&quot;</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">        <span class="token comment">// ä½¿ç”¨å¤–éƒ¨å·¥å…·è¿›è¡Œæ˜ å°„</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">try_mapping_tool</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> map<span class="token punctuation">,</span> map_len<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to use newuid map on %d&quot;</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-é˜¶æ®µ1-ä¸­é—´å­è¿›ç¨‹-stage-child" tabindex="-1"><a class="header-anchor" href="#_3-2-é˜¶æ®µ1-ä¸­é—´å­è¿›ç¨‹-stage-child"><span>3.2 é˜¶æ®µ1: ä¸­é—´å­è¿›ç¨‹ (STAGE_CHILD)</span></a></h3><p><strong>ä¸»è¦èŒè´£</strong>: åŠ å…¥ç°æœ‰ namespaceï¼Œåˆ›å»ºæ–° namespace</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// libcontainer/nsenter/nsexec.c:1063</span></span>
<span class="line"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">child_stage</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">nlconfig_t</span> <span class="token operator">*</span>config<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. å‘é€ PID ç»™çˆ¶è¿›ç¨‹</span></span>
<span class="line">    <span class="token class-name">pid_t</span> stage1_pid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>syncpipe<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stage1_pid<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stage1_pid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stage1_pid<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to write pid to parent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">    <span class="token comment">// 2. ç­‰å¾…çˆ¶è¿›ç¨‹è®¾ç½®ç”¨æˆ·æ˜ å°„</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sync_wait_for_child</span><span class="token punctuation">(</span>syncpipe<span class="token punctuation">,</span> SYNC_USERMAP_ACK<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to wait for parent to map user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. åŠ å…¥ç°æœ‰çš„ namespace (å¦‚æœæŒ‡å®šäº†è·¯å¾„)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>namespaces<span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">join_namespaces</span><span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>namespaces<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. åˆ›å»ºç”¨æˆ· namespace (å¦‚æœéœ€è¦)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>cloneflags <span class="token operator">&amp;</span> CLONE_NEWUSER<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unshare</span><span class="token punctuation">(</span>CLONE_NEWUSER<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to unshare user namespace&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 5. åˆ›å»ºå…¶ä»– namespace</span></span>
<span class="line">    <span class="token function">try_unshare</span><span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>cloneflags <span class="token operator">&amp;</span> <span class="token operator">~</span>CLONE_NEWUSER<span class="token punctuation">,</span> <span class="token string">&quot;remaining namespaces&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 6. Fork å‡ºæœ€ç»ˆçš„ init è¿›ç¨‹</span></span>
<span class="line">    stage2_pid <span class="token operator">=</span> <span class="token function">clone_parent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">,</span> STAGE_INIT<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>stage2_pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;unable to fork stage-2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">    <span class="token comment">// 7. ç­‰å¾… init è¿›ç¨‹å®Œæˆåˆå§‹åŒ–</span></span>
<span class="line">    <span class="token function">wait_for_stage2_child</span><span class="token punctuation">(</span>stage2_pid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="namespace-åŠ å…¥æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#namespace-åŠ å…¥æœºåˆ¶"><span>Namespace åŠ å…¥æœºåˆ¶</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// libcontainer/nsenter/nsexec.c:533</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">join_namespaces</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>nsspec<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">namespace_t</span> <span class="token operator">*</span>ns_list<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">size_t</span> ns_len<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 1. è§£æ namespace è§„æ ¼å­—ç¬¦ä¸²</span></span>
<span class="line">    <span class="token comment">// æ ¼å¼: &quot;net:/proc/1234/ns/net,pid:/proc/1234/ns/pid&quot;</span></span>
<span class="line">    to_join <span class="token operator">=</span> <span class="token function">__open_namespaces</span><span class="token punctuation">(</span>nsspec<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ns_list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ns_len<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. åˆ†ä¸‰ä¸ªæ­¥éª¤åŠ å…¥ï¼Œå¤„ç†æƒé™ä¾èµ–</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ­¥éª¤1: åŠ å…¥éç”¨æˆ·å‘½åç©ºé—´</span></span>
<span class="line">    joined <span class="token operator">|=</span> <span class="token function">__join_namespaces</span><span class="token punctuation">(</span>to_join <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>joined <span class="token operator">|</span> CLONE_NEWUSER<span class="token punctuation">)</span><span class="token punctuation">,</span> </span>
<span class="line">                                ns_list<span class="token punctuation">,</span> ns_len<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ­¥éª¤2: åŠ å…¥ç”¨æˆ·å‘½åç©ºé—´</span></span>
<span class="line">    joined <span class="token operator">|=</span> <span class="token function">__join_namespaces</span><span class="token punctuation">(</span>CLONE_NEWUSER<span class="token punctuation">,</span> ns_list<span class="token punctuation">,</span> ns_len<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ­¥éª¤3: åŠ å…¥å‰©ä½™çš„å‘½åç©ºé—´  </span></span>
<span class="line">    joined <span class="token operator">|=</span> <span class="token function">__join_namespaces</span><span class="token punctuation">(</span>to_join <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>joined <span class="token operator">|</span> CLONE_NEWUSER<span class="token punctuation">)</span><span class="token punctuation">,</span> </span>
<span class="line">                                ns_list<span class="token punctuation">,</span> ns_len<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">free_namespaces</span><span class="token punctuation">(</span>ns_list<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="åŠ å…¥å•ä¸ª-namespace" tabindex="-1"><a class="header-anchor" href="#åŠ å…¥å•ä¸ª-namespace"><span>åŠ å…¥å•ä¸ª Namespace</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// libcontainer/nsenter/nsexec.c:458</span></span>
<span class="line"><span class="token keyword">static</span> <span class="token class-name">nsset_t</span> <span class="token function">__join_namespaces</span><span class="token punctuation">(</span><span class="token class-name">nsset_t</span> allow<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">namespace_t</span> <span class="token operator">*</span>ns_list<span class="token punctuation">,</span> <span class="token class-name">size_t</span> ns_len<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">nsset_t</span> joined <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ns_len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">struct</span> <span class="token class-name">namespace_t</span> <span class="token operator">*</span>ns <span class="token operator">=</span> <span class="token operator">&amp;</span>ns_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">int</span> nstype <span class="token operator">=</span> <span class="token function">nstype</span><span class="token punctuation">(</span>ns<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>nstype <span class="token operator">&amp;</span> allow<span class="token punctuation">)</span><span class="token punctuation">)</span> </span>
<span class="line">            <span class="token keyword">continue</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">        <span class="token comment">// ä½¿ç”¨ setns() ç³»ç»Ÿè°ƒç”¨åŠ å…¥ namespace</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setns</span><span class="token punctuation">(</span>ns<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> nstype<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EPERM<span class="token punctuation">)</span> </span>
<span class="line">                <span class="token keyword">continue</span><span class="token punctuation">;</span>  <span class="token comment">// è·³è¿‡æƒé™é”™è¯¯</span></span>
<span class="line">            <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to setns into %s namespace&quot;</span><span class="token punctuation">,</span> ns<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        joined <span class="token operator">|=</span> nstype<span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// ç”¨æˆ·å‘½åç©ºé—´ç‰¹æ®Šå¤„ç†</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>nstype <span class="token operator">==</span> CLONE_NEWUSER<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setresuid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to become root in user namespace&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setresgid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  </span>
<span class="line">                <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to become root in user namespace&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> joined<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-é˜¶æ®µ2-æœ€ç»ˆ-init-è¿›ç¨‹-stage-init" tabindex="-1"><a class="header-anchor" href="#_3-3-é˜¶æ®µ2-æœ€ç»ˆ-init-è¿›ç¨‹-stage-init"><span>3.3 é˜¶æ®µ2: æœ€ç»ˆ init è¿›ç¨‹ (STAGE_INIT)</span></a></h3><p><strong>ä¸»è¦èŒè´£</strong>: è¿›ç¨‹å±æ€§è®¾ç½®ï¼Œè¿”å› Go è¿è¡Œæ—¶</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// libcontainer/nsenter/nsexec.c:1184</span></span>
<span class="line"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">init_stage</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">nlconfig_t</span> <span class="token operator">*</span>config<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. åˆ›å»ºæ–°çš„è¿›ç¨‹ä¼šè¯</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;setsid failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. è®¾ç½®ç”¨æˆ·å’Œç»„ ID (å¦‚æœä¸åœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>cloneflags <span class="token operator">&amp;</span> CLONE_NEWUSER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setresuid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to setresuid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setresgid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to setresgid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. è®¾ç½® OOM åˆ†æ•°è°ƒæ•´</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>oom_score_adj <span class="token operator">&amp;&amp;</span> <span class="token function">strlen</span><span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>oom_score_adj<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">write_file</span><span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>oom_score_adj<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>oom_score_adj<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                  <span class="token string">&quot;/proc/self/oom_score_adj&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶æè¿°ç¬¦</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>syncpipe <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">close</span><span class="token punctuation">(</span>syncpipe<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        syncpipe <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 5. è®¾ç½®è¿›ç¨‹ä¸ºä¸å¯è½¬å‚¨ (å®‰å…¨æªæ–½)  </span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token operator">-&gt;</span>namespaces<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">prctl</span><span class="token punctuation">(</span>PR_SET_DUMPABLE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token function">bail</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set process as non-dumpable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 6. è¿”å›åˆ° Go è¿è¡Œæ—¶ç»§ç»­åˆå§‹åŒ–</span></span>
<span class="line">    <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// æ§åˆ¶æƒè¿”å› Go</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-go-è¿è¡Œæ—¶é›†æˆ" tabindex="-1"><a class="header-anchor" href="#_4-go-è¿è¡Œæ—¶é›†æˆ"><span>4. Go è¿è¡Œæ—¶é›†æˆ</span></a></h2><h3 id="_4-1-æ ‡å‡†åˆå§‹åŒ–æµç¨‹" tabindex="-1"><a class="header-anchor" href="#_4-1-æ ‡å‡†åˆå§‹åŒ–æµç¨‹"><span>4.1 æ ‡å‡†åˆå§‹åŒ–æµç¨‹</span></a></h3><p>å½“ C ä»£ç å®Œæˆ namespace è®¾ç½®åï¼Œæ§åˆ¶æƒè¿”å›åˆ° Go è¿è¡Œæ—¶ï¼š</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/standard_init_linux.go:52</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>linuxStandardInit<span class="token punctuation">)</span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. Keyring è®¾ç½®</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span>l<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>NoNewKeyring <span class="token punctuation">{</span></span>
<span class="line">        ringname<span class="token punctuation">,</span> keepperms<span class="token punctuation">,</span> newperms <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">getSessionRingParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// åŠ å…¥ä¼šè¯ keyringï¼Œè®¾ç½® SELinux æ ‡ç­¾</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> keys<span class="token punctuation">.</span><span class="token function">JoinSessionKeyring</span><span class="token punctuation">(</span>ringname<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. ç½‘ç»œé…ç½® (NEWNET namespace)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setupNetwork</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setupRoute</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. æ ¹æ–‡ä»¶ç³»ç»Ÿå‡†å¤‡ (NEWNS namespace)  </span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">prepareRootfs</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>pipe<span class="token punctuation">,</span> l<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. æŒ‚è½½å‘½åç©ºé—´å¤„ç†</span></span>
<span class="line">    <span class="token keyword">if</span> l<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Namespaces<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>configs<span class="token punctuation">.</span>NEWNS<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">finalizeRootfs</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 5. UTS namespace - è®¾ç½®ä¸»æœºå</span></span>
<span class="line">    <span class="token keyword">if</span> hostname <span class="token operator">:=</span> l<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Hostname<span class="token punctuation">;</span> hostname <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Sethostname</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>hostname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 6. æœ€ç»ˆå‘½åç©ºé—´é…ç½®</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">finalizeNamespace</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 7. æ‰§è¡Œç”¨æˆ·ç¨‹åº</span></span>
<span class="line">    name<span class="token punctuation">,</span> err <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">LookPath</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> system<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> l<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Args<span class="token punctuation">,</span> os<span class="token punctuation">.</span><span class="token function">Environ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-ç½‘ç»œé…ç½®ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#_4-2-ç½‘ç»œé…ç½®ç¤ºä¾‹"><span>4.2 ç½‘ç»œé…ç½®ç¤ºä¾‹</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/standard_init_linux.go:96</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setupNetwork</span><span class="token punctuation">(</span>config <span class="token operator">*</span>initConfig<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> config <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Networks <span class="token punctuation">{</span></span>
<span class="line">        strategy<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getStrategy</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Type<span class="token punctuation">)</span>  </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> strategy<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>Network<span class="token punctuation">)</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>Pid<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-ä¸»æœºåè®¾ç½®ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#_4-3-ä¸»æœºåè®¾ç½®ç¤ºä¾‹"><span>4.3 ä¸»æœºåè®¾ç½®ç¤ºä¾‹</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// UTS namespace ä¸­çš„ä¸»æœºåè®¾ç½®</span></span>
<span class="line"><span class="token keyword">if</span> hostname <span class="token operator">:=</span> l<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Hostname<span class="token punctuation">;</span> hostname <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Sethostname</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>hostname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set hostname %q: %w&quot;</span><span class="token punctuation">,</span> hostname<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// åŸŸåè®¾ç½®</span></span>
<span class="line"><span class="token keyword">if</span> domainname <span class="token operator">:=</span> l<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Domainname<span class="token punctuation">;</span> domainname <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Setdomainname</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>domainname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set domainname %q: %w&quot;</span><span class="token punctuation">,</span> domainname<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-namespace-åˆ›å»ºé¡ºåºå’Œä¾èµ–å…³ç³»" tabindex="-1"><a class="header-anchor" href="#_5-namespace-åˆ›å»ºé¡ºåºå’Œä¾èµ–å…³ç³»"><span>5. Namespace åˆ›å»ºé¡ºåºå’Œä¾èµ–å…³ç³»</span></a></h2><h3 id="_5-1-åˆ›å»ºé¡ºåºåŸåˆ™" tabindex="-1"><a class="header-anchor" href="#_5-1-åˆ›å»ºé¡ºåºåŸåˆ™"><span>5.1 åˆ›å»ºé¡ºåºåŸåˆ™</span></a></h3><p>runc ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹é¡ºåºå¤„ç† namespaceï¼š</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/configs/namespaces_linux.go:123</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NamespaceTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>NamespaceType <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>NamespaceType<span class="token punctuation">{</span></span>
<span class="line">        NEWUSER<span class="token punctuation">,</span>   <span class="token comment">// 1. ç”¨æˆ·å‘½åç©ºé—´ - å¿…é¡»æœ€å…ˆ</span></span>
<span class="line">        NEWIPC<span class="token punctuation">,</span>    <span class="token comment">// 2. IPC å‘½åç©ºé—´</span></span>
<span class="line">        NEWUTS<span class="token punctuation">,</span>    <span class="token comment">// 3. UTS å‘½åç©ºé—´  </span></span>
<span class="line">        NEWNET<span class="token punctuation">,</span>    <span class="token comment">// 4. ç½‘ç»œå‘½åç©ºé—´</span></span>
<span class="line">        NEWPID<span class="token punctuation">,</span>    <span class="token comment">// 5. PID å‘½åç©ºé—´</span></span>
<span class="line">        NEWNS<span class="token punctuation">,</span>     <span class="token comment">// 6. æŒ‚è½½å‘½åç©ºé—´</span></span>
<span class="line">        NEWCGROUP<span class="token punctuation">,</span> <span class="token comment">// 7. Cgroup å‘½åç©ºé—´</span></span>
<span class="line">        NEWTIME<span class="token punctuation">,</span>   <span class="token comment">// 8. æ—¶é—´å‘½åç©ºé—´</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-ä¾èµ–å…³ç³»è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#_5-2-ä¾èµ–å…³ç³»è¯¦è§£"><span>5.2 ä¾èµ–å…³ç³»è¯¦è§£</span></a></h3><h4 id="ç”¨æˆ·å‘½åç©ºé—´çš„ç‰¹æ®Šåœ°ä½" tabindex="-1"><a class="header-anchor" href="#ç”¨æˆ·å‘½åç©ºé—´çš„ç‰¹æ®Šåœ°ä½"><span>ç”¨æˆ·å‘½åç©ºé—´çš„ç‰¹æ®Šåœ°ä½</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">NEWUSER (ç”¨æˆ·å‘½åç©ºé—´)</span>
<span class="line">    â”‚</span>
<span class="line">    â”‚ å¿…é¡»é¦–å…ˆåˆ›å»ºï¼Œå› ä¸ºï¼š</span>
<span class="line">    â”‚ 1. å½±å“å…¶ä»– namespace çš„æƒé™æ£€æŸ¥</span>
<span class="line">    â”‚ 2. åˆ›å»ºåæ‰èƒ½è¿›è¡Œ ID æ˜ å°„</span>
<span class="line">    â”‚ 3. å…¶ä»– namespace çš„åˆ›å»ºå¯èƒ½éœ€è¦ç›¸åº”æƒé™</span>
<span class="line">    â”‚</span>
<span class="line">    â”œâ”€â”€ NEWIPC (éœ€è¦ IPC æƒé™)</span>
<span class="line">    â”œâ”€â”€ NEWUTS (éœ€è¦ SYS_ADMIN æƒé™)</span>
<span class="line">    â”œâ”€â”€ NEWNET (éœ€è¦ NET_ADMIN æƒé™)  </span>
<span class="line">    â”œâ”€â”€ NEWPID (éœ€è¦ SYS_ADMIN æƒé™)</span>
<span class="line">    â”œâ”€â”€ NEWNS  (éœ€è¦ SYS_ADMIN æƒé™)</span>
<span class="line">    â””â”€â”€ NEWCGROUP (éœ€è¦ SYS_ADMIN æƒé™)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æƒé™æ£€æŸ¥é€»è¾‘" tabindex="-1"><a class="header-anchor" href="#æƒé™æ£€æŸ¥é€»è¾‘"><span>æƒé™æ£€æŸ¥é€»è¾‘</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// æ£€æŸ¥åˆ›å»º namespace æ‰€éœ€çš„æƒé™</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">checkNamespacePermissions</span><span class="token punctuation">(</span>ns NamespaceType<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">switch</span> ns <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> NEWUSER<span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// ç”¨æˆ·å‘½åç©ºé—´ä¸éœ€è¦ç‰¹æ®Šæƒé™</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token keyword">case</span> NEWNET<span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// éœ€è¦ CAP_NET_ADMIN æˆ–åœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">checkCapability</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>CAP_NET_ADMIN<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">case</span> NEWNS<span class="token punctuation">,</span> NEWUTS<span class="token punctuation">,</span> NEWPID<span class="token punctuation">,</span> NEWIPC<span class="token punctuation">,</span> NEWCGROUP<span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// éœ€è¦ CAP_SYS_ADMIN æˆ–åœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">checkCapability</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>CAP_SYS_ADMIN<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-åŒæ­¥æœºåˆ¶è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#_5-3-åŒæ­¥æœºåˆ¶è¯¦è§£"><span>5.3 åŒæ­¥æœºåˆ¶è¯¦è§£</span></a></h3><h4 id="åŒæ­¥æ¶ˆæ¯ç±»å‹" tabindex="-1"><a class="header-anchor" href="#åŒæ­¥æ¶ˆæ¯ç±»å‹"><span>åŒæ­¥æ¶ˆæ¯ç±»å‹</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// libcontainer/nsenter/nsexec.c:60</span></span>
<span class="line"><span class="token keyword">enum</span> <span class="token class-name">sync_t</span> <span class="token punctuation">{</span></span>
<span class="line">    SYNC_USERMAP_PLS <span class="token operator">=</span> <span class="token number">0x40</span><span class="token punctuation">,</span>      <span class="token comment">// è¯·æ±‚çˆ¶è¿›ç¨‹è¿›è¡Œç”¨æˆ·æ˜ å°„</span></span>
<span class="line">    SYNC_USERMAP_ACK <span class="token operator">=</span> <span class="token number">0x41</span><span class="token punctuation">,</span>      <span class="token comment">// ç”¨æˆ·æ˜ å°„å®Œæˆç¡®è®¤</span></span>
<span class="line">    SYNC_RECVPID_PLS <span class="token operator">=</span> <span class="token number">0x42</span><span class="token punctuation">,</span>      <span class="token comment">// å‘é€ PID è¯·æ±‚</span></span>
<span class="line">    SYNC_RECVPID_ACK <span class="token operator">=</span> <span class="token number">0x43</span><span class="token punctuation">,</span>      <span class="token comment">// PID æ¥æ”¶ç¡®è®¤  </span></span>
<span class="line">    SYNC_GRANDCHILD <span class="token operator">=</span> <span class="token number">0x44</span><span class="token punctuation">,</span>       <span class="token comment">// å­™è¿›ç¨‹å°±ç»ªä¿¡å·</span></span>
<span class="line">    SYNC_CHILD_FINISH <span class="token operator">=</span> <span class="token number">0x45</span><span class="token punctuation">,</span>     <span class="token comment">// å­è¿›ç¨‹å®Œæˆä¿¡å·</span></span>
<span class="line">    SYNC_TIMEOFFSETS_PLS <span class="token operator">=</span> <span class="token number">0x46</span><span class="token punctuation">,</span>  <span class="token comment">// è¯·æ±‚è®¾ç½®æ—¶é—´åç§»</span></span>
<span class="line">    SYNC_TIMEOFFSETS_ACK <span class="token operator">=</span> <span class="token number">0x47</span><span class="token punctuation">,</span>  <span class="token comment">// æ—¶é—´åç§»è®¾ç½®å®Œæˆ</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="åŒæ­¥æµç¨‹å›¾" tabindex="-1"><a class="header-anchor" href="#åŒæ­¥æµç¨‹å›¾"><span>åŒæ­¥æµç¨‹å›¾</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">çˆ¶è¿›ç¨‹ (STAGE_PARENT)          ä¸­é—´è¿›ç¨‹ (STAGE_CHILD)           æœ€ç»ˆè¿›ç¨‹ (STAGE_INIT)</span>
<span class="line">      â”‚                              â”‚                               â”‚</span>
<span class="line">      â”‚â—„â”€â”€â”€â”€â”€â”€ SYNC_RECVPID_PLS â”€â”€â”€â”€â”€â”¤                               â”‚</span>
<span class="line">      â”‚                              â”‚                               â”‚</span>
<span class="line">      â”‚â”€â”€â”€ update_uidmap/gidmap â”€â”€â”€â”€ â”‚                               â”‚</span>
<span class="line">      â”‚                              â”‚                               â”‚  </span>
<span class="line">      â”‚â”€â”€â”€â”€â”€â”€ SYNC_USERMAP_ACK â”€â”€â”€â”€â”€â–ºâ”‚                               â”‚</span>
<span class="line">      â”‚                              â”‚                               â”‚</span>
<span class="line">      â”‚                              â”‚â”€â”€â”€ unshare/join namespaces â”€â”€â”‚</span>
<span class="line">      â”‚                              â”‚                               â”‚</span>
<span class="line">      â”‚                              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ fork() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚</span>
<span class="line">      â”‚                              â”‚                               â”‚</span>
<span class="line">      â”‚â—„â”€â”€â”€â”€ SYNC_GRANDCHILD â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚</span>
<span class="line">      â”‚                              â”‚                               â”‚</span>
<span class="line">      â”‚â”€â”€â”€â”€â”€â”€ SYNC_CHILD_FINISH â”€â”€â”€â”€â–ºâ”‚                               â”‚</span>
<span class="line">      â”‚                              â”‚                               â”‚</span>
<span class="line">      â”‚                              â”‚ exit                          â”‚ init...</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-é«˜çº§ç‰¹æ€§å’Œä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_6-é«˜çº§ç‰¹æ€§å’Œä¼˜åŒ–"><span>6. é«˜çº§ç‰¹æ€§å’Œä¼˜åŒ–</span></a></h2><h3 id="_6-1-æ—¶é—´å‘½åç©ºé—´å¤„ç†" tabindex="-1"><a class="header-anchor" href="#_6-1-æ—¶é—´å‘½åç©ºé—´å¤„ç†"><span>6.1 æ—¶é—´å‘½åç©ºé—´å¤„ç†</span></a></h3><p>æ—¶é—´å‘½åç©ºé—´æ˜¯è¾ƒæ–°çš„åŠŸèƒ½ (Linux 5.6+)ï¼Œå…è®¸å®¹å™¨æœ‰ä¸åŒçš„ç³»ç»Ÿæ—¶é—´ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// è®¾ç½®æ—¶é—´åç§»</span></span>
<span class="line"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">update_time_offsets</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>offsets<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">char</span> <span class="token operator">*</span>saveptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">char</span> <span class="token operator">*</span>offset_str <span class="token operator">=</span> <span class="token function">strtok_r</span><span class="token punctuation">(</span>offsets<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>saveptr<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>offset_str <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// è§£æåç§»æ ¼å¼: &quot;monotonic 1000000000 0&quot;  </span></span>
<span class="line">        <span class="token keyword">char</span> <span class="token operator">*</span>clock_id <span class="token operator">=</span> <span class="token function">strtok_r</span><span class="token punctuation">(</span>offset_str<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>saveptr<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">char</span> <span class="token operator">*</span>sec_str <span class="token operator">=</span> <span class="token function">strtok_r</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>saveptr<span class="token punctuation">)</span><span class="token punctuation">;</span>  </span>
<span class="line">        <span class="token keyword">char</span> <span class="token operator">*</span>nsec_str <span class="token operator">=</span> <span class="token function">strtok_r</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>saveptr<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// å†™å…¥ /proc/pid/timens_offsets</span></span>
<span class="line">        <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open_proc_file</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token string">&quot;timens_offsets&quot;</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">dprintf</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">&quot;%s %s %s\\n&quot;</span><span class="token punctuation">,</span> clock_id<span class="token punctuation">,</span> sec_str<span class="token punctuation">,</span> nsec_str<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        offset_str <span class="token operator">=</span> <span class="token function">strtok_r</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>saveptr<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-rootless-å®¹å™¨æ”¯æŒ" tabindex="-1"><a class="header-anchor" href="#_6-2-rootless-å®¹å™¨æ”¯æŒ"><span>6.2 Rootless å®¹å™¨æ”¯æŒ</span></a></h3><p>Rootless æ¨¡å¼å…è®¸æ™®é€šç”¨æˆ·åˆ›å»ºå®¹å™¨ï¼š</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// æ£€æŸ¥æ˜¯å¦è¿è¡Œåœ¨ rootless æ¨¡å¼</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">isRootless</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> os<span class="token punctuation">.</span><span class="token function">Geteuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// rootless æ¨¡å¼çš„ç‰¹æ®Šå¤„ç†</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">handleRootlessNamespaces</span><span class="token punctuation">(</span>namespaces Namespaces<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">isRootless</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// rootless æ¨¡å¼å¿…é¡»åŒ…å«ç”¨æˆ·å‘½åç©ºé—´</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span>namespaces<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>NEWUSER<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;rootless containers require user namespaces&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æŸäº›åŠŸèƒ½åœ¨ rootless æ¨¡å¼ä¸‹å—é™</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ns <span class="token operator">:=</span> <span class="token keyword">range</span> namespaces <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">switch</span> ns<span class="token punctuation">.</span>Type <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">case</span> NEWNET<span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment">// ç½‘ç»œå‘½åç©ºé—´åœ¨ rootless æ¨¡å¼ä¸‹åŠŸèƒ½å—é™</span></span>
<span class="line">            logrus<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">&quot;network namespace has limited functionality in rootless mode&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-æ€§èƒ½ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_6-3-æ€§èƒ½ä¼˜åŒ–"><span>6.3 æ€§èƒ½ä¼˜åŒ–</span></a></h3><h4 id="æ‰¹é‡-namespace-æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#æ‰¹é‡-namespace-æ“ä½œ"><span>æ‰¹é‡ Namespace æ“ä½œ</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// æ‰¹é‡åˆ›å»ºå¤šä¸ª namespaceï¼Œå‡å°‘ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">create_namespaces_batch</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> clone_flags<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ä¸€æ¬¡ unshare è°ƒç”¨åˆ›å»ºå¤šä¸ª namespace</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unshare</span><span class="token punctuation">(</span>clone_flags<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// å¦‚æœæ‰¹é‡åˆ›å»ºå¤±è´¥ï¼Œé€ä¸ªå°è¯•</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">uint32_t</span> flag <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> i<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>clone_flags <span class="token operator">&amp;</span> flag<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unshare</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">!=</span> EINVAL<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ–‡ä»¶æè¿°ç¬¦ç¼“å­˜" tabindex="-1"><a class="header-anchor" href="#æ–‡ä»¶æè¿°ç¬¦ç¼“å­˜"><span>æ–‡ä»¶æè¿°ç¬¦ç¼“å­˜</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// ç¼“å­˜ namespace æ–‡ä»¶æè¿°ç¬¦ï¼Œé¿å…é‡å¤æ‰“å¼€</span></span>
<span class="line"><span class="token keyword">static</span> <span class="token keyword">int</span> ns_fd_cache<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">get_namespace_fd</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ns_path<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ£€æŸ¥ç¼“å­˜</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>ns_fd_cache<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">char</span> fd_path<span class="token punctuation">[</span>PATH_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">snprintf</span><span class="token punctuation">(</span>fd_path<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>fd_path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;/proc/self/fd/%d&quot;</span><span class="token punctuation">,</span> ns_fd_cache<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token function">readlink</span><span class="token punctuation">(</span>fd_path<span class="token punctuation">)</span><span class="token punctuation">,</span> ns_path<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> ns_fd_cache<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ‰“å¼€å¹¶ç¼“å­˜</span></span>
<span class="line">    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>ns_path<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// æ‰¾ç©ºä½ç¼“å­˜</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>ns_fd_cache<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                ns_fd_cache<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> fd<span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> fd<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-è°ƒè¯•å’Œæ•…éšœæ’é™¤" tabindex="-1"><a class="header-anchor" href="#_7-è°ƒè¯•å’Œæ•…éšœæ’é™¤"><span>7. è°ƒè¯•å’Œæ•…éšœæ’é™¤</span></a></h2><h3 id="_7-1-å¸¸è§é—®é¢˜è¯Šæ–­" tabindex="-1"><a class="header-anchor" href="#_7-1-å¸¸è§é—®é¢˜è¯Šæ–­"><span>7.1 å¸¸è§é—®é¢˜è¯Šæ–­</span></a></h3><h4 id="æƒé™é—®é¢˜è¯Šæ–­" tabindex="-1"><a class="header-anchor" href="#æƒé™é—®é¢˜è¯Šæ–­"><span>æƒé™é—®é¢˜è¯Šæ–­</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># æ£€æŸ¥ç”¨æˆ·å‘½åç©ºé—´æ”¯æŒ</span></span>
<span class="line">$ <span class="token function">cat</span> /proc/sys/user/max_user_namespaces</span>
<span class="line"><span class="token number">65536</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥å½“å‰è¿›ç¨‹çš„ namespace</span></span>
<span class="line">$ <span class="token function">ls</span> <span class="token parameter variable">-la</span> /proc/self/ns/</span>
<span class="line">lrwxrwxrwx <span class="token number">1</span> user user <span class="token number">0</span> Jan  <span class="token number">1</span> <span class="token number">10</span>:00 cgroup -<span class="token operator">&gt;</span> <span class="token string">&#39;cgroup:[4026531835]&#39;</span></span>
<span class="line">lrwxrwxrwx <span class="token number">1</span> user user <span class="token number">0</span> Jan  <span class="token number">1</span> <span class="token number">10</span>:00 ipc -<span class="token operator">&gt;</span> <span class="token string">&#39;ipc:[4026531839]&#39;</span></span>
<span class="line">lrwxrwxrwx <span class="token number">1</span> user user <span class="token number">0</span> Jan  <span class="token number">1</span> <span class="token number">10</span>:00 mnt -<span class="token operator">&gt;</span> <span class="token string">&#39;mnt:[4026531840]&#39;</span></span>
<span class="line">lrwxrwxrwx <span class="token number">1</span> user user <span class="token number">0</span> Jan  <span class="token number">1</span> <span class="token number">10</span>:00 net -<span class="token operator">&gt;</span> <span class="token string">&#39;net:[4026531992]&#39;</span></span>
<span class="line">lrwxrwxrwx <span class="token number">1</span> user user <span class="token number">0</span> Jan  <span class="token number">1</span> <span class="token number">10</span>:00 pid -<span class="token operator">&gt;</span> <span class="token string">&#39;pid:[4026531836]&#39;</span></span>
<span class="line">lrwxrwxrwx <span class="token number">1</span> user user <span class="token number">0</span> Jan  <span class="token number">1</span> <span class="token number">10</span>:00 user -<span class="token operator">&gt;</span> <span class="token string">&#39;user:[4026531837]&#39;</span></span>
<span class="line">lrwxrwxrwx <span class="token number">1</span> user user <span class="token number">0</span> Jan  <span class="token number">1</span> <span class="token number">10</span>:00 uts -<span class="token operator">&gt;</span> <span class="token string">&#39;uts:[4026531838]&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥ç”¨æˆ·æ˜ å°„</span></span>
<span class="line">$ <span class="token function">cat</span> /proc/1234/uid_map</span>
<span class="line">         <span class="token number">0</span>       <span class="token number">1000</span>          <span class="token number">1</span></span>
<span class="line">         <span class="token number">1</span>       <span class="token number">1001</span>      <span class="token number">65534</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="è°ƒè¯•ä¿¡æ¯æ”¶é›†" tabindex="-1"><a class="header-anchor" href="#è°ƒè¯•ä¿¡æ¯æ”¶é›†"><span>è°ƒè¯•ä¿¡æ¯æ”¶é›†</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// æ·»åŠ  namespace è°ƒè¯•ä¿¡æ¯</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">debugNamespaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    nsTypes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;cgroup&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ipc&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mnt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;net&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pid&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;uts&quot;</span><span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Current namespace information:&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> nsType <span class="token operator">:=</span> <span class="token keyword">range</span> nsTypes <span class="token punctuation">{</span></span>
<span class="line">        nsPath <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;/proc/self/ns/%s&quot;</span><span class="token punctuation">,</span> nsType<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> target<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Readlink</span><span class="token punctuation">(</span>nsPath<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;  %s: %s\\n&quot;</span><span class="token punctuation">,</span> nsType<span class="token punctuation">,</span> target<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;  %s: error reading (%v)\\n&quot;</span><span class="token punctuation">,</span> nsType<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ£€æŸ¥ç”¨æˆ·æ˜ å°„</span></span>
<span class="line">    <span class="token keyword">if</span> data<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token string">&quot;/proc/self/uid_map&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;UID mapping:\\n%s&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> data<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token string">&quot;/proc/self/gid_map&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;GID mapping:\\n%s&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-æ€§èƒ½åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_7-2-æ€§èƒ½åˆ†æ"><span>7.2 æ€§èƒ½åˆ†æ</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># ä½¿ç”¨ strace è·Ÿè¸ªç³»ç»Ÿè°ƒç”¨</span></span>
<span class="line">$ <span class="token function">strace</span> <span class="token parameter variable">-f</span> <span class="token parameter variable">-e</span> <span class="token assign-left variable">trace</span><span class="token operator">=</span>clone,unshare,setns runc create mycontainer</span>
<span class="line"></span>
<span class="line"><span class="token comment"># ä½¿ç”¨ perf åˆ†ææ€§èƒ½</span></span>
<span class="line">$ perf record runc run mycontainer</span>
<span class="line">$ perf report</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥ namespace åˆ›å»ºæ—¶é—´</span></span>
<span class="line">$ <span class="token function">time</span> runc create mycontainer</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-å®è·µç»ƒä¹ " tabindex="-1"><a class="header-anchor" href="#_8-å®è·µç»ƒä¹ "><span>8. å®è·µç»ƒä¹ </span></a></h2><h3 id="_8-1-æ‰‹åŠ¨åˆ›å»º-namespace" tabindex="-1"><a class="header-anchor" href="#_8-1-æ‰‹åŠ¨åˆ›å»º-namespace"><span>8.1 æ‰‹åŠ¨åˆ›å»º Namespace</span></a></h3><p>ä½“éªŒä¸åŒç±»å‹çš„ namespace éš”ç¦»æ•ˆæœï¼š</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># ç»ƒä¹ 1ï¼šåˆ›å»º PID namespace</span></span>
<span class="line"><span class="token function">sudo</span> unshare <span class="token parameter variable">--pid</span> <span class="token parameter variable">--fork</span> --mount-proc /bin/bash</span>
<span class="line"><span class="token comment"># åœ¨æ–° shell ä¸­æ‰§è¡Œ:</span></span>
<span class="line"><span class="token function">ps</span> aux  <span class="token comment"># åªèƒ½çœ‹åˆ°å½“å‰ namespace çš„è¿›ç¨‹</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç»ƒä¹ 2ï¼šåˆ›å»ºç½‘ç»œ namespace  </span></span>
<span class="line"><span class="token function">sudo</span> unshare <span class="token parameter variable">--net</span> /bin/bash</span>
<span class="line"><span class="token function">ip</span> <span class="token function">link</span> show  <span class="token comment"># åªèƒ½çœ‹åˆ° loopback æ¥å£</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç»ƒä¹ 3ï¼šåˆ›å»ºæŒ‚è½½ namespace</span></span>
<span class="line"><span class="token function">sudo</span> unshare <span class="token parameter variable">--mount</span> /bin/bash</span>
<span class="line"><span class="token function">mount</span> <span class="token parameter variable">-t</span> tmpfs tmpfs /tmp</span>
<span class="line"><span class="token function">ls</span> /tmp  <span class="token comment"># åªåœ¨å½“å‰ namespace ä¸­å¯è§</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç»ƒä¹ 4ï¼šåˆ›å»º UTS namespace</span></span>
<span class="line"><span class="token function">sudo</span> unshare <span class="token parameter variable">--uts</span> /bin/bash  </span>
<span class="line"><span class="token function">hostname</span> container-test</span>
<span class="line"><span class="token function">hostname</span>  <span class="token comment"># åªåœ¨å½“å‰ namespace ä¸­ç”Ÿæ•ˆ</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-è‡ªå®šä¹‰-namespace-é…ç½®" tabindex="-1"><a class="header-anchor" href="#_8-2-è‡ªå®šä¹‰-namespace-é…ç½®"><span>8.2 è‡ªå®šä¹‰ Namespace é…ç½®</span></a></h3><p>ä¿®æ”¹å®¹å™¨é…ç½®ä½“éªŒä¸åŒçš„ namespace ç»„åˆï¼š</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;ociVersion&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.2&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;process&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;root&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rootfs&quot;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;linux&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;namespaces&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pid&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;network&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> </span>
<span class="line">      <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mount&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;uts&quot;</span><span class="token punctuation">}</span></span>
<span class="line">      <span class="token comment">// æ•…æ„çœç•¥ user namespaceï¼Œè§‚å¯Ÿæƒé™å˜åŒ–</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-3-namespace-æ€§èƒ½æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#_8-3-namespace-æ€§èƒ½æµ‹è¯•"><span>8.3 Namespace æ€§èƒ½æµ‹è¯•</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># æµ‹è¯•ä¸åŒ namespace ç»„åˆçš„åˆ›å»ºæ—¶é—´</span></span>
<span class="line"></span>
<span class="line"><span class="token function-name function">test_namespace_performance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin class-name">local</span> <span class="token assign-left variable">namespaces</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$1</span>&quot;</span></span>
<span class="line">    <span class="token builtin class-name">local</span> <span class="token assign-left variable">desc</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$2</span>&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;Testing <span class="token variable">$desc</span>...&quot;</span></span>
<span class="line">    <span class="token function">time</span> <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">..</span><span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">        <span class="token function">sudo</span> unshare <span class="token variable">$namespaces</span> /bin/true</span>
<span class="line">    <span class="token keyword">done</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æµ‹è¯•å„ç§ç»„åˆ</span></span>
<span class="line">test_namespace_performance <span class="token string">&quot;--pid&quot;</span> <span class="token string">&quot;PID namespace only&quot;</span></span>
<span class="line">test_namespace_performance <span class="token string">&quot;--pid --net&quot;</span> <span class="token string">&quot;PID + Network&quot;</span></span>
<span class="line">test_namespace_performance <span class="token string">&quot;--pid --net --mount --uts --ipc&quot;</span> <span class="token string">&quot;All common namespaces&quot;</span></span>
<span class="line">test_namespace_performance <span class="token string">&quot;--user --pid --net --mount --uts --ipc&quot;</span> <span class="token string">&quot;Including user namespace&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-4-è°ƒè¯•-runc-namespace-åˆ›å»º" tabindex="-1"><a class="header-anchor" href="#_8-4-è°ƒè¯•-runc-namespace-åˆ›å»º"><span>8.4 è°ƒè¯• runc Namespace åˆ›å»º</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># å¯ç”¨ runc è°ƒè¯•æ—¥å¿—</span></span>
<span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">RUNC_DEBUG</span><span class="token operator">=</span><span class="token number">1</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># è·Ÿè¸ª namespace åˆ›å»ºè¿‡ç¨‹</span></span>
<span class="line"><span class="token function">strace</span> <span class="token parameter variable">-f</span> <span class="token parameter variable">-e</span> <span class="token assign-left variable">trace</span><span class="token operator">=</span>clone,unshare,setns,openat <span class="token parameter variable">-o</span> /tmp/runc.strace <span class="token punctuation">\\</span></span>
<span class="line">    runc create mycontainer</span>
<span class="line"></span>
<span class="line"><span class="token comment"># åˆ†æç»“æœ</span></span>
<span class="line"><span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">&quot;(clone|unshare|setns)&quot;</span> /tmp/runc.strace <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-20</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-æ€è€ƒé¢˜" tabindex="-1"><a class="header-anchor" href="#_9-æ€è€ƒé¢˜"><span>9. æ€è€ƒé¢˜</span></a></h2><h3 id="_9-1-æ¶æ„è®¾è®¡æ€è€ƒ" tabindex="-1"><a class="header-anchor" href="#_9-1-æ¶æ„è®¾è®¡æ€è€ƒ"><span>9.1 æ¶æ„è®¾è®¡æ€è€ƒ</span></a></h3><ol><li><p><strong>ä¸‰é˜¶æ®µè®¾è®¡çš„å¿…è¦æ€§</strong>ï¼šä¸ºä»€ä¹ˆ runc éœ€è¦ä¸‰é˜¶æ®µè¿›ç¨‹åˆ›å»ºï¼Ÿèƒ½å¦ç®€åŒ–ä¸ºä¸¤é˜¶æ®µï¼Ÿ</p></li><li><p><strong>ç”¨æˆ·å‘½åç©ºé—´ä¼˜å…ˆçº§</strong>ï¼šä¸ºä»€ä¹ˆç”¨æˆ·å‘½åç©ºé—´å¿…é¡»æœ€å…ˆåˆ›å»ºï¼Ÿå¦‚æœé¡ºåºé”™è¯¯ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p></li><li><p><strong>åŒæ­¥æœºåˆ¶å¤æ‚æ€§</strong>ï¼šçˆ¶å­è¿›ç¨‹ä¹‹é—´çš„åŒæ­¥ä¸ºä»€ä¹ˆè¿™ä¹ˆå¤æ‚ï¼Ÿæœ‰æ²¡æœ‰æ›´ç®€å•çš„æ–¹æ¡ˆï¼Ÿ</p></li></ol><h3 id="_9-2-æŠ€æœ¯å®ç°æ€è€ƒ" tabindex="-1"><a class="header-anchor" href="#_9-2-æŠ€æœ¯å®ç°æ€è€ƒ"><span>9.2 æŠ€æœ¯å®ç°æ€è€ƒ</span></a></h3><ol start="4"><li><p><strong>C/Go æ··åˆç¼–ç¨‹</strong>ï¼šä¸ºä»€ä¹ˆåº•å±‚ namespace æ“ä½œç”¨ C å®ç°ï¼Œè€Œä¸æ˜¯çº¯ Goï¼Ÿ</p></li><li><p><strong>é”™è¯¯å¤„ç†ç­–ç•¥</strong>ï¼šå¦‚æœæŸä¸ª namespace åˆ›å»ºå¤±è´¥ï¼Œrunc å¦‚ä½•è¿›è¡Œæ¸…ç†ï¼Ÿ</p></li><li><p><strong>æ€§èƒ½ä¼˜åŒ–ç©ºé—´</strong>ï¼šå½“å‰çš„å®ç°æœ‰å“ªäº›æ€§èƒ½ç“¶é¢ˆï¼Ÿå¦‚ä½•ä¼˜åŒ–ï¼Ÿ</p></li></ol><h3 id="_9-3-å®‰å…¨æ€§æ€è€ƒ" tabindex="-1"><a class="header-anchor" href="#_9-3-å®‰å…¨æ€§æ€è€ƒ"><span>9.3 å®‰å…¨æ€§æ€è€ƒ</span></a></h3><ol start="7"><li><p><strong>æƒé™é€ƒé€¸é£é™©</strong>ï¼šuser namespace çš„ ID æ˜ å°„æœ‰ä»€ä¹ˆå®‰å…¨é£é™©ï¼Ÿ</p></li><li><p><strong>éš”ç¦»å®Œæ•´æ€§</strong>ï¼šå¦‚ä½•ç¡®ä¿å®¹å™¨æ— æ³•çœ‹åˆ°æˆ–å½±å“å®¿ä¸»æœºçš„å…¶ä»– namespaceï¼Ÿ</p></li><li><p><strong>Rootless å®‰å…¨æ€§</strong>ï¼šrootless å®¹å™¨æ˜¯å¦çœŸçš„æ›´å®‰å…¨ï¼Ÿæœ‰ä»€ä¹ˆå±€é™æ€§ï¼Ÿ</p></li></ol><h3 id="_9-4-æ‰©å±•æ€§æ€è€ƒ" tabindex="-1"><a class="header-anchor" href="#_9-4-æ‰©å±•æ€§æ€è€ƒ"><span>9.4 æ‰©å±•æ€§æ€è€ƒ</span></a></h3><ol start="10"><li><strong>æ–° Namespace æ”¯æŒ</strong>ï¼šå¦‚æœ Linux å†…æ ¸å¢åŠ æ–°çš„ namespace ç±»å‹ï¼Œrunc éœ€è¦å¦‚ä½•ä¿®æ”¹ï¼Ÿ</li></ol><h2 id="_10-æ‰©å±•é˜…è¯»" tabindex="-1"><a class="header-anchor" href="#_10-æ‰©å±•é˜…è¯»"><span>10. æ‰©å±•é˜…è¯»</span></a></h2><h3 id="_10-1-linux-å†…æ ¸æ–‡æ¡£" tabindex="-1"><a class="header-anchor" href="#_10-1-linux-å†…æ ¸æ–‡æ¡£"><span>10.1 Linux å†…æ ¸æ–‡æ¡£</span></a></h3>`,158)),s("ul",null,[s("li",null,[s("a",k,[n[11]||(n[11]=a("Namespaces in operation")),e(p)])]),s("li",null,[s("a",m,[n[12]||(n[12]=a("User namespaces")),e(p)])]),s("li",null,[s("a",v,[n[13]||(n[13]=a("PID namespaces")),e(p)])]),s("li",null,[s("a",b,[n[14]||(n[14]=a("Network namespaces")),e(p)])])]),n[28]||(n[28]=s("h3",{id:"_10-2-ç³»ç»Ÿè°ƒç”¨å‚è€ƒ",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_10-2-ç³»ç»Ÿè°ƒç”¨å‚è€ƒ"},[s("span",null,"10.2 ç³»ç»Ÿè°ƒç”¨å‚è€ƒ")])],-1)),s("ul",null,[s("li",null,[s("a",g,[n[15]||(n[15]=a("clone(2)")),e(p)])]),s("li",null,[s("a",h,[n[16]||(n[16]=a("unshare(2)")),e(p)])]),s("li",null,[s("a",f,[n[17]||(n[17]=a("setns(2)")),e(p)])]),s("li",null,[s("a",_,[n[18]||(n[18]=a("nsenter(1)")),e(p)])])]),n[29]||(n[29]=s("h3",{id:"_10-3-æ·±å…¥å­¦ä¹ èµ„æº",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_10-3-æ·±å…¥å­¦ä¹ èµ„æº"},[s("span",null,"10.3 æ·±å…¥å­¦ä¹ èµ„æº")])],-1)),s("ul",null,[s("li",null,[s("a",y,[n[19]||(n[19]=a("Linux Container Primitives")),e(p)])]),s("li",null,[s("a",w,[n[20]||(n[20]=a("Container Runtimes")),e(p)])]),s("li",null,[s("a",x,[n[21]||(n[21]=a("Rootless Containers")),e(p)])])]),n[30]||(n[30]=c('<h2 id="ğŸ¯-æ¨¡å—æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-æ¨¡å—æ€»ç»“"><span>ğŸ¯ æ¨¡å—æ€»ç»“</span></a></h2><p>é€šè¿‡æœ¬æ¨¡å—çš„å­¦ä¹ ï¼Œä½ åº”è¯¥å·²ç»æŒæ¡äº†ï¼š</p><p>âœ… <strong>8ç§ Namespace ç±»å‹</strong>ï¼šç†è§£æ¯ç§ namespace çš„ä½œç”¨å’Œéš”ç¦»èŒƒå›´<br> âœ… <strong>ä¸‰é˜¶æ®µè¿›ç¨‹æ¨¡å‹</strong>ï¼šç†è§£å¤æ‚çš„è¿›ç¨‹åˆ›å»ºå’ŒåŒæ­¥æœºåˆ¶<br> âœ… <strong>åº•å±‚å®ç°åŸç†</strong>ï¼šæŒæ¡ C ä»£ç å®ç°å’Œç³»ç»Ÿè°ƒç”¨ä½¿ç”¨<br> âœ… <strong>æƒé™å’Œä¾èµ–å…³ç³»</strong>ï¼šç†è§£ namespace åˆ›å»ºé¡ºåºå’Œæƒé™è¦æ±‚<br> âœ… <strong>è°ƒè¯•å’Œä¼˜åŒ–æ–¹æ³•</strong>ï¼šå…·å¤‡æ•…éšœæ’é™¤å’Œæ€§èƒ½åˆ†æèƒ½åŠ›</p>',3)),s("p",null,[n[23]||(n[23]=s("strong",null,"ä¸‹ä¸€æ­¥",-1)),n[24]||(n[24]=a(": è¿›å…¥ ")),e(t,{to:"/blogs/cloud-base/runc-deep-dive/04-Cgroups%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86.html"},{default:l(()=>n[22]||(n[22]=[a("æ¨¡å— 4: Cgroups èµ„æºç®¡ç†")])),_:1,__:[22]}),n[25]||(n[25]=a("ï¼Œå­¦ä¹ å®¹å™¨èµ„æºé™åˆ¶å’Œç›‘æ§æœºåˆ¶ã€‚"))])])}const I=o(d,[["render",N]]),S=JSON.parse('{"path":"/blogs/cloud-base/runc-deep-dive/03-Namespacegelishixian.html","title":"Namespace éš”ç¦»å®ç°","lang":"en-US","frontmatter":{"categories":["cloud-base/runc-deep-dive"]},"headers":[{"level":2,"title":"æ¦‚è¿°","slug":"æ¦‚è¿°","link":"#æ¦‚è¿°","children":[]},{"level":2,"title":"ğŸ¯ å­¦ä¹ ç›®æ ‡","slug":"ğŸ¯-å­¦ä¹ ç›®æ ‡","link":"#ğŸ¯-å­¦ä¹ ç›®æ ‡","children":[]},{"level":2,"title":"1. Linux Namespace åŸºç¡€æ¦‚å¿µ","slug":"_1-linux-namespace-åŸºç¡€æ¦‚å¿µ","link":"#_1-linux-namespace-åŸºç¡€æ¦‚å¿µ","children":[{"level":3,"title":"1.1 ä»€ä¹ˆæ˜¯ Namespaceï¼Ÿ","slug":"_1-1-ä»€ä¹ˆæ˜¯-namespace","link":"#_1-1-ä»€ä¹ˆæ˜¯-namespace","children":[]},{"level":3,"title":"1.2 å…«ç§ Namespace ç±»å‹è¯¦è§£","slug":"_1-2-å…«ç§-namespace-ç±»å‹è¯¦è§£","link":"#_1-2-å…«ç§-namespace-ç±»å‹è¯¦è§£","children":[]}]},{"level":2,"title":"2. runc çš„ Namespace å®ç°æ¶æ„","slug":"_2-runc-çš„-namespace-å®ç°æ¶æ„","link":"#_2-runc-çš„-namespace-å®ç°æ¶æ„","children":[{"level":3,"title":"2.1 æ ¸å¿ƒæ•°æ®ç»“æ„","slug":"_2-1-æ ¸å¿ƒæ•°æ®ç»“æ„","link":"#_2-1-æ ¸å¿ƒæ•°æ®ç»“æ„","children":[]},{"level":3,"title":"2.2 ä¸‰é˜¶æ®µè¿›ç¨‹åˆ›å»ºæ¨¡å‹","slug":"_2-2-ä¸‰é˜¶æ®µè¿›ç¨‹åˆ›å»ºæ¨¡å‹","link":"#_2-2-ä¸‰é˜¶æ®µè¿›ç¨‹åˆ›å»ºæ¨¡å‹","children":[]},{"level":3,"title":"2.3 nsenter æ ¸å¿ƒå®ç°","slug":"_2-3-nsenter-æ ¸å¿ƒå®ç°","link":"#_2-3-nsenter-æ ¸å¿ƒå®ç°","children":[]}]},{"level":2,"title":"3. Namespace åˆ›å»ºæµç¨‹è¯¦è§£","slug":"_3-namespace-åˆ›å»ºæµç¨‹è¯¦è§£","link":"#_3-namespace-åˆ›å»ºæµç¨‹è¯¦è§£","children":[{"level":3,"title":"3.1 é˜¶æ®µ0: çˆ¶è¿›ç¨‹ (STAGE_PARENT)","slug":"_3-1-é˜¶æ®µ0-çˆ¶è¿›ç¨‹-stage-parent","link":"#_3-1-é˜¶æ®µ0-çˆ¶è¿›ç¨‹-stage-parent","children":[]},{"level":3,"title":"3.2 é˜¶æ®µ1: ä¸­é—´å­è¿›ç¨‹ (STAGE_CHILD)","slug":"_3-2-é˜¶æ®µ1-ä¸­é—´å­è¿›ç¨‹-stage-child","link":"#_3-2-é˜¶æ®µ1-ä¸­é—´å­è¿›ç¨‹-stage-child","children":[]},{"level":3,"title":"3.3 é˜¶æ®µ2: æœ€ç»ˆ init è¿›ç¨‹ (STAGE_INIT)","slug":"_3-3-é˜¶æ®µ2-æœ€ç»ˆ-init-è¿›ç¨‹-stage-init","link":"#_3-3-é˜¶æ®µ2-æœ€ç»ˆ-init-è¿›ç¨‹-stage-init","children":[]}]},{"level":2,"title":"4. Go è¿è¡Œæ—¶é›†æˆ","slug":"_4-go-è¿è¡Œæ—¶é›†æˆ","link":"#_4-go-è¿è¡Œæ—¶é›†æˆ","children":[{"level":3,"title":"4.1 æ ‡å‡†åˆå§‹åŒ–æµç¨‹","slug":"_4-1-æ ‡å‡†åˆå§‹åŒ–æµç¨‹","link":"#_4-1-æ ‡å‡†åˆå§‹åŒ–æµç¨‹","children":[]},{"level":3,"title":"4.2 ç½‘ç»œé…ç½®ç¤ºä¾‹","slug":"_4-2-ç½‘ç»œé…ç½®ç¤ºä¾‹","link":"#_4-2-ç½‘ç»œé…ç½®ç¤ºä¾‹","children":[]},{"level":3,"title":"4.3 ä¸»æœºåè®¾ç½®ç¤ºä¾‹","slug":"_4-3-ä¸»æœºåè®¾ç½®ç¤ºä¾‹","link":"#_4-3-ä¸»æœºåè®¾ç½®ç¤ºä¾‹","children":[]}]},{"level":2,"title":"5. Namespace åˆ›å»ºé¡ºåºå’Œä¾èµ–å…³ç³»","slug":"_5-namespace-åˆ›å»ºé¡ºåºå’Œä¾èµ–å…³ç³»","link":"#_5-namespace-åˆ›å»ºé¡ºåºå’Œä¾èµ–å…³ç³»","children":[{"level":3,"title":"5.1 åˆ›å»ºé¡ºåºåŸåˆ™","slug":"_5-1-åˆ›å»ºé¡ºåºåŸåˆ™","link":"#_5-1-åˆ›å»ºé¡ºåºåŸåˆ™","children":[]},{"level":3,"title":"5.2 ä¾èµ–å…³ç³»è¯¦è§£","slug":"_5-2-ä¾èµ–å…³ç³»è¯¦è§£","link":"#_5-2-ä¾èµ–å…³ç³»è¯¦è§£","children":[]},{"level":3,"title":"5.3 åŒæ­¥æœºåˆ¶è¯¦è§£","slug":"_5-3-åŒæ­¥æœºåˆ¶è¯¦è§£","link":"#_5-3-åŒæ­¥æœºåˆ¶è¯¦è§£","children":[]}]},{"level":2,"title":"6. é«˜çº§ç‰¹æ€§å’Œä¼˜åŒ–","slug":"_6-é«˜çº§ç‰¹æ€§å’Œä¼˜åŒ–","link":"#_6-é«˜çº§ç‰¹æ€§å’Œä¼˜åŒ–","children":[{"level":3,"title":"6.1 æ—¶é—´å‘½åç©ºé—´å¤„ç†","slug":"_6-1-æ—¶é—´å‘½åç©ºé—´å¤„ç†","link":"#_6-1-æ—¶é—´å‘½åç©ºé—´å¤„ç†","children":[]},{"level":3,"title":"6.2 Rootless å®¹å™¨æ”¯æŒ","slug":"_6-2-rootless-å®¹å™¨æ”¯æŒ","link":"#_6-2-rootless-å®¹å™¨æ”¯æŒ","children":[]},{"level":3,"title":"6.3 æ€§èƒ½ä¼˜åŒ–","slug":"_6-3-æ€§èƒ½ä¼˜åŒ–","link":"#_6-3-æ€§èƒ½ä¼˜åŒ–","children":[]}]},{"level":2,"title":"7. è°ƒè¯•å’Œæ•…éšœæ’é™¤","slug":"_7-è°ƒè¯•å’Œæ•…éšœæ’é™¤","link":"#_7-è°ƒè¯•å’Œæ•…éšœæ’é™¤","children":[{"level":3,"title":"7.1 å¸¸è§é—®é¢˜è¯Šæ–­","slug":"_7-1-å¸¸è§é—®é¢˜è¯Šæ–­","link":"#_7-1-å¸¸è§é—®é¢˜è¯Šæ–­","children":[]},{"level":3,"title":"7.2 æ€§èƒ½åˆ†æ","slug":"_7-2-æ€§èƒ½åˆ†æ","link":"#_7-2-æ€§èƒ½åˆ†æ","children":[]}]},{"level":2,"title":"8. å®è·µç»ƒä¹ ","slug":"_8-å®è·µç»ƒä¹ ","link":"#_8-å®è·µç»ƒä¹ ","children":[{"level":3,"title":"8.1 æ‰‹åŠ¨åˆ›å»º Namespace","slug":"_8-1-æ‰‹åŠ¨åˆ›å»º-namespace","link":"#_8-1-æ‰‹åŠ¨åˆ›å»º-namespace","children":[]},{"level":3,"title":"8.2 è‡ªå®šä¹‰ Namespace é…ç½®","slug":"_8-2-è‡ªå®šä¹‰-namespace-é…ç½®","link":"#_8-2-è‡ªå®šä¹‰-namespace-é…ç½®","children":[]},{"level":3,"title":"8.3 Namespace æ€§èƒ½æµ‹è¯•","slug":"_8-3-namespace-æ€§èƒ½æµ‹è¯•","link":"#_8-3-namespace-æ€§èƒ½æµ‹è¯•","children":[]},{"level":3,"title":"8.4 è°ƒè¯• runc Namespace åˆ›å»º","slug":"_8-4-è°ƒè¯•-runc-namespace-åˆ›å»º","link":"#_8-4-è°ƒè¯•-runc-namespace-åˆ›å»º","children":[]}]},{"level":2,"title":"9. æ€è€ƒé¢˜","slug":"_9-æ€è€ƒé¢˜","link":"#_9-æ€è€ƒé¢˜","children":[{"level":3,"title":"9.1 æ¶æ„è®¾è®¡æ€è€ƒ","slug":"_9-1-æ¶æ„è®¾è®¡æ€è€ƒ","link":"#_9-1-æ¶æ„è®¾è®¡æ€è€ƒ","children":[]},{"level":3,"title":"9.2 æŠ€æœ¯å®ç°æ€è€ƒ","slug":"_9-2-æŠ€æœ¯å®ç°æ€è€ƒ","link":"#_9-2-æŠ€æœ¯å®ç°æ€è€ƒ","children":[]},{"level":3,"title":"9.3 å®‰å…¨æ€§æ€è€ƒ","slug":"_9-3-å®‰å…¨æ€§æ€è€ƒ","link":"#_9-3-å®‰å…¨æ€§æ€è€ƒ","children":[]},{"level":3,"title":"9.4 æ‰©å±•æ€§æ€è€ƒ","slug":"_9-4-æ‰©å±•æ€§æ€è€ƒ","link":"#_9-4-æ‰©å±•æ€§æ€è€ƒ","children":[]}]},{"level":2,"title":"10. æ‰©å±•é˜…è¯»","slug":"_10-æ‰©å±•é˜…è¯»","link":"#_10-æ‰©å±•é˜…è¯»","children":[{"level":3,"title":"10.1 Linux å†…æ ¸æ–‡æ¡£","slug":"_10-1-linux-å†…æ ¸æ–‡æ¡£","link":"#_10-1-linux-å†…æ ¸æ–‡æ¡£","children":[]},{"level":3,"title":"10.2 ç³»ç»Ÿè°ƒç”¨å‚è€ƒ","slug":"_10-2-ç³»ç»Ÿè°ƒç”¨å‚è€ƒ","link":"#_10-2-ç³»ç»Ÿè°ƒç”¨å‚è€ƒ","children":[]},{"level":3,"title":"10.3 æ·±å…¥å­¦ä¹ èµ„æº","slug":"_10-3-æ·±å…¥å­¦ä¹ èµ„æº","link":"#_10-3-æ·±å…¥å­¦ä¹ èµ„æº","children":[]}]},{"level":2,"title":"ğŸ¯ æ¨¡å—æ€»ç»“","slug":"ğŸ¯-æ¨¡å—æ€»ç»“","link":"#ğŸ¯-æ¨¡å—æ€»ç»“","children":[]}],"git":{"createdTime":1754503646000,"updatedTime":1754503646000,"contributors":[{"name":"hushengnian","email":"hushengnian@example.com","commits":1}]},"filePathRelative":"blogs/cloud-base/runc-deep-dive/03-Namespaceéš”ç¦»å®ç°.md"}');export{I as comp,S as data};

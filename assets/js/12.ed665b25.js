(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{576:function(s,a,t){"use strict";t.r(a);var e=t(13),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h3",{attrs:{id:"一-快速安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一-快速安装"}},[s._v("#")]),s._v(" 一. 快速安装")]),s._v(" "),t("ol",[t("li",[s._v("server 国内安装"),t("br"),s._v(" "),t("code",[s._v("curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -")])]),s._v(" "),t("li",[s._v("server 国外安装"),t("br"),s._v(" "),t("code",[s._v("curl -sfL https://get.k3s.io | sh -")])]),s._v(" "),t("li",[s._v("worker 国内安装"),t("br"),s._v(" "),t("code",[s._v("curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn K3S_URL=${K3S_URL} K3S_TOKEN=${K3S_TOKEN} sh -")])]),s._v(" "),t("li",[s._v("worker 国外安装"),t("br"),s._v(" "),t("code",[s._v("curl -sfL https://get.k3s.io | K3S_URL=${K3S_URL} K3S_TOKEN=${K3S_TOKEN} sh -")])])]),s._v(" "),t("p",[t("strong",[s._v("notice")]),s._v(":")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("worker 安装前先export一下环境变量"),t("br"),s._v(" "),t("code",[s._v("export K3S_URL=https://110.40.186.64:6443")]),t("br"),s._v(" "),t("code",[s._v("export K3S_TOKEN=xxxxx::server:xxxxx")])])]),s._v(" "),t("li",[t("p",[t("code",[s._v("K3S_TOKEN")]),s._v(" 在server环境的"),t("code",[s._v("/var/lib/rancher/k3s/server/node-token")]),s._v("路径")])]),s._v(" "),t("li",[t("p",[s._v("每台计算机必须具有唯一的主机名。如果您的计算机没有唯一的主机名，请传递"),t("code",[s._v("K3S_NODE_NAME")]),s._v("环境变量，并为每个节点提供一个有效且唯一的主机名。")])])]),s._v(" "),t("h3",{attrs:{id:"二、先进行server端配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二、先进行server端配置"}},[s._v("#")]),s._v(" 二、先进行"),t("code",[s._v("server")]),s._v("端配置")]),s._v(" "),t("p",[s._v("编辑systemd配置文件")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/systemd/system/k3s-server.service\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("###########################################")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Unit"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Description")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Lightweight Kubernetes\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Documentation")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://k3s.io\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Wants")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("network-online.target\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Service"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Type")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("notify\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("KillMode")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("process\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Delegate")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("yes\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LimitNOFILE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1048576")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LimitNPROC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("infinity\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LimitCORE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("infinity\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TasksMax")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("infinity\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TimeoutStartSec")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStartPre")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("-/sbin/modprobe br_netfilter\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStartPre")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("-/sbin/modprobe overlay\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStart")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/bin/k3s "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    server "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --node-external-ip "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("public-ip"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --no-deploy servicelb "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    --cluster-domain magina.k3s \\")]),s._v("\n    --flannel-backend wireguard "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --kube-proxy-arg "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"proxy-mode=ipvs"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"masquerade-all=true"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --kube-proxy-arg "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"metrics-bind-address=0.0.0.0"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Restart")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("always\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RestartSec")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("5s\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Install"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WantedBy")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("multi-user.target\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br")])]),t("p",[s._v("主要是修改 "),t("code",[s._v("ExecStart")]),s._v(" 启动参数")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("--node-external-ip")]),s._v(": 如果是跨云服务, 需要指定公网IP")]),s._v(" "),t("li",[t("code",[s._v("--no-deploy")]),s._v(": 不使用k3s自带的负载均衡模块")]),s._v(" "),t("li",[t("code",[s._v("--cluster-domain")]),s._v(": 自定义域名, 微服务使用, 如果不指定, 默认"),t("code",[s._v("cluster.local")])]),s._v(" "),t("li",[t("code",[s._v("--flannel-backend")]),s._v(": 这里我是跨公有云部署, 使用"),t("code",[s._v("wireguard")]),s._v("模式, 如果是内网可以不指定, 默认"),t("code",[s._v("vxlan")])])]),s._v(" "),t("p",[s._v("如果使用"),t("code",[s._v("wireguard")]),s._v("，注意所有node节点上都要安装"),t("code",[s._v("wireguard")]),s._v("， "),t("code",[s._v("ubuntu")]),s._v("只需要"),t("code",[s._v("apt-get update")]),s._v(" 并 "),t("code",[s._v("apt-get install wireguard")]),s._v(" 即可"),t("br"),s._v("\n执行完毕后调用"),t("code",[s._v("systemctl daemon-reload")]),s._v(" 并执行 "),t("code",[s._v("systemctl restart k3s")]),s._v(" 即可更新配置")]),s._v(" "),t("h3",{attrs:{id:"三、更新agent配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三、更新agent配置"}},[s._v("#")]),s._v(" 三、更新"),t("code",[s._v("agent")]),s._v("配置")]),s._v(" "),t("p",[s._v("编辑systemd配置文件")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/systemd/system/k3s-agent.service\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("###########################################")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Unit"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Description")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Lightweight Kubernetes\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Documentation")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://k3s.io\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Wants")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("network-online.target\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Service"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Type")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("exec\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("KillMode")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("process\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Delegate")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("yes\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LimitNOFILE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("infinity\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LimitNPROC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("infinity\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LimitCORE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("infinity\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TasksMax")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("infinity\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TimeoutStartSec")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStartPre")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("-/sbin/modprobe br_netfilter\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStartPre")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("-/sbin/modprobe overlay\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStart")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/bin/k3s agent "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --server https://"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("server-ip"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(":6443 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --token xxxxxx::server:xxxxxx "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --node-external-ip "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("public-ip"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --kube-proxy-arg "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"proxy-mode=ipvs"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"masquerade-all=true"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Restart")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("always\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RestartSec")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("5s\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Install"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WantedBy")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("multi-user.target\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br")])]),t("p",[s._v("主要是修改 "),t("code",[s._v("ExecStart")]),s._v(" 启动参数")]),s._v(" "),t("ul",[t("li",[s._v("--server: server服务的连接地址")]),s._v(" "),t("li",[s._v("--node-external-ip: 如果是跨云服务, 需要指定公网IP")]),s._v(" "),t("li",[s._v("--token: 在server服务器中查看"),t("code",[s._v("cat /var/lib/rancher/k3s/server/token")])])]),s._v(" "),t("h3",{attrs:{id:"四、更新节点ip"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#四、更新节点ip"}},[s._v("#")]),s._v(" 四、更新节点ip")]),s._v(" "),t("p",[t("code",[s._v("kubectl edit node k3s-server-01")]),t("br"),s._v(" "),t("code",[s._v("metadata:annotations:")]),s._v("后添加一行"),t("br"),s._v(" "),t("code",[s._v("flannel.alpha.coreos.com/public-ip-overwrite: server-public-ip")])]),s._v(" "),t("p",[s._v("至此就完成了🎉")]),s._v(" "),t("p",[s._v('kubectl run dig --rm -it --image=rickiechina/dig --overrides=\'{"spec": {"nodeSelector": { "kubernetes.io/hostname": "k3s-worker1" }}}\' -- /bin/sh\ncurl -sfL '),t("a",{attrs:{href:"http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh"),t("OutboundLink")],1),s._v(" | INSTALL_K3S_MIRROR=cn sh  -s -  --node-external-ip 121.5.154.166 --advertise-address 121.5.154.166 --node-ip 10.0.4.10")])])}),[],!1,null,null,null);a.default=n.exports}}]);
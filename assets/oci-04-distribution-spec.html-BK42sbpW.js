import{_ as o,c,b as n,a as r,e as a,d as e,w as l,r as t,o as d}from"./app-2O6audqE.js";const u={},v={href:"https://github.com/opencontainers/distribution-spec",target:"_blank",rel:"noopener noreferrer"};function k(m,s){const p=t("RouteLink"),i=t("ExternalLinkIcon");return d(),c("div",null,[s[31]||(s[31]=n("h1",{id:"oci-distribution-规范详解-容器镜像分发协议",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#oci-distribution-规范详解-容器镜像分发协议"},[n("span",null,"OCI Distribution 规范详解 - 容器镜像分发协议")])],-1)),n("blockquote",null,[n("p",null,[s[2]||(s[2]=n("strong",null,"系列导航：",-1)),s[3]||(s[3]=a()),e(p,{to:"/blogs/cloud-base/oci-series-index.html"},{default:l(()=>s[0]||(s[0]=[a("OCI 容器技术完全指南系列")])),_:1,__:[0]}),s[4]||(s[4]=a(" → 第四篇：分发规范")),s[5]||(s[5]=n("br",null,null,-1)),s[6]||(s[6]=n("strong",null,"规范版本：",-1)),s[7]||(s[7]=a(" OCI Distribution Spec v1.0.1")),s[8]||(s[8]=n("br",null,null,-1)),s[9]||(s[9]=n("strong",null,"参考仓库：",-1)),s[10]||(s[10]=a()),n("a",v,[s[1]||(s[1]=a("opencontainers/distribution-spec")),e(i)]),s[11]||(s[11]=n("br",null,null,-1)),s[12]||(s[12]=n("strong",null,"最后更新：",-1)),s[13]||(s[13]=a(" 2024-07-10"))])]),s[32]||(s[32]=r(`<h2 id="概述" tabindex="-1"><a class="header-anchor" href="#概述"><span>概述</span></a></h2><p>OCI Distribution Specification 定义了容器镜像分发和存储的 API 标准，规范了镜像在注册表（Registry）中的存储、检索和管理方式。本文将深入解析分发协议的核心概念、API 接口设计和实际应用场景。</p><h2 id="分发规范基础" tabindex="-1"><a class="header-anchor" href="#分发规范基础"><span>分发规范基础</span></a></h2><h3 id="核心概念" tabindex="-1"><a class="header-anchor" href="#核心概念"><span>核心概念</span></a></h3><p><strong>Registry（注册表）：</strong> 实现 OCI Distribution API 的服务，负责存储和分发容器镜像</p><p><strong>Repository（仓库）：</strong> 注册表中的一个命名空间，包含相关的镜像清单、blob 和标签</p><p><strong>Blob（二进制大对象）：</strong> 存储在注册表中的不可变内容，通过内容摘要寻址</p><p><strong>Manifest（清单）：</strong> 描述镜像结构的 JSON 文档</p><p><strong>Tag（标签）：</strong> 指向特定清单的可变指针</p><h3 id="架构设计" tabindex="-1"><a class="header-anchor" href="#架构设计"><span>架构设计</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">┌─────────────────────────────────────────────────────────────┐</span>
<span class="line">│                    OCI Distribution 架构                     │</span>
<span class="line">├─────────────────────────────────────────────────────────────┤</span>
<span class="line">│  客户端 (Docker, Podman, containerd...)                     │</span>
<span class="line">├─────────────────────────────────────────────────────────────┤</span>
<span class="line">│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │</span>
<span class="line">│  │   Push API      │ │   Pull API      │ │  Discovery API  │ │</span>
<span class="line">│  │                 │ │                 │ │                 │ │</span>
<span class="line">│  │ • 分块上传      │ │ • 内容检索      │ │ • 标签列表      │ │</span>
<span class="line">│  │ • 清单上传      │ │ • 清单下载      │ │ • 内容发现      │ │</span>
<span class="line">│  │ • 跨仓库挂载    │ │ • Blob 下载     │ │ • 版本协商      │ │</span>
<span class="line">│  └─────────────────┘ └─────────────────┘ └─────────────────┘ │</span>
<span class="line">├─────────────────────────────────────────────────────────────┤</span>
<span class="line">│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │</span>
<span class="line">│  │   认证授权      │ │   内容管理      │ │   API 扩展      │ │</span>
<span class="line">│  │                 │ │                 │ │                 │ │</span>
<span class="line">│  │ • Bearer Token  │ │ • 垃圾回收      │ │ • Referrers API │ │</span>
<span class="line">│  │ • Basic Auth    │ │ • 重复数据删除  │ │ • 工件支持      │ │</span>
<span class="line">│  │ • OAuth2        │ │ • 存储后端      │ │ • 自定义扩展    │ │</span>
<span class="line">│  └─────────────────┘ └─────────────────┘ └─────────────────┘ │</span>
<span class="line">├─────────────────────────────────────────────────────────────┤</span>
<span class="line">│  存储后端 (文件系统、对象存储、数据库...)                    │</span>
<span class="line">└─────────────────────────────────────────────────────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="注册表-api-接口" tabindex="-1"><a class="header-anchor" href="#注册表-api-接口"><span>注册表 API 接口</span></a></h2><h3 id="版本协商" tabindex="-1"><a class="header-anchor" href="#版本协商"><span>版本协商</span></a></h3><p>所有兼容的注册表必须实现版本端点：</p><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">GET /v2/</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>响应示例：</strong></p><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line"><span class="token response-status"><span class="token http-version property">HTTP/1.1</span> <span class="token status-code number">200</span> <span class="token reason-phrase string">OK</span></span></span>
<span class="line"><span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/json</span></span></span>
<span class="line"><span class="token application-json"></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;what&quot;</span><span class="token operator">:</span> <span class="token string">&quot;OCI Distribution Spec&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.1&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="核心端点" tabindex="-1"><a class="header-anchor" href="#核心端点"><span>核心端点</span></a></h3><h4 id="_1-内容发现" tabindex="-1"><a class="header-anchor" href="#_1-内容发现"><span>1. 内容发现</span></a></h4><p><strong>列出仓库：</strong></p><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">GET /v2/_catalog?n=&lt;page_size&gt;&amp;last=&lt;last_repository&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>列出标签：</strong></p><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">GET /v2/&lt;repository&gt;/tags/list?n=&lt;page_size&gt;&amp;last=&lt;last_tag&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>响应示例：</strong></p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;myapp&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;latest&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;v1.0.0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;v1.1.0&quot;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-内容检索" tabindex="-1"><a class="header-anchor" href="#_2-内容检索"><span>2. 内容检索</span></a></h4><p><strong>获取清单：</strong></p><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">GET /v2/&lt;repository&gt;/manifests/&lt;reference&gt;</span>
<span class="line"><span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">application/vnd.oci.image.manifest.v1+json</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>获取 Blob：</strong></p><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">GET /v2/&lt;repository&gt;/blobs/&lt;digest&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>检查 Blob 存在性：</strong></p><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">HEAD /v2/&lt;repository&gt;/blobs/&lt;digest&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_3-内容推送" tabindex="-1"><a class="header-anchor" href="#_3-内容推送"><span>3. 内容推送</span></a></h4><p><strong>启动 Blob 上传：</strong></p><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">POST /v2/&lt;repository&gt;/blobs/uploads/</span>
<span class="line"><span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">0</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>响应：</strong></p><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line"><span class="token response-status"><span class="token http-version property">HTTP/1.1</span> <span class="token status-code number">202</span> <span class="token reason-phrase string">Accepted</span></span></span>
<span class="line"><span class="token header"><span class="token header-name keyword">Location</span><span class="token punctuation">:</span> <span class="token header-value">/v2/&lt;repository&gt;/blobs/uploads/&lt;uuid&gt;</span></span></span>
<span class="line"><span class="token header"><span class="token header-name keyword">Range</span><span class="token punctuation">:</span> <span class="token header-value">0-0</span></span></span>
<span class="line"><span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">0</span></span></span>
<span class="line"><span class="token header"><span class="token header-name keyword">Docker-Upload-UUID</span><span class="token punctuation">:</span> <span class="token header-value">&lt;uuid&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>分块上传 Blob：</strong></p><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">PATCH /v2/&lt;repository&gt;/blobs/uploads/&lt;uuid&gt;</span>
<span class="line"><span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/octet-stream</span></span></span>
<span class="line"><span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">&lt;chunk_size&gt;</span></span></span>
<span class="line"><span class="token header"><span class="token header-name keyword">Content-Range</span><span class="token punctuation">:</span> <span class="token header-value">&lt;start&gt;-&lt;end&gt;</span></span></span>
<span class="line"></span>
<span class="line">&lt;binary_data&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>完成 Blob 上传：</strong></p><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">PUT /v2/&lt;repository&gt;/blobs/uploads/&lt;uuid&gt;?digest=&lt;digest&gt;</span>
<span class="line"><span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">&lt;remaining_size&gt;</span></span></span>
<span class="line"><span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/octet-stream</span></span></span>
<span class="line"></span>
<span class="line">&lt;final_chunk&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>上传清单：</strong></p><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">PUT /v2/&lt;repository&gt;/manifests/&lt;reference&gt;</span>
<span class="line"><span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/vnd.oci.image.manifest.v1+json</span></span></span>
<span class="line"><span class="token application-json"></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;schemaVersion&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;mediaType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/vnd.oci.image.manifest.v1+json&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;config&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> ... <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;layers&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> ... <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="错误处理" tabindex="-1"><a class="header-anchor" href="#错误处理"><span>错误处理</span></a></h3><h4 id="标准错误代码" tabindex="-1"><a class="header-anchor" href="#标准错误代码"><span>标准错误代码</span></a></h4><table><thead><tr><th>错误代码</th><th>HTTP 状态</th><th>说明</th></tr></thead><tbody><tr><td><code>BLOB_UNKNOWN</code></td><td>404</td><td>Blob 不存在</td></tr><tr><td><code>BLOB_UPLOAD_INVALID</code></td><td>400</td><td>上传参数无效</td></tr><tr><td><code>BLOB_UPLOAD_UNKNOWN</code></td><td>404</td><td>上传会话不存在</td></tr><tr><td><code>DIGEST_INVALID</code></td><td>400</td><td>摘要格式无效</td></tr><tr><td><code>MANIFEST_BLOB_UNKNOWN</code></td><td>404</td><td>清单引用的 Blob 不存在</td></tr><tr><td><code>MANIFEST_INVALID</code></td><td>400</td><td>清单格式无效</td></tr><tr><td><code>MANIFEST_UNKNOWN</code></td><td>404</td><td>清单不存在</td></tr><tr><td><code>NAME_INVALID</code></td><td>400</td><td>仓库名称无效</td></tr><tr><td><code>NAME_UNKNOWN</code></td><td>404</td><td>仓库不存在</td></tr><tr><td><code>SIZE_INVALID</code></td><td>400</td><td>内容大小无效</td></tr><tr><td><code>TAG_INVALID</code></td><td>400</td><td>标签名称无效</td></tr><tr><td><code>UNAUTHORIZED</code></td><td>401</td><td>认证失败</td></tr><tr><td><code>DENIED</code></td><td>403</td><td>权限不足</td></tr><tr><td><code>UNSUPPORTED</code></td><td>405</td><td>操作不支持</td></tr></tbody></table><h4 id="错误响应格式" tabindex="-1"><a class="header-anchor" href="#错误响应格式"><span>错误响应格式</span></a></h4><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;errors&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token string">&quot;BLOB_UNKNOWN&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;blob unknown to registry&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">&quot;detail&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token property">&quot;digest&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sha256:abc123...&quot;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="认证和授权" tabindex="-1"><a class="header-anchor" href="#认证和授权"><span>认证和授权</span></a></h2><h3 id="bearer-token-认证" tabindex="-1"><a class="header-anchor" href="#bearer-token-认证"><span>Bearer Token 认证</span></a></h3><h4 id="认证流程" tabindex="-1"><a class="header-anchor" href="#认证流程"><span>认证流程</span></a></h4><ol><li><strong>客户端请求受保护资源</strong></li></ol><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">GET /v2/private-repo/manifests/latest</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="2"><li><strong>注册表返回认证挑战</strong></li></ol><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line"><span class="token response-status"><span class="token http-version property">HTTP/1.1</span> <span class="token status-code number">401</span> <span class="token reason-phrase string">Unauthorized</span></span></span>
<span class="line"><span class="token header"><span class="token header-name keyword">WWW-Authenticate</span><span class="token punctuation">:</span> <span class="token header-value">Bearer realm=&quot;https://auth.example.com/token&quot;,</span>
<span class="line">                         service=&quot;registry.example.com&quot;,</span>
<span class="line">                         scope=&quot;repository:private-repo:pull&quot;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><strong>客户端向认证服务器请求 Token</strong></li></ol><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">GET https://auth.example.com/token?service=registry.example.com&amp;scope=repository:private-repo:pull</span>
<span class="line"><span class="token header"><span class="token header-name keyword">Authorization</span><span class="token punctuation">:</span> <span class="token header-value">Basic &lt;base64(username:password)&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li><strong>认证服务器返回 Token</strong></li></ol><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIs...&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;expires_in&quot;</span><span class="token operator">:</span> <span class="token number">3600</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;issued_at&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2024-07-10T10:00:00Z&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li><strong>客户端使用 Token 访问资源</strong></li></ol><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">GET /v2/private-repo/manifests/latest</span>
<span class="line"><span class="token header"><span class="token header-name keyword">Authorization</span><span class="token punctuation">:</span> <span class="token header-value">Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIs...</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="权限范围" tabindex="-1"><a class="header-anchor" href="#权限范围"><span>权限范围</span></a></h3><h4 id="作用域格式" tabindex="-1"><a class="header-anchor" href="#作用域格式"><span>作用域格式</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">repository:&lt;repository&gt;:&lt;action&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>支持的动作：</strong></p><ul><li><code>pull</code> - 下载权限</li><li><code>push</code> - 上传权限</li><li><code>delete</code> - 删除权限</li><li><code>*</code> - 所有权限</li></ul><p><strong>示例：</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">repository:myapp/backend:pull,push</span>
<span class="line">repository:myapp/*:pull</span>
<span class="line">registry:catalog:*</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="basic-认证" tabindex="-1"><a class="header-anchor" href="#basic-认证"><span>Basic 认证</span></a></h3><p>简单的用户名密码认证：</p><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">GET /v2/private-repo/manifests/latest</span>
<span class="line"><span class="token header"><span class="token header-name keyword">Authorization</span><span class="token punctuation">:</span> <span class="token header-value">Basic &lt;base64(username:password)&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="内容分发协议" tabindex="-1"><a class="header-anchor" href="#内容分发协议"><span>内容分发协议</span></a></h2><h3 id="推送工作流" tabindex="-1"><a class="header-anchor" href="#推送工作流"><span>推送工作流</span></a></h3><h4 id="_1-分块上传-推荐" tabindex="-1"><a class="header-anchor" href="#_1-分块上传-推荐"><span>1. 分块上传（推荐）</span></a></h4><p>适用于大文件和不稳定网络环境：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># chunked-upload.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">REPO</span><span class="token operator">=</span><span class="token string">&quot;example.com/myapp&quot;</span></span>
<span class="line"><span class="token assign-left variable">FILE</span><span class="token operator">=</span><span class="token string">&quot;layer.tar.gz&quot;</span></span>
<span class="line"><span class="token assign-left variable">CHUNK_SIZE</span><span class="token operator">=</span><span class="token number">1048576</span>  <span class="token comment"># 1MB chunks</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 1. 启动上传会话</span></span>
<span class="line"><span class="token assign-left variable">UPLOAD_URL</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> <span class="token parameter variable">-X</span> POST <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token string">&quot;https://registry.example.com/v2/<span class="token variable">\${REPO}</span>/blobs/uploads/&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">-H</span> <span class="token string">&quot;Authorization: Bearer <span class="token variable">$TOKEN</span>&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">-I</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-i</span> location <span class="token operator">|</span> <span class="token function">cut</span> -d<span class="token string">&#39; &#39;</span> <span class="token parameter variable">-f2</span><span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 2. 分块上传</span></span>
<span class="line"><span class="token assign-left variable">FILESIZE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">wc</span> <span class="token parameter variable">-c</span> <span class="token operator">&lt;</span> <span class="token string">&quot;<span class="token variable">$FILE</span>&quot;</span><span class="token variable">)</span></span></span>
<span class="line"><span class="token assign-left variable">OFFSET</span><span class="token operator">=</span><span class="token number">0</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable">$OFFSET</span> <span class="token parameter variable">-lt</span> <span class="token variable">$FILESIZE</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">    <span class="token assign-left variable">END</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>OFFSET <span class="token operator">+</span> CHUNK_SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token variable">))</span></span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$END</span> <span class="token parameter variable">-ge</span> <span class="token variable">$FILESIZE</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token assign-left variable">END</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>FILESIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token variable">))</span></span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$FILE</span>&quot;</span> <span class="token assign-left variable">bs</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">skip</span><span class="token operator">=</span><span class="token variable">$OFFSET</span> <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>END <span class="token operator">-</span> OFFSET <span class="token operator">+</span> <span class="token number">1</span><span class="token variable">))</span></span> <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null <span class="token operator">|</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token function">curl</span> <span class="token parameter variable">-X</span> PATCH <span class="token punctuation">\\</span></span>
<span class="line">        <span class="token string">&quot;<span class="token variable">$UPLOAD_URL</span>&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">        <span class="token parameter variable">-H</span> <span class="token string">&quot;Authorization: Bearer <span class="token variable">$TOKEN</span>&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">        <span class="token parameter variable">-H</span> <span class="token string">&quot;Content-Type: application/octet-stream&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">        <span class="token parameter variable">-H</span> <span class="token string">&quot;Content-Range: <span class="token variable">$OFFSET</span>-<span class="token variable">$END</span>&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">        --data-binary @-</span>
<span class="line">    </span>
<span class="line">    <span class="token assign-left variable">OFFSET</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>END <span class="token operator">+</span> <span class="token number">1</span><span class="token variable">))</span></span></span>
<span class="line"><span class="token keyword">done</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 3. 完成上传</span></span>
<span class="line"><span class="token assign-left variable">DIGEST</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>sha256sum <span class="token string">&quot;<span class="token variable">$FILE</span>&quot;</span> <span class="token operator">|</span> <span class="token function">cut</span> -d<span class="token string">&#39; &#39;</span> <span class="token parameter variable">-f1</span><span class="token variable">)</span></span></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-X</span> PUT <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token string">&quot;<span class="token variable">$UPLOAD_URL</span>?digest=sha256:<span class="token variable">$DIGEST</span>&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token parameter variable">-H</span> <span class="token string">&quot;Authorization: Bearer <span class="token variable">$TOKEN</span>&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token parameter variable">-H</span> <span class="token string">&quot;Content-Length: 0&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-单体上传" tabindex="-1"><a class="header-anchor" href="#_2-单体上传"><span>2. 单体上传</span></a></h4><p>适用于小文件：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># single-upload.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">REPO</span><span class="token operator">=</span><span class="token string">&quot;example.com/myapp&quot;</span></span>
<span class="line"><span class="token assign-left variable">FILE</span><span class="token operator">=</span><span class="token string">&quot;config.json&quot;</span></span>
<span class="line"><span class="token assign-left variable">DIGEST</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>sha256sum <span class="token string">&quot;<span class="token variable">$FILE</span>&quot;</span> <span class="token operator">|</span> <span class="token function">cut</span> -d<span class="token string">&#39; &#39;</span> <span class="token parameter variable">-f1</span><span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-X</span> POST <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token string">&quot;https://registry.example.com/v2/<span class="token variable">\${REPO}</span>/blobs/uploads/?digest=sha256:<span class="token variable">$DIGEST</span>&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token parameter variable">-H</span> <span class="token string">&quot;Authorization: Bearer <span class="token variable">$TOKEN</span>&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token parameter variable">-H</span> <span class="token string">&quot;Content-Type: application/octet-stream&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">    --data-binary <span class="token string">&quot;@<span class="token variable">$FILE</span>&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-跨仓库挂载" tabindex="-1"><a class="header-anchor" href="#_3-跨仓库挂载"><span>3. 跨仓库挂载</span></a></h4><p>复用已存在的 Blob：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">curl</span> <span class="token parameter variable">-X</span> POST <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token string">&quot;https://registry.example.com/v2/target-repo/blobs/uploads/?mount=sha256:<span class="token variable">$DIGEST</span>&amp;from=source-repo&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token parameter variable">-H</span> <span class="token string">&quot;Authorization: Bearer <span class="token variable">$TOKEN</span>&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="拉取优化" tabindex="-1"><a class="header-anchor" href="#拉取优化"><span>拉取优化</span></a></h3><h4 id="范围请求" tabindex="-1"><a class="header-anchor" href="#范围请求"><span>范围请求</span></a></h4><p>支持部分内容下载：</p><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">GET /v2/myapp/blobs/sha256:abc123...</span>
<span class="line"><span class="token header"><span class="token header-name keyword">Range</span><span class="token punctuation">:</span> <span class="token header-value">bytes=1024-2048</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="内容验证" tabindex="-1"><a class="header-anchor" href="#内容验证"><span>内容验证</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># verify-content.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">EXPECTED_DIGEST</span><span class="token operator">=</span><span class="token string">&quot;sha256:abc123...&quot;</span></span>
<span class="line"><span class="token assign-left variable">ACTUAL_DIGEST</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> <span class="token parameter variable">-L</span> <span class="token string">&quot;https://registry.example.com/v2/myapp/blobs/<span class="token variable">$EXPECTED_DIGEST</span>&quot;</span> <span class="token operator">|</span> sha256sum <span class="token operator">|</span> <span class="token function">cut</span> -d<span class="token string">&#39; &#39;</span> <span class="token parameter variable">-f1</span><span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;sha256:<span class="token variable">$ACTUAL_DIGEST</span>&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;<span class="token variable">$EXPECTED_DIGEST</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;Content verified successfully&quot;</span></span>
<span class="line"><span class="token keyword">else</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;Content verification failed&quot;</span></span>
<span class="line">    <span class="token builtin class-name">exit</span> <span class="token number">1</span></span>
<span class="line"><span class="token keyword">fi</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="referrers-api-和工件支持" tabindex="-1"><a class="header-anchor" href="#referrers-api-和工件支持"><span>Referrers API 和工件支持</span></a></h2><h3 id="referrers-api" tabindex="-1"><a class="header-anchor" href="#referrers-api"><span>Referrers API</span></a></h3><p>用于查找引用特定清单的工件：</p><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">GET /v2/&lt;repository&gt;/referrers/&lt;digest&gt;?artifactType=&lt;type&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>响应示例：</strong></p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;schemaVersion&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;mediaType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/vnd.oci.image.index.v1+json&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;manifests&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token property">&quot;mediaType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/vnd.oci.image.manifest.v1+json&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">1234</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">&quot;digest&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sha256:signature-manifest&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">&quot;artifactType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/vnd.example.signature.v1+json&quot;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token property">&quot;mediaType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/vnd.oci.image.manifest.v1+json&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">5678</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">&quot;digest&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sha256:sbom-manifest&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">&quot;artifactType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/vnd.example.sbom.v1+json&quot;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="工件清单" tabindex="-1"><a class="header-anchor" href="#工件清单"><span>工件清单</span></a></h3><p>用于存储非容器镜像的工件：</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;schemaVersion&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;mediaType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/vnd.oci.image.manifest.v1+json&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;artifactType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/vnd.example.signature.v1+json&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;config&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;mediaType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/vnd.oci.empty.v1+json&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;digest&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sha256:44136fa355b3678a1146ad16f7e8649e94fb4fc21fe77e8310c060f61caaff8a&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;layers&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token property">&quot;mediaType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/vnd.example.signature.v1+tar&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">1024</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">&quot;digest&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sha256:signature-layer&quot;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;subject&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;mediaType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/vnd.oci.image.manifest.v1+json&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">7682</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;digest&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sha256:target-image-manifest&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;annotations&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;org.example.signature.key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;key1&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="注册表实现" tabindex="-1"><a class="header-anchor" href="#注册表实现"><span>注册表实现</span></a></h2><h3 id="开源注册表" tabindex="-1"><a class="header-anchor" href="#开源注册表"><span>开源注册表</span></a></h3><h4 id="harbor" tabindex="-1"><a class="header-anchor" href="#harbor"><span>Harbor</span></a></h4><p>企业级云原生工件注册表：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token comment"># harbor-values.yaml</span></span>
<span class="line"><span class="token key atrule">expose</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">type</span><span class="token punctuation">:</span> loadBalancer</span>
<span class="line">  <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">IP</span><span class="token punctuation">:</span> <span class="token string">&quot;192.168.1.100&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">persistence</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">  <span class="token key atrule">resourcePolicy</span><span class="token punctuation">:</span> <span class="token string">&quot;keep&quot;</span></span>
<span class="line">  <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">registry</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">storageClass</span><span class="token punctuation">:</span> <span class="token string">&quot;fast-ssd&quot;</span></span>
<span class="line">      <span class="token key atrule">size</span><span class="token punctuation">:</span> 200Gi</span>
<span class="line">    <span class="token key atrule">database</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">storageClass</span><span class="token punctuation">:</span> <span class="token string">&quot;fast-ssd&quot;</span>  </span>
<span class="line">      <span class="token key atrule">size</span><span class="token punctuation">:</span> 10Gi</span>
<span class="line"></span>
<span class="line"><span class="token key atrule">trivy</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">notary</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">chartmuseum</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="distribution-docker-registry-v2" tabindex="-1"><a class="header-anchor" href="#distribution-docker-registry-v2"><span>Distribution (Docker Registry v2)</span></a></h4><p>轻量级 OCI 兼容注册表：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token comment"># distribution-config.yml</span></span>
<span class="line"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token number">0.1</span></span>
<span class="line"><span class="token key atrule">log</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">fields</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">service</span><span class="token punctuation">:</span> registry</span>
<span class="line"><span class="token key atrule">storage</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">cache</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">blobdescriptor</span><span class="token punctuation">:</span> inmemory</span>
<span class="line">  <span class="token key atrule">filesystem</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">rootdirectory</span><span class="token punctuation">:</span> /var/lib/registry</span>
<span class="line">  <span class="token key atrule">delete</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"><span class="token key atrule">http</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">addr</span><span class="token punctuation">:</span> <span class="token punctuation">:</span><span class="token number">5000</span></span>
<span class="line">  <span class="token key atrule">headers</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">X-Content-Type-Options</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>nosniff<span class="token punctuation">]</span></span>
<span class="line"><span class="token key atrule">health</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">storagedriver</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">interval</span><span class="token punctuation">:</span> 10s</span>
<span class="line">    <span class="token key atrule">threshold</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="云服务注册表" tabindex="-1"><a class="header-anchor" href="#云服务注册表"><span>云服务注册表</span></a></h3><h4 id="amazon-ecr" tabindex="-1"><a class="header-anchor" href="#amazon-ecr"><span>Amazon ECR</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 配置 ECR</span></span>
<span class="line">aws ecr get-login-password <span class="token parameter variable">--region</span> us-west-2 <span class="token operator">|</span> <span class="token punctuation">\\</span></span>
<span class="line"><span class="token function">docker</span> login <span class="token parameter variable">--username</span> AWS --password-stdin <span class="token punctuation">\\</span></span>
<span class="line"><span class="token number">123456789012</span>.dkr.ecr.us-west-2.amazonaws.com</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 推送镜像</span></span>
<span class="line"><span class="token function">docker</span> tag myapp:latest <span class="token number">123456789012</span>.dkr.ecr.us-west-2.amazonaws.com/myapp:latest</span>
<span class="line"><span class="token function">docker</span> push <span class="token number">123456789012</span>.dkr.ecr.us-west-2.amazonaws.com/myapp:latest</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="azure-container-registry" tabindex="-1"><a class="header-anchor" href="#azure-container-registry"><span>Azure Container Registry</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 配置 ACR</span></span>
<span class="line">az acr login <span class="token parameter variable">--name</span> myregistry</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 推送镜像</span></span>
<span class="line"><span class="token function">docker</span> tag myapp:latest myregistry.azurecr.io/myapp:latest</span>
<span class="line"><span class="token function">docker</span> push myregistry.azurecr.io/myapp:latest</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="性能优化" tabindex="-1"><a class="header-anchor" href="#性能优化"><span>性能优化</span></a></h2><h3 id="缓存策略" tabindex="-1"><a class="header-anchor" href="#缓存策略"><span>缓存策略</span></a></h3><h4 id="_1-客户端缓存" tabindex="-1"><a class="header-anchor" href="#_1-客户端缓存"><span>1. 客户端缓存</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># Docker 层缓存配置</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&quot;registry-mirrors&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;https://cache.example.com&quot;</span><span class="token punctuation">]</span>,</span>
<span class="line">    <span class="token string">&quot;max-concurrent-downloads&quot;</span><span class="token builtin class-name">:</span> <span class="token number">6</span>,</span>
<span class="line">    <span class="token string">&quot;max-concurrent-uploads&quot;</span><span class="token builtin class-name">:</span> <span class="token number">5</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-cdn-集成" tabindex="-1"><a class="header-anchor" href="#_2-cdn-集成"><span>2. CDN 集成</span></a></h4><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token comment"># nginx.conf for registry CDN</span></span>
<span class="line"><span class="token directive"><span class="token keyword">upstream</span> registry</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">server</span> registry1.example.com:5000</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">server</span> registry2.example.com:5000</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">443</span> ssl</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">server_name</span> registry.example.com</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token directive"><span class="token keyword">location</span> /v2/</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">proxy_pass</span> http://registry</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$http_host</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Proto <span class="token variable">$scheme</span></span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 缓存 Blob 内容</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">location</span> ~* /v2/.*/blobs/</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_cache</span> registry_cache</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_cache_valid</span> <span class="token number">200</span> <span class="token number">30d</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_cache_key</span> <span class="token variable">$uri</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">add_header</span> X-Cache-Status <span class="token variable">$upstream_cache_status</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="存储优化" tabindex="-1"><a class="header-anchor" href="#存储优化"><span>存储优化</span></a></h3><h4 id="重复数据删除" tabindex="-1"><a class="header-anchor" href="#重复数据删除"><span>重复数据删除</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 基于内容寻址的重复数据删除</span></span>
<span class="line"><span class="token keyword">type</span> BlobStore <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    storage <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span></span>
<span class="line">    refs    <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>bs <span class="token operator">*</span>BlobStore<span class="token punctuation">)</span> <span class="token function">Put</span><span class="token punctuation">(</span>digest <span class="token builtin">string</span><span class="token punctuation">,</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> exists <span class="token operator">:=</span> bs<span class="token punctuation">.</span>storage<span class="token punctuation">[</span>digest<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>exists <span class="token punctuation">{</span></span>
<span class="line">        bs<span class="token punctuation">.</span>storage<span class="token punctuation">[</span>digest<span class="token punctuation">]</span> <span class="token operator">=</span> data</span>
<span class="line">        bs<span class="token punctuation">.</span>refs<span class="token punctuation">[</span>digest<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    bs<span class="token punctuation">.</span>refs<span class="token punctuation">[</span>digest<span class="token punctuation">]</span><span class="token operator">++</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>bs <span class="token operator">*</span>BlobStore<span class="token punctuation">)</span> <span class="token function">Delete</span><span class="token punctuation">(</span>digest <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    bs<span class="token punctuation">.</span>refs<span class="token punctuation">[</span>digest<span class="token punctuation">]</span><span class="token operator">--</span></span>
<span class="line">    <span class="token keyword">if</span> bs<span class="token punctuation">.</span>refs<span class="token punctuation">[</span>digest<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">delete</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span>storage<span class="token punctuation">,</span> digest<span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">delete</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span>refs<span class="token punctuation">,</span> digest<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="垃圾回收" tabindex="-1"><a class="header-anchor" href="#垃圾回收"><span>垃圾回收</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># registry-gc.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 标记阶段：标记所有被引用的 Blob</span></span>
<span class="line">registry garbage-collect --dry-run /etc/registry/config.yml</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 清理阶段：删除未被引用的 Blob</span></span>
<span class="line">registry garbage-collect /etc/registry/config.yml</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 压缩存储空间</span></span>
<span class="line"><span class="token function">find</span> /var/lib/registry <span class="token parameter variable">-name</span> <span class="token string">&quot;*.tmp&quot;</span> <span class="token parameter variable">-delete</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="监控和运维" tabindex="-1"><a class="header-anchor" href="#监控和运维"><span>监控和运维</span></a></h2><h3 id="指标监控" tabindex="-1"><a class="header-anchor" href="#指标监控"><span>指标监控</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token comment"># prometheus-config.yml</span></span>
<span class="line"><span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">&#39;registry&#39;</span></span>
<span class="line">    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;registry:5000&#39;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">metrics_path</span><span class="token punctuation">:</span> /metrics</span>
<span class="line">    <span class="token key atrule">scrape_interval</span><span class="token punctuation">:</span> 30s</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="健康检查" tabindex="-1"><a class="header-anchor" href="#健康检查"><span>健康检查</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># registry-health-check.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检查 API 可用性</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token function">curl</span> <span class="token parameter variable">-f</span> <span class="token parameter variable">-s</span> <span class="token string">&quot;https://registry.example.com/v2/&quot;</span> <span class="token operator">&gt;</span> /dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;Registry API is healthy&quot;</span></span>
<span class="line"><span class="token keyword">else</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;Registry API is unhealthy&quot;</span></span>
<span class="line">    <span class="token builtin class-name">exit</span> <span class="token number">1</span></span>
<span class="line"><span class="token keyword">fi</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检查存储空间</span></span>
<span class="line"><span class="token assign-left variable">USAGE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">df</span> /var/lib/registry <span class="token operator">|</span> <span class="token function">tail</span> <span class="token parameter variable">-1</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{print $5}&#39;</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">&#39;s/%//&#39;</span><span class="token variable">)</span></span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$USAGE</span> <span class="token parameter variable">-gt</span> <span class="token number">90</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;Storage usage is critical: <span class="token variable">\${USAGE}</span>%&quot;</span></span>
<span class="line">    <span class="token builtin class-name">exit</span> <span class="token number">1</span></span>
<span class="line"><span class="token keyword">fi</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检查上传性能</span></span>
<span class="line"><span class="token assign-left variable">UPLOAD_TIME</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">time</span> <span class="token punctuation">(</span>echo <span class="token string">&quot;test&quot;</span> <span class="token operator">|</span> <span class="token function">curl</span> <span class="token parameter variable">-X</span> POST <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token string">&quot;https://registry.example.com/v2/test/blobs/uploads/&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">    --data-binary @- <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null<span class="token punctuation">)</span> <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">|</span> <span class="token function">grep</span> real <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{print $2}&#39;</span><span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;Upload test completed in <span class="token variable">$UPLOAD_TIME</span>&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="下一步学习" tabindex="-1"><a class="header-anchor" href="#下一步学习"><span>下一步学习</span></a></h2><p>完成 Distribution 规范学习后，建议继续学习：</p>`,128)),n("ol",null,[n("li",null,[n("strong",null,[e(p,{to:"/blogs/cloud-base/oci-05-security-guide.html"},{default:l(()=>s[14]||(s[14]=[a("OCI 容器安全配置实战")])),_:1,__:[14]})]),s[15]||(s[15]=a(" - 了解注册表安全配置"))]),n("li",null,[n("strong",null,[e(p,{to:"/blogs/cloud-base/oci-06-monitoring-guide.html"},{default:l(()=>s[16]||(s[16]=[a("OCI 容器监控调试与故障排除")])),_:1,__:[16]})]),s[17]||(s[17]=a(" - 学习分发系统监控"))]),n("li",null,[n("strong",null,[e(p,{to:"/blogs/cloud-base/oci-07-production-guide.html"},{default:l(()=>s[18]||(s[18]=[a("OCI 容器生产环境实践案例")])),_:1,__:[18]})]),s[19]||(s[19]=a(" - 掌握企业级注册表部署"))])]),s[33]||(s[33]=n("h2",{id:"总结",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#总结"},[n("span",null,"总结")])],-1)),s[34]||(s[34]=n("p",null,"OCI Distribution 规范为容器镜像的分发提供了标准化的 API 接口，通过统一的协议确保了不同注册表实现之间的互操作性。理解分发规范对于构建可靠的容器基础设施至关重要。",-1)),s[35]||(s[35]=n("p",null,[n("strong",null,"关键要点：")],-1)),s[36]||(s[36]=n("ul",null,[n("li",null,"Distribution API 提供了完整的镜像分发协议"),n("li",null,"支持分块上传、断点续传等高级特性"),n("li",null,"认证授权机制保证了访问安全"),n("li",null,"Referrers API 扩展了工件生态支持")],-1)),s[37]||(s[37]=n("hr",null,null,-1)),n("p",null,[s[23]||(s[23]=n("strong",null,"上一篇：",-1)),s[24]||(s[24]=a()),e(p,{to:"/blogs/cloud-base/oci-03-image-spec.html"},{default:l(()=>s[20]||(s[20]=[a("OCI Image 规范详解 - 容器镜像格式与构建")])),_:1,__:[20]}),s[25]||(s[25]=n("br",null,null,-1)),s[26]||(s[26]=n("strong",null,"下一篇：",-1)),s[27]||(s[27]=a()),e(p,{to:"/blogs/cloud-base/oci-05-security-guide.html"},{default:l(()=>s[21]||(s[21]=[a("OCI 容器安全配置实战")])),_:1,__:[21]}),s[28]||(s[28]=n("br",null,null,-1)),s[29]||(s[29]=n("strong",null,"返回：",-1)),s[30]||(s[30]=a()),e(p,{to:"/blogs/cloud-base/oci-series-index.html"},{default:l(()=>s[22]||(s[22]=[a("OCI 容器技术完全指南系列")])),_:1,__:[22]})])])}const h=o(u,[["render",k]]),g=JSON.parse('{"path":"/blogs/cloud-base/oci-04-distribution-spec.html","title":"OCI Distribution 规范详解 - 容器镜像分发协议","lang":"en-US","frontmatter":{"categories":["cloud-base"]},"headers":[{"level":2,"title":"概述","slug":"概述","link":"#概述","children":[]},{"level":2,"title":"分发规范基础","slug":"分发规范基础","link":"#分发规范基础","children":[{"level":3,"title":"核心概念","slug":"核心概念","link":"#核心概念","children":[]},{"level":3,"title":"架构设计","slug":"架构设计","link":"#架构设计","children":[]}]},{"level":2,"title":"注册表 API 接口","slug":"注册表-api-接口","link":"#注册表-api-接口","children":[{"level":3,"title":"版本协商","slug":"版本协商","link":"#版本协商","children":[]},{"level":3,"title":"核心端点","slug":"核心端点","link":"#核心端点","children":[]},{"level":3,"title":"错误处理","slug":"错误处理","link":"#错误处理","children":[]}]},{"level":2,"title":"认证和授权","slug":"认证和授权","link":"#认证和授权","children":[{"level":3,"title":"Bearer Token 认证","slug":"bearer-token-认证","link":"#bearer-token-认证","children":[]},{"level":3,"title":"权限范围","slug":"权限范围","link":"#权限范围","children":[]},{"level":3,"title":"Basic 认证","slug":"basic-认证","link":"#basic-认证","children":[]}]},{"level":2,"title":"内容分发协议","slug":"内容分发协议","link":"#内容分发协议","children":[{"level":3,"title":"推送工作流","slug":"推送工作流","link":"#推送工作流","children":[]},{"level":3,"title":"拉取优化","slug":"拉取优化","link":"#拉取优化","children":[]}]},{"level":2,"title":"Referrers API 和工件支持","slug":"referrers-api-和工件支持","link":"#referrers-api-和工件支持","children":[{"level":3,"title":"Referrers API","slug":"referrers-api","link":"#referrers-api","children":[]},{"level":3,"title":"工件清单","slug":"工件清单","link":"#工件清单","children":[]}]},{"level":2,"title":"注册表实现","slug":"注册表实现","link":"#注册表实现","children":[{"level":3,"title":"开源注册表","slug":"开源注册表","link":"#开源注册表","children":[]},{"level":3,"title":"云服务注册表","slug":"云服务注册表","link":"#云服务注册表","children":[]}]},{"level":2,"title":"性能优化","slug":"性能优化","link":"#性能优化","children":[{"level":3,"title":"缓存策略","slug":"缓存策略","link":"#缓存策略","children":[]},{"level":3,"title":"存储优化","slug":"存储优化","link":"#存储优化","children":[]}]},{"level":2,"title":"监控和运维","slug":"监控和运维","link":"#监控和运维","children":[{"level":3,"title":"指标监控","slug":"指标监控","link":"#指标监控","children":[]},{"level":3,"title":"健康检查","slug":"健康检查","link":"#健康检查","children":[]}]},{"level":2,"title":"下一步学习","slug":"下一步学习","link":"#下一步学习","children":[]},{"level":2,"title":"总结","slug":"总结","link":"#总结","children":[]}],"git":{"createdTime":1754503646000,"updatedTime":1754503646000,"contributors":[{"name":"hushengnian","email":"hushengnian@example.com","commits":1}]},"filePathRelative":"blogs/cloud-base/oci-04-distribution-spec.md"}');export{h as comp,g as data};

import{_ as c,c as o,b as s,a as u,e as a,d as e,w as l,r as i,o as r}from"./app-6X7aTgdN.js";const d={},k={href:"https://github.com/opencontainers/runtime-spec/blob/main/runtime.md#lifecycle",target:"_blank",rel:"noopener noreferrer"},v={href:"https://man7.org/linux/man-pages/man5/proc.5.html",target:"_blank",rel:"noopener noreferrer"},m={href:"https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/",target:"_blank",rel:"noopener noreferrer"};function b(h,n){const p=i("RouteLink"),t=i("ExternalLinkIcon");return r(),o("div",null,[n[18]||(n[18]=s("h1",{id:"容器生命周期管理",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#容器生命周期管理"},[s("span",null,"容器生命周期管理")])],-1)),s("blockquote",null,[s("p",null,[n[2]||(n[2]=s("strong",null,"系列导航：",-1)),n[3]||(n[3]=a()),e(p,{to:"/blogs/cloud-base/runc-deep-dive/"},{default:l(()=>n[0]||(n[0]=[a("runc 容器运行时深度解析系列")])),_:1,__:[0]}),n[4]||(n[4]=a(" → 第二篇：容器生命周期管理")),n[5]||(n[5]=s("br",null,null,-1)),n[6]||(n[6]=s("strong",null,"上一篇：",-1)),n[7]||(n[7]=a()),e(p,{to:"/blogs/cloud-base/runc-deep-dive/01-runc%E6%A6%82%E8%BF%B0%E4%B8%8E%E6%9E%B6%E6%9E%84.html"},{default:l(()=>n[1]||(n[1]=[a("runc概述与架构")])),_:1,__:[1]}),n[8]||(n[8]=s("br",null,null,-1)),n[9]||(n[9]=s("strong",null,"最后更新：",-1)),n[10]||(n[10]=a(" 2024"))])]),n[19]||(n[19]=u(`<h2 id="概述" tabindex="-1"><a class="header-anchor" href="#概述"><span>概述</span></a></h2><p>容器生命周期管理是 runc 的核心功能，包括容器的创建、启动、暂停、恢复、停止和删除等操作。本文深入分析 runc 如何管理容器状态转换、进程同步以及状态持久化机制。</p><h2 id="容器状态模型" tabindex="-1"><a class="header-anchor" href="#容器状态模型"><span>容器状态模型</span></a></h2><h3 id="_1-1-四种基本状态" tabindex="-1"><a class="header-anchor" href="#_1-1-四种基本状态"><span>1.1 四种基本状态</span></a></h3><p>runc 定义了四种容器状态，这些状态反映了容器在其生命周期中的不同阶段：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/container.go:17</span></span>
<span class="line"><span class="token keyword">type</span> Status <span class="token builtin">int</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token comment">// Created: 容器已创建但尚未运行</span></span>
<span class="line">    Created Status <span class="token operator">=</span> <span class="token boolean">iota</span></span>
<span class="line">    <span class="token comment">// Running: 容器正在运行</span></span>
<span class="line">    Running</span>
<span class="line">    <span class="token comment">// Paused: 容器存在，但所有进程都被暂停</span></span>
<span class="line">    Paused</span>
<span class="line">    <span class="token comment">// Stopped: 容器没有运行的进程</span></span>
<span class="line">    Stopped</span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-状态详细说明" tabindex="-1"><a class="header-anchor" href="#_1-2-状态详细说明"><span>1.2 状态详细说明</span></a></h3><table><thead><tr><th>状态</th><th>含义</th><th>特征</th><th>典型触发</th></tr></thead><tbody><tr><td><strong>Created</strong></td><td>容器已创建但初始化进程未启动</td><td>- 配置已加载<br>- 资源已分配<br>- 进程未执行</td><td><code>runc create</code></td></tr><tr><td><strong>Running</strong></td><td>容器正常运行</td><td>- 初始化进程正在执行<br>- 所有资源可用<br>- 可以接收信号</td><td><code>runc start</code><br><code>runc run</code></td></tr><tr><td><strong>Paused</strong></td><td>容器进程被冻结</td><td>- 进程存在但被挂起<br>- 内存状态保持<br>- 不消耗 CPU</td><td><code>runc pause</code></td></tr><tr><td><strong>Stopped</strong></td><td>容器已停止</td><td>- 没有运行的进程<br>- 资源可能仍被占用<br>- 可以被删除</td><td>进程退出<br><code>runc kill</code></td></tr></tbody></table><h3 id="_1-3-状态转换图" tabindex="-1"><a class="header-anchor" href="#_1-3-状态转换图"><span>1.3 状态转换图</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">    [容器不存在]</span>
<span class="line">          │</span>
<span class="line">          │ runc create</span>
<span class="line">          ▼</span>
<span class="line">    ┌──────────┐     runc start     ┌─────────┐</span>
<span class="line">    │ Created  │ ──────────────────▶│ Running │</span>
<span class="line">    └─────┬────┘                    └────┬────┘</span>
<span class="line">          │                              │</span>
<span class="line">          │ runc delete                  │ runc pause</span>
<span class="line">          │ (force)                      ▼</span>
<span class="line">          │                         ┌─────────┐</span>
<span class="line">          │                         │ Paused  │</span>
<span class="line">          │                         └────┬────┘</span>
<span class="line">          │                              │</span>
<span class="line">          │                              │ runc resume</span>
<span class="line">          │                              │</span>
<span class="line">          ▼                              ▼</span>
<span class="line">    ┌──────────┐    runc delete     ┌─────────┐</span>
<span class="line">    │ Stopped  │◀───────────────────│ Running │</span>
<span class="line">    └─────┬────┘                    └─────────┘</span>
<span class="line">          │                              ▲</span>
<span class="line">          │ 进程退出 / runc kill           │</span>
<span class="line">          └───────────────────────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-状态管理实现" tabindex="-1"><a class="header-anchor" href="#_2-状态管理实现"><span>2. 状态管理实现</span></a></h2><h3 id="_2-1-状态机接口" tabindex="-1"><a class="header-anchor" href="#_2-1-状态机接口"><span>2.1 状态机接口</span></a></h3><p>runc 使用状态机模式来管理容器状态：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/state_linux.go</span></span>
<span class="line"><span class="token keyword">type</span> containerState <span class="token keyword">interface</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">transition</span><span class="token punctuation">(</span>containerState<span class="token punctuation">)</span> <span class="token builtin">error</span>  <span class="token comment">// 状态转换</span></span>
<span class="line">    <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>                   <span class="token comment">// 销毁容器</span></span>
<span class="line">    <span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Status                   <span class="token comment">// 获取当前状态</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-具体状态实现" tabindex="-1"><a class="header-anchor" href="#_2-2-具体状态实现"><span>2.2 具体状态实现</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 已停止状态</span></span>
<span class="line"><span class="token keyword">type</span> stoppedState <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    c <span class="token operator">*</span>Container</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 已创建状态  </span></span>
<span class="line"><span class="token keyword">type</span> createdState <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    c <span class="token operator">*</span>Container</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 运行状态</span></span>
<span class="line"><span class="token keyword">type</span> runningState <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    c <span class="token operator">*</span>Container</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 暂停状态</span></span>
<span class="line"><span class="token keyword">type</span> pausedState <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    c <span class="token operator">*</span>Container</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-状态转换验证" tabindex="-1"><a class="header-anchor" href="#_2-3-状态转换验证"><span>2.3 状态转换验证</span></a></h3><p>每个状态都定义了允许的转换：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// createdState 的转换逻辑</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>createdState<span class="token punctuation">)</span> <span class="token function">transition</span><span class="token punctuation">(</span>s containerState<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">switch</span> s<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token operator">*</span>runningState<span class="token punctuation">,</span> <span class="token operator">*</span>pausedState<span class="token punctuation">,</span> <span class="token operator">*</span>stoppedState<span class="token punctuation">:</span></span>
<span class="line">        i<span class="token punctuation">.</span>c<span class="token punctuation">.</span>state <span class="token operator">=</span> s  <span class="token comment">// 允许的转换</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token operator">*</span>createdState<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span>     <span class="token comment">// 保持当前状态</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">newStateTransitionError</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> s<span class="token punctuation">)</span>  <span class="token comment">// 非法转换</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-核心命令实现" tabindex="-1"><a class="header-anchor" href="#_3-核心命令实现"><span>3. 核心命令实现</span></a></h2><h3 id="_3-1-命令类型定义" tabindex="-1"><a class="header-anchor" href="#_3-1-命令类型定义"><span>3.1 命令类型定义</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// utils.go</span></span>
<span class="line"><span class="token keyword">type</span> CtAct <span class="token builtin">uint8</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">(</span></span>
<span class="line">    CT_ACT_CREATE CtAct <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token operator">+</span> <span class="token number">1</span>  <span class="token comment">// 创建容器</span></span>
<span class="line">    CT_ACT_RUN                      <span class="token comment">// 运行容器</span></span>
<span class="line">    CT_ACT_RESTORE                  <span class="token comment">// 从检查点恢复</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-runc-create-创建容器" tabindex="-1"><a class="header-anchor" href="#_3-2-runc-create-创建容器"><span>3.2 <code>runc create</code> - 创建容器</span></a></h3><h4 id="执行流程" tabindex="-1"><a class="header-anchor" href="#执行流程"><span>执行流程</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// create.go:35</span></span>
<span class="line"><span class="token keyword">var</span> createCommand <span class="token operator">=</span> cli<span class="token punctuation">.</span>Command<span class="token punctuation">{</span></span>
<span class="line">    Name<span class="token punctuation">:</span>  <span class="token string">&quot;create&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    Usage<span class="token punctuation">:</span> <span class="token string">&quot;create a container&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    Action<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>context <span class="token operator">*</span>cli<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">checkArgs</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> exactArgs<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        spec<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">setupSpec</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">startContainer</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> CT_ACT_CREATE<span class="token punctuation">,</span> spec<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="关键步骤分析" tabindex="-1"><a class="header-anchor" href="#关键步骤分析"><span>关键步骤分析</span></a></h4><ol><li><strong>参数验证</strong>: 确保提供了容器 ID</li><li><strong>配置加载</strong>: 读取和解析 <code>config.json</code></li><li><strong>容器创建</strong>: 调用 <code>startContainer()</code> 执行创建逻辑</li></ol><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// utils.go:161 - startContainer 函数核心逻辑</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">startContainer</span><span class="token punctuation">(</span>context <span class="token operator">*</span>cli<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> action CtAct<span class="token punctuation">,</span> spec <span class="token operator">*</span>specs<span class="token punctuation">.</span>Spec<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    id <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 1. 创建或加载容器</span></span>
<span class="line">    container<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">createContainer</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> id<span class="token punctuation">,</span> spec<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 根据动作类型执行不同逻辑</span></span>
<span class="line">    <span class="token keyword">switch</span> action <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> CT_ACT_CREATE<span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// 只创建，不启动</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> container<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>process<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">case</span> CT_ACT_RUN<span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// 创建并运行</span></span>
<span class="line">        <span class="token keyword">return</span> container<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>process<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="create-命令的详细执行过程" tabindex="-1"><a class="header-anchor" href="#create-命令的详细执行过程"><span><code>create</code> 命令的详细执行过程</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">runc create mycontainer</span>
<span class="line">        │</span>
<span class="line">        ▼</span>
<span class="line">┌─────────────────────────────────────┐</span>
<span class="line">│ 1. CLI 解析和验证                   │</span>
<span class="line">│    - 检查参数数量                   │</span>
<span class="line">│    - 提取容器 ID                    │</span>
<span class="line">└─────────────┬───────────────────────┘</span>
<span class="line">              │</span>
<span class="line">              ▼</span>
<span class="line">┌─────────────────────────────────────┐</span>
<span class="line">│ 2. 配置加载 (setupSpec)             │</span>
<span class="line">│    - 读取 config.json               │</span>
<span class="line">│    - 验证 OCI 规范兼容性            │</span>
<span class="line">│    - 处理默认值                     │</span>
<span class="line">└─────────────┬───────────────────────┘</span>
<span class="line">              │</span>
<span class="line">              ▼</span>
<span class="line">┌─────────────────────────────────────┐</span>
<span class="line">│ 3. 容器创建 (createContainer)       │</span>
<span class="line">│    - OCI → libcontainer 配置转换    │</span>
<span class="line">│    - 创建 Container 对象            │</span>
<span class="line">│    - 设置状态目录                   │</span>
<span class="line">└─────────────┬───────────────────────┘</span>
<span class="line">              │</span>
<span class="line">              ▼</span>
<span class="line">┌─────────────────────────────────────┐</span>
<span class="line">│ 4. 进程准备 (container.Start)       │</span>
<span class="line">│    - 创建 namespace                 │</span>
<span class="line">│    - 设置 cgroups                   │</span>
<span class="line">│    - 初始化文件系统                  │</span>
<span class="line">│    - 启动初始化进程                  │</span>
<span class="line">│    - 状态: nil → Created            │</span>
<span class="line">└─────────────────────────────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-runc-start-启动容器" tabindex="-1"><a class="header-anchor" href="#_3-3-runc-start-启动容器"><span>3.3 <code>runc start</code> - 启动容器</span></a></h3><h4 id="执行流程-1" tabindex="-1"><a class="header-anchor" href="#执行流程-1"><span>执行流程</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// start.go:15</span></span>
<span class="line"><span class="token keyword">var</span> startCommand <span class="token operator">=</span> cli<span class="token punctuation">.</span>Command<span class="token punctuation">{</span></span>
<span class="line">    Name<span class="token punctuation">:</span>  <span class="token string">&quot;start&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    Usage<span class="token punctuation">:</span> <span class="token string">&quot;executes the user defined process in a created container&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    Action<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>context <span class="token operator">*</span>cli<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">        container<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getContainer</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        status<span class="token punctuation">,</span> err <span class="token operator">:=</span> container<span class="token punctuation">.</span><span class="token function">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">switch</span> status <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">case</span> libcontainer<span class="token punctuation">.</span>Created<span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment">// 只有 Created 状态的容器可以被启动</span></span>
<span class="line">            <span class="token keyword">return</span> container<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">case</span> libcontainer<span class="token punctuation">.</span>Stopped<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;cannot start a container that has stopped&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">case</span> libcontainer<span class="token punctuation">.</span>Running<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;cannot start an already running container&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">default</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;cannot start a container in the %s state&quot;</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="关键特点" tabindex="-1"><a class="header-anchor" href="#关键特点"><span>关键特点</span></a></h4><ol><li><strong>状态检查</strong>: 只能启动 <code>Created</code> 状态的容器</li><li><strong>状态加载</strong>: 从磁盘加载容器状态</li><li><strong>进程启动</strong>: 使用 <code>container.Exec()</code> 启动初始化进程</li></ol><h4 id="exec-fifo-同步机制" tabindex="-1"><a class="header-anchor" href="#exec-fifo-同步机制"><span>Exec Fifo 同步机制</span></a></h4><p><code>runc start</code> 使用 <strong>exec fifo</strong> 机制来精确控制进程启动时机：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/container_linux.go:298</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Container<span class="token punctuation">)</span> <span class="token function">Exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    path <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>stateDir<span class="token punctuation">,</span> execFifoFilename<span class="token punctuation">)</span></span>
<span class="line">    blockingFifoOpenCh <span class="token operator">:=</span> <span class="token function">awaitFifoOpen</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">select</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">case</span> result <span class="token operator">:=</span> <span class="token operator">&lt;-</span>blockingFifoOpenCh<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">handleFifoResult</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment">// 定期检查进程是否仍然存活</span></span>
<span class="line">            stat<span class="token punctuation">,</span> err <span class="token operator">:=</span> system<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> stat<span class="token punctuation">.</span>State <span class="token operator">==</span> system<span class="token punctuation">.</span>Zombie <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;container process is already dead&quot;</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Exec Fifo 工作原理</strong>：</p><ol><li><code>runc create</code> 创建容器时，创建一个名为 <code>exec.fifo</code> 的文件</li><li>初始化进程等待有人打开这个 fifo 文件</li><li><code>runc start</code> 打开 fifo 文件，触发初始化进程开始执行</li><li>状态转换：<code>Created</code> → <code>Running</code></li></ol><h3 id="_3-4-runc-run-一步运行" tabindex="-1"><a class="header-anchor" href="#_3-4-runc-run-一步运行"><span>3.4 <code>runc run</code> - 一步运行</span></a></h3><h4 id="执行流程-2" tabindex="-1"><a class="header-anchor" href="#执行流程-2"><span>执行流程</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// run.go:28</span></span>
<span class="line"><span class="token keyword">var</span> runCommand <span class="token operator">=</span> cli<span class="token punctuation">.</span>Command<span class="token punctuation">{</span></span>
<span class="line">    Name<span class="token punctuation">:</span>  <span class="token string">&quot;run&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    Usage<span class="token punctuation">:</span> <span class="token string">&quot;create and run a container&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    Action<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>context <span class="token operator">*</span>cli<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">        spec<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">setupSpec</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        status<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">startContainer</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> CT_ACT_RUN<span class="token punctuation">,</span> spec<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 等待容器进程结束并返回退出状态</span></span>
<span class="line">            os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;runc run failed: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="与-create-start-的区别" tabindex="-1"><a class="header-anchor" href="#与-create-start-的区别"><span>与 <code>create</code> + <code>start</code> 的区别</span></a></h4><table><thead><tr><th>特性</th><th><code>runc run</code></th><th><code>runc create</code> + <code>runc start</code></th></tr></thead><tbody><tr><td>步骤数</td><td>一步完成</td><td>两步操作</td></tr><tr><td>状态转换</td><td>直接 <code>nil</code> → <code>Running</code></td><td><code>nil</code> → <code>Created</code> → <code>Running</code></td></tr><tr><td>使用场景</td><td>简单快速启动</td><td>需要在启动前进行配置</td></tr><tr><td>控制粒度</td><td>较粗</td><td>较细</td></tr></tbody></table><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// utils.go 中 CT_ACT_RUN 的处理</span></span>
<span class="line"><span class="token keyword">case</span> CT_ACT_RUN<span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment">// 直接运行，跳过 Created 状态</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> container<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>process<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        container<span class="token punctuation">.</span><span class="token function">Destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// 等待进程结束</span></span>
<span class="line">    status<span class="token punctuation">,</span> err <span class="token operator">:=</span> process<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> status<span class="token punctuation">,</span> err</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-5-runc-state-查询状态" tabindex="-1"><a class="header-anchor" href="#_3-5-runc-state-查询状态"><span>3.5 <code>runc state</code> - 查询状态</span></a></h3><h4 id="执行流程-3" tabindex="-1"><a class="header-anchor" href="#执行流程-3"><span>执行流程</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// state.go:15</span></span>
<span class="line"><span class="token keyword">var</span> stateCommand <span class="token operator">=</span> cli<span class="token punctuation">.</span>Command<span class="token punctuation">{</span></span>
<span class="line">    Name<span class="token punctuation">:</span>  <span class="token string">&quot;state&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    Usage<span class="token punctuation">:</span> <span class="token string">&quot;output the state of a container&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    Action<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>context <span class="token operator">*</span>cli<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">        container<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getContainer</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 获取容器状态</span></span>
<span class="line">        containerStatus<span class="token punctuation">,</span> err <span class="token operator">:=</span> container<span class="token punctuation">.</span><span class="token function">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        state<span class="token punctuation">,</span> err <span class="token operator">:=</span> container<span class="token punctuation">.</span><span class="token function">State</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 构建输出格式</span></span>
<span class="line">        cs <span class="token operator">:=</span> containerState<span class="token punctuation">{</span></span>
<span class="line">            Version<span class="token punctuation">:</span>        state<span class="token punctuation">.</span>BaseState<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Version<span class="token punctuation">,</span></span>
<span class="line">            ID<span class="token punctuation">:</span>             state<span class="token punctuation">.</span>BaseState<span class="token punctuation">.</span>ID<span class="token punctuation">,</span></span>
<span class="line">            Status<span class="token punctuation">:</span>         containerStatus<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            Bundle<span class="token punctuation">:</span>         bundle<span class="token punctuation">,</span></span>
<span class="line">            Created<span class="token punctuation">:</span>        state<span class="token punctuation">.</span>BaseState<span class="token punctuation">.</span>Created<span class="token punctuation">,</span></span>
<span class="line">            InitProcessPid<span class="token punctuation">:</span> pid<span class="token punctuation">,</span></span>
<span class="line">            <span class="token comment">// ... 更多字段</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// JSON 格式输出</span></span>
<span class="line">        data<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">MarshalIndent</span><span class="token punctuation">(</span>cs<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;  &quot;</span><span class="token punctuation">)</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> <span class="token string">&quot;%s&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="输出示例" tabindex="-1"><a class="header-anchor" href="#输出示例"><span>输出示例</span></a></h4><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;ociVersion&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.2&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mycontainer&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;running&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;pid&quot;</span><span class="token operator">:</span> <span class="token number">1234</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;bundle&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/tmp/mycontainer&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;rootfs&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/tmp/mycontainer/rootfs&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;created&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-01-01T12:00:00.000000000Z&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;annotations&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;mykey&quot;</span><span class="token operator">:</span> <span class="token string">&quot;myvalue&quot;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-6-runc-delete-删除容器" tabindex="-1"><a class="header-anchor" href="#_3-6-runc-delete-删除容器"><span>3.6 <code>runc delete</code> - 删除容器</span></a></h3><h4 id="执行流程-4" tabindex="-1"><a class="header-anchor" href="#执行流程-4"><span>执行流程</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// delete.go:20</span></span>
<span class="line"><span class="token keyword">var</span> deleteCommand <span class="token operator">=</span> cli<span class="token punctuation">.</span>Command<span class="token punctuation">{</span></span>
<span class="line">    Name<span class="token punctuation">:</span>  <span class="token string">&quot;delete&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    Usage<span class="token punctuation">:</span> <span class="token string">&quot;delete any resources held by the container often used with detached container&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    Flags<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>cli<span class="token punctuation">.</span>Flag<span class="token punctuation">{</span></span>
<span class="line">        cli<span class="token punctuation">.</span>BoolFlag<span class="token punctuation">{</span></span>
<span class="line">            Name<span class="token punctuation">:</span>  <span class="token string">&quot;force, f&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            Usage<span class="token punctuation">:</span> <span class="token string">&quot;Forcibly deletes the container if it is still running (uses SIGKILL)&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    Action<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>context <span class="token operator">*</span>cli<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">        container<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getContainer</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 容器不存在，考虑已删除成功</span></span>
<span class="line">            <span class="token keyword">if</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        force <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span><span class="token string">&quot;force&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> force <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">killContainer</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        s<span class="token punctuation">,</span> err <span class="token operator">:=</span> container<span class="token punctuation">.</span><span class="token function">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">switch</span> s <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">case</span> libcontainer<span class="token punctuation">.</span>Stopped<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> container<span class="token punctuation">.</span><span class="token function">Destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 正常删除</span></span>
<span class="line">        <span class="token keyword">case</span> libcontainer<span class="token punctuation">.</span>Created<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">killContainer</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span>  <span class="token comment">// 强制删除</span></span>
<span class="line">        <span class="token keyword">default</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;cannot delete container %s that is not stopped: %s&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> s<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="删除逻辑" tabindex="-1"><a class="header-anchor" href="#删除逻辑"><span>删除逻辑</span></a></h4><ol><li><strong>状态检查</strong>: 只能删除 <code>Stopped</code> 状态的容器</li><li><strong>强制删除</strong>: <code>--force</code> 标志可以删除任何状态的容器</li><li><strong>资源清理</strong>: 删除状态文件、清理 cgroups、清理 namespace</li></ol><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// container.Destroy() 的清理步骤</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Container<span class="token punctuation">)</span> <span class="token function">Destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    c<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> c<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 1. 清理 cgroups</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>cgroupManager<span class="token punctuation">.</span><span class="token function">Destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 删除状态目录</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">RemoveAll</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>stateDir<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 更新状态</span></span>
<span class="line">    c<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token operator">&amp;</span>stoppedState<span class="token punctuation">{</span>c<span class="token punctuation">:</span> c<span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-状态持久化机制" tabindex="-1"><a class="header-anchor" href="#_4-状态持久化机制"><span>4. 状态持久化机制</span></a></h2><h3 id="_4-1-状态存储结构" tabindex="-1"><a class="header-anchor" href="#_4-1-状态存储结构"><span>4.1 状态存储结构</span></a></h3><p>容器状态持久化在以下位置：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">/run/runc/&lt;container-id&gt;/</span>
<span class="line">├── state.json          # 容器状态数据</span>
<span class="line">├── exec.fifo          # 启动同步机制</span>
<span class="line">└── hooks/             # 钩子函数相关文件</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-状态数据结构" tabindex="-1"><a class="header-anchor" href="#_4-2-状态数据结构"><span>4.2 状态数据结构</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/state.go</span></span>
<span class="line"><span class="token keyword">type</span> State <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    BaseState</span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// Linux 特定状态</span></span>
<span class="line">    Rootless       <span class="token builtin">bool</span>                              <span class="token string">\`json:&quot;rootless&quot;\`</span></span>
<span class="line">    CgroupPaths    <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>                 <span class="token string">\`json:&quot;cgroup_paths&quot;\`</span></span>
<span class="line">    NamespacePaths <span class="token keyword">map</span><span class="token punctuation">[</span>configs<span class="token punctuation">.</span>NamespaceType<span class="token punctuation">]</span><span class="token builtin">string</span>  <span class="token string">\`json:&quot;namespace_paths&quot;\`</span></span>
<span class="line">    ExternalDescriptors <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>                      <span class="token string">\`json:&quot;external_descriptors&quot;\`</span></span>
<span class="line">    IntelRdtPath   <span class="token builtin">string</span>                            <span class="token string">\`json:&quot;intel_rdt_path&quot;\`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> BaseState <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    ID                   <span class="token builtin">string</span>        <span class="token string">\`json:&quot;id&quot;\`</span></span>
<span class="line">    InitProcessPid       <span class="token builtin">int</span>           <span class="token string">\`json:&quot;init_process_pid&quot;\`</span>  </span>
<span class="line">    InitProcessStartTime <span class="token builtin">uint64</span>        <span class="token string">\`json:&quot;init_process_start&quot;\`</span></span>
<span class="line">    Created              time<span class="token punctuation">.</span>Time     <span class="token string">\`json:&quot;created&quot;\`</span></span>
<span class="line">    Config               configs<span class="token punctuation">.</span>Config <span class="token string">\`json:&quot;config&quot;\`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-状态加载过程" tabindex="-1"><a class="header-anchor" href="#_4-3-状态加载过程"><span>4.3 状态加载过程</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/factory_linux.go:190</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">Load</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Container<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    stateDir<span class="token punctuation">,</span> err <span class="token operator">:=</span> securejoin<span class="token punctuation">.</span><span class="token function">SecureJoin</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> id<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 1. 从 state.json 加载状态</span></span>
<span class="line">    state<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">loadState</span><span class="token punctuation">(</span>stateDir<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 重建容器对象</span></span>
<span class="line">    container <span class="token operator">:=</span> <span class="token operator">&amp;</span>Container<span class="token punctuation">{</span></span>
<span class="line">        initProcess<span class="token punctuation">:</span>          nonChildProcess<span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        initProcessStartTime<span class="token punctuation">:</span> state<span class="token punctuation">.</span>InitProcessStartTime<span class="token punctuation">,</span></span>
<span class="line">        id<span class="token punctuation">:</span>                   id<span class="token punctuation">,</span></span>
<span class="line">        config<span class="token punctuation">:</span>               <span class="token operator">&amp;</span>state<span class="token punctuation">.</span>Config<span class="token punctuation">,</span></span>
<span class="line">        stateDir<span class="token punctuation">:</span>             stateDir<span class="token punctuation">,</span></span>
<span class="line">        created<span class="token punctuation">:</span>              state<span class="token punctuation">.</span>Created<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 刷新运行时状态</span></span>
<span class="line">    container<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token operator">&amp;</span>loadedState<span class="token punctuation">{</span>c<span class="token punctuation">:</span> container<span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> container<span class="token punctuation">.</span><span class="token function">refreshState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> container<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-状态同步机制" tabindex="-1"><a class="header-anchor" href="#_4-4-状态同步机制"><span>4.4 状态同步机制</span></a></h3><p><code>refreshState()</code> 方法负责将磁盘状态与实际运行时状态同步：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/container_linux.go:156</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Container<span class="token punctuation">)</span> <span class="token function">refreshState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 检查是否被暂停</span></span>
<span class="line">    paused<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> paused <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> c<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">transition</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pausedState<span class="token punctuation">{</span>c<span class="token punctuation">:</span> c<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 检查初始化进程是否存在</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span>c<span class="token punctuation">.</span><span class="token function">hasInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> c<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">transition</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stoppedState<span class="token punctuation">{</span>c<span class="token punctuation">:</span> c<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 检查是否处于 Created 状态</span></span>
<span class="line">    <span class="token comment">// 通过检查 exec.fifo 文件是否存在来判断</span></span>
<span class="line">    fifoPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>stateDir<span class="token punctuation">,</span> execFifoFilename<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>fifoPath<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> c<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">transition</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>createdState<span class="token punctuation">{</span>c<span class="token punctuation">:</span> c<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. 默认为 Running 状态</span></span>
<span class="line">    <span class="token keyword">return</span> c<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">transition</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>runningState<span class="token punctuation">{</span>c<span class="token punctuation">:</span> c<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-进程管理与同步" tabindex="-1"><a class="header-anchor" href="#_5-进程管理与同步"><span>5. 进程管理与同步</span></a></h2><h3 id="_5-1-初始化进程模型" tabindex="-1"><a class="header-anchor" href="#_5-1-初始化进程模型"><span>5.1 初始化进程模型</span></a></h3><p>runc 使用分层的进程模型来管理容器：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">┌─────────────────┐</span>
<span class="line">│   runc 主进程   │  ← 用户调用的 runc 命令</span>
<span class="line">└─────────┬───────┘</span>
<span class="line">          │ fork()</span>
<span class="line">          ▼</span>
<span class="line">┌─────────────────┐</span>
<span class="line">│  bootstrap 进程 │  ← 负责 namespace 设置和初始化</span>
<span class="line">└─────────┬───────┘</span>
<span class="line">          │ exec()</span>
<span class="line">          ▼</span>
<span class="line">┌─────────────────┐</span>
<span class="line">│  container 进程 │  ← 最终的用户进程</span>
<span class="line">└─────────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-进程接口定义" tabindex="-1"><a class="header-anchor" href="#_5-2-进程接口定义"><span>5.2 进程接口定义</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/process.go:52</span></span>
<span class="line"><span class="token keyword">type</span> parentProcess <span class="token keyword">interface</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">pid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>                           <span class="token comment">// 获取进程 PID</span></span>
<span class="line">    <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>                       <span class="token comment">// 启动进程</span></span>
<span class="line">    <span class="token function">signal</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span> <span class="token builtin">error</span>             <span class="token comment">// 发送信号</span></span>
<span class="line">    <span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>                   <span class="token comment">// 终止进程</span></span>
<span class="line">    <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>os<span class="token punctuation">.</span>ProcessState<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>    <span class="token comment">// 等待进程结束</span></span>
<span class="line">    <span class="token function">startTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">uint64</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>         <span class="token comment">// 获取启动时间</span></span>
<span class="line">    <span class="token function">externalDescriptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>      <span class="token comment">// 外部文件描述符</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-进程创建流程" tabindex="-1"><a class="header-anchor" href="#_5-3-进程创建流程"><span>5.3 进程创建流程</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/container_linux.go:485</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Container<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span>process <span class="token operator">*</span>Process<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    c<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> c<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 1. 状态检查</span></span>
<span class="line">    <span class="token keyword">if</span> c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Cgroups <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Cgroups<span class="token punctuation">.</span>Resources <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 验证 cgroups 配置</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 创建父进程</span></span>
<span class="line">    parent<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">newParentProcess</span><span class="token punctuation">(</span>process<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. 启动进程</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> parent<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. 保存进程信息</span></span>
<span class="line">    c<span class="token punctuation">.</span>initProcess <span class="token operator">=</span> parent</span>
<span class="line">    c<span class="token punctuation">.</span>initProcessStartTime<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">startTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 5. 状态转换</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">transition</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>createdState<span class="token punctuation">{</span>c<span class="token punctuation">:</span> c<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-同步机制" tabindex="-1"><a class="header-anchor" href="#_5-4-同步机制"><span>5.4 同步机制</span></a></h3><h4 id="exec-fifo-详解" tabindex="-1"><a class="header-anchor" href="#exec-fifo-详解"><span>Exec Fifo 详解</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/utils.go:45</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">awaitFifoOpen</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> openResult <span class="token punctuation">{</span></span>
<span class="line">    fifoOpened <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> openResult<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>fifoOpened<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 创建 fifo 文件</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Mkfifo</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token number">0622</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>os<span class="token punctuation">.</span><span class="token function">IsExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            fifoOpened <span class="token operator">&lt;-</span> openResult<span class="token punctuation">{</span>err<span class="token punctuation">:</span> err<span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 等待另一端打开 fifo</span></span>
<span class="line">        fd<span class="token punctuation">,</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>O_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            fifoOpened <span class="token operator">&lt;-</span> openResult<span class="token punctuation">{</span>err<span class="token punctuation">:</span> err<span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        fifoOpened <span class="token operator">&lt;-</span> openResult<span class="token punctuation">{</span>file<span class="token punctuation">:</span> os<span class="token punctuation">.</span><span class="token function">NewFile</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> fifoOpened</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>工作流程</strong>：</p><ol><li><strong>创建阶段</strong> (<code>runc create</code>): 创建 <code>exec.fifo</code> 文件，初始化进程等待</li><li><strong>启动阶段</strong> (<code>runc start</code>): 打开 <code>exec.fifo</code> 文件，释放等待的初始化进程</li><li><strong>清理阶段</strong>: 删除 <code>exec.fifo</code> 文件，状态转换到 <code>Running</code></li></ol><h2 id="_6-实践练习" tabindex="-1"><a class="header-anchor" href="#_6-实践练习"><span>6. 实践练习</span></a></h2><h3 id="_6-1-状态转换实验" tabindex="-1"><a class="header-anchor" href="#_6-1-状态转换实验"><span>6.1 状态转换实验</span></a></h3><p>创建一个容器并观察状态变化：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 1. 准备容器环境</span></span>
<span class="line"><span class="token function">mkdir</span> /tmp/container-lifecycle</span>
<span class="line"><span class="token builtin class-name">cd</span> /tmp/container-lifecycle</span>
<span class="line"><span class="token function">mkdir</span> rootfs</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 2. 准备根文件系统</span></span>
<span class="line"><span class="token function">docker</span> <span class="token builtin class-name">export</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> create busybox<span class="token variable">)</span></span> <span class="token operator">|</span> <span class="token function">tar</span> <span class="token parameter variable">-C</span> rootfs <span class="token parameter variable">-xf</span> -</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 3. 生成配置文件</span></span>
<span class="line">runc spec</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 4. 观察状态转换</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;=== 创建容器 ===&quot;</span></span>
<span class="line">runc create test-container</span>
<span class="line">runc state test-container</span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;=== 启动容器 ===&quot;</span></span>
<span class="line">runc start test-container <span class="token operator">&amp;</span></span>
<span class="line"><span class="token function">sleep</span> <span class="token number">1</span></span>
<span class="line">runc state test-container</span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;=== 暂停容器 ===&quot;</span></span>
<span class="line">runc pause test-container</span>
<span class="line">runc state test-container</span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;=== 恢复容器 ===&quot;</span></span>
<span class="line">runc resume test-container</span>
<span class="line">runc state test-container</span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;=== 删除容器 ===&quot;</span></span>
<span class="line">runc <span class="token function">kill</span> test-container</span>
<span class="line">runc delete test-container</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-代码跟踪练习" tabindex="-1"><a class="header-anchor" href="#_6-2-代码跟踪练习"><span>6.2 代码跟踪练习</span></a></h3><p>在关键位置添加日志来跟踪状态转换：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// 在 libcontainer/state_linux.go 中添加日志</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>createdState<span class="token punctuation">)</span> <span class="token function">transition</span><span class="token punctuation">(</span>s containerState<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;DEBUG: Transitioning from &#39;created&#39; to &#39;%T&#39;\\n&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">switch</span> s<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token operator">*</span>runningState<span class="token punctuation">:</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;DEBUG: Container starting execution\\n&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        i<span class="token punctuation">.</span>c<span class="token punctuation">.</span>state <span class="token operator">=</span> s</span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token comment">// ... 其他状态</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">newStateTransitionError</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> s<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-exec-fifo-实验" tabindex="-1"><a class="header-anchor" href="#_6-3-exec-fifo-实验"><span>6.3 Exec Fifo 实验</span></a></h3><p>观察 exec fifo 的创建和使用：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 终端 1: 创建容器并监控 fifo</span></span>
<span class="line">runc create test-container</span>
<span class="line"><span class="token function">ls</span> <span class="token parameter variable">-la</span> /run/runc/test-container/</span>
<span class="line"><span class="token function">watch</span> <span class="token parameter variable">-n</span> <span class="token number">0.1</span> <span class="token string">&quot;ls -la /run/runc/test-container/ | grep fifo&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 终端 2: 启动容器</span></span>
<span class="line">runc start test-container</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 观察 exec.fifo 文件的创建和删除</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-深入思考" tabindex="-1"><a class="header-anchor" href="#_7-深入思考"><span>7. 深入思考</span></a></h2><h3 id="_7-1-设计问题" tabindex="-1"><a class="header-anchor" href="#_7-1-设计问题"><span>7.1 设计问题</span></a></h3><ol><li><p><strong>为什么需要 Created 状态？</strong></p><ul><li>允许在实际执行前进行额外配置</li><li>支持复杂的启动编排</li><li>符合 OCI 规范要求</li></ul></li><li><p><strong>Exec Fifo 的作用是什么？</strong></p><ul><li>精确控制进程启动时机</li><li>避免竞态条件</li><li>支持同步和异步操作模式</li></ul></li><li><p><strong>状态持久化的必要性？</strong></p><ul><li>跨进程状态共享</li><li>故障恢复能力</li><li>支持容器管理工具集成</li></ul></li></ol><h3 id="_7-2-性能考虑" tabindex="-1"><a class="header-anchor" href="#_7-2-性能考虑"><span>7.2 性能考虑</span></a></h3><ol><li><strong>状态检查的开销</strong>: 频繁的状态查询可能影响性能</li><li><strong>进程同步成本</strong>: Fifo 机制增加了启动延迟</li><li><strong>持久化 I/O</strong>: 状态文件的读写操作</li></ol><h3 id="_7-3-错误处理" tabindex="-1"><a class="header-anchor" href="#_7-3-错误处理"><span>7.3 错误处理</span></a></h3><ol><li><strong>状态不一致</strong>: 如何处理磁盘状态与实际状态不符？</li><li><strong>进程清理</strong>: 异常情况下如何确保资源清理？</li><li><strong>并发控制</strong>: 多个 runc 进程同时操作同一容器？</li></ol><h2 id="_8-扩展阅读" tabindex="-1"><a class="header-anchor" href="#_8-扩展阅读"><span>8. 扩展阅读</span></a></h2>`,99)),s("ul",null,[s("li",null,[s("a",k,[n[11]||(n[11]=a("OCI Runtime Specification - Container Lifecycle")),e(t)])]),s("li",null,[s("a",v,[n[12]||(n[12]=a("Linux Process State Management")),e(t)])]),s("li",null,[s("a",m,[n[13]||(n[13]=a("Container State in Kubernetes")),e(t)])])]),n[20]||(n[20]=s("h2",{id:"🎯-模块总结",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#🎯-模块总结"},[s("span",null,"🎯 模块总结")])],-1)),n[21]||(n[21]=s("p",null,"通过本模块的学习，你应该已经掌握了：",-1)),n[22]||(n[22]=s("p",null,[a("✅ 容器的四种基本状态和转换规则"),s("br"),a(" ✅ runc 核心命令的实现原理和执行流程"),s("br"),a(" ✅ 状态持久化和同步机制"),s("br"),a(" ✅ 进程管理和 Exec Fifo 同步机制"),s("br"),a(" ✅ 容器生命周期管理的设计模式")],-1)),s("p",null,[n[15]||(n[15]=s("strong",null,"下一步",-1)),n[16]||(n[16]=a(": 进入 ")),e(p,{to:"/blogs/cloud-base/runc-deep-dive/03-Namespace%E9%9A%94%E7%A6%BB%E5%AE%9E%E7%8E%B0.html"},{default:l(()=>n[14]||(n[14]=[a("模块 3: Namespace 隔离实现")])),_:1,__:[14]}),n[17]||(n[17]=a("，深入了解容器隔离的核心技术。"))])])}const f=c(d,[["render",b]]),y=JSON.parse('{"path":"/blogs/cloud-base/runc-deep-dive/02-rongqishengmingzhouqiguanli.html","title":"容器生命周期管理","lang":"en-US","frontmatter":{"title":"容器生命周期管理","date":"2025-08-02T00:00:00.000Z","tags":["runc","云原生","生命周期"],"categories":["cloud-base/runc-deep-dive"],"sidebar":"auto"},"headers":[{"level":2,"title":"概述","slug":"概述","link":"#概述","children":[]},{"level":2,"title":"容器状态模型","slug":"容器状态模型","link":"#容器状态模型","children":[{"level":3,"title":"1.1 四种基本状态","slug":"_1-1-四种基本状态","link":"#_1-1-四种基本状态","children":[]},{"level":3,"title":"1.2 状态详细说明","slug":"_1-2-状态详细说明","link":"#_1-2-状态详细说明","children":[]},{"level":3,"title":"1.3 状态转换图","slug":"_1-3-状态转换图","link":"#_1-3-状态转换图","children":[]}]},{"level":2,"title":"2. 状态管理实现","slug":"_2-状态管理实现","link":"#_2-状态管理实现","children":[{"level":3,"title":"2.1 状态机接口","slug":"_2-1-状态机接口","link":"#_2-1-状态机接口","children":[]},{"level":3,"title":"2.2 具体状态实现","slug":"_2-2-具体状态实现","link":"#_2-2-具体状态实现","children":[]},{"level":3,"title":"2.3 状态转换验证","slug":"_2-3-状态转换验证","link":"#_2-3-状态转换验证","children":[]}]},{"level":2,"title":"3. 核心命令实现","slug":"_3-核心命令实现","link":"#_3-核心命令实现","children":[{"level":3,"title":"3.1 命令类型定义","slug":"_3-1-命令类型定义","link":"#_3-1-命令类型定义","children":[]},{"level":3,"title":"3.2 runc create - 创建容器","slug":"_3-2-runc-create-创建容器","link":"#_3-2-runc-create-创建容器","children":[]},{"level":3,"title":"3.3 runc start - 启动容器","slug":"_3-3-runc-start-启动容器","link":"#_3-3-runc-start-启动容器","children":[]},{"level":3,"title":"3.4 runc run - 一步运行","slug":"_3-4-runc-run-一步运行","link":"#_3-4-runc-run-一步运行","children":[]},{"level":3,"title":"3.5 runc state - 查询状态","slug":"_3-5-runc-state-查询状态","link":"#_3-5-runc-state-查询状态","children":[]},{"level":3,"title":"3.6 runc delete - 删除容器","slug":"_3-6-runc-delete-删除容器","link":"#_3-6-runc-delete-删除容器","children":[]}]},{"level":2,"title":"4. 状态持久化机制","slug":"_4-状态持久化机制","link":"#_4-状态持久化机制","children":[{"level":3,"title":"4.1 状态存储结构","slug":"_4-1-状态存储结构","link":"#_4-1-状态存储结构","children":[]},{"level":3,"title":"4.2 状态数据结构","slug":"_4-2-状态数据结构","link":"#_4-2-状态数据结构","children":[]},{"level":3,"title":"4.3 状态加载过程","slug":"_4-3-状态加载过程","link":"#_4-3-状态加载过程","children":[]},{"level":3,"title":"4.4 状态同步机制","slug":"_4-4-状态同步机制","link":"#_4-4-状态同步机制","children":[]}]},{"level":2,"title":"5. 进程管理与同步","slug":"_5-进程管理与同步","link":"#_5-进程管理与同步","children":[{"level":3,"title":"5.1 初始化进程模型","slug":"_5-1-初始化进程模型","link":"#_5-1-初始化进程模型","children":[]},{"level":3,"title":"5.2 进程接口定义","slug":"_5-2-进程接口定义","link":"#_5-2-进程接口定义","children":[]},{"level":3,"title":"5.3 进程创建流程","slug":"_5-3-进程创建流程","link":"#_5-3-进程创建流程","children":[]},{"level":3,"title":"5.4 同步机制","slug":"_5-4-同步机制","link":"#_5-4-同步机制","children":[]}]},{"level":2,"title":"6. 实践练习","slug":"_6-实践练习","link":"#_6-实践练习","children":[{"level":3,"title":"6.1 状态转换实验","slug":"_6-1-状态转换实验","link":"#_6-1-状态转换实验","children":[]},{"level":3,"title":"6.2 代码跟踪练习","slug":"_6-2-代码跟踪练习","link":"#_6-2-代码跟踪练习","children":[]},{"level":3,"title":"6.3 Exec Fifo 实验","slug":"_6-3-exec-fifo-实验","link":"#_6-3-exec-fifo-实验","children":[]}]},{"level":2,"title":"7. 深入思考","slug":"_7-深入思考","link":"#_7-深入思考","children":[{"level":3,"title":"7.1 设计问题","slug":"_7-1-设计问题","link":"#_7-1-设计问题","children":[]},{"level":3,"title":"7.2 性能考虑","slug":"_7-2-性能考虑","link":"#_7-2-性能考虑","children":[]},{"level":3,"title":"7.3 错误处理","slug":"_7-3-错误处理","link":"#_7-3-错误处理","children":[]}]},{"level":2,"title":"8. 扩展阅读","slug":"_8-扩展阅读","link":"#_8-扩展阅读","children":[]},{"level":2,"title":"🎯 模块总结","slug":"🎯-模块总结","link":"#🎯-模块总结","children":[]}],"git":{"createdTime":1755014556000,"updatedTime":1755014556000,"contributors":[{"name":"hushengnian","email":"hushengnian@example.com","commits":1}]},"filePathRelative":"blogs/cloud-base/runc-deep-dive/02-容器生命周期管理.md"}');export{f as comp,y as data};

import{_ as c,c as u,b as s,a as o,e as a,d as p,w as l,r as i,o as r}from"./app-6X7aTgdN.js";const k={},d={href:"https://man7.org/linux/man-pages/man7/mount_namespaces.7.html",target:"_blank",rel:"noopener noreferrer"},v={href:"https://man7.org/linux/man-pages/man2/pivot_root.2.html",target:"_blank",rel:"noopener noreferrer"},m={href:"https://man7.org/linux/man-pages/man2/mount.2.html",target:"_blank",rel:"noopener noreferrer"},b={href:"https://man7.org/linux/man-pages/man2/mount_setattr.2.html",target:"_blank",rel:"noopener noreferrer"},g={href:"https://www.kernel.org/doc/Documentation/filesystems/vfs.txt",target:"_blank",rel:"noopener noreferrer"},f={href:"https://lwn.net/Articles/281157/",target:"_blank",rel:"noopener noreferrer"},h={href:"https://lwn.net/Articles/159077/",target:"_blank",rel:"noopener noreferrer"},q={href:"https://lwn.net/Articles/837566/",target:"_blank",rel:"noopener noreferrer"},_={href:"https://medium.com/containers-world/filesystem-technology-container-6cfbeac6c0dc",target:"_blank",rel:"noopener noreferrer"},y={href:"https://arkfox.com/archive/overlayfs/",target:"_blank",rel:"noopener noreferrer"},w={href:"https://blog.quarkslab.com/mount-namespace-linux-kernel.html",target:"_blank",rel:"noopener noreferrer"};function x(M,n){const e=i("RouteLink"),t=i("ExternalLinkIcon");return r(),u("div",null,[n[26]||(n[26]=s("h1",{id:"æ–‡ä»¶ç³»ç»Ÿä¸æŒ‚è½½ç®¡ç†",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#æ–‡ä»¶ç³»ç»Ÿä¸æŒ‚è½½ç®¡ç†"},[s("span",null,"æ–‡ä»¶ç³»ç»Ÿä¸æŒ‚è½½ç®¡ç†")])],-1)),s("blockquote",null,[s("p",null,[n[2]||(n[2]=s("strong",null,"ç³»åˆ—å¯¼èˆªï¼š",-1)),n[3]||(n[3]=a()),p(e,{to:"/blogs/cloud-base/runc-deep-dive/"},{default:l(()=>n[0]||(n[0]=[a("runc å®¹å™¨è¿è¡Œæ—¶æ·±åº¦è§£æç³»åˆ—")])),_:1,__:[0]}),n[4]||(n[4]=a(" â†’ ç¬¬äº”ç¯‡ï¼šæ–‡ä»¶ç³»ç»Ÿä¸æŒ‚è½½ç®¡ç†")),n[5]||(n[5]=s("br",null,null,-1)),n[6]||(n[6]=s("strong",null,"ä¸Šä¸€ç¯‡ï¼š",-1)),n[7]||(n[7]=a()),p(e,{to:"/blogs/cloud-base/runc-deep-dive/04-Cgroups%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86.html"},{default:l(()=>n[1]||(n[1]=[a("Cgroupsèµ„æºç®¡ç†")])),_:1,__:[1]}),n[8]||(n[8]=s("br",null,null,-1)),n[9]||(n[9]=s("strong",null,"æœ€åæ›´æ–°ï¼š",-1)),n[10]||(n[10]=a(" 2024"))])]),n[27]||(n[27]=o(`<h2 id="æ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#æ¦‚è¿°"><span>æ¦‚è¿°</span></a></h2><p>æœ¬æ–‡æ·±å…¥åˆ†æ runc å¦‚ä½•ç®¡ç†å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿå’ŒæŒ‚è½½ç‚¹ã€‚åŒ…æ‹¬ rootfs çš„å‡†å¤‡å’Œåˆ‡æ¢ã€æŒ‚è½½ç‚¹çš„åˆ›å»ºå’Œç®¡ç†ï¼Œä»¥åŠæŒ‚è½½ä¼ æ’­ç­‰é«˜çº§ç‰¹æ€§ã€‚</p><h2 id="ğŸ¯-å­¦ä¹ ç›®æ ‡" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-å­¦ä¹ ç›®æ ‡"><span>ğŸ¯ å­¦ä¹ ç›®æ ‡</span></a></h2><p>å®Œæˆæœ¬æ¨¡å—åï¼Œä½ å°†èƒ½å¤Ÿï¼š</p><ul><li>æ·±å…¥ç†è§£å®¹å™¨ rootfs å‡†å¤‡å’Œåˆ‡æ¢çš„å®Œæ•´æœºåˆ¶</li><li>æŒæ¡ runc ä¸­å„ç§æŒ‚è½½ç±»å‹çš„å¤„ç†é€»è¾‘å’Œå®‰å…¨ç­–ç•¥</li><li>ç†è§£ Mount Namespace ä¸æ–‡ä»¶ç³»ç»Ÿéš”ç¦»çš„å®ç°åŸç†</li><li>ç†Ÿæ‚‰ bind mountã€overlayã€ç‰¹æ®Šæ–‡ä»¶ç³»ç»Ÿçš„åº”ç”¨åœºæ™¯</li><li>å…·å¤‡æ’æŸ¥å®¹å™¨æ–‡ä»¶ç³»ç»Ÿé—®é¢˜å’Œä¼˜åŒ–æŒ‚è½½é…ç½®çš„èƒ½åŠ›</li></ul><h2 id="_1-å®¹å™¨æ–‡ä»¶ç³»ç»ŸåŸºç¡€" tabindex="-1"><a class="header-anchor" href="#_1-å®¹å™¨æ–‡ä»¶ç³»ç»ŸåŸºç¡€"><span>1. å®¹å™¨æ–‡ä»¶ç³»ç»ŸåŸºç¡€</span></a></h2><h3 id="_1-1-ä»€ä¹ˆæ˜¯å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ" tabindex="-1"><a class="header-anchor" href="#_1-1-ä»€ä¹ˆæ˜¯å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ"><span>1.1 ä»€ä¹ˆæ˜¯å®¹å™¨æ–‡ä»¶ç³»ç»Ÿï¼Ÿ</span></a></h3><p>å®¹å™¨æ–‡ä»¶ç³»ç»Ÿæ˜¯ä¸ºå®¹å™¨è¿›ç¨‹æä¾›éš”ç¦»æ–‡ä»¶è§†å›¾çš„æ ¸å¿ƒæœºåˆ¶ã€‚å®ƒé€šè¿‡ <strong>rootfs åˆ‡æ¢</strong> + <strong>æŒ‚è½½ç®¡ç†</strong> + <strong>æ–‡ä»¶ç³»ç»Ÿéš”ç¦»</strong> å®ç°å®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿè™šæ‹ŸåŒ–ã€‚</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">å®¿ä¸»æœºæ–‡ä»¶ç³»ç»Ÿ                   å®¹å™¨æ–‡ä»¶ç³»ç»Ÿè§†å›¾</span>
<span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚ /                   â”‚   å˜æ¢   â”‚ /                   â”‚</span>
<span class="line">â”‚ â”œâ”€â”€ bin/            â”‚  â”€â”€â”€â”€â†’  â”‚ â”œâ”€â”€ bin/            â”‚ (æ¥è‡ªé•œåƒ)</span>
<span class="line">â”‚ â”œâ”€â”€ etc/            â”‚         â”‚ â”œâ”€â”€ etc/            â”‚ (æ¥è‡ªé•œåƒ)</span>
<span class="line">â”‚ â”œâ”€â”€ home/           â”‚         â”‚ â”œâ”€â”€ home/           â”‚ (æ¥è‡ªæŒ‚è½½)</span>
<span class="line">â”‚ â”œâ”€â”€ proc/           â”‚         â”‚ â”œâ”€â”€ proc/           â”‚ (å®¹å™¨proc)</span>
<span class="line">â”‚ â””â”€â”€ var/containers/ â”‚         â”‚ â”œâ”€â”€ tmp/            â”‚ (tmpfs)</span>
<span class="line">â”‚     â””â”€â”€ rootfs/     â”‚         â”‚ â””â”€â”€ dev/            â”‚ (è®¾å¤‡èŠ‚ç‚¹)</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line">      å®¿ä¸»æœºè§†å›¾                      å®¹å™¨å†…è§†å›¾</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ ¸å¿ƒç»„ä»¶</strong>ï¼š</p><ul><li>ğŸ  <strong>Rootfs</strong>: å®¹å™¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œé€šå¸¸æ¥è‡ªé•œåƒ</li><li>ğŸ”— <strong>Bind Mounts</strong>: å°†å®¿ä¸»æœºç›®å½•æ˜ å°„åˆ°å®¹å™¨å†…</li><li>ğŸ’¾ <strong>Tmpfs</strong>: ä¸´æ—¶å†…å­˜æ–‡ä»¶ç³»ç»Ÿ</li><li>âš™ï¸ <strong>Special FS</strong>: procã€sysã€dev ç­‰ç‰¹æ®Šæ–‡ä»¶ç³»ç»Ÿ</li></ul><h3 id="_1-2-æ–‡ä»¶ç³»ç»Ÿéš”ç¦»å±‚æ¬¡" tabindex="-1"><a class="header-anchor" href="#_1-2-æ–‡ä»¶ç³»ç»Ÿéš”ç¦»å±‚æ¬¡"><span>1.2 æ–‡ä»¶ç³»ç»Ÿéš”ç¦»å±‚æ¬¡</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚              åº”ç”¨è¿›ç¨‹è§†å›¾                       â”‚</span>
<span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="line">â”‚           å®¹å™¨æŒ‚è½½å‘½åç©ºé—´                      â”‚</span>
<span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚</span>
<span class="line">â”‚  â”‚          /                              â”‚    â”‚</span>
<span class="line">â”‚  â”‚  â”œâ”€â”€ bin/ (æ¥è‡ªé•œåƒå±‚)                  â”‚    â”‚ </span>
<span class="line">â”‚  â”‚  â”œâ”€â”€ etc/ (æ¥è‡ªé•œåƒå±‚)                  â”‚    â”‚</span>
<span class="line">â”‚  â”‚  â”œâ”€â”€ proc/ (å®¹å™¨ä¸“å±procfs)             â”‚    â”‚</span>
<span class="line">â”‚  â”‚  â”œâ”€â”€ tmp/ (tmpfså†…å­˜æ–‡ä»¶ç³»ç»Ÿ)           â”‚    â”‚</span>
<span class="line">â”‚  â”‚  â””â”€â”€ app/ (bind mountå®¿ä¸»æœºç›®å½•)        â”‚    â”‚</span>
<span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚</span>
<span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="line">â”‚                å®¿ä¸»æœºå†…æ ¸                       â”‚</span>
<span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚</span>
<span class="line">â”‚  â”‚  çœŸå®æ–‡ä»¶ç³»ç»Ÿ   â”‚   è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ (VFS)   â”‚   â”‚</span>
<span class="line">â”‚  â”‚   (ext4/xfs)    â”‚   (proc/sys/tmpfs)     â”‚   â”‚</span>
<span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-rootfs-å‡†å¤‡å’Œåˆ‡æ¢æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#_2-rootfs-å‡†å¤‡å’Œåˆ‡æ¢æœºåˆ¶"><span>2. Rootfs å‡†å¤‡å’Œåˆ‡æ¢æœºåˆ¶</span></a></h2><h3 id="_2-1-æ•´ä½“æµç¨‹æ¶æ„" tabindex="-1"><a class="header-anchor" href="#_2-1-æ•´ä½“æµç¨‹æ¶æ„"><span>2.1 æ•´ä½“æµç¨‹æ¶æ„</span></a></h3><p>runc çš„æ–‡ä»¶ç³»ç»Ÿåˆå§‹åŒ–éµå¾ª <strong>å‡†å¤‡</strong> â†’ <strong>æŒ‚è½½</strong> â†’ <strong>åˆ‡æ¢</strong> â†’ <strong>åŠ å›º</strong> çš„å››é˜¶æ®µæµç¨‹ï¼š</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">ç”¨æˆ·æ‰§è¡Œ: runc create mycontainer</span>
<span class="line">           â”‚</span>
<span class="line">           â–¼</span>
<span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚  é˜¶æ®µ1: prepareRoot - æ ¹æŒ‚è½½ç‚¹é¢„å¤„ç†            â”‚</span>
<span class="line">â”‚  - è®¾ç½®æŒ‚è½½ä¼ æ’­å±æ€§                             â”‚</span>
<span class="line">â”‚  - ç¡®ä¿çˆ¶æŒ‚è½½ç‚¹ç§æœ‰åŒ–                           â”‚</span>
<span class="line">â”‚  - è‡ªç»‘å®šrootfså‡†å¤‡pivot_root                   â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line">              â”‚</span>
<span class="line">              â–¼</span>
<span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚  é˜¶æ®µ2: prepareRootfs - æŒ‚è½½å¤„ç†                â”‚</span>
<span class="line">â”‚  - å¤„ç†æ‰€æœ‰OCIé…ç½®çš„æŒ‚è½½ç‚¹                      â”‚</span>
<span class="line">â”‚  - åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹å’Œç¬¦å·é“¾æ¥                       â”‚</span>
<span class="line">â”‚  - å¤„ç†ç‰¹æ®Šæ–‡ä»¶ç³»ç»Ÿ(proc/sys/cgroup)            â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line">              â”‚</span>
<span class="line">              â–¼</span>
<span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚  é˜¶æ®µ3: pivotRoot/msMoveRoot - æ ¹æ–‡ä»¶ç³»ç»Ÿåˆ‡æ¢   â”‚</span>
<span class="line">â”‚  - pivot_root(): æ ‡å‡†åˆ‡æ¢æ–¹å¼                   â”‚</span>
<span class="line">â”‚  - MS_MOVE: --no-pivot-root é€‰é¡¹               â”‚</span>
<span class="line">â”‚  - chroot(): ä¼ ç»Ÿæ–¹å¼(æ— mount namespace)        â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line">              â”‚</span>
<span class="line">              â–¼</span>
<span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚  é˜¶æ®µ4: finalizeRootfs - å®‰å…¨åŠ å›º               â”‚</span>
<span class="line">â”‚  - é‡æ–°æŒ‚è½½tmpfs/devä¸ºåªè¯»                      â”‚</span>
<span class="line">â”‚  - è®¾ç½®æ ¹æ–‡ä»¶ç³»ç»Ÿåªè¯»                           â”‚</span>
<span class="line">â”‚  - åº”ç”¨umaskæƒé™è®¾ç½®                            â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-prepareroot-æ ¹æŒ‚è½½ç‚¹é¢„å¤„ç†" tabindex="-1"><a class="header-anchor" href="#_2-2-prepareroot-æ ¹æŒ‚è½½ç‚¹é¢„å¤„ç†"><span>2.2 prepareRoot - æ ¹æŒ‚è½½ç‚¹é¢„å¤„ç†</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/rootfs_linux.go:97</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">prepareRoot</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. è®¾ç½®æ ¹æŒ‚è½½ä¼ æ’­å±æ€§</span></span>
<span class="line">    flag <span class="token operator">:=</span> unix<span class="token punctuation">.</span>MS_SLAVE <span class="token operator">|</span> unix<span class="token punctuation">.</span>MS_REC  <span class="token comment">// é»˜è®¤ä¸ºslaveé€’å½’</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>RootPropagation <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        flag <span class="token operator">=</span> config<span class="token punctuation">.</span>RootPropagation    <span class="token comment">// ç”¨æˆ·è‡ªå®šä¹‰ä¼ æ’­å±æ€§</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åœ¨æ ¹ç›®å½•ä¸Šåº”ç”¨ä¼ æ’­å±æ€§</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set root mount propagation: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. ç¡®ä¿rootfsçˆ¶æŒ‚è½½ç‚¹æ˜¯ç§æœ‰çš„</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">rootfsParentMountPrivate</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Rootfs<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. é€’å½’ç»‘å®šæŒ‚è½½rootfsåˆ°è‡ªèº«ï¼Œä¸ºpivot_rootåšå‡†å¤‡</span></span>
<span class="line">    <span class="token comment">// è¿™ä¸€æ­¥æ˜¯å…³é”®ï¼šä½¿rootfsæˆä¸ºç‹¬ç«‹çš„æŒ‚è½½ç‚¹</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">mount</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Rootfs<span class="token punctuation">,</span> config<span class="token punctuation">.</span>Rootfs<span class="token punctuation">,</span> <span class="token string">&quot;bind&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                unix<span class="token punctuation">.</span>MS_BIND<span class="token operator">|</span>unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æŒ‚è½½ä¼ æ’­å±æ€§è§£é‡Š</strong>ï¼š</p><table><thead><tr><th>ä¼ æ’­ç±»å‹</th><th>å«ä¹‰</th><th>åº”ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><strong>MS_PRIVATE</strong></td><td>ç§æœ‰ï¼ŒæŒ‚è½½ä¸ä¼ æ’­</td><td>å®Œå…¨éš”ç¦»å®¹å™¨æŒ‚è½½</td></tr><tr><td><strong>MS_SLAVE</strong></td><td>ä»å±ï¼Œåªæ¥æ”¶ä¸å‘é€</td><td>æ¥æ”¶å®¿ä¸»æœºæŒ‚è½½ï¼Œä½†ä¸å½±å“å®¿ä¸»æœº</td></tr><tr><td><strong>MS_SHARED</strong></td><td>å…±äº«ï¼ŒåŒå‘ä¼ æ’­</td><td>å®¹å™¨ä¸å®¿ä¸»æœºå…±äº«æŒ‚è½½å˜æ›´</td></tr><tr><td><strong>MS_UNBINDABLE</strong></td><td>ä¸å¯ç»‘å®š</td><td>é˜²æ­¢æŒ‚è½½ç‚¹è¢«bind</td></tr></tbody></table><h3 id="_2-3-ä¸‰ç§æ ¹æ–‡ä»¶ç³»ç»Ÿåˆ‡æ¢æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#_2-3-ä¸‰ç§æ ¹æ–‡ä»¶ç³»ç»Ÿåˆ‡æ¢æ–¹å¼"><span>2.3 ä¸‰ç§æ ¹æ–‡ä»¶ç³»ç»Ÿåˆ‡æ¢æ–¹å¼</span></a></h3><h4 id="a-pivot-root-æ–¹å¼-æ ‡å‡†æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#a-pivot-root-æ–¹å¼-æ ‡å‡†æ–¹å¼"><span>A. pivot_root æ–¹å¼ (æ ‡å‡†æ–¹å¼)</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/rootfs_linux.go:128</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">pivotRoot</span><span class="token punctuation">(</span>rootfs <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ‰“å¼€æ—§æ ¹å’Œæ–°æ ¹çš„æ–‡ä»¶æè¿°ç¬¦</span></span>
<span class="line">    oldroot<span class="token punctuation">,</span> err <span class="token operator">:=</span> linux<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>O_DIRECTORY<span class="token operator">|</span>unix<span class="token punctuation">.</span>O_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> oldroot<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    newroot<span class="token punctuation">,</span> err <span class="token operator">:=</span> linux<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>rootfs<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>O_DIRECTORY<span class="token operator">|</span>unix<span class="token punctuation">.</span>O_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> newroot<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åˆ‡æ¢åˆ°æ–°æ ¹ç›®å½•</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Fchdir</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>newroot<span class="token punctuation">.</span><span class="token function">Fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ‰§è¡Œpivot_rootç³»ç»Ÿè°ƒç”¨</span></span>
<span class="line">    <span class="token comment">// æŠ€å·§ï¼špivot_root(&quot;.&quot;, &quot;.&quot;) - æ¥è‡ªLXCå¼€å‘è€…çš„æ™ºæ…§</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">PivotRoot</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;pivot_root failed: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®¾ç½®æ—§æ ¹ä¸ºslaveï¼Œé˜²æ­¢æŒ‚è½½ä¼ æ’­åˆ°å®¿ä¸»æœº</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_SLAVE<span class="token operator">|</span>unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åˆ†ç¦»å¸è½½æ—§æ ¹</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MNT_DETACH<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åˆ‡æ¢å·¥ä½œç›®å½•åˆ°æ–°æ ¹</span></span>
<span class="line">    <span class="token keyword">return</span> unix<span class="token punctuation">.</span><span class="token function">Chdir</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>pivot_root å·¥ä½œåŸç†</strong>ï¼š</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">æ‰§è¡Œå‰:                        æ‰§è¡Œå:</span>
<span class="line">å®¿ä¸»æœºæ ¹ (/)                   å®¹å™¨æ ¹ (/)</span>
<span class="line">â”œâ”€â”€ bin/                      â”œâ”€â”€ bin/         (æ¥è‡ªé•œåƒ)</span>
<span class="line">â”œâ”€â”€ etc/                      â”œâ”€â”€ etc/         (æ¥è‡ªé•œåƒ)</span>
<span class="line">â””â”€â”€ containers/               â”œâ”€â”€ tmp/         (tmpfs)</span>
<span class="line">    â””â”€â”€ rootfs/               â””â”€â”€ proc/        (å®¹å™¨procfs)</span>
<span class="line">        â”œâ”€â”€ bin/</span>
<span class="line">        â”œâ”€â”€ etc/</span>
<span class="line">        â””â”€â”€ tmp/</span>
<span class="line">        </span>
<span class="line">pivot_root(rootfs, oldroot) å°†:</span>
<span class="line">- rootfs å˜æˆæ–°çš„æ ¹ç›®å½• /</span>
<span class="line">- åŸæ¥çš„æ ¹ç›®å½•è¢«ç§»åˆ° oldroot ä½ç½®</span>
<span class="line">- ç„¶åå¸è½½ oldrootï¼Œå®Œæˆåˆ‡æ¢</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="b-ms-move-æ–¹å¼-no-pivot-root" tabindex="-1"><a class="header-anchor" href="#b-ms-move-æ–¹å¼-no-pivot-root"><span>B. MS_MOVE æ–¹å¼ (--no-pivot-root)</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/rootfs_linux.go:185</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">msMoveRoot</span><span class="token punctuation">(</span>rootfs <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// å…ˆå¤„ç†æ½œåœ¨çš„å®‰å…¨é£é™©ï¼šå±è”½å±é™©çš„procfså’ŒsysfsæŒ‚è½½</span></span>
<span class="line">    mountinfos<span class="token punctuation">,</span> err <span class="token operator">:=</span> mountinfo<span class="token punctuation">.</span><span class="token function">GetMounts</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>info <span class="token operator">*</span>mountinfo<span class="token punctuation">.</span>Info<span class="token punctuation">)</span> <span class="token punctuation">(</span>skip<span class="token punctuation">,</span> stop <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// è¿‡æ»¤æ¡ä»¶ï¼šæ ¹ç›®å½•ã€proc/sysæ–‡ä»¶ç³»ç»Ÿã€ä¸åœ¨rootfså†…éƒ¨çš„æŒ‚è½½</span></span>
<span class="line">        <span class="token keyword">if</span> info<span class="token punctuation">.</span>Root <span class="token operator">!=</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">||</span> </span>
<span class="line">           <span class="token punctuation">(</span>info<span class="token punctuation">.</span>FSType <span class="token operator">!=</span> <span class="token string">&quot;proc&quot;</span> <span class="token operator">&amp;&amp;</span> info<span class="token punctuation">.</span>FSType <span class="token operator">!=</span> <span class="token string">&quot;sysfs&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span></span>
<span class="line">           strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>Mountpoint<span class="token punctuation">,</span> rootfs<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            skip <span class="token operator">=</span> <span class="token boolean">true</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å¸è½½æˆ–è¦†ç›–å±é™©æŒ‚è½½ç‚¹</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> info <span class="token operator">:=</span> <span class="token keyword">range</span> mountinfos <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// è®¾ç½®ä¸ºslaveé˜²æ­¢ä¼ æ’­</span></span>
<span class="line">        <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>Mountpoint<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_SLAVE<span class="token operator">|</span>unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">unmount</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>Mountpoint<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MNT_DETACH<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// å¦‚æœæ— æ³•å¸è½½ï¼Œç”¨tmpfsè¦†ç›–</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&quot;tmpfs&quot;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>Mountpoint<span class="token punctuation">,</span> <span class="token string">&quot;tmpfs&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to mask %s: %w&quot;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>Mountpoint<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å°†rootfsç§»åŠ¨åˆ°æ ¹ä½ç½®</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mount</span><span class="token punctuation">(</span>rootfs<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_MOVE<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to move %s to /: %w&quot;</span><span class="token punctuation">,</span> rootfs<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ‰§è¡Œchrootå®Œæˆåˆ‡æ¢</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">chroot</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="c-chroot-æ–¹å¼-ä¼ ç»Ÿæ–¹å¼" tabindex="-1"><a class="header-anchor" href="#c-chroot-æ–¹å¼-ä¼ ç»Ÿæ–¹å¼"><span>C. chroot æ–¹å¼ (ä¼ ç»Ÿæ–¹å¼)</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">chroot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ç®€å•çš„chrootç³»ç»Ÿè°ƒç”¨</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Chroot</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> unix<span class="token punctuation">.</span><span class="token function">Chdir</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä¸‰ç§æ–¹å¼å¯¹æ¯”</strong>ï¼š</p><table><thead><tr><th>æ–¹å¼</th><th>ä½¿ç”¨åœºæ™¯</th><th>ä¼˜åŠ¿</th><th>åŠ£åŠ¿</th></tr></thead><tbody><tr><td><strong>pivot_root</strong></td><td>æœ‰mount namespace</td><td>å®‰å…¨æ€§æœ€é«˜ï¼Œå®Œå…¨éš”ç¦»</td><td>éœ€è¦mount namespace</td></tr><tr><td><strong>MS_MOVE</strong></td><td>--no-pivot-rootæ ‡å¿—</td><td>å…¼å®¹æ€§å¥½</td><td>éœ€è¦é¢å¤–å®‰å…¨å¤„ç†</td></tr><tr><td><strong>chroot</strong></td><td>æ— mount namespace</td><td>ç®€å•å…¼å®¹</td><td>å®‰å…¨æ€§è¾ƒä½ï¼Œå¯èƒ½é€ƒé€¸</td></tr></tbody></table><h2 id="_3-æŒ‚è½½ç±»å‹å’Œå¤„ç†æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#_3-æŒ‚è½½ç±»å‹å’Œå¤„ç†æœºåˆ¶"><span>3. æŒ‚è½½ç±»å‹å’Œå¤„ç†æœºåˆ¶</span></a></h2><h3 id="_3-1-æŒ‚è½½åˆ†å‘å™¨-mounttorootfs" tabindex="-1"><a class="header-anchor" href="#_3-1-æŒ‚è½½åˆ†å‘å™¨-mounttorootfs"><span>3.1 æŒ‚è½½åˆ†å‘å™¨ - mountToRootfs</span></a></h3><p>runc æ ¹æ®ä¸åŒçš„è®¾å¤‡ç±»å‹é‡‡ç”¨ä¸“é—¨çš„å¤„ç†é€»è¾‘ï¼š</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/rootfs_linux.go:566</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">mountToRootfs</span><span class="token punctuation">(</span>c <span class="token operator">*</span>mountConfig<span class="token punctuation">,</span> m mountEntry<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">switch</span> m<span class="token punctuation">.</span>Device <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&quot;proc&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sysfs&quot;</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// ç‰¹æ®Šæ–‡ä»¶ç³»ç»Ÿéœ€è¦å®‰å…¨æ£€æŸ¥</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">checkProcMount</span><span class="token punctuation">(</span>rootfs<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">mountPropagate</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> rootfs<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&quot;mqueue&quot;</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// æ¶ˆæ¯é˜Ÿåˆ—æ–‡ä»¶ç³»ç»Ÿ</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mountPropagate</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> rootfs<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> label<span class="token punctuation">.</span><span class="token function">SetFileLabel</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> mountLabel<span class="token punctuation">)</span>  <span class="token comment">// SELinuxæ ‡ç­¾</span></span>
<span class="line">        </span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&quot;tmpfs&quot;</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// tmpfsæ”¯æŒcopyupæ‰©å±•</span></span>
<span class="line">        <span class="token keyword">if</span> m<span class="token punctuation">.</span>Extensions<span class="token operator">&amp;</span>configs<span class="token punctuation">.</span>EXT_COPYUP <span class="token operator">==</span> configs<span class="token punctuation">.</span>EXT_COPYUP <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">doTmpfsCopyUp</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> rootfs<span class="token punctuation">,</span> mountLabel<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">mountPropagate</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> rootfs<span class="token punctuation">,</span> mountLabel<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&quot;bind&quot;</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// bindæŒ‚è½½éœ€è¦ç‰¹æ®Šçš„æ ‡å¿—å¤„ç†</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">handleBindMount</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> rootfs<span class="token punctuation">,</span> mountLabel<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&quot;cgroup&quot;</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// cgroupæ–‡ä»¶ç³»ç»Ÿåˆ†ç‰ˆæœ¬å¤„ç†</span></span>
<span class="line">        <span class="token keyword">if</span> cgroups<span class="token punctuation">.</span><span class="token function">IsCgroup2UnifiedMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">mountCgroupV2</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Mount<span class="token punctuation">,</span> c<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">mountCgroupV1</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Mount<span class="token punctuation">,</span> c<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">    <span class="token keyword">default</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// å…¶ä»–æ ‡å‡†æ–‡ä»¶ç³»ç»Ÿ</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">mountPropagate</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> rootfs<span class="token punctuation">,</span> mountLabel<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-bind-æŒ‚è½½çš„å¤æ‚å¤„ç†" tabindex="-1"><a class="header-anchor" href="#_3-2-bind-æŒ‚è½½çš„å¤æ‚å¤„ç†"><span>3.2 bind æŒ‚è½½çš„å¤æ‚å¤„ç†</span></a></h3><p>bind æŒ‚è½½æ˜¯æœ€å¤æ‚çš„æŒ‚è½½ç±»å‹ï¼Œå› ä¸ºéœ€è¦å¤„ç† <strong>locked flags</strong> é—®é¢˜ï¼š</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">handleBindMount</span><span class="token punctuation">(</span>m mountEntry<span class="token punctuation">,</span> rootfs<span class="token punctuation">,</span> mountLabel <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. æ‰§è¡ŒåŸºç¡€bindæŒ‚è½½</span></span>
<span class="line">    flags <span class="token operator">:=</span> m<span class="token punctuation">.</span>Flags <span class="token operator">|</span> unix<span class="token punctuation">.</span>MS_BIND</span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mountViaFds</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Source<span class="token punctuation">,</span> m<span class="token punctuation">.</span>srcFile<span class="token punctuation">,</span> m<span class="token punctuation">.</span>Destination<span class="token punctuation">,</span> dstFd<span class="token punctuation">,</span> </span>
<span class="line">                         <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>flags<span class="token operator">&amp;^</span>unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">)</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Data<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. å¤„ç†é€’å½’ç»‘å®š</span></span>
<span class="line">    <span class="token keyword">if</span> m<span class="token punctuation">.</span>Flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_REC <span class="token operator">==</span> unix<span class="token punctuation">.</span>MS_REC <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mountViaFds</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Source<span class="token punctuation">,</span> m<span class="token punctuation">.</span>srcFile<span class="token punctuation">,</span> m<span class="token punctuation">.</span>Destination<span class="token punctuation">,</span> dstFd<span class="token punctuation">,</span> </span>
<span class="line">                             <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Data<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. é‡æ–°åº”ç”¨æŒ‚è½½æ ‡å¿— (è¿™æ˜¯å…³é”®æ­¥éª¤!)</span></span>
<span class="line">    <span class="token comment">// bindæŒ‚è½½åéœ€è¦å•ç‹¬çš„remountæ¥åº”ç”¨ro/nosuidç­‰æ ‡å¿—</span></span>
<span class="line">    <span class="token keyword">if</span> m<span class="token punctuation">.</span>Flags<span class="token operator">&amp;^</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>MS_BIND<span class="token operator">|</span>unix<span class="token punctuation">.</span>MS_REC<span class="token operator">|</span>unix<span class="token punctuation">.</span>MS_REMOUNT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> m<span class="token punctuation">.</span>ClearedFlags <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        flags <span class="token operator">:=</span> m<span class="token punctuation">.</span>Flags <span class="token operator">|</span> unix<span class="token punctuation">.</span>MS_BIND <span class="token operator">|</span> unix<span class="token punctuation">.</span>MS_REMOUNT</span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// å°è¯•ç›´æ¥è®¾ç½®æ ‡å¿—</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mountViaFds</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Destination<span class="token punctuation">,</span> dstFd<span class="token punctuation">,</span> </span>
<span class="line">                             <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// å¦‚æœå¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨locked flags</span></span>
<span class="line">        <span class="token comment">// éœ€è¦è·å–æºæ–‡ä»¶ç³»ç»Ÿçš„å½“å‰æ ‡å¿—</span></span>
<span class="line">        st<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">srcStatfs</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        srcFlags <span class="token operator">:=</span> <span class="token function">statfsToMountFlags</span><span class="token punctuation">(</span><span class="token operator">*</span>st<span class="token punctuation">)</span>  <span class="token comment">// ä»statfsè½¬æ¢ä¸ºmountæ ‡å¿—</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// æ£€æŸ¥æ˜¯å¦æœ‰æ— æ³•æ¸…é™¤çš„locked flags</span></span>
<span class="line">        lockedFlags <span class="token operator">:=</span> srcFlags <span class="token operator">&amp;</span> m<span class="token punctuation">.</span>ClearedFlags <span class="token operator">&amp;</span> mntLockFlags</span>
<span class="line">        <span class="token keyword">if</span> lockedFlags <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;cannot clear locked mount flags: %s&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                             <span class="token function">stringifyMountFlags</span><span class="token punctuation">(</span>lockedFlags<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// é‡æ–°åº”ç”¨ï¼ŒåŒ…å«locked flags</span></span>
<span class="line">        flags <span class="token operator">|=</span> srcFlags <span class="token operator">&amp;</span> mntLockFlags</span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">mountViaFds</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Destination<span class="token punctuation">,</span> dstFd<span class="token punctuation">,</span> </span>
<span class="line">                          <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>locked flags é—®é¢˜è§£é‡Š</strong>ï¼š</p><p>æŸäº›æŒ‚è½½æ ‡å¿—åœ¨æºæ–‡ä»¶ç³»ç»Ÿä¸Šå¯èƒ½æ˜¯&quot;é”å®š&quot;çš„ï¼Œæ— æ³•é€šè¿‡remountæ¸…é™¤ï¼š</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># ä¾‹å¦‚ï¼šæºæ–‡ä»¶ç³»ç»Ÿæ˜¯åªè¯»çš„ (MS_RDONLY)</span></span>
<span class="line">$ <span class="token function">mount</span> <span class="token operator">|</span> <span class="token function">grep</span> /source</span>
<span class="line">/dev/sda1 on /source <span class="token builtin class-name">type</span> ext4 <span class="token punctuation">(</span>ro,noatime<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># bindæŒ‚è½½åï¼Œæ— æ³•å°†å…¶æ”¹ä¸ºå¯å†™</span></span>
<span class="line">$ <span class="token function">mount</span> <span class="token parameter variable">--bind</span> /source /target</span>
<span class="line">$ <span class="token function">mount</span> <span class="token parameter variable">-o</span> remount,rw /target  <span class="token comment"># è¿™ä¼šå¤±è´¥ï¼</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># runcçš„è§£å†³æ–¹æ¡ˆï¼šæ£€æµ‹locked flagså¹¶ä¿æŒå®ƒä»¬</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-æ–°ç‰ˆæŒ‚è½½apiæ”¯æŒ" tabindex="-1"><a class="header-anchor" href="#_3-3-æ–°ç‰ˆæŒ‚è½½apiæ”¯æŒ"><span>3.3 æ–°ç‰ˆæŒ‚è½½APIæ”¯æŒ</span></a></h3><p>runc æ”¯æŒ Linux 5.2+ çš„æ–°ç‰ˆæŒ‚è½½APIï¼Œä¸»è¦ç”¨äº <strong>idmapped mounts</strong>ï¼š</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/mount_linux.go:242</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">mountFd</span><span class="token punctuation">(</span>nsHandles <span class="token operator">*</span>userns<span class="token punctuation">.</span>Handles<span class="token punctuation">,</span> m <span class="token operator">*</span>configs<span class="token punctuation">.</span>Mount<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>mountSource<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> m<span class="token punctuation">.</span><span class="token function">IsIDMapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ä½¿ç”¨open_tree()åˆ›å»ºæŒ‚è½½æ–‡ä»¶æè¿°ç¬¦</span></span>
<span class="line">        flags <span class="token operator">:=</span> <span class="token function">uint</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>OPEN_TREE_CLONE <span class="token operator">|</span> unix<span class="token punctuation">.</span>OPEN_TREE_CLOEXEC<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> m<span class="token punctuation">.</span>Flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_REC <span class="token operator">==</span> unix<span class="token punctuation">.</span>MS_REC <span class="token punctuation">{</span></span>
<span class="line">            flags <span class="token operator">|=</span> unix<span class="token punctuation">.</span>AT_RECURSIVE</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        fd<span class="token punctuation">,</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">OpenTree</span><span class="token punctuation">(</span>unix<span class="token punctuation">.</span>AT_FDCWD<span class="token punctuation">,</span> m<span class="token punctuation">.</span>Source<span class="token punctuation">,</span> flags<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;open_tree(%s): %w&quot;</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Source<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        mountFile <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">NewFile</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Source<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// è·å–ç”¨æˆ·å‘½åç©ºé—´æ–‡ä»¶æè¿°ç¬¦</span></span>
<span class="line">        usernsFile<span class="token punctuation">,</span> err <span class="token operator">:=</span> nsHandles<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>userns<span class="token punctuation">.</span>Mapping<span class="token punctuation">{</span></span>
<span class="line">            UIDMappings<span class="token punctuation">:</span> m<span class="token punctuation">.</span>IDMapping<span class="token punctuation">.</span>UIDMappings<span class="token punctuation">,</span></span>
<span class="line">            GIDMappings<span class="token punctuation">:</span> m<span class="token punctuation">.</span>IDMapping<span class="token punctuation">.</span>GIDMappings<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// åº”ç”¨idmapå±æ€§</span></span>
<span class="line">        attr <span class="token operator">:=</span> <span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MountAttr<span class="token punctuation">{</span></span>
<span class="line">            Attr_set<span class="token punctuation">:</span>  unix<span class="token punctuation">.</span>MOUNT_ATTR_IDMAP<span class="token punctuation">,</span></span>
<span class="line">            Userns_fd<span class="token punctuation">:</span> <span class="token function">uint64</span><span class="token punctuation">(</span>usernsFile<span class="token punctuation">.</span><span class="token function">Fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">MountSetattr</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>mountFile<span class="token punctuation">.</span><span class="token function">Fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                                   unix<span class="token punctuation">.</span>AT_EMPTY_PATH<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;mount_setattr(idmap): %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">&amp;</span>mountSource<span class="token punctuation">{</span>Type<span class="token punctuation">:</span> mountSourceOpenTree<span class="token punctuation">,</span> file<span class="token punctuation">:</span> mountFile<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ™®é€šbindæŒ‚è½½ä½¿ç”¨O_PATH</span></span>
<span class="line">    mountFile<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Source<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>O_PATH<span class="token operator">|</span>unix<span class="token punctuation">.</span>O_CLOEXEC<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>mountSource<span class="token punctuation">{</span>Type<span class="token punctuation">:</span> mountSourcePlain<span class="token punctuation">,</span> file<span class="token punctuation">:</span> mountFile<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>idmapped mounts çš„ä¼˜åŠ¿</strong>ï¼š</p><ul><li>ğŸ” <strong>æƒé™æ˜ å°„</strong>: æ–‡ä»¶ç³»ç»Ÿå†…çš„ UID/GID å¯ä»¥æ˜ å°„åˆ°ä¸åŒçš„ç”¨æˆ·å‘½åç©ºé—´</li><li>ğŸ”’ <strong>å®‰å…¨æ€§</strong>: æ— éœ€ chown å°±èƒ½æ”¹å˜æ–‡ä»¶æ‰€æœ‰æƒè§†å›¾</li><li>âš¡ <strong>æ€§èƒ½</strong>: é¿å…å¤åˆ¶æ–‡ä»¶ï¼Œç›´æ¥æ˜ å°„æƒé™</li></ul><h2 id="_4-ç‰¹æ®Šæ–‡ä»¶ç³»ç»Ÿå¤„ç†" tabindex="-1"><a class="header-anchor" href="#_4-ç‰¹æ®Šæ–‡ä»¶ç³»ç»Ÿå¤„ç†"><span>4. ç‰¹æ®Šæ–‡ä»¶ç³»ç»Ÿå¤„ç†</span></a></h2><h3 id="_4-1-proc-æ–‡ä»¶ç³»ç»Ÿå®‰å…¨æ£€æŸ¥" tabindex="-1"><a class="header-anchor" href="#_4-1-proc-æ–‡ä»¶ç³»ç»Ÿå®‰å…¨æ£€æŸ¥"><span>4.1 /proc æ–‡ä»¶ç³»ç»Ÿå®‰å…¨æ£€æŸ¥</span></a></h3><p>proc æ–‡ä»¶ç³»ç»ŸåŒ…å«æ•æ„Ÿçš„ç³»ç»Ÿä¿¡æ¯ï¼Œrunc å®ç°äº†ä¸¥æ ¼çš„å®‰å…¨æ£€æŸ¥ï¼š</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/rootfs_linux.go:790</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">checkProcMount</span><span class="token punctuation">(</span>rootfs<span class="token punctuation">,</span> dest <span class="token builtin">string</span><span class="token punctuation">,</span> m mountEntry<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// è®¡ç®—ç›¸å¯¹äº/procçš„è·¯å¾„</span></span>
<span class="line">    path<span class="token punctuation">,</span> err <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Rel</span><span class="token punctuation">(</span>filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>rootfs<span class="token punctuation">,</span> <span class="token string">&quot;/proc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dest<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> path <span class="token operator">==</span> <span class="token string">&quot;.&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// åœ¨/procæ ¹ç›®å½•ä¸Šçš„æŒ‚è½½</span></span>
<span class="line">        <span class="token keyword">if</span> m<span class="token punctuation">.</span><span class="token function">IsBind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// bindæŒ‚è½½å¿…é¡»æ˜¯çœŸæ­£çš„procfs</span></span>
<span class="line">            fsStat<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">srcStatfs</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> err</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">if</span> fsStat<span class="token punctuation">.</span>Type <span class="token operator">!=</span> unix<span class="token punctuation">.</span>PROC_SUPER_MAGIC <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;bind mount %s is not procfs&quot;</span><span class="token punctuation">,</span> dest<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// æ£€æŸ¥æ˜¯å¦ä¸ºprocfsæ ¹èŠ‚ç‚¹ (inode == 1)</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> uStat<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">srcStat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">const</span> procRootIno <span class="token operator">=</span> <span class="token number">1</span></span>
<span class="line">                <span class="token keyword">if</span> uStat<span class="token punctuation">.</span>Ino <span class="token operator">!=</span> procRootIno <span class="token punctuation">{</span></span>
<span class="line">                    logrus<span class="token punctuation">.</span><span class="token function">Warnf</span><span class="token punctuation">(</span><span class="token string">&quot;bind-mount %s is not procfs root (inode %d)&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                               dest<span class="token punctuation">,</span> uStat<span class="token punctuation">.</span>Ino<span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> m<span class="token punctuation">.</span>Device <span class="token operator">==</span> <span class="token string">&quot;proc&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span>  <span class="token comment">// æ–°çš„procfsæŒ‚è½½æ€»æ˜¯å®‰å…¨çš„</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%s cannot be mounted: not procfs&quot;</span><span class="token punctuation">,</span> dest<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// /procå­è·¯å¾„ï¼šåªå…è®¸ç‰¹å®šçš„ç™½åå•è·¯å¾„</span></span>
<span class="line">    validProcMounts <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&quot;/proc/cpuinfo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/proc/diskstats&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/proc/meminfo&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;/proc/stat&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/proc/swaps&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/proc/uptime&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/proc/loadavg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;/proc/sys/kernel/ns_last_pid&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;/proc/sys/crypto/fips_enabled&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token comment">// æ›´å¤šå®‰å…¨çš„procè·¯å¾„...</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ£€æŸ¥æ˜¯å¦ä¸ºå…è®¸çš„è·¯å¾„</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> validPath <span class="token operator">:=</span> <span class="token keyword">range</span> validProcMounts <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> filepath<span class="token punctuation">.</span><span class="token function">Clean</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span> <span class="token operator">==</span> validPath <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%s cannot be mounted inside /proc: not in whitelist&quot;</span><span class="token punctuation">,</span> dest<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-cgroup-æ–‡ä»¶ç³»ç»Ÿå¤„ç†" tabindex="-1"><a class="header-anchor" href="#_4-2-cgroup-æ–‡ä»¶ç³»ç»Ÿå¤„ç†"><span>4.2 cgroup æ–‡ä»¶ç³»ç»Ÿå¤„ç†</span></a></h3><h4 id="cgroups-v1-å¤„ç†" tabindex="-1"><a class="header-anchor" href="#cgroups-v1-å¤„ç†"><span>Cgroups v1 å¤„ç†</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">mountCgroupV1</span><span class="token punctuation">(</span>m <span class="token operator">*</span>configs<span class="token punctuation">.</span>Mount<span class="token punctuation">,</span> c <span class="token operator">*</span>mountConfig<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// è·å–ç³»ç»Ÿä¸­çš„cgroupæŒ‚è½½ç‚¹</span></span>
<span class="line">    binds<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getCgroupMounts</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åˆ›å»ºtmpfsä½œä¸ºcgroupæ ¹æŒ‚è½½ç‚¹</span></span>
<span class="line">    tmpfs <span class="token operator">:=</span> <span class="token operator">&amp;</span>configs<span class="token punctuation">.</span>Mount<span class="token punctuation">{</span></span>
<span class="line">        Source<span class="token punctuation">:</span>      <span class="token string">&quot;tmpfs&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        Device<span class="token punctuation">:</span>      <span class="token string">&quot;tmpfs&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        Destination<span class="token punctuation">:</span> m<span class="token punctuation">.</span>Destination<span class="token punctuation">,</span></span>
<span class="line">        Flags<span class="token punctuation">:</span>       defaultMountFlags<span class="token punctuation">,</span></span>
<span class="line">        Data<span class="token punctuation">:</span>        <span class="token string">&quot;mode=755,size=65536k&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mountToRootfs</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> mountEntry<span class="token punctuation">{</span>Mount<span class="token punctuation">:</span> tmpfs<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ä¸ºæ¯ä¸ªcgroupå­ç³»ç»Ÿåˆ›å»ºæŒ‚è½½ç‚¹</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token keyword">range</span> binds <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> c<span class="token punctuation">.</span>cgroupns <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// cgroupå‘½åç©ºé—´æ¨¡å¼ï¼šç›´æ¥æŒ‚è½½cgroupæ–‡ä»¶ç³»ç»Ÿ</span></span>
<span class="line">            subsystemName <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>Subsystems<span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mountViaFds</span><span class="token punctuation">(</span><span class="token string">&quot;cgroup&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>Destination<span class="token punctuation">,</span> dstFd<span class="token punctuation">,</span> </span>
<span class="line">                                 <span class="token string">&quot;cgroup&quot;</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>Flags<span class="token punctuation">)</span><span class="token punctuation">,</span> subsystemName<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to mount cgroup %s: %w&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                                 subsystemName<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// éå‘½åç©ºé—´æ¨¡å¼ï¼šbindæŒ‚è½½å®¿ä¸»æœºcgroupè·¯å¾„</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">mountToRootfs</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> mountEntry<span class="token punctuation">{</span>Mount<span class="token punctuation">:</span> b<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> err</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="cgroups-v2-å¤„ç†" tabindex="-1"><a class="header-anchor" href="#cgroups-v2-å¤„ç†"><span>Cgroups v2 å¤„ç†</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">mountCgroupV2</span><span class="token punctuation">(</span>m <span class="token operator">*</span>configs<span class="token punctuation">.</span>Mount<span class="token punctuation">,</span> c <span class="token operator">*</span>mountConfig<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// å°è¯•ç›´æ¥æŒ‚è½½cgroup2æ–‡ä»¶ç³»ç»Ÿ</span></span>
<span class="line">    err <span class="token operator">:=</span> <span class="token function">mountViaFds</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Source<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Destination<span class="token punctuation">,</span> dstFd<span class="token punctuation">,</span> </span>
<span class="line">                      <span class="token string">&quot;cgroup2&quot;</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Flags<span class="token punctuation">)</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Data<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>EPERM<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>EBUSY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æƒé™ä¸è¶³æ—¶é™çº§ä¸ºbindæŒ‚è½½</span></span>
<span class="line">    bindMount <span class="token operator">:=</span> <span class="token operator">&amp;</span>configs<span class="token punctuation">.</span>Mount<span class="token punctuation">{</span></span>
<span class="line">        Device<span class="token punctuation">:</span>      <span class="token string">&quot;bind&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        Source<span class="token punctuation">:</span>      fs2<span class="token punctuation">.</span>UnifiedMountpoint<span class="token punctuation">,</span>  <span class="token comment">// /sys/fs/cgroup</span></span>
<span class="line">        Destination<span class="token punctuation">:</span> m<span class="token punctuation">.</span>Destination<span class="token punctuation">,</span></span>
<span class="line">        Flags<span class="token punctuation">:</span>       unix<span class="token punctuation">.</span>MS_BIND <span class="token operator">|</span> m<span class="token punctuation">.</span>Flags<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> c<span class="token punctuation">.</span>cgroupns <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>cgroup2Path <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// cgroupå‘½åç©ºé—´æ¨¡å¼ï¼šæŒ‚è½½å®¹å™¨ç‰¹å®šè·¯å¾„</span></span>
<span class="line">        bindMount<span class="token punctuation">.</span>Source <span class="token operator">=</span> c<span class="token punctuation">.</span>cgroup2Path</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">mountToRootfs</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> mountEntry<span class="token punctuation">{</span>Mount<span class="token punctuation">:</span> bindMount<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-dev-æ–‡ä»¶ç³»ç»Ÿå’Œè®¾å¤‡èŠ‚ç‚¹" tabindex="-1"><a class="header-anchor" href="#_4-3-dev-æ–‡ä»¶ç³»ç»Ÿå’Œè®¾å¤‡èŠ‚ç‚¹"><span>4.3 /dev æ–‡ä»¶ç³»ç»Ÿå’Œè®¾å¤‡èŠ‚ç‚¹</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/rootfs_linux.go:473</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">createDevices</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    useBindMount <span class="token operator">:=</span> userns<span class="token punctuation">.</span><span class="token function">RunningInUserNS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> </span>
<span class="line">                   config<span class="token punctuation">.</span>Namespaces<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>configs<span class="token punctuation">.</span>NEWUSER<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åˆ›å»ºé…ç½®ä¸­æŒ‡å®šçš„è®¾å¤‡èŠ‚ç‚¹</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> node <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Devices <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ptmxç”±setupPtmx()å•ç‹¬å¤„ç†</span></span>
<span class="line">        <span class="token keyword">if</span> utils<span class="token punctuation">.</span><span class="token function">CleanPath</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Path<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;/dev/ptmx&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">continue</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">createDeviceNode</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Rootfs<span class="token punctuation">,</span> node<span class="token punctuation">,</span> useBindMount<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to create device %s: %w&quot;</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">createDeviceNode</span><span class="token punctuation">(</span>rootfs <span class="token builtin">string</span><span class="token punctuation">,</span> node <span class="token operator">*</span>devices<span class="token punctuation">.</span>Device<span class="token punctuation">,</span> bind <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    dest<span class="token punctuation">,</span> err <span class="token operator">:=</span> securejoin<span class="token punctuation">.</span><span class="token function">SecureJoin</span><span class="token punctuation">(</span>rootfs<span class="token punctuation">,</span> node<span class="token punctuation">.</span>Path<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> bind <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ç”¨æˆ·å‘½åç©ºé—´ä¸­ä½¿ç”¨bindæŒ‚è½½</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">bindMountDeviceNode</span><span class="token punctuation">(</span>rootfs<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> node<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ç›´æ¥ä½¿ç”¨mknodåˆ›å»ºè®¾å¤‡èŠ‚ç‚¹</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">mknodDevice</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> node<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è®¾å¤‡èŠ‚ç‚¹bindæŒ‚è½½</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">bindMountDeviceNode</span><span class="token punctuation">(</span>rootfs<span class="token punctuation">,</span> dest <span class="token builtin">string</span><span class="token punctuation">,</span> node <span class="token operator">*</span>devices<span class="token punctuation">.</span>Device<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// åˆ›å»ºç›®æ ‡æ–‡ä»¶</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">createBlankFile</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// bindæŒ‚è½½è®¾å¤‡èŠ‚ç‚¹</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">mount</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> <span class="token string">&quot;bind&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_BIND<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// åˆ›å»ºæ ‡å‡†è®¾å¤‡ç¬¦å·é“¾æ¥</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setupDevSymlinks</span><span class="token punctuation">(</span>rootfs <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    links <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;/proc/self/fd&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/dev/fd&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;/proc/self/fd/0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/dev/stdin&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;/proc/self/fd/1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/dev/stdout&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;/proc/self/fd/2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/dev/stderr&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ¡ä»¶æ€§ç¬¦å·é“¾æ¥</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span><span class="token string">&quot;/proc/kcore&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        links <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>links<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;/proc/kcore&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/dev/core&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> link <span class="token operator">:=</span> <span class="token keyword">range</span> links <span class="token punctuation">{</span></span>
<span class="line">        newPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>rootfs<span class="token punctuation">,</span> link<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Symlink</span><span class="token punctuation">(</span>link<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> newPath<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>os<span class="token punctuation">.</span><span class="token function">IsExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-æŒ‚è½½é…ç½®å’Œé€‰é¡¹è§£æ" tabindex="-1"><a class="header-anchor" href="#_5-æŒ‚è½½é…ç½®å’Œé€‰é¡¹è§£æ"><span>5. æŒ‚è½½é…ç½®å’Œé€‰é¡¹è§£æ</span></a></h2><h3 id="_5-1-mount-ç»“æ„å®šä¹‰" tabindex="-1"><a class="header-anchor" href="#_5-1-mount-ç»“æ„å®šä¹‰"><span>5.1 Mount ç»“æ„å®šä¹‰</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/configs/mount_linux.go:23</span></span>
<span class="line"><span class="token keyword">type</span> Mount <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Source           <span class="token builtin">string</span>              <span class="token comment">// æºè·¯å¾„æˆ–è®¾å¤‡</span></span>
<span class="line">    Destination      <span class="token builtin">string</span>              <span class="token comment">// å®¹å™¨å†…ç›®æ ‡è·¯å¾„</span></span>
<span class="line">    Device           <span class="token builtin">string</span>              <span class="token comment">// æ–‡ä»¶ç³»ç»Ÿç±»å‹æˆ–è®¾å¤‡ç±»å‹</span></span>
<span class="line">    Flags            <span class="token builtin">int</span>                 <span class="token comment">// æŒ‚è½½æ ‡å¿—ä½</span></span>
<span class="line">    ClearedFlags     <span class="token builtin">int</span>                 <span class="token comment">// æ˜ç¡®æ¸…é™¤çš„æ ‡å¿—</span></span>
<span class="line">    PropagationFlags <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>               <span class="token comment">// æŒ‚è½½ä¼ æ’­æ ‡å¿—æ•°ç»„</span></span>
<span class="line">    Data             <span class="token builtin">string</span>              <span class="token comment">// æ–‡ä»¶ç³»ç»Ÿç‰¹å®šé€‰é¡¹</span></span>
<span class="line">    Relabel          <span class="token builtin">string</span>              <span class="token comment">// SELinuxé‡æ ‡è®°é€‰é¡¹</span></span>
<span class="line">    RecAttr          <span class="token operator">*</span>unix<span class="token punctuation">.</span>MountAttr     <span class="token comment">// mount_setattré€’å½’å±æ€§</span></span>
<span class="line">    Extensions       <span class="token builtin">int</span>                 <span class="token comment">// runcæ‰©å±•æ ‡å¿—</span></span>
<span class="line">    IDMapping        <span class="token operator">*</span>MountIDMapping     <span class="token comment">// idmappedæŒ‚è½½é…ç½®</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å¸¸ç”¨æ–¹æ³•</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Mount<span class="token punctuation">)</span> <span class="token function">IsBind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> m<span class="token punctuation">.</span>Flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_BIND <span class="token operator">!=</span> <span class="token number">0</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Mount<span class="token punctuation">)</span> <span class="token function">IsIDMapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> m<span class="token punctuation">.</span>IDMapping <span class="token operator">!=</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-æŒ‚è½½é€‰é¡¹è§£ææœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#_5-2-æŒ‚è½½é€‰é¡¹è§£ææœºåˆ¶"><span>5.2 æŒ‚è½½é€‰é¡¹è§£ææœºåˆ¶</span></a></h3><p>runc ä½¿ç”¨å¤šå±‚æ˜ å°„è¡¨è§£æ OCI è§„èŒƒä¸­çš„æŒ‚è½½é€‰é¡¹ï¼š</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/specconv/spec_linux.go:1079</span></span>
<span class="line"><span class="token keyword">var</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token comment">// åŸºç¡€æŒ‚è½½æ ‡å¿—æ˜ å°„  </span></span>
<span class="line">    mountFlags <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span>clear <span class="token builtin">bool</span><span class="token punctuation">;</span> flag <span class="token builtin">int</span><span class="token punctuation">}</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&quot;defaults&quot;</span><span class="token punctuation">:</span>   <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                    <span class="token comment">// é»˜è®¤é€‰é¡¹</span></span>
<span class="line">        <span class="token string">&quot;ro&quot;</span><span class="token punctuation">:</span>         <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_RDONLY<span class="token punctuation">}</span><span class="token punctuation">,</span>       <span class="token comment">// åªè¯»</span></span>
<span class="line">        <span class="token string">&quot;rw&quot;</span><span class="token punctuation">:</span>         <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_RDONLY<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token comment">// å¯å†™(æ¸…é™¤åªè¯»)</span></span>
<span class="line">        <span class="token string">&quot;nosuid&quot;</span><span class="token punctuation">:</span>     <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NOSUID<span class="token punctuation">}</span><span class="token punctuation">,</span>       <span class="token comment">// ç¦ç”¨suid</span></span>
<span class="line">        <span class="token string">&quot;suid&quot;</span><span class="token punctuation">:</span>       <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NOSUID<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token comment">// å…è®¸suid(æ¸…é™¤nosuid)</span></span>
<span class="line">        <span class="token string">&quot;nodev&quot;</span><span class="token punctuation">:</span>      <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NODEV<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token comment">// ç¦ç”¨è®¾å¤‡èŠ‚ç‚¹</span></span>
<span class="line">        <span class="token string">&quot;dev&quot;</span><span class="token punctuation">:</span>        <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NODEV<span class="token punctuation">}</span><span class="token punctuation">,</span>         <span class="token comment">// å…è®¸è®¾å¤‡èŠ‚ç‚¹</span></span>
<span class="line">        <span class="token string">&quot;noexec&quot;</span><span class="token punctuation">:</span>     <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NOEXEC<span class="token punctuation">}</span><span class="token punctuation">,</span>       <span class="token comment">// ç¦ç”¨å¯æ‰§è¡Œæ–‡ä»¶</span></span>
<span class="line">        <span class="token string">&quot;exec&quot;</span><span class="token punctuation">:</span>       <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NOEXEC<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token comment">// å…è®¸å¯æ‰§è¡Œæ–‡ä»¶</span></span>
<span class="line">        <span class="token string">&quot;sync&quot;</span><span class="token punctuation">:</span>       <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_SYNCHRONOUS<span class="token punctuation">}</span><span class="token punctuation">,</span>   <span class="token comment">// åŒæ­¥IO</span></span>
<span class="line">        <span class="token string">&quot;async&quot;</span><span class="token punctuation">:</span>      <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_SYNCHRONOUS<span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">// å¼‚æ­¥IO</span></span>
<span class="line">        <span class="token string">&quot;dirsync&quot;</span><span class="token punctuation">:</span>    <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_DIRSYNC<span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token comment">// ç›®å½•åŒæ­¥</span></span>
<span class="line">        <span class="token string">&quot;remount&quot;</span><span class="token punctuation">:</span>    <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_REMOUNT<span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token comment">// é‡æ–°æŒ‚è½½</span></span>
<span class="line">        <span class="token string">&quot;mand&quot;</span><span class="token punctuation">:</span>       <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_MANDLOCK<span class="token punctuation">}</span><span class="token punctuation">,</span>     <span class="token comment">// å¼ºåˆ¶é”</span></span>
<span class="line">        <span class="token string">&quot;nomand&quot;</span><span class="token punctuation">:</span>     <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_MANDLOCK<span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token comment">// ç¦ç”¨å¼ºåˆ¶é”</span></span>
<span class="line">        <span class="token string">&quot;atime&quot;</span><span class="token punctuation">:</span>      <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NOATIME<span class="token punctuation">}</span><span class="token punctuation">,</span>       <span class="token comment">// æ›´æ–°è®¿é—®æ—¶é—´</span></span>
<span class="line">        <span class="token string">&quot;noatime&quot;</span><span class="token punctuation">:</span>    <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NOATIME<span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token comment">// ä¸æ›´æ–°è®¿é—®æ—¶é—´</span></span>
<span class="line">        <span class="token string">&quot;diratime&quot;</span><span class="token punctuation">:</span>   <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NODIRATIME<span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">// ç›®å½•è®¿é—®æ—¶é—´</span></span>
<span class="line">        <span class="token string">&quot;nodiratime&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NODIRATIME<span class="token punctuation">}</span><span class="token punctuation">,</span>   <span class="token comment">// ç¦ç”¨ç›®å½•è®¿é—®æ—¶é—´</span></span>
<span class="line">        <span class="token string">&quot;bind&quot;</span><span class="token punctuation">:</span>       <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_BIND<span class="token punctuation">}</span><span class="token punctuation">,</span>         <span class="token comment">// bindæŒ‚è½½</span></span>
<span class="line">        <span class="token string">&quot;rbind&quot;</span><span class="token punctuation">:</span>      <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_BIND <span class="token operator">|</span> unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// é€’å½’bindæŒ‚è½½</span></span>
<span class="line">        <span class="token string">&quot;relatime&quot;</span><span class="token punctuation">:</span>   <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_RELATIME<span class="token punctuation">}</span><span class="token punctuation">,</span>     <span class="token comment">// ç›¸å¯¹è®¿é—®æ—¶é—´</span></span>
<span class="line">        <span class="token string">&quot;norelatime&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_RELATIME<span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token comment">// ç¦ç”¨ç›¸å¯¹è®¿é—®æ—¶é—´</span></span>
<span class="line">        <span class="token string">&quot;strictatime&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_STRICTATIME<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// ä¸¥æ ¼è®¿é—®æ—¶é—´</span></span>
<span class="line">        <span class="token string">&quot;nostrictatime&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_STRICTATIME<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// éä¸¥æ ¼è®¿é—®æ—¶é—´</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æŒ‚è½½ä¼ æ’­å±æ€§æ˜ å°„</span></span>
<span class="line">    mountPropagationMapping <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&quot;private&quot;</span><span class="token punctuation">:</span>     unix<span class="token punctuation">.</span>MS_PRIVATE<span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rprivate&quot;</span><span class="token punctuation">:</span>    unix<span class="token punctuation">.</span>MS_PRIVATE <span class="token operator">|</span> unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;shared&quot;</span><span class="token punctuation">:</span>      unix<span class="token punctuation">.</span>MS_SHARED<span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rshared&quot;</span><span class="token punctuation">:</span>     unix<span class="token punctuation">.</span>MS_SHARED <span class="token operator">|</span> unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;slave&quot;</span><span class="token punctuation">:</span>       unix<span class="token punctuation">.</span>MS_SLAVE<span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rslave&quot;</span><span class="token punctuation">:</span>      unix<span class="token punctuation">.</span>MS_SLAVE <span class="token operator">|</span> unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;unbindable&quot;</span><span class="token punctuation">:</span>  unix<span class="token punctuation">.</span>MS_UNBINDABLE<span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;runbindable&quot;</span><span class="token punctuation">:</span> unix<span class="token punctuation">.</span>MS_UNBINDABLE <span class="token operator">|</span> unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// mount_setattré€’å½’å±æ€§æ˜ å°„ (Linux 5.12+)</span></span>
<span class="line">    recAttrFlags <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span>clear <span class="token builtin">bool</span><span class="token punctuation">;</span> flag <span class="token builtin">uint64</span><span class="token punctuation">}</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&quot;rro&quot;</span><span class="token punctuation">:</span>        <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_RDONLY<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rrw&quot;</span><span class="token punctuation">:</span>        <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_RDONLY<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rnosuid&quot;</span><span class="token punctuation">:</span>    <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_NOSUID<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rsuid&quot;</span><span class="token punctuation">:</span>      <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_NOSUID<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rnodev&quot;</span><span class="token punctuation">:</span>     <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_NODEV<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rdev&quot;</span><span class="token punctuation">:</span>       <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_NODEV<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rnoexec&quot;</span><span class="token punctuation">:</span>    <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_NOEXEC<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rexec&quot;</span><span class="token punctuation">:</span>      <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_NOEXEC<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rnodiratime&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_NODIRATIME<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rdiratime&quot;</span><span class="token punctuation">:</span>   <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_NODIRATIME<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rnoatime&quot;</span><span class="token punctuation">:</span>    <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_NOATIME<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;ratime&quot;</span><span class="token punctuation">:</span>      <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_NOATIME<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rrelatime&quot;</span><span class="token punctuation">:</span>   <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_RELATIME<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rnorelatime&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_RELATIME<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rstrictatime&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_STRICTATIME<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rnostrictatime&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MOUNT_ATTR_STRICTATIME<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-é€‰é¡¹è§£æç®—æ³•" tabindex="-1"><a class="header-anchor" href="#_5-3-é€‰é¡¹è§£æç®—æ³•"><span>5.3 é€‰é¡¹è§£æç®—æ³•</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">parseMountOptions</span><span class="token punctuation">(</span>options <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>configs<span class="token punctuation">.</span>Mount<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> <span class="token punctuation">(</span></span>
<span class="line">        data     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span></span>
<span class="line">        mount    configs<span class="token punctuation">.</span>Mount</span>
<span class="line">        recAttrSet<span class="token punctuation">,</span> recAttrClr <span class="token builtin">uint64</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> option <span class="token operator">:=</span> <span class="token keyword">range</span> options <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> f<span class="token punctuation">,</span> exists <span class="token operator">:=</span> mountFlags<span class="token punctuation">[</span>option<span class="token punctuation">]</span><span class="token punctuation">;</span> exists <span class="token operator">&amp;&amp;</span> f<span class="token punctuation">.</span>flag <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> f<span class="token punctuation">.</span>clear <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// æ¸…é™¤æ ‡å¿—</span></span>
<span class="line">                mount<span class="token punctuation">.</span>Flags <span class="token operator">&amp;=</span> <span class="token operator">^</span>f<span class="token punctuation">.</span>flag</span>
<span class="line">                mount<span class="token punctuation">.</span>ClearedFlags <span class="token operator">|=</span> f<span class="token punctuation">.</span>flag</span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// è®¾ç½®æ ‡å¿—</span></span>
<span class="line">                mount<span class="token punctuation">.</span>Flags <span class="token operator">|=</span> f<span class="token punctuation">.</span>flag</span>
<span class="line">                mount<span class="token punctuation">.</span>ClearedFlags <span class="token operator">&amp;=</span> <span class="token operator">^</span>f<span class="token punctuation">.</span>flag</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> f<span class="token punctuation">,</span> exists <span class="token operator">:=</span> mountPropagationMapping<span class="token punctuation">[</span>option<span class="token punctuation">]</span><span class="token punctuation">;</span> exists <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// ä¼ æ’­å±æ€§</span></span>
<span class="line">            mount<span class="token punctuation">.</span>PropagationFlags <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>mount<span class="token punctuation">.</span>PropagationFlags<span class="token punctuation">,</span> f<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> f<span class="token punctuation">,</span> exists <span class="token operator">:=</span> recAttrFlags<span class="token punctuation">[</span>option<span class="token punctuation">]</span><span class="token punctuation">;</span> exists <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// é€’å½’å±æ€§ (mount_setattr)</span></span>
<span class="line">            <span class="token keyword">if</span> f<span class="token punctuation">.</span>clear <span class="token punctuation">{</span></span>
<span class="line">                recAttrClr <span class="token operator">|=</span> f<span class="token punctuation">.</span>flag</span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                recAttrSet <span class="token operator">|=</span> f<span class="token punctuation">.</span>flag</span>
<span class="line">                <span class="token comment">// atimeæ ‡å¿—éœ€è¦ç‰¹æ®Šå¤„ç†</span></span>
<span class="line">                <span class="token keyword">if</span> f<span class="token punctuation">.</span>flag<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MOUNT_ATTR__ATIME <span class="token operator">==</span> f<span class="token punctuation">.</span>flag <span class="token punctuation">{</span></span>
<span class="line">                    recAttrClr <span class="token operator">|=</span> unix<span class="token punctuation">.</span>MOUNT_ATTR__ATIME</span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// æ–‡ä»¶ç³»ç»Ÿç‰¹å®šé€‰é¡¹</span></span>
<span class="line">            data <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> option<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    mount<span class="token punctuation">.</span>Data <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®¾ç½®mount_setattrå±æ€§</span></span>
<span class="line">    <span class="token keyword">if</span> recAttrSet <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> recAttrClr <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        mount<span class="token punctuation">.</span>RecAttr <span class="token operator">=</span> <span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MountAttr<span class="token punctuation">{</span></span>
<span class="line">            Attr_set<span class="token punctuation">:</span> recAttrSet<span class="token punctuation">,</span></span>
<span class="line">            Attr_clr<span class="token punctuation">:</span> recAttrClr<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>mount<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-å®‰å…¨æœºåˆ¶å’Œé”™è¯¯å¤„ç†" tabindex="-1"><a class="header-anchor" href="#_6-å®‰å…¨æœºåˆ¶å’Œé”™è¯¯å¤„ç†"><span>6. å®‰å…¨æœºåˆ¶å’Œé”™è¯¯å¤„ç†</span></a></h2><h3 id="_6-1-è·¯å¾„å®‰å…¨å¤„ç†" tabindex="-1"><a class="header-anchor" href="#_6-1-è·¯å¾„å®‰å…¨å¤„ç†"><span>6.1 è·¯å¾„å®‰å…¨å¤„ç†</span></a></h3><p>runc ä½¿ç”¨å¤šç§æœºåˆ¶é˜²æ­¢è·¯å¾„éå†æ”»å‡»ï¼š</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// ä½¿ç”¨procfdç¡®ä¿è·¯å¾„å®‰å…¨</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">WithProcfd</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">,</span> fn <span class="token keyword">func</span><span class="token punctuation">(</span>procfd <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ä½¿ç”¨ /proc/self/fd/&lt;fd&gt; ç¡®ä¿æ“ä½œåœ¨æ­£ç¡®çš„è·¯å¾„ä¸Š</span></span>
<span class="line">    file<span class="token punctuation">,</span> err <span class="token operator">:=</span> securejoin<span class="token punctuation">.</span><span class="token function">OpenInRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> path<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>O_PATH<span class="token operator">|</span>unix<span class="token punctuation">.</span>O_CLOEXEC<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    procfd <span class="token operator">:=</span> <span class="token string">&quot;/proc/self/fd/&quot;</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">Fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>procfd<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// securejoin ç¡®ä¿å®‰å…¨è·¯å¾„è¿æ¥</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">secureJoin</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// é˜²æ­¢ ../ è·¯å¾„éå†</span></span>
<span class="line">    <span class="token comment">// é˜²æ­¢ç¬¦å·é“¾æ¥é€ƒé€¸  </span></span>
<span class="line">    <span class="token comment">// ç¡®ä¿ç»“æœè·¯å¾„åœ¨rootå†…éƒ¨</span></span>
<span class="line">    <span class="token keyword">return</span> securejoin<span class="token punctuation">.</span><span class="token function">SecureJoin</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> path<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-é”™è¯¯å¤„ç†å’Œè¯Šæ–­" tabindex="-1"><a class="header-anchor" href="#_6-2-é”™è¯¯å¤„ç†å’Œè¯Šæ–­"><span>6.2 é”™è¯¯å¤„ç†å’Œè¯Šæ–­</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// ç»“æ„åŒ–çš„æŒ‚è½½é”™è¯¯ä¿¡æ¯</span></span>
<span class="line"><span class="token keyword">type</span> mountError <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    op      <span class="token builtin">string</span>        <span class="token comment">// æ“ä½œç±»å‹ (mount/unmount)</span></span>
<span class="line">    source  <span class="token builtin">string</span>        <span class="token comment">// æºè·¯å¾„</span></span>
<span class="line">    srcFile <span class="token operator">*</span>mountSource  <span class="token comment">// æºæ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯</span></span>
<span class="line">    target  <span class="token builtin">string</span>        <span class="token comment">// ç›®æ ‡è·¯å¾„</span></span>
<span class="line">    dstFd   <span class="token builtin">string</span>        <span class="token comment">// ç›®æ ‡procfdè·¯å¾„</span></span>
<span class="line">    flags   <span class="token builtin">uintptr</span>       <span class="token comment">// æŒ‚è½½æ ‡å¿—</span></span>
<span class="line">    data    <span class="token builtin">string</span>        <span class="token comment">// æŒ‚è½½é€‰é¡¹</span></span>
<span class="line">    err     <span class="token builtin">error</span>         <span class="token comment">// åº•å±‚é”™è¯¯</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>mountError<span class="token punctuation">)</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> srcType <span class="token builtin">string</span></span>
<span class="line">    <span class="token keyword">if</span> e<span class="token punctuation">.</span>srcFile <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        srcType <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>srcFile<span class="token punctuation">.</span>Type<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s failed: src=%s, srcType=%s, dst=%s, flags=%s, data=%s: %v&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                       e<span class="token punctuation">.</span>op<span class="token punctuation">,</span> e<span class="token punctuation">.</span>source<span class="token punctuation">,</span> srcType<span class="token punctuation">,</span> e<span class="token punctuation">.</span>target<span class="token punctuation">,</span></span>
<span class="line">                       <span class="token function">stringifyMountFlags</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>flags<span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>data<span class="token punctuation">,</span> e<span class="token punctuation">.</span>err<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æŒ‚è½½æ ‡å¿—çš„å¯è¯»åŒ–</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">stringifyMountFlags</span><span class="token punctuation">(</span>flags <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> opts <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span></span>
<span class="line">    <span class="token keyword">if</span> flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_RDONLY <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        opts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token string">&quot;ro&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_NOSUID <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        opts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token string">&quot;nosuid&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_NODEV <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        opts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token string">&quot;nodev&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_NOEXEC <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        opts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token string">&quot;noexec&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_BIND <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        opts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token string">&quot;bind&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// ... æ›´å¤šæ ‡å¿—</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;0&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-åªè¯»æ–‡ä»¶ç³»ç»ŸåŠ å›º" tabindex="-1"><a class="header-anchor" href="#_6-3-åªè¯»æ–‡ä»¶ç³»ç»ŸåŠ å›º"><span>6.3 åªè¯»æ–‡ä»¶ç³»ç»ŸåŠ å›º</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// libcontainer/rootfs_linux.go:388</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">finalizeRootfs</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. é‡æ–°æŒ‚è½½å»¶è¿Ÿåªè¯»çš„æ–‡ä»¶ç³»ç»Ÿ</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> mount <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Mounts <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> mount<span class="token punctuation">.</span>Flags<span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>MS_RDONLY <span class="token operator">!=</span> unix<span class="token punctuation">.</span>MS_RDONLY <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">continue</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// tmpfs å’Œ /dev å»¶è¿Ÿåªè¯»å¤„ç†</span></span>
<span class="line">        <span class="token keyword">if</span> mount<span class="token punctuation">.</span>Device <span class="token operator">==</span> <span class="token string">&quot;tmpfs&quot;</span> <span class="token operator">||</span> utils<span class="token punctuation">.</span><span class="token function">CleanPath</span><span class="token punctuation">(</span>mount<span class="token punctuation">.</span>Destination<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;/dev&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">remountReadonly</span><span class="token punctuation">(</span>mount<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to remount %s as readonly: %w&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                                 mount<span class="token punctuation">.</span>Destination<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. è®¾ç½®æ ¹æ–‡ä»¶ç³»ç»Ÿåªè¯»</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>Readonlyfs <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setReadonly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set rootfs readonly: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. åº”ç”¨ umask</span></span>
<span class="line">    <span class="token keyword">if</span> config<span class="token punctuation">.</span>Umask <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        unix<span class="token punctuation">.</span><span class="token function">Umask</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token operator">*</span>config<span class="token punctuation">.</span>Umask<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        unix<span class="token punctuation">.</span><span class="token function">Umask</span><span class="token punctuation">(</span><span class="token number">0o022</span><span class="token punctuation">)</span>  <span class="token comment">// é»˜è®¤ umask</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setReadonly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// é‡æ–°æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿä¸ºåªè¯»</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_BIND<span class="token operator">|</span>unix<span class="token punctuation">.</span>MS_REMOUNT<span class="token operator">|</span>unix<span class="token punctuation">.</span>MS_RDONLY<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-å®è·µç»ƒä¹ " tabindex="-1"><a class="header-anchor" href="#_7-å®è·µç»ƒä¹ "><span>7. å®è·µç»ƒä¹ </span></a></h2><h3 id="_7-1-åŸºç¡€æŒ‚è½½å®éªŒ" tabindex="-1"><a class="header-anchor" href="#_7-1-åŸºç¡€æŒ‚è½½å®éªŒ"><span>7.1 åŸºç¡€æŒ‚è½½å®éªŒ</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># å®éªŒ 1: ç†è§£ä¸åŒæŒ‚è½½ç±»å‹</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># åˆ›å»ºå®éªŒç¯å¢ƒ</span></span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /tmp/rootfs/<span class="token punctuation">{</span>bin,etc,proc,sys,dev,tmp<span class="token punctuation">}</span></span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /tmp/host-data</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 1. bind æŒ‚è½½å®éªŒ</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;host content&quot;</span> <span class="token operator">&gt;</span> /tmp/host-data/file.txt</span>
<span class="line"><span class="token function">mount</span> <span class="token parameter variable">--bind</span> /tmp/host-data /tmp/rootfs/tmp</span>
<span class="line"><span class="token function">ls</span> /tmp/rootfs/tmp/  <span class="token comment"># åº”è¯¥çœ‹åˆ° file.txt</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 2. tmpfs æŒ‚è½½å®éªŒ</span></span>
<span class="line"><span class="token function">mount</span> <span class="token parameter variable">-t</span> tmpfs tmpfs /tmp/rootfs/dev <span class="token parameter variable">-o</span> <span class="token assign-left variable">size</span><span class="token operator">=</span>10M,mode<span class="token operator">=</span><span class="token number">755</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;tmpfs content&quot;</span> <span class="token operator">&gt;</span> /tmp/rootfs/dev/tmpfile</span>
<span class="line"><span class="token function">ls</span> /tmp/rootfs/dev/</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 3. proc æŒ‚è½½å®éªŒ</span></span>
<span class="line"><span class="token function">mount</span> <span class="token parameter variable">-t</span> proc proc /tmp/rootfs/proc</span>
<span class="line"><span class="token function">ls</span> /tmp/rootfs/proc/  <span class="token comment"># çœ‹åˆ°procå†…å®¹</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 4. æµ‹è¯•æŒ‚è½½ä¼ æ’­</span></span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /tmp/test-propagation/<span class="token punctuation">{</span>source,target<span class="token punctuation">}</span></span>
<span class="line"><span class="token function">mount</span> <span class="token parameter variable">--bind</span> /tmp/test-propagation/source /tmp/test-propagation/target</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å…±äº«ä¼ æ’­</span></span>
<span class="line"><span class="token function">mount</span> --make-shared /tmp/test-propagation/target</span>
<span class="line"><span class="token function">mount</span> <span class="token parameter variable">--bind</span> /tmp/host-data /tmp/test-propagation/target/shared</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥ä¼ æ’­æ•ˆæœ</span></span>
<span class="line"><span class="token function">ls</span> /tmp/test-propagation/source/  <span class="token comment"># åº”è¯¥çœ‹åˆ°sharedç›®å½•</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ¸…ç†</span></span>
<span class="line"><span class="token function">umount</span> <span class="token parameter variable">-R</span> /tmp/rootfs</span>
<span class="line"><span class="token function">umount</span> <span class="token parameter variable">-R</span> /tmp/test-propagation</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-å®¹å™¨æ–‡ä»¶ç³»ç»Ÿæ„å»º" tabindex="-1"><a class="header-anchor" href="#_7-2-å®¹å™¨æ–‡ä»¶ç³»ç»Ÿæ„å»º"><span>7.2 å®¹å™¨æ–‡ä»¶ç³»ç»Ÿæ„å»º</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># å®éªŒ 2: æ‰‹åŠ¨æ„å»ºå®¹å™¨æ–‡ä»¶ç³»ç»Ÿ</span></span>
<span class="line"></span>
<span class="line"><span class="token function-name function">create_container_rootfs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin class-name">local</span> <span class="token assign-left variable">rootfs</span><span class="token operator">=</span><span class="token string">&quot;/tmp/container-rootfs&quot;</span></span>
<span class="line">    <span class="token builtin class-name">local</span> <span class="token assign-left variable">old_root</span><span class="token operator">=</span><span class="token string">&quot;/tmp/old-root&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 1. å‡†å¤‡åŸºç¡€rootfs</span></span>
<span class="line">    <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token string">&quot;<span class="token variable">$rootfs</span>&quot;</span>/<span class="token punctuation">{</span>bin,etc,lib,proc,sys,dev,tmp<span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># å¤åˆ¶å¿…è¦çš„å¯æ‰§è¡Œæ–‡ä»¶</span></span>
<span class="line">    <span class="token function">cp</span> /bin/sh <span class="token string">&quot;<span class="token variable">$rootfs</span>/bin/&quot;</span></span>
<span class="line">    <span class="token function">cp</span> /bin/ls <span class="token string">&quot;<span class="token variable">$rootfs</span>/bin/&quot;</span></span>
<span class="line">    <span class="token function">cp</span> /bin/cat <span class="token string">&quot;<span class="token variable">$rootfs</span>/bin/&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># å¤åˆ¶åº“æ–‡ä»¶</span></span>
<span class="line">    ldd /bin/sh <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-o</span> <span class="token string">&#39;/lib[^ ]*&#39;</span> <span class="token operator">|</span> <span class="token keyword">while</span> <span class="token builtin class-name">read</span> lib<span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">        <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token string">&quot;<span class="token variable">$rootfs</span><span class="token variable"><span class="token variable">$(</span><span class="token function">dirname</span> <span class="token string">&quot;<span class="token variable">$lib</span>&quot;</span><span class="token variable">)</span></span>&quot;</span></span>
<span class="line">        <span class="token function">cp</span> <span class="token string">&quot;<span class="token variable">$lib</span>&quot;</span> <span class="token string">&quot;<span class="token variable">$rootfs</span><span class="token variable">$lib</span>&quot;</span></span>
<span class="line">    <span class="token keyword">done</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 2. è®¾ç½®æŒ‚è½½ä¼ æ’­</span></span>
<span class="line">    <span class="token function">mount</span> --make-private /</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 3. bindæŒ‚è½½rootfsåˆ°è‡ªèº«</span></span>
<span class="line">    <span class="token function">mount</span> <span class="token parameter variable">--bind</span> <span class="token string">&quot;<span class="token variable">$rootfs</span>&quot;</span> <span class="token string">&quot;<span class="token variable">$rootfs</span>&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 4. åˆ‡æ¢åˆ°æ–°namespaceä¸­æ‰§è¡Œ</span></span>
<span class="line">    unshare <span class="token parameter variable">--mount</span> <span class="token parameter variable">--pid</span> <span class="token parameter variable">--fork</span> /bin/bash <span class="token parameter variable">-c</span> <span class="token string">&quot;</span>
<span class="line">        # åœ¨æ–°çš„mount namespaceä¸­</span>
<span class="line">        cd &#39;<span class="token variable">$rootfs</span>&#39;</span>
<span class="line">        </span>
<span class="line">        # æŒ‚è½½ç‰¹æ®Šæ–‡ä»¶ç³»ç»Ÿ</span>
<span class="line">        mount -t proc proc proc/</span>
<span class="line">        mount -t sysfs sysfs sys/</span>
<span class="line">        mount -t tmpfs tmpfs tmp/ -o size=100M</span>
<span class="line">        </span>
<span class="line">        # åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹</span>
<span class="line">        mkdir -p dev</span>
<span class="line">        mknod dev/null c 1 3</span>
<span class="line">        mknod dev/zero c 1 5</span>
<span class="line">        mknod dev/random c 1 8</span>
<span class="line">        </span>
<span class="line">        # åˆ›å»ºç¬¦å·é“¾æ¥</span>
<span class="line">        ln -sf /proc/self/fd dev/fd</span>
<span class="line">        ln -sf /proc/self/fd/0 dev/stdin</span>
<span class="line">        ln -sf /proc/self/fd/1 dev/stdout</span>
<span class="line">        ln -sf /proc/self/fd/2 dev/stderr</span>
<span class="line">        </span>
<span class="line">        # æ‰§è¡Œpivot_root</span>
<span class="line">        mkdir -p &#39;<span class="token variable">$old_root</span>&#39;</span>
<span class="line">        pivot_root . &#39;<span class="token variable">$old_root</span>&#39;</span>
<span class="line">        </span>
<span class="line">        # å¸è½½æ—§æ ¹</span>
<span class="line">        umount /<span class="token variable">$old_root</span> 2&gt;/dev/null || true</span>
<span class="line">        rmdir /<span class="token variable">$old_root</span> 2&gt;/dev/null || true</span>
<span class="line">        </span>
<span class="line">        # è¿›å…¥å®¹å™¨ç¯å¢ƒ</span>
<span class="line">        cd /</span>
<span class="line">        exec /bin/sh</span>
<span class="line">    &quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ‰§è¡Œå®éªŒ</span></span>
<span class="line">create_container_rootfs</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-3-æŒ‚è½½é€‰é¡¹è§£ææµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#_7-3-æŒ‚è½½é€‰é¡¹è§£ææµ‹è¯•"><span>7.3 æŒ‚è½½é€‰é¡¹è§£ææµ‹è¯•</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// å®éªŒ 3: ç†è§£æŒ‚è½½é€‰é¡¹è§£æ</span></span>
<span class="line"><span class="token keyword">package</span> main</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;fmt&quot;</span></span>
<span class="line">    <span class="token string">&quot;strings&quot;</span></span>
<span class="line">    <span class="token string">&quot;golang.org/x/sys/unix&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">parseMountOptions</span><span class="token punctuation">(</span>options <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> flags <span class="token builtin">int</span></span>
<span class="line">    <span class="token keyword">var</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span></span>
<span class="line">    </span>
<span class="line">    mountFlags <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span>clear <span class="token builtin">bool</span><span class="token punctuation">;</span> flag <span class="token builtin">int</span><span class="token punctuation">}</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&quot;ro&quot;</span><span class="token punctuation">:</span>     <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_RDONLY<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rw&quot;</span><span class="token punctuation">:</span>     <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_RDONLY<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;nosuid&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NOSUID<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;suid&quot;</span><span class="token punctuation">:</span>   <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_NOSUID<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;bind&quot;</span><span class="token punctuation">:</span>   <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_BIND<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;rbind&quot;</span><span class="token punctuation">:</span>  <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_BIND <span class="token operator">|</span> unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> opt <span class="token operator">:=</span> <span class="token keyword">range</span> options <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> f<span class="token punctuation">,</span> exists <span class="token operator">:=</span> mountFlags<span class="token punctuation">[</span>opt<span class="token punctuation">]</span><span class="token punctuation">;</span> exists <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> f<span class="token punctuation">.</span>clear <span class="token punctuation">{</span></span>
<span class="line">                flags <span class="token operator">&amp;=</span> <span class="token operator">^</span>f<span class="token punctuation">.</span>flag</span>
<span class="line">                fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Cleared flag: %s\\n&quot;</span><span class="token punctuation">,</span> opt<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                flags <span class="token operator">|=</span> f<span class="token punctuation">.</span>flag</span>
<span class="line">                fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Set flag: %s\\n&quot;</span><span class="token punctuation">,</span> opt<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            data <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> opt<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Final flags: %d\\n&quot;</span><span class="token punctuation">,</span> flags<span class="token punctuation">)</span></span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Data: %s\\n&quot;</span><span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æµ‹è¯•ä¸åŒé€‰é¡¹ç»„åˆ</span></span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;=== Test 1: ro,nosuid,bind ===&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">parseMountOptions</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;ro&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;nosuid&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bind&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;\\n=== Test 2: rw,suid,rbind,size=100M ===&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">parseMountOptions</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;rw&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;suid&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rbind&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;size=100M&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;\\n=== Test 3: ro then rw ===&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">parseMountOptions</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;ro&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rw&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-4-æ–‡ä»¶ç³»ç»Ÿå®‰å…¨æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#_7-4-æ–‡ä»¶ç³»ç»Ÿå®‰å…¨æµ‹è¯•"><span>7.4 æ–‡ä»¶ç³»ç»Ÿå®‰å…¨æµ‹è¯•</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># å®éªŒ 4: æµ‹è¯•æ–‡ä»¶ç³»ç»Ÿå®‰å…¨æœºåˆ¶</span></span>
<span class="line"></span>
<span class="line"><span class="token function-name function">test_path_traversal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;=== Path Traversal Test ===&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># åˆ›å»ºå®¹å™¨rootfs</span></span>
<span class="line">    <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /tmp/container/<span class="token punctuation">{</span>rootfs,host-secret<span class="token punctuation">}</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;secret content&quot;</span> <span class="token operator">&gt;</span> /tmp/container/host-secret/secret.txt</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># æµ‹è¯•è·¯å¾„éå†é˜²æŠ¤</span></span>
<span class="line">    <span class="token function">ln</span> <span class="token parameter variable">-sf</span> <span class="token punctuation">..</span>/host-secret /tmp/container/rootfs/escape</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># runcä¼šé˜²æ­¢è¿™ç§ç¬¦å·é“¾æ¥é€ƒé€¸</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;Attempting to access: /tmp/container/rootfs/escape/secret.txt&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># æ¨¡æ‹Ÿsecurejoinæ£€æŸ¥</span></span>
<span class="line">    <span class="token keyword">if</span> readlink /tmp/container/rootfs/escape <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token string">&quot;\\.\\.&quot;</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;Path traversal detected and blocked!&quot;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token function-name function">test_proc_mount_security</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;=== /proc Mount Security Test ===&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /tmp/test-proc/rootfs/proc</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># å…è®¸çš„/procæŒ‚è½½</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;Testing allowed /proc paths:&quot;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token for-or-select variable">path</span> <span class="token keyword">in</span> <span class="token string">&quot;/proc/cpuinfo&quot;</span> <span class="token string">&quot;/proc/meminfo&quot;</span> <span class="token string">&quot;/proc/uptime&quot;</span><span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  <span class="token variable">$path</span> - ALLOWED&quot;</span></span>
<span class="line">    <span class="token keyword">done</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># ç¦æ­¢çš„/procæŒ‚è½½</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;Testing forbidden /proc paths:&quot;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token for-or-select variable">path</span> <span class="token keyword">in</span> <span class="token string">&quot;/proc/1/maps&quot;</span> <span class="token string">&quot;/proc/sys/kernel/core_pattern&quot;</span> <span class="token string">&quot;/proc/kcore&quot;</span><span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;  <span class="token variable">$path</span> - BLOCKED&quot;</span></span>
<span class="line">    <span class="token keyword">done</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token function-name function">test_bind_mount_flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;=== Bind Mount Flags Test ===&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># åˆ›å»ºæºç›®å½•å’Œæ–‡ä»¶</span></span>
<span class="line">    <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /tmp/bind-test/source</span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;test&quot;</span> <span class="token operator">&gt;</span> /tmp/bind-test/source/file.txt</span>
<span class="line">    <span class="token function">chmod</span> <span class="token number">777</span> /tmp/bind-test/source/file.txt</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># æµ‹è¯•åªè¯»bindæŒ‚è½½</span></span>
<span class="line">    <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /tmp/bind-test/target</span>
<span class="line">    <span class="token function">mount</span> <span class="token parameter variable">--bind</span> /tmp/bind-test/source /tmp/bind-test/target</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># å°è¯•é‡æ–°æŒ‚è½½ä¸ºåªè¯»</span></span>
<span class="line">    <span class="token function">mount</span> <span class="token parameter variable">-o</span> remount,ro /tmp/bind-test/target</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># æµ‹è¯•å†™å…¥ï¼ˆåº”è¯¥å¤±è´¥ï¼‰</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;write test&quot;</span> <span class="token operator">&gt;</span> /tmp/bind-test/target/file.txt <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;ERROR: Read-only bind mount failed!&quot;</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;SUCCESS: Read-only bind mount working&quot;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">umount</span> /tmp/bind-test/target</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># è¿è¡Œæµ‹è¯•</span></span>
<span class="line">test_path_traversal</span>
<span class="line">test_proc_mount_security  </span>
<span class="line">test_bind_mount_flags</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ¸…ç†</span></span>
<span class="line"><span class="token function">rm</span> <span class="token parameter variable">-rf</span> /tmp/container /tmp/test-proc /tmp/bind-test</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-æ•…éšœæ’é™¤å’Œè°ƒè¯•" tabindex="-1"><a class="header-anchor" href="#_8-æ•…éšœæ’é™¤å’Œè°ƒè¯•"><span>8. æ•…éšœæ’é™¤å’Œè°ƒè¯•</span></a></h2><h3 id="_8-1-å¸¸è§æŒ‚è½½é—®é¢˜è¯Šæ–­" tabindex="-1"><a class="header-anchor" href="#_8-1-å¸¸è§æŒ‚è½½é—®é¢˜è¯Šæ–­"><span>8.1 å¸¸è§æŒ‚è½½é—®é¢˜è¯Šæ–­</span></a></h3><h4 id="æƒé™é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#æƒé™é—®é¢˜"><span>æƒé™é—®é¢˜</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># æ£€æŸ¥å½“å‰æŒ‚è½½æƒ…å†µ</span></span>
<span class="line"><span class="token function">mount</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">&quot;container\\|runc&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿæƒé™</span></span>
<span class="line"><span class="token function">ls</span> <span class="token parameter variable">-la</span> /proc/self/ns/mnt  <span class="token comment"># mount namespace</span></span>
<span class="line"><span class="token function">ls</span> <span class="token parameter variable">-la</span> /sys/fs/cgroup     <span class="token comment"># cgroupæ–‡ä»¶ç³»ç»Ÿ</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥ç”¨æˆ·æƒé™</span></span>
<span class="line"><span class="token function">id</span></span>
<span class="line"><span class="token function">groups</span></span>
<span class="line"><span class="token function">cat</span> /proc/self/uid_map</span>
<span class="line"><span class="token function">cat</span> /proc/self/gid_map</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æŒ‚è½½ä¼ æ’­é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#æŒ‚è½½ä¼ æ’­é—®é¢˜"><span>æŒ‚è½½ä¼ æ’­é—®é¢˜</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># æ£€æŸ¥æŒ‚è½½ä¼ æ’­å±æ€§</span></span>
<span class="line"><span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">&quot;shared|slave|private&quot;</span> /proc/self/mountinfo</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹ç‰¹å®šæŒ‚è½½ç‚¹çš„ä¼ æ’­å±æ€§</span></span>
<span class="line">findmnt <span class="token parameter variable">-o</span> TARGET,PROPAGATION /</span>
<span class="line"></span>
<span class="line"><span class="token comment"># ä¿®å¤ä¼ æ’­å±æ€§</span></span>
<span class="line"><span class="token function">mount</span> --make-private /</span>
<span class="line"><span class="token function">mount</span> --make-slave /</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-è°ƒè¯•å·¥å…·å’Œæ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#_8-2-è°ƒè¯•å·¥å…·å’Œæ–¹æ³•"><span>8.2 è°ƒè¯•å·¥å…·å’Œæ–¹æ³•</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># strace è·Ÿè¸ªæŒ‚è½½ç³»ç»Ÿè°ƒç”¨</span></span>
<span class="line"><span class="token function">strace</span> <span class="token parameter variable">-f</span> <span class="token parameter variable">-e</span> <span class="token assign-left variable">trace</span><span class="token operator">=</span>mount,umount,pivot_root runc create container</span>
<span class="line"></span>
<span class="line"><span class="token comment"># ä½¿ç”¨ nsenter è¿›å…¥å®¹å™¨çš„ mount namespace</span></span>
<span class="line">nsenter <span class="token parameter variable">-m</span> <span class="token parameter variable">-p</span> <span class="token parameter variable">-t</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> inspect <span class="token parameter variable">-f</span> <span class="token string">&#39;{{.State.Pid}}&#39;</span> container<span class="token variable">)</span></span> /bin/sh</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥å®¹å™¨å†…çš„æŒ‚è½½æƒ…å†µ</span></span>
<span class="line">nsenter <span class="token parameter variable">-m</span> <span class="token parameter variable">-t</span> PID <span class="token function">cat</span> /proc/mounts</span>
<span class="line">nsenter <span class="token parameter variable">-m</span> <span class="token parameter variable">-t</span> PID findmnt</span>
<span class="line"></span>
<span class="line"><span class="token comment"># è°ƒè¯• runc æŒ‚è½½è¿‡ç¨‹</span></span>
<span class="line"><span class="token assign-left variable">RUNC_DEBUG</span><span class="token operator">=</span><span class="token number">1</span> runc create container <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-i</span> <span class="token function">mount</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-3-æ€§èƒ½åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_8-3-æ€§èƒ½åˆ†æ"><span>8.3 æ€§èƒ½åˆ†æ</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># æµ‹é‡æŒ‚è½½æ“ä½œæ—¶é—´</span></span>
<span class="line"><span class="token function">time</span> runc create container</span>
<span class="line"></span>
<span class="line"><span class="token comment"># åˆ†æI/Oæ€§èƒ½</span></span>
<span class="line">iostat <span class="token parameter variable">-x</span> <span class="token number">1</span> <span class="token number">10</span> <span class="token operator">&amp;</span></span>
<span class="line">runc run container</span>
<span class="line"><span class="token function">kill</span> %1</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å†…å­˜ä½¿ç”¨åˆ†æ</span></span>
<span class="line">/usr/bin/time <span class="token parameter variable">-v</span> runc run container</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-æ€è€ƒé¢˜" tabindex="-1"><a class="header-anchor" href="#_9-æ€è€ƒé¢˜"><span>9. æ€è€ƒé¢˜</span></a></h2><h3 id="_9-1-æ¶æ„è®¾è®¡æ€è€ƒ" tabindex="-1"><a class="header-anchor" href="#_9-1-æ¶æ„è®¾è®¡æ€è€ƒ"><span>9.1 æ¶æ„è®¾è®¡æ€è€ƒ</span></a></h3><ol><li><p><strong>rootfsåˆ‡æ¢æ–¹å¼</strong>: pivot_root vs MS_MOVE vs chroot çš„ä¼˜ç¼ºç‚¹å¯¹æ¯”ï¼Œä»€ä¹ˆåœºæ™¯ä¸‹é€‰æ‹©å“ªç§æ–¹å¼ï¼Ÿ</p></li><li><p><strong>æŒ‚è½½ä¼ æ’­</strong>: ä¸ºä»€ä¹ˆå®¹å™¨éœ€è¦ MS_SLAVE ä¼ æ’­å±æ€§ï¼Ÿå¦‚æœä½¿ç”¨ MS_SHARED ä¼šæœ‰ä»€ä¹ˆé£é™©ï¼Ÿ</p></li><li><p><strong>bindæŒ‚è½½å¤æ‚æ€§</strong>: ä¸ºä»€ä¹ˆ bind æŒ‚è½½éœ€è¦ remount æ¥åº”ç”¨æ ‡å¿—ï¼Ÿlocked flags é—®é¢˜å¦‚ä½•æ›´ä¼˜é›…åœ°è§£å†³ï¼Ÿ</p></li></ol><h3 id="_9-2-å®‰å…¨æ€§æ€è€ƒ" tabindex="-1"><a class="header-anchor" href="#_9-2-å®‰å…¨æ€§æ€è€ƒ"><span>9.2 å®‰å…¨æ€§æ€è€ƒ</span></a></h3><ol start="4"><li><p><strong>/procå®‰å…¨</strong>: é™¤äº†ç™½åå•æœºåˆ¶ï¼Œè¿˜æœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥å¢å¼º /proc æŒ‚è½½çš„å®‰å…¨æ€§ï¼Ÿ</p></li><li><p><strong>è·¯å¾„éå†</strong>: securejoin æœºåˆ¶èƒ½å¦é˜²å¾¡æ‰€æœ‰çš„è·¯å¾„éå†æ”»å‡»ï¼Ÿè¿˜æœ‰ä»€ä¹ˆæ½œåœ¨æ¼æ´ï¼Ÿ</p></li><li><p><strong>idmapped mounts</strong>: idmapped mounts åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹æœ€æœ‰ä»·å€¼ï¼Ÿæœ‰ä»€ä¹ˆå®‰å…¨é£é™©ï¼Ÿ</p></li></ol><h3 id="_9-3-æ€§èƒ½ä¼˜åŒ–æ€è€ƒ" tabindex="-1"><a class="header-anchor" href="#_9-3-æ€§èƒ½ä¼˜åŒ–æ€è€ƒ"><span>9.3 æ€§èƒ½ä¼˜åŒ–æ€è€ƒ</span></a></h3><ol start="7"><li><p><strong>æŒ‚è½½å¼€é”€</strong>: å¤§é‡æŒ‚è½½ç‚¹å¯¹å®¹å™¨å¯åŠ¨æ€§èƒ½çš„å½±å“ï¼Ÿå¦‚ä½•ä¼˜åŒ–ï¼Ÿ</p></li><li><p><strong>æ–‡ä»¶ç³»ç»Ÿé€‰æ‹©</strong>: ä¸åŒ rootfs æ–‡ä»¶ç³»ç»Ÿ (ext4/xfs/overlay) å¯¹æ€§èƒ½çš„å½±å“ï¼Ÿ</p></li><li><p><strong>å†…å­˜ä½¿ç”¨</strong>: tmpfs çš„å†…å­˜ä½¿ç”¨å¦‚ä½•æ§åˆ¶ï¼Ÿä½•æ—¶é€‰æ‹© tmpfs vs bind mountï¼Ÿ</p></li></ol><h2 id="_10-æ‰©å±•é˜…è¯»" tabindex="-1"><a class="header-anchor" href="#_10-æ‰©å±•é˜…è¯»"><span>10. æ‰©å±•é˜…è¯»</span></a></h2><h3 id="_10-1-linux-å†…æ ¸æ–‡æ¡£" tabindex="-1"><a class="header-anchor" href="#_10-1-linux-å†…æ ¸æ–‡æ¡£"><span>10.1 Linux å†…æ ¸æ–‡æ¡£</span></a></h3>`,102)),s("ul",null,[s("li",null,[s("a",d,[n[11]||(n[11]=a("Mount namespaces")),p(t)])]),s("li",null,[s("a",v,[n[12]||(n[12]=a("pivot_root(2)")),p(t)])]),s("li",null,[s("a",m,[n[13]||(n[13]=a("mount(2)")),p(t)])]),s("li",null,[s("a",b,[n[14]||(n[14]=a("mount_setattr(2)")),p(t)])])]),n[28]||(n[28]=s("h3",{id:"_10-2-æ–‡ä»¶ç³»ç»ŸæŠ€æœ¯",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_10-2-æ–‡ä»¶ç³»ç»ŸæŠ€æœ¯"},[s("span",null,"10.2 æ–‡ä»¶ç³»ç»ŸæŠ€æœ¯")])],-1)),s("ul",null,[s("li",null,[s("a",g,[n[15]||(n[15]=a("VFS (Virtual File System)")),p(t)])]),s("li",null,[s("a",f,[n[16]||(n[16]=a("Bind Mounts")),p(t)])]),s("li",null,[s("a",h,[n[17]||(n[17]=a("Mount propagation")),p(t)])]),s("li",null,[s("a",q,[n[18]||(n[18]=a("Idmapped mounts")),p(t)])])]),n[29]||(n[29]=s("h3",{id:"_10-3-å®¹å™¨æŠ€æœ¯æ·±å…¥",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_10-3-å®¹å™¨æŠ€æœ¯æ·±å…¥"},[s("span",null,"10.3 å®¹å™¨æŠ€æœ¯æ·±å…¥")])],-1)),s("ul",null,[s("li",null,[s("a",_,[n[19]||(n[19]=a("Container filesystems")),p(t)])]),s("li",null,[s("a",y,[n[20]||(n[20]=a("OverlayFS and containers")),p(t)])]),s("li",null,[s("a",w,[n[21]||(n[21]=a("Container security with mount namespaces")),p(t)])])]),n[30]||(n[30]=o('<h2 id="ğŸ¯-æ¨¡å—æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-æ¨¡å—æ€»ç»“"><span>ğŸ¯ æ¨¡å—æ€»ç»“</span></a></h2><p>é€šè¿‡æœ¬æ¨¡å—çš„å­¦ä¹ ï¼Œä½ åº”è¯¥å·²ç»æŒæ¡äº†ï¼š</p><p>âœ… <strong>Rootfs åˆ‡æ¢æœºåˆ¶</strong>ï¼šç†è§£ä¸‰ç§åˆ‡æ¢æ–¹å¼å’Œé€‚ç”¨åœºæ™¯<br> âœ… <strong>æŒ‚è½½ç±»å‹å¤„ç†</strong>ï¼šæŒæ¡å„ç§æ–‡ä»¶ç³»ç»Ÿçš„ä¸“é—¨å¤„ç†é€»è¾‘<br> âœ… <strong>å®‰å…¨é˜²æŠ¤æœºåˆ¶</strong>ï¼šç†è§£è·¯å¾„å®‰å…¨ã€procæ£€æŸ¥ç­‰é˜²æŠ¤æªæ–½<br> âœ… <strong>é…ç½®è§£æç³»ç»Ÿ</strong>ï¼šç†Ÿæ‚‰æŒ‚è½½é€‰é¡¹çš„å¤šå±‚æ˜ å°„å’Œè§£ææµç¨‹<br> âœ… <strong>æ•…éšœæ’é™¤èƒ½åŠ›</strong>ï¼šå…·å¤‡æŒ‚è½½é—®é¢˜è¯Šæ–­å’Œæ€§èƒ½ä¼˜åŒ–æŠ€èƒ½</p>',3)),s("p",null,[n[23]||(n[23]=s("strong",null,"ä¸‹ä¸€æ­¥",-1)),n[24]||(n[24]=a(": è¿›å…¥ ")),p(e,{to:"/blogs/cloud-base/runc-deep-dive/06-%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7%E5%AE%9E%E7%8E%B0.html"},{default:l(()=>n[22]||(n[22]=[a("æ¨¡å— 6: å®‰å…¨ç‰¹æ€§å®ç°")])),_:1,__:[22]}),n[25]||(n[25]=a("ï¼Œå­¦ä¹ å®¹å™¨å®‰å…¨æœºåˆ¶çš„å…·ä½“å®ç°ã€‚"))])])}const E=c(k,[["render",x]]),T=JSON.parse('{"path":"/blogs/cloud-base/runc-deep-dive/05-wenjianxitongyuguazaiguanli.html","title":"æ–‡ä»¶ç³»ç»Ÿä¸æŒ‚è½½ç®¡ç†","lang":"en-US","frontmatter":{"title":"æ–‡ä»¶ç³»ç»Ÿä¸æŒ‚è½½ç®¡ç†","date":"2025-08-05T00:00:00.000Z","tags":["runc","äº‘åŸç”Ÿ","æ–‡ä»¶ç³»ç»Ÿ"],"categories":["cloud-base/runc-deep-dive"],"sidebar":"auto"},"headers":[{"level":2,"title":"æ¦‚è¿°","slug":"æ¦‚è¿°","link":"#æ¦‚è¿°","children":[]},{"level":2,"title":"ğŸ¯ å­¦ä¹ ç›®æ ‡","slug":"ğŸ¯-å­¦ä¹ ç›®æ ‡","link":"#ğŸ¯-å­¦ä¹ ç›®æ ‡","children":[]},{"level":2,"title":"1. å®¹å™¨æ–‡ä»¶ç³»ç»ŸåŸºç¡€","slug":"_1-å®¹å™¨æ–‡ä»¶ç³»ç»ŸåŸºç¡€","link":"#_1-å®¹å™¨æ–‡ä»¶ç³»ç»ŸåŸºç¡€","children":[{"level":3,"title":"1.1 ä»€ä¹ˆæ˜¯å®¹å™¨æ–‡ä»¶ç³»ç»Ÿï¼Ÿ","slug":"_1-1-ä»€ä¹ˆæ˜¯å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ","link":"#_1-1-ä»€ä¹ˆæ˜¯å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ","children":[]},{"level":3,"title":"1.2 æ–‡ä»¶ç³»ç»Ÿéš”ç¦»å±‚æ¬¡","slug":"_1-2-æ–‡ä»¶ç³»ç»Ÿéš”ç¦»å±‚æ¬¡","link":"#_1-2-æ–‡ä»¶ç³»ç»Ÿéš”ç¦»å±‚æ¬¡","children":[]}]},{"level":2,"title":"2. Rootfs å‡†å¤‡å’Œåˆ‡æ¢æœºåˆ¶","slug":"_2-rootfs-å‡†å¤‡å’Œåˆ‡æ¢æœºåˆ¶","link":"#_2-rootfs-å‡†å¤‡å’Œåˆ‡æ¢æœºåˆ¶","children":[{"level":3,"title":"2.1 æ•´ä½“æµç¨‹æ¶æ„","slug":"_2-1-æ•´ä½“æµç¨‹æ¶æ„","link":"#_2-1-æ•´ä½“æµç¨‹æ¶æ„","children":[]},{"level":3,"title":"2.2 prepareRoot - æ ¹æŒ‚è½½ç‚¹é¢„å¤„ç†","slug":"_2-2-prepareroot-æ ¹æŒ‚è½½ç‚¹é¢„å¤„ç†","link":"#_2-2-prepareroot-æ ¹æŒ‚è½½ç‚¹é¢„å¤„ç†","children":[]},{"level":3,"title":"2.3 ä¸‰ç§æ ¹æ–‡ä»¶ç³»ç»Ÿåˆ‡æ¢æ–¹å¼","slug":"_2-3-ä¸‰ç§æ ¹æ–‡ä»¶ç³»ç»Ÿåˆ‡æ¢æ–¹å¼","link":"#_2-3-ä¸‰ç§æ ¹æ–‡ä»¶ç³»ç»Ÿåˆ‡æ¢æ–¹å¼","children":[]}]},{"level":2,"title":"3. æŒ‚è½½ç±»å‹å’Œå¤„ç†æœºåˆ¶","slug":"_3-æŒ‚è½½ç±»å‹å’Œå¤„ç†æœºåˆ¶","link":"#_3-æŒ‚è½½ç±»å‹å’Œå¤„ç†æœºåˆ¶","children":[{"level":3,"title":"3.1 æŒ‚è½½åˆ†å‘å™¨ - mountToRootfs","slug":"_3-1-æŒ‚è½½åˆ†å‘å™¨-mounttorootfs","link":"#_3-1-æŒ‚è½½åˆ†å‘å™¨-mounttorootfs","children":[]},{"level":3,"title":"3.2 bind æŒ‚è½½çš„å¤æ‚å¤„ç†","slug":"_3-2-bind-æŒ‚è½½çš„å¤æ‚å¤„ç†","link":"#_3-2-bind-æŒ‚è½½çš„å¤æ‚å¤„ç†","children":[]},{"level":3,"title":"3.3 æ–°ç‰ˆæŒ‚è½½APIæ”¯æŒ","slug":"_3-3-æ–°ç‰ˆæŒ‚è½½apiæ”¯æŒ","link":"#_3-3-æ–°ç‰ˆæŒ‚è½½apiæ”¯æŒ","children":[]}]},{"level":2,"title":"4. ç‰¹æ®Šæ–‡ä»¶ç³»ç»Ÿå¤„ç†","slug":"_4-ç‰¹æ®Šæ–‡ä»¶ç³»ç»Ÿå¤„ç†","link":"#_4-ç‰¹æ®Šæ–‡ä»¶ç³»ç»Ÿå¤„ç†","children":[{"level":3,"title":"4.1 /proc æ–‡ä»¶ç³»ç»Ÿå®‰å…¨æ£€æŸ¥","slug":"_4-1-proc-æ–‡ä»¶ç³»ç»Ÿå®‰å…¨æ£€æŸ¥","link":"#_4-1-proc-æ–‡ä»¶ç³»ç»Ÿå®‰å…¨æ£€æŸ¥","children":[]},{"level":3,"title":"4.2 cgroup æ–‡ä»¶ç³»ç»Ÿå¤„ç†","slug":"_4-2-cgroup-æ–‡ä»¶ç³»ç»Ÿå¤„ç†","link":"#_4-2-cgroup-æ–‡ä»¶ç³»ç»Ÿå¤„ç†","children":[]},{"level":3,"title":"4.3 /dev æ–‡ä»¶ç³»ç»Ÿå’Œè®¾å¤‡èŠ‚ç‚¹","slug":"_4-3-dev-æ–‡ä»¶ç³»ç»Ÿå’Œè®¾å¤‡èŠ‚ç‚¹","link":"#_4-3-dev-æ–‡ä»¶ç³»ç»Ÿå’Œè®¾å¤‡èŠ‚ç‚¹","children":[]}]},{"level":2,"title":"5. æŒ‚è½½é…ç½®å’Œé€‰é¡¹è§£æ","slug":"_5-æŒ‚è½½é…ç½®å’Œé€‰é¡¹è§£æ","link":"#_5-æŒ‚è½½é…ç½®å’Œé€‰é¡¹è§£æ","children":[{"level":3,"title":"5.1 Mount ç»“æ„å®šä¹‰","slug":"_5-1-mount-ç»“æ„å®šä¹‰","link":"#_5-1-mount-ç»“æ„å®šä¹‰","children":[]},{"level":3,"title":"5.2 æŒ‚è½½é€‰é¡¹è§£ææœºåˆ¶","slug":"_5-2-æŒ‚è½½é€‰é¡¹è§£ææœºåˆ¶","link":"#_5-2-æŒ‚è½½é€‰é¡¹è§£ææœºåˆ¶","children":[]},{"level":3,"title":"5.3 é€‰é¡¹è§£æç®—æ³•","slug":"_5-3-é€‰é¡¹è§£æç®—æ³•","link":"#_5-3-é€‰é¡¹è§£æç®—æ³•","children":[]}]},{"level":2,"title":"6. å®‰å…¨æœºåˆ¶å’Œé”™è¯¯å¤„ç†","slug":"_6-å®‰å…¨æœºåˆ¶å’Œé”™è¯¯å¤„ç†","link":"#_6-å®‰å…¨æœºåˆ¶å’Œé”™è¯¯å¤„ç†","children":[{"level":3,"title":"6.1 è·¯å¾„å®‰å…¨å¤„ç†","slug":"_6-1-è·¯å¾„å®‰å…¨å¤„ç†","link":"#_6-1-è·¯å¾„å®‰å…¨å¤„ç†","children":[]},{"level":3,"title":"6.2 é”™è¯¯å¤„ç†å’Œè¯Šæ–­","slug":"_6-2-é”™è¯¯å¤„ç†å’Œè¯Šæ–­","link":"#_6-2-é”™è¯¯å¤„ç†å’Œè¯Šæ–­","children":[]},{"level":3,"title":"6.3 åªè¯»æ–‡ä»¶ç³»ç»ŸåŠ å›º","slug":"_6-3-åªè¯»æ–‡ä»¶ç³»ç»ŸåŠ å›º","link":"#_6-3-åªè¯»æ–‡ä»¶ç³»ç»ŸåŠ å›º","children":[]}]},{"level":2,"title":"7. å®è·µç»ƒä¹ ","slug":"_7-å®è·µç»ƒä¹ ","link":"#_7-å®è·µç»ƒä¹ ","children":[{"level":3,"title":"7.1 åŸºç¡€æŒ‚è½½å®éªŒ","slug":"_7-1-åŸºç¡€æŒ‚è½½å®éªŒ","link":"#_7-1-åŸºç¡€æŒ‚è½½å®éªŒ","children":[]},{"level":3,"title":"7.2 å®¹å™¨æ–‡ä»¶ç³»ç»Ÿæ„å»º","slug":"_7-2-å®¹å™¨æ–‡ä»¶ç³»ç»Ÿæ„å»º","link":"#_7-2-å®¹å™¨æ–‡ä»¶ç³»ç»Ÿæ„å»º","children":[]},{"level":3,"title":"7.3 æŒ‚è½½é€‰é¡¹è§£ææµ‹è¯•","slug":"_7-3-æŒ‚è½½é€‰é¡¹è§£ææµ‹è¯•","link":"#_7-3-æŒ‚è½½é€‰é¡¹è§£ææµ‹è¯•","children":[]},{"level":3,"title":"7.4 æ–‡ä»¶ç³»ç»Ÿå®‰å…¨æµ‹è¯•","slug":"_7-4-æ–‡ä»¶ç³»ç»Ÿå®‰å…¨æµ‹è¯•","link":"#_7-4-æ–‡ä»¶ç³»ç»Ÿå®‰å…¨æµ‹è¯•","children":[]}]},{"level":2,"title":"8. æ•…éšœæ’é™¤å’Œè°ƒè¯•","slug":"_8-æ•…éšœæ’é™¤å’Œè°ƒè¯•","link":"#_8-æ•…éšœæ’é™¤å’Œè°ƒè¯•","children":[{"level":3,"title":"8.1 å¸¸è§æŒ‚è½½é—®é¢˜è¯Šæ–­","slug":"_8-1-å¸¸è§æŒ‚è½½é—®é¢˜è¯Šæ–­","link":"#_8-1-å¸¸è§æŒ‚è½½é—®é¢˜è¯Šæ–­","children":[]},{"level":3,"title":"8.2 è°ƒè¯•å·¥å…·å’Œæ–¹æ³•","slug":"_8-2-è°ƒè¯•å·¥å…·å’Œæ–¹æ³•","link":"#_8-2-è°ƒè¯•å·¥å…·å’Œæ–¹æ³•","children":[]},{"level":3,"title":"8.3 æ€§èƒ½åˆ†æ","slug":"_8-3-æ€§èƒ½åˆ†æ","link":"#_8-3-æ€§èƒ½åˆ†æ","children":[]}]},{"level":2,"title":"9. æ€è€ƒé¢˜","slug":"_9-æ€è€ƒé¢˜","link":"#_9-æ€è€ƒé¢˜","children":[{"level":3,"title":"9.1 æ¶æ„è®¾è®¡æ€è€ƒ","slug":"_9-1-æ¶æ„è®¾è®¡æ€è€ƒ","link":"#_9-1-æ¶æ„è®¾è®¡æ€è€ƒ","children":[]},{"level":3,"title":"9.2 å®‰å…¨æ€§æ€è€ƒ","slug":"_9-2-å®‰å…¨æ€§æ€è€ƒ","link":"#_9-2-å®‰å…¨æ€§æ€è€ƒ","children":[]},{"level":3,"title":"9.3 æ€§èƒ½ä¼˜åŒ–æ€è€ƒ","slug":"_9-3-æ€§èƒ½ä¼˜åŒ–æ€è€ƒ","link":"#_9-3-æ€§èƒ½ä¼˜åŒ–æ€è€ƒ","children":[]}]},{"level":2,"title":"10. æ‰©å±•é˜…è¯»","slug":"_10-æ‰©å±•é˜…è¯»","link":"#_10-æ‰©å±•é˜…è¯»","children":[{"level":3,"title":"10.1 Linux å†…æ ¸æ–‡æ¡£","slug":"_10-1-linux-å†…æ ¸æ–‡æ¡£","link":"#_10-1-linux-å†…æ ¸æ–‡æ¡£","children":[]},{"level":3,"title":"10.2 æ–‡ä»¶ç³»ç»ŸæŠ€æœ¯","slug":"_10-2-æ–‡ä»¶ç³»ç»ŸæŠ€æœ¯","link":"#_10-2-æ–‡ä»¶ç³»ç»ŸæŠ€æœ¯","children":[]},{"level":3,"title":"10.3 å®¹å™¨æŠ€æœ¯æ·±å…¥","slug":"_10-3-å®¹å™¨æŠ€æœ¯æ·±å…¥","link":"#_10-3-å®¹å™¨æŠ€æœ¯æ·±å…¥","children":[]}]},{"level":2,"title":"ğŸ¯ æ¨¡å—æ€»ç»“","slug":"ğŸ¯-æ¨¡å—æ€»ç»“","link":"#ğŸ¯-æ¨¡å—æ€»ç»“","children":[]}],"git":{"createdTime":1755014556000,"updatedTime":1755014556000,"contributors":[{"name":"hushengnian","email":"hushengnian@example.com","commits":1}]},"filePathRelative":"blogs/cloud-base/runc-deep-dive/05-æ–‡ä»¶ç³»ç»Ÿä¸æŒ‚è½½ç®¡ç†.md"}');export{E as comp,T as data};

import{_ as i,c as u,b as s,a as c,e as a,d as p,w as l,r as o,o as r}from"./app-6X7aTgdN.js";const k={},d={href:"https://www.kernel.org/doc/Documentation/admin-guide/cgroup-v2.rst",target:"_blank",rel:"noopener noreferrer"},v={href:"https://www.kernel.org/doc/Documentation/cgroup-v1/",target:"_blank",rel:"noopener noreferrer"},m={href:"https://www.kernel.org/doc/Documentation/scheduler/sched-bwc.txt",target:"_blank",rel:"noopener noreferrer"},b={href:"https://www.kernel.org/doc/Documentation/cgroup-v1/memory.txt",target:"_blank",rel:"noopener noreferrer"},g={href:"https://www.slideshare.net/jpetazzo/cgroups-namespaces-and-beyond-what-are-containers-made-from-dockercon-europe-2015",target:"_blank",rel:"noopener noreferrer"},h={href:"https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/managing_monitoring_and_updating_the_kernel/using-control-groups_managing-monitoring-and-updating-the-kernel",target:"_blank",rel:"noopener noreferrer"},f={href:"https://systemd.io/CGROUP_DELEGATION/",target:"_blank",rel:"noopener noreferrer"},y={href:"https://github.com/google/cadvisor",target:"_blank",rel:"noopener noreferrer"},w={href:"https://www.freedesktop.org/software/systemd/man/systemd-cgtop.html",target:"_blank",rel:"noopener noreferrer"},q={href:"https://github.com/cloudera/cgroupspy",target:"_blank",rel:"noopener noreferrer"};function _(C,n){const t=o("RouteLink"),e=o("ExternalLinkIcon");return r(),u("div",null,[n[25]||(n[25]=s("h1",{id:"cgroups-èµ„æºç®¡ç†",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#cgroups-èµ„æºç®¡ç†"},[s("span",null,"Cgroups èµ„æºç®¡ç†")])],-1)),s("blockquote",null,[s("p",null,[n[2]||(n[2]=s("strong",null,"ç³»åˆ—å¯¼èˆªï¼š",-1)),n[3]||(n[3]=a()),p(t,{to:"/blogs/cloud-base/runc-deep-dive/"},{default:l(()=>n[0]||(n[0]=[a("runc å®¹å™¨è¿è¡Œæ—¶æ·±åº¦è§£æç³»åˆ—")])),_:1,__:[0]}),n[4]||(n[4]=a(" â†’ ç¬¬å››ç¯‡ï¼šCgroups èµ„æºç®¡ç†")),n[5]||(n[5]=s("br",null,null,-1)),n[6]||(n[6]=s("strong",null,"ä¸Šä¸€ç¯‡ï¼š",-1)),n[7]||(n[7]=a()),p(t,{to:"/blogs/cloud-base/runc-deep-dive/03-Namespace%E9%9A%94%E7%A6%BB%E5%AE%9E%E7%8E%B0.html"},{default:l(()=>n[1]||(n[1]=[a("Namespaceéš”ç¦»å®ç°")])),_:1,__:[1]}),n[8]||(n[8]=s("br",null,null,-1)),n[9]||(n[9]=s("strong",null,"æœ€åæ›´æ–°ï¼š",-1)),n[10]||(n[10]=a(" 2024"))])]),n[26]||(n[26]=c(`<h2 id="æ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#æ¦‚è¿°"><span>æ¦‚è¿°</span></a></h2><p>æœ¬æ–‡æ·±å…¥åˆ†æ runc å¦‚ä½•åˆ©ç”¨ Linux Cgroups å®ç°å®¹å™¨èµ„æºç®¡ç†å’Œé™åˆ¶ã€‚Cgroups æ˜¯å®¹å™¨èµ„æºéš”ç¦»çš„æ ¸å¿ƒæœºåˆ¶ï¼Œèƒ½å¤Ÿç²¾ç¡®æ§åˆ¶å®¹å™¨å¯¹ CPUã€å†…å­˜ã€I/O ç­‰èµ„æºçš„ä½¿ç”¨ã€‚</p><h2 id="ğŸ¯-å­¦ä¹ ç›®æ ‡" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-å­¦ä¹ ç›®æ ‡"><span>ğŸ¯ å­¦ä¹ ç›®æ ‡</span></a></h2><p>å®Œæˆæœ¬æ¨¡å—åï¼Œä½ å°†èƒ½å¤Ÿï¼š</p><ul><li>æ·±å…¥ç†è§£ Linux Cgroups çš„æ ¸å¿ƒæ¦‚å¿µå’Œå±‚æ¬¡ç»“æ„</li><li>æŒæ¡ cgroups v1 å’Œ v2 çš„æ¶æ„å·®å¼‚å’Œå®ç°åŸç†</li><li>ç†è§£ CPUã€å†…å­˜ã€IOã€è®¾å¤‡ç­‰èµ„æºæ§åˆ¶æœºåˆ¶</li><li>æŒæ¡ runc ä¸­èµ„æºé™åˆ¶çš„é…ç½®å’Œåº”ç”¨æµç¨‹</li><li>å…·å¤‡èµ„æºç›‘æ§ã€ç»Ÿè®¡å’Œæ€§èƒ½è°ƒä¼˜çš„å®è·µèƒ½åŠ›</li></ul><h2 id="_1-cgroups-åŸºç¡€æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#_1-cgroups-åŸºç¡€æ¦‚å¿µ"><span>1. Cgroups åŸºç¡€æ¦‚å¿µ</span></a></h2><h3 id="_1-1-ä»€ä¹ˆæ˜¯-cgroups" tabindex="-1"><a class="header-anchor" href="#_1-1-ä»€ä¹ˆæ˜¯-cgroups"><span>1.1 ä»€ä¹ˆæ˜¯ Cgroupsï¼Ÿ</span></a></h3><p><strong>Cgroups (Control Groups)</strong> æ˜¯ Linux å†…æ ¸æä¾›çš„èµ„æºç®¡ç†å’Œéš”ç¦»æœºåˆ¶ï¼Œå…è®¸å¯¹è¿›ç¨‹ç»„è¿›è¡Œèµ„æºé™åˆ¶ã€ä¼˜å…ˆçº§åˆ†é…å’Œèµ„æºä½¿ç”¨ç»Ÿè®¡ã€‚</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚                    ç‰©ç†æœºå™¨                     â”‚</span>
<span class="line">â”‚  CPU: 8æ ¸   Memory: 16GB   Disk: 1TB          â”‚</span>
<span class="line">â””â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line"> â”‚                    â”‚</span>
<span class="line"> â–¼                    â–¼</span>
<span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚   å®¹å™¨ A        â”‚  â”‚        å®¹å™¨ B               â”‚</span>
<span class="line">â”‚ CPU: 2æ ¸ (25%)  â”‚  â”‚    CPU: 4æ ¸ (50%)          â”‚</span>
<span class="line">â”‚ Memory: 4GB     â”‚  â”‚    Memory: 8GB             â”‚</span>
<span class="line">â”‚ IO: 100MB/s     â”‚  â”‚    IO: 200MB/s             â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line">       â–²                        â–²</span>
<span class="line">   cgroup-a                 cgroup-b</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ ¸å¿ƒåŠŸèƒ½</strong>ï¼š</p><ul><li>ğŸ¯ <strong>èµ„æºé™åˆ¶</strong>: é™åˆ¶è¿›ç¨‹ç»„ä½¿ç”¨çš„èµ„æºä¸Šé™</li><li>âš–ï¸ <strong>ä¼˜å…ˆçº§åˆ†é…</strong>: åˆ†é…ä¸åŒçš„èµ„æºæƒé‡</li><li>ğŸ“Š <strong>èµ„æºç»Ÿè®¡</strong>: ç›‘æ§å’Œç»Ÿè®¡èµ„æºä½¿ç”¨æƒ…å†µ</li><li>ğŸ”§ <strong>èµ„æºæ§åˆ¶</strong>: åŠ¨æ€è°ƒæ•´èµ„æºé…ç½®</li></ul><h3 id="_1-2-cgroups-å±‚æ¬¡ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_1-2-cgroups-å±‚æ¬¡ç»“æ„"><span>1.2 Cgroups å±‚æ¬¡ç»“æ„</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">/sys/fs/cgroup/         â† cgroup æ–‡ä»¶ç³»ç»Ÿæ ¹ç›®å½•</span>
<span class="line">â”œâ”€â”€ system.slice/       â† systemd åˆ›å»ºçš„ç³»ç»ŸæœåŠ¡</span>
<span class="line">â”‚   â”œâ”€â”€ cgroup.procs    â† è¿›ç¨‹åˆ—è¡¨</span>
<span class="line">â”‚   â”œâ”€â”€ cpu.shares      â† CPU æƒé‡</span>
<span class="line">â”‚   â””â”€â”€ memory.limit_in_bytes â† å†…å­˜é™åˆ¶</span>
<span class="line">â”œâ”€â”€ user.slice/         â† ç”¨æˆ·ä¼šè¯</span>
<span class="line">â””â”€â”€ machine.slice/      â† è™šæ‹Ÿæœºå’Œå®¹å™¨</span>
<span class="line">    â””â”€â”€ docker-abc123.scope/</span>
<span class="line">        â”œâ”€â”€ cgroup.procs</span>
<span class="line">        â”œâ”€â”€ cpu.cfs_quota_us</span>
<span class="line">        â”œâ”€â”€ cpu.cfs_period_us</span>
<span class="line">        â”œâ”€â”€ memory.limit_in_bytes</span>
<span class="line">        â”œâ”€â”€ memory.usage_in_bytes</span>
<span class="line">        â””â”€â”€ blkio.throttle.read_bps_device</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å±‚æ¬¡ç»“æ„ç‰¹ç‚¹</strong>ï¼š</p><ul><li>ğŸŒ³ <strong>æ ‘å½¢ç»“æ„</strong>: å­ cgroup ç»§æ‰¿çˆ¶ cgroup çš„å±æ€§</li><li>ğŸ‘¥ <strong>è¿›ç¨‹å½’å±</strong>: æ¯ä¸ªè¿›ç¨‹å±äºä¸”ä»…å±äºä¸€ä¸ª cgroup</li><li>ğŸ“‹ <strong>æ§åˆ¶å™¨</strong>: æ¯ä¸ªæ§åˆ¶å™¨ç‹¬ç«‹ç®¡ç†ç‰¹å®šç±»å‹èµ„æº</li></ul><h2 id="_2-cgroups-v1-vs-v2-æ¶æ„å·®å¼‚" tabindex="-1"><a class="header-anchor" href="#_2-cgroups-v1-vs-v2-æ¶æ„å·®å¼‚"><span>2. Cgroups v1 vs v2 æ¶æ„å·®å¼‚</span></a></h2><h3 id="_2-1-æ¶æ„å¯¹æ¯”å›¾" tabindex="-1"><a class="header-anchor" href="#_2-1-æ¶æ„å¯¹æ¯”å›¾"><span>2.1 æ¶æ„å¯¹æ¯”å›¾</span></a></h3><h4 id="cgroups-v1-å¤šå±‚æ¬¡æ¶æ„" tabindex="-1"><a class="header-anchor" href="#cgroups-v1-å¤šå±‚æ¬¡æ¶æ„"><span>Cgroups v1 (å¤šå±‚æ¬¡æ¶æ„)</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">/sys/fs/cgroup/</span>
<span class="line">â”œâ”€â”€ cpu/              â† CPU æ§åˆ¶å™¨ç‹¬ç«‹å±‚æ¬¡</span>
<span class="line">â”‚   â”œâ”€â”€ system/</span>
<span class="line">â”‚   â””â”€â”€ docker/</span>
<span class="line">â”‚       â””â”€â”€ container1/</span>
<span class="line">â”œâ”€â”€ memory/           â† å†…å­˜æ§åˆ¶å™¨ç‹¬ç«‹å±‚æ¬¡  </span>
<span class="line">â”‚   â”œâ”€â”€ system/</span>
<span class="line">â”‚   â””â”€â”€ docker/</span>
<span class="line">â”‚       â””â”€â”€ container1/</span>
<span class="line">â”œâ”€â”€ blkio/            â† IO æ§åˆ¶å™¨ç‹¬ç«‹å±‚æ¬¡</span>
<span class="line">â”‚   â”œâ”€â”€ system/</span>
<span class="line">â”‚   â””â”€â”€ docker/</span>
<span class="line">â”‚       â””â”€â”€ container1/</span>
<span class="line">â””â”€â”€ devices/          â† è®¾å¤‡æ§åˆ¶å™¨ç‹¬ç«‹å±‚æ¬¡</span>
<span class="line">    â”œâ”€â”€ system/</span>
<span class="line">    â””â”€â”€ docker/</span>
<span class="line">        â””â”€â”€ container1/</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="cgroups-v2-ç»Ÿä¸€å±‚æ¬¡æ¶æ„" tabindex="-1"><a class="header-anchor" href="#cgroups-v2-ç»Ÿä¸€å±‚æ¬¡æ¶æ„"><span>Cgroups v2 (ç»Ÿä¸€å±‚æ¬¡æ¶æ„)</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">/sys/fs/cgroup/              â† ç»Ÿä¸€æ–‡ä»¶ç³»ç»Ÿ</span>
<span class="line">â”œâ”€â”€ cgroup.controllers       â† å¯ç”¨æ§åˆ¶å™¨åˆ—è¡¨</span>
<span class="line">â”œâ”€â”€ cgroup.subtree_control   â† å¯ç”¨çš„å­æ§åˆ¶å™¨</span>
<span class="line">â”œâ”€â”€ system.slice/</span>
<span class="line">â”‚   â”œâ”€â”€ cpu.weight          â† æ‰€æœ‰æ§åˆ¶å™¨æ–‡ä»¶</span>
<span class="line">â”‚   â”œâ”€â”€ memory.max          â† éƒ½åœ¨åŒä¸€ç›®å½•</span>
<span class="line">â”‚   â”œâ”€â”€ io.max</span>
<span class="line">â”‚   â””â”€â”€ cgroup.procs</span>
<span class="line">â””â”€â”€ machine.slice/</span>
<span class="line">    â””â”€â”€ docker-abc123.scope/</span>
<span class="line">        â”œâ”€â”€ cpu.weight</span>
<span class="line">        â”œâ”€â”€ memory.max</span>
<span class="line">        â”œâ”€â”€ io.max</span>
<span class="line">        â””â”€â”€ cgroup.procs</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-æ ¸å¿ƒå·®å¼‚å¯¹æ¯”" tabindex="-1"><a class="header-anchor" href="#_2-2-æ ¸å¿ƒå·®å¼‚å¯¹æ¯”"><span>2.2 æ ¸å¿ƒå·®å¼‚å¯¹æ¯”</span></a></h3><table><thead><tr><th>ç‰¹æ€§</th><th>Cgroups v1</th><th>Cgroups v2</th></tr></thead><tbody><tr><td><strong>å±‚æ¬¡ç»“æ„</strong></td><td>å¤šä¸ªç‹¬ç«‹å±‚æ¬¡</td><td>ç»Ÿä¸€å±‚æ¬¡ç»“æ„</td></tr><tr><td><strong>æ§åˆ¶å™¨ç®¡ç†</strong></td><td>æ¯ä¸ªæ§åˆ¶å™¨ç‹¬ç«‹æŒ‚è½½</td><td>æ‰€æœ‰æ§åˆ¶å™¨ç»Ÿä¸€ç®¡ç†</td></tr><tr><td><strong>CPUæƒé‡</strong></td><td><code>cpu.shares</code> (2-262144)</td><td><code>cpu.weight</code> (1-10000)</td></tr><tr><td><strong>å†…å­˜äº¤æ¢</strong></td><td><code>memory.memsw.limit_in_bytes</code></td><td><code>memory.swap.max</code></td></tr><tr><td><strong>IOæ§åˆ¶</strong></td><td><code>blkio.*</code> æ¥å£</td><td><code>io.*</code> æ¥å£</td></tr><tr><td><strong>è®¾å¤‡æ§åˆ¶</strong></td><td>ç™½åå•æœºåˆ¶</td><td>eBPF ç¨‹åº</td></tr><tr><td><strong>å†…å­˜å›æ”¶</strong></td><td>å¤æ‚çš„é¡µé¢å›æ”¶</td><td>ç»Ÿä¸€çš„å†…å­˜å›æ”¶ç­–ç•¥</td></tr><tr><td><strong>PSIæ”¯æŒ</strong></td><td>ä¸æ”¯æŒ</td><td>å†…ç½®å‹åŠ›å¤±é€Ÿä¿¡æ¯</td></tr></tbody></table><h3 id="_2-3-runc-çš„å®ç°é€‚é…" tabindex="-1"><a class="header-anchor" href="#_2-3-runc-çš„å®ç°é€‚é…"><span>2.3 runc çš„å®ç°é€‚é…</span></a></h3><p>runc é€šè¿‡æŠ½è±¡æ¥å£åŒæ—¶æ”¯æŒä¸¤ä¸ªç‰ˆæœ¬ï¼š</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// ç»Ÿä¸€çš„ Manager æ¥å£</span></span>
<span class="line"><span class="token keyword">type</span> Manager <span class="token keyword">interface</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">Apply</span><span class="token punctuation">(</span>pid <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span>           <span class="token comment">// å°†è¿›ç¨‹åŠ å…¥ cgroup</span></span>
<span class="line">    <span class="token function">GetPids</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>       <span class="token comment">// è·å– cgroup ä¸­çš„è¿›ç¨‹åˆ—è¡¨</span></span>
<span class="line">    <span class="token function">GetAllPids</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>    <span class="token comment">// è·å–åŒ…æ‹¬å­ cgroup çš„æ‰€æœ‰è¿›ç¨‹</span></span>
<span class="line">    <span class="token function">GetStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Stats<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>     <span class="token comment">// è·å–èµ„æºä½¿ç”¨ç»Ÿè®¡</span></span>
<span class="line">    <span class="token function">Freeze</span><span class="token punctuation">(</span>state FreezerState<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token comment">// å†»ç»“/è§£å†»è¿›ç¨‹</span></span>
<span class="line">    <span class="token function">Destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>               <span class="token comment">// é”€æ¯ cgroup</span></span>
<span class="line">    <span class="token function">Set</span><span class="token punctuation">(</span>r <span class="token operator">*</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span>       <span class="token comment">// è®¾ç½®èµ„æºé™åˆ¶</span></span>
<span class="line">    <span class="token function">GetPaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>  <span class="token comment">// è·å– cgroup è·¯å¾„</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç‰ˆæœ¬æ£€æµ‹å’Œç®¡ç†å™¨åˆ›å»º</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewManager</span><span class="token punctuation">(</span>config <span class="token operator">*</span>configs<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token punctuation">(</span>Manager<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> cgroups<span class="token punctuation">.</span><span class="token function">IsCgroup2UnifiedMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ä½¿ç”¨ v2 ç®¡ç†å™¨</span></span>
<span class="line">        <span class="token keyword">return</span> fs2<span class="token punctuation">.</span><span class="token function">NewManager</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> path<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ä½¿ç”¨ v1 ç®¡ç†å™¨  </span></span>
<span class="line">        <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">NewManager</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> paths<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-æ ¸å¿ƒèµ„æºæ§åˆ¶æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#_3-æ ¸å¿ƒèµ„æºæ§åˆ¶æœºåˆ¶"><span>3. æ ¸å¿ƒèµ„æºæ§åˆ¶æœºåˆ¶</span></a></h2><h3 id="_3-1-cpu-èµ„æºæ§åˆ¶" tabindex="-1"><a class="header-anchor" href="#_3-1-cpu-èµ„æºæ§åˆ¶"><span>3.1 CPU èµ„æºæ§åˆ¶</span></a></h3><h4 id="a-cpu-æƒé‡æ§åˆ¶-ç›¸å¯¹æƒé‡" tabindex="-1"><a class="header-anchor" href="#a-cpu-æƒé‡æ§åˆ¶-ç›¸å¯¹æƒé‡"><span>A. CPU æƒé‡æ§åˆ¶ (ç›¸å¯¹æƒé‡)</span></a></h4><p><strong>Cgroups v1 å®ç°</strong>ï¼š</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// CPU æƒé‡è®¾ç½® (cpu.shares)</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>CpuGroup<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> r<span class="token punctuation">.</span>CpuShares <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// èŒƒå›´: 2-262144ï¼Œé»˜è®¤: 1024</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;cpu.shares&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">            strconv<span class="token punctuation">.</span><span class="token function">FormatUint</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>CpuShares<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set cpu.shares: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Cgroups v2 å®ç°</strong>ï¼š</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// CPU æƒé‡è®¾ç½® (cpu.weight)  </span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setCPU</span><span class="token punctuation">(</span>dirPath <span class="token builtin">string</span><span class="token punctuation">,</span> r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> r<span class="token punctuation">.</span>CpuWeight <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// èŒƒå›´: 1-10000ï¼Œé»˜è®¤: 100</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> <span class="token string">&quot;cpu.weight&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">            strconv<span class="token punctuation">.</span><span class="token function">FormatUint</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>CpuWeight<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to set cpu.weight: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// v1 shares åˆ° v2 weight çš„è½¬æ¢</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">convertSharesToWeight</span><span class="token punctuation">(</span>shares <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token builtin">uint64</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> shares <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// weight = ((shares - 2) * 9999) / 262142 + 1</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>shares <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">9999</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">262142</span> <span class="token operator">+</span> <span class="token number">1</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æƒé‡è®¡ç®—ç¤ºä¾‹</strong>ï¼š</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">åœºæ™¯: 3ä¸ªå®¹å™¨ç«äº‰ CPU</span>
<span class="line">å®¹å™¨A: cpu.shares = 1024 (é»˜è®¤)</span>
<span class="line">å®¹å™¨B: cpu.shares = 512  (ä¸€åŠæƒé‡)  </span>
<span class="line">å®¹å™¨C: cpu.shares = 2048 (ä¸¤å€æƒé‡)</span>
<span class="line"></span>
<span class="line">æ€»æƒé‡ = 1024 + 512 + 2048 = 3584</span>
<span class="line"></span>
<span class="line">CPU åˆ†é…æ¯”ä¾‹:</span>
<span class="line">å®¹å™¨A: 1024/3584 = 28.6%</span>
<span class="line">å®¹å™¨B: 512/3584  = 14.3%  </span>
<span class="line">å®¹å™¨C: 2048/3584 = 57.1%</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="b-cpu-é…é¢æ§åˆ¶-ç¡¬é™åˆ¶" tabindex="-1"><a class="header-anchor" href="#b-cpu-é…é¢æ§åˆ¶-ç¡¬é™åˆ¶"><span>B. CPU é…é¢æ§åˆ¶ (ç¡¬é™åˆ¶)</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// CFS è°ƒåº¦å™¨é…é¢è®¾ç½®</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setCPUQuota</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> quota <span class="token builtin">int64</span><span class="token punctuation">,</span> period <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// è®¾ç½®è°ƒåº¦å‘¨æœŸ (é»˜è®¤ 100ms = 100,000Î¼s)</span></span>
<span class="line">    <span class="token keyword">if</span> period <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;cpu.cfs_period_us&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">            strconv<span class="token punctuation">.</span><span class="token function">FormatUint</span><span class="token punctuation">(</span>period<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®¾ç½®é…é¢ (æ¯ä¸ªå‘¨æœŸå†…å¯ä½¿ç”¨çš„ CPU æ—¶é—´)</span></span>
<span class="line">    <span class="token keyword">if</span> quota <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;cpu.cfs_quota_us&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">            strconv<span class="token punctuation">.</span><span class="token function">FormatInt</span><span class="token punctuation">(</span>quota<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>é…é¢è®¡ç®—ç¤ºä¾‹</strong>ï¼š</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># é™åˆ¶å®¹å™¨ä½¿ç”¨ 1.5 ä¸ª CPU æ ¸å¿ƒ</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token number">100000</span> <span class="token operator">&gt;</span> cpu.cfs_period_us    <span class="token comment"># å‘¨æœŸ 100ms</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token number">150000</span> <span class="token operator">&gt;</span> cpu.cfs_quota_us     <span class="token comment"># é…é¢ 150ms</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># é™åˆ¶ä½¿ç”¨ 50% çš„å•æ ¸ CPU</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token number">100000</span> <span class="token operator">&gt;</span> cpu.cfs_period_us    <span class="token comment"># å‘¨æœŸ 100ms  </span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token number">50000</span>  <span class="token operator">&gt;</span> cpu.cfs_quota_us     <span class="token comment"># é…é¢ 50ms</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># é…é¢è®¡ç®—å…¬å¼:</span></span>
<span class="line"><span class="token comment"># CPUæ ¸å¿ƒæ•° = quota / period</span></span>
<span class="line"><span class="token comment"># 1.5 æ ¸ = 150000 / 100000 = 1.5</span></span>
<span class="line"><span class="token comment"># 0.5 æ ¸ = 50000 / 100000 = 0.5</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="c-cpu-çªå‘æ§åˆ¶-burst" tabindex="-1"><a class="header-anchor" href="#c-cpu-çªå‘æ§åˆ¶-burst"><span>C. CPU çªå‘æ§åˆ¶ (Burst)</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// CPU çªå‘é™åˆ¶ (è¾ƒæ–°çš„å†…æ ¸ç‰¹æ€§)</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setCPUBurst</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> burst <span class="token operator">*</span><span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> burst <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// å…è®¸çŸ­æœŸå†…è¶…è¿‡é…é¢ä½¿ç”¨çš„ CPU æ—¶é—´</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;cpu.cfs_burst_us&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">            strconv<span class="token punctuation">.</span><span class="token function">FormatUint</span><span class="token punctuation">(</span><span class="token operator">*</span>burst<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// å¿½ç•¥ä¸æ”¯æŒçš„å†…æ ¸</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token operator">!</span>os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> err</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-å†…å­˜èµ„æºæ§åˆ¶" tabindex="-1"><a class="header-anchor" href="#_3-2-å†…å­˜èµ„æºæ§åˆ¶"><span>3.2 å†…å­˜èµ„æºæ§åˆ¶</span></a></h3><h4 id="a-å†…å­˜é™åˆ¶è®¾ç½®" tabindex="-1"><a class="header-anchor" href="#a-å†…å­˜é™åˆ¶è®¾ç½®"><span>A. å†…å­˜é™åˆ¶è®¾ç½®</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// å†…å­˜é™åˆ¶çš„å¤æ‚è®¾ç½®é€»è¾‘</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setMemoryAndSwap</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// å…³é”®: äº¤æ¢ç©ºé—´é™åˆ¶å¿…é¡» &gt;= å†…å­˜é™åˆ¶</span></span>
<span class="line">    <span class="token keyword">if</span> r<span class="token punctuation">.</span>Memory <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>MemorySwap <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        curLimit<span class="token punctuation">,</span> err <span class="token operator">:=</span> fscommon<span class="token punctuation">.</span><span class="token function">GetCgroupParamUint</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> cgroupMemoryLimit<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// æ ¹æ®å½“å‰å€¼å†³å®šè®¾ç½®é¡ºåº</span></span>
<span class="line">        <span class="token keyword">if</span> r<span class="token punctuation">.</span>MemorySwap <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> curLimit <span class="token operator">&lt;</span> <span class="token function">uint64</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>MemorySwap<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// æƒ…å†µ1: å…ˆè®¾ç½®äº¤æ¢ï¼Œå†è®¾ç½®å†…å­˜</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setSwap</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> r<span class="token punctuation">.</span>MemorySwap<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> err</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">setMemory</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Memory<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æƒ…å†µ2: æ­£å¸¸é¡ºåº - å…ˆå†…å­˜ï¼Œåäº¤æ¢</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">setMemory</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Memory<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">setSwap</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> r<span class="token punctuation">.</span>MemorySwap<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setMemory</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> limit <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> limit <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> cgroupMemoryLimit<span class="token punctuation">,</span> </span>
<span class="line">        strconv<span class="token punctuation">.</span><span class="token function">FormatInt</span><span class="token punctuation">(</span>limit<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// EBUSY è¡¨ç¤ºæ–°é™åˆ¶ä½äºå½“å‰ä½¿ç”¨é‡</span></span>
<span class="line">    <span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>EBUSY<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        usage<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> fscommon<span class="token punctuation">.</span><span class="token function">GetCgroupParamUint</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> cgroupMemoryUsage<span class="token punctuation">)</span></span>
<span class="line">        max<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> fscommon<span class="token punctuation">.</span><span class="token function">GetCgroupParamUint</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> cgroupMemoryMaxUsage<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;cannot set memory limit to %d: current usage %d, peak usage %d&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">            limit<span class="token punctuation">,</span> usage<span class="token punctuation">,</span> max<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> err</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="b-cgroups-v2-å†…å­˜ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#b-cgroups-v2-å†…å­˜ç®¡ç†"><span>B. Cgroups v2 å†…å­˜ç®¡ç†</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// v2 çš„å†…å­˜ç®¡ç†æ›´åŠ ç»Ÿä¸€å’Œç®€åŒ–</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setMemory</span><span class="token punctuation">(</span>dirPath <span class="token builtin">string</span><span class="token punctuation">,</span> r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ£€æŸ¥å½“å‰å†…å­˜ä½¿ç”¨ï¼Œé¿å…è®¾ç½®è¿‡ä½çš„é™åˆ¶</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">CheckMemoryUsage</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// v2 ä¸­äº¤æ¢ç©ºé—´é™åˆ¶ä¸åŒ…å«å†…å­˜</span></span>
<span class="line">    swap<span class="token punctuation">,</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">ConvertMemorySwapToCgroupV2Value</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>MemorySwap<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Memory<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®¾ç½®äº¤æ¢é™åˆ¶</span></span>
<span class="line">    <span class="token keyword">if</span> swapStr <span class="token operator">:=</span> <span class="token function">numToStr</span><span class="token punctuation">(</span>swap<span class="token punctuation">)</span><span class="token punctuation">;</span> swapStr <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> <span class="token string">&quot;memory.swap.max&quot;</span><span class="token punctuation">,</span> swapStr<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// å¦‚æœ swap æœªå¯ç”¨ï¼Œé™é»˜å¿½ç•¥é”™è¯¯</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token operator">!</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> os<span class="token punctuation">.</span>ErrNotExist<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>swapStr <span class="token operator">==</span> <span class="token string">&quot;max&quot;</span> <span class="token operator">||</span> swapStr <span class="token operator">==</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> err</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®¾ç½®å†…å­˜é™åˆ¶</span></span>
<span class="line">    <span class="token keyword">if</span> val <span class="token operator">:=</span> <span class="token function">numToStr</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Memory<span class="token punctuation">)</span><span class="token punctuation">;</span> val <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> <span class="token string">&quot;memory.max&quot;</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å†…å­˜äº¤æ¢å€¼è½¬æ¢ (v1 -&gt; v2)</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">ConvertMemorySwapToCgroupV2Value</span><span class="token punctuation">(</span>memorySwap<span class="token punctuation">,</span> memory <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// v1: memory.memsw.limit_in_bytes åŒ…å«å†…å­˜+äº¤æ¢æ€»é‡</span></span>
<span class="line">    <span class="token comment">// v2: memory.swap.max åªåŒ…å«äº¤æ¢ç©ºé—´</span></span>
<span class="line">    <span class="token keyword">if</span> memorySwap <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>  <span class="token comment">// æ— é™åˆ¶</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> memorySwap <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> memory <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> memorySwap <span class="token operator">-</span> memory<span class="token punctuation">,</span> <span class="token boolean">nil</span>  <span class="token comment">// å‡å»å†…å­˜éƒ¨åˆ†</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> memorySwap<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="c-å†…å­˜å›æ”¶ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#c-å†…å­˜å›æ”¶ç­–ç•¥"><span>C. å†…å­˜å›æ”¶ç­–ç•¥</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// å†…å­˜äº¤æ¢å€¾å‘æ€§è®¾ç½®</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setSwappiness</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> swappiness <span class="token operator">*</span><span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> swappiness <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// èŒƒå›´ 0-100ï¼Œå€¼è¶Šå°è¶Šä¸æ„¿æ„ä½¿ç”¨äº¤æ¢ç©ºé—´</span></span>
<span class="line">        <span class="token comment">// 0: ç¦ç”¨äº¤æ¢ (é™¤éå†…å­˜ä¸è¶³)</span></span>
<span class="line">        <span class="token comment">// 100: ç§¯æä½¿ç”¨äº¤æ¢ç©ºé—´</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;memory.swappiness&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">            strconv<span class="token punctuation">.</span><span class="token function">FormatUint</span><span class="token punctuation">(</span><span class="token operator">*</span>swappiness<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-io-èµ„æºæ§åˆ¶" tabindex="-1"><a class="header-anchor" href="#_3-3-io-èµ„æºæ§åˆ¶"><span>3.3 IO èµ„æºæ§åˆ¶</span></a></h3><h4 id="a-io-æƒé‡æ§åˆ¶" tabindex="-1"><a class="header-anchor" href="#a-io-æƒé‡æ§åˆ¶"><span>A. IO æƒé‡æ§åˆ¶</span></a></h4><p><strong>Cgroups v1 å®ç°</strong>ï¼š</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>BlkioGroup<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ£€æµ‹å¹¶é€‰æ‹©è°ƒåº¦å™¨ (CFQ æˆ– BFQ)</span></span>
<span class="line">    s<span class="token punctuation">.</span><span class="token function">detectWeightFilenames</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®¾ç½®å…¨å±€ IO æƒé‡</span></span>
<span class="line">    <span class="token keyword">if</span> r<span class="token punctuation">.</span>BlkioWeight <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// èŒƒå›´: 10-1000ï¼Œé»˜è®¤: 500</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> s<span class="token punctuation">.</span>weightFilename<span class="token punctuation">,</span> </span>
<span class="line">            strconv<span class="token punctuation">.</span><span class="token function">FormatUint</span><span class="token punctuation">(</span><span class="token function">uint64</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>BlkioWeight<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®¾ç½®è®¾å¤‡çº§ IO æƒé‡</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> wd <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>BlkioWeightDevice <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> wd<span class="token punctuation">.</span>Weight <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// æ ¼å¼: &quot;major:minor weight&quot;</span></span>
<span class="line">            weightStr <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%d:%d %d&quot;</span><span class="token punctuation">,</span> wd<span class="token punctuation">.</span>Major<span class="token punctuation">,</span> wd<span class="token punctuation">.</span>Minor<span class="token punctuation">,</span> wd<span class="token punctuation">.</span>Weight<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> s<span class="token punctuation">.</span>weightDeviceFilename<span class="token punctuation">,</span> </span>
<span class="line">                weightStr<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> err</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">setThrottle</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> r<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Cgroups v2 å®ç°</strong>ï¼š</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">setIo</span><span class="token punctuation">(</span>dirPath <span class="token builtin">string</span><span class="token punctuation">,</span> r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ä¼˜å…ˆå°è¯•ä½¿ç”¨ BFQ è°ƒåº¦å™¨ (æ›´å¥½çš„æ€§èƒ½)</span></span>
<span class="line">    <span class="token keyword">var</span> bfq <span class="token operator">*</span>os<span class="token punctuation">.</span>File</span>
<span class="line">    <span class="token keyword">if</span> r<span class="token punctuation">.</span>BlkioWeight <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>BlkioWeightDevice<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> bfq<span class="token punctuation">,</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> <span class="token string">&quot;io.bfq.weight&quot;</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">defer</span> bfq<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®¾ç½® IO æƒé‡</span></span>
<span class="line">    <span class="token keyword">if</span> r<span class="token punctuation">.</span>BlkioWeight <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> bfq <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// ä½¿ç”¨ BFQ è°ƒåº¦å™¨</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> bfq<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>strconv<span class="token punctuation">.</span><span class="token function">FormatUint</span><span class="token punctuation">(</span><span class="token function">uint64</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>BlkioWeight<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> err</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// è½¬æ¢ä¸º io.weight å€¼ (ä¸åŒçš„èŒƒå›´)</span></span>
<span class="line">            v <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">ConvertBlkIOToIOWeightValue</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>BlkioWeight<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> <span class="token string">&quot;io.weight&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                strconv<span class="token punctuation">.</span><span class="token function">FormatUint</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> err</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// BlkIO æƒé‡åˆ° IO æƒé‡çš„è½¬æ¢</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">ConvertBlkIOToIOWeightValue</span><span class="token punctuation">(</span>blkioWeight <span class="token builtin">uint16</span><span class="token punctuation">)</span> <span class="token builtin">uint64</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> blkioWeight <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// weight = (blkioWeight - 10) * 9999 / 990 + 1</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">uint64</span><span class="token punctuation">(</span>blkioWeight<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">9999</span><span class="token operator">/</span><span class="token number">990</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="b-io-é™æµ-throttling" tabindex="-1"><a class="header-anchor" href="#b-io-é™æµ-throttling"><span>B. IO é™æµ (Throttling)</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// IO å¸¦å®½é™åˆ¶</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setIOThrottle</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// è¯»å–å¸¦å®½é™åˆ¶</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> td <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>BlkioThrottleReadBpsDevice <span class="token punctuation">{</span></span>
<span class="line">        throttleStr <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%d:%d %d&quot;</span><span class="token punctuation">,</span> td<span class="token punctuation">.</span>Major<span class="token punctuation">,</span> td<span class="token punctuation">.</span>Minor<span class="token punctuation">,</span> td<span class="token punctuation">.</span>Rate<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;blkio.throttle.read_bps_device&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">            throttleStr<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å†™å…¥å¸¦å®½é™åˆ¶</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> td <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>BlkioThrottleWriteBpsDevice <span class="token punctuation">{</span></span>
<span class="line">        throttleStr <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%d:%d %d&quot;</span><span class="token punctuation">,</span> td<span class="token punctuation">.</span>Major<span class="token punctuation">,</span> td<span class="token punctuation">.</span>Minor<span class="token punctuation">,</span> td<span class="token punctuation">.</span>Rate<span class="token punctuation">)</span>  </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;blkio.throttle.write_bps_device&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">            throttleStr<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// IOPS é™åˆ¶</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> td <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>BlkioThrottleReadIOPSDevice <span class="token punctuation">{</span></span>
<span class="line">        throttleStr <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%d:%d %d&quot;</span><span class="token punctuation">,</span> td<span class="token punctuation">.</span>Major<span class="token punctuation">,</span> td<span class="token punctuation">.</span>Minor<span class="token punctuation">,</span> td<span class="token punctuation">.</span>Rate<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;blkio.throttle.read_iops_device&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">            throttleStr<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-4-è®¾å¤‡è®¿é—®æ§åˆ¶" tabindex="-1"><a class="header-anchor" href="#_3-4-è®¾å¤‡è®¿é—®æ§åˆ¶"><span>3.4 è®¾å¤‡è®¿é—®æ§åˆ¶</span></a></h3><h4 id="a-cgroups-v1-è®¾å¤‡æ§åˆ¶-ç™½åå•æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#a-cgroups-v1-è®¾å¤‡æ§åˆ¶-ç™½åå•æœºåˆ¶"><span>A. Cgroups v1 è®¾å¤‡æ§åˆ¶ (ç™½åå•æœºåˆ¶)</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// è®¾å¤‡è®¿é—®æ§åˆ¶çš„çŠ¶æ€æœºå®ç°</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setV1</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. åŠ è½½å½“å‰è®¾å¤‡è®¿é—®çŠ¶æ€</span></span>
<span class="line">    current<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">loadEmulator</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. æ„å»ºç›®æ ‡çŠ¶æ€</span></span>
<span class="line">    target<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">buildEmulator</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Devices<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. è®¡ç®—çŠ¶æ€è½¬æ¢è§„åˆ™</span></span>
<span class="line">    transitionRules<span class="token punctuation">,</span> err <span class="token operator">:=</span> current<span class="token punctuation">.</span><span class="token function">Transition</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. åº”ç”¨è½¬æ¢è§„åˆ™</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> rule <span class="token operator">:=</span> <span class="token keyword">range</span> transitionRules <span class="token punctuation">{</span></span>
<span class="line">        file <span class="token operator">:=</span> <span class="token string">&quot;devices.deny&quot;</span></span>
<span class="line">        <span class="token keyword">if</span> rule<span class="token punctuation">.</span>Allow <span class="token punctuation">{</span></span>
<span class="line">            file <span class="token operator">=</span> <span class="token string">&quot;devices.allow&quot;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        ruleStr <span class="token operator">:=</span> rule<span class="token punctuation">.</span><span class="token function">CgroupString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// æ ¼å¼: &quot;c 1:3 rwm&quot;</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> file<span class="token punctuation">,</span> ruleStr<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to write %s to %s: %w&quot;</span><span class="token punctuation">,</span> ruleStr<span class="token punctuation">,</span> file<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 5. éªŒè¯æœ€ç»ˆçŠ¶æ€</span></span>
<span class="line">    currentAfter<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">loadEmulator</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span>target<span class="token punctuation">.</span><span class="token function">IsBlacklist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>reflect<span class="token punctuation">.</span><span class="token function">DeepEqual</span><span class="token punctuation">(</span>currentAfter<span class="token punctuation">,</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;resulting devices cgroup doesn&#39;t precisely match target&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>è®¾å¤‡è§„åˆ™æ ¼å¼</strong>ï¼š</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># è®¾å¤‡è§„åˆ™æ ¼å¼: [a|b|c] [major:minor|*] [r][w][m]</span></span>
<span class="line"><span class="token comment"># a: all devices, b: block devices, c: character devices  </span></span>
<span class="line"><span class="token comment"># major:minor: è®¾å¤‡å·ï¼Œ* è¡¨ç¤ºæ‰€æœ‰</span></span>
<span class="line"><span class="token comment"># r: read, w: write, m: mknod</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># å…è®¸è®¿é—®æ‰€æœ‰è®¾å¤‡ (å±é™©!)</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;a *:* rwm&quot;</span> <span class="token operator">&gt;</span> devices.allow</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å…è®¸è¯»å†™ /dev/null (1:3)</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;c 1:3 rw&quot;</span> <span class="token operator">&gt;</span> devices.allow  </span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç¦æ­¢è®¿é—®æ‰€æœ‰å—è®¾å¤‡</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;b *:* rwm&quot;</span> <span class="token operator">&gt;</span> devices.deny</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å…è®¸åˆ›å»ºå­—ç¬¦è®¾å¤‡èŠ‚ç‚¹ </span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;c 5:0 m&quot;</span> <span class="token operator">&gt;</span> devices.allow  <span class="token comment"># /dev/tty</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="b-cgroups-v2-è®¾å¤‡æ§åˆ¶-ebpf-ç¨‹åº" tabindex="-1"><a class="header-anchor" href="#b-cgroups-v2-è®¾å¤‡æ§åˆ¶-ebpf-ç¨‹åº"><span>B. Cgroups v2 è®¾å¤‡æ§åˆ¶ (eBPF ç¨‹åº)</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// v2 ä½¿ç”¨ eBPF ç¨‹åºè¿›è¡Œè®¾å¤‡è®¿é—®æ§åˆ¶</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setV2</span><span class="token punctuation">(</span>dirPath <span class="token builtin">string</span><span class="token punctuation">,</span> r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. ç”Ÿæˆ eBPF æŒ‡ä»¤å’Œè®¸å¯è¯</span></span>
<span class="line">    insts<span class="token punctuation">,</span> license<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">deviceFilter</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Devices<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. æ‰“å¼€ cgroup ç›®å½•æ–‡ä»¶æè¿°ç¬¦</span></span>
<span class="line">    dirFD<span class="token punctuation">,</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>O_DIRECTORY<span class="token operator">|</span>unix<span class="token punctuation">.</span>O_RDONLY<span class="token punctuation">,</span> <span class="token number">0o600</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;cannot get dir FD for %s&quot;</span><span class="token punctuation">,</span> dirPath<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> unix<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span>dirFD<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. åŠ è½½å’Œé™„åŠ  eBPF ç¨‹åºåˆ° cgroup</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">loadAttachCgroupDeviceFilter</span><span class="token punctuation">(</span>insts<span class="token punctuation">,</span> license<span class="token punctuation">,</span> dirFD<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">canSkipEBPFError</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">// rootless æ¨¡å¼æˆ–çº¯å…è®¸è§„åˆ™å¯ä»¥å¿½ç•¥ eBPF é”™è¯¯</span></span>
<span class="line">        logrus<span class="token punctuation">.</span><span class="token function">WithError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to load eBPF device filter&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ£€æŸ¥æ˜¯å¦å¯ä»¥å¿½ç•¥ eBPF é”™è¯¯</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">canSkipEBPFError</span><span class="token punctuation">(</span>r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// rootless æ¨¡å¼å…è®¸å¿½ç•¥ eBPF é”™è¯¯</span></span>
<span class="line">    <span class="token keyword">if</span> userns<span class="token punctuation">.</span><span class="token function">RunningInUserNS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å¦‚æœæ‰€æœ‰è§„åˆ™éƒ½æ˜¯å…è®¸è§„åˆ™ä¸”åŒ…å« rwm æƒé™</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> dev <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>Devices <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token operator">!</span>dev<span class="token punctuation">.</span>Allow <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isRWM</span><span class="token punctuation">(</span>dev<span class="token punctuation">.</span>Permissions<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-5-è¿›ç¨‹æ•°é™åˆ¶-pids" tabindex="-1"><a class="header-anchor" href="#_3-5-è¿›ç¨‹æ•°é™åˆ¶-pids"><span>3.5 è¿›ç¨‹æ•°é™åˆ¶ (PIDs)</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// é™åˆ¶ cgroup ä¸­çš„è¿›ç¨‹æ•°é‡</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">setPids</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> r<span class="token punctuation">.</span>PidsLimit <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">var</span> limit <span class="token builtin">string</span></span>
<span class="line">        <span class="token keyword">if</span> r<span class="token punctuation">.</span>PidsLimit <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">            limit <span class="token operator">=</span> strconv<span class="token punctuation">.</span><span class="token function">FormatInt</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>PidsLimit<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            limit <span class="token operator">=</span> <span class="token string">&quot;max&quot;</span>  <span class="token comment">// æ— é™åˆ¶</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;pids.max&quot;</span><span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-èµ„æºç»Ÿè®¡å’Œç›‘æ§" tabindex="-1"><a class="header-anchor" href="#_4-èµ„æºç»Ÿè®¡å’Œç›‘æ§"><span>4. èµ„æºç»Ÿè®¡å’Œç›‘æ§</span></a></h2><h3 id="_4-1-ç»Ÿè®¡æ•°æ®ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_4-1-ç»Ÿè®¡æ•°æ®ç»“æ„"><span>4.1 ç»Ÿè®¡æ•°æ®ç»“æ„</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// ç»¼åˆçš„èµ„æºä½¿ç”¨ç»Ÿè®¡</span></span>
<span class="line"><span class="token keyword">type</span> Stats <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    CpuStats     CpuStats                <span class="token string">\`json:&quot;cpu_stats&quot;\`</span></span>
<span class="line">    CPUSetStats  CPUSetStats             <span class="token string">\`json:&quot;cpuset_stats&quot;\`</span></span>
<span class="line">    MemoryStats  MemoryStats             <span class="token string">\`json:&quot;memory_stats&quot;\`</span></span>
<span class="line">    PidsStats    PidsStats               <span class="token string">\`json:&quot;pids_stats&quot;\`</span></span>
<span class="line">    BlkioStats   BlkioStats              <span class="token string">\`json:&quot;blkio_stats&quot;\`</span></span>
<span class="line">    HugetlbStats <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>HugetlbStats <span class="token string">\`json:&quot;hugetlb_stats&quot;\`</span></span>
<span class="line">    RdmaStats    RdmaStats               <span class="token string">\`json:&quot;rdma_stats&quot;\`</span></span>
<span class="line">    MiscStats    <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>MiscStats    <span class="token string">\`json:&quot;misc_stats&quot;\`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// CPU ä½¿ç”¨ç»Ÿè®¡</span></span>
<span class="line"><span class="token keyword">type</span> CpuStats <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    CpuUsage       CpuUsage       <span class="token string">\`json:&quot;cpu_usage&quot;\`</span></span>
<span class="line">    ThrottlingData ThrottlingData <span class="token string">\`json:&quot;throttling_data&quot;\`</span></span>
<span class="line">    PSI            <span class="token operator">*</span>PSIStats      <span class="token string">\`json:&quot;psi,omitempty&quot;\`</span>  <span class="token comment">// å‹åŠ›å¤±é€Ÿä¿¡æ¯</span></span>
<span class="line">    BurstData      BurstData      <span class="token string">\`json:&quot;cpu_burst&quot;\`</span>      <span class="token comment">// çªå‘ä½¿ç”¨æ•°æ®</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å†…å­˜ä½¿ç”¨ç»Ÿè®¡</span></span>
<span class="line"><span class="token keyword">type</span> MemoryStats <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Cache              <span class="token builtin">uint64</span>                <span class="token string">\`json:&quot;cache&quot;\`</span></span>
<span class="line">    Usage              MemoryData            <span class="token string">\`json:&quot;usage&quot;\`</span></span>
<span class="line">    SwapUsage          MemoryData            <span class="token string">\`json:&quot;swap_usage&quot;\`</span></span>
<span class="line">    SwapOnlyUsage      MemoryData            <span class="token string">\`json:&quot;swap_only_usage&quot;\`</span></span>
<span class="line">    KernelUsage        MemoryData            <span class="token string">\`json:&quot;kernel_usage&quot;\`</span></span>
<span class="line">    KernelTCPUsage     MemoryData            <span class="token string">\`json:&quot;kernel_tcp_usage&quot;\`</span></span>
<span class="line">    PageUsageByNUMA    PageUsageByNUMA       <span class="token string">\`json:&quot;page_usage_by_numa&quot;\`</span></span>
<span class="line">    UseHierarchy       <span class="token builtin">bool</span>                  <span class="token string">\`json:&quot;use_hierarchy&quot;\`</span></span>
<span class="line">    Stats              <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">uint64</span>     <span class="token string">\`json:&quot;stats&quot;\`</span>  <span class="token comment">// è¯¦ç»†ç»Ÿè®¡</span></span>
<span class="line">    PSI                <span class="token operator">*</span>PSIStats             <span class="token string">\`json:&quot;psi,omitempty&quot;\`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å‹åŠ›å¤±é€Ÿä¿¡æ¯ (PSI - Pressure Stall Information)</span></span>
<span class="line"><span class="token keyword">type</span> PSIStats <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Some PSIData <span class="token string">\`json:&quot;some&quot;\`</span> <span class="token comment">// æŸäº›ä»»åŠ¡å—é˜»</span></span>
<span class="line">    Full PSIData <span class="token string">\`json:&quot;full&quot;\`</span> <span class="token comment">// æ‰€æœ‰ä»»åŠ¡å—é˜»  </span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> PSIData <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Avg10  <span class="token builtin">float64</span> <span class="token string">\`json:&quot;avg10&quot;\`</span>  <span class="token comment">// 10ç§’å¹³å‡</span></span>
<span class="line">    Avg60  <span class="token builtin">float64</span> <span class="token string">\`json:&quot;avg60&quot;\`</span>  <span class="token comment">// 60ç§’å¹³å‡</span></span>
<span class="line">    Avg300 <span class="token builtin">float64</span> <span class="token string">\`json:&quot;avg300&quot;\`</span> <span class="token comment">// 300ç§’å¹³å‡</span></span>
<span class="line">    Total  <span class="token builtin">uint64</span>  <span class="token string">\`json:&quot;total&quot;\`</span>  <span class="token comment">// æ€»è®¡å¾®ç§’</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-ç»Ÿè®¡æ•°æ®æ”¶é›†å®ç°" tabindex="-1"><a class="header-anchor" href="#_4-2-ç»Ÿè®¡æ•°æ®æ”¶é›†å®ç°"><span>4.2 ç»Ÿè®¡æ•°æ®æ”¶é›†å®ç°</span></a></h3><h4 id="cgroups-v1-ç»Ÿè®¡æ”¶é›†" tabindex="-1"><a class="header-anchor" href="#cgroups-v1-ç»Ÿè®¡æ”¶é›†"><span>Cgroups v1 ç»Ÿè®¡æ”¶é›†</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// v1 éœ€è¦ä»å¤šä¸ªå­ç³»ç»Ÿæ”¶é›†ç»Ÿè®¡</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">GetStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Stats<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    stats <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">NewStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// éå†æ‰€æœ‰å­ç³»ç»Ÿæ”¶é›†ç»Ÿè®¡</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> sys <span class="token operator">:=</span> <span class="token keyword">range</span> subsystems <span class="token punctuation">{</span></span>
<span class="line">        path <span class="token operator">:=</span> m<span class="token punctuation">.</span>paths<span class="token punctuation">[</span>sys<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">if</span> path <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">continue</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> sys<span class="token punctuation">.</span><span class="token function">GetStats</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> stats<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">Cause</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">continue</span>  <span class="token comment">// å­ç³»ç»Ÿä¸å­˜åœ¨ï¼Œè·³è¿‡</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> stats<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// CPU ç»Ÿè®¡æ”¶é›†ç¤ºä¾‹</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>CpuGroup<span class="token punctuation">)</span> <span class="token function">GetStats</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> stats <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Stats<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// CPU ä½¿ç”¨æ—¶é—´ç»Ÿè®¡</span></span>
<span class="line">    <span class="token keyword">if</span> cpuacctUsage<span class="token punctuation">,</span> err <span class="token operator">:=</span> fscommon<span class="token punctuation">.</span><span class="token function">GetCgroupParamUint</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;cpuacct.usage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        stats<span class="token punctuation">.</span>CpuStats<span class="token punctuation">.</span>CpuUsage<span class="token punctuation">.</span>TotalUsage <span class="token operator">=</span> cpuacctUsage</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åˆ†æ ¸å¿ƒ CPU ä½¿ç”¨ç»Ÿè®¡</span></span>
<span class="line">    <span class="token keyword">if</span> percpuUsage<span class="token punctuation">,</span> err <span class="token operator">:=</span> fscommon<span class="token punctuation">.</span><span class="token function">ParseCgroupFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;cpuacct.usage_percpu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">for</span> i<span class="token punctuation">,</span> usage <span class="token operator">:=</span> <span class="token keyword">range</span> percpuUsage <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span>CpuStats<span class="token punctuation">.</span>CpuUsage<span class="token punctuation">.</span>PercpuUsage<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> i <span class="token punctuation">{</span></span>
<span class="line">                stats<span class="token punctuation">.</span>CpuStats<span class="token punctuation">.</span>CpuUsage<span class="token punctuation">.</span>PercpuUsage <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span>CpuStats<span class="token punctuation">.</span>CpuUsage<span class="token punctuation">.</span>PercpuUsage<span class="token punctuation">,</span> usage<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                stats<span class="token punctuation">.</span>CpuStats<span class="token punctuation">.</span>CpuUsage<span class="token punctuation">.</span>PercpuUsage<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> usage</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// é™æµç»Ÿè®¡</span></span>
<span class="line">    <span class="token keyword">if</span> throttledData<span class="token punctuation">,</span> err <span class="token operator">:=</span> fscommon<span class="token punctuation">.</span><span class="token function">ParseCgroupFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;cpu.stat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        stats<span class="token punctuation">.</span>CpuStats<span class="token punctuation">.</span>ThrottlingData<span class="token punctuation">.</span>Periods <span class="token operator">=</span> throttledData<span class="token punctuation">[</span><span class="token string">&quot;nr_periods&quot;</span><span class="token punctuation">]</span></span>
<span class="line">        stats<span class="token punctuation">.</span>CpuStats<span class="token punctuation">.</span>ThrottlingData<span class="token punctuation">.</span>ThrottledPeriods <span class="token operator">=</span> throttledData<span class="token punctuation">[</span><span class="token string">&quot;nr_throttled&quot;</span><span class="token punctuation">]</span>  </span>
<span class="line">        stats<span class="token punctuation">.</span>CpuStats<span class="token punctuation">.</span>ThrottlingData<span class="token punctuation">.</span>ThrottledTime <span class="token operator">=</span> throttledData<span class="token punctuation">[</span><span class="token string">&quot;throttled_time&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="cgroups-v2-ç»Ÿè®¡æ”¶é›†" tabindex="-1"><a class="header-anchor" href="#cgroups-v2-ç»Ÿè®¡æ”¶é›†"><span>Cgroups v2 ç»Ÿè®¡æ”¶é›†</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// v2 ä»ç»Ÿä¸€è·¯å¾„æ”¶é›†æ‰€æœ‰ç»Ÿè®¡</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">GetStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Stats<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> errs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span></span>
<span class="line">    st <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">NewStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ”¶é›†å„ç§èµ„æºç»Ÿè®¡</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">statPids</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>dirPath<span class="token punctuation">,</span> st<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">statMemory</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>dirPath<span class="token punctuation">,</span> st<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">statIo</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>dirPath<span class="token punctuation">,</span> st<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">statCpu</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>dirPath<span class="token punctuation">,</span> st<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ”¶é›† PSI (å‹åŠ›å¤±é€Ÿä¿¡æ¯)</span></span>
<span class="line">    <span class="token keyword">if</span> st<span class="token punctuation">.</span>CpuStats<span class="token punctuation">.</span>PSI<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">statPSI</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>dirPath<span class="token punctuation">,</span> <span class="token string">&quot;cpu.pressure&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> st<span class="token punctuation">.</span>MemoryStats<span class="token punctuation">.</span>PSI<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">statPSI</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>dirPath<span class="token punctuation">,</span> <span class="token string">&quot;memory.pressure&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> st<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// PSI ç»Ÿè®¡æ”¶é›†</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">statPSI</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> file <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>cgroups<span class="token punctuation">.</span>PSIStats<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    data<span class="token punctuation">,</span> err <span class="token operator">:=</span> cgroups<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> file<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    psi <span class="token operator">:=</span> <span class="token operator">&amp;</span>cgroups<span class="token punctuation">.</span>PSIStats<span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è§£ææ ¼å¼: &quot;some avg10=0.00 avg60=0.00 avg300=0.00 total=0&quot;</span></span>
<span class="line">    lines <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> line <span class="token operator">:=</span> <span class="token keyword">range</span> lines <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">&quot;some &quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            psi<span class="token punctuation">.</span>Some <span class="token operator">=</span> <span class="token function">parsePSIData</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">&quot;full &quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            psi<span class="token punctuation">.</span>Full <span class="token operator">=</span> <span class="token function">parsePSIData</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> psi<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-æ€§èƒ½ç›‘æ§æŒ‡æ ‡è§£è¯»" tabindex="-1"><a class="header-anchor" href="#_4-3-æ€§èƒ½ç›‘æ§æŒ‡æ ‡è§£è¯»"><span>4.3 æ€§èƒ½ç›‘æ§æŒ‡æ ‡è§£è¯»</span></a></h3><h4 id="a-cpu-ç›‘æ§æŒ‡æ ‡" tabindex="-1"><a class="header-anchor" href="#a-cpu-ç›‘æ§æŒ‡æ ‡"><span>A. CPU ç›‘æ§æŒ‡æ ‡</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// CPU ä½¿ç”¨ç‡è®¡ç®—</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">calculateCPUPercent</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> curr <span class="token operator">*</span>CpuStats<span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> <span class="token punctuation">(</span></span>
<span class="line">        cpuDelta    <span class="token operator">=</span> curr<span class="token punctuation">.</span>CpuUsage<span class="token punctuation">.</span>TotalUsage <span class="token operator">-</span> prev<span class="token punctuation">.</span>CpuUsage<span class="token punctuation">.</span>TotalUsage</span>
<span class="line">        systemDelta <span class="token operator">=</span> curr<span class="token punctuation">.</span>SystemUsage <span class="token operator">-</span> prev<span class="token punctuation">.</span>SystemUsage</span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> systemDelta <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> cpuDelta <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>cpuDelta<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">float64</span><span class="token punctuation">(</span>systemDelta<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">float64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span>CpuUsage<span class="token punctuation">.</span>PercpuUsage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100.0</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0.0</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// é™æµåˆ†æ</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">analyzeCPUThrottling</span><span class="token punctuation">(</span>stats <span class="token operator">*</span>CpuStats<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> stats<span class="token punctuation">.</span>ThrottlingData<span class="token punctuation">.</span>Periods <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        throttlePercent <span class="token operator">:=</span> <span class="token function">float64</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span>ThrottlingData<span class="token punctuation">.</span>ThrottledPeriods<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">float64</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span>ThrottlingData<span class="token punctuation">.</span>Periods<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;CPU Throttling: %.2f%% of periods throttled\\n&quot;</span><span class="token punctuation">,</span> throttlePercent<span class="token punctuation">)</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Total throttled time: %d ns\\n&quot;</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>ThrottlingData<span class="token punctuation">.</span>ThrottledTime<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="b-å†…å­˜ç›‘æ§æŒ‡æ ‡" tabindex="-1"><a class="header-anchor" href="#b-å†…å­˜ç›‘æ§æŒ‡æ ‡"><span>B. å†…å­˜ç›‘æ§æŒ‡æ ‡</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// å†…å­˜ä½¿ç”¨åˆ†æ</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">analyzeMemoryUsage</span><span class="token punctuation">(</span>stats <span class="token operator">*</span>MemoryStats<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Memory Usage: %d / %d bytes (%.2f%%)\\n&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">        stats<span class="token punctuation">.</span>Usage<span class="token punctuation">.</span>Usage<span class="token punctuation">,</span> stats<span class="token punctuation">.</span>Usage<span class="token punctuation">.</span>Limit<span class="token punctuation">,</span></span>
<span class="line">        <span class="token function">float64</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span>Usage<span class="token punctuation">.</span>Usage<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">float64</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span>Usage<span class="token punctuation">.</span>Limit<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Memory Cache: %d bytes\\n&quot;</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>Cache<span class="token punctuation">)</span></span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Memory RSS: %d bytes\\n&quot;</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>Stats<span class="token punctuation">[</span><span class="token string">&quot;rss&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Memory Swap: %d / %d bytes\\n&quot;</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>SwapUsage<span class="token punctuation">.</span>Usage<span class="token punctuation">,</span> stats<span class="token punctuation">.</span>SwapUsage<span class="token punctuation">.</span>Limit<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å†…å­˜å‹åŠ›åˆ†æ</span></span>
<span class="line">    <span class="token keyword">if</span> stats<span class="token punctuation">.</span>PSI <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Memory Pressure: some=%.2f%%, full=%.2f%%\\n&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            stats<span class="token punctuation">.</span>PSI<span class="token punctuation">.</span>Some<span class="token punctuation">.</span>Avg60<span class="token punctuation">,</span> stats<span class="token punctuation">.</span>PSI<span class="token punctuation">.</span>Full<span class="token punctuation">.</span>Avg60<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-é«˜çº§ç‰¹æ€§å’Œä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_5-é«˜çº§ç‰¹æ€§å’Œä¼˜åŒ–"><span>5. é«˜çº§ç‰¹æ€§å’Œä¼˜åŒ–</span></a></h2><h3 id="_5-1-å±‚æ¬¡ç»“æ„ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#_5-1-å±‚æ¬¡ç»“æ„ç®¡ç†"><span>5.1 å±‚æ¬¡ç»“æ„ç®¡ç†</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// cgroup å±‚æ¬¡ç»“æ„çš„åˆ›å»ºå’Œç®¡ç†</span></span>
<span class="line"><span class="token keyword">type</span> Manager <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    mu      sync<span class="token punctuation">.</span>Mutex</span>
<span class="line">    cgroups <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Cgroup</span>
<span class="line">    paths   <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>  <span class="token comment">// v1: å¤šè·¯å¾„æ˜ å°„</span></span>
<span class="line">    dirPath <span class="token builtin">string</span>            <span class="token comment">// v2: å•ä¸€è·¯å¾„</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// åˆ›å»º cgroup å±‚æ¬¡ç»“æ„</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">Apply</span><span class="token punctuation">(</span>pid <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. åˆ›å»º cgroup ç›®å½•ç»“æ„</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">createCgroupPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. è®¾ç½®èµ„æºé™åˆ¶</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. å°†è¿›ç¨‹åŠ å…¥ cgroup</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">addProcess</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err  </span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">createCgroupPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// v1 éœ€è¦ä¸ºæ¯ä¸ªå­ç³»ç»Ÿåˆ›å»ºè·¯å¾„</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span>cgroups<span class="token punctuation">.</span><span class="token function">IsCgroup2UnifiedMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">for</span> subsys<span class="token punctuation">,</span> path <span class="token operator">:=</span> <span class="token keyword">range</span> m<span class="token punctuation">.</span>paths <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to create cgroup path %s: %w&quot;</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// v2 åªéœ€åˆ›å»ºå•ä¸€è·¯å¾„</span></span>
<span class="line">    <span class="token keyword">return</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>dirPath<span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-åŠ¨æ€èµ„æºè°ƒæ•´" tabindex="-1"><a class="header-anchor" href="#_5-2-åŠ¨æ€èµ„æºè°ƒæ•´"><span>5.2 åŠ¨æ€èµ„æºè°ƒæ•´</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// è¿è¡Œæ—¶åŠ¨æ€è°ƒæ•´èµ„æºé™åˆ¶</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">UpdateResources</span><span class="token punctuation">(</span>r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// éªŒè¯æ–°çš„èµ„æºé…ç½®</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">validateResources</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åº”ç”¨æ–°çš„èµ„æºé™åˆ¶</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ›´æ–°å†…éƒ¨é…ç½®</span></span>
<span class="line">    m<span class="token punctuation">.</span>cgroups<span class="token punctuation">.</span>Resources <span class="token operator">=</span> r</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">validateResources</span><span class="token punctuation">(</span>r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// å†…å­˜é™åˆ¶ä¸èƒ½ä½äºå½“å‰ä½¿ç”¨é‡</span></span>
<span class="line">    <span class="token keyword">if</span> r<span class="token punctuation">.</span>Memory <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// æ£€æŸ¥å½“å‰å†…å­˜ä½¿ç”¨</span></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// CPU é…é¢åˆç†æ€§æ£€æŸ¥  </span></span>
<span class="line">    <span class="token keyword">if</span> r<span class="token punctuation">.</span>CpuQuota <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>CpuPeriod <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        cpuRatio <span class="token operator">:=</span> <span class="token function">float64</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>CpuQuota<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">float64</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>CpuPeriod<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> cpuRatio <span class="token operator">&gt;</span> <span class="token function">float64</span><span class="token punctuation">(</span>runtime<span class="token punctuation">.</span><span class="token function">NumCPU</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;CPU quota %.2f exceeds available CPUs %d&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">                cpuRatio<span class="token punctuation">,</span> runtime<span class="token punctuation">.</span><span class="token function">NumCPU</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-rootless-å®¹å™¨æ”¯æŒ" tabindex="-1"><a class="header-anchor" href="#_5-3-rootless-å®¹å™¨æ”¯æŒ"><span>5.3 Rootless å®¹å™¨æ”¯æŒ</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// Rootless æ¨¡å¼çš„ç‰¹æ®Šå¤„ç†</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewRootlessManager</span><span class="token punctuation">(</span>config <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Cgroup<span class="token punctuation">)</span> <span class="token punctuation">(</span>cgroups<span class="token punctuation">.</span>Manager<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ£€æŸ¥ cgroups å§”æ‰˜</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">isValidDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;insufficient cgroups delegation for rootless&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// Rootless æ¨¡å¼ä¸‹çš„è·¯å¾„è°ƒæ•´</span></span>
<span class="line">    userSlice<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getUserSlice</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    config<span class="token punctuation">.</span>Path <span class="token operator">=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>userSlice<span class="token punctuation">,</span> config<span class="token punctuation">.</span>Path<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> cgroups<span class="token punctuation">.</span><span class="token function">IsCgroup2UnifiedMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fs2<span class="token punctuation">.</span><span class="token function">NewManager</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> config<span class="token punctuation">.</span>Path<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// v1 rootless æ”¯æŒæœ‰é™</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;cgroups v1 rootless support is limited&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">isValidDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰è¶³å¤Ÿçš„ cgroups å§”æ‰˜æƒé™</span></span>
<span class="line">    delegateFile <span class="token operator">:=</span> <span class="token string">&quot;/sys/fs/cgroup/cgroup.subtree_control&quot;</span></span>
<span class="line">    <span class="token keyword">if</span> data<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>delegateFile<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;memory&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> </span>
<span class="line">               strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;cpu&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#_5-4-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"><span>5.4 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</span></a></h3><h4 id="a-æ‰¹é‡æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#a-æ‰¹é‡æ“ä½œ"><span>A. æ‰¹é‡æ“ä½œ</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// æ‰¹é‡è®¾ç½®å¤šä¸ªèµ„æºå‚æ•°ï¼Œå‡å°‘ç³»ç»Ÿè°ƒç”¨</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">SetBatch</span><span class="token punctuation">(</span>r <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    operations <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">setCpu</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>path<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">setMemory</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>path<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">setIO</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>path<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">setPids</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>path<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å¹¶å‘æ‰§è¡Œï¼Œä½†è¦å¤„ç†ä¾èµ–å…³ç³»</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> op <span class="token operator">:=</span> <span class="token keyword">range</span> operations <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="b-ç¼“å­˜æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#b-ç¼“å­˜æœºåˆ¶"><span>B. ç¼“å­˜æœºåˆ¶</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// ç»Ÿè®¡æ•°æ®ç¼“å­˜ï¼Œé¿å…é¢‘ç¹è¯»å–æ–‡ä»¶</span></span>
<span class="line"><span class="token keyword">type</span> cachedStats <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    stats     <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Stats</span>
<span class="line">    timestamp time<span class="token punctuation">.</span>Time</span>
<span class="line">    ttl       time<span class="token punctuation">.</span>Duration</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">GetStatsCached</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Stats<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> m<span class="token punctuation">.</span>cache <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span> <span class="token operator">&lt;</span> m<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>ttl <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> m<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>stats<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    stats<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">GetStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    m<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token operator">&amp;</span>cachedStats<span class="token punctuation">{</span></span>
<span class="line">        stats<span class="token punctuation">:</span>     stats<span class="token punctuation">,</span></span>
<span class="line">        timestamp<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        ttl<span class="token punctuation">:</span>       time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">,</span>  <span class="token comment">// 5ç§’ç¼“å­˜</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> stats<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-å®è·µç»ƒä¹ " tabindex="-1"><a class="header-anchor" href="#_6-å®è·µç»ƒä¹ "><span>6. å®è·µç»ƒä¹ </span></a></h2><h3 id="_6-1-åŸºç¡€èµ„æºé™åˆ¶å®éªŒ" tabindex="-1"><a class="header-anchor" href="#_6-1-åŸºç¡€èµ„æºé™åˆ¶å®éªŒ"><span>6.1 åŸºç¡€èµ„æºé™åˆ¶å®éªŒ</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># å®éªŒ 1: CPU é™åˆ¶æµ‹è¯•</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># åˆ›å»ºæµ‹è¯• cgroup</span></span>
<span class="line"><span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /sys/fs/cgroup/cpu/test-cpu</span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token variable">$$</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /sys/fs/cgroup/cpu/test-cpu/cgroup.procs</span>
<span class="line"></span>
<span class="line"><span class="token comment"># é™åˆ¶ä¸º 0.5 ä¸ª CPU æ ¸å¿ƒ</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token number">100000</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /sys/fs/cgroup/cpu/test-cpu/cpu.cfs_period_us</span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token number">50000</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /sys/fs/cgroup/cpu/test-cpu/cpu.cfs_quota_us</span>
<span class="line"></span>
<span class="line"><span class="token comment"># è¿è¡Œ CPU å¯†é›†ä»»åŠ¡å¹¶è§‚å¯Ÿé™åˆ¶æ•ˆæœ</span></span>
<span class="line">stress <span class="token parameter variable">--cpu</span> <span class="token number">4</span> <span class="token parameter variable">--timeout</span> 30s <span class="token operator">&amp;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç›‘æ§ CPU ä½¿ç”¨</span></span>
<span class="line"><span class="token function">watch</span> <span class="token parameter variable">-n</span> <span class="token number">1</span> <span class="token string">&quot;cat /sys/fs/cgroup/cpu/test-cpu/cpuacct.usage &amp;&amp; top -p \\<span class="token variable">$!</span>&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash  </span></span>
<span class="line"><span class="token comment"># å®éªŒ 2: å†…å­˜é™åˆ¶æµ‹è¯•</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># åˆ›å»ºå†…å­˜é™åˆ¶ cgroup</span></span>
<span class="line"><span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /sys/fs/cgroup/memory/test-memory</span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token variable">$$</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /sys/fs/cgroup/memory/test-memory/cgroup.procs</span>
<span class="line"></span>
<span class="line"><span class="token comment"># é™åˆ¶å†…å­˜ä¸º 100MB</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token number">104857600</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /sys/fs/cgroup/memory/test-memory/memory.limit_in_bytes</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å°è¯•åˆ†é… 200MB å†…å­˜ (åº”è¯¥è¢« OOM killer ç»ˆæ­¢)</span></span>
<span class="line">stress <span class="token parameter variable">--vm</span> <span class="token number">1</span> --vm-bytes 200M <span class="token parameter variable">--timeout</span> 10s</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥ OOM ç»Ÿè®¡</span></span>
<span class="line"><span class="token function">cat</span> /sys/fs/cgroup/memory/test-memory/memory.oom_control</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-ç›‘æ§è„šæœ¬å¼€å‘" tabindex="-1"><a class="header-anchor" href="#_6-2-ç›‘æ§è„šæœ¬å¼€å‘"><span>6.2 ç›‘æ§è„šæœ¬å¼€å‘</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># cgroup èµ„æºç›‘æ§è„šæœ¬</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">CGROUP_PATH</span><span class="token operator">=</span><span class="token string">&quot;/sys/fs/cgroup&quot;</span></span>
<span class="line"><span class="token assign-left variable">CONTAINER_PATH</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$CGROUP_PATH</span>/system.slice/docker-*.scope&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token function-name function">monitor_container</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin class-name">local</span> <span class="token assign-left variable">container_path</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$1</span>&quot;</span></span>
<span class="line">    <span class="token builtin class-name">local</span> <span class="token assign-left variable">container_name</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">basename</span> <span class="token string">&quot;<span class="token variable">$container_path</span>&quot;</span> <span class="token operator">|</span> <span class="token function">cut</span> -d<span class="token string">&#39;-&#39;</span> <span class="token parameter variable">-f2</span> <span class="token operator">|</span> <span class="token function">cut</span> -d<span class="token string">&#39;.&#39;</span> <span class="token parameter variable">-f1</span><span class="token variable">)</span></span></span>
<span class="line">    </span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">&quot;=== Container: <span class="token variable">$container_name</span> ===&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># CPU ç»Ÿè®¡</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-f</span> <span class="token string">&quot;<span class="token variable">$container_path</span>/cpu.stat&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;CPU Stats:&quot;</span></span>
<span class="line">        <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">&quot;(usage_usec|throttled)&quot;</span> <span class="token string">&quot;<span class="token variable">$container_path</span>/cpu.stat&quot;</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">&#39;s/^/  /&#39;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># å†…å­˜ç»Ÿè®¡  </span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-f</span> <span class="token string">&quot;<span class="token variable">$container_path</span>/memory.current&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;Memory Usage: <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> $container_path/memory.current<span class="token variable">)</span></span> bytes&quot;</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;Memory Limit: <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> $container_path/memory.max<span class="token variable">)</span></span>&quot;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># IO ç»Ÿè®¡</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-f</span> <span class="token string">&quot;<span class="token variable">$container_path</span>/io.stat&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;IO Stats:&quot;</span></span>
<span class="line">        <span class="token function">head</span> <span class="token parameter variable">-3</span> <span class="token string">&quot;<span class="token variable">$container_path</span>/io.stat&quot;</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">&#39;s/^/  /&#39;</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line">    </span>
<span class="line">    <span class="token builtin class-name">echo</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç›‘æ§æ‰€æœ‰å®¹å™¨</span></span>
<span class="line"><span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token for-or-select variable">container_path</span> <span class="token keyword">in</span> <span class="token variable">$CONTAINER_PATH</span><span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">        <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-d</span> <span class="token string">&quot;<span class="token variable">$container_path</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> monitor_container <span class="token string">&quot;<span class="token variable">$container_path</span>&quot;</span></span>
<span class="line">    <span class="token keyword">done</span></span>
<span class="line">    <span class="token function">sleep</span> <span class="token number">5</span></span>
<span class="line"><span class="token keyword">done</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-è‡ªå®šä¹‰èµ„æºæ§åˆ¶" tabindex="-1"><a class="header-anchor" href="#_6-3-è‡ªå®šä¹‰èµ„æºæ§åˆ¶"><span>6.3 è‡ªå®šä¹‰èµ„æºæ§åˆ¶</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// è‡ªå®šä¹‰èµ„æºç®¡ç†å™¨ç¤ºä¾‹</span></span>
<span class="line"><span class="token keyword">package</span> main</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;fmt&quot;</span></span>
<span class="line">    <span class="token string">&quot;github.com/opencontainers/cgroups&quot;</span></span>
<span class="line">    <span class="token string">&quot;github.com/opencontainers/cgroups/fs2&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// åˆ›å»ºè‡ªå®šä¹‰ cgroup é…ç½®</span></span>
<span class="line">    cgroupConfig <span class="token operator">:=</span> <span class="token operator">&amp;</span>cgroups<span class="token punctuation">.</span>Cgroup<span class="token punctuation">{</span></span>
<span class="line">        Path<span class="token punctuation">:</span> <span class="token string">&quot;custom-test&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        Resources<span class="token punctuation">:</span> <span class="token operator">&amp;</span>cgroups<span class="token punctuation">.</span>Resources<span class="token punctuation">{</span></span>
<span class="line">            Memory<span class="token punctuation">:</span> <span class="token number">128</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>  <span class="token comment">// 128MB</span></span>
<span class="line">            CpuWeight<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>             <span class="token comment">// CPU æƒé‡</span></span>
<span class="line">            CpuQuota<span class="token punctuation">:</span> <span class="token number">50000</span><span class="token punctuation">,</span>           <span class="token comment">// 0.5 CPU æ ¸å¿ƒ</span></span>
<span class="line">            CpuPeriod<span class="token punctuation">:</span> <span class="token number">100000</span><span class="token punctuation">,</span>         <span class="token comment">// 100ms å‘¨æœŸ</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åˆ›å»ºç®¡ç†å™¨ (è‡ªåŠ¨æ£€æµ‹ v1/v2)</span></span>
<span class="line">    manager<span class="token punctuation">,</span> err <span class="token operator">:=</span> fs2<span class="token punctuation">.</span><span class="token function">NewManager</span><span class="token punctuation">(</span>cgroupConfig<span class="token punctuation">,</span> cgroupConfig<span class="token punctuation">.</span>Path<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åº”ç”¨é…ç½®åˆ°å½“å‰è¿›ç¨‹</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> manager<span class="token punctuation">.</span><span class="token function">Apply</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">Getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Cgroup applied successfully!&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è¿è¡Œä¸€äº›å·¥ä½œè´Ÿè½½</span></span>
<span class="line">    <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è·å–ç»Ÿè®¡ä¿¡æ¯</span></span>
<span class="line">    stats<span class="token punctuation">,</span> err <span class="token operator">:=</span> manager<span class="token punctuation">.</span><span class="token function">GetStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;CPU Usage: %d ns\\n&quot;</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>CpuStats<span class="token punctuation">.</span>CpuUsage<span class="token punctuation">.</span>TotalUsage<span class="token punctuation">)</span></span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Memory Usage: %d bytes\\n&quot;</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>MemoryStats<span class="token punctuation">.</span>Usage<span class="token punctuation">.</span>Usage<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ¸…ç†</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> manager<span class="token punctuation">.</span><span class="token function">Destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to cleanup: %v\\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ¨¡æ‹Ÿä¸€äº› CPU å’Œå†…å­˜ä½¿ç”¨</span></span>
<span class="line">    data <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token comment">// 50MB</span></span>
<span class="line">    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">        data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">byte</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// CPU å¯†é›†è®¡ç®—</span></span>
<span class="line">    sum <span class="token operator">:=</span> <span class="token number">0</span></span>
<span class="line">    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">        sum <span class="token operator">+=</span> i</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Work completed, sum: %d\\n&quot;</span><span class="token punctuation">,</span> sum<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-æ•…éšœæ’é™¤å’Œè°ƒè¯•" tabindex="-1"><a class="header-anchor" href="#_7-æ•…éšœæ’é™¤å’Œè°ƒè¯•"><span>7. æ•…éšœæ’é™¤å’Œè°ƒè¯•</span></a></h2><h3 id="_7-1-å¸¸è§é—®é¢˜è¯Šæ–­" tabindex="-1"><a class="header-anchor" href="#_7-1-å¸¸è§é—®é¢˜è¯Šæ–­"><span>7.1 å¸¸è§é—®é¢˜è¯Šæ–­</span></a></h3><h4 id="æƒé™é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#æƒé™é—®é¢˜"><span>æƒé™é—®é¢˜</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># æ£€æŸ¥ cgroup æŒ‚è½½æƒ…å†µ</span></span>
<span class="line"><span class="token function">mount</span> <span class="token operator">|</span> <span class="token function">grep</span> cgroup</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥ cgroup ç‰ˆæœ¬</span></span>
<span class="line"><span class="token function">stat</span> <span class="token parameter variable">-fc</span> %T /sys/fs/cgroup/</span>
<span class="line"><span class="token comment"># cgroup2fs = v2, tmpfs = v1</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥ç”¨æˆ·æƒé™</span></span>
<span class="line"><span class="token function">ls</span> <span class="token parameter variable">-la</span> /sys/fs/cgroup/user.slice/user-<span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span>.slice/</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥ systemd å§”æ‰˜</span></span>
<span class="line">systemctl <span class="token parameter variable">--user</span> show-environment</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="èµ„æºé™åˆ¶ä¸ç”Ÿæ•ˆ" tabindex="-1"><a class="header-anchor" href="#èµ„æºé™åˆ¶ä¸ç”Ÿæ•ˆ"><span>èµ„æºé™åˆ¶ä¸ç”Ÿæ•ˆ</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># æ£€æŸ¥æ˜¯å¦æ­£ç¡®è®¾ç½®</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;è®¾ç½®çš„é™åˆ¶:&quot;</span></span>
<span class="line"><span class="token function">cat</span> /sys/fs/cgroup/memory/test/memory.limit_in_bytes</span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;å½“å‰ä½¿ç”¨:&quot;</span>  </span>
<span class="line"><span class="token function">cat</span> /sys/fs/cgroup/memory/test/memory.usage_in_bytes</span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;è¿›ç¨‹åˆ—è¡¨:&quot;</span></span>
<span class="line"><span class="token function">cat</span> /sys/fs/cgroup/memory/test/cgroup.procs</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥å†…æ ¸æ”¯æŒ</span></span>
<span class="line"><span class="token function">grep</span> CONFIG_MEMCG /boot/config-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token parameter variable">-r</span><span class="token variable">)</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-æ€§èƒ½åˆ†æå·¥å…·" tabindex="-1"><a class="header-anchor" href="#_7-2-æ€§èƒ½åˆ†æå·¥å…·"><span>7.2 æ€§èƒ½åˆ†æå·¥å…·</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># ä½¿ç”¨ systemd-cgtop ç›‘æ§</span></span>
<span class="line">systemd-cgtop</span>
<span class="line"></span>
<span class="line"><span class="token comment"># ä½¿ç”¨ htop æŸ¥çœ‹ cgroup ä¿¡æ¯</span></span>
<span class="line"><span class="token function">htop</span> <span class="token parameter variable">-t</span>  <span class="token comment"># æ˜¾ç¤ºè¿›ç¨‹æ ‘</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ä½¿ç”¨ perf åˆ†æ cgroup æ€§èƒ½</span></span>
<span class="line">perf record <span class="token parameter variable">-g</span> <span class="token parameter variable">-e</span> cpu-cycles <span class="token parameter variable">--cgroup</span><span class="token operator">=</span>/sys/fs/cgroup/test ./workload</span>
<span class="line">perf report</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-æ€è€ƒé¢˜" tabindex="-1"><a class="header-anchor" href="#_8-æ€è€ƒé¢˜"><span>8. æ€è€ƒé¢˜</span></a></h2><h3 id="_8-1-æ¶æ„è®¾è®¡æ€è€ƒ" tabindex="-1"><a class="header-anchor" href="#_8-1-æ¶æ„è®¾è®¡æ€è€ƒ"><span>8.1 æ¶æ„è®¾è®¡æ€è€ƒ</span></a></h3><ol><li><p><strong>åŒç‰ˆæœ¬æ¶æ„</strong>: ä¸ºä»€ä¹ˆ runc éœ€è¦åŒæ—¶æ”¯æŒ cgroups v1 å’Œ v2ï¼Ÿä¸¤ä¸ªç‰ˆæœ¬èƒ½å¦ç»Ÿä¸€ï¼Ÿ</p></li><li><p><strong>èµ„æºå†²çªå¤„ç†</strong>: å½“ CPU é…é¢å’Œæƒé‡åŒæ—¶è®¾ç½®æ—¶ï¼Œå†…æ ¸å¦‚ä½•å¤„ç†ä¼˜å…ˆçº§ï¼Ÿ</p></li><li><p><strong>å†…å­˜äº¤æ¢ç­–ç•¥</strong>: ä¸ºä»€ä¹ˆå†…å­˜é™åˆ¶çš„è®¾ç½®é¡ºåºå¾ˆé‡è¦ï¼Ÿå¦‚ä½•é¿å…è®¾ç½®å†²çªï¼Ÿ</p></li></ol><h3 id="_8-2-æ€§èƒ½ä¼˜åŒ–æ€è€ƒ" tabindex="-1"><a class="header-anchor" href="#_8-2-æ€§èƒ½ä¼˜åŒ–æ€è€ƒ"><span>8.2 æ€§èƒ½ä¼˜åŒ–æ€è€ƒ</span></a></h3><ol start="4"><li><p><strong>ç»Ÿè®¡æ”¶é›†å¼€é”€</strong>: é¢‘ç¹è¯»å– cgroup ç»Ÿè®¡æ–‡ä»¶å¯¹æ€§èƒ½æœ‰ä»€ä¹ˆå½±å“ï¼Ÿå¦‚ä½•ä¼˜åŒ–ï¼Ÿ</p></li><li><p><strong>æ‰¹é‡æ“ä½œ</strong>: å“ªäº› cgroup æ“ä½œå¯ä»¥æ‰¹é‡æ‰§è¡Œï¼Ÿå¦‚ä½•è®¾è®¡æ‰¹é‡æ¥å£ï¼Ÿ</p></li><li><p><strong>ç¼“å­˜ç­–ç•¥</strong>: cgroup è·¯å¾„å’Œæ–‡ä»¶æè¿°ç¬¦åº”è¯¥å¦‚ä½•ç¼“å­˜ï¼Ÿä»€ä¹ˆæ—¶å€™å¤±æ•ˆï¼Ÿ</p></li></ol><h3 id="_8-3-å®é™…åº”ç”¨æ€è€ƒ" tabindex="-1"><a class="header-anchor" href="#_8-3-å®é™…åº”ç”¨æ€è€ƒ"><span>8.3 å®é™…åº”ç”¨æ€è€ƒ</span></a></h3><ol start="7"><li><p><strong>åŠ¨æ€è°ƒæ•´</strong>: å¦‚ä½•åœ¨ä¸é‡å¯å®¹å™¨çš„æƒ…å†µä¸‹å®‰å…¨åœ°è°ƒæ•´èµ„æºé™åˆ¶ï¼Ÿ</p></li><li><p><strong>èµ„æºè¶…å”®</strong>: åœ¨èµ„æºè¶…å”®çš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•è®¾è®¡åˆç†çš„èµ„æºåˆ†é…ç­–ç•¥ï¼Ÿ</p></li><li><p><strong>å¤šç§Ÿæˆ·éš”ç¦»</strong>: å¦‚ä½•ä½¿ç”¨ cgroups å®ç°å¤šç§Ÿæˆ·ä¹‹é—´çš„èµ„æºéš”ç¦»ï¼Ÿ</p></li></ol><h2 id="_9-æ‰©å±•é˜…è¯»" tabindex="-1"><a class="header-anchor" href="#_9-æ‰©å±•é˜…è¯»"><span>9. æ‰©å±•é˜…è¯»</span></a></h2><h3 id="_9-1-å†…æ ¸æ–‡æ¡£" tabindex="-1"><a class="header-anchor" href="#_9-1-å†…æ ¸æ–‡æ¡£"><span>9.1 å†…æ ¸æ–‡æ¡£</span></a></h3>`,115)),s("ul",null,[s("li",null,[s("a",d,[n[11]||(n[11]=a("Control Group v2")),p(e)])]),s("li",null,[s("a",v,[n[12]||(n[12]=a("Control Group v1")),p(e)])]),s("li",null,[s("a",m,[n[13]||(n[13]=a("CPU Bandwidth Control")),p(e)])]),s("li",null,[s("a",b,[n[14]||(n[14]=a("Memory Resource Controller")),p(e)])])]),n[27]||(n[27]=s("h3",{id:"_9-2-å®è·µæŒ‡å—",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_9-2-å®è·µæŒ‡å—"},[s("span",null,"9.2 å®è·µæŒ‡å—")])],-1)),s("ul",null,[s("li",null,[s("a",g,[n[15]||(n[15]=a("Cgroups, namespaces and beyond")),p(e)])]),s("li",null,[s("a",h,[n[16]||(n[16]=a("Understanding cgroups")),p(e)])]),s("li",null,[s("a",f,[n[17]||(n[17]=a("Systemd and cgroups")),p(e)])])]),n[28]||(n[28]=s("h3",{id:"_9-3-å·¥å…·å’Œç›‘æ§",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_9-3-å·¥å…·å’Œç›‘æ§"},[s("span",null,"9.3 å·¥å…·å’Œç›‘æ§")])],-1)),s("ul",null,[s("li",null,[s("a",y,[n[18]||(n[18]=a("cAdvisor - Container monitoring")),p(e)])]),s("li",null,[s("a",w,[n[19]||(n[19]=a("systemd-cgtop")),p(e)])]),s("li",null,[s("a",q,[n[20]||(n[20]=a("cgroupspy - Python cgroups interface")),p(e)])])]),n[29]||(n[29]=c('<h2 id="ğŸ¯-æ¨¡å—æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-æ¨¡å—æ€»ç»“"><span>ğŸ¯ æ¨¡å—æ€»ç»“</span></a></h2><p>é€šè¿‡æœ¬æ¨¡å—çš„å­¦ä¹ ï¼Œä½ åº”è¯¥å·²ç»æŒæ¡äº†ï¼š</p><p>âœ… <strong>Cgroups åŸºç¡€æ¶æ„</strong>ï¼šç†è§£ v1/v2 å·®å¼‚å’Œå±‚æ¬¡ç»“æ„ç®¡ç†<br> âœ… <strong>èµ„æºæ§åˆ¶æœºåˆ¶</strong>ï¼šæŒæ¡ CPUã€å†…å­˜ã€IOã€è®¾å¤‡æ§åˆ¶çš„å®ç°åŸç†<br> âœ… <strong>ç»Ÿè®¡ç›‘æ§ç³»ç»Ÿ</strong>ï¼šç†è§£èµ„æºä½¿ç”¨ç»Ÿè®¡å’Œæ€§èƒ½æŒ‡æ ‡åˆ†æ<br> âœ… <strong>é«˜çº§ç‰¹æ€§åº”ç”¨</strong>ï¼šæŒæ¡åŠ¨æ€è°ƒæ•´ã€Rootless æ”¯æŒç­‰é«˜çº§åŠŸèƒ½<br> âœ… <strong>æ•…éšœæ’é™¤èƒ½åŠ›</strong>ï¼šå…·å¤‡ cgroups é—®é¢˜è¯Šæ–­å’Œæ€§èƒ½è°ƒä¼˜æŠ€èƒ½</p>',3)),s("p",null,[n[22]||(n[22]=s("strong",null,"ä¸‹ä¸€æ­¥",-1)),n[23]||(n[23]=a(": è¿›å…¥ ")),p(t,{to:"/blogs/cloud-base/runc-deep-dive/05-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%8E%E6%8C%82%E8%BD%BD%E7%AE%A1%E7%90%86.html"},{default:l(()=>n[21]||(n[21]=[a("æ¨¡å— 5: æ–‡ä»¶ç³»ç»Ÿä¸æŒ‚è½½ç®¡ç†")])),_:1,__:[21]}),n[24]||(n[24]=a("ï¼Œå­¦ä¹ å®¹å™¨æ–‡ä»¶ç³»ç»Ÿéš”ç¦»å’ŒæŒ‚è½½æœºåˆ¶ã€‚"))])])}const S=i(k,[["render",_]]),x=JSON.parse('{"path":"/blogs/cloud-base/runc-deep-dive/04-Cgroupsziyuanguanli.html","title":"Cgroups èµ„æºç®¡ç†","lang":"en-US","frontmatter":{"title":"Cgroups èµ„æºç®¡ç†","date":"2025-08-04T00:00:00.000Z","tags":["runc","äº‘åŸç”Ÿ","Cgroups"],"categories":["cloud-base/runc-deep-dive"],"sidebar":"auto"},"headers":[{"level":2,"title":"æ¦‚è¿°","slug":"æ¦‚è¿°","link":"#æ¦‚è¿°","children":[]},{"level":2,"title":"ğŸ¯ å­¦ä¹ ç›®æ ‡","slug":"ğŸ¯-å­¦ä¹ ç›®æ ‡","link":"#ğŸ¯-å­¦ä¹ ç›®æ ‡","children":[]},{"level":2,"title":"1. Cgroups åŸºç¡€æ¦‚å¿µ","slug":"_1-cgroups-åŸºç¡€æ¦‚å¿µ","link":"#_1-cgroups-åŸºç¡€æ¦‚å¿µ","children":[{"level":3,"title":"1.1 ä»€ä¹ˆæ˜¯ Cgroupsï¼Ÿ","slug":"_1-1-ä»€ä¹ˆæ˜¯-cgroups","link":"#_1-1-ä»€ä¹ˆæ˜¯-cgroups","children":[]},{"level":3,"title":"1.2 Cgroups å±‚æ¬¡ç»“æ„","slug":"_1-2-cgroups-å±‚æ¬¡ç»“æ„","link":"#_1-2-cgroups-å±‚æ¬¡ç»“æ„","children":[]}]},{"level":2,"title":"2. Cgroups v1 vs v2 æ¶æ„å·®å¼‚","slug":"_2-cgroups-v1-vs-v2-æ¶æ„å·®å¼‚","link":"#_2-cgroups-v1-vs-v2-æ¶æ„å·®å¼‚","children":[{"level":3,"title":"2.1 æ¶æ„å¯¹æ¯”å›¾","slug":"_2-1-æ¶æ„å¯¹æ¯”å›¾","link":"#_2-1-æ¶æ„å¯¹æ¯”å›¾","children":[]},{"level":3,"title":"2.2 æ ¸å¿ƒå·®å¼‚å¯¹æ¯”","slug":"_2-2-æ ¸å¿ƒå·®å¼‚å¯¹æ¯”","link":"#_2-2-æ ¸å¿ƒå·®å¼‚å¯¹æ¯”","children":[]},{"level":3,"title":"2.3 runc çš„å®ç°é€‚é…","slug":"_2-3-runc-çš„å®ç°é€‚é…","link":"#_2-3-runc-çš„å®ç°é€‚é…","children":[]}]},{"level":2,"title":"3. æ ¸å¿ƒèµ„æºæ§åˆ¶æœºåˆ¶","slug":"_3-æ ¸å¿ƒèµ„æºæ§åˆ¶æœºåˆ¶","link":"#_3-æ ¸å¿ƒèµ„æºæ§åˆ¶æœºåˆ¶","children":[{"level":3,"title":"3.1 CPU èµ„æºæ§åˆ¶","slug":"_3-1-cpu-èµ„æºæ§åˆ¶","link":"#_3-1-cpu-èµ„æºæ§åˆ¶","children":[]},{"level":3,"title":"3.2 å†…å­˜èµ„æºæ§åˆ¶","slug":"_3-2-å†…å­˜èµ„æºæ§åˆ¶","link":"#_3-2-å†…å­˜èµ„æºæ§åˆ¶","children":[]},{"level":3,"title":"3.3 IO èµ„æºæ§åˆ¶","slug":"_3-3-io-èµ„æºæ§åˆ¶","link":"#_3-3-io-èµ„æºæ§åˆ¶","children":[]},{"level":3,"title":"3.4 è®¾å¤‡è®¿é—®æ§åˆ¶","slug":"_3-4-è®¾å¤‡è®¿é—®æ§åˆ¶","link":"#_3-4-è®¾å¤‡è®¿é—®æ§åˆ¶","children":[]},{"level":3,"title":"3.5 è¿›ç¨‹æ•°é™åˆ¶ (PIDs)","slug":"_3-5-è¿›ç¨‹æ•°é™åˆ¶-pids","link":"#_3-5-è¿›ç¨‹æ•°é™åˆ¶-pids","children":[]}]},{"level":2,"title":"4. èµ„æºç»Ÿè®¡å’Œç›‘æ§","slug":"_4-èµ„æºç»Ÿè®¡å’Œç›‘æ§","link":"#_4-èµ„æºç»Ÿè®¡å’Œç›‘æ§","children":[{"level":3,"title":"4.1 ç»Ÿè®¡æ•°æ®ç»“æ„","slug":"_4-1-ç»Ÿè®¡æ•°æ®ç»“æ„","link":"#_4-1-ç»Ÿè®¡æ•°æ®ç»“æ„","children":[]},{"level":3,"title":"4.2 ç»Ÿè®¡æ•°æ®æ”¶é›†å®ç°","slug":"_4-2-ç»Ÿè®¡æ•°æ®æ”¶é›†å®ç°","link":"#_4-2-ç»Ÿè®¡æ•°æ®æ”¶é›†å®ç°","children":[]},{"level":3,"title":"4.3 æ€§èƒ½ç›‘æ§æŒ‡æ ‡è§£è¯»","slug":"_4-3-æ€§èƒ½ç›‘æ§æŒ‡æ ‡è§£è¯»","link":"#_4-3-æ€§èƒ½ç›‘æ§æŒ‡æ ‡è§£è¯»","children":[]}]},{"level":2,"title":"5. é«˜çº§ç‰¹æ€§å’Œä¼˜åŒ–","slug":"_5-é«˜çº§ç‰¹æ€§å’Œä¼˜åŒ–","link":"#_5-é«˜çº§ç‰¹æ€§å’Œä¼˜åŒ–","children":[{"level":3,"title":"5.1 å±‚æ¬¡ç»“æ„ç®¡ç†","slug":"_5-1-å±‚æ¬¡ç»“æ„ç®¡ç†","link":"#_5-1-å±‚æ¬¡ç»“æ„ç®¡ç†","children":[]},{"level":3,"title":"5.2 åŠ¨æ€èµ„æºè°ƒæ•´","slug":"_5-2-åŠ¨æ€èµ„æºè°ƒæ•´","link":"#_5-2-åŠ¨æ€èµ„æºè°ƒæ•´","children":[]},{"level":3,"title":"5.3 Rootless å®¹å™¨æ”¯æŒ","slug":"_5-3-rootless-å®¹å™¨æ”¯æŒ","link":"#_5-3-rootless-å®¹å™¨æ”¯æŒ","children":[]},{"level":3,"title":"5.4 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥","slug":"_5-4-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥","link":"#_5-4-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥","children":[]}]},{"level":2,"title":"6. å®è·µç»ƒä¹ ","slug":"_6-å®è·µç»ƒä¹ ","link":"#_6-å®è·µç»ƒä¹ ","children":[{"level":3,"title":"6.1 åŸºç¡€èµ„æºé™åˆ¶å®éªŒ","slug":"_6-1-åŸºç¡€èµ„æºé™åˆ¶å®éªŒ","link":"#_6-1-åŸºç¡€èµ„æºé™åˆ¶å®éªŒ","children":[]},{"level":3,"title":"6.2 ç›‘æ§è„šæœ¬å¼€å‘","slug":"_6-2-ç›‘æ§è„šæœ¬å¼€å‘","link":"#_6-2-ç›‘æ§è„šæœ¬å¼€å‘","children":[]},{"level":3,"title":"6.3 è‡ªå®šä¹‰èµ„æºæ§åˆ¶","slug":"_6-3-è‡ªå®šä¹‰èµ„æºæ§åˆ¶","link":"#_6-3-è‡ªå®šä¹‰èµ„æºæ§åˆ¶","children":[]}]},{"level":2,"title":"7. æ•…éšœæ’é™¤å’Œè°ƒè¯•","slug":"_7-æ•…éšœæ’é™¤å’Œè°ƒè¯•","link":"#_7-æ•…éšœæ’é™¤å’Œè°ƒè¯•","children":[{"level":3,"title":"7.1 å¸¸è§é—®é¢˜è¯Šæ–­","slug":"_7-1-å¸¸è§é—®é¢˜è¯Šæ–­","link":"#_7-1-å¸¸è§é—®é¢˜è¯Šæ–­","children":[]},{"level":3,"title":"7.2 æ€§èƒ½åˆ†æå·¥å…·","slug":"_7-2-æ€§èƒ½åˆ†æå·¥å…·","link":"#_7-2-æ€§èƒ½åˆ†æå·¥å…·","children":[]}]},{"level":2,"title":"8. æ€è€ƒé¢˜","slug":"_8-æ€è€ƒé¢˜","link":"#_8-æ€è€ƒé¢˜","children":[{"level":3,"title":"8.1 æ¶æ„è®¾è®¡æ€è€ƒ","slug":"_8-1-æ¶æ„è®¾è®¡æ€è€ƒ","link":"#_8-1-æ¶æ„è®¾è®¡æ€è€ƒ","children":[]},{"level":3,"title":"8.2 æ€§èƒ½ä¼˜åŒ–æ€è€ƒ","slug":"_8-2-æ€§èƒ½ä¼˜åŒ–æ€è€ƒ","link":"#_8-2-æ€§èƒ½ä¼˜åŒ–æ€è€ƒ","children":[]},{"level":3,"title":"8.3 å®é™…åº”ç”¨æ€è€ƒ","slug":"_8-3-å®é™…åº”ç”¨æ€è€ƒ","link":"#_8-3-å®é™…åº”ç”¨æ€è€ƒ","children":[]}]},{"level":2,"title":"9. æ‰©å±•é˜…è¯»","slug":"_9-æ‰©å±•é˜…è¯»","link":"#_9-æ‰©å±•é˜…è¯»","children":[{"level":3,"title":"9.1 å†…æ ¸æ–‡æ¡£","slug":"_9-1-å†…æ ¸æ–‡æ¡£","link":"#_9-1-å†…æ ¸æ–‡æ¡£","children":[]},{"level":3,"title":"9.2 å®è·µæŒ‡å—","slug":"_9-2-å®è·µæŒ‡å—","link":"#_9-2-å®è·µæŒ‡å—","children":[]},{"level":3,"title":"9.3 å·¥å…·å’Œç›‘æ§","slug":"_9-3-å·¥å…·å’Œç›‘æ§","link":"#_9-3-å·¥å…·å’Œç›‘æ§","children":[]}]},{"level":2,"title":"ğŸ¯ æ¨¡å—æ€»ç»“","slug":"ğŸ¯-æ¨¡å—æ€»ç»“","link":"#ğŸ¯-æ¨¡å—æ€»ç»“","children":[]}],"git":{"createdTime":1755014556000,"updatedTime":1755014556000,"contributors":[{"name":"hushengnian","email":"hushengnian@example.com","commits":1}]},"filePathRelative":"blogs/cloud-base/runc-deep-dive/04-Cgroupsèµ„æºç®¡ç†.md"}');export{S as comp,x as data};
